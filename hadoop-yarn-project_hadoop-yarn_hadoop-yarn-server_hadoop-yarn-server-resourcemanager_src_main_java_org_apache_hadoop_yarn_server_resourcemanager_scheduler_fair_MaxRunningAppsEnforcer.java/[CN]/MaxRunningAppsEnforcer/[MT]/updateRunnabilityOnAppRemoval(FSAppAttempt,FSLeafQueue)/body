{
  AllocationConfiguration allocConf=scheduler.getAllocationConfiguration();
  FSQueue highestQueueWithAppsNowRunnable=(queue.getNumRunnableApps() == allocConf.getQueueMaxApps(queue.getName()) - 1) ? queue : null;
  FSParentQueue parent=queue.getParent();
  while (parent != null) {
    if (parent.getNumRunnableApps() == allocConf.getQueueMaxApps(parent.getName()) - 1) {
      highestQueueWithAppsNowRunnable=parent;
    }
    parent=parent.getParent();
  }
  List<List<FSAppAttempt>> appsNowMaybeRunnable=new ArrayList<List<FSAppAttempt>>();
  if (highestQueueWithAppsNowRunnable != null) {
    gatherPossiblyRunnableAppLists(highestQueueWithAppsNowRunnable,appsNowMaybeRunnable);
  }
  String user=app.getUser();
  Integer userNumRunning=usersNumRunnableApps.get(user);
  if (userNumRunning == null) {
    userNumRunning=0;
  }
  if (userNumRunning == allocConf.getUserMaxApps(user) - 1) {
    List<FSAppAttempt> userWaitingApps=usersNonRunnableApps.get(user);
    if (userWaitingApps != null) {
      appsNowMaybeRunnable.add(userWaitingApps);
    }
  }
  Iterator<FSAppAttempt> iter=new MultiListStartTimeIterator(appsNowMaybeRunnable);
  FSAppAttempt prev=null;
  List<FSAppAttempt> noLongerPendingApps=new ArrayList<FSAppAttempt>();
  while (iter.hasNext()) {
    FSAppAttempt next=iter.next();
    if (next == prev) {
      continue;
    }
    if (canAppBeRunnable(next.getQueue(),next.getUser())) {
      trackRunnableApp(next);
      FSAppAttempt appSched=next;
      next.getQueue().getRunnableAppSchedulables().add(appSched);
      noLongerPendingApps.add(appSched);
      if (noLongerPendingApps.size() >= appsNowMaybeRunnable.size()) {
        break;
      }
    }
    prev=next;
  }
  for (  FSAppAttempt appSched : noLongerPendingApps) {
    if (!appSched.getQueue().getNonRunnableAppSchedulables().remove(appSched)) {
      LOG.error("Can't make app runnable that does not already exist in queue" + " as non-runnable: " + appSched + ". This should never happen.");
    }
    if (!usersNonRunnableApps.remove(appSched.getUser(),appSched)) {
      LOG.error("Waiting app " + appSched + " expected to be in "+ "usersNonRunnableApps, but was not. This should never happen.");
    }
  }
}
