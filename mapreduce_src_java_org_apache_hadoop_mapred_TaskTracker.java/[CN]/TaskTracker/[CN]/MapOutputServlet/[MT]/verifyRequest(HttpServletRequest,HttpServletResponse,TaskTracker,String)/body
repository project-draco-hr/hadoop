{
  SecretKey tokenSecret=tracker.getJobTokenSecretManager().retrieveTokenSecret(jobId);
  String enc_str=SecureShuffleUtils.buildMsgFrom(request);
  String urlHashStr=request.getHeader(SecureShuffleUtils.HTTP_HEADER_URL_HASH);
  if (urlHashStr == null) {
    response.sendError(HttpServletResponse.SC_UNAUTHORIZED);
    throw new IOException("fetcher cannot be authenticated");
  }
  int len=urlHashStr.length();
  LOG.debug("verifying request. enc_str=" + enc_str + "; hash=..."+ urlHashStr.substring(len - len / 2,len - 1));
  try {
    SecureShuffleUtils.verifyReply(urlHashStr,enc_str,tokenSecret);
  }
 catch (  IOException ioe) {
    response.sendError(HttpServletResponse.SC_UNAUTHORIZED);
    throw ioe;
  }
  String reply=SecureShuffleUtils.generateHash(urlHashStr.getBytes(),tokenSecret);
  response.addHeader(SecureShuffleUtils.HTTP_HEADER_REPLY_URL_HASH,reply);
  len=reply.length();
  LOG.debug("Fetcher request verfied. enc_str=" + enc_str + ";reply="+ reply.substring(len - len / 2,len - 1));
}
