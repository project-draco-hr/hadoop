{
  Configuration conf=new Configuration();
  MiniDFSCluster cluster=null;
  FSNamesystem fsn=null;
  try {
    cluster=new MiniDFSCluster.Builder(conf).build();
    cluster.waitActive();
    fsn=cluster.getNameNode().namesystem;
    fsn.writeLock();
    MBeanClient client=new MBeanClient();
    client.start();
    client.join(20000);
    assertTrue("JMX calls are blocked when FSNamesystem's writerlock" + "is owned by another thread",client.succeeded);
    client.interrupt();
  }
  finally {
    if (fsn != null && fsn.hasWriteLock()) {
      fsn.writeUnlock();
    }
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
