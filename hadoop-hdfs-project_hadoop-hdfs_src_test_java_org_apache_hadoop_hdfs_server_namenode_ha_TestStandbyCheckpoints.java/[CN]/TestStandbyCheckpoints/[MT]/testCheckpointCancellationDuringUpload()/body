{
  cluster.getConfiguration(0).setInt(DFSConfigKeys.DFS_NAMENODE_CHECKPOINT_TXNS_KEY,1000);
  for (int i=0; i < NUM_NNS; i++) {
    cluster.getConfiguration(i).setBoolean(DFSConfigKeys.DFS_IMAGE_COMPRESS_KEY,false);
  }
  for (int i=1; i < NUM_NNS; i++) {
    cluster.getConfiguration(i).setLong(DFSConfigKeys.DFS_IMAGE_TRANSFER_RATE_KEY,100);
  }
  for (int i=0; i < NUM_NNS; i++) {
    cluster.restartNameNode(i);
  }
  setNNs();
  cluster.transitionToActive(0);
  doEdits(0,100);
  for (int i=1; i < NUM_NNS; i++) {
    HATestUtil.waitForStandbyToCatchUp(nns[0],nns[i]);
    HATestUtil.waitForCheckpoint(cluster,i,ImmutableList.of(104));
  }
  cluster.transitionToStandby(0);
  cluster.transitionToActive(1);
  cluster.shutdown();
  cluster=null;
  GenericTestUtils.waitFor(new Supplier<Boolean>(){
    @Override public Boolean get(){
      ThreadMXBean threadBean=ManagementFactory.getThreadMXBean();
      ThreadInfo[] threads=threadBean.getThreadInfo(threadBean.getAllThreadIds(),1);
      for (      ThreadInfo thread : threads) {
        if (thread.getThreadName().startsWith("TransferFsImageUpload")) {
          return false;
        }
      }
      return true;
    }
  }
,1000,30000);
  assertEquals(0,nns[0].getFSImage().getMostRecentCheckpointTxId());
}
