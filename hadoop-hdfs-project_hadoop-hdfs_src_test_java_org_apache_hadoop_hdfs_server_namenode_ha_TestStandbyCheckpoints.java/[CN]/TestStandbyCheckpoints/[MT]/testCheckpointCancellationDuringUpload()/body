{
  cluster.getConfiguration(0).setBoolean(DFSConfigKeys.DFS_IMAGE_COMPRESS_KEY,false);
  cluster.getConfiguration(1).setBoolean(DFSConfigKeys.DFS_IMAGE_COMPRESS_KEY,false);
  cluster.getConfiguration(1).setLong(DFSConfigKeys.DFS_IMAGE_TRANSFER_RATE_KEY,100);
  cluster.restartNameNode(0);
  cluster.restartNameNode(1);
  nn0=cluster.getNameNode(0);
  nn1=cluster.getNameNode(1);
  cluster.transitionToActive(0);
  doEdits(0,100);
  HATestUtil.waitForStandbyToCatchUp(nn0,nn1);
  HATestUtil.waitForCheckpoint(cluster,1,ImmutableList.of(104));
  cluster.transitionToStandby(0);
  cluster.transitionToActive(1);
  cluster.shutdown();
  cluster=null;
  GenericTestUtils.waitFor(new Supplier<Boolean>(){
    @Override public Boolean get(){
      ThreadMXBean threadBean=ManagementFactory.getThreadMXBean();
      ThreadInfo[] threads=threadBean.getThreadInfo(threadBean.getAllThreadIds(),1);
      for (      ThreadInfo thread : threads) {
        if (thread.getThreadName().startsWith("TransferFsImageUpload")) {
          return false;
        }
      }
      return true;
    }
  }
,1000,30000);
  assertEquals(0,nn0.getFSImage().getMostRecentCheckpointTxId());
}
