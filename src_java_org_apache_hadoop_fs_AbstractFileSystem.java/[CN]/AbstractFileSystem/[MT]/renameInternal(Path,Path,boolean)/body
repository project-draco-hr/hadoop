{
  final FileStatus srcStatus=getFileLinkStatus(src);
  if (srcStatus == null) {
    throw new FileNotFoundException("rename source " + src + " not found.");
  }
  FileStatus dstStatus;
  try {
    dstStatus=getFileLinkStatus(dst);
  }
 catch (  IOException e) {
    dstStatus=null;
  }
  if (dstStatus != null) {
    if (dst.equals(src)) {
      throw new FileAlreadyExistsException("The source " + src + " and destination "+ dst+ " are the same");
    }
    if (srcStatus.isSymlink() && dst.equals(srcStatus.getSymlink())) {
      throw new FileAlreadyExistsException("Cannot rename symlink " + src + " to its target "+ dst);
    }
    if (srcStatus.isDir() != dstStatus.isDir()) {
      throw new IOException("Source " + src + " Destination "+ dst+ " both should be either file or directory");
    }
    if (!overwrite) {
      throw new FileAlreadyExistsException("rename destination " + dst + " already exists.");
    }
    if (dstStatus.isDir()) {
      Iterator<FileStatus> list=listStatusIterator(dst);
      if (list != null && list.hasNext()) {
        throw new IOException("rename cannot overwrite non empty destination directory " + dst);
      }
    }
    delete(dst,false);
  }
 else {
    final Path parent=dst.getParent();
    final FileStatus parentStatus=getFileLinkStatus(parent);
    if (parentStatus == null) {
      throw new FileNotFoundException("rename destination parent " + parent + " not found.");
    }
    if (!parentStatus.isDir() && !parentStatus.isSymlink()) {
      throw new ParentNotDirectoryException("rename destination parent " + parent + " is a file.");
    }
  }
  renameInternal(src,dst);
}
