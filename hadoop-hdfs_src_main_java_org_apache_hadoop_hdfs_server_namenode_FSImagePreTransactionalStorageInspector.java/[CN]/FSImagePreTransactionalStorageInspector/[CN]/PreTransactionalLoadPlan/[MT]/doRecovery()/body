{
  LOG.debug("Performing recovery in " + latestNameSD + " and "+ latestEditsSD);
  boolean needToSave=false;
  File curFile=NNStorage.getStorageFile(latestNameSD,NameNodeFile.IMAGE);
  File ckptFile=NNStorage.getStorageFile(latestNameSD,NameNodeFile.IMAGE_NEW);
  if (ckptFile.exists()) {
    needToSave=true;
    if (NNStorage.getStorageFile(latestEditsSD,NameNodeFile.EDITS_NEW).exists()) {
      if (!ckptFile.delete()) {
        throw new IOException("Unable to delete " + ckptFile);
      }
    }
 else {
      if (!ckptFile.renameTo(curFile)) {
        if (!curFile.delete())         LOG.warn("Unable to delete dir " + curFile + " before rename");
        if (!ckptFile.renameTo(curFile)) {
          throw new IOException("Unable to rename " + ckptFile + " to "+ curFile);
        }
      }
    }
  }
  return needToSave;
}
