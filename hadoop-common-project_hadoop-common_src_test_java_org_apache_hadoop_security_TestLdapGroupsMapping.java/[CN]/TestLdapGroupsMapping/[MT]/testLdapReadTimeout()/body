{
  final int readTimeoutMs=4 * 1000;
  try (ServerSocket serverSock=new ServerSocket(0)){
    final CountDownLatch finLatch=new CountDownLatch(1);
    final Thread ldapServer=new Thread(new Runnable(){
      @Override public void run(){
        try {
          try (Socket clientSock=serverSock.accept()){
            IOUtils.skipFully(clientSock.getInputStream(),1);
            clientSock.getOutputStream().write(AUTHENTICATE_SUCCESS_MSG);
            finLatch.await();
          }
         }
 catch (        Exception e) {
          e.printStackTrace();
        }
      }
    }
);
    ldapServer.start();
    final LdapGroupsMapping mapping=new LdapGroupsMapping();
    final Configuration conf=new Configuration();
    conf.set(LdapGroupsMapping.LDAP_URL_KEY,"ldap://localhost:" + serverSock.getLocalPort());
    conf.setInt(READ_TIMEOUT,readTimeoutMs);
    mapping.setConf(conf);
    try {
      mapping.doGetGroups("hadoop");
      fail("The LDAP query should have timed out!");
    }
 catch (    NamingException ne) {
      LOG.debug("Got the exception while LDAP querying: ",ne);
      assertExceptionContains("LDAP response read timed out, timeout used:" + readTimeoutMs + "ms",ne);
      assertExceptionContains("remaining name",ne);
    }
 finally {
      finLatch.countDown();
    }
    ldapServer.join();
  }
 }
