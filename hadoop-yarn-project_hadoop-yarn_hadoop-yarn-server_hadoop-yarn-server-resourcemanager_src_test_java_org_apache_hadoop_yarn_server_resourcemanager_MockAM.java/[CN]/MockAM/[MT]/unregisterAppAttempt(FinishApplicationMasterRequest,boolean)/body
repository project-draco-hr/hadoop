{
  if (waitForStateRunning) {
    waitForState(RMAppAttemptState.RUNNING);
  }
  if (ugi == null) {
    ugi=UserGroupInformation.createRemoteUser(attemptId.toString());
    Token<AMRMTokenIdentifier> token=context.getRMApps().get(attemptId.getApplicationId()).getRMAppAttempt(attemptId).getAMRMToken();
    ugi.addTokenIdentifier(token.decodeIdentifier());
  }
  try {
    ugi.doAs(new PrivilegedExceptionAction<Object>(){
      @Override public Object run() throws Exception {
        amRMProtocol.finishApplicationMaster(req);
        return null;
      }
    }
);
  }
 catch (  UndeclaredThrowableException e) {
    throw (Exception)e.getCause();
  }
}
