{
  waitForState(RMAppAttemptState.RUNNING);
  final FinishApplicationMasterRequest req=Records.newRecord(FinishApplicationMasterRequest.class);
  req.setAppAttemptId(attemptId);
  req.setDiagnostics("");
  req.setFinalApplicationStatus(FinalApplicationStatus.SUCCEEDED);
  req.setTrackingUrl("");
  UserGroupInformation ugi=UserGroupInformation.createRemoteUser(attemptId.toString());
  Token<AMRMTokenIdentifier> token=context.getRMApps().get(attemptId.getApplicationId()).getRMAppAttempt(attemptId).getAMRMToken();
  ugi.addTokenIdentifier(token.decodeIdentifier());
  ugi.doAs(new PrivilegedExceptionAction<Object>(){
    @Override public Object run() throws Exception {
      amRMProtocol.finishApplicationMaster(req);
      return null;
    }
  }
);
}
