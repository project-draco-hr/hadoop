{
  conf.setLong(YarnConfiguration.RM_CONTAINER_ALLOC_EXPIRY_INTERVAL_MS,5000);
  MockRM rm1=new MockRM(conf);
  rm1.start();
  MockNM nm1=rm1.registerNode("127.0.0.1:1234",20 * GB);
  RMApp app1=rm1.submitApp(1 * GB,"app","user",null,"default");
  MockAM am1=MockRM.launchAndRegisterAM(app1,rm1,nm1);
  nm1.nodeHeartbeat(app1.getCurrentAppAttempt().getAppAttemptId(),1,ContainerState.RUNNING);
  am1.allocate("127.0.0.1",1 * GB,1,new ArrayList<ContainerId>());
  ContainerId containerId2=ContainerId.newContainerId(am1.getApplicationAttemptId(),2);
  rm1.waitForState(nm1,containerId2,RMContainerState.ALLOCATED);
  List<Container> containers=am1.allocate(null,null).getAllocatedContainers();
  Assert.assertEquals(containerId2,containers.get(0).getId());
  Assert.assertNotNull(containers.get(0).getContainerToken());
  checkUsedResource(rm1,"default",2 * GB,null);
  FiCaSchedulerApp app=TestUtils.getFiCaSchedulerApp(rm1,app1.getApplicationId());
  Assert.assertEquals(2 * GB,app.getAppAttemptResourceUsage().getUsed().getMemorySize());
  verifyAvailableResourceOfSchedulerNode(rm1,nm1.getNodeId(),18 * GB);
  nm1.nodeHeartbeat(app1.getCurrentAppAttempt().getAppAttemptId(),2,ContainerState.RUNNING);
  rm1.waitForState(nm1,containerId2,RMContainerState.RUNNING);
  am1.sendContainerResizingRequest(Collections.singletonList(ContainerResourceChangeRequest.newInstance(containerId2,Resources.createResource(3 * GB))),null);
  nm1.nodeHeartbeat(true);
  Thread.sleep(1000);
  am1.allocate(null,null);
  Resource resource=Resources.clone(rm1.getResourceScheduler().getRMContainer(containerId2).getAllocatedResource());
  nm1.containerIncreaseStatus(getContainer(rm1,containerId2,resource));
  Thread.sleep(10000);
  Assert.assertEquals(RMContainerState.RUNNING,rm1.getResourceScheduler().getRMContainer(containerId2).getState());
  Assert.assertEquals(3 * GB,rm1.getResourceScheduler().getRMContainer(containerId2).getAllocatedResource().getMemorySize());
  checkUsedResource(rm1,"default",4 * GB,null);
  Assert.assertEquals(4 * GB,app.getAppAttemptResourceUsage().getUsed().getMemorySize());
  verifyAvailableResourceOfSchedulerNode(rm1,nm1.getNodeId(),16 * GB);
  rm1.stop();
}
