{
  if (target.exists && (target.stat.isDirectory() || !overwrite)) {
    throw new PathExistsException(target.toString());
  }
  TargetFileSystem targetFs=new TargetFileSystem(target.fs);
  try {
    PathData tempTarget=direct ? target : target.suffix("._COPYING_");
    targetFs.setWriteChecksum(writeChecksum);
    targetFs.writeStreamToFile(in,tempTarget,lazyPersist,direct);
    if (!direct) {
      targetFs.rename(tempTarget,target);
    }
  }
  finally {
    targetFs.close();
  }
}
