{
  NNStorage dstStorage=dstImage.getStorage();
  dstStorage.setStorageInfo(sig);
  if (loadImage) {
    File file=dstStorage.findImageFile(NameNodeFile.IMAGE,sig.mostRecentCheckpointTxId);
    if (file == null) {
      throw new IOException("Couldn't find image file at txid " + sig.mostRecentCheckpointTxId + " even though it should have "+ "just been downloaded");
    }
    dstNamesystem.writeLock();
    try {
      dstImage.reloadFromImageFile(file,dstNamesystem);
    }
  finally {
      dstNamesystem.writeUnlock();
    }
    dstNamesystem.imageLoadComplete();
  }
  CheckpointFaultInjector.getInstance().duringMerge();
  Checkpointer.rollForwardByApplyingLogs(manifest,dstImage,dstNamesystem);
  dstImage.saveFSImageInAllDirs(dstNamesystem,dstImage.getLastAppliedTxId());
  if (!dstNamesystem.isRollingUpgrade()) {
    dstStorage.writeAll();
  }
}
