{
  Configuration conf=new Configuration();
  conf.setClass(YarnConfiguration.RM_SCHEDULER,CapacityScheduler.class,ResourceScheduler.class);
  MockRM rm1=new MockRM(conf);
  rm1.start();
  MockNM nm1=rm1.registerNode("127.0.0.1:1234",8000);
  RMApp app1=rm1.submitApp(1024);
  MockAM am1=MockRM.launchAndRegisterAM(app1,rm1,nm1);
  CapacityScheduler cs=(CapacityScheduler)rm1.getResourceScheduler();
  am1.allocate("127.0.0.1",1024,1,new ArrayList<ContainerId>());
  ContainerId containerId1=ContainerId.newContainerId(am1.getApplicationAttemptId(),2);
  rm1.waitForState(nm1,containerId1,RMContainerState.ALLOCATED);
  RMContainer rmContainer=cs.getRMContainer(containerId1);
  List<ResourceRequest> requests=rmContainer.getResourceRequests();
  FiCaSchedulerApp app=cs.getApplicationAttempt(am1.getApplicationAttemptId());
  FiCaSchedulerNode node=cs.getNode(rmContainer.getAllocatedNode());
  for (  ResourceRequest request : requests) {
    if (request.getResourceName().equals(node.getRackName()) || request.getResourceName().equals(ResourceRequest.ANY)) {
      continue;
    }
    Assert.assertNull(app.getResourceRequest(request.getPriority(),request.getResourceName()));
  }
  cs.killContainer(rmContainer);
  Assert.assertEquals(3,requests.size());
  for (  ResourceRequest request : requests) {
    Assert.assertEquals(1,app.getResourceRequest(request.getPriority(),request.getResourceName()).getNumContainers());
  }
  ContainerId containerId2=ContainerId.newContainerId(am1.getApplicationAttemptId(),3);
  rm1.waitForState(nm1,containerId2,RMContainerState.ALLOCATED);
  List<Container> containers=am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>()).getAllocatedContainers();
  Assert.assertTrue(containers.size() == 1);
}
