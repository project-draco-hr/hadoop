{
  Configuration conf=new HdfsConfiguration();
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(0).format(true).build();
  SecondaryNameNode secondary1=null, secondary2=null;
  try {
    secondary1=startSecondaryNameNode(conf,1);
    secondary2=startSecondaryNameNode(conf,2);
    CheckpointStorage spyImage1=spyOnSecondaryImage(secondary1);
    DelayAnswer delayer=new DelayAnswer(LOG);
    Mockito.doAnswer(delayer).when(spyImage1).saveFSImageInAllDirs(Mockito.anyLong());
    DoCheckpointThread checkpointThread=new DoCheckpointThread(secondary1);
    checkpointThread.start();
    delayer.waitForCall();
    secondary2.doCheckpoint();
    delayer.proceed();
    checkpointThread.join();
    checkpointThread.propagateExceptions();
    NNStorage storage=cluster.getNameNode().getFSImage().getStorage();
    assertEquals(4,storage.getMostRecentCheckpointTxId());
    assertNNHasCheckpoints(cluster,ImmutableList.of(2,4));
    secondary2.doCheckpoint();
    assertEquals(6,storage.getMostRecentCheckpointTxId());
  }
  finally {
    cleanup(secondary1);
    cleanup(secondary2);
    if (cluster != null) {
      cluster.shutdown();
    }
  }
  assertParallelFilesInvariant(cluster,ImmutableList.of(secondary1,secondary2));
  assertNNHasCheckpoints(cluster,ImmutableList.of(4,6));
}
