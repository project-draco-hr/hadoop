{
  String delegTokenRenewer=Master.getMasterPrincipal(conf);
  if (delegTokenRenewer == null || delegTokenRenewer.length() == 0) {
    throw new IOException("Can't get Master Kerberos principal for use as renewer");
  }
  mergeBinaryTokens(credentials,conf);
  String fsName=fs.getCanonicalServiceName();
  if (TokenCache.getDelegationToken(credentials,fsName) == null) {
    List<Token<?>> tokens=fs.getDelegationTokens(delegTokenRenewer,credentials);
    if (tokens != null) {
      for (      Token<?> token : tokens) {
        credentials.addToken(token.getService(),token);
        LOG.info("Got dt for " + fs.getUri() + ";uri="+ fsName+ ";t.service="+ token.getService());
      }
    }
    if (tokens == null || tokens.size() == 0) {
      Token<?> token=fs.getDelegationToken(delegTokenRenewer);
      if (token != null) {
        credentials.addToken(token.getService(),token);
        LOG.info("Got dt for " + fs.getUri() + ";uri="+ fsName+ ";t.service="+ token.getService());
      }
    }
  }
}
