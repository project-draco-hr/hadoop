{
  Path absolutePath=makeAbsolute(p);
  String key=pathToKey(absolutePath);
  FileMetadata metadata=null;
  try {
    metadata=store.retrieveMetadata(key);
  }
 catch (  IOException ex) {
    Throwable innerException=NativeAzureFileSystem.checkForAzureStorageException(ex);
    if (innerException instanceof StorageException && NativeAzureFileSystem.isFileNotFoundException((StorageException)innerException)) {
      throw new FileNotFoundException(String.format("File %s doesn't exists.",p));
    }
    throw ex;
  }
  if (metadata == null) {
    throw new FileNotFoundException("File doesn't exist: " + p);
  }
  permission=applyUMask(permission,metadata.isDir() ? UMaskApplyMode.ChangeExistingDirectory : UMaskApplyMode.ChangeExistingFile);
  if (metadata.getBlobMaterialization() == BlobMaterialization.Implicit) {
    store.storeEmptyFolder(key,createPermissionStatus(permission));
  }
 else   if (!metadata.getPermissionStatus().getPermission().equals(permission)) {
    store.changePermissionStatus(key,new PermissionStatus(metadata.getPermissionStatus().getUserName(),metadata.getPermissionStatus().getGroupName(),permission));
  }
}
