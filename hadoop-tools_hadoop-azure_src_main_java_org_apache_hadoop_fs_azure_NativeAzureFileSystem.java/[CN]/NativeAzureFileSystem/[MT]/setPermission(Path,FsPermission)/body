{
  Path absolutePath=makeAbsolute(p);
  String key=pathToKey(absolutePath);
  FileMetadata metadata=store.retrieveMetadata(key);
  if (metadata == null) {
    throw new FileNotFoundException("File doesn't exist: " + p);
  }
  permission=applyUMask(permission,metadata.isDir() ? UMaskApplyMode.ChangeExistingDirectory : UMaskApplyMode.ChangeExistingFile);
  if (metadata.getBlobMaterialization() == BlobMaterialization.Implicit) {
    store.storeEmptyFolder(key,createPermissionStatus(permission));
  }
 else   if (!metadata.getPermissionStatus().getPermission().equals(permission)) {
    store.changePermissionStatus(key,new PermissionStatus(metadata.getPermissionStatus().getUserName(),metadata.getPermissionStatus().getGroupName(),permission));
  }
}
