{
  FolderRenamePending renamePending=null;
  LOG.debug("Moving {} to {}",src,dst);
  if (containsColon(dst)) {
    throw new IOException("Cannot rename to file " + dst + " through WASB that has colons in the name");
  }
  String srcKey=pathToKey(makeAbsolute(src));
  if (srcKey.length() == 0) {
    return false;
  }
  Path absoluteDst=makeAbsolute(dst);
  String dstKey=pathToKey(absoluteDst);
  FileMetadata dstMetadata=store.retrieveMetadata(dstKey);
  if (dstMetadata != null && dstMetadata.isDir()) {
    dstKey=pathToKey(makeAbsolute(new Path(dst,src.getName())));
    LOG.debug("Destination {} " + " is a directory, adjusted the destination to be {}",dst,dstKey);
  }
 else   if (dstMetadata != null) {
    LOG.debug("Destination {}" + " is an already existing file, failing the rename.",dst);
    return false;
  }
 else {
    FileMetadata parentOfDestMetadata=store.retrieveMetadata(pathToKey(absoluteDst.getParent()));
    if (parentOfDestMetadata == null) {
      LOG.debug("Parent of the destination {}" + " doesn't exist, failing the rename.",dst);
      return false;
    }
 else     if (!parentOfDestMetadata.isDir()) {
      LOG.debug("Parent of the destination {}" + " is a file, failing the rename.",dst);
      return false;
    }
  }
  FileMetadata srcMetadata=store.retrieveMetadata(srcKey);
  if (srcMetadata == null) {
    LOG.debug("Source {} doesn't exist, failing the rename.",src);
    return false;
  }
 else   if (!srcMetadata.isDir()) {
    LOG.debug("Source {} found as a file, renaming.",src);
    store.rename(srcKey,dstKey);
  }
 else {
    renamePending=prepareAtomicFolderRename(srcKey,dstKey);
    renamePending.execute();
    LOG.debug("Renamed {} to {} successfully.",src,dst);
    renamePending.cleanup();
    return true;
  }
  updateParentFolderLastModifiedTime(srcKey);
  updateParentFolderLastModifiedTime(dstKey);
  LOG.debug("Renamed {} to {} successfully.",src,dst);
  return true;
}
