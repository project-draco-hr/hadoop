{
  DatanodeStorageInfo[] storages=DFSTestUtil.createDatanodeStorageInfos(TOTAL_NUM_BLOCKS);
  Block[] blocks=createReportedBlocks(TOTAL_NUM_BLOCKS);
  for (int i=0; i < storages.length; i+=2) {
    Assert.assertEquals(AddBlockResult.ADDED,storages[i].addBlock(info,blocks[i]));
  }
  BlockInfoStriped newBlockInfo=new BlockInfoStriped(info,info.getErasureCodingPolicy());
  newBlockInfo.setBlockCollectionId(info.getBlockCollectionId());
  info.replaceBlock(newBlockInfo);
  byte[] indices=(byte[])Whitebox.getInternalState(newBlockInfo,"indices");
  for (int i=0; i < storages.length; i+=2) {
    int index=newBlockInfo.findStorageInfo(storages[i]);
    Assert.assertEquals(i,index);
    Assert.assertEquals(index,indices[i]);
    Assert.assertSame(newBlockInfo,storages[i].getBlockListHeadForTesting());
    Assert.assertEquals(1,storages[i].numBlocks());
    Assert.assertNull(newBlockInfo.getNext());
  }
}
