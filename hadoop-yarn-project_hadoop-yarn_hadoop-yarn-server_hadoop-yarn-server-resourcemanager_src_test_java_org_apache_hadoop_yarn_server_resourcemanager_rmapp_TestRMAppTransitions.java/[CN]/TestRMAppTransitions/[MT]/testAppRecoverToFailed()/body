{
  LOG.info("--- START: testAppRecoverToFailed ---");
  ApplicationSubmissionContext sub=Records.newRecord(ApplicationSubmissionContext.class);
  ContainerLaunchContext clc=Records.newRecord(ContainerLaunchContext.class);
  Credentials credentials=new Credentials();
  DataOutputBuffer dob=new DataOutputBuffer();
  credentials.writeTokenStorageToStream(dob);
  ByteBuffer securityTokens=ByteBuffer.wrap(dob.getData(),0,dob.getLength());
  clc.setTokens(securityTokens);
  sub.setAMContainerSpec(clc);
  RMApp application=createNewTestApp(sub);
  RMState state=new RMState();
  RMAppEvent event=new RMAppRecoverEvent(application.getApplicationId(),state);
  application.handle(event);
  assertAppState(RMAppState.FINAL_SAVING,application);
  sendAppUpdateSavedEvent(application);
  rmDispatcher.await();
  assertAppState(RMAppState.FAILED,application);
}
