{
  LOG.info("--- START: testAppAcceptedFailed ---");
  RMApp application=testCreateAppAccepted(null);
  Assert.assertTrue(maxAppAttempts > 1);
  for (int i=1; i < maxAppAttempts; i++) {
    RMAppEvent event=new RMAppFailedAttemptEvent(application.getApplicationId(),RMAppEventType.ATTEMPT_FAILED,"",false);
    application.handle(event);
    assertAppState(RMAppState.ACCEPTED,application);
    event=new RMAppEvent(application.getApplicationId(),RMAppEventType.APP_ACCEPTED);
    application.handle(event);
    rmDispatcher.await();
    assertAppState(RMAppState.ACCEPTED,application);
  }
  String message="Test fail";
  RMAppEvent event=new RMAppFailedAttemptEvent(application.getApplicationId(),RMAppEventType.ATTEMPT_FAILED,message,false);
  application.handle(event);
  rmDispatcher.await();
  sendAppUpdateSavedEvent(application);
  assertFailed(application,".*" + message + ".*Failing the application.*");
  assertAppFinalStateSaved(application);
  verify(writer).applicationFinished(any(RMApp.class));
}
