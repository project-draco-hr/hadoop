{
  RMApp application=null;
  if (submissionContext != null && submissionContext.getUnmanagedAM()) {
    application=testCreateAppRunning(submissionContext);
  }
 else {
    application=testCreateAppFinishing(submissionContext);
  }
  RMAppEvent finishedEvent=new RMAppFinishedAttemptEvent(application.getApplicationId(),diagnostics);
  application.handle(finishedEvent);
  assertAppState(RMAppState.FINISHED,application);
  assertTimesAtFinish(application);
  assertFinalAppStatus(FinalApplicationStatus.FAILED,application);
  Assert.assertTrue("Finished app missing diagnostics",application.getDiagnostics().indexOf(diagnostics) != -1);
  return application;
}
