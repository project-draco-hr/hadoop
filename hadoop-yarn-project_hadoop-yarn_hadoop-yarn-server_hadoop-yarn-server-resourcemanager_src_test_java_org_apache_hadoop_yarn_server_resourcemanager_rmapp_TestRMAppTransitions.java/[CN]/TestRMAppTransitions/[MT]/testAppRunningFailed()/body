{
  LOG.info("--- START: testAppRunningFailed ---");
  RMApp application=testCreateAppRunning(null);
  RMAppAttempt appAttempt=application.getCurrentAppAttempt();
  int expectedAttemptId=1;
  Assert.assertEquals(expectedAttemptId,appAttempt.getAppAttemptId().getAttemptId());
  Assert.assertTrue(maxAppAttempts > 1);
  for (int i=1; i < maxAppAttempts; i++) {
    RMAppEvent event=new RMAppFailedAttemptEvent(application.getApplicationId(),RMAppEventType.ATTEMPT_FAILED,"",false);
    application.handle(event);
    rmDispatcher.await();
    assertAppState(RMAppState.ACCEPTED,application);
    appAttempt=application.getCurrentAppAttempt();
    Assert.assertEquals(++expectedAttemptId,appAttempt.getAppAttemptId().getAttemptId());
    event=new RMAppEvent(application.getApplicationId(),RMAppEventType.APP_ACCEPTED);
    application.handle(event);
    rmDispatcher.await();
    assertAppState(RMAppState.ACCEPTED,application);
    event=new RMAppEvent(application.getApplicationId(),RMAppEventType.ATTEMPT_REGISTERED);
    application.handle(event);
    rmDispatcher.await();
    assertAppState(RMAppState.RUNNING,application);
  }
  RMAppEvent event=new RMAppFailedAttemptEvent(application.getApplicationId(),RMAppEventType.ATTEMPT_FAILED,"",false);
  application.handle(event);
  rmDispatcher.await();
  sendAppUpdateSavedEvent(application);
  assertFailed(application,".*Failing the application.*");
  assertAppFinalStateSaved(application);
  event=new RMAppEvent(application.getApplicationId(),RMAppEventType.KILL);
  application.handle(event);
  rmDispatcher.await();
  assertFailed(application,".*Failing the application.*");
  assertAppFinalStateSaved(application);
  verifyApplicationFinished(RMAppState.FAILED);
}
