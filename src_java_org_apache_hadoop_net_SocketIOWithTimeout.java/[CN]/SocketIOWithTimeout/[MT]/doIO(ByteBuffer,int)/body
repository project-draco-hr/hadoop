{
  if (!buf.hasRemaining()) {
    throw new IllegalArgumentException("Buffer has no data left.");
  }
  while (buf.hasRemaining()) {
    if (closed) {
      return -1;
    }
    try {
      int n=performIO(buf);
      if (n != 0) {
        return n;
      }
    }
 catch (    IOException e) {
      if (!channel.isOpen()) {
        closed=true;
      }
      throw e;
    }
    int count=0;
    try {
      count=selector.select(channel,ops,timeout);
    }
 catch (    IOException e) {
      closed=true;
      throw e;
    }
    if (count == 0) {
      throw new SocketTimeoutException(timeoutExceptionString(channel,timeout,ops));
    }
  }
  return 0;
}
