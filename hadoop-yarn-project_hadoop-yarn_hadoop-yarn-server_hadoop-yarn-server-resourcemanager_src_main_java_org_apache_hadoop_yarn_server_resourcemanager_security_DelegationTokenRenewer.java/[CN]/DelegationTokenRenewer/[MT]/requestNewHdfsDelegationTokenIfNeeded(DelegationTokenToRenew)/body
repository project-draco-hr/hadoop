{
  if (hasProxyUserPrivileges && dttr.maxDate - dttr.expirationDate < credentialsValidTimeRemaining && dttr.token.getKind().equals(HDFS_DELEGATION_KIND)) {
    final Collection<ApplicationId> applicationIds;
synchronized (dttr.referringAppIds) {
      applicationIds=new HashSet<>(dttr.referringAppIds);
      dttr.referringAppIds.clear();
    }
    for (    ApplicationId appId : applicationIds) {
      Set<DelegationTokenToRenew> tokenSet=appTokens.get(appId);
      if (tokenSet == null || tokenSet.isEmpty()) {
        continue;
      }
      Iterator<DelegationTokenToRenew> iter=tokenSet.iterator();
synchronized (tokenSet) {
        while (iter.hasNext()) {
          DelegationTokenToRenew t=iter.next();
          if (t.token.getKind().equals(HDFS_DELEGATION_KIND)) {
            iter.remove();
            allTokens.remove(t.token);
            t.cancelTimer();
            LOG.info("Removed expiring token " + t);
          }
        }
      }
    }
    LOG.info("Token= (" + dttr + ") is expiring, request new token.");
    requestNewHdfsDelegationToken(applicationIds,dttr.user,dttr.shouldCancelAtEnd);
  }
}
