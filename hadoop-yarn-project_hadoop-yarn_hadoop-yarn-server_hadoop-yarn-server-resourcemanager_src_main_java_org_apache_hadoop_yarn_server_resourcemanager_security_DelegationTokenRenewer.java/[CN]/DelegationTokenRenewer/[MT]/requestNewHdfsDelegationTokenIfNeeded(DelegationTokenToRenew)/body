{
  if (hasProxyUserPrivileges && dttr.maxDate - dttr.expirationDate < credentialsValidTimeRemaining && dttr.token.getKind().equals(new Text("HDFS_DELEGATION_TOKEN"))) {
    Set<DelegationTokenToRenew> tokenSet=appTokens.get(dttr.applicationId);
    if (tokenSet != null && !tokenSet.isEmpty()) {
      Iterator<DelegationTokenToRenew> iter=tokenSet.iterator();
synchronized (tokenSet) {
        while (iter.hasNext()) {
          DelegationTokenToRenew t=iter.next();
          if (t.token.getKind().equals(new Text("HDFS_DELEGATION_TOKEN"))) {
            iter.remove();
            if (t.timerTask != null) {
              t.timerTask.cancel();
            }
            LOG.info("Removed expiring token " + t);
          }
        }
      }
    }
    LOG.info("Token= (" + dttr + ") is expiring, request new token.");
    requestNewHdfsDelegationToken(dttr.applicationId,dttr.user,dttr.shouldCancelAtEnd);
  }
}
