{
  mgr.addToCluserNodeLabelsWithDefaultExclusivity(ImmutableSet.of("x","y","z"));
  mgr.addLabelsToNode(ImmutableMap.of(NodeId.newInstance("h1",0),toSet("x")));
  mgr.addLabelsToNode(ImmutableMap.of(NodeId.newInstance("h2",0),toSet("y")));
  MockRM rm=new MockRM(getConfigurationWithQueueLabels(conf)){
    @Override public RMNodeLabelsManager createNodeLabelManager(){
      return mgr;
    }
  }
;
  rm.getRMContext().setNodeLabelManager(mgr);
  rm.start();
  MockNM nm1=rm.registerNode("h1:1234",8000);
  MockNM nm2=rm.registerNode("h2:1234",8000);
  MockNM nm3=rm.registerNode("h3:1234",8000);
  ContainerId containerId1;
  ContainerId containerId2;
  RMApp app1=rm.submitApp(GB,"app","user",null,"a");
  MockAM am1=MockRM.launchAndRegisterAM(app1,rm,nm3);
  am1.allocate("*",GB,1,new ArrayList<ContainerId>(),"x");
  containerId1=ContainerId.newContainerId(am1.getApplicationAttemptId(),1);
  containerId2=ContainerId.newContainerId(am1.getApplicationAttemptId(),2);
  Assert.assertTrue(rm.waitForState(nm1,containerId2,RMContainerState.ALLOCATED,10 * 1000));
  checkUsedResource(rm,"a",1024,"x");
  checkUsedResource(rm,"a",1024);
  CapacityScheduler cs=(CapacityScheduler)rm.getResourceScheduler();
  FiCaSchedulerApp app=cs.getApplicationAttempt(am1.getApplicationAttemptId());
  cs.handle(new NodeLabelsUpdateSchedulerEvent(ImmutableMap.of(nm1.getNodeId(),toSet("z"))));
  checkUsedResource(rm,"a",0,"x");
  checkUsedResource(rm,"a",1024,"z");
  checkUsedResource(rm,"a",1024);
  checkUsedResource(rm,"root",0,"x");
  checkUsedResource(rm,"root",1024,"z");
  checkUsedResource(rm,"root",1024);
  checkUserUsedResource(rm,"a","user","x",0);
  checkUserUsedResource(rm,"a","user","z",1024);
  Assert.assertEquals(0,app.getAppAttemptResourceUsage().getUsed("x").getMemory());
  Assert.assertEquals(1024,app.getAppAttemptResourceUsage().getUsed("z").getMemory());
  cs.handle(new NodeLabelsUpdateSchedulerEvent(ImmutableMap.of(nm1.getNodeId(),toSet("y"))));
  checkUsedResource(rm,"a",0,"x");
  checkUsedResource(rm,"a",1024,"y");
  checkUsedResource(rm,"a",0,"z");
  checkUsedResource(rm,"a",1024);
  checkUsedResource(rm,"root",0,"x");
  checkUsedResource(rm,"root",1024,"y");
  checkUsedResource(rm,"root",0,"z");
  checkUsedResource(rm,"root",1024);
  checkUserUsedResource(rm,"a","user","x",0);
  checkUserUsedResource(rm,"a","user","y",1024);
  checkUserUsedResource(rm,"a","user","z",0);
  Assert.assertEquals(0,app.getAppAttemptResourceUsage().getUsed("x").getMemory());
  Assert.assertEquals(1024,app.getAppAttemptResourceUsage().getUsed("y").getMemory());
  Assert.assertEquals(0,app.getAppAttemptResourceUsage().getUsed("z").getMemory());
  Set<String> emptyLabels=new HashSet<>();
  Map<NodeId,Set<String>> map=ImmutableMap.of(nm1.getNodeId(),emptyLabels);
  cs.handle(new NodeLabelsUpdateSchedulerEvent(map));
  checkUsedResource(rm,"a",0,"x");
  checkUsedResource(rm,"a",0,"y");
  checkUsedResource(rm,"a",0,"z");
  checkUsedResource(rm,"a",2048);
  checkUsedResource(rm,"root",0,"x");
  checkUsedResource(rm,"root",0,"y");
  checkUsedResource(rm,"root",0,"z");
  checkUsedResource(rm,"root",2048);
  checkUserUsedResource(rm,"a","user","x",0);
  checkUserUsedResource(rm,"a","user","y",0);
  checkUserUsedResource(rm,"a","user","z",0);
  checkUserUsedResource(rm,"a","user","",2048);
  Assert.assertEquals(0,app.getAppAttemptResourceUsage().getUsed("x").getMemory());
  Assert.assertEquals(0,app.getAppAttemptResourceUsage().getUsed("y").getMemory());
  Assert.assertEquals(0,app.getAppAttemptResourceUsage().getUsed("z").getMemory());
  Assert.assertEquals(2048,app.getAppAttemptResourceUsage().getUsed("").getMemory());
  cs.completedContainer(cs.getRMContainer(containerId2),ContainerStatus.newInstance(containerId2,ContainerState.COMPLETE,"",ContainerExitStatus.KILLED_BY_RESOURCEMANAGER),RMContainerEventType.KILL);
  cs.completedContainer(cs.getRMContainer(containerId1),ContainerStatus.newInstance(containerId1,ContainerState.COMPLETE,"",ContainerExitStatus.KILLED_BY_RESOURCEMANAGER),RMContainerEventType.KILL);
  checkUsedResource(rm,"a",0,"x");
  checkUsedResource(rm,"a",0,"y");
  checkUsedResource(rm,"a",0,"z");
  checkUsedResource(rm,"a",0);
  checkUsedResource(rm,"root",0,"x");
  checkUsedResource(rm,"root",0,"y");
  checkUsedResource(rm,"root",0,"z");
  checkUsedResource(rm,"root",0);
  checkUserUsedResource(rm,"a","user","x",0);
  checkUserUsedResource(rm,"a","user","y",0);
  checkUserUsedResource(rm,"a","user","z",0);
  checkUserUsedResource(rm,"a","user","",0);
  rm.close();
}
