{
  DirectoryWithSnapshotFeature sf=getDirectoryWithSnapshotFeature();
  if (sf != null) {
    return sf.cleanDirectory(this,snapshotId,priorSnapshotId,collectedBlocks,removedINodes);
  }
  if (priorSnapshotId == Snapshot.NO_SNAPSHOT_ID && snapshotId == Snapshot.CURRENT_STATE_ID) {
    Quota.Counts counts=Quota.Counts.newInstance();
    this.computeQuotaUsage(counts,true);
    destroyAndCollectBlocks(collectedBlocks,removedINodes);
    return counts;
  }
 else {
    Quota.Counts counts=cleanSubtreeRecursively(snapshotId,priorSnapshotId,collectedBlocks,removedINodes,null);
    if (isQuotaSet()) {
      getDirectoryWithQuotaFeature().addSpaceConsumed2Cache(-counts.get(Quota.NAMESPACE),-counts.get(Quota.DISKSPACE));
    }
    return counts;
  }
}
