{
  DirectoryWithQuotaFeature quota=getDirectoryWithQuotaFeature();
  if (quota != null) {
    if (type != null) {
      quota.setQuota(dsQuota,type);
    }
 else {
      quota.setQuota(nsQuota,dsQuota);
    }
    if (!isQuotaSet() && !isRoot()) {
      removeFeature(quota);
    }
  }
 else {
    final QuotaCounts c=computeQuotaUsage(bsps);
    DirectoryWithQuotaFeature.Builder builder=new DirectoryWithQuotaFeature.Builder().nameSpaceQuota(nsQuota);
    if (type != null) {
      builder.typeQuota(type,dsQuota);
    }
 else {
      builder.spaceQuota(dsQuota);
    }
    addDirectoryWithQuotaFeature(builder.build()).setSpaceConsumed(c);
  }
}
