{
  Preconditions.checkState(!(this instanceof INodeDirectoryWithQuota),"this is already an INodeDirectoryWithQuota, this=%s",this);
  if (!this.isInLatestSnapshot(latest)) {
    final INodeDirectoryWithQuota q=new INodeDirectoryWithQuota(this,true,nsQuota,dsQuota);
    replaceSelf(q,inodeMap);
    return q;
  }
 else {
    final INodeDirectoryWithSnapshot s=new INodeDirectoryWithSnapshot(this);
    s.setQuota(nsQuota,dsQuota);
    return replaceSelf(s,inodeMap).saveSelf2Snapshot(latest,this);
  }
}
