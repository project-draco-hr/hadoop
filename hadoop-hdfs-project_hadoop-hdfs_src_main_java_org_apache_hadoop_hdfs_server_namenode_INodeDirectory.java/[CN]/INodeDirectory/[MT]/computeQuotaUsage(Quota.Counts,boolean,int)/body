{
  final DirectoryWithSnapshotFeature sf=getDirectoryWithSnapshotFeature();
  if (sf != null && lastSnapshotId != Snapshot.INVALID_ID && !(useCache && isQuotaSet())) {
    Snapshot lastSnapshot=sf.getDiffs().getSnapshotById(lastSnapshotId);
    ReadOnlyList<INode> childrenList=getChildrenList(lastSnapshot);
    for (    INode child : childrenList) {
      child.computeQuotaUsage(counts,useCache,lastSnapshotId);
    }
    counts.add(Quota.NAMESPACE,1);
    return counts;
  }
  final DirectoryWithQuotaFeature q=getDirectoryWithQuotaFeature();
  if (useCache && q != null && q.isQuotaSet()) {
    return q.addNamespaceDiskspace(counts);
  }
 else {
    useCache=q != null && !q.isQuotaSet() ? false : useCache;
    return computeDirectoryQuotaUsage(counts,useCache,lastSnapshotId);
  }
}
