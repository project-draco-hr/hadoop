{
  final DirectoryWithSnapshotFeature sf=getDirectoryWithSnapshotFeature();
  QuotaCounts counts=new QuotaCounts.Builder().build();
  if (sf != null && lastSnapshotId != Snapshot.CURRENT_STATE_ID && !(useCache && isQuotaSet())) {
    ReadOnlyList<INode> childrenList=getChildrenList(lastSnapshotId);
    for (    INode child : childrenList) {
      final byte childPolicyId=child.getStoragePolicyIDForQuota(blockStoragePolicyId);
      counts.add(child.computeQuotaUsage(bsps,childPolicyId,useCache,lastSnapshotId));
    }
    counts.addNameSpace(1);
    return counts;
  }
  final DirectoryWithQuotaFeature q=getDirectoryWithQuotaFeature();
  if (useCache && q != null && q.isQuotaSet()) {
    return q.AddCurrentSpaceUsage(counts);
  }
 else {
    useCache=q != null && !q.isQuotaSet() ? false : useCache;
    return computeDirectoryQuotaUsage(bsps,blockStoragePolicyId,counts,useCache,lastSnapshotId);
  }
}
