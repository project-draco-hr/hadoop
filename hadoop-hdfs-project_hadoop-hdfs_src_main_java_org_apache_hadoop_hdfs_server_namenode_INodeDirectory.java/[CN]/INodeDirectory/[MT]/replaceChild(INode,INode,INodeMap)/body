{
  Preconditions.checkNotNull(children);
  final int i=searchChildren(newChild.getLocalNameBytes());
  Preconditions.checkState(i >= 0);
  Preconditions.checkState(oldChild == children.get(i) || oldChild == children.get(i).asReference().getReferredINode().asReference().getReferredINode());
  oldChild=children.get(i);
  if (oldChild.isReference() && !newChild.isReference()) {
    final INode withCount=oldChild.asReference().getReferredINode();
    withCount.asReference().setReferredINode(newChild);
  }
 else {
    if (oldChild.isReference()) {
      final INodeReference.WithCount withCount=(WithCount)oldChild.asReference().getReferredINode();
      withCount.removeReference(oldChild.asReference());
    }
    children.set(i,newChild);
  }
  if (inodeMap != null) {
    inodeMap.put(newChild);
  }
}
