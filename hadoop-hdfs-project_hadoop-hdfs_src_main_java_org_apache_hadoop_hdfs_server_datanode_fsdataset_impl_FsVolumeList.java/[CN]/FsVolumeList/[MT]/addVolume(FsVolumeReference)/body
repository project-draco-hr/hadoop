{
  while (true) {
    final FsVolumeImpl[] curVolumes=volumes.get();
    final List<FsVolumeImpl> volumeList=Lists.newArrayList(curVolumes);
    volumeList.add((FsVolumeImpl)ref.getVolume());
    if (volumes.compareAndSet(curVolumes,volumeList.toArray(new FsVolumeImpl[volumeList.size()]))) {
      break;
    }
 else {
      if (FsDatasetImpl.LOG.isDebugEnabled()) {
        FsDatasetImpl.LOG.debug("The volume list has been changed concurrently, " + "retry to remove volume: " + ref.getVolume().getStorageID());
      }
    }
  }
  if (blockScanner != null) {
    blockScanner.addVolumeScanner(ref);
  }
 else {
    IOUtils.cleanup(FsDatasetImpl.LOG,ref);
  }
  removeVolumeFailureInfo(new File(ref.getVolume().getBasePath()));
  FsDatasetImpl.LOG.info("Added new volume: " + ref.getVolume().getStorageID());
}
