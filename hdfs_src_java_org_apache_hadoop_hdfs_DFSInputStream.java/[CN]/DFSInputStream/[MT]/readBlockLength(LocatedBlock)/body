{
  if (locatedblock == null || locatedblock.getLocations().length == 0) {
    return 0;
  }
  int replicaNotFoundCount=locatedblock.getLocations().length;
  for (  DatanodeInfo datanode : locatedblock.getLocations()) {
    ClientDatanodeProtocol cdp=null;
    try {
      cdp=DFSClient.createClientDatanodeProtocolProxy(datanode,dfsClient.conf,dfsClient.socketTimeout,locatedblock);
      final long n=cdp.getReplicaVisibleLength(locatedblock.getBlock());
      if (n >= 0) {
        return n;
      }
    }
 catch (    IOException ioe) {
      if (ioe instanceof RemoteException && (((RemoteException)ioe).unwrapRemoteException() instanceof ReplicaNotFoundException)) {
        replicaNotFoundCount--;
      }
      if (DFSClient.LOG.isDebugEnabled()) {
        DFSClient.LOG.debug("Failed to getReplicaVisibleLength from datanode " + datanode + " for block "+ locatedblock.getBlock(),ioe);
      }
    }
 finally {
      if (cdp != null) {
        RPC.stopProxy(cdp);
      }
    }
  }
  if (replicaNotFoundCount == 0) {
    return 0;
  }
  throw new IOException("Cannot obtain block length for " + locatedblock);
}
