{
  List<Path> localDirs=new ArrayList<Path>();
  String[] sDirs=new String[1];
  localDirs.add(lfs.makeQualified(new Path(basedir,0 + "")));
  sDirs[0]=localDirs.get(0).toString();
  conf.setStrings(YarnConfiguration.NM_LOCAL_DIRS,sDirs);
  DrainDispatcher dispatcher=new DrainDispatcher();
  dispatcher.init(conf);
  dispatcher.start();
  EventHandler<ApplicationEvent> applicationBus=mock(EventHandler.class);
  dispatcher.register(ApplicationEventType.class,applicationBus);
  EventHandler<ContainerEvent> containerBus=mock(EventHandler.class);
  dispatcher.register(ContainerEventType.class,containerBus);
  DummyExecutor exec=new DummyExecutor();
  LocalDirsHandlerService dirsHandler=new LocalDirsHandlerService();
  dirsHandler.init(conf);
  DeletionService delServiceReal=new DeletionService(exec);
  DeletionService delService=spy(delServiceReal);
  delService.init(new Configuration());
  delService.start();
  ResourceLocalizationService rawService=new ResourceLocalizationService(dispatcher,exec,delService,dirsHandler,nmContext);
  ResourceLocalizationService spyService=spy(rawService);
  doReturn(mockServer).when(spyService).createServer();
  doReturn(lfs).when(spyService).getLocalFileContext(isA(Configuration.class));
  FsPermission defaultPermission=FsPermission.getDirDefault().applyUMask(lfs.getUMask());
  FsPermission nmPermission=ResourceLocalizationService.NM_PRIVATE_PERM.applyUMask(lfs.getUMask());
  final Path userDir=new Path(sDirs[0].substring("file:".length()),ContainerLocalizer.USERCACHE);
  final Path fileDir=new Path(sDirs[0].substring("file:".length()),ContainerLocalizer.FILECACHE);
  final Path sysDir=new Path(sDirs[0].substring("file:".length()),ResourceLocalizationService.NM_PRIVATE_DIR);
  final FileStatus fs=new FileStatus(0,true,1,0,System.currentTimeMillis(),0,defaultPermission,"","",new Path(sDirs[0]));
  final FileStatus nmFs=new FileStatus(0,true,1,0,System.currentTimeMillis(),0,nmPermission,"","",sysDir);
  doAnswer(new Answer<FileStatus>(){
    @Override public FileStatus answer(    InvocationOnMock invocation) throws Throwable {
      Object[] args=invocation.getArguments();
      if (args.length > 0) {
        if (args[0].equals(userDir) || args[0].equals(fileDir)) {
          return fs;
        }
      }
      return nmFs;
    }
  }
).when(spylfs).getFileStatus(isA(Path.class));
  try {
    spyService.init(conf);
    spyService.start();
    final Application app=mock(Application.class);
    final ApplicationId appId=BuilderUtils.newApplicationId(314159265358979L,3);
    String user="user0";
    when(app.getUser()).thenReturn(user);
    when(app.getAppId()).thenReturn(appId);
    spyService.handle(new ApplicationLocalizationEvent(LocalizationEventType.INIT_APPLICATION_RESOURCES,app));
    ArgumentMatcher<ApplicationEvent> matchesAppInit=new ArgumentMatcher<ApplicationEvent>(){
      @Override public boolean matches(      Object o){
        ApplicationEvent evt=(ApplicationEvent)o;
        return evt.getType() == ApplicationEventType.APPLICATION_INITED && appId == evt.getApplicationID();
      }
    }
;
    dispatcher.await();
    verify(applicationBus).handle(argThat(matchesAppInit));
    Random r=new Random();
    long seed=r.nextLong();
    System.out.println("SEED: " + seed);
    r.setSeed(seed);
    final Container c1=getMockContainer(appId,42,"user0");
    final Container c2=getMockContainer(appId,43,"user0");
    FSDataOutputStream out=new FSDataOutputStream(new DataOutputBuffer(),null);
    doReturn(out).when(spylfs).createInternal(isA(Path.class),isA(EnumSet.class),isA(FsPermission.class),anyInt(),anyShort(),anyLong(),isA(Progressable.class),isA(ChecksumOpt.class),anyBoolean());
    final LocalResource resource1=getPrivateMockedResource(r);
    LocalResource resource2=null;
    do {
      resource2=getPrivateMockedResource(r);
    }
 while (resource2 == null || resource2.equals(resource1));
    LocalResource resource3=null;
    do {
      resource3=getPrivateMockedResource(r);
    }
 while (resource3 == null || resource3.equals(resource1) || resource3.equals(resource2));
    final LocalResourceRequest req1=new LocalResourceRequest(resource1);
    final LocalResourceRequest req2=new LocalResourceRequest(resource2);
    final LocalResourceRequest req3=new LocalResourceRequest(resource3);
    Map<LocalResourceVisibility,Collection<LocalResourceRequest>> rsrcs=new HashMap<LocalResourceVisibility,Collection<LocalResourceRequest>>();
    List<LocalResourceRequest> privateResourceList=new ArrayList<LocalResourceRequest>();
    privateResourceList.add(req1);
    privateResourceList.add(req2);
    privateResourceList.add(req3);
    rsrcs.put(LocalResourceVisibility.PRIVATE,privateResourceList);
    spyService.handle(new ContainerLocalizationRequestEvent(c1,rsrcs));
    final LocalResourceRequest req1_1=new LocalResourceRequest(resource2);
    Map<LocalResourceVisibility,Collection<LocalResourceRequest>> rsrcs1=new HashMap<LocalResourceVisibility,Collection<LocalResourceRequest>>();
    List<LocalResourceRequest> privateResourceList1=new ArrayList<LocalResourceRequest>();
    privateResourceList1.add(req1_1);
    rsrcs1.put(LocalResourceVisibility.PRIVATE,privateResourceList1);
    spyService.handle(new ContainerLocalizationRequestEvent(c2,rsrcs1));
    dispatcher.await();
    exec.waitForLocalizers(2);
    LocalizerRunner locC1=spyService.getLocalizerRunner(c1.getContainerId().toString());
    final String containerIdStr=c1.getContainerId().toString();
    LocalResourceStatus rsrc1success=mock(LocalResourceStatus.class);
    LocalResourceStatus rsrc2pending=mock(LocalResourceStatus.class);
    LocalizerStatus stat=mock(LocalizerStatus.class);
    when(stat.getLocalizerId()).thenReturn(containerIdStr);
    when(rsrc1success.getResource()).thenReturn(resource1);
    when(rsrc2pending.getResource()).thenReturn(resource2);
    when(rsrc1success.getLocalSize()).thenReturn(4344L);
    URL locPath=getPath("/some/path");
    when(rsrc1success.getLocalPath()).thenReturn(locPath);
    when(rsrc1success.getStatus()).thenReturn(ResourceStatusType.FETCH_SUCCESS);
    when(rsrc2pending.getStatus()).thenReturn(ResourceStatusType.FETCH_PENDING);
    when(stat.getResources()).thenReturn(Collections.<LocalResourceStatus>emptyList()).thenReturn(Collections.singletonList(rsrc1success)).thenReturn(Collections.singletonList(rsrc2pending)).thenReturn(Collections.singletonList(rsrc2pending)).thenReturn(Collections.<LocalResourceStatus>emptyList());
    LocalizerHeartbeatResponse response=spyService.heartbeat(stat);
    assertEquals(LocalizerAction.LIVE,response.getLocalizerAction());
    response=spyService.heartbeat(stat);
    assertEquals(LocalizerAction.LIVE,response.getLocalizerAction());
    final String locPath1=response.getResourceSpecs().get(0).getDestinationDirectory().getFile();
    response=spyService.heartbeat(stat);
    assertEquals(LocalizerAction.LIVE,response.getLocalizerAction());
    final String locPath2=response.getResourceSpecs().get(0).getDestinationDirectory().getFile();
    spyService.handle(new ContainerLocalizationCleanupEvent(c1,rsrcs));
    response=spyService.heartbeat(stat);
    assertEquals(LocalizerAction.DIE,response.getLocalizerAction());
    exec.setStopLocalization();
    dispatcher.await();
    ArgumentMatcher<ContainerEvent> successContainerLoc=new ArgumentMatcher<ContainerEvent>(){
      @Override public boolean matches(      Object o){
        ContainerEvent evt=(ContainerEvent)o;
        return evt.getType() == ContainerEventType.RESOURCE_LOCALIZED && c1.getContainerId() == evt.getContainerID();
      }
    }
;
    verify(containerBus).handle(argThat(successContainerLoc));
    Set<Path> paths=Sets.newHashSet(new Path(locPath1),new Path(locPath1 + "_tmp"),new Path(locPath2),new Path(locPath2 + "_tmp"));
    while (locC1.getState() != Thread.State.TERMINATED) {
      Thread.sleep(50);
    }
    verify(delService).delete(eq(user),(Path)eq(null),argThat(new DownloadingPathsMatcher(paths)));
    LocalResourcesTracker tracker=spyService.getLocalResourcesTracker(LocalResourceVisibility.PRIVATE,"user0",appId);
    LocalizedResource rsrc1=tracker.getLocalizedResource(req1);
    assertNotNull(rsrc1);
    assertEquals(rsrc1.getState(),ResourceState.LOCALIZED);
    assertEquals(rsrc1.getRefCount(),0);
    LocalizedResource rsrc2=tracker.getLocalizedResource(req2);
    assertNotNull(rsrc2);
    assertEquals(rsrc2.getState(),ResourceState.DOWNLOADING);
    assertEquals(rsrc2.getRefCount(),1);
    LocalizedResource rsrc3=tracker.getLocalizedResource(req3);
    assertNull(rsrc3);
  }
  finally {
    spyService.stop();
    dispatcher.stop();
    delService.stop();
  }
}
