{
  int expectedLength=expected.getBytes().length;
  assertEquals(expectedLength,buf.size());
  byte[] framed=buf.toByteArray();
  assertEquals(expectedLength + 4,framed.length);
  DataInputStream dis=new DataInputStream(new ByteArrayInputStream(framed));
  assertEquals(expectedLength,dis.readInt());
  assertEquals(expectedLength,dis.available());
  byte[] payload=new byte[expectedLength];
  dis.readFully(payload);
  assertEquals(expected,new String(payload));
}
