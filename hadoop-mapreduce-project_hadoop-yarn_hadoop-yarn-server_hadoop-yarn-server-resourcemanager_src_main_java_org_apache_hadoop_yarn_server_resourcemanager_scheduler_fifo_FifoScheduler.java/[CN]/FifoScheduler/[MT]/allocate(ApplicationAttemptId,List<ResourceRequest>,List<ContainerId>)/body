{
  SchedulerApp application=getApplication(applicationAttemptId);
  if (application == null) {
    LOG.error("Calling allocate on removed " + "or non existant application " + applicationAttemptId);
    return EMPTY_ALLOCATION;
  }
  normalizeRequests(ask);
  for (  ContainerId releasedContainer : release) {
    containerCompleted(getRMContainer(releasedContainer),RMContainerEventType.RELEASED);
  }
  if (!ask.isEmpty()) {
    LOG.debug("allocate: pre-update" + " applicationId=" + applicationAttemptId + " application="+ application);
    application.showRequests();
    application.updateResourceRequests(ask);
    LOG.debug("allocate: post-update" + " applicationId=" + applicationAttemptId + " application="+ application);
    application.showRequests();
    LOG.debug("allocate:" + " applicationId=" + applicationAttemptId + " #ask="+ ask.size());
  }
  return new Allocation(application.pullNewlyAllocatedContainers(),application.getHeadroom());
}
