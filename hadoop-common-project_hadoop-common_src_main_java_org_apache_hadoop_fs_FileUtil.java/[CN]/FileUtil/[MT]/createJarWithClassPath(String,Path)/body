{
  @SuppressWarnings("unchecked") Map<String,String> env=Shell.WINDOWS ? new CaseInsensitiveMap(System.getenv()) : System.getenv();
  String[] classPathEntries=inputClassPath.split(File.pathSeparator);
  for (int i=0; i < classPathEntries.length; ++i) {
    classPathEntries[i]=StringUtils.replaceTokens(classPathEntries[i],StringUtils.ENV_VAR_PATTERN,env);
  }
  File workingDir=new File(pwd.toString());
  if (!workingDir.mkdirs()) {
    LOG.debug("mkdirs false for " + workingDir + ", execution will continue");
  }
  List<String> classPathEntryList=new ArrayList<String>(classPathEntries.length);
  for (  String classPathEntry : classPathEntries) {
    if (classPathEntry.endsWith("*")) {
      Path globPath=new Path(classPathEntry).suffix("{.jar,.JAR}");
      FileStatus[] wildcardJars=FileContext.getLocalFSFileContext().util().globStatus(globPath);
      if (wildcardJars != null) {
        for (        FileStatus wildcardJar : wildcardJars) {
          classPathEntryList.add(wildcardJar.getPath().toUri().toURL().toExternalForm());
        }
      }
    }
 else {
      classPathEntryList.add(new File(classPathEntry).toURI().toURL().toExternalForm());
    }
  }
  String jarClassPath=StringUtils.join(" ",classPathEntryList);
  Manifest jarManifest=new Manifest();
  jarManifest.getMainAttributes().putValue(Attributes.Name.MANIFEST_VERSION.toString(),"1.0");
  jarManifest.getMainAttributes().putValue(Attributes.Name.CLASS_PATH.toString(),jarClassPath);
  File classPathJar=File.createTempFile("classpath-",".jar",workingDir);
  FileOutputStream fos=null;
  BufferedOutputStream bos=null;
  JarOutputStream jos=null;
  try {
    fos=new FileOutputStream(classPathJar);
    bos=new BufferedOutputStream(fos);
    jos=new JarOutputStream(bos,jarManifest);
  }
  finally {
    IOUtils.cleanup(LOG,jos,bos,fos);
  }
  return classPathJar.getCanonicalPath();
}
