{
  this.dataIn=dataIn;
  this.checksumIn=checksumIn;
  this.startOffset=Math.max(startOffset,0);
  this.filename=filename;
  this.datanodeID=datanodeID;
  this.block=block;
  this.fisCache=fisCache;
  this.clientMmap=null;
  this.mmapDisabled=false;
  checksumIn.getChannel().position(0);
  BlockMetadataHeader header=BlockMetadataHeader.readHeader(new DataInputStream(new BufferedInputStream(checksumIn,BlockMetadataHeader.getHeaderSize())));
  short version=header.getVersion();
  if (version != BlockMetadataHeader.VERSION) {
    throw new IOException("Wrong version (" + version + ") of the "+ "metadata file for "+ filename+ ".");
  }
  this.verifyChecksum=verifyChecksum && !conf.skipShortCircuitChecksums;
  long firstChunkOffset;
  if (this.verifyChecksum) {
    this.checksum=header.getChecksum();
    this.bytesPerChecksum=this.checksum.getBytesPerChecksum();
    this.checksumSize=this.checksum.getChecksumSize();
    firstChunkOffset=startOffset - (startOffset % checksum.getBytesPerChecksum());
    this.offsetFromChunkBoundary=(int)(startOffset - firstChunkOffset);
    int chunksPerChecksumRead=getSlowReadBufferNumChunks(conf.shortCircuitBufferSize,bytesPerChecksum);
    slowReadBuff=bufferPool.getBuffer(bytesPerChecksum * chunksPerChecksumRead);
    checksumBuff=bufferPool.getBuffer(checksumSize * chunksPerChecksumRead);
    slowReadBuff.flip();
    checksumBuff.flip();
    long checkSumOffset=(firstChunkOffset / bytesPerChecksum) * checksumSize;
    IOUtils.skipFully(checksumIn,checkSumOffset);
  }
 else {
    firstChunkOffset=startOffset;
    this.checksum=null;
    this.bytesPerChecksum=0;
    this.checksumSize=0;
    this.offsetFromChunkBoundary=0;
  }
  boolean success=false;
  try {
    this.dataIn.getChannel().position(firstChunkOffset);
    success=true;
  }
  finally {
    if (success) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Created BlockReaderLocal for file " + filename + " block "+ block+ " in datanode "+ datanodeID);
      }
    }
 else {
      if (slowReadBuff != null)       bufferPool.returnBuffer(slowReadBuff);
      if (checksumBuff != null)       bufferPool.returnBuffer(checksumBuff);
    }
  }
}
