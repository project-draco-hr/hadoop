{
  LocalDatanodeInfo localDatanodeInfo=getLocalDatanodeInfo(node.getIpcPort());
  BlockLocalPathInfo pathinfo=localDatanodeInfo.getBlockLocalPathInfo(blk);
  if (pathinfo == null) {
    pathinfo=getBlockPathInfo(blk,node,conf,socketTimeout,token);
  }
  FileInputStream dataIn=null;
  FileInputStream checksumIn=null;
  BlockReaderLocal localBlockReader=null;
  boolean skipChecksumCheck=skipChecksumCheck(conf);
  try {
    File blkfile=new File(pathinfo.getBlockPath());
    dataIn=new FileInputStream(blkfile);
    if (LOG.isDebugEnabled()) {
      LOG.debug("New BlockReaderLocal for file " + blkfile + " of size "+ blkfile.length()+ " startOffset "+ startOffset+ " length "+ length+ " short circuit checksum "+ skipChecksumCheck);
    }
    if (!skipChecksumCheck) {
      File metafile=new File(pathinfo.getMetaPath());
      checksumIn=new FileInputStream(metafile);
      BlockMetadataHeader header=BlockMetadataHeader.readHeader(new DataInputStream(checksumIn));
      short version=header.getVersion();
      if (version != BlockMetadataHeader.VERSION) {
        LOG.warn("Wrong version (" + version + ") for metadata file for "+ blk+ " ignoring ...");
      }
      DataChecksum checksum=header.getChecksum();
      long firstChunkOffset=startOffset - (startOffset % checksum.getBytesPerChecksum());
      localBlockReader=new BlockReaderLocal(conf,file,blk,token,startOffset,length,pathinfo,checksum,true,dataIn,firstChunkOffset,checksumIn);
    }
 else {
      localBlockReader=new BlockReaderLocal(conf,file,blk,token,startOffset,length,pathinfo,dataIn);
    }
  }
 catch (  IOException e) {
    localDatanodeInfo.removeBlockLocalPathInfo(blk);
    DFSClient.LOG.warn("BlockReaderLocal: Removing " + blk + " from cache because local file "+ pathinfo.getBlockPath()+ " could not be opened.");
    throw e;
  }
 finally {
    if (localBlockReader == null) {
      if (dataIn != null) {
        dataIn.close();
      }
      if (checksumIn != null) {
        checksumIn.close();
      }
    }
  }
  return localBlockReader;
}
