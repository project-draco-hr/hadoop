{
  int bytesRead=stream.getChannel().read(buf);
  if (bytesRead < 0) {
    return bytesRead;
  }
  while (buf.remaining() > 0) {
    int n=stream.getChannel().read(buf);
    if (n < 0) {
      return bytesRead;
    }
    bytesRead+=n;
  }
  return bytesRead;
}
