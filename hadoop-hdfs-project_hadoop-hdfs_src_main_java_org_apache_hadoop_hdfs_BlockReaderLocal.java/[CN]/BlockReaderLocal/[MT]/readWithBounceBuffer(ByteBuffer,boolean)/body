{
  int total=0;
  boolean eof=false;
  while (true) {
    int bb=drainDataBuf(buf);
    total+=bb;
    int needed=buf.remaining();
    if (eof || (needed == 0)) {
      break;
    }
 else     if (buf.isDirect() && (needed >= maxReadaheadLength) && ((dataPos % bytesPerChecksum) == 0)) {
      int oldLimit=buf.limit();
      int nRead;
      try {
        buf.limit(buf.position() + maxReadaheadLength);
        nRead=fillBuffer(buf,canSkipChecksum);
      }
  finally {
        buf.limit(oldLimit);
      }
      if (nRead < maxReadaheadLength) {
        eof=true;
      }
      total+=nRead;
    }
 else {
      if (fillDataBuf(canSkipChecksum)) {
        eof=true;
      }
    }
  }
  return total == 0 ? -1 : total;
}
