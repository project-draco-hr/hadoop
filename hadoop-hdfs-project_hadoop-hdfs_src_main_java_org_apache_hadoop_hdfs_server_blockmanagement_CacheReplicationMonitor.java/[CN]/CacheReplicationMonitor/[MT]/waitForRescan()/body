{
  boolean retakeWriteLock=false;
  if (namesystem.hasWriteLock()) {
    namesystem.writeUnlock();
    retakeWriteLock=true;
  }
 else   if (namesystem.hasReadLock()) {
    namesystem.readUnlock();
  }
 else {
    Preconditions.checkState(false,"Need to be holding either the read or write lock");
  }
  try {
    lock.lock();
    try {
      if (!isScanning) {
        needsRescan=true;
        doRescan.signal();
      }
      final long startCount=scanCount;
      while (startCount >= scanCount) {
        try {
          scanFinished.await();
        }
 catch (        InterruptedException e) {
          LOG.warn("Interrupted while waiting for CacheReplicationMonitor" + " rescan",e);
          break;
        }
      }
    }
  finally {
      lock.unlock();
    }
  }
  finally {
    if (retakeWriteLock) {
      namesystem.writeLock();
    }
 else {
      namesystem.readLock();
    }
  }
}
