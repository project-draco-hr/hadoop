{
  BlockInfo[] blockInfos=file.getBlocks();
  directive.addFilesNeeded(1);
  long neededTotal=file.computeFileSizeNotIncludingLastUcBlock() * directive.getReplication();
  directive.addBytesNeeded(neededTotal);
  CachePool pool=directive.getPool();
  if (pool.getBytesNeeded() > pool.getLimit()) {
    if (LOG.isDebugEnabled()) {
      LOG.debug(String.format("Directive %d: not scanning file %s because " + "bytesNeeded for pool %s is %d, but the pool's limit is %d",directive.getId(),file.getFullPathName(),pool.getPoolName(),pool.getBytesNeeded(),pool.getLimit()));
    }
    return;
  }
  long cachedTotal=0;
  for (  BlockInfo blockInfo : blockInfos) {
    if (!blockInfo.getBlockUCState().equals(BlockUCState.COMPLETE)) {
      if (LOG.isTraceEnabled()) {
        LOG.trace("Directive " + directive.getId() + ": can't cache "+ "block "+ blockInfo+ " because it is in state "+ blockInfo.getBlockUCState()+ ", not COMPLETE.");
      }
      continue;
    }
    Block block=new Block(blockInfo.getBlockId());
    CachedBlock ncblock=new CachedBlock(block.getBlockId(),directive.getReplication(),mark);
    CachedBlock ocblock=cachedBlocks.get(ncblock);
    if (ocblock == null) {
      cachedBlocks.put(ncblock);
      ocblock=ncblock;
    }
 else {
      List<DatanodeDescriptor> cachedOn=ocblock.getDatanodes(Type.CACHED);
      long cachedByBlock=Math.min(cachedOn.size(),directive.getReplication()) * blockInfo.getNumBytes();
      cachedTotal+=cachedByBlock;
      if ((mark != ocblock.getMark()) || (ocblock.getReplication() < directive.getReplication())) {
        ocblock.setReplicationAndMark(directive.getReplication(),mark);
      }
    }
    if (LOG.isTraceEnabled()) {
      LOG.trace("Directive " + directive.getId() + ": setting replication "+ "for block "+ blockInfo+ " to "+ ocblock.getReplication());
    }
  }
  directive.addBytesCached(cachedTotal);
  if (cachedTotal == neededTotal) {
    directive.addFilesCached(1);
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Directive " + directive.getId() + ": caching "+ file.getFullPathName()+ ": "+ cachedTotal+ "/"+ neededTotal+ " bytes");
  }
}
