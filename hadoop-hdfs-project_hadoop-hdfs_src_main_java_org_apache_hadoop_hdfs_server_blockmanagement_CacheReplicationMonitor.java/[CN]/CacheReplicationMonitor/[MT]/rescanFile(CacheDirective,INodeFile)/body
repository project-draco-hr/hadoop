{
  pce.incrementFilesAffected();
  BlockInfo[] blockInfos=file.getBlocks();
  long cachedTotal=0;
  long neededTotal=0;
  for (  BlockInfo blockInfo : blockInfos) {
    if (!blockInfo.getBlockUCState().equals(BlockUCState.COMPLETE)) {
      continue;
    }
    long neededByBlock=pce.getReplication() * blockInfo.getNumBytes();
    neededTotal+=neededByBlock;
    Block block=new Block(blockInfo.getBlockId());
    CachedBlock ncblock=new CachedBlock(block.getBlockId(),pce.getReplication(),mark);
    CachedBlock ocblock=cachedBlocks.get(ncblock);
    if (ocblock == null) {
      cachedBlocks.put(ncblock);
    }
 else {
      List<DatanodeDescriptor> cachedOn=ocblock.getDatanodes(Type.CACHED);
      long cachedByBlock=Math.min(cachedOn.size(),pce.getReplication()) * blockInfo.getNumBytes();
      cachedTotal+=cachedByBlock;
      if (mark != ocblock.getMark()) {
        ocblock.setReplicationAndMark(pce.getReplication(),mark);
      }
 else {
        ocblock.setReplicationAndMark((short)Math.max(pce.getReplication(),ocblock.getReplication()),mark);
      }
    }
  }
  pce.addBytesNeeded(neededTotal);
  pce.addBytesCached(cachedTotal);
  if (LOG.isTraceEnabled()) {
    LOG.debug("Directive " + pce.getId() + " is caching "+ file.getFullPathName()+ ": "+ cachedTotal+ "/"+ neededTotal);
  }
}
