{
  float total=0;
  for (  DatanodeDescriptor d : targets) {
    total+=d.getCacheRemainingPercent();
  }
  TreeMap<Integer,DatanodeDescriptor> lottery=new TreeMap<Integer,DatanodeDescriptor>();
  int offset=0;
  for (  DatanodeDescriptor d : targets) {
    int weight=Math.max(1,(int)((d.getCacheRemainingPercent() / total) * 1000000));
    offset+=weight;
    lottery.put(offset,d);
  }
  DatanodeDescriptor winner=lottery.higherEntry(random.nextInt(offset)).getValue();
  return winner;
}
