{
  for (Iterator<CachedBlock> cbIter=cachedBlocks.iterator(); cbIter.hasNext(); ) {
    scannedBlocks++;
    CachedBlock cblock=cbIter.next();
    List<DatanodeDescriptor> pendingCached=cblock.getDatanodes(Type.PENDING_CACHED);
    List<DatanodeDescriptor> cached=cblock.getDatanodes(Type.CACHED);
    List<DatanodeDescriptor> pendingUncached=cblock.getDatanodes(Type.PENDING_UNCACHED);
    for (Iterator<DatanodeDescriptor> iter=pendingUncached.iterator(); iter.hasNext(); ) {
      DatanodeDescriptor datanode=iter.next();
      if (!cblock.isInList(datanode.getCached())) {
        datanode.getPendingUncached().remove(cblock);
        iter.remove();
      }
    }
    BlockInfo blockInfo=blockManager.getStoredBlock(new Block(cblock.getBlockId()));
    String reason=findReasonForNotCaching(cblock,blockInfo);
    int neededCached=0;
    if (reason != null) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("not caching " + cblock + " because it is "+ reason);
      }
    }
 else {
      neededCached=cblock.getReplication();
    }
    int numCached=cached.size();
    if (numCached >= neededCached) {
      for (Iterator<DatanodeDescriptor> iter=pendingCached.iterator(); iter.hasNext(); ) {
        DatanodeDescriptor datanode=iter.next();
        datanode.getPendingCached().remove(cblock);
        iter.remove();
      }
    }
    if (numCached < neededCached) {
      for (Iterator<DatanodeDescriptor> iter=pendingUncached.iterator(); iter.hasNext(); ) {
        DatanodeDescriptor datanode=iter.next();
        datanode.getPendingUncached().remove(cblock);
        iter.remove();
      }
    }
    int neededUncached=numCached - (pendingUncached.size() + neededCached);
    if (neededUncached > 0) {
      addNewPendingUncached(neededUncached,cblock,cached,pendingUncached);
    }
 else {
      int additionalCachedNeeded=neededCached - (numCached + pendingCached.size());
      if (additionalCachedNeeded > 0) {
        addNewPendingCached(additionalCachedNeeded,cblock,cached,pendingCached);
      }
    }
    if ((neededCached == 0) && pendingUncached.isEmpty() && pendingCached.isEmpty()) {
      cbIter.remove();
    }
  }
}
