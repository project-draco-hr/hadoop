{
  Configuration conf=new Configuration();
  conf.set("fs.trash.interval","10");
  conf.set("fs.default.name",fs.getUri().toString());
  FsShell shell=new FsShell();
  shell.setConf(conf);
  Path trashRoot=null;
  Path myPath=new Path(base,"test/mkdirs");
  mkdir(fs,myPath);
  Path myFile=new Path(base,"test/mkdirs/myFile");
  writeFile(fs,myFile);
{
    String[] args=new String[1];
    args[0]="-expunge";
    int val=-1;
    try {
      val=shell.run(args);
    }
 catch (    Exception e) {
      System.err.println("Exception raised from Trash.run " + e.getLocalizedMessage());
    }
    assertTrue(val == 0);
  }
{
    String[] args=new String[2];
    args[0]="-rm";
    args[1]=myFile.toString();
    int val=-1;
    try {
      val=shell.run(args);
    }
 catch (    Exception e) {
      System.err.println("Exception raised from Trash.run " + e.getLocalizedMessage());
    }
    assertTrue(val == 0);
    trashRoot=shell.getCurrentTrashDir();
    checkTrash(fs,trashRoot,myFile);
  }
  writeFile(fs,myFile);
{
    String[] args=new String[2];
    args[0]="-rm";
    args[1]=new Path(base,"test/mkdirs/myFile").toString();
    int val=-1;
    try {
      val=shell.run(args);
    }
 catch (    Exception e) {
      System.err.println("Exception raised from Trash.run " + e.getLocalizedMessage());
    }
    assertTrue(val == 0);
  }
  writeFile(fs,myFile);
{
    String[] args=new String[2];
    args[0]="-rmr";
    args[1]=new Path(base,"test/mkdirs").toString();
    int val=-1;
    try {
      val=shell.run(args);
    }
 catch (    Exception e) {
      System.err.println("Exception raised from Trash.run " + e.getLocalizedMessage());
    }
    assertTrue(val == 0);
  }
  mkdir(fs,myPath);
{
    String[] args=new String[2];
    args[0]="-rmr";
    args[1]=new Path(base,"test/mkdirs").toString();
    int val=-1;
    try {
      val=shell.run(args);
    }
 catch (    Exception e) {
      System.err.println("Exception raised from Trash.run " + e.getLocalizedMessage());
    }
    assertTrue(val == 0);
  }
{
    Path toErase=new Path(trashRoot,"toErase");
    int retVal=-1;
    writeFile(fs,toErase);
    try {
      retVal=shell.run(new String[]{"-rm",toErase.toString()});
    }
 catch (    Exception e) {
      System.err.println("Exception raised from Trash.run " + e.getLocalizedMessage());
    }
    assertTrue(retVal == 0);
    checkNotInTrash(fs,trashRoot,toErase.toString());
    checkNotInTrash(fs,trashRoot,toErase.toString() + ".1");
  }
{
    String[] args=new String[1];
    args[0]="-expunge";
    int val=-1;
    try {
      val=shell.run(args);
    }
 catch (    Exception e) {
      System.err.println("Exception raised from Trash.run " + e.getLocalizedMessage());
    }
    assertTrue(val == 0);
  }
  checkNotInTrash(fs,trashRoot,new Path(base,"test/mkdirs/myFile").toString());
  mkdir(fs,myPath);
  writeFile(fs,myFile);
{
    String[] args=new String[2];
    args[0]="-rm";
    args[1]=myFile.toString();
    int val=-1;
    try {
      val=shell.run(args);
    }
 catch (    Exception e) {
      System.err.println("Exception raised from Trash.run " + e.getLocalizedMessage());
    }
    assertTrue(val == 0);
    checkTrash(fs,trashRoot,myFile);
    args=new String[2];
    args[0]="-rmr";
    args[1]=myPath.toString();
    val=-1;
    try {
      val=shell.run(args);
    }
 catch (    Exception e) {
      System.err.println("Exception raised from Trash.run " + e.getLocalizedMessage());
    }
    assertTrue(val == 0);
    checkTrash(fs,trashRoot,myPath);
  }
{
    String[] args=new String[2];
    args[0]="-rmr";
    args[1]=trashRoot.getParent().getParent().toString();
    int val=-1;
    try {
      val=shell.run(args);
    }
 catch (    Exception e) {
      System.err.println("Exception raised from Trash.run " + e.getLocalizedMessage());
    }
    assertTrue(val == -1);
    assertTrue(fs.exists(trashRoot));
  }
  mkdir(fs,myPath);
  writeFile(fs,myFile);
{
    String[] args=new String[3];
    args[0]="-rm";
    args[1]="-skipTrash";
    args[2]=myFile.toString();
    int val=-1;
    try {
      assertEquals(0,shell.run(new String[]{"-expunge"}));
      val=shell.run(args);
    }
 catch (    Exception e) {
      System.err.println("Exception raised from Trash.run " + e.getLocalizedMessage());
    }
    assertFalse(fs.exists(trashRoot));
    assertFalse(fs.exists(myFile));
    assertTrue(val == 0);
  }
  mkdir(fs,myPath);
  writeFile(fs,myFile);
{
    String[] args=new String[3];
    args[0]="-rmr";
    args[1]="-skipTrash";
    args[2]=myPath.toString();
    int val=-1;
    try {
      assertEquals(0,shell.run(new String[]{"-expunge"}));
      val=shell.run(args);
    }
 catch (    Exception e) {
      System.err.println("Exception raised from Trash.run " + e.getLocalizedMessage());
    }
    assertFalse(fs.exists(trashRoot));
    assertFalse(fs.exists(myPath));
    assertFalse(fs.exists(myFile));
    assertTrue(val == 0);
  }
{
    int val=-1;
    mkdir(fs,myPath);
    try {
      assertEquals(0,shell.run(new String[]{"-expunge"}));
    }
 catch (    Exception e) {
      System.err.println("Exception raised from fs expunge " + e.getLocalizedMessage());
    }
    myFile=new Path(base,"test/mkdirs/myFile");
    String[] args=new String[]{"-rm",myFile.toString()};
    int num_runs=10;
    for (int i=0; i < num_runs; i++) {
      writeFile(fs,myFile);
      try {
        val=shell.run(args);
      }
 catch (      Exception e) {
        System.err.println("Exception raised from Trash.run " + e.getLocalizedMessage());
      }
      assertTrue(val == 0);
    }
    Path trashDir=new Path(trashRoot.toUri().getPath() + myFile.getParent().toUri().getPath());
    System.out.println("Deleting same myFile: myFile.parent=" + myFile.getParent().toUri().getPath() + "; trashroot="+ trashRoot.toUri().getPath()+ "; trashDir="+ trashDir.toUri().getPath());
    int count=countSameDeletedFiles(fs,trashDir,myFile);
    System.out.println("counted " + count + " files "+ myFile.getName()+ "* in "+ trashDir);
    assertTrue(count == num_runs);
  }
}
