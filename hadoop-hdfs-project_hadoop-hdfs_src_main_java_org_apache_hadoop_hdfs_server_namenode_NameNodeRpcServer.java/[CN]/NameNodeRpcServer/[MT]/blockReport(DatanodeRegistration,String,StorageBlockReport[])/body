{
  verifyRequest(nodeReg);
  if (blockStateChangeLog.isDebugEnabled()) {
    blockStateChangeLog.debug("*BLOCK* NameNode.blockReport: " + "from " + nodeReg + ", reports.length="+ reports.length);
  }
  final BlockManager bm=namesystem.getBlockManager();
  boolean noStaleStorages=false;
  for (  StorageBlockReport r : reports) {
    final BlockListAsLongs blocks=new BlockListAsLongs(r.getBlocks());
    noStaleStorages=bm.processReport(nodeReg,r.getStorage(),blocks);
    metrics.incrStorageBlockReportOps();
  }
  if (nn.getFSImage().isUpgradeFinalized() && !nn.isStandbyState() && noStaleStorages) {
    return new FinalizeCommand(poolId);
  }
  return null;
}
