{
  verifyRequest(nodeReg);
  if (blockStateChangeLog.isDebugEnabled()) {
    blockStateChangeLog.debug("*BLOCK* NameNode.blockReport: " + "from " + nodeReg + ", reports.length="+ reports.length);
  }
  final BlockManager bm=namesystem.getBlockManager();
  boolean hasStaleStorages=true;
  for (  StorageBlockReport r : reports) {
    final BlockListAsLongs blocks=new BlockListAsLongs(r.getBlocks());
    hasStaleStorages=bm.processReport(nodeReg,r.getStorage(),poolId,blocks);
    metrics.incrStorageBlockReportOps();
  }
  if (nn.getFSImage().isUpgradeFinalized() && !nn.isStandbyState() && !hasStaleStorages) {
    return new FinalizeCommand(poolId);
  }
  return null;
}
