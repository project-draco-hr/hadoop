{
  verifyRequest(nodeReg);
  BlockListAsLongs blist=new BlockListAsLongs(blocks);
  if (nn.isStandbyState()) {
    long maxGs=blist.getMaxGsInBlockList();
    if (namesystem.isGenStampInFuture(maxGs)) {
      LOG.info("Required GS=" + maxGs + ", Queuing blockReport message");
      namesystem.getPendingDataNodeMessages().queueMessage(new PendingDataNodeMessages.BlockReportMessage(nodeReg,poolId,blist,maxGs));
      return null;
    }
  }
  if (stateChangeLog.isDebugEnabled()) {
    stateChangeLog.debug("*BLOCK* NameNode.blockReport: " + "from " + nodeReg.getName() + " "+ blist.getNumberOfBlocks()+ " blocks");
  }
  namesystem.getBlockManager().processReport(nodeReg,poolId,blist);
  if (nn.getFSImage().isUpgradeFinalized() && !nn.isStandbyState())   return new FinalizeCommand(poolId);
  return null;
}
