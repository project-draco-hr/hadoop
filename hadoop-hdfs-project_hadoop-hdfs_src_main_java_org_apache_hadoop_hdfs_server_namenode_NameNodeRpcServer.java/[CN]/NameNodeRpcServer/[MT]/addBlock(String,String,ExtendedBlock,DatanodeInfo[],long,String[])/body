{
  checkNNStartup();
  if (stateChangeLog.isDebugEnabled()) {
    stateChangeLog.debug("*BLOCK* NameNode.addBlock: file " + src + " fileId="+ fileId+ " for "+ clientName);
  }
  Set<Node> excludedNodesSet=null;
  if (excludedNodes != null) {
    excludedNodesSet=new HashSet<Node>(excludedNodes.length);
    for (    Node node : excludedNodes) {
      excludedNodesSet.add(node);
    }
  }
  List<String> favoredNodesList=(favoredNodes == null) ? null : Arrays.asList(favoredNodes);
  LocatedBlock locatedBlock=namesystem.getAdditionalBlock(src,fileId,clientName,previous,excludedNodesSet,favoredNodesList);
  if (locatedBlock != null)   metrics.incrAddBlockOps();
  return locatedBlock;
}
