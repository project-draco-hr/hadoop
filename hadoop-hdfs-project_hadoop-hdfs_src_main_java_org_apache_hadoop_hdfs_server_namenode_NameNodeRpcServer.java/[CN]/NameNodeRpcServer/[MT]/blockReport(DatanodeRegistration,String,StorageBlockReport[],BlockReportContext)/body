{
  checkNNStartup();
  verifyRequest(nodeReg);
  if (blockStateChangeLog.isDebugEnabled()) {
    blockStateChangeLog.debug("*BLOCK* NameNode.blockReport: " + "from " + nodeReg + ", reports.length="+ reports.length);
  }
  final BlockManager bm=namesystem.getBlockManager();
  boolean noStaleStorages=false;
  for (int r=0; r < reports.length; r++) {
    final BlockListAsLongs blocks=reports[r].getBlocks();
    noStaleStorages=bm.processReport(nodeReg,reports[r].getStorage(),blocks,context,(r == reports.length - 1));
    metrics.incrStorageBlockReportOps();
  }
  if (nn.getFSImage().isUpgradeFinalized() && !namesystem.isRollingUpgrade() && !nn.isStandbyState()&& noStaleStorages) {
    return new FinalizeCommand(poolId);
  }
  return null;
}
