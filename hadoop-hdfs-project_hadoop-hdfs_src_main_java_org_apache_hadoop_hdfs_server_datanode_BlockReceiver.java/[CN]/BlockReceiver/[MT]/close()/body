{
  IOException ioe=null;
  if (syncOnClose && (out != null || checksumOut != null)) {
    datanode.metrics.incrFsyncCount();
  }
  try {
    if (checksumOut != null) {
      checksumOut.flush();
      if (syncOnClose && (cout instanceof FileOutputStream)) {
        long start=Util.now();
        ((FileOutputStream)cout).getChannel().force(true);
        datanode.metrics.addFsync(Util.now() - start);
      }
      checksumOut.close();
      checksumOut=null;
    }
  }
 catch (  IOException e) {
    ioe=e;
  }
 finally {
    IOUtils.closeStream(checksumOut);
  }
  try {
    if (out != null) {
      out.flush();
      if (syncOnClose && (out instanceof FileOutputStream)) {
        long start=Util.now();
        ((FileOutputStream)out).getChannel().force(true);
        datanode.metrics.addFsync(Util.now() - start);
      }
      out.close();
      out=null;
    }
  }
 catch (  IOException e) {
    ioe=e;
  }
 finally {
    IOUtils.closeStream(out);
  }
  if (ioe != null) {
    datanode.checkDiskError(ioe);
    throw ioe;
  }
}
