{
  readNextPacket();
  buf.mark();
  PacketHeader header=new PacketHeader();
  header.readFields(buf);
  int endOfHeader=buf.position();
  buf.reset();
  if (header.getOffsetInBlock() > replicaInfo.getNumBytes()) {
    throw new IOException("Received an out-of-sequence packet for " + block + "from "+ inAddr+ " at offset "+ header.getOffsetInBlock()+ ". Expecting packet starting at "+ replicaInfo.getNumBytes());
  }
  if (header.getDataLen() < 0) {
    throw new IOException("Got wrong length during writeBlock(" + block + ") from "+ inAddr+ " at offset "+ header.getOffsetInBlock()+ ": "+ header.getDataLen());
  }
  return receivePacket(header.getOffsetInBlock(),header.getSeqno(),header.isLastPacketInBlock(),header.getDataLen(),header.getSyncBlock(),endOfHeader);
}
