{
  DatanodeProtocol nn=datanode.getBPNamenode(block.getBlockPoolId());
  while (len > 0) {
    int chunkLen=Math.min(len,bytesPerChecksum);
    clientChecksum.update(dataBuf,dataOff,chunkLen);
    if (!clientChecksum.compare(checksumBuf,checksumOff)) {
      if (srcDataNode != null) {
        try {
          LOG.info("report corrupt block " + block + " from datanode "+ srcDataNode+ " to namenode");
          LocatedBlock lb=new LocatedBlock(block,new DatanodeInfo[]{srcDataNode});
          nn.reportBadBlocks(new LocatedBlock[]{lb});
        }
 catch (        IOException e) {
          LOG.warn("Failed to report bad block " + block + " from datanode "+ srcDataNode+ " to namenode");
        }
      }
      throw new IOException("Unexpected checksum mismatch " + "while writing " + block + " from "+ inAddr);
    }
    clientChecksum.reset();
    dataOff+=chunkLen;
    checksumOff+=checksumSize;
    len-=chunkLen;
  }
}
