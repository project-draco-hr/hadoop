{
  if (!(req instanceof HttpServletRequest)) {
    throw new ServletException("This filter only works for HTTP/HTTPS");
  }
  HttpServletRequest httpReq=(HttpServletRequest)req;
  HttpServletResponse httpResp=(HttpServletResponse)resp;
  if (LOG.isDebugEnabled()) {
    LOG.debug("Remote address for request is: " + httpReq.getRemoteAddr());
  }
  if (!getProxyAddresses().contains(httpReq.getRemoteAddr())) {
    String redirectUrl=findRedirectUrl();
    redirectUrl=httpResp.encodeRedirectURL(redirectUrl + httpReq.getRequestURI());
    httpResp.sendRedirect(redirectUrl);
    return;
  }
  String user=null;
  if (httpReq.getCookies() != null) {
    for (    Cookie c : httpReq.getCookies()) {
      if (WebAppProxyServlet.PROXY_USER_COOKIE_NAME.equals(c.getName())) {
        user=c.getValue();
        break;
      }
    }
  }
  if (user == null) {
    LOG.warn("Could not find " + WebAppProxyServlet.PROXY_USER_COOKIE_NAME + " cookie, so user will not be set");
    chain.doFilter(req,resp);
  }
 else {
    final AmIpPrincipal principal=new AmIpPrincipal(user);
    ServletRequest requestWrapper=new AmIpServletRequestWrapper(httpReq,principal);
    chain.doFilter(requestWrapper,resp);
  }
}
