{
  conf.setBoolean(YarnConfiguration.RM_PROXY_USER_PRIVILEGES_ENABLED,true);
  Text userText2=new Text("user2");
  DelegationTokenIdentifier dtId2=new DelegationTokenIdentifier(new Text("user2"),new Text("renewer2"),userText2);
  final Token<DelegationTokenIdentifier> token2=new Token<DelegationTokenIdentifier>(dtId2.getBytes(),"password2".getBytes(),dtId2.getKind(),new Text("service2"));
  final MockRM rm=new TestSecurityMockRM(conf,null){
    @Override protected DelegationTokenRenewer createDelegationTokenRenewer(){
      return new DelegationTokenRenewer(){
        @Override protected Token<?>[] obtainSystemTokensForUser(        String user,        final Credentials credentials) throws IOException {
          credentials.addToken(token2.getService(),token2);
          return new Token<?>[]{token2};
        }
      }
;
    }
  }
;
  rm.start();
  RMApp app=rm.submitApp(200);
  GenericTestUtils.waitFor(new Supplier<Boolean>(){
    public Boolean get(){
      return rm.getRMContext().getDelegationTokenRenewer().getDelegationTokens().contains(token2);
    }
  }
,1000,20000);
  final MockNM nm1=new MockNM("127.0.0.1:1234",15120,rm.getResourceTrackerService());
  nm1.registerNode();
  NodeHeartbeatResponse response=nm1.nodeHeartbeat(true);
  ByteBuffer tokenBuffer=response.getSystemCredentialsForApps().get(app.getApplicationId());
  Assert.assertNotNull(tokenBuffer);
  Credentials appCredentials=new Credentials();
  DataInputByteBuffer buf=new DataInputByteBuffer();
  tokenBuffer.rewind();
  buf.reset(tokenBuffer);
  appCredentials.readTokenStorageStream(buf);
  Assert.assertTrue(appCredentials.getAllTokens().contains(token2));
}
