{
  startEmptyStore();
  final String key="key1";
  final String fileName="foo.jar";
  final String user="user";
  final ApplicationId id=createAppId(1,1L);
  ExecutorService exec=Executors.newFixedThreadPool(2);
  final CountDownLatch start=new CountDownLatch(1);
  Callable<String> addKeyTask=new Callable<String>(){
    public String call() throws Exception {
      start.await();
      return store.addResource(key,fileName);
    }
  }
;
  Callable<String> addAppIdTask=new Callable<String>(){
    public String call() throws Exception {
      start.await();
      return store.addResourceReference(key,new SharedCacheResourceReference(id,user));
    }
  }
;
  Future<String> addAppIdFuture=exec.submit(addAppIdTask);
  Future<String> addKeyFuture=exec.submit(addKeyTask);
  start.countDown();
  String addKeyResult=addKeyFuture.get();
  String addAppIdResult=addAppIdFuture.get();
  assertEquals(fileName,addKeyResult);
  System.out.println("addAppId() result: " + addAppIdResult);
  assertTrue(addAppIdResult == null || addAppIdResult.equals(fileName));
  exec.shutdown();
}
