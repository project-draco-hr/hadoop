{
  final ExtendedBlock eb=new ExtendedBlock(BLOCK_POOL_IDS[0],0);
  final CountDownLatch startFinalizeLatch=new CountDownLatch(1);
  final CountDownLatch brReceivedLatch=new CountDownLatch(1);
  final CountDownLatch volRemovedLatch=new CountDownLatch(1);
class BlockReportThread extends Thread {
    public void run(){
      try {
        volRemovedLatch.await();
      }
 catch (      Exception e) {
        LOG.info("Unexpected exception when waiting for vol removal:",e);
      }
      LOG.info("Getting block report");
      dataset.getBlockReports(eb.getBlockPoolId());
      LOG.info("Successfully received block report");
      brReceivedLatch.countDown();
    }
  }
class ResponderThread extends Thread {
    public void run(){
      try (ReplicaHandler replica=dataset.createRbw(StorageType.DEFAULT,eb,false)){
        LOG.info("CreateRbw finished");
        startFinalizeLatch.countDown();
        try {
          Thread.sleep(1000);
        }
 catch (        InterruptedException ie) {
          LOG.info("Ignoring ",ie);
        }
        brReceivedLatch.await();
        dataset.finalizeBlock(eb);
        LOG.info("FinalizeBlock finished");
      }
 catch (      Exception e) {
        LOG.warn("Exception caught. This should not affect the test",e);
      }
    }
  }
  ResponderThread res=new ResponderThread();
  res.start();
  startFinalizeLatch.await();
  final BlockReportThread brt=new BlockReportThread();
  brt.start();
  Set<File> volumesToRemove=new HashSet<>();
  volumesToRemove.add(StorageLocation.parse(dataset.getVolume(eb).getBasePath()).getFile());
  try {
    LOG.info("Removing volume " + volumesToRemove);
    dataset.removeVolumes(volumesToRemove,true);
  }
 catch (  Exception e) {
    LOG.info("Unexpected issue while removing volume: ",e);
  }
 finally {
    volRemovedLatch.countDown();
  }
  LOG.info("Volumes removed");
  brReceivedLatch.await();
}
