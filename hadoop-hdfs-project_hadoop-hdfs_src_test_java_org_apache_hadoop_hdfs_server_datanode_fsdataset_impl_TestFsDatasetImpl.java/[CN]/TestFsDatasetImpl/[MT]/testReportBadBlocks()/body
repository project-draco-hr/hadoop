{
  boolean threwException=false;
  MiniDFSCluster cluster=null;
  try {
    Configuration config=new HdfsConfiguration();
    cluster=new MiniDFSCluster.Builder(config).numDataNodes(1).build();
    cluster.waitActive();
    Assert.assertEquals(0,cluster.getNamesystem().getCorruptReplicaBlocks());
    DataNode dataNode=cluster.getDataNodes().get(0);
    ExtendedBlock block=new ExtendedBlock(cluster.getNamesystem().getBlockPoolId(),0);
    try {
      dataNode.reportBadBlocks(block);
    }
 catch (    NullPointerException npe) {
      threwException=true;
    }
    Thread.sleep(3000);
    Assert.assertFalse(threwException);
    Assert.assertEquals(0,cluster.getNamesystem().getCorruptReplicaBlocks());
    FileSystem fs=cluster.getFileSystem();
    Path filePath=new Path("testData");
    DFSTestUtil.createFile(fs,filePath,1,(short)1,0);
    block=DFSTestUtil.getFirstBlock(fs,filePath);
    dataNode.reportBadBlocks(block,dataNode.getFSDataset().getFsVolumeReferences().get(0));
    Thread.sleep(3000);
    BlockManagerTestUtil.updateState(cluster.getNamesystem().getBlockManager());
    Assert.assertEquals(1,cluster.getNamesystem().getCorruptReplicaBlocks());
  }
  finally {
    cluster.shutdown();
  }
}
