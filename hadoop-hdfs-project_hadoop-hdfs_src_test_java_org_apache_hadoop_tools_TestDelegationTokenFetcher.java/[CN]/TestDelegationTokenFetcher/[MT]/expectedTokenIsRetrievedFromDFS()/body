{
  final byte[] ident=new DelegationTokenIdentifier(new Text("owner"),new Text("renewer"),new Text("realuser")).getBytes();
  final byte[] pw=new byte[]{42};
  final Text service=new Text(uri.toString());
  final Token<DelegationTokenIdentifier> t=new Token<DelegationTokenIdentifier>(ident,pw,FakeRenewer.KIND,service);
  when(dfs.addDelegationTokens(eq((String)null),any(Credentials.class))).thenAnswer(new Answer<Token<?>[]>(){
    @Override public Token<?>[] answer(    InvocationOnMock invocation){
      Credentials creds=(Credentials)invocation.getArguments()[1];
      creds.addToken(service,t);
      return new Token<?>[]{t};
    }
  }
);
  when(dfs.getUri()).thenReturn(uri);
  FakeRenewer.reset();
  FileSystem fileSys=FileSystem.getLocal(conf);
  try {
    DelegationTokenFetcher.main(new String[]{"-fs",uri.toString(),tokenFile});
    Path p=new Path(fileSys.getWorkingDirectory(),tokenFile);
    Credentials creds=Credentials.readTokenStorageFile(p,conf);
    Iterator<Token<?>> itr=creds.getAllTokens().iterator();
    assertTrue(itr.hasNext());
    assertEquals(t,itr.next());
    assertTrue(!itr.hasNext());
    DelegationTokenFetcher.main(new String[]{"--print",tokenFile});
    DelegationTokenFetcher.main(new String[]{"--renew",tokenFile});
    assertEquals(t,FakeRenewer.lastRenewed);
    FakeRenewer.reset();
    DelegationTokenFetcher.main(new String[]{"--cancel",tokenFile});
    assertEquals(t,FakeRenewer.lastCanceled);
  }
  finally {
    fileSys.delete(new Path(tokenFile),true);
  }
}
