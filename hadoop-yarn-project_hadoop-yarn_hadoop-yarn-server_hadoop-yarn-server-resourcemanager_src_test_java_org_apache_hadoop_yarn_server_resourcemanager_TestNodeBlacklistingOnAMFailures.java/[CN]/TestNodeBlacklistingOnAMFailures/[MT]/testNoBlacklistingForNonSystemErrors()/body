{
  YarnConfiguration conf=new YarnConfiguration();
  conf.setBoolean(YarnConfiguration.AM_SCHEDULING_NODE_BLACKLISTING_ENABLED,true);
  conf.setFloat(YarnConfiguration.AM_SCHEDULING_NODE_BLACKLISTING_DISABLE_THRESHOLD,1.5f);
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,100);
  DrainDispatcher dispatcher=new DrainDispatcher();
  MockRM rm=startRM(conf,dispatcher);
  MockNM node=new MockNM("127.0.0.1:1234",8000,rm.getResourceTrackerService());
  node.registerNode();
  RMApp app=rm.submitApp(200);
  ApplicationId appId=app.getApplicationId();
  int numAppAttempts=1;
  RMAppAttempt attempt=MockRM.waitForAttemptScheduled(app,rm);
  node.nodeHeartbeat(true);
  dispatcher.await();
  MockRM.waitForState(attempt,RMAppAttemptState.ALLOCATED,20000);
  rm.sendAMLaunched(attempt.getAppAttemptId());
  rm.waitForState(attempt.getAppAttemptId(),RMAppAttemptState.LAUNCHED);
  ApplicationAttemptId appAttemptId=ApplicationAttemptId.newInstance(appId,numAppAttempts);
  ContainerId amContainerId=ContainerId.newContainerId(appAttemptId,1);
  for (  int containerExitStatus : new int[]{ContainerExitStatus.PREEMPTED,ContainerExitStatus.KILLED_BY_RESOURCEMANAGER,ContainerExitStatus.KILLED_AFTER_APP_COMPLETION,ContainerExitStatus.ABORTED,ContainerExitStatus.DISKS_FAILED,ContainerExitStatus.KILLED_EXCEEDED_VMEM,ContainerExitStatus.KILLED_EXCEEDED_PMEM}) {
    makeAMContainerExit(rm,amContainerId,node,containerExitStatus);
    attempt=MockRM.waitForAttemptScheduled(app,rm);
    System.out.println("New AppAttempt launched " + attempt.getAppAttemptId());
    node.nodeHeartbeat(true);
    dispatcher.await();
    MockRM.waitForState(attempt,RMAppAttemptState.ALLOCATED,20000);
    rm.sendAMLaunched(attempt.getAppAttemptId());
    rm.waitForState(attempt.getAppAttemptId(),RMAppAttemptState.LAUNCHED);
    numAppAttempts++;
    appAttemptId=ApplicationAttemptId.newInstance(appId,numAppAttempts);
    amContainerId=ContainerId.newContainerId(appAttemptId,1);
    rm.waitForState(node,amContainerId,RMContainerState.ACQUIRED);
  }
}
