{
  Configuration conf=new HdfsConfiguration();
  conf.setLong(DFSConfigKeys.DFS_BLOCK_SIZE_KEY,BLOCK_SIZE);
  conf.setInt(DFSConfigKeys.DFS_BYTES_PER_CHECKSUM_KEY,BYTES_PER_SUM);
  rand.nextBytes(expected);
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).build();
  FileSystem fileSys=cluster.getFileSystem();
  try {
    testChecker(fileSys,true);
    testChecker(fileSys,false);
    testSeekAndRead(fileSys);
  }
  finally {
    fileSys.close();
    cluster.shutdown();
  }
  fileSys=FileSystem.getLocal(conf);
  try {
    testChecker(fileSys,true);
    testChecker(fileSys,false);
    testFileCorruption((LocalFileSystem)fileSys);
    testSeekAndRead(fileSys);
  }
  finally {
    fileSys.close();
  }
}
