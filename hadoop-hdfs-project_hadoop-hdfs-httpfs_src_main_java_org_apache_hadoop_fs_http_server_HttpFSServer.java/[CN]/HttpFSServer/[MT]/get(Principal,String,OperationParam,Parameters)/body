{
  Response response;
  path=makeAbsolute(path);
  MDC.put(HttpFSFileSystem.OP_PARAM,op.value().name());
  String doAs=params.get(DoAsParam.NAME,DoAsParam.class);
switch (op.value()) {
case OPEN:
{
      FSOperations.FSOpen command=new FSOperations.FSOpen(path);
      FileSystem fs=createFileSystem(user,doAs);
      InputStream is=command.execute(fs);
      Long offset=params.get(OffsetParam.NAME,OffsetParam.class);
      Long len=params.get(LenParam.NAME,LenParam.class);
      AUDIT_LOG.info("[{}] offset [{}] len [{}]",new Object[]{path,offset,len});
      InputStreamEntity entity=new InputStreamEntity(is,offset,len);
      response=Response.ok(entity).type(MediaType.APPLICATION_OCTET_STREAM).build();
      break;
    }
case GETFILESTATUS:
{
    FSOperations.FSFileStatus command=new FSOperations.FSFileStatus(path);
    Map json=fsExecute(user,doAs,command);
    AUDIT_LOG.info("[{}]",path);
    response=Response.ok(json).type(MediaType.APPLICATION_JSON).build();
    break;
  }
case LISTSTATUS:
{
  String filter=params.get(FilterParam.NAME,FilterParam.class);
  FSOperations.FSListStatus command=new FSOperations.FSListStatus(path,filter);
  Map json=fsExecute(user,doAs,command);
  AUDIT_LOG.info("[{}] filter [{}]",path,(filter != null) ? filter : "-");
  response=Response.ok(json).type(MediaType.APPLICATION_JSON).build();
  break;
}
case GETHOMEDIRECTORY:
{
enforceRootPath(op.value(),path);
FSOperations.FSHomeDir command=new FSOperations.FSHomeDir();
JSONObject json=fsExecute(user,doAs,command);
AUDIT_LOG.info("");
response=Response.ok(json).type(MediaType.APPLICATION_JSON).build();
break;
}
case INSTRUMENTATION:
{
enforceRootPath(op.value(),path);
Groups groups=HttpFSServerWebApp.get().get(Groups.class);
List<String> userGroups=groups.getGroups(user.getName());
if (!userGroups.contains(HttpFSServerWebApp.get().getAdminGroup())) {
throw new AccessControlException("User not in HttpFSServer admin group");
}
Instrumentation instrumentation=HttpFSServerWebApp.get().get(Instrumentation.class);
Map snapshot=instrumentation.getSnapshot();
response=Response.ok(snapshot).build();
break;
}
case GETCONTENTSUMMARY:
{
FSOperations.FSContentSummary command=new FSOperations.FSContentSummary(path);
Map json=fsExecute(user,doAs,command);
AUDIT_LOG.info("[{}]",path);
response=Response.ok(json).type(MediaType.APPLICATION_JSON).build();
break;
}
case GETFILECHECKSUM:
{
FSOperations.FSFileChecksum command=new FSOperations.FSFileChecksum(path);
Map json=fsExecute(user,doAs,command);
AUDIT_LOG.info("[{}]",path);
response=Response.ok(json).type(MediaType.APPLICATION_JSON).build();
break;
}
case GETFILEBLOCKLOCATIONS:
{
response=Response.status(Response.Status.BAD_REQUEST).build();
break;
}
case GETACLSTATUS:
{
FSOperations.FSAclStatus command=new FSOperations.FSAclStatus(path);
Map json=fsExecute(user,doAs,command);
AUDIT_LOG.info("ACL status for [{}]",path);
response=Response.ok(json).type(MediaType.APPLICATION_JSON).build();
break;
}
default :
{
throw new IOException(MessageFormat.format("Invalid HTTP GET operation [{0}]",op.value()));
}
}
return response;
}
