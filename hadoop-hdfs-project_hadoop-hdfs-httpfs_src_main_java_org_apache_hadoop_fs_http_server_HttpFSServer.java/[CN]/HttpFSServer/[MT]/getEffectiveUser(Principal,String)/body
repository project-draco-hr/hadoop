{
  String effectiveUser=user.getName();
  if (doAs != null && !doAs.equals(user.getName())) {
    ProxyUser proxyUser=HttpFSServerWebApp.get().get(ProxyUser.class);
    String proxyUserName;
    if (user instanceof AuthenticationToken) {
      proxyUserName=((AuthenticationToken)user).getUserName();
    }
 else {
      proxyUserName=user.getName();
    }
    proxyUser.validate(proxyUserName,HostnameFilter.get(),doAs);
    effectiveUser=doAs;
    AUDIT_LOG.info("Proxy user [{}] DoAs user [{}]",proxyUserName,doAs);
  }
  return effectiveUser;
}
