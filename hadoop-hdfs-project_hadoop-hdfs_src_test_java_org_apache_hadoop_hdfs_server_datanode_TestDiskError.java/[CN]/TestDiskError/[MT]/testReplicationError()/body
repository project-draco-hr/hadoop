{
  final Path fileName=new Path("/test.txt");
  final int fileLen=1;
  DFSTestUtil.createFile(fs,fileName,1,(short)1,1L);
  DFSTestUtil.waitReplication(fs,fileName,(short)1);
  LocatedBlocks blocks=NameNodeAdapter.getBlockLocations(cluster.getNameNode(),fileName.toString(),0,(long)fileLen);
  assertEquals("Should only find 1 block",blocks.locatedBlockCount(),1);
  LocatedBlock block=blocks.get(0);
  cluster.startDataNodes(conf,1,true,null,null);
  cluster.waitActive();
  final int sndNode=1;
  DataNode datanode=cluster.getDataNodes().get(sndNode);
  InetSocketAddress target=datanode.getSelfAddr();
  Socket s=new Socket(target.getAddress(),target.getPort());
  DataOutputStream out=new DataOutputStream(s.getOutputStream());
  DataChecksum checksum=DataChecksum.newDataChecksum(DataChecksum.CHECKSUM_CRC32,512);
  new Sender(out).writeBlock(block.getBlock(),BlockTokenSecretManager.DUMMY_TOKEN,"",new DatanodeInfo[0],null,BlockConstructionStage.PIPELINE_SETUP_CREATE,1,0L,0L,0L,checksum);
  out.flush();
  out.close();
  String bpid=cluster.getNamesystem().getBlockPoolId();
  File storageDir=cluster.getInstanceStorageDir(sndNode,0);
  File dir1=MiniDFSCluster.getRbwDir(storageDir,bpid);
  storageDir=cluster.getInstanceStorageDir(sndNode,1);
  File dir2=MiniDFSCluster.getRbwDir(storageDir,bpid);
  while (dir1.listFiles().length != 0 || dir2.listFiles().length != 0) {
    Thread.sleep(100);
  }
  fs.setReplication(fileName,(short)2);
  DFSTestUtil.waitReplication(fs,fileName,(short)1);
  fs.delete(fileName,false);
}
