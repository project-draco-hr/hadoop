{
  verifyEncryption();
  cluster.restartNameNodes();
  cluster.waitActive();
  verifyEncryption();
  fs.setSafeMode(HdfsConstants.SafeModeAction.SAFEMODE_ENTER);
  fs.saveNamespace();
  fs.setSafeMode(HdfsConstants.SafeModeAction.SAFEMODE_LEAVE);
  cluster.restartNameNodes();
  cluster.waitActive();
  verifyEncryption();
  Path renamedTopEZFile=new Path(topEZDir,"renamedFile");
  Path renamedNestedEZFile=new Path(nestedEZDir,"renamedFile");
  try {
    fs.rename(topEZFile,renamedTopEZFile);
    fs.rename(nestedEZFile,renamedNestedEZFile);
  }
 catch (  Exception e) {
    fail("Should be able to rename files within the same EZ.");
  }
  topEZFile=renamedTopEZFile;
  nestedEZFile=renamedNestedEZFile;
  topEZRawFile=new Path(rawDir,"topEZ/renamedFile");
  nestedEZRawFile=new Path(rawDir,"topEZ/nestedEZ/renamedFile");
  verifyEncryption();
  try {
    fs.rename(topEZFile,new Path(nestedEZDir,"movedTopEZFile"));
    fail("Shouldn't be able to rename between top EZ and nested EZ.");
  }
 catch (  Exception e) {
    assertTrue(e.getMessage().contains("can't be moved from encryption zone " + topEZDir.toString() + " to encryption zone "+ nestedEZDir.toString()));
  }
  try {
    fs.rename(nestedEZFile,new Path(topEZDir,"movedNestedEZFile"));
    fail("Shouldn't be able to rename between top EZ and nested EZ.");
  }
 catch (  Exception e) {
    assertTrue(e.getMessage().contains("can't be moved from encryption zone " + nestedEZDir.toString() + " to encryption zone "+ topEZDir.toString()));
  }
  try {
    fs.rename(nestedEZFile,new Path(rootDir,"movedNestedEZFile"));
    fail("Shouldn't be able to move the nested EZ out of the top EZ.");
  }
 catch (  Exception e) {
    assertTrue(e.getMessage().contains("can't be moved from an encryption zone"));
  }
  Path topEZ2Dir=new Path(rootDir,"topEZ2");
  fs.mkdir(topEZ2Dir,FsPermission.getDirDefault());
  fs.createEncryptionZone(topEZ2Dir,TOP_EZ_KEY);
  try {
    fs.rename(topEZ2Dir,new Path(topEZDir,"topEZ2"));
    fail("Shouldn't be able to move a non-nested EZ into another " + "existing EZ.");
  }
 catch (  Exception e) {
    assertTrue(e.getMessage().contains("can't be moved into an encryption zone"));
  }
  try {
    fs.rename(topEZDir,new Path(rootDir,"newTopEZDir"));
  }
 catch (  Exception e) {
    fail("Should be able to rename the root dir of an EZ.");
  }
  try {
    fs.rename(new Path(rootDir,"newTopEZDir/nestedEZDir"),new Path(rootDir,"newTopEZDir/newNestedEZDir"));
  }
 catch (  Exception e) {
    fail("Should be able to rename the nested EZ dir within " + "the same top EZ.");
  }
}
