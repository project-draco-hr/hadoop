{
  LogAggregationService logAggregationService=new LogAggregationService(dispatcher,this.context,this.delSrvc,super.dirsHandler);
  logAggregationService.init(this.conf);
  logAggregationService.start();
  ApplicationId appId=createApplication();
  logAggregationService.handle(new LogHandlerAppStartedEvent(appId,this.user,null,this.acls,logAggregationContext));
  String[] logFiles=new String[]{"stdout"};
  finishContainer(appId,logAggregationService,ContainerType.APPLICATION_MASTER,1,0,logFiles);
  AppLogAggregatorImpl aggregator=(AppLogAggregatorImpl)logAggregationService.getAppLogAggregators().get(appId);
  aggregator.doLogAggregationOutOfBand();
  Thread.sleep(2000);
  aggregator.doLogAggregationOutOfBand();
  Thread.sleep(2000);
  logAggregationService.handle(new LogHandlerAppFinishedEvent(appId));
  logAggregationService.stop();
  assertEquals(expectedLogAggregationTimes,aggregator.getLogAggregationTimes());
  assertEquals(expectedAggregationReportNum,this.context.getLogAggregationStatusForApps().size());
}
