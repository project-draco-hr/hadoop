{
  DeletionService mockDelService=mock(DeletionService.class);
  File[] localLogDirs=TestNonAggregatingLogHandler.getLocalLogDirFiles(this.getClass().getName(),7);
  final List<String> localLogDirPaths=new ArrayList<String>(localLogDirs.length);
  for (int i=0; i < localLogDirs.length; i++) {
    localLogDirPaths.add(localLogDirs[i].getAbsolutePath());
  }
  String localLogDirsString=StringUtils.join(localLogDirPaths,",");
  this.conf.set(YarnConfiguration.NM_LOG_DIRS,localLogDirsString);
  this.conf.set(YarnConfiguration.NM_REMOTE_APP_LOG_DIR,this.remoteRootLogDir.getAbsolutePath());
  this.conf.setLong(YarnConfiguration.NM_DISK_HEALTH_CHECK_INTERVAL_MS,500);
  ApplicationId application1=BuilderUtils.newApplicationId(1234,1);
  ApplicationAttemptId appAttemptId=BuilderUtils.newApplicationAttemptId(application1,1);
  this.dirsHandler=new LocalDirsHandlerService();
  LocalDirsHandlerService mockDirsHandler=mock(LocalDirsHandlerService.class);
  LogAggregationService logAggregationService=spy(new LogAggregationService(dispatcher,this.context,mockDelService,mockDirsHandler));
  AbstractFileSystem spylfs=spy(FileContext.getLocalFSFileContext().getDefaultFileSystem());
  FileContext lfs=FileContext.getFileContext(spylfs,conf);
  doReturn(lfs).when(logAggregationService).getLocalFileContext(isA(Configuration.class));
  logAggregationService.init(this.conf);
  logAggregationService.start();
  TestNonAggregatingLogHandler.runMockedFailedDirs(logAggregationService,application1,user,mockDelService,mockDirsHandler,conf,spylfs,lfs,localLogDirs);
  logAggregationService.stop();
  assertEquals(0,logAggregationService.getNumAggregators());
  verify(logAggregationService).closeFileSystems(any(UserGroupInformation.class));
  ApplicationEvent expectedEvents[]=new ApplicationEvent[]{new ApplicationEvent(appAttemptId.getApplicationId(),ApplicationEventType.APPLICATION_LOG_HANDLING_INITED),new ApplicationEvent(appAttemptId.getApplicationId(),ApplicationEventType.APPLICATION_LOG_HANDLING_FINISHED)};
  checkEvents(appEventHandler,expectedEvents,true,"getType","getApplicationID");
}
