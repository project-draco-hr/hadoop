{
  LOG.info("doTestPathFilter started---------------------------:" + " iter " + iter + " blockSize="+ blockSize+ " stripeLength="+ stripeLength);
  ConfigBuilder cb=new ConfigBuilder();
  cb.addPolicy("policy1","/user/dhruba/raidtest",(short)1,targetReplication,metaReplication,stripeLength);
  cb.persist();
  RaidShell shell=null;
  Path dir=new Path("/user/dhruba/raidtest/");
  Path file1=new Path(dir + "/file" + iter);
  RaidNode cnode=null;
  try {
    Path destPath=new Path("/destraid/user/dhruba/raidtest");
    fileSys.delete(dir,true);
    fileSys.delete(destPath,true);
    long crc1=createOldFile(fileSys,file1,1,numBlock,blockSize);
    LOG.info("doTestPathFilter created test files for iteration " + iter);
    cnode=RaidNode.createRaidNode(null,conf);
    FileStatus[] listPaths=null;
    while (true) {
      try {
        listPaths=fileSys.listStatus(destPath);
        int count=0;
        if (listPaths != null && listPaths.length == 1) {
          for (          FileStatus s : listPaths) {
            LOG.info("doTestPathFilter found path " + s.getPath());
            if (!s.getPath().toString().endsWith(".tmp") && fileSys.getFileStatus(file1).getReplication() == targetReplication) {
              count++;
            }
          }
        }
        if (count > 0) {
          break;
        }
      }
 catch (      FileNotFoundException e) {
      }
      LOG.info("doTestPathFilter waiting for files to be raided. Found " + (listPaths == null ? "none" : listPaths.length));
      Thread.sleep(1000);
    }
    LOG.info("doTestPathFilter all files found in Raid.");
    Thread.sleep(20000);
    shell=new RaidShell(conf);
    shell.initializeRpc(conf,cnode.getListenerAddress());
    if (numBlock >= 1) {
      LOG.info("doTestPathFilter Check error at beginning of file.");
      simulateError(shell,fileSys,file1,crc1,0);
    }
    if (numBlock >= 2) {
      LOG.info("doTestPathFilter Check error at beginning of second block.");
      simulateError(shell,fileSys,file1,crc1,blockSize + 1);
    }
    if (numBlock >= 3) {
      LOG.info("doTestPathFilter Check error at middle of third block.");
      simulateError(shell,fileSys,file1,crc1,2 * blockSize + 10);
    }
    if (numBlock >= stripeLength + 1) {
      LOG.info("doTestPathFilter Check error at middle of second stripe.");
      simulateError(shell,fileSys,file1,crc1,stripeLength * blockSize + 100);
    }
  }
 catch (  Exception e) {
    LOG.info("doTestPathFilter Exception " + e + StringUtils.stringifyException(e));
    throw e;
  }
 finally {
    if (shell != null)     shell.close();
    if (cnode != null) {
      cnode.stop();
      cnode.join();
    }
    LOG.info("doTestPathFilter delete file " + file1);
    fileSys.delete(file1,true);
  }
  LOG.info("doTestPathFilter completed:" + " blockSize=" + blockSize + " stripeLength="+ stripeLength);
}
