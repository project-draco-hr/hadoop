{
  if (commitOffset == 0) {
    commitOffset=nextOffset.get();
  }
  long flushed=getFlushedOffset();
  if (LOG.isDebugEnabled()) {
    LOG.debug("getFlushedOffset=" + flushed + " commitOffset="+ commitOffset);
  }
  if (flushed < commitOffset) {
    updateLastAccessTime();
    return COMMIT_WAIT;
  }
  int ret=COMMIT_WAIT;
  try {
    fos.hsync(EnumSet.of(SyncFlag.UPDATE_LENGTH));
    ret=COMMIT_FINISHED;
  }
 catch (  ClosedChannelException cce) {
    ret=COMMIT_INACTIVE_CTX;
    if (pendingWrites.isEmpty()) {
      ret=COMMIT_INACTIVE_CTX;
    }
 else {
      ret=COMMIT_INACTIVE_WITH_PENDING_WRITE;
    }
  }
catch (  IOException e) {
    LOG.error("Got stream error during data sync:" + e);
    ret=COMMIT_ERROR;
  }
  updateLastAccessTime();
  return ret;
}
