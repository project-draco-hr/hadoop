{
  if (commitOffset == 0) {
    commitOffset=getNextOffsetUnprotected();
  }
  long flushed=getFlushedOffset();
  LOG.info("getFlushedOffset=" + flushed + " commitOffset="+ commitOffset);
  if (flushed < commitOffset) {
    updateLastAccessTime();
    return COMMIT_WAIT;
  }
  int ret=COMMIT_WAIT;
  try {
    ((HdfsDataOutputStream)fos).hsync(EnumSet.of(SyncFlag.UPDATE_LENGTH));
    ret=COMMIT_FINISHED;
  }
 catch (  IOException e) {
    LOG.error("Got stream error during data sync:" + e);
    ret=COMMIT_ERROR;
  }
  updateLastAccessTime();
  return ret;
}
