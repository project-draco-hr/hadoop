{
  conf=new HdfsConfiguration();
  conf.setBoolean(DFS_NAMENODE_ENABLE_RETRY_CACHE_KEY,true);
  conf.setInt(DFSConfigKeys.DFS_CLIENT_TEST_DROP_NAMENODE_RESPONSE_NUM_KEY,2);
  cluster=new MiniDFSCluster.Builder(conf).nnTopology(MiniDFSNNTopology.simpleHATopology()).numDataNodes(3).build();
  cluster.waitActive();
  cluster.transitionToActive(namenodeId);
  HATestUtil.setFailoverConfigurations(cluster,conf);
  filesystem=(DistributedFileSystem)HATestUtil.configureFailoverFs(cluster,conf);
  namesystem=cluster.getNamesystem(namenodeId);
  metrics=namesystem.getRetryCache().getMetricsForTests();
}
