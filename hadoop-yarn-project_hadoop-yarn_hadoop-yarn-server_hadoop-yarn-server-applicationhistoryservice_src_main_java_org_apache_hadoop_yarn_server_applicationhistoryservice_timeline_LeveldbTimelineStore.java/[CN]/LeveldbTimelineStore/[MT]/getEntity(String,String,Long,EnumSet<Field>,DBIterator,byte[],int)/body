{
  if (fields == null)   fields=EnumSet.allOf(Field.class);
  TimelineEntity entity=new TimelineEntity();
  boolean events=false;
  boolean lastEvent=false;
  if (fields.contains(Field.EVENTS)) {
    events=true;
    entity.setEvents(new ArrayList<TimelineEvent>());
  }
 else   if (fields.contains(Field.LAST_EVENT_ONLY)) {
    lastEvent=true;
    entity.setEvents(new ArrayList<TimelineEvent>());
  }
 else {
    entity.setEvents(null);
  }
  boolean relatedEntities=false;
  if (fields.contains(Field.RELATED_ENTITIES)) {
    relatedEntities=true;
  }
 else {
    entity.setRelatedEntities(null);
  }
  boolean primaryFilters=false;
  if (fields.contains(Field.PRIMARY_FILTERS)) {
    primaryFilters=true;
  }
 else {
    entity.setPrimaryFilters(null);
  }
  boolean otherInfo=false;
  if (fields.contains(Field.OTHER_INFO)) {
    otherInfo=true;
    entity.setOtherInfo(new HashMap<String,Object>());
  }
 else {
    entity.setOtherInfo(null);
  }
  for (; iterator.hasNext(); iterator.next()) {
    byte[] key=iterator.peekNext().getKey();
    if (!prefixMatches(prefix,prefixlen,key))     break;
    if (key[prefixlen] == PRIMARY_FILTER_COLUMN[0]) {
      if (primaryFilters) {
        addPrimaryFilter(entity,key,prefixlen + PRIMARY_FILTER_COLUMN.length);
      }
    }
 else     if (key[prefixlen] == OTHER_INFO_COLUMN[0]) {
      if (otherInfo) {
        entity.addOtherInfo(parseRemainingKey(key,prefixlen + OTHER_INFO_COLUMN.length),GenericObjectMapper.read(iterator.peekNext().getValue()));
      }
    }
 else     if (key[prefixlen] == RELATED_COLUMN[0]) {
      if (relatedEntities) {
        addRelatedEntity(entity,key,prefixlen + RELATED_COLUMN.length);
      }
    }
 else     if (key[prefixlen] == TIME_COLUMN[0]) {
      if (events || (lastEvent && entity.getEvents().size() == 0)) {
        TimelineEvent event=getEntityEvent(null,key,prefixlen + TIME_COLUMN.length,iterator.peekNext().getValue());
        if (event != null) {
          entity.addEvent(event);
        }
      }
    }
 else {
      LOG.warn(String.format("Found unexpected column for entity %s of " + "type %s (0x%02x)",entityId,entityType,key[prefixlen]));
    }
  }
  entity.setEntityId(entityId);
  entity.setEntityType(entityType);
  entity.setStartTime(startTime);
  return entity;
}
