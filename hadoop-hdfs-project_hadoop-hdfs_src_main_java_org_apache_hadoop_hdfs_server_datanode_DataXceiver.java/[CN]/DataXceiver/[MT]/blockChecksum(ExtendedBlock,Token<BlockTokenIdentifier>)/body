{
  final DataOutputStream out=new DataOutputStream(getOutputStream());
  checkAccess(out,true,block,blockToken,Op.BLOCK_CHECKSUM,BlockTokenSecretManager.AccessMode.READ);
  updateCurrentThreadName("Reading metadata for block " + block);
  final LengthInputStream metadataIn=datanode.data.getMetaDataInputStream(block);
  final DataInputStream checksumIn=new DataInputStream(new BufferedInputStream(metadataIn,HdfsConstants.IO_FILE_BUFFER_SIZE));
  updateCurrentThreadName("Getting checksum for block " + block);
  try {
    final BlockMetadataHeader header=BlockMetadataHeader.readHeader(checksumIn);
    final DataChecksum checksum=header.getChecksum();
    final int bytesPerCRC=checksum.getBytesPerChecksum();
    final long crcPerBlock=checksum.getChecksumSize() > 0 ? (metadataIn.getLength() - BlockMetadataHeader.getHeaderSize()) / checksum.getChecksumSize() : 0;
    final MD5Hash md5=MD5Hash.digest(checksumIn);
    if (LOG.isDebugEnabled()) {
      LOG.debug("block=" + block + ", bytesPerCRC="+ bytesPerCRC+ ", crcPerBlock="+ crcPerBlock+ ", md5="+ md5);
    }
    BlockOpResponseProto.newBuilder().setStatus(SUCCESS).setChecksumResponse(OpBlockChecksumResponseProto.newBuilder().setBytesPerCrc(bytesPerCRC).setCrcPerBlock(crcPerBlock).setMd5(ByteString.copyFrom(md5.getDigest())).setCrcType(PBHelper.convert(checksum.getChecksumType()))).build().writeDelimitedTo(out);
    out.flush();
  }
  finally {
    IOUtils.closeStream(out);
    IOUtils.closeStream(checksumIn);
    IOUtils.closeStream(metadataIn);
  }
  datanode.metrics.addBlockChecksumOp(elapsed());
}
