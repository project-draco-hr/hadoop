{
  updateCurrentThreadName("Passing file descriptors for block " + blk);
  BlockOpResponseProto.Builder bld=BlockOpResponseProto.newBuilder();
  FileInputStream fis[]=null;
  try {
    if (peer.getDomainSocket() == null) {
      throw new IOException("You cannot pass file descriptors over " + "anything but a UNIX domain socket.");
    }
    if (slotId != null) {
      boolean isCached=datanode.data.isCached(blk.getBlockPoolId(),blk.getBlockId());
      datanode.shortCircuitRegistry.registerSlot(ExtendedBlockId.fromExtendedBlock(blk),slotId,isCached);
    }
    try {
      fis=datanode.requestShortCircuitFdsForRead(blk,token,maxVersion);
    }
  finally {
      if ((fis == null) && (slotId != null)) {
        datanode.shortCircuitRegistry.unregisterSlot(slotId);
      }
    }
    bld.setStatus(SUCCESS);
    bld.setShortCircuitAccessVersion(DataNode.CURRENT_BLOCK_FORMAT_VERSION);
  }
 catch (  ShortCircuitFdsVersionException e) {
    bld.setStatus(ERROR_UNSUPPORTED);
    bld.setShortCircuitAccessVersion(DataNode.CURRENT_BLOCK_FORMAT_VERSION);
    bld.setMessage(e.getMessage());
  }
catch (  ShortCircuitFdsUnsupportedException e) {
    bld.setStatus(ERROR_UNSUPPORTED);
    bld.setMessage(e.getMessage());
  }
catch (  InvalidToken e) {
    bld.setStatus(ERROR_ACCESS_TOKEN);
    bld.setMessage(e.getMessage());
  }
catch (  IOException e) {
    bld.setStatus(ERROR);
    bld.setMessage(e.getMessage());
  }
  try {
    bld.build().writeDelimitedTo(socketOut);
    if (fis != null) {
      FileDescriptor fds[]=new FileDescriptor[fis.length];
      for (int i=0; i < fds.length; i++) {
        fds[i]=fis[i].getFD();
      }
      byte buf[]=new byte[]{(byte)0};
      peer.getDomainSocket().sendFileDescriptors(fds,buf,0,buf.length);
    }
  }
  finally {
    if (ClientTraceLog.isInfoEnabled()) {
      DatanodeRegistration dnR=datanode.getDNRegistrationForBP(blk.getBlockPoolId());
      BlockSender.ClientTraceLog.info(String.format("src: 127.0.0.1, dest: 127.0.0.1, op: REQUEST_SHORT_CIRCUIT_FDS," + " blockid: %s, srvID: %s, success: %b",blk.getBlockId(),dnR.getDatanodeUuid(),(fis != null)));
    }
    if (fis != null) {
      IOUtils.cleanup(LOG,fis);
    }
  }
}
