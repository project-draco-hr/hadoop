{
  updateCurrentThreadName("Copying block " + block);
  if (datanode.isBlockTokenEnabled) {
    try {
      datanode.blockPoolTokenSecretManager.checkAccess(blockToken,null,block,BlockTokenSecretManager.AccessMode.COPY);
    }
 catch (    InvalidToken e) {
      LOG.warn("Invalid access token in request from " + remoteAddress + " for OP_COPY_BLOCK for block "+ block+ " : "+ e.getLocalizedMessage());
      sendResponse(ERROR_ACCESS_TOKEN,"Invalid access token");
      return;
    }
  }
  if (!dataXceiverServer.balanceThrottler.acquire()) {
    String msg="Not able to copy block " + block.getBlockId() + " "+ "to "+ peer.getRemoteAddressString()+ " because threads "+ "quota is exceeded.";
    LOG.info(msg);
    sendResponse(ERROR,msg);
    return;
  }
  BlockSender blockSender=null;
  DataOutputStream reply=null;
  boolean isOpSuccess=true;
  try {
    blockSender=new BlockSender(block,0,-1,false,false,true,datanode,null,CachingStrategy.newDropBehind());
    OutputStream baseStream=getOutputStream();
    reply=new DataOutputStream(new BufferedOutputStream(baseStream,HdfsConstants.SMALL_BUFFER_SIZE));
    writeSuccessWithChecksumInfo(blockSender,reply);
    long read=blockSender.sendBlock(reply,baseStream,dataXceiverServer.balanceThrottler);
    datanode.metrics.incrBytesRead((int)read);
    datanode.metrics.incrBlocksRead();
    LOG.info("Copied " + block + " to "+ peer.getRemoteAddressString());
  }
 catch (  IOException ioe) {
    isOpSuccess=false;
    LOG.info("opCopyBlock " + block + " received exception "+ ioe);
    datanode.metrics.incrDatanodeNetworkErrors();
    throw ioe;
  }
 finally {
    dataXceiverServer.balanceThrottler.release();
    if (isOpSuccess) {
      try {
        reply.writeChar('d');
      }
 catch (      IOException ignored) {
      }
    }
    IOUtils.closeStream(reply);
    IOUtils.closeStream(blockSender);
  }
  datanode.metrics.addCopyBlockOp(elapsed());
}
