{
  final Map<Block,BInfo> map=getMap(b.getBlockPoolId());
  BInfo binfo=map.get(b.getLocalBlock());
  if (binfo == null) {
    throw new ReplicaNotFoundException("Block " + b + " is not valid, and cannot be appended to.");
  }
  if (!binfo.isFinalized()) {
    binfo.finalizeBlock(b.getBlockPoolId(),binfo.getNumBytes());
  }
  map.remove(b.getLocalBlock());
  binfo.theBlock.setGenerationStamp(newGS);
  map.put(binfo.theBlock,binfo);
  return binfo;
}
