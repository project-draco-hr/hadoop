{
  long inodeId=inodeIdFromOp;
  if (inodeId == INodeId.GRANDFATHER_INODE_ID) {
    if (LayoutVersion.supports(Feature.ADD_INODE_ID,logVersion)) {
      throw new IOException("The layout version " + logVersion + " supports inodeId but gave bogus inodeId");
    }
    inodeId=fsNamesys.allocateNewInodeId();
  }
 else {
    if (inodeId > lastInodeId) {
      fsNamesys.resetLastInodeId(inodeId);
    }
  }
  return inodeId;
}
