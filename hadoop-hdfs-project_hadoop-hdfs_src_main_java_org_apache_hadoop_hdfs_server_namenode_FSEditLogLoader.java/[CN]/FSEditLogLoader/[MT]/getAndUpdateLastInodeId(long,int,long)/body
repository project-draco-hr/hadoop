{
  long inodeId=inodeIdFromOp;
  if (inodeId == INodeId.GRANDFATHER_INODE_ID) {
    if (NameNodeLayoutVersion.supports(LayoutVersion.Feature.ADD_INODE_ID,logVersion)) {
      throw new IOException("The layout version " + logVersion + " supports inodeId but gave bogus inodeId");
    }
    inodeId=fsNamesys.dir.allocateNewInodeId();
  }
 else {
    if (inodeId > lastInodeId) {
      fsNamesys.dir.resetLastInodeId(inodeId);
    }
  }
  return inodeId;
}
