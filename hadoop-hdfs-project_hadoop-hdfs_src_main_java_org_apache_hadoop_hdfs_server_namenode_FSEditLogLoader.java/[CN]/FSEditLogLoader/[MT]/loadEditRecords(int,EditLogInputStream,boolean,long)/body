{
  FSDirectory fsDir=fsNamesys.dir;
  long numEdits=0;
  EnumMap<FSEditLogOpCodes,Holder<Integer>> opCounts=new EnumMap<FSEditLogOpCodes,Holder<Integer>>(FSEditLogOpCodes.class);
  if (LOG.isTraceEnabled()) {
    LOG.trace("Acquiring write lock to replay edit log");
  }
  fsNamesys.writeLock();
  fsDir.writeLock();
  long recentOpcodeOffsets[]=new long[4];
  Arrays.fill(recentOpcodeOffsets,-1);
  long txId=expectedStartingTxId - 1;
  long lastTxId=in.getLastTxId();
  long numTxns=(lastTxId - expectedStartingTxId) + 1;
  long lastLogTime=now();
  if (LOG.isDebugEnabled()) {
    LOG.debug("edit log length: " + in.length() + ", start txid: "+ expectedStartingTxId+ ", last txid: "+ lastTxId);
  }
  try {
    try {
      while (true) {
        FSEditLogOp op;
        try {
          if ((op=in.readOp()) == null) {
            break;
          }
        }
 catch (        IOException ioe) {
          long badTxId=txId + 1;
          String errorMessage=formatEditLogReplayError(in,recentOpcodeOffsets,badTxId);
          FSImage.LOG.error(errorMessage);
          throw new EditLogInputException(errorMessage,ioe,numEdits);
        }
        recentOpcodeOffsets[(int)(numEdits % recentOpcodeOffsets.length)]=in.getPosition();
        if (LayoutVersion.supports(Feature.STORED_TXIDS,logVersion)) {
          long expectedTxId=txId + 1;
          txId=op.txid;
          if (txId != expectedTxId) {
            throw new IOException("Expected transaction ID " + expectedTxId + " but got "+ txId);
          }
        }
        incrOpCount(op.opCode,opCounts);
        try {
          applyEditLogOp(op,fsDir,logVersion);
        }
 catch (        Throwable t) {
          String errorMessage=formatEditLogReplayError(in,recentOpcodeOffsets,txId);
          FSImage.LOG.error(errorMessage);
          throw new IOException(errorMessage,t);
        }
        if (now() - lastLogTime > REPLAY_TRANSACTION_LOG_INTERVAL) {
          int percent=Math.round((float)txId / numTxns * 100);
          LOG.info("replaying edit log: " + txId + "/"+ numTxns+ " transactions completed. ("+ percent+ "%)");
          lastLogTime=now();
        }
        numEdits++;
      }
    }
 catch (    IOException ex) {
      check203UpgradeFailure(logVersion,ex);
    }
 finally {
      if (closeOnExit)       in.close();
    }
  }
  finally {
    fsDir.writeUnlock();
    fsNamesys.writeUnlock();
    if (LOG.isTraceEnabled()) {
      LOG.trace("replaying edit log finished");
    }
    if (FSImage.LOG.isDebugEnabled()) {
      dumpOpCounts(opCounts);
    }
  }
  return numEdits;
}
