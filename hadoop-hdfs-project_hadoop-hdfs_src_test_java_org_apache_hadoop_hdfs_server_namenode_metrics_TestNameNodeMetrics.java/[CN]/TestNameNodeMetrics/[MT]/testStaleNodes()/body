{
  for (int i=0; i < 2; i++) {
    DataNode dn=cluster.getDataNodes().get(i);
    DataNodeTestUtils.setHeartbeatsDisabledForTests(dn,true);
    long staleInterval=CONF.getLong(DFSConfigKeys.DFS_NAMENODE_STALE_DATANODE_INTERVAL_KEY,DFSConfigKeys.DFS_NAMENODE_STALE_DATANODE_INTERVAL_DEFAULT);
    cluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().getDatanode(dn.getDatanodeId()).setLastUpdate(Time.now() - staleInterval - 1);
  }
  BlockManagerTestUtil.checkHeartbeat(cluster.getNameNode().getNamesystem().getBlockManager());
  assertGauge("StaleDataNodes",2,getMetrics(NS_METRICS));
  for (int i=0; i < 2; i++) {
    DataNode dn=cluster.getDataNodes().get(i);
    DataNodeTestUtils.setHeartbeatsDisabledForTests(dn,false);
    cluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().getDatanode(dn.getDatanodeId()).setLastUpdate(Time.now());
  }
  BlockManagerTestUtil.checkHeartbeat(cluster.getNameNode().getNamesystem().getBlockManager());
  assertGauge("StaleDataNodes",0,getMetrics(NS_METRICS));
}
