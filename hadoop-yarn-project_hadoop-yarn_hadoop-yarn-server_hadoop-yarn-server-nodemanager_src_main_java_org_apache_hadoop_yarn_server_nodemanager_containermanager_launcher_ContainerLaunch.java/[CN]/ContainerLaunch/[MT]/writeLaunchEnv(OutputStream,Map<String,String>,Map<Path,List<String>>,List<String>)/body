{
  ShellScriptBuilder sb=Shell.WINDOWS ? new WindowsShellScriptBuilder() : new UnixShellScriptBuilder();
  if (environment != null) {
    for (    Map.Entry<String,String> env : environment.entrySet()) {
      sb.env(env.getKey().toString(),env.getValue().toString());
    }
  }
  if (resources != null) {
    for (    Map.Entry<Path,List<String>> entry : resources.entrySet()) {
      for (      String linkName : entry.getValue()) {
        sb.symlink(entry.getKey(),new Path(linkName));
      }
    }
  }
  sb.command(command);
  PrintStream pout=null;
  try {
    pout=new PrintStream(out);
    sb.write(pout);
  }
  finally {
    if (out != null) {
      out.close();
    }
  }
}
