{
  final List<RMApp> apps=newRMApps(n,time,RMAppState.FINISHED);
  final ConcurrentMap<ApplicationId,RMApp> map=Maps.newConcurrentMap();
  for (  RMApp app : apps) {
    map.put(app.getApplicationId(),app);
  }
  Dispatcher rmDispatcher=new AsyncDispatcher();
  ContainerAllocationExpirer containerAllocationExpirer=new ContainerAllocationExpirer(rmDispatcher);
  AMLivelinessMonitor amLivelinessMonitor=new AMLivelinessMonitor(rmDispatcher);
  AMLivelinessMonitor amFinishingMonitor=new AMLivelinessMonitor(rmDispatcher);
  RMApplicationHistoryWriter writer=mock(RMApplicationHistoryWriter.class);
  RMContext context=new RMContextImpl(rmDispatcher,containerAllocationExpirer,amLivelinessMonitor,amFinishingMonitor,null,null,null,null,null,writer){
    @Override public ConcurrentMap<ApplicationId,RMApp> getRMApps(){
      return map;
    }
  }
;
  ((RMContextImpl)context).setStateStore(mock(RMStateStore.class));
  metricsPublisher=mock(SystemMetricsPublisher.class);
  ((RMContextImpl)context).setSystemMetricsPublisher(metricsPublisher);
  return context;
}
