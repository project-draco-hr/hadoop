{
  long now=System.currentTimeMillis();
  RMContext rmContext=mockRMContext(10,now - 20000);
  Configuration conf=new YarnConfiguration();
  int maxAppsInMemory=8;
  int maxAppsInStateStore=4;
  conf.setInt(YarnConfiguration.RM_MAX_COMPLETED_APPLICATIONS,maxAppsInMemory);
  conf.setInt(YarnConfiguration.RM_STATE_STORE_MAX_COMPLETED_APPLICATIONS,maxAppsInStateStore);
  TestRMAppManager appMonitor=new TestRMAppManager(rmContext,conf);
  addToCompletedApps(appMonitor,rmContext);
  Assert.assertEquals("Number of completed apps incorrect",10,appMonitor.getCompletedAppsListSize());
  appMonitor.checkAppNumCompletedLimit();
  Assert.assertEquals("Number of apps incorrect after # completed check",maxAppsInMemory,rmContext.getRMApps().size());
  Assert.assertEquals("Number of completed apps incorrect after check",maxAppsInMemory,appMonitor.getCompletedAppsListSize());
  int numRemoveAppsFromStateStore=10 - maxAppsInStateStore;
  verify(rmContext.getStateStore(),times(numRemoveAppsFromStateStore)).removeApplication(isA(RMApp.class));
  Assert.assertEquals(maxAppsInStateStore,appMonitor.getCompletedAppsInStateStore());
}
