{
  MiniDFSCluster cluster=null;
  DFSTestUtil util=new DFSTestUtil.Builder().setName("TestFileCorruption").setNumFiles(20).build();
  try {
    Configuration conf=new HdfsConfiguration();
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(3).build();
    FileSystem fs=cluster.getFileSystem();
    util.createFiles(fs,"/srcdat");
    File storageDir=cluster.getInstanceStorageDir(2,0);
    String bpid=cluster.getNamesystem().getBlockPoolId();
    File data_dir=MiniDFSCluster.getFinalizedDir(storageDir,bpid);
    assertTrue("data directory does not exist",data_dir.exists());
    Collection<File> blocks=FileUtils.listFiles(data_dir,new PrefixFileFilter(Block.BLOCK_FILE_PREFIX),DirectoryFileFilter.DIRECTORY);
    assertTrue("Blocks do not exist in data-dir",blocks.size() > 0);
    for (    File block : blocks) {
      System.out.println("Deliberately removing file " + block.getName());
      assertTrue("Cannot remove file.",block.delete());
    }
    assertTrue("Corrupted replicas not handled properly.",util.checkFiles(fs,"/srcdat"));
    util.cleanup(fs,"/srcdat");
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
