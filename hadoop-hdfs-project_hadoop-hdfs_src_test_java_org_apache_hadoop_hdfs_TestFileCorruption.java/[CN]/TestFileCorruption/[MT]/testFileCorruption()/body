{
  MiniDFSCluster cluster=null;
  DFSTestUtil util=new DFSTestUtil.Builder().setName("TestFileCorruption").setNumFiles(20).build();
  try {
    Configuration conf=new HdfsConfiguration();
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(3).build();
    FileSystem fs=cluster.getFileSystem();
    util.createFiles(fs,"/srcdat");
    String bpid=cluster.getNamesystem().getBlockPoolId();
    DataNode dn=cluster.getDataNodes().get(2);
    Map<DatanodeStorage,BlockListAsLongs> blockReports=dn.getFSDataset().getBlockReports(bpid);
    assertTrue("Blocks do not exist on data-dir",!blockReports.isEmpty());
    for (    BlockListAsLongs report : blockReports.values()) {
      for (      BlockReportReplica brr : report) {
        LOG.info("Deliberately removing block {}",brr.getBlockName());
        cluster.getFsDatasetTestUtils(2).getMaterializedReplica(new ExtendedBlock(bpid,brr)).deleteData();
      }
    }
    assertTrue("Corrupted replicas not handled properly.",util.checkFiles(fs,"/srcdat"));
    util.cleanup(fs,"/srcdat");
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
