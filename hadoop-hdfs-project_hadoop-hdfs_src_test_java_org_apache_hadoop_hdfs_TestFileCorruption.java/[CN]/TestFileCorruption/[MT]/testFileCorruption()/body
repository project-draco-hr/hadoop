{
  MiniDFSCluster cluster=null;
  DFSTestUtil util=new DFSTestUtil.Builder().setName("TestFileCorruption").setNumFiles(20).build();
  try {
    Configuration conf=new HdfsConfiguration();
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(3).build();
    FileSystem fs=cluster.getFileSystem();
    util.createFiles(fs,"/srcdat");
    File storageDir=cluster.getInstanceStorageDir(2,0);
    String bpid=cluster.getNamesystem().getBlockPoolId();
    File data_dir=MiniDFSCluster.getFinalizedDir(storageDir,bpid);
    assertTrue("data directory does not exist",data_dir.exists());
    File[] blocks=data_dir.listFiles();
    assertTrue("Blocks do not exist in data-dir",(blocks != null) && (blocks.length > 0));
    for (int idx=0; idx < blocks.length; idx++) {
      if (!blocks[idx].getName().startsWith("blk_")) {
        continue;
      }
      System.out.println("Deliberately removing file " + blocks[idx].getName());
      assertTrue("Cannot remove file.",blocks[idx].delete());
    }
    assertTrue("Corrupted replicas not handled properly.",util.checkFiles(fs,"/srcdat"));
    util.cleanup(fs,"/srcdat");
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
