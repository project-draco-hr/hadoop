{
  SecondaryNameNode secondary=null;
  try {
    cluster=new MiniDFSCluster.Builder(config).numDataNodes(1).manageNameDfsDirs(false).build();
    cluster.waitActive();
    secondary=new SecondaryNameNode(config);
    FSImage fsImage=cluster.getNameNode().getFSImage();
    printStorages(fsImage);
    FileSystem fs=cluster.getFileSystem();
    Path testPath=new Path("/","test");
    assertTrue(fs.mkdirs(testPath));
    printStorages(fsImage);
    invalidateStorage(fsImage,ImmutableSet.of(path1));
    cluster.getNameNodeRpc().rollEditLog();
    printStorages(fsImage);
    secondary.doCheckpoint();
    printStorages(fsImage);
    assertTrue("path exists before restart",fs.exists(testPath));
    secondary.shutdown();
    cluster.restartNameNode();
    assertTrue("path should still exist after restart",fs.exists(testPath));
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
    if (secondary != null) {
      secondary.shutdown();
    }
  }
}
