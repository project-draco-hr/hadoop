{
  SecondaryNameNode secondary=null;
  try {
    cluster=new MiniDFSCluster.Builder(config).numDataNodes(0).manageNameDfsDirs(false).build();
    cluster.waitActive();
    secondary=new SecondaryNameNode(config);
    printStorages(cluster.getNameNode().getFSImage());
    FileSystem fs=cluster.getFileSystem();
    Path path=new Path("/","test");
    assertTrue(fs.mkdirs(path));
    FileUtil.chmod(path2.toString(),"000");
    FileUtil.chmod(path3.toString(),"000");
    secondary.doCheckpoint();
    printStorages(cluster.getNameNode().getFSImage());
    path=new Path("/","test1");
    assertTrue(fs.mkdirs(path));
    assert(cluster.getNameNode().getFSImage().getStorage().getNumStorageDirs() == 1);
    secondary.doCheckpoint();
    assert(cluster.getNameNode().getFSImage().getStorage().getNumStorageDirs() == 1);
    FileUtil.chmod(path2.toString(),"755");
    FileUtil.chmod(path3.toString(),"755");
    secondary.doCheckpoint();
    assert(cluster.getNameNode().getFSImage().getStorage().getNumStorageDirs() == 3);
  }
  finally {
    if (path2.exists()) {
      FileUtil.chmod(path2.toString(),"755");
    }
    if (path3.exists()) {
      FileUtil.chmod(path3.toString(),"755");
    }
    if (cluster != null) {
      cluster.shutdown();
    }
    if (secondary != null) {
      secondary.shutdown();
    }
  }
}
