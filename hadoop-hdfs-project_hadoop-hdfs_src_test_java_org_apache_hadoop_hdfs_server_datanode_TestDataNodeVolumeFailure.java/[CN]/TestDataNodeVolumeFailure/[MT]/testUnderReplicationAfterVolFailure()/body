{
  assumeTrue(!Path.WINDOWS);
  cluster.startDataNodes(conf,1,true,null,null);
  cluster.waitActive();
  final BlockManager bm=cluster.getNamesystem().getBlockManager();
  Path file1=new Path("/test1");
  DFSTestUtil.createFile(fs,file1,1024,(short)3,1L);
  DFSTestUtil.waitReplication(fs,file1,(short)3);
  File dn1Vol1=new File(dataDir,"data" + (2 * 0 + 1));
  File dn2Vol1=new File(dataDir,"data" + (2 * 1 + 1));
  assertTrue("Couldn't chmod local vol",FileUtil.setExecutable(dn1Vol1,false));
  assertTrue("Couldn't chmod local vol",FileUtil.setExecutable(dn2Vol1,false));
  Path file2=new Path("/test2");
  DFSTestUtil.createFile(fs,file2,1024,(short)3,1L);
  DFSTestUtil.waitReplication(fs,file2,(short)3);
  int underReplicatedBlocks=BlockManagerTestUtil.checkHeartbeatAndGetUnderReplicatedBlocksCount(cluster.getNamesystem(),bm);
  assertTrue("There is no under replicated block after volume failure",underReplicatedBlocks > 0);
}
