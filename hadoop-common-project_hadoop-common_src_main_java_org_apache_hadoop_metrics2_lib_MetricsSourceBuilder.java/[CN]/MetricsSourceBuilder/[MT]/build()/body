{
  if (source instanceof MetricsSource) {
    if (hasAtMetric && !hasRegistry) {
      throw new MetricsException("Hybrid metrics: registry required.");
    }
    return (MetricsSource)source;
  }
 else   if (!hasAtMetric) {
    throw new MetricsException("No valid @Metric annotation found.");
  }
  return new MetricsSource(){
    @Override public void getMetrics(    MetricsCollector builder,    boolean all){
      registry.snapshot(builder.addRecord(registry.info()),all);
    }
  }
;
}
