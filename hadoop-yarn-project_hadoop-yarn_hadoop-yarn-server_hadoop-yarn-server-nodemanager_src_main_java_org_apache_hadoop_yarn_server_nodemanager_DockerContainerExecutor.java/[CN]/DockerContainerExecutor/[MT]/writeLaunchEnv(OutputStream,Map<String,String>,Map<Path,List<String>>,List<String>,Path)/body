{
  ContainerLaunch.ShellScriptBuilder sb=ContainerLaunch.ShellScriptBuilder.create();
  Set<String> exclusionSet=new HashSet<String>();
  exclusionSet.add(YarnConfiguration.NM_DOCKER_CONTAINER_EXECUTOR_IMAGE_NAME);
  exclusionSet.add(ApplicationConstants.Environment.HADOOP_YARN_HOME.name());
  exclusionSet.add(ApplicationConstants.Environment.HADOOP_COMMON_HOME.name());
  exclusionSet.add(ApplicationConstants.Environment.HADOOP_HDFS_HOME.name());
  exclusionSet.add(ApplicationConstants.Environment.HADOOP_CONF_DIR.name());
  exclusionSet.add(ApplicationConstants.Environment.JAVA_HOME.name());
  if (environment != null) {
    for (    Map.Entry<String,String> env : environment.entrySet()) {
      if (!exclusionSet.contains(env.getKey())) {
        sb.env(env.getKey().toString(),env.getValue().toString());
      }
    }
  }
  if (resources != null) {
    for (    Map.Entry<Path,List<String>> entry : resources.entrySet()) {
      for (      String linkName : entry.getValue()) {
        sb.symlink(entry.getKey(),new Path(linkName));
      }
    }
  }
  if (getConf() != null && getConf().getBoolean(YarnConfiguration.NM_LOG_CONTAINER_DEBUG_INFO,YarnConfiguration.DEFAULT_NM_LOG_CONTAINER_DEBUG_INFO)) {
    sb.copyDebugInformation(new Path(ContainerLaunch.CONTAINER_SCRIPT),new Path(logDir,ContainerLaunch.CONTAINER_SCRIPT));
    sb.listDebugInformation(new Path(logDir,DIRECTORY_CONTENTS));
  }
  sb.command(command);
  PrintStream pout=null;
  PrintStream ps=null;
  ByteArrayOutputStream baos=new ByteArrayOutputStream();
  try {
    pout=new PrintStream(out,false,"UTF-8");
    if (LOG.isDebugEnabled()) {
      ps=new PrintStream(baos,false,"UTF-8");
      sb.write(ps);
    }
    sb.write(pout);
  }
  finally {
    if (out != null) {
      out.close();
    }
    if (ps != null) {
      ps.close();
    }
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Script: " + baos.toString("UTF-8"));
  }
}
