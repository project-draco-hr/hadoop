{
  if (closed) {
    throw new IOException("Stream closed");
  }
  while (len > 0) {
    int remaining=bufferSize - pos;
    int toWrite=Math.min(remaining,len);
    System.arraycopy(b,off,outBuf,pos,toWrite);
    pos+=toWrite;
    off+=toWrite;
    len-=toWrite;
    filePos+=toWrite;
    if ((bytesWrittenToBlock + pos >= blockSize) || (pos == bufferSize)) {
      flush();
    }
  }
}
