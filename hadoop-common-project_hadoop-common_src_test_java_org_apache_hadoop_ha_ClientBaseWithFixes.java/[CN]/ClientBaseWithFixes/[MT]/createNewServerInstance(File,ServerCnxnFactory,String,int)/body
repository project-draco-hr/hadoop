{
  ZooKeeperServer zks=new ZooKeeperServer(dataDir,dataDir,3000);
  final int PORT=getPort(hostPort);
  if (factory == null) {
    factory=ServerCnxnFactory.createFactory(PORT,maxCnxns);
  }
  factory.startup(zks);
  Assert.assertTrue("waiting for server up",ClientBaseWithFixes.waitForServerUp("127.0.0.1:" + PORT,CONNECTION_TIMEOUT));
  return factory;
}
