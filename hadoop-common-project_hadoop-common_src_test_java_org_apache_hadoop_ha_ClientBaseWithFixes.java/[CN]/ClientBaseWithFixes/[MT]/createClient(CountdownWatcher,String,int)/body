{
  watcher.reset();
  TestableZooKeeper zk=new TestableZooKeeper(hp,timeout,watcher);
  if (!watcher.clientConnected.await(timeout,TimeUnit.MILLISECONDS)) {
    Assert.fail("Unable to connect to server");
  }
synchronized (this) {
    if (!allClientsSetup) {
      LOG.error("allClients never setup");
      Assert.fail("allClients never setup");
    }
    if (allClients != null) {
      allClients.add(zk);
    }
 else {
      zk.close();
    }
  }
  return zk;
}
