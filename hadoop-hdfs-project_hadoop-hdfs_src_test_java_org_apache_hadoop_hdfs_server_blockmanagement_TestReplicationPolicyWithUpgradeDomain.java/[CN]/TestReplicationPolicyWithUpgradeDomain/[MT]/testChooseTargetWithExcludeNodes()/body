{
  Set<Node> excludedNodes=new HashSet<>();
  DatanodeStorageInfo[] targets;
  List<DatanodeStorageInfo> chosenNodes=new ArrayList<>();
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[4]);
  targets=chooseTarget(3,chosenNodes,excludedNodes);
  assertEquals(targets.length,3);
  assertEquals(storages[0],targets[0]);
  assertEquals(getRacks(targets).size(),2);
  assertEquals(getUpgradeDomains(targets).size(),3);
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[4]);
  excludedNodes.add(dataNodes[8]);
  targets=chooseTarget(3,chosenNodes,excludedNodes);
  assertEquals(targets.length,3);
  assertEquals(storages[0],targets[0]);
  assertEquals(getRacks(targets).size(),2);
  assertEquals(getUpgradeDomains(targets).size(),3);
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[4]);
  excludedNodes.add(dataNodes[5]);
  excludedNodes.add(dataNodes[8]);
  targets=chooseTarget(3,chosenNodes,excludedNodes);
  assertEquals(targets.length,3);
  assertEquals(storages[0],targets[0]);
  assertEquals(storages[2],targets[1]);
  assertEquals(storages[7],targets[2]);
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[4]);
  targets=chooseTarget(4,chosenNodes,excludedNodes);
  assertEquals(targets.length,4);
  assertEquals(storages[0],targets[0]);
  assertTrue(getRacks(targets).size() >= 2);
  assertEquals(getUpgradeDomains(targets).size(),3);
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[4]);
  excludedNodes.add(dataNodes[8]);
  targets=chooseTarget(4,chosenNodes,excludedNodes);
  assertEquals(targets.length,4);
  assertEquals(storages[0],targets[0]);
  assertTrue(getRacks(targets).size() >= 2);
  assertEquals(getUpgradeDomains(targets).size(),3);
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[1]);
  chosenNodes.add(storages[2]);
  targets=replicator.chooseTarget(filename,1,dataNodes[0],chosenNodes,true,excludedNodes,BLOCK_SIZE,TestBlockStoragePolicy.DEFAULT_STORAGE_POLICY);
  System.out.println("targets=" + Arrays.asList(targets));
  assertEquals(2,targets.length);
}
