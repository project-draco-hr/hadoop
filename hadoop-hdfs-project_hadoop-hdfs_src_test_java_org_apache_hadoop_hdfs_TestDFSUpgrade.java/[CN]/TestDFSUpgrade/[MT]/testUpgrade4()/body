{
  int numDirs=4;
  conf=new HdfsConfiguration();
  conf.setInt(DFSConfigKeys.DFS_DATANODE_SCAN_PERIOD_HOURS_KEY,-1);
  conf.setBoolean(DFSConfigKeys.DFS_DATANODE_DUPLICATE_REPLICA_DELETION,false);
  conf=UpgradeUtilities.initializeStorageStateConf(numDirs,conf);
  String[] nameNodeDirs=conf.getStrings(DFSConfigKeys.DFS_NAMENODE_NAME_DIR_KEY);
  log("NameNode upgrade with one bad storage dir",numDirs);
  UpgradeUtilities.createNameNodeStorageDirs(nameNodeDirs,"current");
  try {
    startNameNodeShouldFail(StartupOption.UPGRADE,IOException.class,Pattern.compile("failed in 1 storage"));
  }
  finally {
    UpgradeUtilities.createEmptyDirs(nameNodeDirs);
  }
}
