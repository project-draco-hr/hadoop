{
  final Client client=new Client(LongWritable.class,conf);
  final TestServer server=new TestServer(1,false);
  server.callListener=new Runnable(){
    private int retryCount=0;
    @Override public void run(){
      Assert.assertEquals(retryCount++,Server.getCallRetryCount());
    }
  }
;
  final int totalRetry=10000;
  DummyProtocol proxy=(DummyProtocol)Proxy.newProxyInstance(DummyProtocol.class.getClassLoader(),new Class[]{DummyProtocol.class},new TestInvocationHandler(client,server,totalRetry));
  DummyProtocol retryProxy=(DummyProtocol)RetryProxy.create(DummyProtocol.class,proxy,RetryPolicies.RETRY_FOREVER);
  try {
    server.start();
    retryProxy.dummyRun();
    Assert.assertEquals(TestInvocationHandler.retry,totalRetry + 1);
  }
  finally {
    Client.setCallIdAndRetryCount(0,0);
    client.stop();
    server.stop();
  }
}
