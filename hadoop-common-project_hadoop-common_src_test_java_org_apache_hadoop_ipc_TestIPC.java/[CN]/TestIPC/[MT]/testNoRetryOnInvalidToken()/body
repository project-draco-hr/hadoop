{
  final Client client=new Client(LongWritable.class,conf);
  final TestServer server=new TestServer(1,false);
  TestInvalidTokenHandler handler=new TestInvalidTokenHandler(client,server);
  DummyProtocol proxy=(DummyProtocol)Proxy.newProxyInstance(DummyProtocol.class.getClassLoader(),new Class[]{DummyProtocol.class},handler);
  FailoverProxyProvider<DummyProtocol> provider=new DefaultFailoverProxyProvider<DummyProtocol>(DummyProtocol.class,proxy);
  DummyProtocol retryProxy=(DummyProtocol)RetryProxy.create(DummyProtocol.class,provider,RetryPolicies.failoverOnNetworkException(RetryPolicies.TRY_ONCE_THEN_FAIL,100,100,10000,0));
  try {
    server.start();
    retryProxy.dummyRun();
  }
  finally {
    Assert.assertEquals(handler.invocations,1);
    Client.setCallIdAndRetryCount(0,0,null);
    client.stop();
    server.stop();
  }
}
