{
  SocketFactory spyFactory=spy(NetUtils.getDefaultSocketFactory(conf));
  Mockito.doAnswer(new Answer<Socket>(){
    @Override public Socket answer(    InvocationOnMock invocation) throws Throwable {
      Socket s=spy((Socket)invocation.callRealMethod());
      doThrow(new RuntimeException("Injected fault")).when(s).setSoTimeout(anyInt());
      return s;
    }
  }
).when(spyFactory).createSocket();
  Server server=new TestServer(1,true);
  Client client=new Client(LongWritable.class,conf,spyFactory);
  server.start();
  try {
    InetSocketAddress address=NetUtils.getConnectAddress(server);
    try {
      call(client,RANDOM.nextLong(),address,conf);
      fail("Expected an exception to have been thrown");
    }
 catch (    Exception e) {
      LOG.info("caught expected exception",e);
      assertTrue(StringUtils.stringifyException(e).contains("Injected fault"));
    }
    Mockito.reset(spyFactory);
    call(client,RANDOM.nextLong(),address,conf);
  }
  finally {
    client.stop();
    server.stop();
  }
}
