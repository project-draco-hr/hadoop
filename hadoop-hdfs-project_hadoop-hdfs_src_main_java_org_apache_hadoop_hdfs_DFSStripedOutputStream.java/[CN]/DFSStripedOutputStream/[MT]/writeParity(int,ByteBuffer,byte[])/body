{
  final StripedDataStreamer current=setCurrentStreamer(index);
  final int len=buffer.limit();
  final long oldBytes=current.getBytesCurBlock();
  if (!current.isFailed()) {
    try {
      for (      DFSPacket p : generatePackets(buffer,checksumBuf)) {
        streamer.waitAndQueuePacket(p);
      }
      endBlock();
    }
 catch (    Exception e) {
      handleStreamerFailure("oldBytes=" + oldBytes + ", len="+ len,e);
    }
  }
  if (current.isFailed()) {
    final long newBytes=oldBytes + len;
    current.setBytesCurBlock(newBytes);
  }
}
