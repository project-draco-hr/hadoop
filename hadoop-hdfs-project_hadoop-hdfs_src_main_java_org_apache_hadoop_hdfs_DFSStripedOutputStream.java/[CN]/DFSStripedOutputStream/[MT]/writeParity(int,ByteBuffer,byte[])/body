{
  final StripedDataStreamer current=setCurrentStreamer(index);
  final int len=buffer.limit();
  final long oldBytes=current.getBytesCurBlock();
  if (!current.isFailed()) {
    try {
      DataChecksum sum=getDataChecksum();
      sum.calculateChunkedSums(buffer.array(),0,len,checksumBuf,0);
      for (int i=0; i < len; i+=sum.getBytesPerChecksum()) {
        int chunkLen=Math.min(sum.getBytesPerChecksum(),len - i);
        int ckOffset=i / sum.getBytesPerChecksum() * getChecksumSize();
        super.writeChunk(buffer.array(),i,chunkLen,checksumBuf,ckOffset,getChecksumSize());
      }
    }
 catch (    Exception e) {
      handleStreamerFailure("oldBytes=" + oldBytes + ", len="+ len,e);
    }
  }
  if (current.isFailed()) {
    final long newBytes=oldBytes + len;
    current.setBytesCurBlock(newBytes);
  }
}
