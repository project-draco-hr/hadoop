{
  if (isClosed()) {
    IOException e=getLeadingStreamer().getLastException().getAndSet(null);
    if (e != null) {
      throw e;
    }
 else {
      return;
    }
  }
  try {
    flushBuffer();
    if (currentPacket != null) {
      streamer.waitAndQueuePacket(currentPacket);
      currentPacket=null;
    }
    writeParityCellsForLastStripe();
    for (int i=0; i < numAllBlocks; i++) {
      curIdx=i;
      refreshStreamer();
      if (streamer.getBytesCurBlock() > 0) {
        currentPacket=createPacket(0,0,streamer.getBytesCurBlock(),streamer.getAndIncCurrentSeqno(),true);
        currentPacket.setSyncBlock(shouldSyncBlock);
      }
      flushInternal();
    }
    closeThreads(false);
    final ExtendedBlock lastBlock=getCommittedBlock();
    TraceScope scope=Trace.startSpan("completeFile",Sampler.NEVER);
    try {
      completeFile(lastBlock);
    }
  finally {
      scope.close();
    }
    dfsClient.endFileLease(fileId);
  }
 catch (  ClosedChannelException ignored) {
  }
 finally {
    setClosed();
  }
}
