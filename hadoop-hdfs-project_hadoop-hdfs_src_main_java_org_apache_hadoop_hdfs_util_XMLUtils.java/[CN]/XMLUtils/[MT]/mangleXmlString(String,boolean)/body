{
  final StringBuilder bld=new StringBuilder();
  final int length=str.length();
  for (int offset=0; offset < length; ) {
    final int cp=str.codePointAt(offset);
    final int len=Character.charCount(cp);
    if (codePointMustBeMangled(cp)) {
      bld.append(mangleCodePoint(cp));
    }
 else {
      String entityRef=null;
      if (createEntityRefs) {
        entityRef=codePointToEntityRef(cp);
      }
      if (entityRef != null) {
        bld.append(entityRef);
      }
 else {
        for (int i=0; i < len; i++) {
          bld.append(str.charAt(offset + i));
        }
      }
    }
    offset+=len;
  }
  return bld.toString();
}
