{
  final Path foo=new Path("/foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPLICATION,0L);
  SnapshotTestHelper.createSnapshot(hdfs,foo,"s0");
  hdfs.append(bar);
  INodeFile barNode=fsdir.getINode4Write(bar.toString()).asFile();
  BlockInfoContiguous[] blks=barNode.getBlocks();
  assertEquals(1,blks.length);
  assertEquals(BLOCKSIZE,blks[0].getNumBytes());
  ExtendedBlock previous=new ExtendedBlock(fsn.getBlockPoolId(),blks[0]);
  cluster.getNameNodeRpc().addBlock(bar.toString(),hdfs.getClient().getClientName(),previous,null,barNode.getId(),null);
  SnapshotTestHelper.createSnapshot(hdfs,foo,"s1");
  barNode=fsdir.getINode4Write(bar.toString()).asFile();
  blks=barNode.getBlocks();
  assertEquals(2,blks.length);
  assertEquals(BLOCKSIZE,blks[0].getNumBytes());
  assertEquals(0,blks[1].getNumBytes());
  hdfs.delete(bar,true);
  final Path sbar=SnapshotTestHelper.getSnapshotPath(foo,"s1",bar.getName());
  barNode=fsdir.getINode(sbar.toString()).asFile();
  blks=barNode.getBlocks();
  assertEquals(1,blks.length);
  assertEquals(BLOCKSIZE,blks[0].getNumBytes());
}
