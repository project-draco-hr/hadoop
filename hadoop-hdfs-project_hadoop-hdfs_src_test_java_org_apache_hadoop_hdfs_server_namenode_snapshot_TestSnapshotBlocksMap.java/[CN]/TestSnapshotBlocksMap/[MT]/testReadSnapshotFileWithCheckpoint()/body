{
  Path foo=new Path("/foo");
  hdfs.mkdirs(foo);
  hdfs.allowSnapshot(foo);
  Path bar=new Path("/foo/bar");
  DFSTestUtil.createFile(hdfs,bar,100,(short)2,100024L);
  hdfs.createSnapshot(foo,"s1");
  assertTrue(hdfs.delete(bar,true));
  NameNode nameNode=cluster.getNameNode();
  NameNodeAdapter.enterSafeMode(nameNode,false);
  NameNodeAdapter.saveNamespace(nameNode);
  NameNodeAdapter.leaveSafeMode(nameNode);
  cluster.restartNameNode(true);
  String snapshotPath=Snapshot.getSnapshotPath(foo.toString(),"s1/bar");
  DFSTestUtil.readFile(hdfs,new Path(snapshotPath));
}
