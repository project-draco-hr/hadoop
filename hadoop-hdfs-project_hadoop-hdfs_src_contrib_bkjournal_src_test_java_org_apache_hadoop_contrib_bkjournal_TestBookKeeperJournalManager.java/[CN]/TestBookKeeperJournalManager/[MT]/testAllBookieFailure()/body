{
  BookieServer bookieToFail=newBookie();
  BookieServer replacementBookie=null;
  try {
    int ensembleSize=numBookies + 1;
    assertEquals("New bookie didn't start",ensembleSize,checkBookiesUp(ensembleSize,10));
    Configuration conf=new Configuration();
    conf.setInt(BookKeeperJournalManager.BKJM_BOOKKEEPER_ENSEMBLE_SIZE,ensembleSize);
    conf.setInt(BookKeeperJournalManager.BKJM_BOOKKEEPER_QUORUM_SIZE,ensembleSize);
    long txid=1;
    BookKeeperJournalManager bkjm=new BookKeeperJournalManager(conf,URI.create("bookkeeper://" + zkEnsemble + "/hdfsjournal-allbookiefailure"));
    EditLogOutputStream out=bkjm.startLogSegment(txid);
    for (long i=1; i <= 3; i++) {
      FSEditLogOp op=FSEditLogTestUtil.getNoOpInstance();
      op.setTransactionId(txid++);
      out.write(op);
    }
    out.setReadyToFlush();
    out.flush();
    bookieToFail.shutdown();
    assertEquals("New bookie didn't die",numBookies,checkBookiesUp(numBookies,10));
    try {
      for (long i=1; i <= 3; i++) {
        FSEditLogOp op=FSEditLogTestUtil.getNoOpInstance();
        op.setTransactionId(txid++);
        out.write(op);
      }
      out.setReadyToFlush();
      out.flush();
      fail("should not get to this stage");
    }
 catch (    IOException ioe) {
      LOG.debug("Error writing to bookkeeper",ioe);
      assertTrue("Invalid exception message",ioe.getMessage().contains("Failed to write to bookkeeper"));
    }
    replacementBookie=newBookie();
    assertEquals("New bookie didn't start",numBookies + 1,checkBookiesUp(numBookies + 1,10));
    out=bkjm.startLogSegment(txid);
    for (long i=1; i <= 3; i++) {
      FSEditLogOp op=FSEditLogTestUtil.getNoOpInstance();
      op.setTransactionId(txid++);
      out.write(op);
    }
    out.setReadyToFlush();
    out.flush();
  }
 catch (  Exception e) {
    LOG.error("Exception in test",e);
    throw e;
  }
 finally {
    if (replacementBookie != null) {
      replacementBookie.shutdown();
    }
    bookieToFail.shutdown();
    if (checkBookiesUp(numBookies,30) != numBookies) {
      LOG.warn("Not all bookies from this test shut down, expect errors");
    }
  }
}
