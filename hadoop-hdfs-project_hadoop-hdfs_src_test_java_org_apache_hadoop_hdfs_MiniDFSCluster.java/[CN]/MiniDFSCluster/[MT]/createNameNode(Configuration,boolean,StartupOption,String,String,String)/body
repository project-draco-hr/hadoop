{
  if (format) {
    DFSTestUtil.formatNameNode(conf);
  }
  if (operation == StartupOption.UPGRADE) {
    operation.setClusterId(clusterId);
  }
  String originalDefaultFs=conf.get(FS_DEFAULT_NAME_KEY);
  String[] args=createArgs(operation);
  NameNode nn=NameNode.createNameNode(args,conf);
  if (operation == StartupOption.RECOVER) {
    return null;
  }
  conf.set(DFSUtil.addKeySuffixes(DFS_NAMENODE_RPC_ADDRESS_KEY,nameserviceId,nnId),nn.getNameNodeAddressHostPortString());
  if (nn.getHttpAddress() != null) {
    conf.set(DFSUtil.addKeySuffixes(DFS_NAMENODE_HTTP_ADDRESS_KEY,nameserviceId,nnId),NetUtils.getHostPortString(nn.getHttpAddress()));
  }
  if (nn.getHttpsAddress() != null) {
    conf.set(DFSUtil.addKeySuffixes(DFS_NAMENODE_HTTPS_ADDRESS_KEY,nameserviceId,nnId),NetUtils.getHostPortString(nn.getHttpsAddress()));
  }
  DFSUtil.setGenericConf(conf,nameserviceId,nnId,DFS_NAMENODE_HTTP_ADDRESS_KEY);
  NameNodeInfo info=new NameNodeInfo(nn,nameserviceId,nnId,operation,new Configuration(conf));
  namenodes.put(nameserviceId,info);
  if (originalDefaultFs == null) {
    conf.set(FS_DEFAULT_NAME_KEY,"");
  }
 else {
    conf.set(FS_DEFAULT_NAME_KEY,originalDefaultFs);
  }
  return info;
}
