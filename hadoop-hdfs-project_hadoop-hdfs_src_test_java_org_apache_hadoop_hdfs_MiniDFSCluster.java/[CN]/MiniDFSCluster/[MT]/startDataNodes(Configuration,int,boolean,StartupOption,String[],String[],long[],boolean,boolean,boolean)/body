{
  if (operation == StartupOption.RECOVER) {
    return;
  }
  if (checkDataNodeHostConfig) {
    conf.setIfUnset(DFS_DATANODE_HOST_NAME_KEY,"127.0.0.1");
  }
 else {
    conf.set(DFS_DATANODE_HOST_NAME_KEY,"127.0.0.1");
  }
  int curDatanodesNum=dataNodes.size();
  if (conf.get(DFS_BLOCKREPORT_INITIAL_DELAY_KEY) == null) {
    conf.setLong(DFS_BLOCKREPORT_INITIAL_DELAY_KEY,0);
  }
  if (racks != null && numDataNodes > racks.length) {
    throw new IllegalArgumentException("The length of racks [" + racks.length + "] is less than the number of datanodes ["+ numDataNodes+ "].");
  }
  if (hosts != null && numDataNodes > hosts.length) {
    throw new IllegalArgumentException("The length of hosts [" + hosts.length + "] is less than the number of datanodes ["+ numDataNodes+ "].");
  }
  if (racks != null && hosts == null) {
    hosts=new String[numDataNodes];
    for (int i=curDatanodesNum; i < curDatanodesNum + numDataNodes; i++) {
      hosts[i - curDatanodesNum]="host" + i + ".foo.com";
    }
  }
  if (simulatedCapacities != null && numDataNodes > simulatedCapacities.length) {
    throw new IllegalArgumentException("The length of simulatedCapacities [" + simulatedCapacities.length + "] is less than the number of datanodes ["+ numDataNodes+ "].");
  }
  String[] dnArgs=(operation == null || operation != StartupOption.ROLLBACK) ? null : new String[]{operation.getName()};
  for (int i=curDatanodesNum; i < curDatanodesNum + numDataNodes; i++) {
    Configuration dnConf=new HdfsConfiguration(conf);
    setupDatanodeAddress(dnConf,setupHostsFile,checkDataNodeAddrConfig);
    if (manageDfsDirs) {
      StringBuilder sb=new StringBuilder();
      for (int j=0; j < DIRS_PER_DATANODE; ++j) {
        File dir=getInstanceStorageDir(i,j);
        dir.mkdirs();
        if (!dir.isDirectory()) {
          throw new IOException("Mkdirs failed to create directory for DataNode " + dir);
        }
        sb.append((j > 0 ? "," : "") + fileAsURI(dir));
      }
      String dirs=sb.toString();
      dnConf.set(DFS_DATANODE_DATA_DIR_KEY,dirs);
      conf.set(DFS_DATANODE_DATA_DIR_KEY,dirs);
    }
    if (simulatedCapacities != null) {
      SimulatedFSDataset.setFactory(dnConf);
      dnConf.setLong(SimulatedFSDataset.CONFIG_PROPERTY_CAPACITY,simulatedCapacities[i - curDatanodesNum]);
    }
    LOG.info("Starting DataNode " + i + " with "+ DFSConfigKeys.DFS_DATANODE_DATA_DIR_KEY+ ": "+ dnConf.get(DFSConfigKeys.DFS_DATANODE_DATA_DIR_KEY));
    if (hosts != null) {
      dnConf.set(DFSConfigKeys.DFS_DATANODE_HOST_NAME_KEY,hosts[i - curDatanodesNum]);
      LOG.info("Starting DataNode " + i + " with hostname set to: "+ dnConf.get(DFSConfigKeys.DFS_DATANODE_HOST_NAME_KEY));
    }
    if (racks != null) {
      String name=hosts[i - curDatanodesNum];
      LOG.info("Adding node with hostname : " + name + " to rack "+ racks[i - curDatanodesNum]);
      StaticMapping.addNodeToRack(name,racks[i - curDatanodesNum]);
    }
    Configuration newconf=new HdfsConfiguration(dnConf);
    if (hosts != null) {
      NetUtils.addStaticResolution(hosts[i - curDatanodesNum],"localhost");
    }
    SecureResources secureResources=null;
    if (UserGroupInformation.isSecurityEnabled()) {
      try {
        secureResources=SecureDataNodeStarter.getSecureResources(dnConf);
      }
 catch (      Exception ex) {
        ex.printStackTrace();
      }
    }
    DataNode dn=DataNode.instantiateDataNode(dnArgs,dnConf,secureResources);
    if (dn == null)     throw new IOException("Cannot start DataNode in " + dnConf.get(DFS_DATANODE_DATA_DIR_KEY));
    String service=SecurityUtil.buildTokenService(dn.getXferAddress()).toString();
    if (racks != null) {
      LOG.info("Adding node with service : " + service + " to rack "+ racks[i - curDatanodesNum]);
      StaticMapping.addNodeToRack(service,racks[i - curDatanodesNum]);
    }
    dn.runDatanodeDaemon();
    dataNodes.add(new DataNodeProperties(dn,newconf,dnArgs,secureResources));
  }
  curDatanodesNum+=numDataNodes;
  this.numDataNodes+=numDataNodes;
  waitActive();
}
