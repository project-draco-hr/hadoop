{
  if (setupHostsFile) {
    String hostsFile=conf.get(DFS_HOSTS,"").trim();
    if (hostsFile.length() == 0) {
      throw new IOException("Parameter dfs.hosts is not setup in conf");
    }
    String address="127.0.0.1:" + getFreeSocketPort();
    if (checkDataNodeAddrConfig) {
      conf.setIfUnset(DFS_DATANODE_ADDRESS_KEY,address);
    }
 else {
      conf.set(DFS_DATANODE_ADDRESS_KEY,address);
    }
    addToFile(hostsFile,address);
    LOG.info("Adding datanode " + address + " to hosts file "+ hostsFile);
  }
 else {
    if (checkDataNodeAddrConfig) {
      conf.setIfUnset(DFS_DATANODE_ADDRESS_KEY,"127.0.0.1:0");
      conf.setIfUnset(DFS_DATANODE_HTTP_ADDRESS_KEY,"127.0.0.1:0");
      conf.setIfUnset(DFS_DATANODE_IPC_ADDRESS_KEY,"127.0.0.1:0");
    }
 else {
      conf.set(DFS_DATANODE_ADDRESS_KEY,"127.0.0.1:0");
      conf.set(DFS_DATANODE_HTTP_ADDRESS_KEY,"127.0.0.1:0");
      conf.set(DFS_DATANODE_IPC_ADDRESS_KEY,"127.0.0.1:0");
    }
  }
}
