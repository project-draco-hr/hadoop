{
  MiniDFSCluster cluster=null;
  try {
    Configuration conf=new HdfsConfiguration();
    conf.setBoolean(DFSConfigKeys.DFS_PERMISSIONS_ENABLED_KEY,true);
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(4).build();
    FileSystem hdfs=cluster.getFileSystem();
    assertTrue(hdfs instanceof DistributedFileSystem);
    Path tmpPath=new Path("/tmp");
    Path tmpPath2=new Path("/tmp2");
    hdfs.mkdirs(tmpPath);
    hdfs.mkdirs(tmpPath2);
    hdfs.setPermission(tmpPath,new FsPermission((short)01777));
    hdfs.setPermission(tmpPath2,new FsPermission((short)01777));
    Path file=new Path(tmpPath,"foo");
    FileSystem hdfs2=DFSTestUtil.getFileSystemAs(user1,conf);
    writeFile(hdfs2,file);
    FileSystem hdfs3=DFSTestUtil.getFileSystemAs(user2,conf);
    try {
      hdfs3.rename(file,new Path(tmpPath2,"renamed"));
      fail("Shouldn't be able to rename someone else's file with SB on");
    }
 catch (    IOException ioe) {
      assertTrue(ioe instanceof AccessControlException);
      assertTrue(ioe.getMessage().contains("sticky bit"));
    }
  }
  finally {
    if (cluster != null)     cluster.shutdown();
  }
}
