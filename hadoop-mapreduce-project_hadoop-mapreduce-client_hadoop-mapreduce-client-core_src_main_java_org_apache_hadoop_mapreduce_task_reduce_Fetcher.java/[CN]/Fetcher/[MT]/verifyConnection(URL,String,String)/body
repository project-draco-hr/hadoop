{
  int rc=connection.getResponseCode();
  if (rc != HttpURLConnection.HTTP_OK) {
    throw new IOException("Got invalid response code " + rc + " from "+ url+ ": "+ connection.getResponseMessage());
  }
  if (!ShuffleHeader.DEFAULT_HTTP_HEADER_NAME.equals(connection.getHeaderField(ShuffleHeader.HTTP_HEADER_NAME)) || !ShuffleHeader.DEFAULT_HTTP_HEADER_VERSION.equals(connection.getHeaderField(ShuffleHeader.HTTP_HEADER_VERSION))) {
    throw new IOException("Incompatible shuffle response version");
  }
  String replyHash=connection.getHeaderField(SecureShuffleUtils.HTTP_HEADER_REPLY_URL_HASH);
  if (replyHash == null) {
    throw new IOException("security validation of TT Map output failed");
  }
  LOG.debug("url=" + msgToEncode + ";encHash="+ encHash+ ";replyHash="+ replyHash);
  SecureShuffleUtils.verifyReply(replyHash,encHash,shuffleSecretKey);
  LOG.debug("for url=" + msgToEncode + " sent hash and received reply");
}
