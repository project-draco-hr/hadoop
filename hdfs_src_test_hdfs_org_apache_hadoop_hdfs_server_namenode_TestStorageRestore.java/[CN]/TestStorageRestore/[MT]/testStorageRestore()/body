{
  int numDatanodes=2;
  cluster=new MiniDFSCluster.Builder(config).numDataNodes(numDatanodes).manageNameDfsDirs(false).build();
  cluster.waitActive();
  SecondaryNameNode secondary=new SecondaryNameNode(config);
  System.out.println("****testStorageRestore: Cluster and SNN started");
  printStorages(cluster.getNameNode().getFSImage());
  FileSystem fs=cluster.getFileSystem();
  Path path=new Path("/","test");
  writeFile(fs,path,2);
  System.out.println("****testStorageRestore: file test written, invalidating storage...");
  invalidateStorage(cluster.getNameNode().getFSImage(),ImmutableSet.of(path2,path3));
  printStorages(cluster.getNameNode().getFSImage());
  System.out.println("****testStorageRestore: storage invalidated + doCheckpoint");
  path=new Path("/","test1");
  writeFile(fs,path,2);
  System.out.println("****testStorageRestore: file test1 written");
  checkFiles(false);
  System.out.println("****testStorageRestore: checkfiles(false) run");
  secondary.doCheckpoint();
  checkFiles(true);
  System.out.println("****testStorageRestore: second Checkpoint done and checkFiles(true) run");
  path=new Path("/","test2");
  writeFile(fs,path,2);
  System.out.println("****testStorageRestore: wrote a file and checkFiles(true) run");
  checkFiles(true);
  secondary.shutdown();
  cluster.shutdown();
}
