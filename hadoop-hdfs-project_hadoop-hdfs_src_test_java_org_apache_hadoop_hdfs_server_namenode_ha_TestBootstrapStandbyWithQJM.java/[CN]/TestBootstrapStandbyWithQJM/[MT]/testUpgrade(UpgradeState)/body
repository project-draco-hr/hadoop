{
  cluster.transitionToActive(0);
  final Configuration confNN1=cluster.getConfiguration(1);
  final File current=cluster.getNameNode(1).getFSImage().getStorage().getStorageDir(0).getCurrentDir();
  final File tmp=cluster.getNameNode(1).getFSImage().getStorage().getStorageDir(0).getPreviousTmp();
  cluster.shutdownNameNode(1);
  FSImage fsImage0=cluster.getNameNode(0).getNamesystem().getFSImage();
  Whitebox.setInternalState(fsImage0,"isUpgradeFinalized",false);
switch (state) {
case RECOVER:
    NNStorage.rename(current,tmp);
  break;
case FORMAT:
final File wrongPath=new File(current.getParentFile(),"wrong");
NNStorage.rename(current,wrongPath);
break;
default :
break;
}
int rc=BootstrapStandby.run(new String[]{"-force"},confNN1);
assertEquals(0,rc);
FSImageTestUtil.assertNNHasCheckpoints(cluster,1,ImmutableList.of(0));
FSImageTestUtil.assertNNFilesMatch(cluster);
cluster.restartNameNode(1);
assertFalse(cluster.getNameNode(1).getNamesystem().isUpgradeFinalized());
}
