{
  final JobConf job=new JobConf(MRJobConfig.JOB_CONF_FILE);
  job.setCredentials(credentials);
  MRApps.setJobClassLoader(job);
  String appAttemptIdEnv=System.getenv(MRJobConfig.APPLICATION_ATTEMPT_ID_ENV);
  LOG.debug("APPLICATION_ATTEMPT_ID: " + appAttemptIdEnv);
  job.setInt(MRJobConfig.APPLICATION_ATTEMPT_ID,Integer.parseInt(appAttemptIdEnv));
  job.setBoolean("ipc.client.tcpnodelay",true);
  job.setClass(MRConfig.TASK_LOCAL_OUTPUT_CLASS,YarnOutputFiles.class,MapOutputFile.class);
  task.setJobTokenSecret(JobTokenSecretManager.createSecretKey(jt.getPassword()));
  byte[] shuffleSecret=TokenCache.getShuffleSecretKey(credentials);
  if (shuffleSecret == null) {
    LOG.warn("Shuffle secret missing from task credentials." + " Using job token secret as shuffle secret.");
    shuffleSecret=jt.getPassword();
  }
  task.setShuffleSecret(JobTokenSecretManager.createSecretKey(shuffleSecret));
  configureLocalDirs(task,job);
  task.localizeConfiguration(job);
  setupDistributedCacheConfig(job);
  Path localTaskFile=new Path(MRJobConfig.JOB_CONF_FILE);
  writeLocalJobFile(localTaskFile,job);
  task.setJobFile(localTaskFile.toString());
  task.setConf(job);
  return job;
}
