{
  Thread.setDefaultUncaughtExceptionHandler(new YarnUncaughtExceptionHandler());
  LOG.debug("Child starting");
  final JobConf job=new JobConf(MRJobConfig.JOB_CONF_FILE);
  Limits.init(job);
  UserGroupInformation.setConfiguration(job);
  String host=args[0];
  int port=Integer.parseInt(args[1]);
  final InetSocketAddress address=NetUtils.createSocketAddrForHost(host,port);
  final TaskAttemptID firstTaskid=TaskAttemptID.forName(args[2]);
  long jvmIdLong=Long.parseLong(args[3]);
  JVMId jvmId=new JVMId(firstTaskid.getJobID(),firstTaskid.getTaskType() == TaskType.MAP,jvmIdLong);
  DefaultMetricsSystem.initialize(StringUtils.camelize(firstTaskid.getTaskType().name()) + "Task");
  Credentials credentials=UserGroupInformation.getCurrentUser().getCredentials();
  LOG.info("Executing with tokens:");
  for (  Token<?> token : credentials.getAllTokens()) {
    LOG.info(token);
  }
  UserGroupInformation taskOwner=UserGroupInformation.createRemoteUser(firstTaskid.getJobID().toString());
  Token<JobTokenIdentifier> jt=TokenCache.getJobToken(credentials);
  SecurityUtil.setTokenService(jt,address);
  taskOwner.addToken(jt);
  final TaskUmbilicalProtocol umbilical=taskOwner.doAs(new PrivilegedExceptionAction<TaskUmbilicalProtocol>(){
    @Override public TaskUmbilicalProtocol run() throws Exception {
      return (TaskUmbilicalProtocol)RPC.getProxy(TaskUmbilicalProtocol.class,TaskUmbilicalProtocol.versionID,address,job);
    }
  }
);
  JvmContext context=new JvmContext(jvmId,"-1000");
  LOG.debug("PID: " + System.getenv().get("JVM_PID"));
  Task task=null;
  UserGroupInformation childUGI=null;
  ScheduledExecutorService logSyncer=null;
  try {
    int idleLoopCount=0;
    JvmTask myTask=null;
    ;
    for (int idle=0; null == myTask; ++idle) {
      long sleepTimeMilliSecs=Math.min(idle * 500,1500);
      LOG.info("Sleeping for " + sleepTimeMilliSecs + "ms before retrying again. Got null now.");
      MILLISECONDS.sleep(sleepTimeMilliSecs);
      myTask=umbilical.getTask(context);
    }
    if (myTask.shouldDie()) {
      return;
    }
    task=myTask.getTask();
    YarnChild.taskid=task.getTaskID();
    configureTask(job,task,credentials,jt);
    String systemPropsToLog=MRApps.getSystemPropertiesToLog(job);
    if (systemPropsToLog != null) {
      LOG.info(systemPropsToLog);
    }
    JvmMetrics.initSingleton(jvmId.toString(),job.getSessionId());
    childUGI=UserGroupInformation.createRemoteUser(System.getenv(ApplicationConstants.Environment.USER.toString()));
    childUGI.addCredentials(credentials);
    MRApps.setJobClassLoader(job);
    logSyncer=TaskLog.createLogSyncer();
    final Task taskFinal=task;
    childUGI.doAs(new PrivilegedExceptionAction<Object>(){
      @Override public Object run() throws Exception {
        FileSystem.get(job).setWorkingDirectory(job.getWorkingDirectory());
        taskFinal.run(job,umbilical);
        return null;
      }
    }
);
  }
 catch (  FSError e) {
    LOG.fatal("FSError from child",e);
    if (!ShutdownHookManager.get().isShutdownInProgress()) {
      umbilical.fsError(taskid,e.getMessage());
    }
  }
catch (  Exception exception) {
    LOG.warn("Exception running child : " + StringUtils.stringifyException(exception));
    try {
      if (task != null) {
        if (childUGI == null) {
          task.taskCleanup(umbilical);
        }
 else {
          final Task taskFinal=task;
          childUGI.doAs(new PrivilegedExceptionAction<Object>(){
            @Override public Object run() throws Exception {
              taskFinal.taskCleanup(umbilical);
              return null;
            }
          }
);
        }
      }
    }
 catch (    Exception e) {
      LOG.info("Exception cleaning up: " + StringUtils.stringifyException(e));
    }
    if (taskid != null) {
      if (!ShutdownHookManager.get().isShutdownInProgress()) {
        umbilical.fatalError(taskid,StringUtils.stringifyException(exception));
      }
    }
  }
catch (  Throwable throwable) {
    LOG.fatal("Error running child : " + StringUtils.stringifyException(throwable));
    if (taskid != null) {
      if (!ShutdownHookManager.get().isShutdownInProgress()) {
        Throwable tCause=throwable.getCause();
        String cause=tCause == null ? throwable.getMessage() : StringUtils.stringifyException(tCause);
        umbilical.fatalError(taskid,cause);
      }
    }
  }
 finally {
    RPC.stopProxy(umbilical);
    DefaultMetricsSystem.shutdown();
    TaskLog.syncLogsShutdown(logSyncer);
  }
}
