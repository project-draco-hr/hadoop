{
  LOG.info("Application " + applicationAttemptId + " is done."+ " finalState="+ rmAppAttemptFinalState);
  SchedulerApplication<FSAppAttempt> application=applications.get(applicationAttemptId.getApplicationId());
  FSAppAttempt attempt=getSchedulerApp(applicationAttemptId);
  if (attempt == null || application == null) {
    LOG.info("Unknown application " + applicationAttemptId + " has completed!");
    return;
  }
  for (  RMContainer rmContainer : attempt.getLiveContainers()) {
    if (keepContainers && rmContainer.getState().equals(RMContainerState.RUNNING)) {
      LOG.info("Skip killing " + rmContainer.getContainerId());
      continue;
    }
    super.completedContainer(rmContainer,SchedulerUtils.createAbnormalContainerStatus(rmContainer.getContainerId(),SchedulerUtils.COMPLETED_APPLICATION),RMContainerEventType.KILL);
  }
  for (  RMContainer rmContainer : attempt.getReservedContainers()) {
    super.completedContainer(rmContainer,SchedulerUtils.createAbnormalContainerStatus(rmContainer.getContainerId(),"Application Complete"),RMContainerEventType.KILL);
  }
  attempt.stop(rmAppAttemptFinalState);
  FSLeafQueue queue=queueMgr.getLeafQueue(attempt.getQueue().getQueueName(),false);
  boolean wasRunnable=queue.removeApp(attempt);
  if (wasRunnable) {
    maxRunningEnforcer.untrackRunnableApp(attempt);
    maxRunningEnforcer.updateRunnabilityOnAppRemoval(attempt,attempt.getQueue());
  }
 else {
    maxRunningEnforcer.untrackNonRunnableApp(attempt);
  }
}
