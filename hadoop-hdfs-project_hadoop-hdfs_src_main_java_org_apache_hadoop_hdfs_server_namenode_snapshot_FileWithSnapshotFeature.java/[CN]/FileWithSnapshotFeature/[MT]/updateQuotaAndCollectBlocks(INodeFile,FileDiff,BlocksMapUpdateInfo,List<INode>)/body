{
  long oldDiskspace=file.diskspaceConsumed();
  if (removed.snapshotINode != null) {
    short replication=removed.snapshotINode.getFileReplication();
    short currentRepl=file.getBlockReplication();
    if (currentRepl == 0) {
      oldDiskspace=file.computeFileSize(true,true) * replication;
    }
 else     if (replication > currentRepl) {
      oldDiskspace=oldDiskspace / file.getBlockReplication() * replication;
    }
    AclFeature aclFeature=removed.getSnapshotINode().getAclFeature();
    if (aclFeature != null) {
      AclStorage.removeAclFeature(aclFeature);
    }
  }
  collectBlocksAndClear(file,collectedBlocks,removedINodes);
  long dsDelta=oldDiskspace - file.diskspaceConsumed();
  return Quota.Counts.newInstance(0,dsDelta);
}
