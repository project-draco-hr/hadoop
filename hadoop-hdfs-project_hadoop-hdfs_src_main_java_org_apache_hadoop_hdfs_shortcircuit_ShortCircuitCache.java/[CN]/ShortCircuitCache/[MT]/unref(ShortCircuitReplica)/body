{
  lock.lock();
  try {
    if (!replica.purged) {
      String purgeReason=null;
      if (!replica.getDataStream().getChannel().isOpen()) {
        purgeReason="purging replica because its data channel is closed.";
      }
 else       if (!replica.getMetaStream().getChannel().isOpen()) {
        purgeReason="purging replica because its meta channel is closed.";
      }
 else       if (replica.isStale()) {
        purgeReason="purging replica because it is stale.";
      }
      if (purgeReason != null) {
        LOG.debug(this + ": " + purgeReason);
        purge(replica);
      }
    }
    String addedString="";
    boolean shouldTrimEvictionMaps=false;
    int newRefCount=--replica.refCount;
    if (newRefCount == 0) {
      Preconditions.checkArgument(replica.purged,"Replica %s reached a refCount of 0 without being purged",replica);
      replica.close();
    }
 else     if (newRefCount == 1) {
      Preconditions.checkState(null == replica.getEvictableTimeNs(),"Replica %s had a refCount higher than 1, " + "but was still evictable (evictableTimeNs = %d)",replica,replica.getEvictableTimeNs());
      if (!replica.purged) {
        if (replica.hasMmap()) {
          insertEvictable(System.nanoTime(),replica,evictableMmapped);
          addedString="added to evictableMmapped, ";
        }
 else {
          insertEvictable(System.nanoTime(),replica,evictable);
          addedString="added to evictable, ";
        }
        shouldTrimEvictionMaps=true;
      }
    }
 else {
      Preconditions.checkArgument(replica.refCount >= 0,"replica's refCount went negative (refCount = %d" + " for %s)",replica.refCount,replica);
    }
    if (LOG.isTraceEnabled()) {
      LOG.trace(this + ": unref replica " + replica+ ": "+ addedString+ " refCount "+ (newRefCount + 1)+ " -> "+ newRefCount+ StringUtils.getStackTrace(Thread.currentThread()));
    }
    if (shouldTrimEvictionMaps) {
      trimEvictionMaps();
    }
  }
  finally {
    lock.unlock();
  }
}
