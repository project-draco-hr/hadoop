{
  lock.lock();
  try {
    if (closed) {
      handler.handle(sock);
      IOUtils.cleanup(LOG,sock);
      return;
    }
    Entry entry=new Entry(sock,handler);
    try {
      sock.refCount.reference();
    }
 catch (    ClosedChannelException e1) {
      handler.handle(sock);
      return;
    }
    toAdd.add(entry);
    kick();
    while (true) {
      try {
        processedCond.await();
      }
 catch (      InterruptedException e) {
        Thread.currentThread().interrupt();
      }
      if (!toAdd.contains(entry)) {
        break;
      }
    }
  }
  finally {
    lock.unlock();
  }
}
