{
  if (numBlocks < maxBlocksPerDir) {
    final File dest=moveBlockFiles(b,src,dir);
    numBlocks+=1;
    return dest;
  }
  if (lastChildIdx < 0 && resetIdx) {
    lastChildIdx=DFSUtil.getRandom().nextInt(children.length);
  }
  if (lastChildIdx >= 0 && children != null) {
    for (int i=0; i < children.length; i++) {
      int idx=(lastChildIdx + i) % children.length;
      File file=children[idx].addBlock(b,src,false,resetIdx);
      if (file != null) {
        lastChildIdx=idx;
        return file;
      }
    }
    lastChildIdx=-1;
  }
  if (!createOk) {
    return null;
  }
  if (children == null || children.length == 0) {
    children=new FSDir[maxBlocksPerDir];
    for (int idx=0; idx < maxBlocksPerDir; idx++) {
      children[idx]=new FSDir(new File(dir,DataStorage.BLOCK_SUBDIR_PREFIX + idx));
    }
  }
  lastChildIdx=DFSUtil.getRandom().nextInt(children.length);
  return children[lastChildIdx].addBlock(b,src,true,false);
}
