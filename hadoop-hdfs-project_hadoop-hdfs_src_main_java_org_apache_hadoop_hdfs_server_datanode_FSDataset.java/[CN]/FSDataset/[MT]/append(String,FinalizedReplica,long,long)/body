{
  replicaInfo.unlinkBlock(1);
  File blkfile=replicaInfo.getBlockFile();
  FSVolume v=(FSVolume)replicaInfo.getVolume();
  if (v.getAvailable() < estimateBlockLen - replicaInfo.getNumBytes()) {
    throw new DiskOutOfSpaceException("Insufficient space for appending to " + replicaInfo);
  }
  File newBlkFile=new File(v.getRbwDir(bpid),replicaInfo.getBlockName());
  File oldmeta=replicaInfo.getMetaFile();
  ReplicaBeingWritten newReplicaInfo=new ReplicaBeingWritten(replicaInfo.getBlockId(),replicaInfo.getNumBytes(),newGS,v,newBlkFile.getParentFile(),Thread.currentThread());
  File newmeta=newReplicaInfo.getMetaFile();
  if (DataNode.LOG.isDebugEnabled()) {
    DataNode.LOG.debug("Renaming " + oldmeta + " to "+ newmeta);
  }
  if (!oldmeta.renameTo(newmeta)) {
    throw new IOException("Block " + replicaInfo + " reopen failed. "+ " Unable to move meta file  "+ oldmeta+ " to rbw dir "+ newmeta);
  }
  if (DataNode.LOG.isDebugEnabled()) {
    DataNode.LOG.debug("Renaming " + blkfile + " to "+ newBlkFile);
    DataNode.LOG.debug("Old block file length is " + blkfile.length());
  }
  if (!blkfile.renameTo(newBlkFile)) {
    if (!newmeta.renameTo(oldmeta)) {
      DataNode.LOG.warn("Cannot move meta file " + newmeta + "back to the finalized directory "+ oldmeta);
    }
    throw new IOException("Block " + replicaInfo + " reopen failed. "+ " Unable to move block file "+ blkfile+ " to rbw dir "+ newBlkFile);
  }
  volumeMap.add(bpid,newReplicaInfo);
  return newReplicaInfo;
}
