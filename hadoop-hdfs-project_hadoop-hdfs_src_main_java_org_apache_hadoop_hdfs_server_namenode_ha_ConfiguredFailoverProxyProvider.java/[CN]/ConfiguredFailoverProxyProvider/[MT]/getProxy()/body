{
  AddressRpcProxyPair current=proxies.get(currentProxyIndex);
  if (current.namenode == null) {
    try {
      if (NamenodeProtocol.class.equals(xface)) {
        current.namenode=DFSUtil.createNNProxyWithNamenodeProtocol(current.address,conf,ugi,false);
      }
 else       if (ClientProtocol.class.equals(xface)) {
        current.namenode=DFSUtil.createNNProxyWithClientProtocol(current.address,conf,ugi,false);
      }
 else {
        throw new IllegalStateException("Upsupported protocol found when creating the proxy conection to NameNode. " + ((xface != null) ? xface.getClass().getName() : xface) + " is not supported by "+ this.getClass().getName());
      }
    }
 catch (    IOException e) {
      LOG.error("Failed to create RPC proxy to NameNode",e);
      throw new RuntimeException(e);
    }
  }
  return (T)current.namenode;
}
