{
  System.out.println("Starting testNameNodeImageSendFail");
  Path file1=new Path("checkpointww.dat");
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(numDatanodes).format(false).build();
  cluster.waitActive();
  FileSystem fileSys=cluster.getFileSystem();
  try {
    assertTrue(!fileSys.exists(file1));
    SecondaryNameNode secondary=startSecondaryNameNode(conf);
    ErrorSimulator.setErrorSimulation(3);
    try {
      secondary.doCheckpoint();
      fail("Did not get expected exception");
    }
 catch (    IOException e) {
      assertTrue(e.getMessage().contains("is not of the advertised size"));
    }
    ErrorSimulator.clearErrorSimulation(3);
    secondary.shutdown();
    secondary=startSecondaryNameNode(conf);
    secondary.doCheckpoint();
    secondary.shutdown();
    writeFile(fileSys,file1,replication);
    checkFile(fileSys,file1,replication);
  }
  finally {
    fileSys.close();
    cluster.shutdown();
  }
}
