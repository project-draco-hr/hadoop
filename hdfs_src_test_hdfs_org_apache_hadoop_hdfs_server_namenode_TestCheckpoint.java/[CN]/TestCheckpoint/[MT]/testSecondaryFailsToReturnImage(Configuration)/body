{
  System.out.println("Starting testSecondaryFailsToReturnImage");
  Path file1=new Path("checkpointRI.dat");
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(numDatanodes).format(false).build();
  cluster.waitActive();
  FileSystem fileSys=cluster.getFileSystem();
  FSImage image=cluster.getNameNode().getFSImage();
  try {
    assertTrue(!fileSys.exists(file1));
    StorageDirectory sd=null;
    for (Iterator<StorageDirectory> it=image.getStorage().dirIterator(NameNodeDirType.IMAGE); it.hasNext(); )     sd=it.next();
    assertTrue(sd != null);
    long fsimageLength=image.getStorage().getStorageFile(sd,NameNodeFile.IMAGE).length();
    SecondaryNameNode secondary=startSecondaryNameNode(conf);
    ErrorSimulator.setErrorSimulation(2);
    try {
      secondary.doCheckpoint();
      assertTrue(false);
    }
 catch (    IOException e) {
      System.out.println("testSecondaryFailsToReturnImage: doCheckpoint() " + "failed predictably - " + e);
    }
    ErrorSimulator.clearErrorSimulation(2);
    for (Iterator<StorageDirectory> it=image.getStorage().dirIterator(NameNodeDirType.IMAGE); it.hasNext(); ) {
      assertTrue(image.getStorage().getStorageFile(it.next(),NameNodeFile.IMAGE).length() == fsimageLength);
    }
    secondary.shutdown();
  }
  finally {
    fileSys.close();
    cluster.shutdown();
  }
}
