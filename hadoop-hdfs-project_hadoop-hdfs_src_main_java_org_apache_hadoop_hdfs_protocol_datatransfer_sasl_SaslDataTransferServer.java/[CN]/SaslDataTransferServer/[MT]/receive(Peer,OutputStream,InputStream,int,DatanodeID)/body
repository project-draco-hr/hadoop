{
  if (dnConf.getEncryptDataTransfer()) {
    LOG.debug("SASL server doing encrypted handshake for peer = {}, datanodeId = {}",peer,datanodeId);
    return getEncryptedStreams(peer,underlyingOut,underlyingIn);
  }
 else   if (!UserGroupInformation.isSecurityEnabled()) {
    LOG.debug("SASL server skipping handshake in unsecured configuration for " + "peer = {}, datanodeId = {}",peer,datanodeId);
    return new IOStreamPair(underlyingIn,underlyingOut);
  }
 else   if (xferPort < 1024) {
    LOG.debug("SASL server skipping handshake in secured configuration for " + "peer = {}, datanodeId = {}",peer,datanodeId);
    return new IOStreamPair(underlyingIn,underlyingOut);
  }
 else   if (dnConf.getSaslPropsResolver() != null) {
    LOG.debug("SASL server doing general handshake for peer = {}, datanodeId = {}",peer,datanodeId);
    return getSaslStreams(peer,underlyingOut,underlyingIn);
  }
 else   if (dnConf.getIgnoreSecurePortsForTesting()) {
    LOG.debug("SASL server skipping handshake in secured configuration with no SASL " + "protection configured for peer = {}, datanodeId = {}",peer,datanodeId);
    return new IOStreamPair(underlyingIn,underlyingOut);
  }
 else {
    throw new IOException(String.format("Cannot create a secured " + "connection if DataNode listens on unprivileged port (%d) and no " + "protection is defined in configuration property %s.",datanodeId.getXferPort(),DFS_DATA_TRANSFER_PROTECTION_KEY));
  }
}
