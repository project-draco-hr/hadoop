{
  long bits=0L;
  int bitSetIndex=bitSet.nextSetBit(0);
  for (; bitSetIndex >= 0 && bitSetIndex < Long.SIZE; bitSetIndex=bitSet.nextSetBit(bitSetIndex + 1)) {
    bits|=1L << bitSetIndex;
  }
  WritableUtils.writeVLong(stream,bits);
  if (nbits > Long.SIZE) {
    bits=0L;
    for (int lastWordWritten=0; bitSetIndex >= 0 && bitSetIndex < nbits; bitSetIndex=bitSet.nextSetBit(bitSetIndex + 1)) {
      int bitsIndex=bitSetIndex % Byte.SIZE;
      int word=(bitSetIndex - Long.SIZE) / Byte.SIZE;
      if (word > lastWordWritten) {
        stream.writeByte((byte)bits);
        bits=0L;
        for (lastWordWritten++; lastWordWritten < word; lastWordWritten++) {
          stream.writeByte((byte)bits);
        }
      }
      bits|=1L << bitsIndex;
    }
    stream.writeByte((byte)bits);
  }
}
