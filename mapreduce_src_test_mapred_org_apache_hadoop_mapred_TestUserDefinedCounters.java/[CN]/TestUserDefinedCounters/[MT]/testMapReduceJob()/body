{
  JobConf conf=new JobConf(TestUserDefinedCounters.class);
  conf.setJobName("UserDefinedCounters");
  FileSystem fs=FileSystem.get(conf);
  cleanAndCreateInput(fs);
  conf.setInputFormat(TextInputFormat.class);
  conf.setMapOutputKeyClass(LongWritable.class);
  conf.setMapOutputValueClass(Text.class);
  conf.setOutputFormat(TextOutputFormat.class);
  conf.setOutputKeyClass(LongWritable.class);
  conf.setOutputValueClass(Text.class);
  conf.setMapperClass(CountingMapper.class);
  conf.setReducerClass(IdentityReducer.class);
  FileInputFormat.setInputPaths(conf,INPUT_DIR);
  FileOutputFormat.setOutputPath(conf,OUTPUT_DIR);
  RunningJob runningJob=JobClient.runJob(conf);
  Path[] outputFiles=FileUtil.stat2Paths(fs.listStatus(OUTPUT_DIR,new Utils.OutputFileUtils.OutputFilesFilter()));
  if (outputFiles.length > 0) {
    InputStream is=fs.open(outputFiles[0]);
    BufferedReader reader=new BufferedReader(new InputStreamReader(is));
    String line=reader.readLine();
    int counter=0;
    while (line != null) {
      counter++;
      assertTrue(line.contains("hello"));
      line=reader.readLine();
    }
    reader.close();
    assertEquals(4,counter);
  }
  verifyCounters(runningJob,4);
}
