{
  Configuration conf=new HdfsConfiguration();
  MiniQJMHACluster cluster=new MiniQJMHACluster.Builder(conf).build();
  try {
    cluster.getDfsCluster().waitActive();
    cluster.getDfsCluster().transitionToActive(0);
    DFSClient client=((DistributedFileSystem)HATestUtil.configureFailoverFs(cluster.getDfsCluster(),conf)).dfs;
    DFSInotifyEventInputStream eis=client.getInotifyEventStream();
    for (int i=0; i < 10; i++) {
      client.mkdirs("/dir" + i,null,false);
    }
    cluster.getDfsCluster().shutdownNameNode(0);
    cluster.getDfsCluster().transitionToActive(1);
    EventBatch batch=null;
    for (int i=0; i < 10; i++) {
      batch=waitForNextEvents(eis);
      Assert.assertEquals(1,batch.getEvents().length);
      Assert.assertTrue(batch.getEvents()[0].getEventType() == Event.EventType.CREATE);
      Assert.assertTrue(((Event.CreateEvent)batch.getEvents()[0]).getPath().equals("/dir" + i));
    }
    Assert.assertTrue(eis.poll() == null);
  }
  finally {
    cluster.shutdown();
  }
}
