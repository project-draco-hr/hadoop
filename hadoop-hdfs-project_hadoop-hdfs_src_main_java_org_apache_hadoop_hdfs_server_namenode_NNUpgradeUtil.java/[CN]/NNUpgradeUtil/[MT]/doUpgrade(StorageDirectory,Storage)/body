{
  LOG.info("Performing upgrade of storage directory " + sd.getRoot());
  try {
    storage.writeProperties(sd);
    File prevDir=sd.getPreviousDir();
    File tmpDir=sd.getPreviousTmp();
    Preconditions.checkState(!prevDir.exists(),"previous directory must not exist for upgrade.");
    Preconditions.checkState(tmpDir.exists(),"previous.tmp directory must exist for upgrade.");
    NNStorage.rename(tmpDir,prevDir);
  }
 catch (  IOException ioe) {
    LOG.error("Unable to rename temp to previous for " + sd.getRoot(),ioe);
    throw ioe;
  }
}
