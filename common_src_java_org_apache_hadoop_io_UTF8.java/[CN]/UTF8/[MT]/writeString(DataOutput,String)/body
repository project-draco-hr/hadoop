{
  if (s.length() > 0xffff / 3) {
    LOG.warn("truncating long string: " + s.length() + " chars, starting with "+ s.substring(0,20));
    s=s.substring(0,0xffff / 3);
  }
  int len=utf8Length(s);
  if (len > 0xffff)   throw new IOException("string too long!");
  out.writeShort(len);
  writeChars(out,s,0,s.length());
  return len;
}
