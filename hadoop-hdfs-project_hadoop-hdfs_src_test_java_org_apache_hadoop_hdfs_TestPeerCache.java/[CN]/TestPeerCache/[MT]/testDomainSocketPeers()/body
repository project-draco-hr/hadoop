{
  final int CAPACITY=3;
  PeerCache cache=new PeerCache(CAPACITY,100000);
  DatanodeID dnId=new DatanodeID("192.168.0.1","fakehostname","fake_datanode_id",100,101,102);
  HashMultiset<FakePeer> peers=HashMultiset.create(CAPACITY);
  for (int i=0; i < CAPACITY; ++i) {
    FakePeer peer=new FakePeer(dnId,i == CAPACITY - 1);
    peers.add(peer);
    cache.put(dnId,peer);
  }
  assertEquals(CAPACITY,cache.size());
  Peer peer=cache.get(dnId,true);
  assertTrue(peer.getDomainSocket() != null);
  peers.remove(peer);
  peer=cache.get(dnId,true);
  assertTrue(peer == null);
  while (!peers.isEmpty()) {
    peer=cache.get(dnId,false);
    assertTrue(peer != null);
    assertTrue(!peer.isClosed());
    peers.remove(peer);
  }
  assertEquals(0,cache.size());
  cache.close();
}
