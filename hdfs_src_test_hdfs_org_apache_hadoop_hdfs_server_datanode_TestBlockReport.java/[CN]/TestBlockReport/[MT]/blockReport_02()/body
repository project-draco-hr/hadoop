{
  final String METHOD_NAME=GenericTestUtils.getMethodName();
  LOG.info("Running test " + METHOD_NAME);
  Path filePath=new Path("/" + METHOD_NAME + ".dat");
  DFSTestUtil.createFile(fs,filePath,(long)FILE_SIZE,REPL_FACTOR,rand.nextLong());
  File dataDir=new File(cluster.getDataDirectory());
  assertTrue(dataDir.isDirectory());
  List<ExtendedBlock> blocks2Remove=new ArrayList<ExtendedBlock>();
  List<Integer> removedIndex=new ArrayList<Integer>();
  List<LocatedBlock> lBlocks=cluster.getNameNode().getBlockLocations(filePath.toString(),FILE_START,FILE_SIZE).getLocatedBlocks();
  while (removedIndex.size() != 2) {
    int newRemoveIndex=rand.nextInt(lBlocks.size());
    if (!removedIndex.contains(newRemoveIndex))     removedIndex.add(newRemoveIndex);
  }
  for (  Integer aRemovedIndex : removedIndex) {
    blocks2Remove.add(lBlocks.get(aRemovedIndex).getBlock());
  }
  ArrayList<Block> blocks=locatedToBlocks(lBlocks,removedIndex);
  if (LOG.isDebugEnabled()) {
    LOG.debug("Number of blocks allocated " + lBlocks.size());
  }
  for (  ExtendedBlock b : blocks2Remove) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Removing the block " + b.getBlockName());
    }
    for (    File f : findAllFiles(dataDir,new MyFileFilter(b.getBlockName(),true))) {
      cluster.getDataNodes().get(DN_N0).getFSDataset().unfinalizeBlock(b);
      if (!f.delete())       LOG.warn("Couldn't delete " + b.getBlockName());
    }
  }
  waitTil(DN_RESCAN_EXTRA_WAIT);
  DataNode dn=cluster.getDataNodes().get(DN_N0);
  String poolId=cluster.getNamesystem().getBlockPoolId();
  DatanodeRegistration dnR=dn.getDNRegistrationForBP(poolId);
  cluster.getNameNode().blockReport(dnR,poolId,new BlockListAsLongs(blocks,null).getBlockListAsLongs());
  cluster.getNamesystem().computeDatanodeWork();
  printStats();
  assertEquals("Wrong number of MissingBlocks is found",blocks2Remove.size(),cluster.getNamesystem().getMissingBlocksCount());
  assertEquals("Wrong number of UnderReplicatedBlocks is found",blocks2Remove.size(),cluster.getNamesystem().getUnderReplicatedBlocks());
}
