{
  final String hostname=host instanceof DatanodeInfo ? ((DatanodeInfo)host).getHostName() : host.getHost();
  final String scheme=request.getScheme();
  final int port="https".equals(scheme) ? (Integer)getServletContext().getAttribute("datanode.https.port") : host.getInfoPort();
  final String filename=request.getPathInfo();
  StringBuilder params=new StringBuilder();
  params.append("filename=");
  params.append(filename);
  if (UserGroupInformation.isSecurityEnabled()) {
    String tokenString=ugi.getTokens().iterator().next().encodeToUrlString();
    params.append(JspHelper.getDelegationTokenUrlParam(tokenString));
  }
 else {
    params.append("&ugi=");
    params.append(ugi.getShortUserName());
  }
  String nnAddr=NameNode.getHostPortString(nn.getNameNodeAddress());
  params.append(JspHelper.getUrlParam(JspHelper.NAMENODE_ADDRESS,nnAddr));
  return new URI(scheme,null,hostname,port,servletpath,params.toString(),null);
}
