{
  final WebHdfsFileSystem webhdfs=(WebHdfsFileSystem)fs;
  final Path root=new Path("/");
  final Path dir=new Path("/test/testUrl");
  assertTrue(webhdfs.mkdirs(dir));
  final Path file=new Path("/test/file");
  final FSDataOutputStream out=webhdfs.create(file);
  out.write(1);
  out.close();
{
    final URL url=webhdfs.toUrl(GetOpParam.Op.GETHOMEDIRECTORY,root);
    final HttpURLConnection conn=(HttpURLConnection)url.openConnection();
    final Map<?,?> m=WebHdfsTestUtil.connectAndGetJson(conn,HttpServletResponse.SC_OK);
    assertEquals(WebHdfsFileSystem.getHomeDirectoryString(ugi),m.get(Path.class.getSimpleName()));
    conn.disconnect();
  }
{
    final URL url=webhdfs.toUrl(GetOpParam.Op.GETHOMEDIRECTORY,root,new DoAsParam(ugi.getShortUserName() + "proxy"));
    final HttpURLConnection conn=(HttpURLConnection)url.openConnection();
    conn.connect();
    assertEquals(HttpServletResponse.SC_UNAUTHORIZED,conn.getResponseCode());
    conn.disconnect();
  }
{
    final URL url=webhdfs.toUrl(PutOpParam.Op.SETOWNER,dir);
    final HttpURLConnection conn=(HttpURLConnection)url.openConnection();
    conn.connect();
    assertEquals(HttpServletResponse.SC_BAD_REQUEST,conn.getResponseCode());
    conn.disconnect();
  }
{
    final HttpOpParam.Op op=PutOpParam.Op.SETREPLICATION;
    final URL url=webhdfs.toUrl(op,dir);
    final HttpURLConnection conn=(HttpURLConnection)url.openConnection();
    conn.setRequestMethod(op.getType().toString());
    conn.connect();
    assertEquals(HttpServletResponse.SC_OK,conn.getResponseCode());
    assertFalse(webhdfs.setReplication(dir,(short)1));
    conn.disconnect();
  }
{
    final Path p=new Path(dir,"non-exist");
    final URL url=webhdfs.toUrl(GetOpParam.Op.GETFILESTATUS,p);
    final HttpURLConnection conn=(HttpURLConnection)url.openConnection();
    conn.connect();
    assertEquals(HttpServletResponse.SC_NOT_FOUND,conn.getResponseCode());
    conn.disconnect();
  }
{
    final HttpOpParam.Op op=PutOpParam.Op.SETPERMISSION;
    final URL url=webhdfs.toUrl(op,dir);
    final HttpURLConnection conn=(HttpURLConnection)url.openConnection();
    conn.setRequestMethod(op.getType().toString());
    conn.connect();
    assertEquals(HttpServletResponse.SC_OK,conn.getResponseCode());
    assertEquals(0,conn.getContentLength());
    assertEquals(MediaType.APPLICATION_OCTET_STREAM,conn.getContentType());
    assertEquals((short)0755,webhdfs.getFileStatus(dir).getPermission().toShort());
    conn.disconnect();
  }
{
    AppendTestUtil.testAppend(fs,new Path(dir,"append"));
  }
{
    final HttpOpParam.Op op=PutOpParam.Op.CREATE;
    final URL url=webhdfs.toUrl(op,dir);
    HttpURLConnection conn=(HttpURLConnection)url.openConnection();
    conn.setRequestMethod(op.getType().toString());
    conn.setDoOutput(false);
    conn.setInstanceFollowRedirects(false);
    conn.connect();
    final String redirect=conn.getHeaderField("Location");
    conn.disconnect();
    WebHdfsFileSystem.LOG.info("redirect = " + redirect);
    final int i=redirect.indexOf(NamenodeRpcAddressParam.NAME);
    final int j=redirect.indexOf("&",i);
    String modified=redirect.substring(0,i - 1) + redirect.substring(j);
    WebHdfsFileSystem.LOG.info("modified = " + modified);
    conn=(HttpURLConnection)new URL(modified).openConnection();
    conn.setRequestMethod(op.getType().toString());
    conn.setDoOutput(op.getDoOutput());
    conn.connect();
    assertEquals(HttpServletResponse.SC_BAD_REQUEST,conn.getResponseCode());
  }
{
    final HttpOpParam.Op op=GetOpParam.Op.OPEN;
    final URL url=webhdfs.toUrl(op,file);
    final HttpURLConnection conn=(HttpURLConnection)url.openConnection();
    conn.setRequestMethod(op.getType().toString());
    conn.connect();
    try {
      WebHdfsFileSystem.jsonParse(conn,false);
      fail();
    }
 catch (    IOException ioe) {
      WebHdfsFileSystem.LOG.info("GOOD",ioe);
    }
    conn.disconnect();
  }
{
    HttpOpParam.Op op=PutOpParam.Op.CREATE;
    Path path=new Path("/test/path%20with%20spaces");
    URL url=webhdfs.toUrl(op,path);
    HttpURLConnection conn=(HttpURLConnection)url.openConnection();
    conn.setRequestMethod(op.getType().toString());
    conn.setDoOutput(false);
    conn.setInstanceFollowRedirects(false);
    final String redirect;
    try {
      conn.connect();
      assertEquals(HttpServletResponse.SC_TEMPORARY_REDIRECT,conn.getResponseCode());
      redirect=conn.getHeaderField("Location");
    }
  finally {
      conn.disconnect();
    }
    conn=(HttpURLConnection)new URL(redirect).openConnection();
    conn.setRequestMethod(op.getType().toString());
    conn.setDoOutput(op.getDoOutput());
    try {
      conn.connect();
      assertEquals(HttpServletResponse.SC_CREATED,conn.getResponseCode());
    }
  finally {
      conn.disconnect();
    }
  }
}
