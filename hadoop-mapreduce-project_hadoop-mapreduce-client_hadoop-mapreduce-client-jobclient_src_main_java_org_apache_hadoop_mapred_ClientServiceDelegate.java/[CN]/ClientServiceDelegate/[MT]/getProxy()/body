{
  if (!forceRefresh && realProxy != null) {
    return realProxy;
  }
  ApplicationReport application=rm.getApplicationReport(appId);
  if (application != null) {
    trackingUrl=application.getTrackingUrl();
  }
  String serviceAddr=null;
  while (application == null || YarnApplicationState.RUNNING == application.getYarnApplicationState()) {
    if (application == null) {
      LOG.info("Could not get Job info from RM for job " + jobId + ". Redirecting to job history server.");
      return checkAndGetHSProxy(null,JobState.NEW);
    }
    try {
      if (application.getHost() == null || "".equals(application.getHost())) {
        LOG.debug("AM not assigned to Job. Waiting to get the AM ...");
        Thread.sleep(2000);
        LOG.debug("Application state is " + application.getYarnApplicationState());
        application=rm.getApplicationReport(appId);
        continue;
      }
      serviceAddr=application.getHost() + ":" + application.getRpcPort();
      if (UserGroupInformation.isSecurityEnabled()) {
        String clientTokenEncoded=application.getClientToken();
        Token<ApplicationTokenIdentifier> clientToken=new Token<ApplicationTokenIdentifier>();
        clientToken.decodeFromUrlString(clientTokenEncoded);
        InetSocketAddress addr=NetUtils.createSocketAddr(application.getHost(),application.getRpcPort());
        clientToken.setService(new Text(addr.getAddress().getHostAddress() + ":" + addr.getPort()));
        UserGroupInformation.getCurrentUser().addToken(clientToken);
      }
      LOG.info("Tracking Url of JOB is " + application.getTrackingUrl());
      LOG.info("Connecting to " + serviceAddr);
      instantiateAMProxy(serviceAddr);
      return realProxy;
    }
 catch (    IOException e) {
      LOG.info("Could not connect to " + serviceAddr + ". Waiting for getting the latest AM address...");
      try {
        Thread.sleep(2000);
      }
 catch (      InterruptedException e1) {
        LOG.warn("getProxy() call interruped",e1);
        throw new YarnException(e1);
      }
      application=rm.getApplicationReport(appId);
      if (application == null) {
        LOG.info("Could not get Job info from RM for job " + jobId + ". Redirecting to job history server.");
        return checkAndGetHSProxy(null,JobState.RUNNING);
      }
    }
catch (    InterruptedException e) {
      LOG.warn("getProxy() call interruped",e);
      throw new YarnException(e);
    }
  }
  String user=application.getUser();
  if (user == null) {
    throw RPCUtil.getRemoteException("User is not set in the application report");
  }
  if (application.getYarnApplicationState() == YarnApplicationState.NEW || application.getYarnApplicationState() == YarnApplicationState.SUBMITTED) {
    realProxy=null;
    return getNotRunningJob(application,JobState.NEW);
  }
  if (application.getYarnApplicationState() == YarnApplicationState.FAILED) {
    realProxy=null;
    return getNotRunningJob(application,JobState.FAILED);
  }
  if (application.getYarnApplicationState() == YarnApplicationState.KILLED) {
    realProxy=null;
    return getNotRunningJob(application,JobState.KILLED);
  }
  if (application.getYarnApplicationState() == YarnApplicationState.FINISHED) {
    LOG.info("Application state is completed. FinalApplicationStatus=" + application.getFinalApplicationStatus().toString() + ". Redirecting to job history server");
    realProxy=checkAndGetHSProxy(application,JobState.SUCCEEDED);
  }
  return realProxy;
}
