{
  String id=appId.toString();
  TimelineAggregator aggregatorInTable;
  boolean aggregatorIsNew=false;
synchronized (aggregators) {
    aggregatorInTable=aggregators.get(id);
    if (aggregatorInTable == null) {
      try {
        aggregator.init(getConfig());
        aggregator.start();
        aggregators.put(id,aggregator);
        LOG.info("the aggregator for " + id + " was added");
        aggregatorInTable=aggregator;
        aggregatorIsNew=true;
      }
 catch (      Exception e) {
        throw new YarnRuntimeException(e);
      }
    }
 else {
      String msg="the aggregator for " + id + " already exists!";
      LOG.error(msg);
    }
  }
  if (aggregatorIsNew) {
    try {
      reportNewAggregatorToNM(appId);
    }
 catch (    Exception e) {
      LOG.error("Failed to report a new aggregator for application: " + appId + " to NM Aggregator Services.");
      throw new YarnRuntimeException(e);
    }
  }
  return aggregatorInTable;
}
