{
  MiniDFSCluster cluster=null;
  try {
    Configuration conf=new HdfsConfiguration();
    if (System.getProperty("test.build.data") == null) {
      System.setProperty("test.build.data","build/test/data");
    }
    conf.setInt(DFSConfigKeys.DFS_DATANODE_SCAN_PERIOD_HOURS_KEY,-1);
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(numDataNodes).format(false).startupOption(StartupOption.UPGRADE).clusterId("testClusterId").build();
    cluster.waitActive();
    DistributedFileSystem dfs=(DistributedFileSystem)cluster.getFileSystem();
    DFSClient dfsClient=dfs.dfs;
    while (dfsClient.setSafeMode(FSConstants.SafeModeAction.SAFEMODE_GET)) {
      LOG.info("Waiting for SafeMode to be OFF.");
      try {
        Thread.sleep(1000);
      }
 catch (      InterruptedException ignored) {
      }
    }
    verifyFileSystem(dfs);
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
