{
  Configuration conf=new HdfsConfiguration();
  File namenodeStorage=new File(TEST_ROOT_DIR,"nnimage-0.3.0");
  conf.set(DFSConfigKeys.DFS_NAMENODE_NAME_DIR_KEY,namenodeStorage.toString());
  FileUtil.fullyDelete(namenodeStorage);
  assertTrue("Make " + namenodeStorage,namenodeStorage.mkdirs());
  File imageDir=new File(namenodeStorage,"image");
  assertTrue("Make " + imageDir,imageDir.mkdirs());
  File imageFile=new File(imageDir,"fsimage");
  byte[] imageBytes=StringUtils.hexStringToByte("fffffffee17c0d2700000000");
  FileOutputStream fos=new FileOutputStream(imageFile);
  try {
    fos.write(imageBytes);
  }
  finally {
    fos.close();
  }
  try {
    new MiniDFSCluster.Builder(conf).numDataNodes(0).format(false).manageDataDfsDirs(false).manageNameDfsDirs(false).startupOption(StartupOption.REGULAR).build();
    fail("Was able to start NN from 0.3.0 image");
  }
 catch (  IOException ioe) {
    assertTrue(ioe.toString().contains("Old layout version is 'too old'"));
  }
}
