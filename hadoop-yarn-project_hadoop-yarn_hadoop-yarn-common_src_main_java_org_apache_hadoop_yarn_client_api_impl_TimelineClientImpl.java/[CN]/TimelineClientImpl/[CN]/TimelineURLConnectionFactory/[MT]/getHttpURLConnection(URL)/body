{
  boolean isProxyAccess=UserGroupInformation.getCurrentUser().getAuthenticationMethod() == UserGroupInformation.AuthenticationMethod.PROXY;
  UserGroupInformation callerUGI=isProxyAccess ? UserGroupInformation.getCurrentUser().getRealUser() : UserGroupInformation.getCurrentUser();
  final String doAsUser=isProxyAccess ? UserGroupInformation.getCurrentUser().getShortUserName() : null;
  try {
    return callerUGI.doAs(new PrivilegedExceptionAction<HttpURLConnection>(){
      @Override public HttpURLConnection run() throws Exception {
        return new DelegationTokenAuthenticatedURL(authenticator,connConfigurator).openConnection(url,token,doAsUser);
      }
    }
);
  }
 catch (  UndeclaredThrowableException e) {
    throw new IOException(e.getCause());
  }
catch (  InterruptedException e) {
    throw new IOException(e);
  }
}
