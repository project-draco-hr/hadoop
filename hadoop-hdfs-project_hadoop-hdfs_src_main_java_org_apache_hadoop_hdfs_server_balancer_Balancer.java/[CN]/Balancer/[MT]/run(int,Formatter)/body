{
  try {
    final long bytesLeftToMove=initNodes(nnc.client.getDatanodeReport(DatanodeReportType.LIVE));
    if (bytesLeftToMove == 0) {
      System.out.println("The cluster is balanced. Exiting...");
      return ReturnStatus.SUCCESS;
    }
 else {
      LOG.info("Need to move " + StringUtils.byteDesc(bytesLeftToMove) + " to make the cluster balanced.");
    }
    final long bytesToMove=chooseNodes();
    if (bytesToMove == 0) {
      System.out.println("No block can be moved. Exiting...");
      return ReturnStatus.NO_MOVE_BLOCK;
    }
 else {
      LOG.info("Will move " + StringUtils.byteDesc(bytesToMove) + " in this iteration");
    }
    formatter.format("%-24s %10d  %19s  %18s  %17s\n",DateFormat.getDateTimeInstance().format(new Date()),iteration,StringUtils.byteDesc(bytesMoved.get()),StringUtils.byteDesc(bytesLeftToMove),StringUtils.byteDesc(bytesToMove));
    if (dispatchBlockMoves() > 0) {
      notChangedIterations=0;
    }
 else {
      notChangedIterations++;
      if (notChangedIterations >= 5) {
        System.out.println("No block has been moved for 5 iterations. Exiting...");
        return ReturnStatus.NO_MOVE_PROGRESS;
      }
    }
    resetData();
    return ReturnStatus.IN_PROGRESS;
  }
 catch (  IllegalArgumentException e) {
    System.out.println(e + ".  Exiting ...");
    return ReturnStatus.ILLEGAL_ARGS;
  }
catch (  IOException e) {
    System.out.println(e + ".  Exiting ...");
    return ReturnStatus.IO_EXCEPTION;
  }
catch (  InterruptedException e) {
    System.out.println(e + ".  Exiting ...");
    return ReturnStatus.INTERRUPTED;
  }
 finally {
    dispatcherExecutor.shutdownNow();
    moverExecutor.shutdownNow();
  }
}
