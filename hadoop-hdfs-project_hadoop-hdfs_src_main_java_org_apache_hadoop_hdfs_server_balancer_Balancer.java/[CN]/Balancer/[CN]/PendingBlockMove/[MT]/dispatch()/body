{
  Socket sock=new Socket();
  DataOutputStream out=null;
  DataInputStream in=null;
  try {
    sock.connect(NetUtils.createSocketAddr(target.datanode.getXferAddr()),HdfsServerConstants.READ_TIMEOUT);
    sock.setKeepAlive(true);
    OutputStream unbufOut=sock.getOutputStream();
    InputStream unbufIn=sock.getInputStream();
    if (nnc.getDataEncryptionKey() != null) {
      IOStreamPair encryptedStreams=DataTransferEncryptor.getEncryptedStreams(unbufOut,unbufIn,nnc.getDataEncryptionKey());
      unbufOut=encryptedStreams.out;
      unbufIn=encryptedStreams.in;
    }
    out=new DataOutputStream(new BufferedOutputStream(unbufOut,HdfsConstants.IO_FILE_BUFFER_SIZE));
    in=new DataInputStream(new BufferedInputStream(unbufIn,HdfsConstants.IO_FILE_BUFFER_SIZE));
    sendRequest(out);
    receiveResponse(in);
    bytesMoved.inc(block.getNumBytes());
    LOG.info("Moving block " + block.getBlock().getBlockId() + " from "+ source.getDisplayName()+ " to "+ target.getDisplayName()+ " through "+ proxySource.getDisplayName()+ " is succeeded.");
  }
 catch (  IOException e) {
    LOG.warn("Error moving block " + block.getBlockId() + " from "+ source.getDisplayName()+ " to "+ target.getDisplayName()+ " through "+ proxySource.getDisplayName()+ ": "+ e.getMessage());
  }
 finally {
    IOUtils.closeStream(out);
    IOUtils.closeStream(in);
    IOUtils.closeSocket(sock);
    proxySource.removePendingBlock(this);
    target.removePendingBlock(this);
synchronized (this) {
      reset();
    }
synchronized (Balancer.this) {
      Balancer.this.notifyAll();
    }
  }
}
