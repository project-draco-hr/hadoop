{
  int bits;
  while (true) {
    bits=status.get();
    if ((bits & STATUS_CLOSED_MASK) != 0) {
      return;
    }
    if (status.compareAndSet(bits,bits | STATUS_CLOSED_MASK)) {
      break;
    }
  }
  boolean didShutdown=false;
  boolean interrupted=false;
  while ((bits & (~STATUS_CLOSED_MASK)) > 0) {
    if (!didShutdown) {
      try {
        shutdown0(fd);
      }
 catch (      IOException e) {
        LOG.error("shutdown error: ",e);
      }
      didShutdown=true;
    }
    try {
      Thread.sleep(10);
    }
 catch (    InterruptedException e) {
      interrupted=true;
    }
    bits=status.get();
  }
  close0(fd);
  if (interrupted) {
    Thread.currentThread().interrupt();
  }
}
