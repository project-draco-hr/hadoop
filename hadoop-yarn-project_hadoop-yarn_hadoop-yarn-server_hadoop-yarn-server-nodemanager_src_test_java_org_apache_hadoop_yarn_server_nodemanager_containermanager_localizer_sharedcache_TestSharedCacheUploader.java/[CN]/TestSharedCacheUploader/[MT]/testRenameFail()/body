{
  Configuration conf=new Configuration();
  conf.setBoolean(YarnConfiguration.SHARED_CACHE_ENABLED,true);
  LocalResource resource=mock(LocalResource.class);
  Path localPath=mock(Path.class);
  when(localPath.getName()).thenReturn("foo.jar");
  String user="joe";
  SCMUploaderProtocol scmClient=mock(SCMUploaderProtocol.class);
  SCMUploaderNotifyResponse response=mock(SCMUploaderNotifyResponse.class);
  when(response.getAccepted()).thenReturn(true);
  when(scmClient.notify(isA(SCMUploaderNotifyRequest.class))).thenReturn(response);
  FileSystem fs=mock(FileSystem.class);
  when(fs.rename(isA(Path.class),isA(Path.class))).thenReturn(false);
  FileSystem localFs=FileSystem.getLocal(conf);
  SharedCacheUploader spied=createSpiedUploader(resource,localPath,user,conf,scmClient,fs,localFs);
  doReturn(true).when(spied).verifyAccess();
  doReturn(localPath).when(spied).getActualPath();
  doReturn("abcdef0123456789").when(spied).computeChecksum(isA(Path.class));
  doReturn(true).when(spied).uploadFile(isA(Path.class),isA(Path.class));
  assertFalse(spied.call());
}
