{
  if (MINI_DFS == null) {
    if (System.getProperty("hadoop.log.dir") == null) {
      System.setProperty("hadoop.log.dir",new File(TEST_DIR_ROOT,"hadoop-log").getAbsolutePath());
    }
    if (System.getProperty("test.build.data") == null) {
      System.setProperty("test.build.data",new File(TEST_DIR_ROOT,"hadoop-data").getAbsolutePath());
    }
    conf=new Configuration(conf);
    HadoopUsersConfTestHelper.addUserConf(conf);
    conf.set("fs.hdfs.impl.disable.cache","true");
    conf.set("dfs.block.access.token.enable","false");
    conf.set("dfs.permissions","true");
    conf.set("hadoop.security.authentication","simple");
    conf.setBoolean(DFSConfigKeys.DFS_NAMENODE_ACLS_ENABLED_KEY,true);
    MiniDFSCluster.Builder builder=new MiniDFSCluster.Builder(conf);
    builder.numDataNodes(2);
    MiniDFSCluster miniHdfs=builder.build();
    FileSystem fileSystem=miniHdfs.getFileSystem();
    fileSystem.mkdirs(new Path("/tmp"));
    fileSystem.mkdirs(new Path("/user"));
    fileSystem.setPermission(new Path("/tmp"),FsPermission.valueOf("-rwxrwxrwx"));
    fileSystem.setPermission(new Path("/user"),FsPermission.valueOf("-rwxrwxrwx"));
    MINI_DFS=miniHdfs;
  }
  return MINI_DFS;
}
