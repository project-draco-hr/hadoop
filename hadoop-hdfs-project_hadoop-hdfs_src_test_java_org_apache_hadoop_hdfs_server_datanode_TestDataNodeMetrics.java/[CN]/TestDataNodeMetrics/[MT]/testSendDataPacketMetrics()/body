{
  Configuration conf=new HdfsConfiguration();
  final int interval=1;
  conf.set(DFSConfigKeys.DFS_METRICS_PERCENTILES_INTERVALS_KEY,"" + interval);
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).build();
  try {
    FileSystem fs=cluster.getFileSystem();
    Path tmpfile=new Path("/tmp.txt");
    DFSTestUtil.createFile(fs,tmpfile,(long)1,(short)1,1L);
    DFSTestUtil.readFile(fs,tmpfile);
    List<DataNode> datanodes=cluster.getDataNodes();
    assertEquals(datanodes.size(),1);
    DataNode datanode=datanodes.get(0);
    MetricsRecordBuilder rb=getMetrics(datanode.getMetrics().name());
    assertCounter("SendDataPacketTransferNanosNumOps",(long)2,rb);
    assertCounter("SendDataPacketBlockedOnNetworkNanosNumOps",(long)2,rb);
    Thread.sleep((interval + 1) * 1000);
    String sec=interval + "s";
    assertQuantileGauges("SendDataPacketBlockedOnNetworkNanos" + sec,rb);
    assertQuantileGauges("SendDataPacketTransferNanos" + sec,rb);
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
