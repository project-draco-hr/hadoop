{
  final boolean toAppend=action == FileAction.APPEND;
  Path targetPath=toAppend ? target : getTmpFile(target,context);
  final Configuration configuration=context.getConfiguration();
  FileSystem targetFS=target.getFileSystem(configuration);
  try {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Copying " + sourceFileStatus.getPath() + " to "+ target);
      LOG.debug("Target file path: " + targetPath);
    }
    final Path sourcePath=sourceFileStatus.getPath();
    final FileSystem sourceFS=sourcePath.getFileSystem(configuration);
    final FileChecksum sourceChecksum=fileAttributes.contains(FileAttribute.CHECKSUMTYPE) ? sourceFS.getFileChecksum(sourcePath) : null;
    final long offset=action == FileAction.APPEND ? targetFS.getFileStatus(target).getLen() : 0;
    long bytesRead=copyToFile(targetPath,targetFS,sourceFileStatus,offset,context,fileAttributes,sourceChecksum);
    compareFileLengths(sourceFileStatus,targetPath,configuration,bytesRead + offset);
    if ((bytesRead != 0) && (!skipCrc)) {
      compareCheckSums(sourceFS,sourceFileStatus.getPath(),sourceChecksum,targetFS,targetPath);
    }
    if (!toAppend) {
      promoteTmpToTarget(targetPath,target,targetFS);
    }
    return bytesRead;
  }
  finally {
    if (!toAppend && targetFS.exists(targetPath)) {
      targetFS.delete(targetPath,false);
    }
  }
}
