{
  Path tmpTargetPath=getTmpFile(target,context);
  final Configuration configuration=context.getConfiguration();
  FileSystem targetFS=target.getFileSystem(configuration);
  try {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Copying " + sourceFileStatus.getPath() + " to "+ target);
      LOG.debug("Tmp-file path: " + tmpTargetPath);
    }
    final Path sourcePath=sourceFileStatus.getPath();
    final FileSystem sourceFS=sourcePath.getFileSystem(configuration);
    final FileChecksum sourceChecksum=fileAttributes.contains(FileAttribute.CHECKSUMTYPE) ? sourceFS.getFileChecksum(sourcePath) : null;
    long bytesRead=copyToTmpFile(tmpTargetPath,targetFS,sourceFileStatus,context,fileAttributes,sourceChecksum);
    compareFileLengths(sourceFileStatus,tmpTargetPath,configuration,bytesRead);
    if ((bytesRead != 0) && (!skipCrc)) {
      compareCheckSums(sourceFS,sourceFileStatus.getPath(),sourceChecksum,targetFS,tmpTargetPath);
    }
    promoteTmpToTarget(tmpTargetPath,target,targetFS);
    return bytesRead;
  }
  finally {
    if (targetFS.exists(tmpTargetPath))     targetFS.delete(tmpTargetPath,false);
  }
}
