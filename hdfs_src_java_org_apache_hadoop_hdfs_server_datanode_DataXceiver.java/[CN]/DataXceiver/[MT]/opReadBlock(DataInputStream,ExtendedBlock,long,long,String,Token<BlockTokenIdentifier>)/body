{
  OutputStream baseStream=NetUtils.getOutputStream(s,datanode.socketWriteTimeout);
  DataOutputStream out=new DataOutputStream(new BufferedOutputStream(baseStream,SMALL_BUFFER_SIZE));
  checkAccess(out,true,block,blockToken,Op.READ_BLOCK,BlockTokenSecretManager.AccessMode.READ);
  BlockSender blockSender=null;
  DatanodeRegistration dnR=datanode.getDNRegistrationForBP(block.getBlockPoolId());
  final String clientTraceFmt=clientName.length() > 0 && ClientTraceLog.isInfoEnabled() ? String.format(DN_CLIENTTRACE_FORMAT,localAddress,remoteAddress,"%d","HDFS_READ",clientName,"%d",dnR.getStorageID(),block,"%d") : dnR + " Served block " + block+ " to "+ s.getInetAddress();
  updateCurrentThreadName("Sending block " + block);
  try {
    try {
      blockSender=new BlockSender(block,startOffset,length,true,true,false,datanode,clientTraceFmt);
    }
 catch (    IOException e) {
      sendResponse(s,ERROR,datanode.socketWriteTimeout);
      throw e;
    }
    sendResponse(s,SUCCESS,datanode.socketWriteTimeout);
    long read=blockSender.sendBlock(out,baseStream,null);
    if (blockSender.didSendEntireByteRange()) {
      try {
        ClientReadStatusProto stat=ClientReadStatusProto.parseFrom(HdfsProtoUtil.vintPrefixed(in));
        if (!stat.hasStatus()) {
          LOG.warn("Client " + s.getInetAddress() + " did not send a valid status "+ "code after reading. Will close connection.");
          IOUtils.closeStream(out);
        }
      }
 catch (      IOException ioe) {
        LOG.debug("Error reading client status response. Will close connection.",ioe);
        IOUtils.closeStream(out);
      }
    }
 else {
      IOUtils.closeStream(out);
    }
    datanode.metrics.incrBytesRead((int)read);
    datanode.metrics.incrBlocksRead();
  }
 catch (  SocketException ignored) {
    datanode.metrics.incrBlocksRead();
    IOUtils.closeStream(out);
  }
catch (  IOException ioe) {
    LOG.warn(dnR + ":Got exception while serving " + block+ " to "+ s.getInetAddress()+ ":\n"+ StringUtils.stringifyException(ioe));
    throw ioe;
  }
 finally {
    IOUtils.closeStream(blockSender);
  }
  datanode.metrics.addReadBlockOp(elapsed());
  datanode.metrics.incrReadsFromClient(isLocal);
}
