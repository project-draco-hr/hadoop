{
  LOG.info("Stopping JobHistory");
  if (moveIntermediateToDoneThread != null) {
    LOG.info("Stopping move thread");
    moveIntermediateToDoneRunnable.stop();
    moveIntermediateToDoneThread.interrupt();
    try {
      LOG.info("Joining on move thread");
      moveIntermediateToDoneThread.join();
    }
 catch (    InterruptedException e) {
      LOG.info("Interrupted while stopping move thread");
    }
  }
  if (cleanerScheduledExecutor != null) {
    LOG.info("Stopping History Cleaner");
    cleanerScheduledExecutor.shutdown();
    boolean interrupted=false;
    long currentTime=System.currentTimeMillis();
    while (!cleanerScheduledExecutor.isShutdown() && System.currentTimeMillis() > currentTime + 1000l && !interrupted) {
      try {
        Thread.sleep(20);
      }
 catch (      InterruptedException e) {
        interrupted=true;
      }
    }
    if (!cleanerScheduledExecutor.isShutdown()) {
      LOG.warn("HistoryCleanerService shutdown may not have succeeded");
    }
  }
  if (storage instanceof Service) {
    ((Service)storage).stop();
  }
  hsManager.stop();
  super.stop();
}
