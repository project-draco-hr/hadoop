{
  FSImage fsimage=cluster.getNamesystem().getFSImage();
  FSEditLog editLog=fsimage.getEditLog();
  JournalAndStream jas=editLog.getJournals().get(index);
  EditLogFileOutputStream elos=(EditLogFileOutputStream)jas.getCurrentStream();
  EditLogFileOutputStream spyElos=spy(elos);
  if (failOnWrite) {
    doThrow(new IOException("fail on write()")).when(spyElos).write((FSEditLogOp)any());
  }
  if (failOnFlush) {
    doThrow(new IOException("fail on flush()")).when(spyElos).flush();
  }
 else {
    doThrow(new IOException("fail on setReadyToFlush()")).when(spyElos).setReadyToFlush();
  }
  doNothing().when(spyElos).abort();
  jas.setCurrentStreamForTests(spyElos);
  return elos;
}
