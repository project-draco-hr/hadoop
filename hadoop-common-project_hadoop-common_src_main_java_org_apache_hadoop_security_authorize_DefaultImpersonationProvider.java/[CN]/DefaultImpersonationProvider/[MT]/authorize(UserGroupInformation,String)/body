{
  UserGroupInformation realUser=user.getRealUser();
  if (realUser == null) {
    return;
  }
  AccessControlList acl=proxyUserAcl.get(CONF_HADOOP_PROXYUSER + realUser.getShortUserName());
  if (acl == null || !acl.isUserAllowed(user)) {
    throw new AuthorizationException("User: " + realUser.getUserName() + " is not allowed to impersonate "+ user.getUserName());
  }
  boolean ipAuthorized=false;
  Collection<String> ipList=proxyHosts.get(getProxySuperuserIpConfKey(realUser.getShortUserName()));
  if (isWildcardList(ipList)) {
    ipAuthorized=true;
  }
 else   if (ipList != null && !ipList.isEmpty()) {
    for (    String allowedHost : ipList) {
      InetAddress hostAddr;
      try {
        hostAddr=InetAddress.getByName(allowedHost);
      }
 catch (      UnknownHostException e) {
        continue;
      }
      if (hostAddr.getHostAddress().equals(remoteAddress)) {
        ipAuthorized=true;
      }
    }
  }
  if (!ipAuthorized) {
    throw new AuthorizationException("Unauthorized connection for super-user: " + realUser.getUserName() + " from IP "+ remoteAddress);
  }
}
