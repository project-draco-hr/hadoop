{
  long started=System.currentTimeMillis();
  long mustEnd=System.currentTimeMillis() + (long)(getWaitForRatio() * timeout);
  long lastEcho=0;
  try {
    long waiting=mustEnd - System.currentTimeMillis();
    System.out.println(MessageFormat.format("Waiting up to [{0}] msec",waiting));
    boolean eval;
    while (!(eval=predicate.evaluate()) && System.currentTimeMillis() < mustEnd) {
      if ((System.currentTimeMillis() - lastEcho) > 5000) {
        waiting=mustEnd - System.currentTimeMillis();
        System.out.println(MessageFormat.format("Waiting up to [{0}] msec",waiting));
        lastEcho=System.currentTimeMillis();
      }
      Thread.sleep(100);
    }
    if (!eval) {
      if (failIfTimeout) {
        Assert.fail(MessageFormat.format("Waiting timed out after [{0}] msec",timeout));
      }
 else {
        System.out.println(MessageFormat.format("Waiting timed out after [{0}] msec",timeout));
      }
    }
    return (eval) ? System.currentTimeMillis() - started : -1;
  }
 catch (  Exception ex) {
    throw new RuntimeException(ex);
  }
}
