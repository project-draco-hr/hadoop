{
  Configuration conf=new HdfsConfiguration();
  conf.setInt(DFSConfigKeys.DFS_REPLICATION_KEY,1);
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(1).build();
  try {
    cluster.waitActive();
    FileSystem fs=cluster.getFileSystem();
    FSNamesystem fsn=cluster.getNamesystem();
    final int blockCount=10;
    Path path1=new Path("testBlockIdCollisionDetection_file1.dat");
    DFSTestUtil.createFile(fs,path1,IO_SIZE,BLOCK_SIZE * blockCount,BLOCK_SIZE,REPLICATION,SEED);
    List<LocatedBlock> blocks1=DFSTestUtil.getAllBlocks(fs,path1);
    SequentialBlockIdGenerator blockIdGenerator=fsn.getBlockIdManager().getBlockIdGenerator();
    blockIdGenerator.setCurrentValue(blockIdGenerator.getCurrentValue() - 5);
    Path path2=new Path("testBlockIdCollisionDetection_file2.dat");
    DFSTestUtil.createFile(fs,path2,IO_SIZE,BLOCK_SIZE * blockCount,BLOCK_SIZE,REPLICATION,SEED);
    List<LocatedBlock> blocks2=DFSTestUtil.getAllBlocks(fs,path2);
    assertThat(blocks2.size(),is(blockCount));
    assertThat(blocks2.get(0).getBlock().getBlockId(),is(blocks1.get(9).getBlock().getBlockId() + 1));
  }
  finally {
    cluster.shutdown();
  }
}
