{
  UserGroupInformation ugi=UserGroupInformation.createUserForTesting(fs.getUri().getAuthority(),new String[]{});
  @SuppressWarnings("unchecked") TokenAspect<HftpFileSystem> aspect=(TokenAspect<HftpFileSystem>)Whitebox.getInternalState(fs,"tokenAspect");
  SecurityUtilTestHelper.setTokenServiceUseIp(true);
  Token<?> hdfsToken=new Token<TokenIdentifier>(new byte[0],new byte[0],DelegationTokenIdentifier.HDFS_DELEGATION_KIND,new Text("127.0.0.1:8020"));
  ugi.addToken(hdfsToken);
  Token<?> token=aspect.selectDelegationToken(ugi);
  assertNotNull(token);
  assertEquals(hdfsToken,token);
  Token<?> hftpToken=new Token<TokenIdentifier>(new byte[0],new byte[0],HftpFileSystem.TOKEN_KIND,new Text("127.0.0.1:" + port));
  ugi.addToken(hftpToken);
  token=aspect.selectDelegationToken(ugi);
  assertNotNull(token);
  assertEquals(hftpToken,token);
  SecurityUtilTestHelper.setTokenServiceUseIp(false);
  token=aspect.selectDelegationToken(ugi);
  assertNull(token);
  hdfsToken=new Token<TokenIdentifier>(new byte[0],new byte[0],DelegationTokenIdentifier.HDFS_DELEGATION_KIND,new Text("localhost:8020"));
  ugi.addToken(hdfsToken);
  token=aspect.selectDelegationToken(ugi);
  assertNotNull(token);
  assertEquals(hdfsToken,token);
  hftpToken=new Token<TokenIdentifier>(new byte[0],new byte[0],HftpFileSystem.TOKEN_KIND,new Text("localhost:" + port));
  ugi.addToken(hftpToken);
  token=aspect.selectDelegationToken(ugi);
  assertNotNull(token);
  assertEquals(hftpToken,token);
}
