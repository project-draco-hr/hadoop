{
  Configuration conf=new Configuration();
  MiniDFSCluster cluster=null;
  try {
    conf.set(DFSConfigKeys.DFS_NAMESERVICES,"namesServerId1,namesServerId2");
    cluster=new MiniDFSCluster.Builder(conf).nnTopology(MiniDFSNNTopology.simpleFederatedTopology(conf.get(DFSConfigKeys.DFS_NAMESERVICES))).numDataNodes(2).build();
    cluster.waitActive();
    FileSystem fs1=cluster.getFileSystem(0);
    FileSystem fs2=cluster.getFileSystem(1);
    DFSTestUtil.createFile(fs1,new Path("/alpha"),1024,(short)2,54);
    DFSTestUtil.createFile(fs2,new Path("/beta"),1024,(short)2,54);
    DataNode dn1=cluster.getDataNodes().get(0);
    DataNode dn2=cluster.getDataNodes().get(1);
    String bpid1=cluster.getNamesystem(0).getBlockPoolId();
    String bpid2=cluster.getNamesystem(1).getBlockPoolId();
    File dn1StorageDir1=cluster.getInstanceStorageDir(0,0);
    File dn1StorageDir2=cluster.getInstanceStorageDir(0,1);
    File dn2StorageDir1=cluster.getInstanceStorageDir(1,0);
    File dn2StorageDir2=cluster.getInstanceStorageDir(1,1);
    try {
      dn1.deleteBlockPool(bpid1,true);
      fail("Must not delete a running block pool");
    }
 catch (    IOException expected) {
    }
    Configuration nn1Conf=cluster.getConfiguration(1);
    nn1Conf.set(DFSConfigKeys.DFS_NAMESERVICES,"namesServerId2");
    dn1.refreshNamenodes(nn1Conf);
    assertEquals(1,dn1.getAllBpOs().length);
    try {
      dn1.deleteBlockPool(bpid1,false);
      fail("Must not delete if any block files exist unless " + "force is true");
    }
 catch (    IOException expected) {
    }
    verifyBlockPoolDirectories(true,dn1StorageDir1,bpid1);
    verifyBlockPoolDirectories(true,dn1StorageDir2,bpid1);
    dn1.deleteBlockPool(bpid1,true);
    verifyBlockPoolDirectories(false,dn1StorageDir1,bpid1);
    verifyBlockPoolDirectories(false,dn1StorageDir2,bpid1);
    fs1.delete(new Path("/alpha"),true);
    File finalDir1=MiniDFSCluster.getFinalizedDir(dn2StorageDir1,bpid1);
    File finalDir2=MiniDFSCluster.getFinalizedDir(dn2StorageDir1,bpid2);
    while ((!DatanodeUtil.dirNoFilesRecursive(finalDir1)) || (!DatanodeUtil.dirNoFilesRecursive(finalDir2))) {
      try {
        Thread.sleep(3000);
      }
 catch (      Exception ignored) {
      }
    }
    cluster.shutdownNameNode(0);
    try {
      dn2.deleteBlockPool(bpid1,true);
      fail("Must not delete a running block pool");
    }
 catch (    IOException expected) {
    }
    dn2.refreshNamenodes(nn1Conf);
    assertEquals(1,dn2.getAllBpOs().length);
    verifyBlockPoolDirectories(true,dn2StorageDir1,bpid1);
    verifyBlockPoolDirectories(true,dn2StorageDir2,bpid1);
    dn2.deleteBlockPool(bpid1,false);
    verifyBlockPoolDirectories(false,dn2StorageDir1,bpid1);
    verifyBlockPoolDirectories(false,dn2StorageDir2,bpid1);
    verifyBlockPoolDirectories(true,dn1StorageDir1,bpid2);
    verifyBlockPoolDirectories(true,dn1StorageDir2,bpid2);
    verifyBlockPoolDirectories(true,dn2StorageDir1,bpid2);
    verifyBlockPoolDirectories(true,dn2StorageDir2,bpid2);
    Path gammaFile=new Path("/gamma");
    DFSTestUtil.createFile(fs2,gammaFile,1024,(short)1,55);
    fs2.setReplication(gammaFile,(short)2);
    DFSTestUtil.waitReplication(fs2,gammaFile,(short)2);
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
