{
  LOG.info("Starting test testDecommissionWithNamenodeRestart");
  int numNamenodes=1;
  int numDatanodes=1;
  int replicas=1;
  conf.setLong(DFSConfigKeys.DFS_BLOCKREPORT_INTERVAL_MSEC_KEY,DFSConfigKeys.DFS_BLOCKREPORT_INTERVAL_MSEC_DEFAULT);
  conf.setLong(DFSConfigKeys.DFS_BLOCKREPORT_INITIAL_DELAY_KEY,5);
  startCluster(numNamenodes,numDatanodes,conf);
  Path file1=new Path("testDecommissionWithNamenodeRestart.dat");
  FileSystem fileSys=cluster.getFileSystem();
  writeFile(fileSys,file1,replicas);
  DFSClient client=getDfsClient(cluster.getNameNode(),conf);
  DatanodeInfo[] info=client.datanodeReport(DatanodeReportType.LIVE);
  DatanodeID excludedDatanodeID=info[0];
  String excludedDatanodeName=info[0].getXferAddr();
  writeConfigFile(excludeFile,new ArrayList<String>(Arrays.asList(excludedDatanodeName)));
  cluster.startDataNodes(conf,1,true,null,null,null,null);
  numDatanodes+=1;
  assertEquals("Number of datanodes should be 2 ",2,cluster.getDataNodes().size());
  cluster.restartNameNode();
  DatanodeInfo datanodeInfo=NameNodeAdapter.getDatanode(cluster.getNamesystem(),excludedDatanodeID);
  waitNodeState(datanodeInfo,AdminStates.DECOMMISSIONED);
  assertEquals("All datanodes must be alive",numDatanodes,client.datanodeReport(DatanodeReportType.LIVE).length);
  assertTrue("Checked if block was replicated after decommission.",checkFile(fileSys,file1,replicas,datanodeInfo.getXferAddr(),numDatanodes) == null);
  cleanupFile(fileSys,file1);
  cluster.shutdown();
  startCluster(numNamenodes,numDatanodes,conf);
  cluster.shutdown();
}
