{
  LOG.info("Starting test testDecommissionWithOpenfile");
  startCluster(1,7,conf);
  FileSystem fileSys=cluster.getFileSystem(0);
  FSNamesystem ns=cluster.getNamesystem(0);
  String openFile="/testDecommissionWithOpenfile.dat";
  writeFile(fileSys,new Path(openFile),(short)3);
  FSDataOutputStream fdos=fileSys.append(new Path(openFile));
  LocatedBlocks lbs=NameNodeAdapter.getBlockLocations(cluster.getNameNode(0),openFile,0,fileSize);
  DatanodeInfo[] dnInfos4LastBlock=lbs.getLastLocatedBlock().getLocations();
  DatanodeInfo[] dnInfos4FirstBlock=lbs.get(0).getLocations();
  ArrayList<String> nodes=new ArrayList<String>();
  ArrayList<DatanodeInfo> dnInfos=new ArrayList<DatanodeInfo>();
  for (  DatanodeInfo datanodeInfo : dnInfos4FirstBlock) {
    DatanodeInfo found=datanodeInfo;
    for (    DatanodeInfo dif : dnInfos4LastBlock) {
      if (datanodeInfo.equals(dif)) {
        found=null;
      }
    }
    if (found != null) {
      nodes.add(found.getXferAddr());
      dnInfos.add(found);
    }
  }
  nodes.add(dnInfos4LastBlock[0].getXferAddr());
  dnInfos.add(dnInfos4LastBlock[0]);
  writeConfigFile(excludeFile,nodes);
  refreshNodes(ns,conf);
  for (  DatanodeInfo dn : dnInfos) {
    waitNodeState(dn,AdminStates.DECOMMISSIONED);
  }
  fdos.close();
}
