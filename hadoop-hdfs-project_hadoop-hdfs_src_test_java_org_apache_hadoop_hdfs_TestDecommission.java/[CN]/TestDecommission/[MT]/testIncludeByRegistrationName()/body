{
  Configuration hdfsConf=new Configuration(conf);
  final String registrationName="127.0.0.100";
  final String nonExistentDn="127.0.0.10";
  hdfsConf.set(DFSConfigKeys.DFS_DATANODE_HOST_NAME_KEY,registrationName);
  cluster=new MiniDFSCluster.Builder(hdfsConf).numDataNodes(1).checkDataNodeHostConfig(true).setupHostsFile(true).build();
  cluster.waitActive();
  ArrayList<String> nodes=new ArrayList<String>();
  nodes.add(nonExistentDn);
  writeConfigFile(hostsFile,nodes);
  refreshNodes(cluster.getNamesystem(0),hdfsConf);
  LOG.info("Waiting for DN to be marked as dead.");
  final DFSClient client=getDfsClient(cluster.getNameNode(0),hdfsConf);
  GenericTestUtils.waitFor(new Supplier<Boolean>(){
    @Override public Boolean get(){
      BlockManagerTestUtil.checkHeartbeat(cluster.getNamesystem().getBlockManager());
      try {
        DatanodeInfo info[]=client.datanodeReport(DatanodeReportType.DEAD);
        return info.length == 1;
      }
 catch (      IOException e) {
        LOG.warn("Failed to check dead DNs",e);
        return false;
      }
    }
  }
,500,5000);
  int dnPort=cluster.getDataNodes().get(0).getXferPort();
  nodes=new ArrayList<String>();
  nodes.add(registrationName + ":" + dnPort);
  writeConfigFile(hostsFile,nodes);
  refreshNodes(cluster.getNamesystem(0),hdfsConf);
  cluster.restartDataNode(0);
  cluster.triggerHeartbeats();
  LOG.info("Waiting for DN to come back.");
  GenericTestUtils.waitFor(new Supplier<Boolean>(){
    @Override public Boolean get(){
      BlockManagerTestUtil.checkHeartbeat(cluster.getNamesystem().getBlockManager());
      try {
        DatanodeInfo info[]=client.datanodeReport(DatanodeReportType.LIVE);
        if (info.length == 1) {
          Assert.assertFalse(info[0].isDecommissioned());
          Assert.assertFalse(info[0].isDecommissionInProgress());
          assertEquals(registrationName,info[0].getHostName());
          return true;
        }
      }
 catch (      IOException e) {
        LOG.warn("Failed to check dead DNs",e);
      }
      return false;
    }
  }
,500,5000);
}
