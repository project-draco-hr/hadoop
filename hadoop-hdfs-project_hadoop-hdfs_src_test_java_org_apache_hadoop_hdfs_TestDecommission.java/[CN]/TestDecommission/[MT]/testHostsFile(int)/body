{
  int numDatanodes=1;
  cluster=new MiniDFSCluster.Builder(conf).nnTopology(MiniDFSNNTopology.simpleFederatedTopology(numNameNodes)).numDataNodes(numDatanodes).setupHostsFile(true).build();
  cluster.waitActive();
  ArrayList<String> list=new ArrayList<String>();
  final String badHostname="BOGUSHOST";
  list.add(badHostname);
  writeConfigFile(hostsFile,list);
  for (int j=0; j < numNameNodes; j++) {
    refreshNodes(cluster.getNamesystem(j),conf);
    DFSClient client=getDfsClient(cluster.getNameNode(j),conf);
    DatanodeInfo[] info=client.datanodeReport(DatanodeReportType.LIVE);
    for (int i=0; i < 5 && info.length != 0; i++) {
      LOG.info("Waiting for datanode to be marked dead");
      Thread.sleep(HEARTBEAT_INTERVAL * 1000);
      info=client.datanodeReport(DatanodeReportType.LIVE);
    }
    assertEquals("Number of live nodes should be 0",0,info.length);
    info=client.datanodeReport(DatanodeReportType.DEAD);
    assertEquals("There should be 2 dead nodes",2,info.length);
    DatanodeID id=cluster.getDataNodes().get(0).getDatanodeId();
    assertEquals(id.getHostName(),info[0].getHostName());
    assertEquals(badHostname,info[1].getHostName());
  }
}
