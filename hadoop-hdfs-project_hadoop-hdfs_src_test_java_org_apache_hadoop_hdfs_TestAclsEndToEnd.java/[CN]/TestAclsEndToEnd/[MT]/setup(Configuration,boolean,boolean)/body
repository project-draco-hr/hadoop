{
  if (resetKms) {
    FileSystemTestHelper fsHelper=new FileSystemTestHelper();
    kmsDir=new File(fsHelper.getTestRootDir()).getAbsoluteFile();
    Assert.assertTrue(kmsDir.mkdirs());
  }
  writeConf(kmsDir,conf);
  MiniKMS.Builder miniKMSBuilder=new MiniKMS.Builder();
  miniKMS=miniKMSBuilder.setKmsConfDir(kmsDir).build();
  miniKMS.start();
  conf=new HdfsConfiguration();
  conf.set(ProxyUsers.CONF_HADOOP_PROXYUSER + "." + realUser+ ".users","keyadmin,hdfs,user");
  conf.set(ProxyUsers.CONF_HADOOP_PROXYUSER + "." + realUser+ ".hosts","*");
  conf.set(CommonConfigurationKeysPublic.HADOOP_SECURITY_KEY_PROVIDER_PATH,getKeyProviderURI());
  conf.setBoolean(DFSConfigKeys.DFS_NAMENODE_DELEGATION_TOKEN_ALWAYS_USE_KEY,true);
  MiniDFSCluster.Builder clusterBuilder=new MiniDFSCluster.Builder(conf);
  cluster=clusterBuilder.numDataNodes(1).format(resetDfs).build();
  fs=cluster.getFileSystem();
}
