{
  Configuration conf=new Configuration();
  conf.setInt(ShuffleHandler.SHUFFLE_PORT_CONFIG_KEY,0);
  conf.setBoolean(ShuffleHandler.SHUFFLE_CONNECTION_KEEP_ALIVE_ENABLED,true);
  conf.setInt(ShuffleHandler.SHUFFLE_CONNECTION_KEEP_ALIVE_TIME_OUT,-100);
  HttpURLConnection conn=null;
  MockShuffleHandler2 shuffleHandler=new MockShuffleHandler2();
  try {
    shuffleHandler.init(conf);
    shuffleHandler.start();
    String shuffleBaseURL="http://127.0.0.1:" + shuffleHandler.getConfig().get(ShuffleHandler.SHUFFLE_PORT_CONFIG_KEY);
    URL url=new URL(shuffleBaseURL + "/mapOutput?job=job_12345_1&reduce=1&" + "map=attempt_12345_1_m_1_0");
    conn=(HttpURLConnection)url.openConnection();
    conn.setRequestProperty(ShuffleHeader.HTTP_HEADER_NAME,ShuffleHeader.DEFAULT_HTTP_HEADER_NAME);
    conn.setRequestProperty(ShuffleHeader.HTTP_HEADER_VERSION,ShuffleHeader.DEFAULT_HTTP_HEADER_VERSION);
    conn.connect();
    conn.getInputStream();
    Assert.assertTrue("socket should be set KEEP_ALIVE",shuffleHandler.isSocketKeepAlive());
  }
  finally {
    if (conn != null) {
      conn.disconnect();
    }
    shuffleHandler.stop();
  }
}
