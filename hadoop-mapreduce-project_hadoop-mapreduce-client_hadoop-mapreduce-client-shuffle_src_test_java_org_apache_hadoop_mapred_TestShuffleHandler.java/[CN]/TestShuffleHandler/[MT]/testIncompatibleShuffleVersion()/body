{
  final int failureNum=3;
  Configuration conf=new Configuration();
  conf.setInt(ShuffleHandler.SHUFFLE_PORT_CONFIG_KEY,0);
  ShuffleHandler shuffleHandler=new ShuffleHandler();
  shuffleHandler.init(conf);
  shuffleHandler.start();
  URL url=new URL("http://127.0.0.1:" + shuffleHandler.getConfig().get(ShuffleHandler.SHUFFLE_PORT_CONFIG_KEY) + "/mapOutput?job=job_12345_1&reduce=1&map=attempt_12345_1_m_1_0");
  for (int i=0; i < failureNum; ++i) {
    HttpURLConnection conn=(HttpURLConnection)url.openConnection();
    conn.setRequestProperty(ShuffleHeader.HTTP_HEADER_NAME,i == 0 ? "mapreduce" : "other");
    conn.setRequestProperty(ShuffleHeader.HTTP_HEADER_VERSION,i == 1 ? "1.0.0" : "1.0.1");
    conn.connect();
    Assert.assertEquals(HttpURLConnection.HTTP_BAD_REQUEST,conn.getResponseCode());
  }
  shuffleHandler.stop();
  shuffleHandler.close();
}
