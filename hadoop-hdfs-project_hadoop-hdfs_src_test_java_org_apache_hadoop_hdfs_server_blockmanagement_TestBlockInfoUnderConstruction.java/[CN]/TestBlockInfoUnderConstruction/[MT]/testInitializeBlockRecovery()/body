{
  DatanodeDescriptor dd1=DFSTestUtil.getDatanodeDescriptor("10.10.1.1","default");
  DatanodeDescriptor dd2=DFSTestUtil.getDatanodeDescriptor("10.10.1.2","default");
  DatanodeDescriptor dd3=DFSTestUtil.getDatanodeDescriptor("10.10.1.3","default");
  dd1.isAlive=dd2.isAlive=dd3.isAlive=true;
  BlockInfoUnderConstruction blockInfo=new BlockInfoUnderConstruction(new Block(0,0,GenerationStamp.LAST_RESERVED_STAMP),3,BlockUCState.UNDER_CONSTRUCTION,new DatanodeDescriptor[]{dd1,dd2,dd3});
  long currentTime=System.currentTimeMillis();
  dd1.setLastUpdate(currentTime - 3 * 1000);
  dd2.setLastUpdate(currentTime - 1 * 1000);
  dd3.setLastUpdate(currentTime - 2 * 1000);
  blockInfo.initializeBlockRecovery(1);
  BlockInfoUnderConstruction[] blockInfoRecovery=dd2.getLeaseRecoveryCommand(1);
  assertEquals(blockInfoRecovery[0],blockInfo);
  currentTime=System.currentTimeMillis();
  dd1.setLastUpdate(currentTime - 2 * 1000);
  dd2.setLastUpdate(currentTime - 1 * 1000);
  dd3.setLastUpdate(currentTime - 3 * 1000);
  blockInfo.initializeBlockRecovery(2);
  blockInfoRecovery=dd1.getLeaseRecoveryCommand(1);
  assertEquals(blockInfoRecovery[0],blockInfo);
  currentTime=System.currentTimeMillis();
  dd1.setLastUpdate(currentTime - 2 * 1000);
  dd2.setLastUpdate(currentTime - 1 * 1000);
  dd3.setLastUpdate(currentTime - 3 * 1000);
  currentTime=System.currentTimeMillis();
  blockInfo.initializeBlockRecovery(3);
  blockInfoRecovery=dd3.getLeaseRecoveryCommand(1);
  assertEquals(blockInfoRecovery[0],blockInfo);
  currentTime=System.currentTimeMillis();
  dd1.setLastUpdate(currentTime - 2 * 1000);
  dd2.setLastUpdate(currentTime - 1 * 1000);
  dd3.setLastUpdate(currentTime);
  currentTime=System.currentTimeMillis();
  blockInfo.initializeBlockRecovery(3);
  blockInfoRecovery=dd3.getLeaseRecoveryCommand(1);
  assertEquals(blockInfoRecovery[0],blockInfo);
}
