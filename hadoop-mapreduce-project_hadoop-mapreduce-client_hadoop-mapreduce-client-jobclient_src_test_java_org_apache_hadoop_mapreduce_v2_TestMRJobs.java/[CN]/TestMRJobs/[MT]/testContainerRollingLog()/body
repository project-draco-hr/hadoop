{
  if (!(new File(MiniMRYarnCluster.APPJAR)).exists()) {
    LOG.info("MRAppJar " + MiniMRYarnCluster.APPJAR + " not found. Not running test.");
    return;
  }
  final SleepJob sleepJob=new SleepJob();
  final JobConf sleepConf=new JobConf(mrCluster.getConfig());
  sleepConf.set(MRJobConfig.MAP_LOG_LEVEL,Level.ALL.toString());
  sleepConf.set(MRJobConfig.MR_AM_LOG_LEVEL,Level.ALL.toString());
  sleepConf.setLong(MRJobConfig.TASK_USERLOG_LIMIT,1);
  sleepConf.setInt(MRJobConfig.TASK_LOG_BACKUPS,3);
  sleepConf.setInt(MRJobConfig.MR_AM_LOG_BACKUPS,7);
  sleepJob.setConf(sleepConf);
  final Job job=sleepJob.createJob(1,0,1L,100,0L,0);
  job.setJarByClass(SleepJob.class);
  job.addFileToClassPath(APP_JAR);
  job.waitForCompletion(true);
  final JobId jobId=TypeConverter.toYarn(job.getJobID());
  final ApplicationId appID=jobId.getAppId();
  int pollElapsed=0;
  while (true) {
    Thread.sleep(1000);
    pollElapsed+=1000;
    if (TERMINAL_RM_APP_STATES.contains(mrCluster.getResourceManager().getRMContext().getRMApps().get(appID).getState())) {
      break;
    }
    if (pollElapsed >= 60000) {
      LOG.warn("application did not reach terminal state within 60 seconds");
      break;
    }
  }
  Assert.assertEquals(RMAppState.FINISHED,mrCluster.getResourceManager().getRMContext().getRMApps().get(appID).getState());
  final String appIdStr=appID.toString();
  final String appIdSuffix=appIdStr.substring("application_".length(),appIdStr.length());
  final String containerGlob="container_" + appIdSuffix + "_*_*";
  final String syslogGlob=appIdStr + Path.SEPARATOR + containerGlob+ Path.SEPARATOR+ TaskLog.LogName.SYSLOG;
  int numAppMasters=0;
  int numMapTasks=0;
  for (int i=0; i < NUM_NODE_MGRS; i++) {
    final Configuration nmConf=mrCluster.getNodeManager(i).getConfig();
    for (    String logDir : nmConf.getTrimmedStrings(YarnConfiguration.NM_LOG_DIRS)) {
      final Path absSyslogGlob=new Path(logDir + Path.SEPARATOR + syslogGlob);
      LOG.info("Checking for glob: " + absSyslogGlob);
      final FileStatus[] syslogs=localFs.globStatus(absSyslogGlob);
      for (      FileStatus slog : syslogs) {
        final FileStatus[] sysSiblings=localFs.globStatus(new Path(slog.getPath().getParent(),TaskLog.LogName.SYSLOG + "*"));
        boolean foundAppMaster=false;
        floop:         for (        FileStatus f : sysSiblings) {
          final BufferedReader reader=new BufferedReader(new InputStreamReader(localFs.open(f.getPath())));
          String line;
          try {
            while ((line=reader.readLine()) != null) {
              if (line.contains(MRJobConfig.APPLICATION_MASTER_CLASS)) {
                foundAppMaster=true;
                break floop;
              }
            }
          }
  finally {
            reader.close();
          }
        }
        if (foundAppMaster) {
          numAppMasters++;
        }
 else {
          numMapTasks++;
        }
        Assert.assertSame("Number of sylog* files",foundAppMaster ? sleepConf.getInt(MRJobConfig.MR_AM_LOG_BACKUPS,0) + 1 : sleepConf.getInt(MRJobConfig.TASK_LOG_BACKUPS,0) + 1,sysSiblings.length);
      }
    }
  }
  Assert.assertEquals("No AppMaster log found!",1,numAppMasters);
  if (sleepConf.getBoolean(MRJobConfig.JOB_UBERTASK_ENABLE,false)) {
    Assert.assertEquals("MapTask log with uber found!",0,numMapTasks);
  }
 else {
    Assert.assertEquals("No MapTask log found!",1,numMapTasks);
  }
}
