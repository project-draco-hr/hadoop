{
  JobConf conf=new JobConf();
  FileSystem lfs=FileSystem.getLocal(conf);
  String inputLine="Hi Hello!";
  CompressionEmulationUtil.setCompressionEmulationEnabled(conf,true);
  CompressionEmulationUtil.setInputCompressionEmulationEnabled(conf,true);
  org.apache.hadoop.mapred.FileOutputFormat.setCompressOutput(conf,true);
  org.apache.hadoop.mapred.FileOutputFormat.setOutputCompressorClass(conf,GzipCodec.class);
  Path rootTempDir=new Path(System.getProperty("test.build.data","/tmp")).makeQualified(lfs.getUri(),lfs.getWorkingDirectory());
  Path tempDir=new Path(rootTempDir,"TestFileQueueDecompression");
  lfs.delete(tempDir,true);
  Path compressedFile=new Path(tempDir,"test");
  OutputStream out=CompressionEmulationUtil.getPossiblyCompressedOutputStream(compressedFile,conf);
  BufferedWriter writer=new BufferedWriter(new OutputStreamWriter(out));
  writer.write(inputLine);
  writer.close();
  compressedFile=compressedFile.suffix(".gz");
  long fileSize=lfs.listStatus(compressedFile)[0].getLen();
  CombineFileSplit split=new CombineFileSplit(new Path[]{compressedFile},new long[]{fileSize});
  FileQueue queue=new FileQueue(split,conf);
  byte[] bytes=new byte[inputLine.getBytes().length];
  queue.read(bytes);
  queue.close();
  String readLine=new String(bytes);
  assertEquals("Compression/Decompression error",inputLine,readLine);
}
