{
  final int i=searchSnapshot(DFSUtil.string2Bytes(snapshotName));
  if (i < 0) {
    throw new SnapshotException("Cannot delete snapshot " + snapshotName + " from path "+ snapshotRoot.getFullPathName()+ ": the snapshot does not exist.");
  }
 else {
    final Snapshot snapshot=snapshotsByNames.get(i);
    int prior=Snapshot.findLatestSnapshot(snapshotRoot,snapshot.getId());
    try {
      Quota.Counts counts=snapshotRoot.cleanSubtree(snapshot.getId(),prior,collectedBlocks,removedINodes,true);
      INodeDirectory parent=snapshotRoot.getParent();
      if (parent != null) {
        parent.addSpaceConsumed(-counts.get(Quota.NAMESPACE),-counts.get(Quota.DISKSPACE),true);
      }
    }
 catch (    QuotaExceededException e) {
      INode.LOG.error("BUG: removeSnapshot increases namespace usage.",e);
    }
    snapshotsByNames.remove(i);
    return snapshot;
  }
}
