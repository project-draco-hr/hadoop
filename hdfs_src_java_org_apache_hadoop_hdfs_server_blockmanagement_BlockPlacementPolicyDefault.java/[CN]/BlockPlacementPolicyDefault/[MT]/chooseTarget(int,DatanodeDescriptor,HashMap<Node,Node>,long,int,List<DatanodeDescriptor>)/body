{
  if (numOfReplicas == 0 || clusterMap.getNumOfLeaves() == 0) {
    return writer;
  }
  int totalReplicasExpected=numOfReplicas;
  int numOfResults=results.size();
  boolean newBlock=(numOfResults == 0);
  if (writer == null && !newBlock) {
    writer=results.get(0);
  }
  try {
    if (numOfResults == 0) {
      writer=chooseLocalNode(writer,excludedNodes,blocksize,maxNodesPerRack,results);
      if (--numOfReplicas == 0) {
        return writer;
      }
    }
    if (numOfResults <= 1) {
      chooseRemoteRack(1,results.get(0),excludedNodes,blocksize,maxNodesPerRack,results);
      if (--numOfReplicas == 0) {
        return writer;
      }
    }
    if (numOfResults <= 2) {
      if (clusterMap.isOnSameRack(results.get(0),results.get(1))) {
        chooseRemoteRack(1,results.get(0),excludedNodes,blocksize,maxNodesPerRack,results);
      }
 else       if (newBlock) {
        chooseLocalRack(results.get(1),excludedNodes,blocksize,maxNodesPerRack,results);
      }
 else {
        chooseLocalRack(writer,excludedNodes,blocksize,maxNodesPerRack,results);
      }
      if (--numOfReplicas == 0) {
        return writer;
      }
    }
    chooseRandom(numOfReplicas,NodeBase.ROOT,excludedNodes,blocksize,maxNodesPerRack,results);
  }
 catch (  NotEnoughReplicasException e) {
    FSNamesystem.LOG.warn("Not able to place enough replicas, still in need of " + numOfReplicas + " to reach "+ totalReplicasExpected+ "\n"+ e.getMessage());
  }
  return writer;
}
