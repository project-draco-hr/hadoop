{
  String nsId=DFSUtil.getNamenodeNameServiceId(conf);
  String namenodeId=HAUtil.getNameNodeId(conf,nsId);
  initializeGenericKeys(conf,nsId,namenodeId);
  NNStorage existingStorage=null;
  try {
    FSNamesystem fsns=FSNamesystem.loadFromDisk(conf,FSNamesystem.getNamespaceDirs(conf),FSNamesystem.getNamespaceEditsDirs(conf,false));
    existingStorage=fsns.getFSImage().getStorage();
    Collection<URI> sharedEditsDirs=FSNamesystem.getSharedEditsDirs(conf);
    if (!confirmFormat(sharedEditsDirs,force,interactive)) {
      return true;
    }
    NNStorage newSharedStorage=new NNStorage(conf,Lists.<URI>newArrayList(),sharedEditsDirs);
    newSharedStorage.format(new NamespaceInfo(existingStorage.getNamespaceID(),existingStorage.getClusterID(),existingStorage.getBlockPoolID(),existingStorage.getCTime(),existingStorage.getDistributedUpgradeVersion()));
    fsns.getFSImage().getEditLog().close();
    fsns.getFSImage().getEditLog().initJournalsForWrite();
    fsns.getFSImage().getEditLog().recoverUnclosedStreams();
    if (copyEditLogSegmentsToSharedDir(fsns,sharedEditsDirs,newSharedStorage,conf)) {
      return true;
    }
  }
 catch (  IOException ioe) {
    LOG.error("Could not initialize shared edits dir",ioe);
    return true;
  }
 finally {
    if (existingStorage != null) {
      try {
        existingStorage.unlockAll();
      }
 catch (      IOException ioe) {
        LOG.warn("Could not unlock storage directories",ioe);
        return true;
      }
    }
  }
  return false;
}
