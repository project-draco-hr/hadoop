{
  JobConf jConf=new JobConf();
  FileSystem fs=FileSystem.getLocal(jConf);
  Path rootDir=new Path(System.getProperty("test.build.data","/tmp"),"testSetupWorkDirSymlinkFailure");
  Path myTargetDir=new Path(rootDir,"./tmp");
  createEmptyDir(fs,myTargetDir);
  createFile(fs,myTargetDir,"cacheFile.txt");
  TrackerDistributedCacheManager.setLocalFiles(jConf,(myTargetDir.toString() + Path.SEPARATOR + "cacheFile.txt"));
  assertTrue("Did not create cache file in " + myTargetDir,(fs.listStatus(myTargetDir).length == 1));
  jConf.set(MRJobConfig.CACHE_SYMLINK,"yes");
  Path myWorkDir=new Path(rootDir,"./work");
  createEmptyDir(fs,myWorkDir);
  DistributedCache.addCacheFile(new URI(myWorkDir.toString() + Path.SEPARATOR + "file.txt#valid"),jConf);
  TaskRunner.setupWorkDir(jConf,new File(myWorkDir.toUri().getPath()));
  assertTrue(myWorkDir + " does not have cache symlink.",fs.exists(myWorkDir) && (fs.listStatus(myWorkDir).length == 2));
  boolean foundValid=false;
  for (  FileStatus fstat : fs.listStatus(myWorkDir)) {
    if (fstat.getPath().toUri() != null && fstat.getPath().toUri().getPath().toString().equals(myWorkDir.toString() + Path.SEPARATOR + "valid")) {
      foundValid=true;
    }
  }
  assertTrue("Valid symlink not created",foundValid);
  fs.delete(rootDir,true);
}
