{
  String message=key.toString();
  IntermediateForm form=null;
  while (values.hasNext()) {
    IntermediateForm singleDocForm=values.next();
    long formSize=form == null ? 0 : form.totalSizeInBytes();
    long singleDocFormSize=singleDocForm.totalSizeInBytes();
    if (form != null && formSize + singleDocFormSize > maxSizeInBytes) {
      closeForm(form,message);
      output.collect(key,form);
      form=null;
    }
    if (form == null && singleDocFormSize >= nearMaxSizeInBytes) {
      output.collect(key,singleDocForm);
    }
 else {
      if (form == null) {
        form=createForm(message);
      }
      form.process(singleDocForm);
    }
  }
  if (form != null) {
    closeForm(form,message);
    output.collect(key,form);
  }
}
