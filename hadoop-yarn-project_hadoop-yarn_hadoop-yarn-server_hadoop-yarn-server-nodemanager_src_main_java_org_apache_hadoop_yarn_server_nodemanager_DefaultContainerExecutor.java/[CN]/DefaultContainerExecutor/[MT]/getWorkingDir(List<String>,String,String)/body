{
  Path appStorageDir=null;
  long totalAvailable=0L;
  long[] availableOnDisk=new long[localDirs.size()];
  int i=0;
  for (  String localDir : localDirs) {
    Path curBase=getApplicationDir(new Path(localDir),user,appId);
    long space=0L;
    try {
      space=getDiskFreeSpace(curBase);
    }
 catch (    IOException e) {
      LOG.warn("Unable to get Free Space for " + curBase.toString(),e);
    }
    availableOnDisk[i++]=space;
    totalAvailable+=space;
  }
  if (totalAvailable <= 0L) {
    throw new IOException("Not able to find a working directory for " + user);
  }
  Random r=new Random();
  long randomPosition=Math.abs(r.nextLong()) % totalAvailable;
  int dir=0;
  while (availableOnDisk[dir] == 0L) {
    dir++;
  }
  while (randomPosition > availableOnDisk[dir]) {
    randomPosition-=availableOnDisk[dir++];
  }
  appStorageDir=getApplicationDir(new Path(localDirs.get(dir)),user,appId);
  return appStorageDir;
}
