{
  boolean success=false;
  Socket sock=null;
  try {
    sock=socketFactory.createSocket();
    String dnAddr=dn.getXferAddr(connectToDnViaHostname);
    if (LOG.isDebugEnabled()) {
      LOG.debug("Connecting to datanode " + dnAddr);
    }
    NetUtils.connect(sock,NetUtils.createSocketAddr(dnAddr),timeout);
    sock.setSoTimeout(timeout);
    OutputStream unbufOut=NetUtils.getOutputStream(sock);
    InputStream unbufIn=NetUtils.getInputStream(sock);
    IOStreamPair ret;
    if (encryptionKey != null) {
      ret=DataTransferEncryptor.getEncryptedStreams(unbufOut,unbufIn,encryptionKey);
    }
 else {
      ret=new IOStreamPair(unbufIn,unbufOut);
    }
    success=true;
    return ret;
  }
  finally {
    if (!success) {
      IOUtils.closeSocket(sock);
    }
  }
}
