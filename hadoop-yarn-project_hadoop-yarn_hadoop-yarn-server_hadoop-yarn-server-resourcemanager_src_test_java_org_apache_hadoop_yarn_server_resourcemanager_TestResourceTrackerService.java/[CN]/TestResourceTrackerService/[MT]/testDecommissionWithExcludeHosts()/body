{
  Configuration conf=new Configuration();
  conf.set(YarnConfiguration.RM_NODES_EXCLUDE_FILE_PATH,hostFile.getAbsolutePath());
  writeToHostsFile("");
  final DrainDispatcher dispatcher=new DrainDispatcher();
  rm=new MockRM(conf){
    @Override protected Dispatcher createDispatcher(){
      return dispatcher;
    }
  }
;
  rm.start();
  MockNM nm1=rm.registerNode("host1:1234",5120);
  MockNM nm2=rm.registerNode("host2:5678",10240);
  MockNM nm3=rm.registerNode("localhost:4433",1024);
  dispatcher.await();
  int metricCount=ClusterMetrics.getMetrics().getNumDecommisionedNMs();
  NodeHeartbeatResponse nodeHeartbeat=nm1.nodeHeartbeat(true);
  Assert.assertTrue(NodeAction.NORMAL.equals(nodeHeartbeat.getNodeAction()));
  nodeHeartbeat=nm2.nodeHeartbeat(true);
  Assert.assertTrue(NodeAction.NORMAL.equals(nodeHeartbeat.getNodeAction()));
  dispatcher.await();
  String ip=NetUtils.normalizeHostName("localhost");
  writeToHostsFile("host2",ip);
  rm.getNodesListManager().refreshNodes(conf);
  checkDecommissionedNMCount(rm,metricCount + 2);
  nodeHeartbeat=nm1.nodeHeartbeat(true);
  Assert.assertTrue(NodeAction.NORMAL.equals(nodeHeartbeat.getNodeAction()));
  nodeHeartbeat=nm2.nodeHeartbeat(true);
  Assert.assertTrue("The decommisioned metrics are not updated",NodeAction.SHUTDOWN.equals(nodeHeartbeat.getNodeAction()));
  nodeHeartbeat=nm3.nodeHeartbeat(true);
  Assert.assertTrue("The decommisioned metrics are not updated",NodeAction.SHUTDOWN.equals(nodeHeartbeat.getNodeAction()));
  dispatcher.await();
  writeToHostsFile("");
  rm.getNodesListManager().refreshNodes(conf);
  nm3=rm.registerNode("localhost:4433",1024);
  dispatcher.await();
  nodeHeartbeat=nm3.nodeHeartbeat(true);
  dispatcher.await();
  Assert.assertTrue(NodeAction.NORMAL.equals(nodeHeartbeat.getNodeAction()));
  checkDecommissionedNMCount(rm,metricCount + 1);
}
