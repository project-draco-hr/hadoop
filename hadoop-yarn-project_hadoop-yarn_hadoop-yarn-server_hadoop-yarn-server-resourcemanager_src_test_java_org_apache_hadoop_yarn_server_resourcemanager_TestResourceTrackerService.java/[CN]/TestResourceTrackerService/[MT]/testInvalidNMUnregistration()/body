{
  Configuration conf=new Configuration();
  rm=new MockRM(conf);
  rm.start();
  ResourceTrackerService resourceTrackerService=rm.getResourceTrackerService();
  int decommisionedNMsCount=ClusterMetrics.getMetrics().getNumDecommisionedNMs();
  UnRegisterNodeManagerRequest request=Records.newRecord(UnRegisterNodeManagerRequest.class);
  request.setNodeId(BuilderUtils.newNodeId("host",1234));
  resourceTrackerService.unRegisterNodeManager(request);
  checkShutdownNMCount(rm,0);
  checkDecommissionedNMCount(rm,0);
  MockNM nm1=new MockNM("host1:1234",5120,resourceTrackerService);
  RegisterNodeManagerResponse response=nm1.registerNode();
  Assert.assertEquals(NodeAction.NORMAL,response.getNodeAction());
  int shutdownNMsCount=ClusterMetrics.getMetrics().getNumShutdownNMs();
  writeToHostsFile("host2");
  conf.set(YarnConfiguration.RM_NODES_INCLUDE_FILE_PATH,hostFile.getAbsolutePath());
  rm.getNodesListManager().refreshNodes(conf);
  NodeHeartbeatResponse heartbeatResponse=nm1.nodeHeartbeat(true);
  Assert.assertEquals(NodeAction.SHUTDOWN,heartbeatResponse.getNodeAction());
  checkDecommissionedNMCount(rm,decommisionedNMsCount);
  request.setNodeId(nm1.getNodeId());
  resourceTrackerService.unRegisterNodeManager(request);
  checkShutdownNMCount(rm,++shutdownNMsCount);
  checkDecommissionedNMCount(rm,decommisionedNMsCount);
  MockNM nm2=new MockNM("host2:1234",5120,resourceTrackerService);
  RegisterNodeManagerResponse response2=nm2.registerNode();
  Assert.assertEquals(NodeAction.NORMAL,response2.getNodeAction());
  writeToHostsFile("host1");
  conf.set(YarnConfiguration.RM_NODES_INCLUDE_FILE_PATH,hostFile.getAbsolutePath());
  rm.getNodesListManager().refreshNodes(conf);
  request.setNodeId(nm2.getNodeId());
  resourceTrackerService.unRegisterNodeManager(request);
  checkShutdownNMCount(rm,++shutdownNMsCount);
  checkDecommissionedNMCount(rm,decommisionedNMsCount);
  rm.stop();
}
