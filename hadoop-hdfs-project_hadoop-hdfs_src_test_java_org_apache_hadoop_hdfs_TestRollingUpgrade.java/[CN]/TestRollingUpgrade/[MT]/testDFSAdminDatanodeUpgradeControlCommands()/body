{
  final Configuration conf=new HdfsConfiguration();
  MiniDFSCluster cluster=null;
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(1).build();
    cluster.waitActive();
    final DFSAdmin dfsadmin=new DFSAdmin(conf);
    DataNode dn=cluster.getDataNodes().get(0);
    final String dnAddr=dn.getDatanodeId().getIpcAddr(false);
    final String[] args1={"-getDatanodeInfo",dnAddr};
    Assert.assertEquals(0,dfsadmin.run(args1));
    final String[] args2={"-shutdownDatanode",dnAddr,"upgrade"};
    Assert.assertEquals(0,dfsadmin.run(args2));
    Thread.sleep(2000);
    Assert.assertFalse("DataNode should exit",dn.isDatanodeUp());
    Assert.assertEquals(-1,dfsadmin.run(args1));
  }
  finally {
    if (cluster != null)     cluster.shutdown();
  }
}
