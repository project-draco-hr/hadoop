{
  final Configuration conf=new Configuration();
  MiniQJMHACluster cluster=null;
  try {
    cluster=new MiniQJMHACluster.Builder(conf).setNumNameNodes(nnCount).build();
    MiniDFSCluster dfsCluster=cluster.getDfsCluster();
    dfsCluster.waitActive();
    dfsCluster.transitionToActive(0);
    DistributedFileSystem dfs=dfsCluster.getFileSystem(0);
    for (int i=1; i < nnCount; i++) {
      dfsCluster.shutdownNameNode(i);
    }
    RollingUpgradeInfo info=dfs.rollingUpgrade(RollingUpgradeAction.PREPARE);
    Assert.assertTrue(info.isStarted());
    info=dfs.rollingUpgrade(RollingUpgradeAction.QUERY);
    Assert.assertFalse(info.createdRollbackImages());
    for (int i=1; i < nnCount; i++) {
      dfsCluster.restartNameNode(i);
    }
    queryForPreparation(dfs);
    Assert.assertTrue(dfsCluster.getNamesystem(0).getFSImage().hasRollbackFSImage());
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
