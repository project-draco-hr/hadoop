{
  String nnDirPrefix=MiniDFSCluster.getBaseDirectory() + "/nn/";
  final File nn1Dir=new File(nnDirPrefix + "image1");
  final File nn2Dir=new File(nnDirPrefix + "image2");
  LOG.info("nn1Dir=" + nn1Dir);
  LOG.info("nn2Dir=" + nn2Dir);
  final Configuration conf=new HdfsConfiguration();
  final MiniJournalCluster mjc=new MiniJournalCluster.Builder(conf).build();
  setConf(conf,nn1Dir,mjc);
{
    final MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(0).manageNameDfsDirs(false).checkExitOnShutdown(false).build();
    cluster.shutdown();
  }
  MiniDFSCluster cluster2=null;
  try {
    FileUtil.fullyDelete(nn2Dir);
    FileUtil.copy(nn1Dir,FileSystem.getLocal(conf).getRaw(),new Path(nn2Dir.getAbsolutePath()),false,conf);
    final MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(0).format(false).manageNameDfsDirs(false).checkExitOnShutdown(false).build();
    final Path foo=new Path("/foo");
    final Path bar=new Path("/bar");
    final Path baz=new Path("/baz");
    final RollingUpgradeInfo info1;
{
      final DistributedFileSystem dfs=cluster.getFileSystem();
      dfs.mkdirs(foo);
      info1=dfs.rollingUpgrade(RollingUpgradeAction.START);
      LOG.info("START\n" + info1);
      Assert.assertEquals(info1,dfs.rollingUpgrade(RollingUpgradeAction.QUERY));
      dfs.mkdirs(bar);
      try {
        dfs.saveNamespace();
        Assert.fail();
      }
 catch (      RemoteException re) {
        Assert.assertEquals(RollingUpgradeException.class.getName(),re.getClassName());
        LOG.info("The exception is expected.",re);
      }
      try {
        NameNodeAdapter.startCheckpoint(cluster.getNameNode(),null,null);
        Assert.fail();
      }
 catch (      RollingUpgradeException re) {
        LOG.info("The exception is expected.",re);
      }
    }
    final Configuration conf2=setConf(new Configuration(),nn2Dir,mjc);
    StartupOption.ROLLINGUPGRADE.setRollingUpgradeStartupOption("started");
    cluster2=new MiniDFSCluster.Builder(conf2).numDataNodes(0).format(false).manageNameDfsDirs(false).startupOption(StartupOption.ROLLINGUPGRADE).build();
    final DistributedFileSystem dfs2=cluster2.getFileSystem();
    Assert.assertTrue(dfs2.exists(foo));
    Assert.assertTrue(dfs2.exists(bar));
    Assert.assertFalse(dfs2.exists(baz));
    Assert.assertEquals(info1,dfs2.rollingUpgrade(RollingUpgradeAction.QUERY));
    dfs2.mkdirs(baz);
    LOG.info("RESTART cluster 2 with -rollingupgrade started");
    cluster2.restartNameNode();
    Assert.assertEquals(info1,dfs2.rollingUpgrade(RollingUpgradeAction.QUERY));
    Assert.assertTrue(dfs2.exists(foo));
    Assert.assertTrue(dfs2.exists(bar));
    Assert.assertTrue(dfs2.exists(baz));
    LOG.info("RESTART cluster 2 with -rollingupgrade started again");
    cluster2.restartNameNode();
    Assert.assertEquals(info1,dfs2.rollingUpgrade(RollingUpgradeAction.QUERY));
    Assert.assertTrue(dfs2.exists(foo));
    Assert.assertTrue(dfs2.exists(bar));
    Assert.assertTrue(dfs2.exists(baz));
    final RollingUpgradeInfo finalize=dfs2.rollingUpgrade(RollingUpgradeAction.FINALIZE);
    LOG.info("FINALIZE: " + finalize);
    Assert.assertEquals(info1.getStartTime(),finalize.getStartTime());
    LOG.info("RESTART cluster 2 with regular startup option");
    cluster2.getNameNodeInfos()[0].setStartOpt(StartupOption.REGULAR);
    cluster2.restartNameNode();
    Assert.assertTrue(dfs2.exists(foo));
    Assert.assertTrue(dfs2.exists(bar));
    Assert.assertTrue(dfs2.exists(baz));
  }
  finally {
    if (cluster2 != null)     cluster2.shutdown();
  }
}
