{
  final Configuration conf=new Configuration();
  conf.setInt(DFSConfigKeys.DFS_HA_TAILEDITS_PERIOD_KEY,1);
  conf.setInt(DFSConfigKeys.DFS_NAMENODE_CHECKPOINT_PERIOD_KEY,1);
  MiniQJMHACluster cluster=null;
  final Path foo=new Path("/foo");
  try {
    cluster=new MiniQJMHACluster.Builder(conf).build();
    MiniDFSCluster dfsCluster=cluster.getDfsCluster();
    dfsCluster.waitActive();
    dfsCluster.transitionToActive(0);
    DistributedFileSystem dfs=dfsCluster.getFileSystem(0);
    RollingUpgradeInfo info=dfs.rollingUpgrade(RollingUpgradeAction.PREPARE);
    Assert.assertTrue(info.isStarted());
    queryForPreparation(dfs);
    dfs.mkdirs(foo);
    long txid=dfs.rollEdits();
    Assert.assertTrue(txid > 0);
    int retries=0;
    while (++retries < 5) {
      NNStorage storage=dfsCluster.getNamesystem(1).getFSImage().getStorage();
      if (storage.getFsImageName(txid - 1) != null) {
        return;
      }
      Thread.sleep(1000);
    }
    Assert.fail("new checkpoint does not exist");
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
