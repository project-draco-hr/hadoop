{
  final Configuration conf=new HdfsConfiguration();
  MiniDFSCluster cluster=null;
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(1).build();
    cluster.waitActive();
    final Path foo=new Path("/foo");
    final Path bar=new Path("/bar");
    cluster.getFileSystem().mkdirs(foo);
    final Path file=new Path(foo,"file");
    final byte[] data=new byte[1024];
    ThreadLocalRandom.current().nextBytes(data);
    final FSDataOutputStream out=cluster.getFileSystem().create(file);
    out.write(data,0,data.length);
    out.close();
    startRollingUpgrade(foo,bar,file,data,cluster);
    cluster.getFileSystem().rollEdits();
    cluster.getFileSystem().rollEdits();
    rollbackRollingUpgrade(foo,bar,file,data,cluster);
    startRollingUpgrade(foo,bar,file,data,cluster);
    cluster.getFileSystem().rollEdits();
    cluster.getFileSystem().rollEdits();
    rollbackRollingUpgrade(foo,bar,file,data,cluster);
    startRollingUpgrade(foo,bar,file,data,cluster);
    cluster.restartNameNode();
    rollbackRollingUpgrade(foo,bar,file,data,cluster);
    startRollingUpgrade(foo,bar,file,data,cluster);
    cluster.restartNameNode();
    rollbackRollingUpgrade(foo,bar,file,data,cluster);
    startRollingUpgrade(foo,bar,file,data,cluster);
    rollbackRollingUpgrade(foo,bar,file,data,cluster);
    startRollingUpgrade(foo,bar,file,data,cluster);
    rollbackRollingUpgrade(foo,bar,file,data,cluster);
  }
  finally {
    if (cluster != null)     cluster.shutdown();
  }
}
