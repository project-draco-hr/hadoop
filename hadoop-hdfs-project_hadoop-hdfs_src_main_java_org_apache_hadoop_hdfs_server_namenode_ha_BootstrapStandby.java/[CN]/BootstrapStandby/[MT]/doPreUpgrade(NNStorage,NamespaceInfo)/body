{
  boolean isFormatted=false;
  Map<StorageDirectory,StorageState> dataDirStates=new HashMap<>();
  try {
    isFormatted=FSImage.recoverStorageDirs(StartupOption.UPGRADE,storage,dataDirStates);
    if (dataDirStates.values().contains(StorageState.NOT_FORMATTED)) {
      isFormatted=false;
      System.err.println("The original storage directory is not formatted.");
    }
  }
 catch (  InconsistentFSStateException e) {
    LOG.warn("The storage directory is in an inconsistent state",e);
  }
 finally {
    storage.unlockAll();
  }
  if (!isFormatted && !format(storage,nsInfo)) {
    return false;
  }
  FSImage.checkUpgrade(storage);
  for (Iterator<StorageDirectory> it=storage.dirIterator(false); it.hasNext(); ) {
    StorageDirectory sd=it.next();
    try {
      NNUpgradeUtil.renameCurToTmp(sd);
    }
 catch (    IOException e) {
      LOG.error("Failed to move aside pre-upgrade storage " + "in image directory " + sd.getRoot(),e);
      throw e;
    }
  }
  storage.setStorageInfo(nsInfo);
  storage.setBlockPoolID(nsInfo.getBlockPoolID());
  return true;
}
