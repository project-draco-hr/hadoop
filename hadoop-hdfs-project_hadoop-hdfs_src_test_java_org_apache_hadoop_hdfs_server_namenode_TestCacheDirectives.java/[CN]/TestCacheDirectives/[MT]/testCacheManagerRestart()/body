{
  SecondaryNameNode secondary=null;
  try {
    conf.set(DFSConfigKeys.DFS_NAMENODE_SECONDARY_HTTP_ADDRESS_KEY,"0.0.0.0:0");
    secondary=new SecondaryNameNode(conf);
    final String pool="poolparty";
    String groupName="partygroup";
    FsPermission mode=new FsPermission((short)0777);
    long limit=747;
    dfs.addCachePool(new CachePoolInfo(pool).setGroupName(groupName).setMode(mode).setLimit(limit));
    RemoteIterator<CachePoolEntry> pit=dfs.listCachePools();
    assertTrue("No cache pools found",pit.hasNext());
    CachePoolInfo info=pit.next().getInfo();
    assertEquals(pool,info.getPoolName());
    assertEquals(groupName,info.getGroupName());
    assertEquals(mode,info.getMode());
    assertEquals(limit,(long)info.getLimit());
    assertFalse("Unexpected # of cache pools found",pit.hasNext());
    int numEntries=10;
    String entryPrefix="/party-";
    long prevId=-1;
    final Date expiry=new Date();
    for (int i=0; i < numEntries; i++) {
      prevId=dfs.addCacheDirective(new CacheDirectiveInfo.Builder().setPath(new Path(entryPrefix + i)).setPool(pool).setExpiration(CacheDirectiveInfo.Expiration.newAbsolute(expiry.getTime())).build());
    }
    RemoteIterator<CacheDirectiveEntry> dit=dfs.listCacheDirectives(null);
    for (int i=0; i < numEntries; i++) {
      assertTrue("Unexpected # of cache entries: " + i,dit.hasNext());
      CacheDirectiveInfo cd=dit.next().getInfo();
      assertEquals(i + 1,cd.getId().longValue());
      assertEquals(entryPrefix + i,cd.getPath().toUri().getPath());
      assertEquals(pool,cd.getPool());
    }
    assertFalse("Unexpected # of cache directives found",dit.hasNext());
    secondary.doCheckpoint();
    final String imagePool="imagePool";
    dfs.addCachePool(new CachePoolInfo(imagePool));
    prevId=dfs.addCacheDirective(new CacheDirectiveInfo.Builder().setPath(new Path("/image")).setPool(imagePool).build());
    dfs.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
    dfs.saveNamespace();
    dfs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
    boolean fetchImage=secondary.doCheckpoint();
    assertTrue("Secondary should have fetched a new fsimage from NameNode",fetchImage);
    dfs.removeCachePool(imagePool);
    cluster.restartNameNode();
    pit=dfs.listCachePools();
    assertTrue("No cache pools found",pit.hasNext());
    info=pit.next().getInfo();
    assertEquals(pool,info.getPoolName());
    assertEquals(pool,info.getPoolName());
    assertEquals(groupName,info.getGroupName());
    assertEquals(mode,info.getMode());
    assertEquals(limit,(long)info.getLimit());
    assertFalse("Unexpected # of cache pools found",pit.hasNext());
    dit=dfs.listCacheDirectives(null);
    for (int i=0; i < numEntries; i++) {
      assertTrue("Unexpected # of cache entries: " + i,dit.hasNext());
      CacheDirectiveInfo cd=dit.next().getInfo();
      assertEquals(i + 1,cd.getId().longValue());
      assertEquals(entryPrefix + i,cd.getPath().toUri().getPath());
      assertEquals(pool,cd.getPool());
      assertEquals(expiry.getTime(),cd.getExpiration().getMillis());
    }
    assertFalse("Unexpected # of cache directives found",dit.hasNext());
    long nextId=dfs.addCacheDirective(new CacheDirectiveInfo.Builder().setPath(new Path("/foobar")).setPool(pool).build());
    assertEquals(prevId + 1,nextId);
  }
  finally {
    if (secondary != null) {
      secondary.shutdown();
    }
  }
}
