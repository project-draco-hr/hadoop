{
  boolean requireClientCert=conf.getBoolean(SSLFactory.SSL_REQUIRE_CLIENT_CERT_KEY,SSLFactory.DEFAULT_SSL_REQUIRE_CLIENT_CERT);
  String keystoreType=conf.get(resolvePropertyName(mode,SSL_KEYSTORE_TYPE_TPL_KEY),DEFAULT_KEYSTORE_TYPE);
  KeyStore keystore=KeyStore.getInstance(keystoreType);
  String keystoreKeyPassword=null;
  if (requireClientCert || mode == SSLFactory.Mode.SERVER) {
    String locationProperty=resolvePropertyName(mode,SSL_KEYSTORE_LOCATION_TPL_KEY);
    String keystoreLocation=conf.get(locationProperty,"");
    if (keystoreLocation.isEmpty()) {
      throw new GeneralSecurityException("The property '" + locationProperty + "' has not been set in the ssl configuration file.");
    }
    String passwordProperty=resolvePropertyName(mode,SSL_KEYSTORE_PASSWORD_TPL_KEY);
    String keystorePassword=getPassword(conf,passwordProperty,"");
    if (keystorePassword.isEmpty()) {
      throw new GeneralSecurityException("The property '" + passwordProperty + "' has not been set in the ssl configuration file.");
    }
    String keyPasswordProperty=resolvePropertyName(mode,SSL_KEYSTORE_KEYPASSWORD_TPL_KEY);
    keystoreKeyPassword=getPassword(conf,keyPasswordProperty,keystorePassword);
    if (LOG.isDebugEnabled()) {
      LOG.debug(mode.toString() + " KeyStore: " + keystoreLocation);
    }
    InputStream is=new FileInputStream(keystoreLocation);
    try {
      keystore.load(is,keystorePassword.toCharArray());
    }
  finally {
      is.close();
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug(mode.toString() + " Loaded KeyStore: " + keystoreLocation);
    }
  }
 else {
    keystore.load(null,null);
  }
  KeyManagerFactory keyMgrFactory=KeyManagerFactory.getInstance(SSLFactory.SSLCERTIFICATE);
  keyMgrFactory.init(keystore,(keystoreKeyPassword != null) ? keystoreKeyPassword.toCharArray() : null);
  keyManagers=keyMgrFactory.getKeyManagers();
  String truststoreType=conf.get(resolvePropertyName(mode,SSL_TRUSTSTORE_TYPE_TPL_KEY),DEFAULT_KEYSTORE_TYPE);
  String locationProperty=resolvePropertyName(mode,SSL_TRUSTSTORE_LOCATION_TPL_KEY);
  String truststoreLocation=conf.get(locationProperty,"");
  if (!truststoreLocation.isEmpty()) {
    String passwordProperty=resolvePropertyName(mode,SSL_TRUSTSTORE_PASSWORD_TPL_KEY);
    String truststorePassword=getPassword(conf,passwordProperty,"");
    if (truststorePassword.isEmpty()) {
      throw new GeneralSecurityException("The property '" + passwordProperty + "' has not been set in the ssl configuration file.");
    }
    long truststoreReloadInterval=conf.getLong(resolvePropertyName(mode,SSL_TRUSTSTORE_RELOAD_INTERVAL_TPL_KEY),DEFAULT_SSL_TRUSTSTORE_RELOAD_INTERVAL);
    if (LOG.isDebugEnabled()) {
      LOG.debug(mode.toString() + " TrustStore: " + truststoreLocation);
    }
    trustManager=new ReloadingX509TrustManager(truststoreType,truststoreLocation,truststorePassword,truststoreReloadInterval);
    trustManager.init();
    if (LOG.isDebugEnabled()) {
      LOG.debug(mode.toString() + " Loaded TrustStore: " + truststoreLocation);
    }
    trustManagers=new TrustManager[]{trustManager};
  }
 else {
    if (LOG.isDebugEnabled()) {
      LOG.debug("The property '" + locationProperty + "' has not been set, "+ "no TrustStore will be loaded");
    }
    trustManagers=null;
  }
}
