{
  Configuration conf=new HdfsConfiguration();
  FSDataOutputStream fos=null;
  SecondaryNameNode secondary=null;
  MiniDFSCluster cluster=null;
  FileSystem fs=null;
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(numDatanodes).build();
    cluster.waitActive();
    fs=cluster.getFileSystem();
    secondary=startSecondaryNameNode(conf);
    fos=fs.create(new Path("tmpfile0"));
    fos.write(new byte[]{0,1,2,3});
    secondary.doCheckpoint();
    fos.write(new byte[]{0,1,2,3});
    fos.hsync();
    Mockito.doThrow(new IOException("Injecting failure during merge")).when(faultInjector).duringMerge();
    try {
      secondary.doCheckpoint();
      fail("Fault injection failed.");
    }
 catch (    IOException ioe) {
    }
    Mockito.reset(faultInjector);
    fos.write(new byte[]{0,1,2,3});
    fos.hsync();
    assertTrue("Another checkpoint should have reloaded image",secondary.doCheckpoint());
  }
  finally {
    if (fs != null) {
      fs.close();
    }
    cleanup(secondary);
    secondary=null;
    cleanup(cluster);
    cluster=null;
    Mockito.reset(faultInjector);
  }
}
