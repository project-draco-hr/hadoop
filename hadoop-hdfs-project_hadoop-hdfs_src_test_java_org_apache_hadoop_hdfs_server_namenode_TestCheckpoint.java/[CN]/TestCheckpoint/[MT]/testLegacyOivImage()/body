{
  MiniDFSCluster cluster=null;
  SecondaryNameNode secondary=null;
  File tmpDir=Files.createTempDir();
  Configuration conf=new HdfsConfiguration();
  conf.set(DFSConfigKeys.DFS_NAMENODE_LEGACY_OIV_IMAGE_DIR_KEY,tmpDir.getAbsolutePath());
  conf.set(DFSConfigKeys.DFS_NAMENODE_NUM_CHECKPOINTS_RETAINED_KEY,"2");
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(0).format(true).build();
    secondary=startSecondaryNameNode(conf);
    secondary.doCheckpoint();
    String files1[]=tmpDir.list();
    assertEquals("Only one file is expected",1,files1.length);
    secondary.doCheckpoint();
    secondary.doCheckpoint();
    String files2[]=tmpDir.list();
    assertEquals("Two files are expected",2,files2.length);
    for (    String fName : files2) {
      assertFalse(fName.equals(files1[0]));
    }
  }
  finally {
    cleanup(secondary);
    cleanup(cluster);
    tmpDir.delete();
  }
}
