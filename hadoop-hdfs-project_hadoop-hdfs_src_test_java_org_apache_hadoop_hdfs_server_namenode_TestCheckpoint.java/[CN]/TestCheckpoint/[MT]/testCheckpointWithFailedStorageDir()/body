{
  MiniDFSCluster cluster=null;
  SecondaryNameNode secondary=null;
  File currentDir=null;
  Configuration conf=new HdfsConfiguration();
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(0).format(true).build();
    secondary=startSecondaryNameNode(conf);
    secondary.doCheckpoint();
    NamenodeProtocols nn=cluster.getNameNodeRpc();
    NNStorage storage=cluster.getNameNode().getFSImage().getStorage();
    StorageDirectory sd0=storage.getStorageDir(0);
    StorageDirectory sd1=storage.getStorageDir(1);
    currentDir=sd0.getCurrentDir();
    FileUtil.setExecutable(currentDir,false);
    secondary.doCheckpoint();
    GenericTestUtils.assertExists(new File(sd1.getCurrentDir(),NNStorage.getImageFileName(2)));
    FileUtil.setExecutable(currentDir,true);
    nn.restoreFailedStorage("true");
    nn.rollEditLog();
    secondary.doCheckpoint();
    assertNNHasCheckpoints(cluster,ImmutableList.of(8));
    assertParallelFilesInvariant(cluster,ImmutableList.of(secondary));
  }
  finally {
    if (currentDir != null) {
      FileUtil.setExecutable(currentDir,true);
    }
    cleanup(secondary);
    secondary=null;
    cleanup(cluster);
    cluster=null;
  }
}
