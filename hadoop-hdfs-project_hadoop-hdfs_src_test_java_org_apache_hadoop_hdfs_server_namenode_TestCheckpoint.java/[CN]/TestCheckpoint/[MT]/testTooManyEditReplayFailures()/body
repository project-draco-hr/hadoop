{
  Configuration conf=new HdfsConfiguration();
  conf.set(DFSConfigKeys.DFS_NAMENODE_CHECKPOINT_MAX_RETRIES_KEY,"1");
  conf.set(DFSConfigKeys.DFS_NAMENODE_CHECKPOINT_CHECK_PERIOD_KEY,"1");
  FSDataOutputStream fos=null;
  SecondaryNameNode secondary=null;
  MiniDFSCluster cluster=null;
  FileSystem fs=null;
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(numDatanodes).checkExitOnShutdown(false).build();
    cluster.waitActive();
    fs=cluster.getFileSystem();
    fos=fs.create(new Path("tmpfile0"));
    fos.write(new byte[]{0,1,2,3});
    Mockito.doThrow(new IOException("Injecting failure during merge")).when(faultInjector).duringMerge();
    secondary=startSecondaryNameNode(conf);
    secondary.doWork();
    fail("2NN did not exit.");
  }
 catch (  ExitException ee) {
    ExitUtil.resetFirstExitException();
    assertEquals("Max retries",1,secondary.getMergeErrorCount() - 1);
  }
 finally {
    if (secondary != null) {
      secondary.shutdown();
    }
    if (fs != null) {
      fs.close();
    }
    if (cluster != null) {
      cluster.shutdown();
    }
    Mockito.reset(faultInjector);
  }
}
