{
  File f=new File("./src/test/resources/mock-container-executer-with-error");
  if (!FileUtil.canExecute(f)) {
    FileUtil.setExecutable(f,true);
  }
  String executorPath=f.getAbsolutePath();
  Configuration conf=new Configuration();
  conf.set(YarnConfiguration.NM_LINUX_CONTAINER_EXECUTOR_PATH,executorPath);
  conf.set(YarnConfiguration.NM_LOCAL_DIRS,"file:///bin/echo");
  conf.set(YarnConfiguration.NM_LOG_DIRS,"file:///dev/null");
  mockExec=spy(new LinuxContainerExecutor());
  doAnswer(new Answer(){
    @Override public Object answer(    InvocationOnMock invocationOnMock) throws Throwable {
      String diagnostics=(String)invocationOnMock.getArguments()[0];
      assertTrue("Invalid Diagnostics message: " + diagnostics,diagnostics.contains("badcommand"));
      return null;
    }
  }
).when(mockExec).logOutput(any(String.class));
  dirsHandler=new LocalDirsHandlerService();
  dirsHandler.init(conf);
  mockExec.setConf(conf);
  String appSubmitter="nobody";
  String cmd=String.valueOf(LinuxContainerExecutor.Commands.LAUNCH_CONTAINER.getValue());
  String appId="APP_ID";
  String containerId="CONTAINER_ID";
  Container container=mock(Container.class);
  ContainerId cId=mock(ContainerId.class);
  ContainerLaunchContext context=mock(ContainerLaunchContext.class);
  HashMap<String,String> env=new HashMap<String,String>();
  when(container.getContainerId()).thenReturn(cId);
  when(container.getLaunchContext()).thenReturn(context);
  doAnswer(new Answer(){
    @Override public Object answer(    InvocationOnMock invocationOnMock) throws Throwable {
      ContainerDiagnosticsUpdateEvent event=(ContainerDiagnosticsUpdateEvent)invocationOnMock.getArguments()[0];
      assertTrue("Invalid Diagnostics message: " + event.getDiagnosticsUpdate(),event.getDiagnosticsUpdate().contains("badcommand"));
      return null;
    }
  }
).when(container).handle(any(ContainerDiagnosticsUpdateEvent.class));
  when(cId.toString()).thenReturn(containerId);
  when(context.getEnvironment()).thenReturn(env);
  Path scriptPath=new Path("file:///bin/echo");
  Path tokensPath=new Path("file:///dev/null");
  Path workDir=new Path("/tmp");
  Path pidFile=new Path(workDir,"pid.txt");
  mockExec.activateContainer(cId,pidFile);
  int ret=mockExec.launchContainer(new ContainerStartContext.Builder().setContainer(container).setNmPrivateContainerScriptPath(scriptPath).setNmPrivateTokensPath(tokensPath).setUser(appSubmitter).setAppId(appId).setContainerWorkDir(workDir).setLocalDirs(dirsHandler.getLocalDirs()).setLogDirs(dirsHandler.getLogDirs()).build());
  Assert.assertNotSame(0,ret);
  assertEquals(Arrays.asList(YarnConfiguration.DEFAULT_NM_NONSECURE_MODE_LOCAL_USER,appSubmitter,cmd,appId,containerId,workDir.toString(),"/bin/echo","/dev/null",pidFile.toString(),StringUtils.join(PrivilegedOperation.LINUX_FILE_PATH_SEPARATOR,dirsHandler.getLocalDirs()),StringUtils.join(PrivilegedOperation.LINUX_FILE_PATH_SEPARATOR,dirsHandler.getLogDirs()),"cgroups=none"),readMockParams());
}
