{
  if (shouldCloseConnection.get()) {
    return;
  }
  touch();
  try {
    RpcResponseHeaderProto header=RpcResponseHeaderProto.parseDelimitedFrom(in);
    if (header == null) {
      throw new IOException("Response is null.");
    }
    int callId=header.getCallId();
    if (LOG.isDebugEnabled())     LOG.debug(getName() + " got value #" + callId);
    Call call=calls.get(callId);
    RpcStatusProto status=header.getStatus();
    if (status == RpcStatusProto.SUCCESS) {
      Writable value=ReflectionUtils.newInstance(valueClass,conf);
      value.readFields(in);
      call.setRpcResponse(value);
      calls.remove(callId);
    }
 else {
      final String exceptionClassName=header.hasExceptionClassName() ? header.getExceptionClassName() : "ServerDidNotSetExceptionClassName";
      final String errorMsg=header.hasErrorMsg() ? header.getErrorMsg() : "ServerDidNotSetErrorMsg";
      RemoteException re=new RemoteException(exceptionClassName,errorMsg);
      if (status == RpcStatusProto.ERROR) {
        call.setException(re);
        calls.remove(callId);
      }
 else       if (status == RpcStatusProto.FATAL) {
        markClosed(re);
      }
    }
  }
 catch (  IOException e) {
    markClosed(e);
  }
}
