{
  if (shouldCloseConnection.get()) {
    return;
  }
  touch();
  try {
    ByteBuffer bb=ipcStreams.readResponse();
    RpcWritable.Buffer packet=RpcWritable.Buffer.wrap(bb);
    RpcResponseHeaderProto header=packet.getValue(RpcResponseHeaderProto.getDefaultInstance());
    checkResponse(header);
    int callId=header.getCallId();
    if (LOG.isDebugEnabled())     LOG.debug(getName() + " got value #" + callId);
    RpcStatusProto status=header.getStatus();
    if (status == RpcStatusProto.SUCCESS) {
      Writable value=packet.newInstance(valueClass,conf);
      final Call call=calls.remove(callId);
      call.setRpcResponse(value);
    }
    if (packet.remaining() > 0) {
      throw new RpcClientException("RPC response length mismatch");
    }
    if (status != RpcStatusProto.SUCCESS) {
      final String exceptionClassName=header.hasExceptionClassName() ? header.getExceptionClassName() : "ServerDidNotSetExceptionClassName";
      final String errorMsg=header.hasErrorMsg() ? header.getErrorMsg() : "ServerDidNotSetErrorMsg";
      final RpcErrorCodeProto erCode=(header.hasErrorDetail() ? header.getErrorDetail() : null);
      if (erCode == null) {
        LOG.warn("Detailed error code not set by server on rpc error");
      }
      RemoteException re=new RemoteException(exceptionClassName,errorMsg,erCode);
      if (status == RpcStatusProto.ERROR) {
        final Call call=calls.remove(callId);
        call.setException(re);
      }
 else       if (status == RpcStatusProto.FATAL) {
        markClosed(re);
      }
    }
  }
 catch (  IOException e) {
    markClosed(e);
  }
}
