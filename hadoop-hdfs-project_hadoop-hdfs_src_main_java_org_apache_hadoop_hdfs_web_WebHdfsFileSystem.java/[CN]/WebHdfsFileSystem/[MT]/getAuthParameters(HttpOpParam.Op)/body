{
  List<Param<?,?>> authParams=Lists.newArrayList();
  boolean hasToken=false;
  if (UserGroupInformation.isSecurityEnabled() && op != GetOpParam.Op.GETDELEGATIONTOKEN && op != PutOpParam.Op.RENEWDELEGATIONTOKEN && op != PutOpParam.Op.CANCELDELEGATIONTOKEN) {
synchronized (this) {
      hasToken=(delegationToken != null);
      if (hasToken) {
        final String encoded=delegationToken.encodeToUrlString();
        authParams.add(new DelegationParam(encoded));
      }
    }
  }
  if (!hasToken) {
    UserGroupInformation userUgi=ugi;
    UserGroupInformation realUgi=userUgi.getRealUser();
    if (realUgi != null) {
      authParams.add(new DoAsParam(userUgi.getShortUserName()));
      userUgi=realUgi;
    }
    authParams.add(new UserParam(userUgi.getShortUserName()));
  }
  return authParams.toArray(new Param<?,?>[0]);
}
