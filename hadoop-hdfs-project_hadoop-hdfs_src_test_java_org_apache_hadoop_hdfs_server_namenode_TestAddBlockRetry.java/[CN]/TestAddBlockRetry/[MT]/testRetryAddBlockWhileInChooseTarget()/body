{
  final String src="/testRetryAddBlockWhileInChooseTarget";
  final FSNamesystem ns=cluster.getNamesystem();
  final NamenodeProtocols nn=cluster.getNameNodeRpc();
  nn.create(src,FsPermission.getFileDefault(),"clientName",new EnumSetWritable<CreateFlag>(EnumSet.of(CreateFlag.CREATE)),true,(short)3,1024,null);
  LOG.info("Starting first addBlock for " + src);
  LocatedBlock[] onRetryBlock=new LocatedBlock[1];
  DatanodeStorageInfo targets[]=ns.getNewBlockTargets(src,HdfsConstants.GRANDFATHER_INODE_ID,"clientName",null,null,null,onRetryBlock);
  assertNotNull("Targets must be generated",targets);
  LOG.info("Starting second addBlock for " + src);
  nn.addBlock(src,"clientName",null,null,HdfsConstants.GRANDFATHER_INODE_ID,null);
  assertTrue("Penultimate block must be complete",checkFileProgress(src,false));
  LocatedBlocks lbs=nn.getBlockLocations(src,0,Long.MAX_VALUE);
  assertEquals("Must be one block",1,lbs.getLocatedBlocks().size());
  LocatedBlock lb2=lbs.get(0);
  assertEquals("Wrong replication",REPLICATION,lb2.getLocations().length);
  LocatedBlock newBlock=ns.storeAllocatedBlock(src,HdfsConstants.GRANDFATHER_INODE_ID,"clientName",null,targets);
  assertEquals("Blocks are not equal",lb2.getBlock(),newBlock.getBlock());
  lbs=nn.getBlockLocations(src,0,Long.MAX_VALUE);
  assertEquals("Must be one block",1,lbs.getLocatedBlocks().size());
  LocatedBlock lb1=lbs.get(0);
  assertEquals("Wrong replication",REPLICATION,lb1.getLocations().length);
  assertEquals("Blocks are not equal",lb1.getBlock(),lb2.getBlock());
}
