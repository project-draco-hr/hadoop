{
  Configuration conf=new Configuration();
  conf.set(YarnConfiguration.IPC_RPC_IMPL,HadoopYarnProtoRPC.class.getName());
  YarnRPC rpc=YarnRPC.create(conf);
  String bindAddr="localhost:0";
  InetSocketAddress addr=NetUtils.createSocketAddr(bindAddr);
  conf.setSocketAddr(YarnConfiguration.RM_SCHEDULER_ADDRESS,addr);
  final RecordFactory factory=RecordFactoryProvider.getRecordFactory(null);
  final RMContext rmContext=new RMContextImpl(){
    @Override public AMLivelinessMonitor getAMLivelinessMonitor(){
      return null;
    }
    @Override public Configuration getYarnConfiguration(){
      return new YarnConfiguration();
    }
  }
;
  Container c=factory.newRecordInstance(Container.class);
  c.setExecutionType(ExecutionType.OPPORTUNISTIC);
  c.setId(ContainerId.newContainerId(ApplicationAttemptId.newInstance(ApplicationId.newInstance(12345,1),2),3));
  DistributedSchedulingService service=createService(factory,rmContext,c);
  Server server=service.getServer(rpc,conf,addr,null);
  server.start();
  RPC.setProtocolEngine(conf,ApplicationMasterProtocolPB.class,ProtobufRpcEngine.class);
  ApplicationMasterProtocolPB ampProxy=RPC.getProxy(ApplicationMasterProtocolPB.class,1,NetUtils.getConnectAddress(server),conf);
  RegisterApplicationMasterResponse regResp=new RegisterApplicationMasterResponsePBImpl(ampProxy.registerApplicationMaster(null,((RegisterApplicationMasterRequestPBImpl)factory.newRecordInstance(RegisterApplicationMasterRequest.class)).getProto()));
  Assert.assertEquals("dummyQueue",regResp.getQueue());
  FinishApplicationMasterResponse finishResp=new FinishApplicationMasterResponsePBImpl(ampProxy.finishApplicationMaster(null,((FinishApplicationMasterRequestPBImpl)factory.newRecordInstance(FinishApplicationMasterRequest.class)).getProto()));
  Assert.assertEquals(false,finishResp.getIsUnregistered());
  AllocateResponse allocResp=new AllocateResponsePBImpl(ampProxy.allocate(null,((AllocateRequestPBImpl)factory.newRecordInstance(AllocateRequest.class)).getProto()));
  List<Container> allocatedContainers=allocResp.getAllocatedContainers();
  Assert.assertEquals(1,allocatedContainers.size());
  Assert.assertEquals(ExecutionType.OPPORTUNISTIC,allocatedContainers.get(0).getExecutionType());
  Assert.assertEquals(12345,allocResp.getNumClusterNodes());
  RPC.setProtocolEngine(conf,DistributedSchedulerProtocolPB.class,ProtobufRpcEngine.class);
  DistributedSchedulerProtocolPB dsProxy=RPC.getProxy(DistributedSchedulerProtocolPB.class,1,NetUtils.getConnectAddress(server),conf);
  DistSchedRegisterResponse dsRegResp=new DistSchedRegisterResponsePBImpl(dsProxy.registerApplicationMasterForDistributedScheduling(null,((RegisterApplicationMasterRequestPBImpl)factory.newRecordInstance(RegisterApplicationMasterRequest.class)).getProto()));
  Assert.assertEquals(54321l,dsRegResp.getContainerIdStart());
  Assert.assertEquals(4,dsRegResp.getMaxAllocatableCapabilty().getVirtualCores());
  Assert.assertEquals(1024,dsRegResp.getMinAllocatableCapabilty().getMemorySize());
  Assert.assertEquals(2,dsRegResp.getIncrAllocatableCapabilty().getVirtualCores());
  DistSchedAllocateResponse dsAllocResp=new DistSchedAllocateResponsePBImpl(dsProxy.allocateForDistributedScheduling(null,((AllocateRequestPBImpl)factory.newRecordInstance(AllocateRequest.class)).getProto()));
  Assert.assertEquals("h1",dsAllocResp.getNodesForScheduling().get(0).getHost());
  FinishApplicationMasterResponse dsfinishResp=new FinishApplicationMasterResponsePBImpl(dsProxy.finishApplicationMaster(null,((FinishApplicationMasterRequestPBImpl)factory.newRecordInstance(FinishApplicationMasterRequest.class)).getProto()));
  Assert.assertEquals(false,dsfinishResp.getIsUnregistered());
}
