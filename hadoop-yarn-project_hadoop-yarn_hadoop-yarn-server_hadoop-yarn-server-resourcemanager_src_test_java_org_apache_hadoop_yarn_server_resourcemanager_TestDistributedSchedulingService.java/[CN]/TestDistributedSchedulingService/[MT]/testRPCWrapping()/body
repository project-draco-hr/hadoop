{
  Configuration conf=new Configuration();
  conf.set(YarnConfiguration.IPC_RPC_IMPL,HadoopYarnProtoRPC.class.getName());
  YarnRPC rpc=YarnRPC.create(conf);
  String bindAddr="localhost:0";
  InetSocketAddress addr=NetUtils.createSocketAddr(bindAddr);
  conf.setSocketAddr(YarnConfiguration.RM_SCHEDULER_ADDRESS,addr);
  final RecordFactory factory=RecordFactoryProvider.getRecordFactory(null);
  final RMContext rmContext=new RMContextImpl(){
    @Override public AMLivelinessMonitor getAMLivelinessMonitor(){
      return null;
    }
    @Override public Configuration getYarnConfiguration(){
      return new YarnConfiguration();
    }
  }
;
  DistributedSchedulingService service=new DistributedSchedulingService(rmContext,null){
    @Override public RegisterApplicationMasterResponse registerApplicationMaster(    RegisterApplicationMasterRequest request) throws YarnException, IOException {
      RegisterApplicationMasterResponse resp=factory.newRecordInstance(RegisterApplicationMasterResponse.class);
      resp.setQueue("dummyQueue");
      return resp;
    }
    @Override public FinishApplicationMasterResponse finishApplicationMaster(    FinishApplicationMasterRequest request) throws YarnException, IOException {
      FinishApplicationMasterResponse resp=factory.newRecordInstance(FinishApplicationMasterResponse.class);
      resp.setIsUnregistered(false);
      return resp;
    }
    @Override public AllocateResponse allocate(    AllocateRequest request) throws YarnException, IOException {
      AllocateResponse response=factory.newRecordInstance(AllocateResponse.class);
      response.setNumClusterNodes(12345);
      return response;
    }
    @Override public DistSchedRegisterResponse registerApplicationMasterForDistributedScheduling(    RegisterApplicationMasterRequest request) throws YarnException, IOException {
      DistSchedRegisterResponse resp=factory.newRecordInstance(DistSchedRegisterResponse.class);
      resp.setContainerIdStart(54321l);
      return resp;
    }
    @Override public DistSchedAllocateResponse allocateForDistributedScheduling(    AllocateRequest request) throws YarnException, IOException {
      DistSchedAllocateResponse resp=factory.newRecordInstance(DistSchedAllocateResponse.class);
      resp.setNodesForScheduling(Arrays.asList(NodeId.newInstance("h1",1234)));
      return resp;
    }
  }
;
  Server server=service.getServer(rpc,conf,addr,null);
  server.start();
  RPC.setProtocolEngine(conf,ApplicationMasterProtocolPB.class,ProtobufRpcEngine.class);
  ApplicationMasterProtocol ampProxy=(ApplicationMasterProtocol)rpc.getProxy(ApplicationMasterProtocol.class,NetUtils.getConnectAddress(server),conf);
  RegisterApplicationMasterResponse regResp=ampProxy.registerApplicationMaster(factory.newRecordInstance(RegisterApplicationMasterRequest.class));
  Assert.assertEquals("dummyQueue",regResp.getQueue());
  FinishApplicationMasterResponse finishResp=ampProxy.finishApplicationMaster(factory.newRecordInstance(FinishApplicationMasterRequest.class));
  Assert.assertEquals(false,finishResp.getIsUnregistered());
  AllocateResponse allocResp=ampProxy.allocate(factory.newRecordInstance(AllocateRequest.class));
  Assert.assertEquals(12345,allocResp.getNumClusterNodes());
  RPC.setProtocolEngine(conf,DistributedSchedulerProtocolPB.class,ProtobufRpcEngine.class);
  DistributedSchedulerProtocol dsProxy=(DistributedSchedulerProtocol)rpc.getProxy(DistributedSchedulerProtocol.class,NetUtils.getConnectAddress(server),conf);
  DistSchedRegisterResponse dsRegResp=dsProxy.registerApplicationMasterForDistributedScheduling(factory.newRecordInstance(RegisterApplicationMasterRequest.class));
  Assert.assertEquals(54321l,dsRegResp.getContainerIdStart());
  DistSchedAllocateResponse dsAllocResp=dsProxy.allocateForDistributedScheduling(factory.newRecordInstance(AllocateRequest.class));
  Assert.assertEquals("h1",dsAllocResp.getNodesForScheduling().get(0).getHost());
}
