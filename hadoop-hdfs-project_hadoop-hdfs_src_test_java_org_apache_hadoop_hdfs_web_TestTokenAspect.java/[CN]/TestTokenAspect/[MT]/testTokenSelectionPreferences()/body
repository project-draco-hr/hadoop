{
  Configuration conf=new Configuration();
  DummyFs fs=spy(new DummyFs());
  doReturn(null).when(fs).getDelegationToken(anyString());
  fs.initialize(new URI("dummyfs://localhost:1234"),conf);
  TokenAspect<DummyFs> aspect=new TokenAspect<DummyFs>(fs,DummyFs.TOKEN_KIND);
  UserGroupInformation ugi=UserGroupInformation.createUserForTesting("foo",new String[]{"bar"});
  SecurityUtilTestHelper.setTokenServiceUseIp(true);
  Token<TokenIdentifier> hdfsToken=new Token<TokenIdentifier>(new byte[0],new byte[0],DelegationTokenIdentifier.HDFS_DELEGATION_KIND,new Text("127.0.0.1:8020"));
  ugi.addToken(hdfsToken);
  Token<?> token=aspect.selectDelegationToken(ugi);
  assertEquals(hdfsToken,token);
  Token<TokenIdentifier> dummyFsToken=new Token<TokenIdentifier>(new byte[0],new byte[0],DummyFs.TOKEN_KIND,new Text("127.0.0.1:1234"));
  ugi.addToken(dummyFsToken);
  token=aspect.selectDelegationToken(ugi);
  assertEquals(dummyFsToken,token);
  SecurityUtilTestHelper.setTokenServiceUseIp(false);
  token=aspect.selectDelegationToken(ugi);
  assertNull(token);
  hdfsToken=new Token<TokenIdentifier>(new byte[0],new byte[0],DelegationTokenIdentifier.HDFS_DELEGATION_KIND,new Text("localhost:8020"));
  ugi.addToken(hdfsToken);
  token=aspect.selectDelegationToken(ugi);
  assertEquals(hdfsToken,token);
  dummyFsToken=new Token<TokenIdentifier>(new byte[0],new byte[0],DummyFs.TOKEN_KIND,new Text("localhost:1234"));
  ugi.addToken(dummyFsToken);
  token=aspect.selectDelegationToken(ugi);
  assertEquals(dummyFsToken,token);
}
