{
  Preconditions.checkArgument(req.uri().startsWith(WEBHDFS_PREFIX));
  QueryStringDecoder queryString=new QueryStringDecoder(req.uri());
  params=new ParameterParser(queryString,conf);
  DataNodeUGIProvider ugiProvider=new DataNodeUGIProvider(params);
  ugi=ugiProvider.ugi();
  path=params.path();
  injectToken();
  ugi.doAs(new PrivilegedExceptionAction<Void>(){
    @Override public Void run() throws Exception {
      try {
        handle(ctx,req);
      }
  finally {
        String host=null;
        try {
          host=((InetSocketAddress)ctx.channel().remoteAddress()).getAddress().getHostAddress();
        }
 catch (        Exception e) {
          LOG.warn("Error retrieving hostname: ",e);
          host="unknown";
        }
        REQLOG.info(host + " " + req.method()+ " "+ req.uri()+ " "+ getResponseCode());
      }
      return null;
    }
  }
);
}
