{
  Preconditions.checkNotNull(url,"url");
  Preconditions.checkNotNull(token,"token");
  Map<String,String> extraParams=new HashMap<String,String>();
  Credentials creds=UserGroupInformation.getCurrentUser().getCredentials();
  if (!creds.getAllTokens().isEmpty()) {
    InetSocketAddress serviceAddr=new InetSocketAddress(url.getHost(),url.getPort());
    Text service=SecurityUtil.buildTokenService(serviceAddr);
    org.apache.hadoop.security.token.Token<? extends TokenIdentifier> dt=creds.getToken(service);
    if (dt != null) {
      extraParams.put(KerberosDelegationTokenAuthenticator.DELEGATION_PARAM,dt.encodeToUrlString());
    }
  }
  url=augmentURL(url,extraParams);
  return super.openConnection(url,token);
}
