{
  HeartbeatResponse response;
  try {
    final StorageReport[] report=PBHelperClient.convertStorageReports(request.getReportsList());
    VolumeFailureSummary volumeFailureSummary=request.hasVolumeFailureSummary() ? PBHelper.convertVolumeFailureSummary(request.getVolumeFailureSummary()) : null;
    response=impl.sendHeartbeat(PBHelper.convert(request.getRegistration()),report,request.getCacheCapacity(),request.getCacheUsed(),request.getXmitsInProgress(),request.getXceiverCount(),request.getFailedVolumes(),volumeFailureSummary,request.getRequestFullBlockReportLease());
  }
 catch (  IOException e) {
    throw new ServiceException(e);
  }
  HeartbeatResponseProto.Builder builder=HeartbeatResponseProto.newBuilder();
  DatanodeCommand[] cmds=response.getCommands();
  if (cmds != null) {
    for (int i=0; i < cmds.length; i++) {
      if (cmds[i] != null) {
        builder.addCmds(PBHelper.convert(cmds[i]));
      }
    }
  }
  builder.setHaStatus(PBHelper.convert(response.getNameNodeHaState()));
  RollingUpgradeStatus rollingUpdateStatus=response.getRollingUpdateStatus();
  if (rollingUpdateStatus != null) {
    builder.setRollingUpgradeStatus(PBHelperClient.convertRollingUpgradeStatus(rollingUpdateStatus));
  }
  builder.setFullBlockReportLeaseId(response.getFullBlockReportLeaseId());
  return builder.build();
}
