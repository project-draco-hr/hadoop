{
  HeartbeatResponse response;
  try {
    List<StorageReportProto> list=request.getReportsList();
    StorageReport[] report=new StorageReport[list.size()];
    int i=0;
    for (    StorageReportProto p : list) {
      report[i++]=new StorageReport(p.getStorageID(),p.getFailed(),p.getCapacity(),p.getDfsUsed(),p.getRemaining(),p.getBlockPoolUsed());
    }
    List<CacheReportProto> cacheList=request.getCacheReportsList();
    CacheReport[] cacheReport=new CacheReport[list.size()];
    i=0;
    for (    CacheReportProto p : cacheList) {
      cacheReport[i++]=new CacheReport(p.getCacheCapacity(),p.getCacheUsed());
    }
    response=impl.sendHeartbeat(PBHelper.convert(request.getRegistration()),report,cacheReport,request.getXmitsInProgress(),request.getXceiverCount(),request.getFailedVolumes());
  }
 catch (  IOException e) {
    throw new ServiceException(e);
  }
  HeartbeatResponseProto.Builder builder=HeartbeatResponseProto.newBuilder();
  DatanodeCommand[] cmds=response.getCommands();
  if (cmds != null) {
    for (int i=0; i < cmds.length; i++) {
      if (cmds[i] != null) {
        builder.addCmds(PBHelper.convert(cmds[i]));
      }
    }
  }
  builder.setHaStatus(PBHelper.convert(response.getNameNodeHaState()));
  return builder.build();
}
