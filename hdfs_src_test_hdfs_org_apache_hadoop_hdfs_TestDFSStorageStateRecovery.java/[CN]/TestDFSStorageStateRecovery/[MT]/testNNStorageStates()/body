{
  String[] baseDirs;
  for (int numDirs=1; numDirs <= 2; numDirs++) {
    conf=new HdfsConfiguration();
    conf.setInt(DFSConfigKeys.DFS_DATANODE_SCAN_PERIOD_HOURS_KEY,-1);
    conf=UpgradeUtilities.initializeStorageStateConf(numDirs,conf);
    for (int i=0; i < NUM_NN_TEST_CASES; i++) {
      boolean[] testCase=testCases[i];
      boolean shouldRecover=testCase[5];
      boolean curAfterRecover=testCase[6];
      boolean prevAfterRecover=testCase[7];
      log("NAME_NODE recovery",numDirs,i,testCase);
      baseDirs=createNameNodeStorageState(testCase);
      if (shouldRecover) {
        cluster=createCluster(conf);
        checkResultNameNode(baseDirs,curAfterRecover,prevAfterRecover);
        cluster.shutdown();
      }
 else {
        try {
          cluster=createCluster(conf);
          throw new AssertionError("NameNode should have failed to start");
        }
 catch (        IOException expected) {
          if (!testCases[i][0] && !testCases[i][2] && !testCases[i][1]&& !testCases[i][3]&& !testCases[i][4]) {
            assertTrue(expected.getLocalizedMessage().contains("NameNode is not formatted"));
          }
        }
      }
      cluster.shutdown();
    }
  }
}
