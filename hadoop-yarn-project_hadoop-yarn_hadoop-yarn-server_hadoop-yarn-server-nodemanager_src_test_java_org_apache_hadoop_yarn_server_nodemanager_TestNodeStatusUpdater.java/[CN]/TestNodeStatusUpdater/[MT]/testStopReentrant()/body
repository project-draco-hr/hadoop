{
  final AtomicInteger numCleanups=new AtomicInteger(0);
  nm=new NodeManager(){
    @Override protected NodeStatusUpdater createNodeStatusUpdater(    Context context,    Dispatcher dispatcher,    NodeHealthCheckerService healthChecker){
      MyNodeStatusUpdater myNodeStatusUpdater=new MyNodeStatusUpdater(context,dispatcher,healthChecker,metrics);
      MyResourceTracker2 myResourceTracker2=new MyResourceTracker2();
      myResourceTracker2.heartBeatNodeAction=NodeAction.SHUTDOWN;
      myNodeStatusUpdater.resourceTracker=myResourceTracker2;
      return myNodeStatusUpdater;
    }
    @Override protected void cleanupContainers(    NodeManagerEventType eventType){
      super.cleanupContainers(NodeManagerEventType.SHUTDOWN);
      numCleanups.incrementAndGet();
    }
  }
;
  YarnConfiguration conf=createNMConfig();
  nm.init(conf);
  nm.start();
  int waitCount=0;
  while (heartBeatID < 1 && waitCount++ != 200) {
    Thread.sleep(500);
  }
  Assert.assertFalse(heartBeatID < 1);
  nm.stop();
  waitCount=0;
  while (nm.getServiceState() != STATE.STOPPED && waitCount++ != 20) {
    LOG.info("Waiting for NM to stop..");
    Thread.sleep(1000);
  }
  Assert.assertEquals(STATE.STOPPED,nm.getServiceState());
  Assert.assertEquals(numCleanups.get(),1);
}
