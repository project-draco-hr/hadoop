{
  NodeManager nm=new NodeManager();
  YarnConfiguration conf=new YarnConfiguration();
  conf.set(NodeStatusUpdaterImpl.YARN_NODEMANAGER_DURATION_TO_TRACK_STOPPED_CONTAINERS,"1000000");
  nm.init(conf);
  NodeStatusUpdaterImpl nodeStatusUpdater=(NodeStatusUpdaterImpl)nm.getNodeStatusUpdater();
  ApplicationId appId=ApplicationId.newInstance(0,0);
  ApplicationAttemptId appAttemptId=ApplicationAttemptId.newInstance(appId,0);
  ContainerId cId=ContainerId.newInstance(appAttemptId,1);
  Token containerToken=BuilderUtils.newContainerToken(cId,"anyHost",1234,"anyUser",BuilderUtils.newResource(1024,1),0,123,"password".getBytes(),0);
  Container anyCompletedContainer=new ContainerImpl(conf,null,null,null,null,null,BuilderUtils.newContainerTokenIdentifier(containerToken)){
    @Override public ContainerState getCurrentState(){
      return ContainerState.COMPLETE;
    }
  }
;
  Application application=mock(Application.class);
  when(application.getApplicationState()).thenReturn(ApplicationState.RUNNING);
  nm.getNMContext().getApplications().putIfAbsent(appId,application);
  nm.getNMContext().getContainers().put(cId,anyCompletedContainer);
  Assert.assertEquals(1,nodeStatusUpdater.getContainerStatuses().size());
  when(application.getApplicationState()).thenReturn(ApplicationState.FINISHING_CONTAINERS_WAIT);
  Assert.assertEquals(1,nodeStatusUpdater.getContainerStatuses().size());
  Assert.assertEquals(0,nodeStatusUpdater.getContainerStatuses().size());
  nm.getNMContext().getContainers().put(cId,anyCompletedContainer);
  nm.getNMContext().getApplications().remove(appId);
  Assert.assertEquals(1,nodeStatusUpdater.getContainerStatuses().size());
  Assert.assertEquals(0,nodeStatusUpdater.getContainerStatuses().size());
}
