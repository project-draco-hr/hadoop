{
  MyNodeManager nm=new MyNodeManager();
  try {
    YarnConfiguration conf=createNMConfig();
    conf.setBoolean(YarnConfiguration.LOG_AGGREGATION_ENABLED,true);
    conf.setLong(YarnConfiguration.RM_NM_EXPIRY_INTERVAL_MS,4000l);
    nm.init(conf);
    nm.start();
    while (heartBeatID < 12) {
      Thread.sleep(1000l);
    }
    MyResourceTracker3 rt=(MyResourceTracker3)nm.getNodeStatusUpdater().getRMClient();
    rt.context.getApplications().remove(rt.appId);
    Assert.assertEquals(1,rt.keepAliveRequests.size());
    int numKeepAliveRequests=rt.keepAliveRequests.get(rt.appId).size();
    LOG.info("Number of Keep Alive Requests: [" + numKeepAliveRequests + "]");
    Assert.assertTrue(numKeepAliveRequests == 2 || numKeepAliveRequests == 3);
    while (heartBeatID < 20) {
      Thread.sleep(1000l);
    }
    int numKeepAliveRequests2=rt.keepAliveRequests.get(rt.appId).size();
    Assert.assertEquals(numKeepAliveRequests,numKeepAliveRequests2);
  }
  finally {
    if (nm.getServiceState() == STATE.STARTED)     nm.stop();
  }
}
