{
  EditsDoubleBuffer buf=new EditsDoubleBuffer(1024);
  assertTrue(buf.isFlushed());
  byte[] data=new byte[100];
  buf.writeRaw(data,0,data.length);
  assertEquals("Should count new data correctly",data.length,buf.countBufferedBytes());
  assertTrue("Writing to current buffer should not affect flush state",buf.isFlushed());
  buf.setReadyToFlush();
  assertEquals("Swapping buffers should still count buffered bytes",data.length,buf.countBufferedBytes());
  assertFalse(buf.isFlushed());
  DataOutputBuffer outBuf=new DataOutputBuffer();
  buf.flushTo(outBuf);
  assertEquals(data.length,outBuf.getLength());
  assertTrue(buf.isFlushed());
  assertEquals(0,buf.countBufferedBytes());
  buf.writeRaw(data,0,data.length);
  assertEquals("Should count new data correctly",data.length,buf.countBufferedBytes());
  buf.setReadyToFlush();
  buf.flushTo(outBuf);
  assertEquals(data.length * 2,outBuf.getLength());
  assertEquals(0,buf.countBufferedBytes());
  outBuf.close();
}
