{
  this.bpid=bpid;
  this.volume=volume;
  this.currentDir=new File(bpDir,DataStorage.STORAGE_DIR_CURRENT);
  this.finalizedDir=new File(currentDir,DataStorage.STORAGE_DIR_FINALIZED);
  this.lazypersistDir=new File(currentDir,DataStorage.STORAGE_DIR_LAZY_PERSIST);
  if (!this.finalizedDir.exists()) {
    if (!this.finalizedDir.mkdirs()) {
      throw new IOException("Failed to mkdirs " + this.finalizedDir);
    }
  }
  this.ioFileBufferSize=DFSUtilClient.getIoFileBufferSize(conf);
  this.deleteDuplicateReplicas=conf.getBoolean(DFSConfigKeys.DFS_DATANODE_DUPLICATE_REPLICA_DELETION,DFSConfigKeys.DFS_DATANODE_DUPLICATE_REPLICA_DELETION_DEFAULT);
  this.cachedDfsUsedCheckTime=conf.getLong(DFSConfigKeys.DFS_DN_CACHED_DFSUSED_CHECK_INTERVAL_MS,DFSConfigKeys.DFS_DN_CACHED_DFSUSED_CHECK_INTERVAL_DEFAULT_MS);
  this.maxDataLength=conf.getInt(CommonConfigurationKeys.IPC_MAXIMUM_DATA_LENGTH,CommonConfigurationKeys.IPC_MAXIMUM_DATA_LENGTH_DEFAULT);
  this.timer=timer;
  this.tmpDir=new File(bpDir,DataStorage.STORAGE_DIR_TMP);
  if (tmpDir.exists()) {
    FileUtil.fullyDelete(tmpDir);
  }
  this.rbwDir=new File(currentDir,DataStorage.STORAGE_DIR_RBW);
  if (!rbwDir.mkdirs()) {
    if (!rbwDir.isDirectory()) {
      throw new IOException("Mkdirs failed to create " + rbwDir.toString());
    }
  }
  if (!tmpDir.mkdirs()) {
    if (!tmpDir.isDirectory()) {
      throw new IOException("Mkdirs failed to create " + tmpDir.toString());
    }
  }
  this.dfsUsage=new CachingGetSpaceUsed.Builder().setPath(bpDir).setConf(conf).setInitialUsed(loadDfsUsed()).build();
  ShutdownHookManager.get().addShutdownHook(new Runnable(){
    @Override public void run(){
      if (!dfsUsedSaved) {
        saveDfsUsed();
      }
    }
  }
,SHUTDOWN_HOOK_PRIORITY);
}
