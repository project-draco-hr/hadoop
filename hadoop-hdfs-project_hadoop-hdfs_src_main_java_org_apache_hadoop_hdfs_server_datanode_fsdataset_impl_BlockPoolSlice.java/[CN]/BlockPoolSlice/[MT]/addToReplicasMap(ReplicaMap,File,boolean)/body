{
  File blockFiles[]=FileUtil.listFiles(dir);
  for (  File blockFile : blockFiles) {
    if (!Block.isBlockFilename(blockFile))     continue;
    long genStamp=FsDatasetUtil.getGenerationStampFromFile(blockFiles,blockFile);
    long blockId=Block.filename2id(blockFile.getName());
    ReplicaInfo newReplica=null;
    if (isFinalized) {
      newReplica=new FinalizedReplica(blockId,blockFile.length(),genStamp,volume,blockFile.getParentFile());
    }
 else {
      newReplica=new ReplicaWaitingToBeRecovered(blockId,validateIntegrityAndSetLength(blockFile,genStamp),genStamp,volume,blockFile.getParentFile());
    }
    ReplicaInfo oldReplica=volumeMap.add(bpid,newReplica);
    if (oldReplica != null) {
      FsDatasetImpl.LOG.warn("Two block files with the same block id exist " + "on disk: " + oldReplica.getBlockFile() + " and "+ blockFile);
    }
  }
}
