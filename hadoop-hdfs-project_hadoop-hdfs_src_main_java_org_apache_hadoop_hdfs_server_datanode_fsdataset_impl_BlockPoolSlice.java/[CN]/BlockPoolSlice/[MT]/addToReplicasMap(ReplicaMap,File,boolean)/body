{
  File blockFiles[]=FileUtil.listFiles(dir);
  for (  File blockFile : blockFiles) {
    if (!Block.isBlockFilename(blockFile))     continue;
    long genStamp=FsDatasetUtil.getGenerationStampFromFile(blockFiles,blockFile);
    long blockId=Block.filename2id(blockFile.getName());
    ReplicaInfo newReplica=null;
    if (isFinalized) {
      newReplica=new FinalizedReplica(blockId,blockFile.length(),genStamp,volume,blockFile.getParentFile());
    }
 else {
      boolean loadRwr=true;
      File restartMeta=new File(blockFile.getParent() + File.pathSeparator + "."+ blockFile.getName()+ ".restart");
      Scanner sc=null;
      try {
        sc=new Scanner(restartMeta);
        if (sc.hasNextLong() && (sc.nextLong() > Time.now())) {
          newReplica=new ReplicaBeingWritten(blockId,validateIntegrityAndSetLength(blockFile,genStamp),genStamp,volume,blockFile.getParentFile(),null);
          loadRwr=false;
        }
        restartMeta.delete();
      }
 catch (      FileNotFoundException fnfe) {
      }
 finally {
        if (sc != null) {
          sc.close();
        }
      }
      if (loadRwr) {
        newReplica=new ReplicaWaitingToBeRecovered(blockId,validateIntegrityAndSetLength(blockFile,genStamp),genStamp,volume,blockFile.getParentFile());
      }
    }
    ReplicaInfo oldReplica=volumeMap.add(bpid,newReplica);
    if (oldReplica != null) {
      FsDatasetImpl.LOG.warn("Two block files with the same block id exist " + "on disk: " + oldReplica.getBlockFile() + " and "+ blockFile);
    }
  }
}
