{
  YarnConfiguration conf=new YarnConfiguration();
  conf.setClass(YarnConfiguration.RM_SCHEDULER,CapacityScheduler.class,ResourceScheduler.class);
  conf.setBoolean(YarnConfiguration.RECOVERY_ENABLED,true);
  conf.set(YarnConfiguration.RM_STORE,MemoryRMStateStore.class.getName());
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,2);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  MockNM nm1=new MockNM("127.0.0.1:1234",8000,rm1.getResourceTrackerService());
  nm1.registerNode();
  RMApp app=rm1.submitApp(200,20000);
  MockAM am=MockRM.launchAM(app,rm1,nm1);
  nm1.nodeHeartbeat(am.getApplicationAttemptId(),1,ContainerState.COMPLETE);
  am.waitForState(RMAppAttemptState.FAILED);
  rm1.waitForState(app.getApplicationId(),RMAppState.ACCEPTED);
  Assert.assertEquals(2,app.getAppAttempts().size());
  Assert.assertTrue(((RMAppAttemptImpl)app.getCurrentAppAttempt()).mayBeLastAttempt());
  MockAM am_2=MockRM.launchAndRegisterAM(app,rm1,nm1);
  am_2.waitForState(RMAppAttemptState.RUNNING);
  nm1.nodeHeartbeat(am_2.getApplicationAttemptId(),1,ContainerState.COMPLETE);
  am_2.waitForState(RMAppAttemptState.FAILED);
  rm1.waitForState(app.getApplicationId(),RMAppState.FAILED);
  ControlledClock clock=new ControlledClock(new SystemClock());
  RMAppImpl app1=(RMAppImpl)rm1.submitApp(200,6000);
  ;
  app1.setSystemClock(clock);
  MockAM am1=MockRM.launchAndRegisterAM(app1,rm1,nm1);
  nm1.nodeHeartbeat(am1.getApplicationAttemptId(),1,ContainerState.COMPLETE);
  am1.waitForState(RMAppAttemptState.FAILED);
  rm1.waitForState(app1.getApplicationId(),RMAppState.ACCEPTED);
  Assert.assertEquals(2,app1.getAppAttempts().size());
  RMAppAttempt attempt2=app1.getCurrentAppAttempt();
  Assert.assertTrue(((RMAppAttemptImpl)attempt2).mayBeLastAttempt());
  MockAM am2=MockRM.launchAndRegisterAM(app1,rm1,nm1);
  am2.waitForState(RMAppAttemptState.RUNNING);
  clock.setTime(System.currentTimeMillis() + 6 * 1000);
  nm1.nodeHeartbeat(am2.getApplicationAttemptId(),1,ContainerState.COMPLETE);
  am2.waitForState(RMAppAttemptState.FAILED);
  rm1.waitForState(app1.getApplicationId(),RMAppState.ACCEPTED);
  Assert.assertEquals(3,app1.getAppAttempts().size());
  RMAppAttempt attempt3=app1.getCurrentAppAttempt();
  clock.reset();
  MockAM am3=MockRM.launchAndRegisterAM(app1,rm1,nm1);
  am3.waitForState(RMAppAttemptState.RUNNING);
  @SuppressWarnings("resource") MockRM rm2=new MockRM(conf,memStore);
  rm2.start();
  nm1.setResourceTrackerService(rm2.getResourceTrackerService());
  NMContainerStatus status=Records.newRecord(NMContainerStatus.class);
  status.setContainerExitStatus(ContainerExitStatus.KILLED_BY_RESOURCEMANAGER);
  status.setContainerId(attempt3.getMasterContainer().getId());
  status.setContainerState(ContainerState.COMPLETE);
  status.setDiagnostics("");
  nm1.registerNode(Collections.singletonList(status),null);
  rm2.waitForState(attempt3.getAppAttemptId(),RMAppAttemptState.FAILED);
  rm2.waitForState(app1.getApplicationId(),RMAppState.ACCEPTED);
  MockAM am4=rm2.waitForNewAMToLaunchAndRegister(app1.getApplicationId(),4,nm1);
  clock.setTime(System.currentTimeMillis() + 6 * 1000);
  nm1.nodeHeartbeat(am4.getApplicationAttemptId(),1,ContainerState.COMPLETE);
  am4.waitForState(RMAppAttemptState.FAILED);
  rm2.waitForState(app1.getApplicationId(),RMAppState.ACCEPTED);
  MockAM am5=rm2.waitForNewAMToLaunchAndRegister(app1.getApplicationId(),5,nm1);
  clock.reset();
  am5.waitForState(RMAppAttemptState.RUNNING);
  nm1.nodeHeartbeat(am5.getApplicationAttemptId(),1,ContainerState.COMPLETE);
  am5.waitForState(RMAppAttemptState.FAILED);
  rm2.waitForState(app1.getApplicationId(),RMAppState.FAILED);
  rm1.stop();
  rm2.stop();
}
