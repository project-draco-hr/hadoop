{
  Resource capability=request.getCapability();
  Resource available=node.getAvailableResource();
  Container container=null;
  if (reserved) {
    container=node.getReservedContainer().getContainer();
  }
 else {
    container=createContainer(node,capability,request.getPriority());
  }
  if (Resources.fitsIn(capability,available)) {
    RMContainer allocatedContainer=allocate(type,node,request.getPriority(),request,container);
    if (allocatedContainer == null) {
      if (reserved) {
        unreserve(request.getPriority(),node);
      }
      return Resources.none();
    }
    if (reserved) {
      unreserve(request.getPriority(),node);
    }
    node.allocateContainer(allocatedContainer);
    if (!isAmRunning() && !getUnmanagedAM()) {
      setAMResource(container.getResource());
      getQueue().addAMResourceUsage(container.getResource());
      setAmRunning(true);
    }
    return container.getResource();
  }
  if (isReservable(container)) {
    reserve(request.getPriority(),node,container,type,reserved);
    return FairScheduler.CONTAINER_RESERVED;
  }
 else {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Not creating reservation as container " + container.getId() + " is not reservable");
    }
    return Resources.none();
  }
}
