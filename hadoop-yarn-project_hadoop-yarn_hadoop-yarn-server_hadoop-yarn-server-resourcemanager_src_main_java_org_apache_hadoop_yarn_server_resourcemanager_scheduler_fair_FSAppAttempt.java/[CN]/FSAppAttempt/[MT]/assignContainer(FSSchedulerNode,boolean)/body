{
  if (LOG.isDebugEnabled()) {
    LOG.debug("Node offered to app: " + getName() + " reserved: "+ reserved);
  }
  Collection<SchedulerRequestKey> keysToTry=(reserved) ? Arrays.asList(node.getReservedContainer().getReservedSchedulerKey()) : getSchedulerKeys();
synchronized (this) {
    for (    SchedulerRequestKey schedulerKey : keysToTry) {
      if (!reserved && !hasContainerForNode(schedulerKey,node)) {
        continue;
      }
      addSchedulingOpportunity(schedulerKey);
      ResourceRequest rackLocalRequest=getResourceRequest(schedulerKey,node.getRackName());
      ResourceRequest localRequest=getResourceRequest(schedulerKey,node.getNodeName());
      if (localRequest != null && !localRequest.getRelaxLocality()) {
        LOG.warn("Relax locality off is not supported on local request: " + localRequest);
      }
      NodeType allowedLocality;
      if (scheduler.isContinuousSchedulingEnabled()) {
        allowedLocality=getAllowedLocalityLevelByTime(schedulerKey,scheduler.getNodeLocalityDelayMs(),scheduler.getRackLocalityDelayMs(),scheduler.getClock().getTime());
      }
 else {
        allowedLocality=getAllowedLocalityLevel(schedulerKey,scheduler.getNumClusterNodes(),scheduler.getNodeLocalityThreshold(),scheduler.getRackLocalityThreshold());
      }
      if (rackLocalRequest != null && rackLocalRequest.getNumContainers() != 0 && localRequest != null && localRequest.getNumContainers() != 0) {
        return assignContainer(node,localRequest,NodeType.NODE_LOCAL,reserved,schedulerKey);
      }
      if (rackLocalRequest != null && !rackLocalRequest.getRelaxLocality()) {
        continue;
      }
      if (rackLocalRequest != null && rackLocalRequest.getNumContainers() != 0 && (allowedLocality.equals(NodeType.RACK_LOCAL) || allowedLocality.equals(NodeType.OFF_SWITCH))) {
        return assignContainer(node,rackLocalRequest,NodeType.RACK_LOCAL,reserved,schedulerKey);
      }
      ResourceRequest offSwitchRequest=getResourceRequest(schedulerKey,ResourceRequest.ANY);
      if (offSwitchRequest != null && !offSwitchRequest.getRelaxLocality()) {
        continue;
      }
      if (offSwitchRequest != null && offSwitchRequest.getNumContainers() != 0) {
        if (!hasNodeOrRackLocalRequests(schedulerKey) || allowedLocality.equals(NodeType.OFF_SWITCH)) {
          return assignContainer(node,offSwitchRequest,NodeType.OFF_SWITCH,reserved,schedulerKey);
        }
      }
    }
  }
  return Resources.none();
}
