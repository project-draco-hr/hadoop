{
  JobID jobID=JobID.forName(jobId);
  ApplicationId appID=Records.newRecord(ApplicationId.class);
  appID.setClusterTimestamp(Long.parseLong(jobID.getJtIdentifier()));
  appID.setId(jobID.getId());
  final String base=ContainerLocalizer.USERCACHE + "/" + user+ "/"+ ContainerLocalizer.APPCACHE+ "/"+ ConverterUtils.toString(appID)+ "/output"+ "/"+ mapId;
  if (LOG.isDebugEnabled()) {
    LOG.debug("DEBUG0 " + base);
  }
  Path indexFileName=lDirAlloc.getLocalPathToRead(base + "/file.out.index",conf);
  Path mapOutputFileName=lDirAlloc.getLocalPathToRead(base + "/file.out",conf);
  if (LOG.isDebugEnabled()) {
    LOG.debug("DEBUG1 " + base + " : "+ mapOutputFileName+ " : "+ indexFileName);
  }
  final IndexRecord info=indexCache.getIndexInformation(mapId,reduce,indexFileName,user);
  final ShuffleHeader header=new ShuffleHeader(mapId,info.partLength,info.rawLength,reduce);
  final DataOutputBuffer dob=new DataOutputBuffer();
  header.write(dob);
  ch.write(wrappedBuffer(dob.getData(),0,dob.getLength()));
  final File spillfile=new File(mapOutputFileName.toString());
  RandomAccessFile spill;
  try {
    spill=SecureIOUtils.openForRandomRead(spillfile,"r",user,null);
  }
 catch (  FileNotFoundException e) {
    LOG.info(spillfile + " not found");
    return null;
  }
  ChannelFuture writeFuture;
  if (ch.getPipeline().get(SslHandler.class) == null) {
    final FadvisedFileRegion partition=new FadvisedFileRegion(spill,info.startOffset,info.partLength,manageOsCache,readaheadLength,readaheadPool,spillfile.getAbsolutePath());
    writeFuture=ch.write(partition);
    writeFuture.addListener(new ChannelFutureListener(){
      @Override public void operationComplete(      ChannelFuture future){
        partition.releaseExternalResources();
      }
    }
);
  }
 else {
    final FadvisedChunkedFile chunk=new FadvisedChunkedFile(spill,info.startOffset,info.partLength,sslFileBufferSize,manageOsCache,readaheadLength,readaheadPool,spillfile.getAbsolutePath());
    writeFuture=ch.write(chunk);
  }
  metrics.shuffleConnections.incr();
  metrics.shuffleOutputBytes.incr(info.partLength);
  return writeFuture;
}
