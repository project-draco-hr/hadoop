{
  final String encryptionKeyVersionName=encryptedKeyVersion.getEncryptionKeyVersionName();
  final KeyVersion encryptionKey=keyProvider.getKeyVersion(encryptionKeyVersionName);
  Preconditions.checkNotNull(encryptionKey,"KeyVersion name '%s' does not exist",encryptionKeyVersionName);
  Preconditions.checkArgument(encryptedKeyVersion.getEncryptedKeyVersion().getVersionName().equals(KeyProviderCryptoExtension.EEK),"encryptedKey version name must be '%s', is '%s'",KeyProviderCryptoExtension.EEK,encryptedKeyVersion.getEncryptedKeyVersion().getVersionName());
  final byte[] encryptionKeyMaterial=encryptionKey.getMaterial();
  final byte[] encryptionIV=EncryptedKeyVersion.deriveIV(encryptedKeyVersion.getEncryptedKeyIv());
  Cipher cipher=Cipher.getInstance("AES/CTR/NoPadding");
  cipher.init(Cipher.DECRYPT_MODE,new SecretKeySpec(encryptionKeyMaterial,"AES"),new IvParameterSpec(encryptionIV));
  final KeyVersion encryptedKV=encryptedKeyVersion.getEncryptedKeyVersion();
  final byte[] decryptedKey=cipher.doFinal(encryptedKV.getMaterial());
  return new KeyVersion(encryptionKey.getName(),EK,decryptedKey);
}
