{
  while (namesystem.isRunning()) {
    NameNodeMetrics metrics=NameNode.getNameNodeMetrics();
    try {
      Runnable action=queue.take();
      int processed=0;
      namesystem.writeLock();
      metrics.setBlockOpsQueued(queue.size() + 1);
      try {
        long start=Time.monotonicNow();
        do {
          processed++;
          action.run();
          if (Time.monotonicNow() - start > MAX_LOCK_HOLD_MS) {
            break;
          }
          action=queue.poll();
        }
 while (action != null);
      }
  finally {
        namesystem.writeUnlock();
        metrics.addBlockOpsBatched(processed - 1);
      }
    }
 catch (    InterruptedException e) {
      if (Thread.interrupted()) {
        break;
      }
    }
  }
  queue.clear();
}
