{
  if (namesystem.isInSafeMode()) {
    return 0;
  }
  final int numlive=heartbeatManager.getLiveDatanodeCount();
  final int blocksToProcess=numlive * ReplicationMonitor.REPLICATION_WORK_MULTIPLIER_PER_ITERATION;
  final int nodesToProcess=(int)Math.ceil(numlive * ReplicationMonitor.INVALIDATE_WORK_PCT_PER_ITERATION / 100.0);
  int workFound=this.computeReplicationWork(blocksToProcess);
  namesystem.writeLock();
  try {
    this.updateState();
    this.scheduledReplicationBlocksCount=workFound;
  }
  finally {
    namesystem.writeUnlock();
  }
  workFound+=this.computeInvalidateWork(nodesToProcess);
  return workFound;
}
