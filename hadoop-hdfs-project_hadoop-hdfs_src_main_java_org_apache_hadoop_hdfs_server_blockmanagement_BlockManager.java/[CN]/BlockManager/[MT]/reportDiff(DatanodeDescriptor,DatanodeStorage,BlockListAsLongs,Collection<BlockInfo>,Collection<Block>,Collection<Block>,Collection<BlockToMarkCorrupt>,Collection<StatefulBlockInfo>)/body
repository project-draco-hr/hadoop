{
  dn.updateStorage(storage);
  for (Iterator<BlockInfo> it=dn.getBlockIterator(storage.getStorageID()); it.hasNext(); ) {
    toRemove.add(it.next());
  }
  if (newReport == null)   newReport=new BlockListAsLongs();
  BlockReportIterator itBR=newReport.getBlockReportIterator();
  while (itBR.hasNext()) {
    Block iblk=itBR.next();
    ReplicaState iState=itBR.getCurrentReplicaState();
    BlockInfo storedBlock=processReportedBlock(dn,storage.getStorageID(),iblk,iState,toAdd,toInvalidate,toCorrupt,toUC);
    if (storedBlock != null) {
      toRemove.remove(storedBlock);
    }
  }
}
