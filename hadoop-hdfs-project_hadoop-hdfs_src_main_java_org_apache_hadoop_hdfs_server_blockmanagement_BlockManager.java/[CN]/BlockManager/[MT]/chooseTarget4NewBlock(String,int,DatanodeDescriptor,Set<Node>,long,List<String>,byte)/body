{
  List<DatanodeDescriptor> favoredDatanodeDescriptors=getDatanodeDescriptors(favoredNodes);
  final BlockStoragePolicy storagePolicy=storagePolicySuite.getPolicy(storagePolicyID);
  final DatanodeStorageInfo[] targets=blockplacement.chooseTarget(src,numOfReplicas,client,excludedNodes,blocksize,favoredDatanodeDescriptors,storagePolicy);
  if (targets.length < minReplication) {
    throw new IOException("File " + src + " could only be replicated to "+ targets.length+ " nodes instead of minReplication (="+ minReplication+ ").  There are "+ getDatanodeManager().getNetworkTopology().getNumOfLeaves()+ " datanode(s) running and "+ (excludedNodes == null ? "no" : excludedNodes.size())+ " node(s) are excluded in this operation.");
  }
  return targets;
}
