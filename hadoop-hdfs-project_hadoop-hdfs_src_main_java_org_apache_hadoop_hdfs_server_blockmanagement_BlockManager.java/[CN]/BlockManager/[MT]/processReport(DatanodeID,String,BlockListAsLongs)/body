{
  namesystem.writeLock();
  final long startTime=Util.now();
  final long endTime;
  try {
    final DatanodeDescriptor node=datanodeManager.getDatanode(nodeID);
    if (node == null || !node.isAlive) {
      throw new IOException("ProcessReport from dead or unregistered node: " + nodeID);
    }
    if (namesystem.isInStartupSafeMode() && !node.isFirstBlockReport()) {
      NameNode.stateChangeLog.info("BLOCK* processReport: " + "discarded non-initial block report from " + nodeID + " because namenode still in startup phase");
      return;
    }
    if (node.numBlocks() == 0) {
      processFirstBlockReport(node,newReport);
    }
 else {
      processReport(node,newReport);
    }
    boolean staleBefore=node.areBlockContentsStale();
    node.receivedBlockReport();
    if (staleBefore && !node.areBlockContentsStale()) {
      LOG.info("BLOCK* processReport: " + "Received first block report from " + node + " after becoming active. Its block contents are no longer"+ " considered stale.");
      rescanPostponedMisreplicatedBlocks();
    }
  }
  finally {
    endTime=Util.now();
    namesystem.writeUnlock();
  }
  NameNode.getNameNodeMetrics().addBlockReport((int)(endTime - startTime));
  NameNode.stateChangeLog.info("BLOCK* processReport: from " + nodeID + ", blocks: "+ newReport.getNumberOfBlocks()+ ", processing time: "+ (endTime - startTime)+ " msecs");
}
