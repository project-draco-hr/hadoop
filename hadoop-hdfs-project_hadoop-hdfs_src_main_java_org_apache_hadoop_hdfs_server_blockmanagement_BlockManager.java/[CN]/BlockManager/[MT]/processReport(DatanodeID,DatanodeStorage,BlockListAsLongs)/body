{
  namesystem.writeLock();
  final long startTime=Time.now();
  final long endTime;
  DatanodeDescriptor node;
  Collection<Block> invalidatedBlocks=null;
  try {
    node=datanodeManager.getDatanode(nodeID);
    if (node == null || !node.isAlive) {
      throw new IOException("ProcessReport from dead or unregistered node: " + nodeID);
    }
    DatanodeStorageInfo storageInfo=node.getStorageInfo(storage.getStorageID());
    if (storageInfo == null) {
      storageInfo=node.updateStorage(storage);
    }
    if (namesystem.isInStartupSafeMode() && storageInfo.getBlockReportCount() > 0) {
      blockLog.info("BLOCK* processReport: " + "discarded non-initial block report from " + nodeID + " because namenode still in startup phase");
      return !node.hasStaleStorages();
    }
    if (storageInfo.numBlocks() == 0) {
      processFirstBlockReport(storageInfo,newReport);
    }
 else {
      invalidatedBlocks=processReport(storageInfo,newReport);
    }
    storageInfo.receivedBlockReport();
  }
  finally {
    endTime=Time.now();
    namesystem.writeUnlock();
  }
  if (invalidatedBlocks != null) {
    for (    Block b : invalidatedBlocks) {
      blockLog.info("BLOCK* processReport: " + b + " on "+ node+ " size "+ b.getNumBytes()+ " does not belong to any file");
    }
  }
  final NameNodeMetrics metrics=NameNode.getNameNodeMetrics();
  if (metrics != null) {
    metrics.addBlockReport((int)(endTime - startTime));
  }
  blockLog.info("BLOCK* processReport: from storage " + storage.getStorageID() + " node "+ nodeID+ ", blocks: "+ newReport.getNumberOfBlocks()+ ", hasStaleStorages: "+ node.hasStaleStorages()+ ", processing time: "+ (endTime - startTime)+ " msecs");
  return !node.hasStaleStorages();
}
