{
  namesystem.writeLock();
  int received=0;
  int deleted=0;
  try {
    final DatanodeDescriptor node=datanodeManager.getDatanode(nodeID);
    if (node == null || !node.isAlive) {
      NameNode.stateChangeLog.warn("BLOCK* blockReceivedDeleted" + " is received from dead or unregistered node " + nodeID.getName());
      throw new IOException("Got blockReceivedDeleted message from unregistered or dead node");
    }
    for (int i=0; i < receivedAndDeletedBlocks.length; i++) {
      if (receivedAndDeletedBlocks[i].isDeletedBlock()) {
        removeStoredBlock(receivedAndDeletedBlocks[i].getBlock(),node);
        deleted++;
      }
 else {
        addBlock(node,receivedAndDeletedBlocks[i].getBlock(),receivedAndDeletedBlocks[i].getDelHints());
        received++;
      }
      if (NameNode.stateChangeLog.isDebugEnabled()) {
        NameNode.stateChangeLog.debug("BLOCK* block" + (receivedAndDeletedBlocks[i].isDeletedBlock() ? "Deleted" : "Received") + ": "+ receivedAndDeletedBlocks[i].getBlock()+ " is received from "+ nodeID.getName());
      }
    }
  }
  finally {
    namesystem.writeUnlock();
    NameNode.stateChangeLog.debug("*BLOCK* NameNode.blockReceivedAndDeleted: " + "from " + nodeID.getName() + " received: "+ received+ ", "+ " deleted: "+ deleted);
  }
}
