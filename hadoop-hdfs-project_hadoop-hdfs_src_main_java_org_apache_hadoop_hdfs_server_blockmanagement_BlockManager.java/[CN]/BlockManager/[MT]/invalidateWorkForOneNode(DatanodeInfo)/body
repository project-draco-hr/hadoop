{
  final List<Block> toInvalidate;
  namesystem.writeLock();
  try {
    if (namesystem.isInSafeMode()) {
      LOG.debug("In safemode, not computing replication work");
      return 0;
    }
    try {
      toInvalidate=invalidateBlocks.invalidateWork(datanodeManager.getDatanode(dn));
      if (toInvalidate == null) {
        return 0;
      }
    }
 catch (    UnregisteredNodeException une) {
      return 0;
    }
  }
  finally {
    namesystem.writeUnlock();
  }
  if (blockLog.isInfoEnabled()) {
    blockLog.info("BLOCK* " + getClass().getSimpleName() + ": ask "+ dn+ " to delete "+ toInvalidate);
  }
  return toInvalidate.size();
}
