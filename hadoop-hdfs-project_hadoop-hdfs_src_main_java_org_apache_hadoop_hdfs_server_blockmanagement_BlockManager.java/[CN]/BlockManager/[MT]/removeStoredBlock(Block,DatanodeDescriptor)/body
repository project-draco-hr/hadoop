{
  blockLog.debug("BLOCK* removeStoredBlock: {} from {}",block,node);
  assert(namesystem.hasWriteLock());
{
    BlockInfo storedBlock=getStoredBlock(block);
    if (storedBlock == null || !blocksMap.removeNode(storedBlock,node)) {
      blockLog.debug("BLOCK* removeStoredBlock: {} has already been" + " removed from node {}",block,node);
      return;
    }
    BlockCollection bc=blocksMap.getBlockCollection(block);
    if (bc != null) {
      namesystem.decrementSafeBlockCount(storedBlock);
      updateNeededReplications(storedBlock,-1,0);
    }
    LightWeightLinkedSet<Block> excessBlocks=excessReplicateMap.get(node.getDatanodeUuid());
    if (excessBlocks != null) {
      if (excessBlocks.remove(block)) {
        excessBlocksCount.decrementAndGet();
        blockLog.debug("BLOCK* removeStoredBlock: {} is removed from " + "excessBlocks",block);
        if (excessBlocks.size() == 0) {
          excessReplicateMap.remove(node.getDatanodeUuid());
        }
      }
    }
    corruptReplicas.removeFromCorruptReplicasMap(block,node);
  }
}
