{
  if (blockLog.isDebugEnabled()) {
    blockLog.debug("BLOCK* removeStoredBlock: " + block + " from "+ node);
  }
  assert(namesystem.hasWriteLock());
{
    if (!blocksMap.removeNode(block,node)) {
      if (blockLog.isDebugEnabled()) {
        blockLog.debug("BLOCK* removeStoredBlock: " + block + " has already been removed from node "+ node);
      }
      return;
    }
    BlockCollection bc=blocksMap.getBlockCollection(block);
    if (bc != null) {
      namesystem.decrementSafeBlockCount(block);
      updateNeededReplications(block,-1,0);
    }
    LightWeightLinkedSet<Block> excessBlocks=excessReplicateMap.get(node.getDatanodeUuid());
    if (excessBlocks != null) {
      if (excessBlocks.remove(block)) {
        excessBlocksCount.decrementAndGet();
        if (blockLog.isDebugEnabled()) {
          blockLog.debug("BLOCK* removeStoredBlock: " + block + " is removed from excessBlocks");
        }
        if (excessBlocks.size() == 0) {
          excessReplicateMap.remove(node.getDatanodeUuid());
        }
      }
    }
    corruptReplicas.removeFromCorruptReplicasMap(block,node);
  }
}
