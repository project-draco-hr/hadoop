{
  if (NameNode.stateChangeLog.isDebugEnabled()) {
    NameNode.stateChangeLog.debug("BLOCK* removeStoredBlock: " + block + " from "+ node);
  }
  assert(namesystem.hasWriteLock());
{
    if (!blocksMap.removeNode(block,node)) {
      if (NameNode.stateChangeLog.isDebugEnabled()) {
        NameNode.stateChangeLog.debug("BLOCK* removeStoredBlock: " + block + " has already been removed from node "+ node);
      }
      return;
    }
    INodeFile fileINode=blocksMap.getINode(block);
    if (fileINode != null) {
      namesystem.decrementSafeBlockCount(block);
      updateNeededReplications(block,-1,0);
    }
    LightWeightLinkedSet<Block> excessBlocks=excessReplicateMap.get(node.getStorageID());
    if (excessBlocks != null) {
      if (excessBlocks.remove(block)) {
        excessBlocksCount--;
        if (NameNode.stateChangeLog.isDebugEnabled()) {
          NameNode.stateChangeLog.debug("BLOCK* removeStoredBlock: " + block + " is removed from excessBlocks");
        }
        if (excessBlocks.size() == 0) {
          excessReplicateMap.remove(node.getStorageID());
        }
      }
    }
    corruptReplicas.removeFromCorruptReplicasMap(block,node);
  }
}
