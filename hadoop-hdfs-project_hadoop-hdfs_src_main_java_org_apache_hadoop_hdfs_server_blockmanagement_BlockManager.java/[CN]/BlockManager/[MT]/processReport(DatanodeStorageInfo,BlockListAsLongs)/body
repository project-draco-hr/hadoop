{
  Collection<BlockInfoToAdd> toAdd=new LinkedList<>();
  Collection<BlockInfo> toRemove=new TreeSet<>();
  Collection<Block> toInvalidate=new LinkedList<>();
  Collection<BlockToMarkCorrupt> toCorrupt=new LinkedList<>();
  Collection<StatefulBlockInfo> toUC=new LinkedList<>();
  reportDiff(storageInfo,report,toAdd,toRemove,toInvalidate,toCorrupt,toUC);
  DatanodeDescriptor node=storageInfo.getDatanodeDescriptor();
  for (  StatefulBlockInfo b : toUC) {
    addStoredBlockUnderConstruction(b,storageInfo);
  }
  for (  BlockInfo b : toRemove) {
    removeStoredBlock(b,node);
  }
  int numBlocksLogged=0;
  for (  BlockInfoToAdd b : toAdd) {
    addStoredBlock(b.getStored(),b.getReported(),storageInfo,null,numBlocksLogged < maxNumBlocksToLog);
    numBlocksLogged++;
  }
  if (numBlocksLogged > maxNumBlocksToLog) {
    blockLog.info("BLOCK* processReport: logged info for {} of {} " + "reported.",maxNumBlocksToLog,numBlocksLogged);
  }
  for (  Block b : toInvalidate) {
    addToInvalidates(b,node);
  }
  for (  BlockToMarkCorrupt b : toCorrupt) {
    markBlockAsCorrupt(b,storageInfo,node);
  }
  return toInvalidate;
}
