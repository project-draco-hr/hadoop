{
  if (isBlockTokenEnabled()) {
    if (b.isStriped()) {
      Preconditions.checkState(b instanceof LocatedStripedBlock);
      LocatedStripedBlock sb=(LocatedStripedBlock)b;
      int[] indices=sb.getBlockIndices();
      Token<BlockTokenIdentifier>[] blockTokens=new Token[indices.length];
      ExtendedBlock internalBlock=new ExtendedBlock(b.getBlock());
      for (int i=0; i < indices.length; i++) {
        internalBlock.setBlockId(b.getBlock().getBlockId() + indices[i]);
        blockTokens[i]=blockTokenSecretManager.generateToken(NameNode.getRemoteUser().getShortUserName(),internalBlock,EnumSet.of(mode));
      }
      sb.setBlockTokens(blockTokens);
    }
 else {
      b.setBlockToken(blockTokenSecretManager.generateToken(NameNode.getRemoteUser().getShortUserName(),b.getBlock(),EnumSet.of(mode)));
    }
  }
}
