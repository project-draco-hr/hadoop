{
  if (blkIndex < 0) {
    return null;
  }
  BlockInfo curBlock=bc.getBlocks()[blkIndex];
  if (curBlock.isComplete()) {
    return curBlock;
  }
  int numNodes=curBlock.numNodes();
  if (!force && !checkMinStorage(curBlock,numNodes)) {
    throw new IOException("Cannot complete block: " + "block does not satisfy minimal replication requirement.");
  }
  if (!force && curBlock.getBlockUCState() != BlockUCState.COMMITTED) {
    throw new IOException("Cannot complete block: block has not been COMMITTED by the client");
  }
  final BlockInfo completeBlock=BlockInfo.convertToCompleteBlock(curBlock);
  bc.setBlock(blkIndex,completeBlock);
  namesystem.adjustSafeModeBlockTotals(0,1);
  namesystem.incrementSafeBlockCount(Math.min(numNodes,minReplication));
  return blocksMap.replaceBlock(completeBlock);
}
