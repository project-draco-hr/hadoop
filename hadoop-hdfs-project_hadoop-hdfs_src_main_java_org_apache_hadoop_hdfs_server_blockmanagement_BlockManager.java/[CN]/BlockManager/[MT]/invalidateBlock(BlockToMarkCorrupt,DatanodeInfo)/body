{
  NameNode.stateChangeLog.info("BLOCK* invalidateBlock: " + b + " on "+ dn);
  DatanodeDescriptor node=getDatanodeManager().getDatanode(dn);
  if (node == null) {
    throw new IOException("Cannot invalidate " + b + " because datanode "+ dn+ " does not exist.");
  }
  NumberReplicas nr=countNodes(b.stored);
  if (nr.replicasOnStaleNodes() > 0) {
    NameNode.stateChangeLog.info("BLOCK* invalidateBlocks: postponing " + "invalidation of " + b + " on "+ dn+ " because "+ nr.replicasOnStaleNodes()+ " replica(s) are located on nodes "+ "with potentially out-of-date block reports.");
    postponeBlock(b.corrupted);
  }
 else   if (nr.liveReplicas() >= 1) {
    addToInvalidates(b.corrupted,dn);
    removeStoredBlock(b.stored,node);
    if (NameNode.stateChangeLog.isDebugEnabled()) {
      NameNode.stateChangeLog.debug("BLOCK* invalidateBlocks: " + b + " on "+ dn+ " listed for deletion.");
    }
  }
 else {
    NameNode.stateChangeLog.info("BLOCK* invalidateBlocks: " + b + " on "+ dn+ " is the only copy and was not deleted.");
  }
}
