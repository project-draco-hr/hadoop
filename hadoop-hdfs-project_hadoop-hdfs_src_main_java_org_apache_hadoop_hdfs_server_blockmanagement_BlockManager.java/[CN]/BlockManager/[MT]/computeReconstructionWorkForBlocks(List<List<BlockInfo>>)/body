{
  int scheduledWork=0;
  List<BlockReconstructionWork> reconWork=new LinkedList<>();
  namesystem.writeLock();
  try {
synchronized (neededReconstruction) {
      for (int priority=0; priority < blocksToReconstruct.size(); priority++) {
        for (        BlockInfo block : blocksToReconstruct.get(priority)) {
          BlockReconstructionWork rw=scheduleReconstruction(block,priority);
          if (rw != null) {
            reconWork.add(rw);
          }
        }
      }
    }
  }
  finally {
    namesystem.writeUnlock();
  }
  final Set<Node> excludedNodes=new HashSet<>();
  for (  BlockReconstructionWork rw : reconWork) {
    excludedNodes.clear();
    for (    DatanodeDescriptor dn : rw.getContainingNodes()) {
      excludedNodes.add(dn);
    }
    final BlockPlacementPolicy placementPolicy=placementPolicies.getPolicy(rw.getBlock().isStriped());
    rw.chooseTargets(placementPolicy,storagePolicySuite,excludedNodes);
  }
  namesystem.writeLock();
  try {
    for (    BlockReconstructionWork rw : reconWork) {
      final DatanodeStorageInfo[] targets=rw.getTargets();
      if (targets == null || targets.length == 0) {
        rw.resetTargets();
        continue;
      }
synchronized (neededReconstruction) {
        if (validateReconstructionWork(rw)) {
          scheduledWork++;
        }
      }
    }
  }
  finally {
    namesystem.writeUnlock();
  }
  if (blockLog.isDebugEnabled()) {
    for (    BlockReconstructionWork rw : reconWork) {
      DatanodeStorageInfo[] targets=rw.getTargets();
      if (targets != null && targets.length != 0) {
        StringBuilder targetList=new StringBuilder("datanode(s)");
        for (        DatanodeStorageInfo target : targets) {
          targetList.append(' ');
          targetList.append(target.getDatanodeDescriptor());
        }
        blockLog.debug("BLOCK* ask {} to replicate {} to {}",rw.getSrcNodes(),rw.getBlock(),targetList);
      }
    }
    blockLog.debug("BLOCK* neededReconstruction = {} pendingReplications = {}",neededReconstruction.size(),pendingReplications.size());
  }
  return scheduledWork;
}
