{
  Map<String,LocalResource> localResources=new HashMap<String,LocalResource>();
  Map<String,String> environment=new HashMap<String,String>();
  Map<String,ByteBuffer> serviceData=new HashMap<String,ByteBuffer>();
  ByteBuffer tokens=ByteBuffer.wrap(new byte[]{});
  try {
    FileSystem remoteFS=FileSystem.get(conf);
    if (conf.get(MRJobConfig.JAR) != null) {
      Path remoteJobJar=(new Path(remoteTask.getConf().get(MRJobConfig.JAR))).makeQualified(remoteFS.getUri(),remoteFS.getWorkingDirectory());
      localResources.put(MRJobConfig.JOB_JAR,createLocalResource(remoteFS,recordFactory,remoteJobJar,LocalResourceType.FILE,LocalResourceVisibility.APPLICATION));
      LOG.info("The job-jar file on the remote FS is " + remoteJobJar.toUri().toASCIIString());
    }
 else {
      LOG.info("Job jar is not present. " + "Not adding any jar to the list of resources.");
    }
    Path path=MRApps.getStagingAreaDir(conf,UserGroupInformation.getCurrentUser().getShortUserName());
    Path remoteJobSubmitDir=new Path(path,oldJobId.toString());
    Path remoteJobConfPath=new Path(remoteJobSubmitDir,MRJobConfig.JOB_CONF_FILE);
    localResources.put(MRJobConfig.JOB_CONF_FILE,createLocalResource(remoteFS,recordFactory,remoteJobConfPath,LocalResourceType.FILE,LocalResourceVisibility.APPLICATION));
    LOG.info("The job-conf file on the remote FS is " + remoteJobConfPath.toUri().toASCIIString());
    MRApps.setupDistributedCache(conf,localResources);
    Credentials taskCredentials=new Credentials();
    if (UserGroupInformation.isSecurityEnabled()) {
      for (      Token<? extends TokenIdentifier> token : fsTokens) {
        LOG.info("Putting fs-token for NM use for launching container : " + token.toString());
        taskCredentials.addToken(token.getService(),token);
      }
    }
    TokenCache.setJobToken(jobToken,taskCredentials);
    DataOutputBuffer containerTokens_dob=new DataOutputBuffer();
    LOG.info("Size of containertokens_dob is " + taskCredentials.numberOfTokens());
    taskCredentials.writeTokenStorageToStream(containerTokens_dob);
    tokens=ByteBuffer.wrap(containerTokens_dob.getData(),0,containerTokens_dob.getLength());
    LOG.info("Putting shuffle token in serviceData");
    serviceData.put(ShuffleHandler.MAPREDUCE_SHUFFLE_SERVICEID,ShuffleHandler.serializeServiceData(jobToken));
    MRApps.addToEnvironment(environment,Environment.CLASSPATH.name(),getInitialClasspath());
  }
 catch (  IOException e) {
    throw new YarnException(e);
  }
  MapReduceChildJVM.setVMEnv(environment,remoteTask);
  List<String> commands=MapReduceChildJVM.getVMCommand(taskAttemptListener.getAddress(),remoteTask,jvmID);
  ContainerLaunchContext container=recordFactory.newRecordInstance(ContainerLaunchContext.class);
  container.setContainerId(containerID);
  container.setUser(conf.get(MRJobConfig.USER_NAME));
  container.setResource(assignedCapability);
  container.setLocalResources(localResources);
  container.setEnvironment(environment);
  container.setCommands(commands);
  container.setServiceData(serviceData);
  container.setContainerTokens(tokens);
  return container;
}
