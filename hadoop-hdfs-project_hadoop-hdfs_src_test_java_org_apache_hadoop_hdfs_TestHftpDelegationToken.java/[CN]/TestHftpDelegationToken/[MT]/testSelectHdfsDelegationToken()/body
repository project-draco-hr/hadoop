{
  SecurityUtilTestHelper.setTokenServiceUseIp(true);
  Configuration conf=new Configuration();
  URI hftpUri=URI.create("hftp://localhost:0");
  UserGroupInformation ugi=UserGroupInformation.getCurrentUser();
  Token<?> token=null;
  Token<?> hdfsToken=new Token<TokenIdentifier>(new byte[0],new byte[0],DelegationTokenIdentifier.HDFS_DELEGATION_KIND,new Text("127.0.0.1:8020"));
  ugi.addToken(hdfsToken);
  HftpFileSystem fs=(HftpFileSystem)FileSystem.get(hftpUri,conf);
  token=fs.selectDelegationToken();
  assertNotNull(token);
  assertEquals(hdfsToken,token);
  Token<?> hftpToken=new Token<TokenIdentifier>(new byte[0],new byte[0],HftpFileSystem.TOKEN_KIND,new Text("127.0.0.1:0"));
  ugi.addToken(hftpToken);
  token=fs.selectDelegationToken();
  assertNotNull(token);
  assertEquals(hftpToken,token);
  SecurityUtilTestHelper.setTokenServiceUseIp(false);
  token=fs.selectDelegationToken();
  assertNull(token);
  hdfsToken=new Token<TokenIdentifier>(new byte[0],new byte[0],DelegationTokenIdentifier.HDFS_DELEGATION_KIND,new Text("localhost:8020"));
  ugi.addToken(hdfsToken);
  token=fs.selectDelegationToken();
  assertNotNull(token);
  assertEquals(hdfsToken,token);
  hftpToken=new Token<TokenIdentifier>(new byte[0],new byte[0],HftpFileSystem.TOKEN_KIND,new Text("localhost:0"));
  ugi.addToken(hftpToken);
  token=fs.selectDelegationToken();
  assertNotNull(token);
  assertEquals(hftpToken,token);
}
