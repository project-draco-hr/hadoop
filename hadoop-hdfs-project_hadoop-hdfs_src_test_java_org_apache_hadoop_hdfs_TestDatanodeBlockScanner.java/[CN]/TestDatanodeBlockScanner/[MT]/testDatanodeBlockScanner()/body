{
  long startTime=Time.monotonicNow();
  Configuration conf=new HdfsConfiguration();
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).build();
  cluster.waitActive();
  FileSystem fs=cluster.getFileSystem();
  Path file1=new Path("/tmp/testBlockVerification/file1");
  Path file2=new Path("/tmp/testBlockVerification/file2");
  DFSTestUtil.createFile(fs,file1,10,(short)1,0);
  cluster.shutdown();
  cluster=new MiniDFSCluster.Builder(conf).numDataNodes(1).format(false).build();
  cluster.waitActive();
  DFSClient dfsClient=new DFSClient(new InetSocketAddress("localhost",cluster.getNameNodePort()),conf);
  fs=cluster.getFileSystem();
  DatanodeInfo dn=dfsClient.datanodeReport(DatanodeReportType.LIVE)[0];
  assertTrue(waitForVerification(dn.getInfoPort(),fs,file1,1,startTime,TIMEOUT) >= startTime);
  DFSTestUtil.createFile(fs,file2,10,(short)1,0);
  IOUtils.copyBytes(fs.open(file2),new IOUtils.NullOutputStream(),conf,true);
  assertTrue(waitForVerification(dn.getInfoPort(),fs,file2,2,startTime,TIMEOUT) >= startTime);
  cluster.shutdown();
}
