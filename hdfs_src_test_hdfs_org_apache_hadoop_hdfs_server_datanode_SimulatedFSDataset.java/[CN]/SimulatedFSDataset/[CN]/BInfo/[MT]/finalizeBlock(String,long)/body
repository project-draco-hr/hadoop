{
  if (finalized) {
    throw new IOException("Finalizing a block that has already been finalized" + theBlock.getBlockId());
  }
  if (oStream == null) {
    DataNode.LOG.error("Null oStream on unfinalized block - bug");
    throw new IOException("Unexpected error on finalize");
  }
  if (oStream.getLength() != finalSize) {
    DataNode.LOG.warn("Size passed to finalize (" + finalSize + ")does not match what was written:"+ oStream.getLength());
    throw new IOException("Size passed to finalize does not match the amount of data written");
  }
  long extraLen=finalSize - theBlock.getNumBytes();
  if (extraLen > 0) {
    if (!storage.alloc(bpid,extraLen)) {
      DataNode.LOG.warn("Lack of free storage on a block alloc");
      throw new IOException("Creating block, no free space available");
    }
  }
 else {
    storage.free(bpid,-extraLen);
  }
  theBlock.setNumBytes(finalSize);
  finalized=true;
  oStream=null;
  return;
}
