{
  Configuration conf=new HdfsConfiguration();
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).build();
  final FileSystem fs=cluster.getFileSystem();
  final Path p=new Path("/testHSyncBlockBoundary/foo");
  final int len=1 << 16;
  final byte[] fileContents=AppendTestUtil.initBuffer(len);
  FSDataOutputStream out=fs.create(p,FsPermission.getDefault(),EnumSet.of(CreateFlag.CREATE,CreateFlag.OVERWRITE,CreateFlag.SYNC_BLOCK),4096,(short)1,len,null);
  out.write(fileContents,0,len);
  out.hflush();
  checkSyncMetric(cluster,1);
  out.hsync();
  checkSyncMetric(cluster,1);
  out.write(1);
  out.hsync();
  checkSyncMetric(cluster,2);
  out.close();
  checkSyncMetric(cluster,3);
  cluster.shutdown();
}
