{
  File files[]=FileUtil.listFiles(dir);
  for (  File file : files) {
    if (!FsDatasetUtil.isUnlinkTmpFile(file)) {
      continue;
    }
    File blockFile=FsDatasetUtil.getOrigFile(file);
    if (blockFile.exists()) {
      if (!file.delete()) {
        throw new IOException("Unable to cleanup unlinked tmp file " + file);
      }
    }
 else {
      if (!file.renameTo(blockFile)) {
        throw new IOException("Unable to cleanup detached file " + file);
      }
    }
  }
}
