{
  BackupImage bnImage=(BackupImage)getFSImage();
  NNStorage storage=bnImage.getStorage();
  if (storage.getNamespaceID() == 0) {
    storage.setStorageInfo(nsInfo);
    storage.setBlockPoolID(nsInfo.getBlockPoolID());
    storage.setClusterID(nsInfo.getClusterID());
  }
 else {
    nsInfo.validateStorage(storage);
  }
  bnImage.initEditLog(StartupOption.REGULAR);
  setRegistration();
  NamenodeRegistration nnReg=null;
  while (!isStopRequested()) {
    try {
      nnReg=namenode.registerSubordinateNamenode(getRegistration());
      break;
    }
 catch (    SocketTimeoutException e) {
      LOG.info("Problem connecting to name-node: " + nnRpcAddress);
      try {
        Thread.sleep(1000);
      }
 catch (      InterruptedException ie) {
        LOG.warn("Encountered exception ",e);
      }
    }
  }
  String msg=null;
  if (nnReg == null)   msg="Registration rejected by " + nnRpcAddress;
 else   if (!nnReg.isRole(NamenodeRole.NAMENODE)) {
    msg="Name-node " + nnRpcAddress + " is not active";
  }
  if (msg != null) {
    msg+=". Shutting down.";
    LOG.error(msg);
    throw new IOException(msg);
  }
  nnRpcAddress=nnReg.getAddress();
}
