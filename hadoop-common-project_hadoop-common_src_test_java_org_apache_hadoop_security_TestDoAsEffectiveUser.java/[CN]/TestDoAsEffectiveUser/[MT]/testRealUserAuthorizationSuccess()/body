{
  final Configuration conf=new Configuration();
  configureSuperUserIPAddresses(conf,REAL_USER_SHORT_NAME);
  conf.setStrings(DefaultImpersonationProvider.getTestProvider().getProxySuperuserGroupConfKey(REAL_USER_SHORT_NAME),"group1");
  Server server=new RPC.Builder(conf).setProtocol(TestProtocol.class).setInstance(new TestImpl()).setBindAddress(ADDRESS).setPort(0).setNumHandlers(2).setVerbose(false).build();
  refreshConf(conf);
  try {
    server.start();
    UserGroupInformation realUserUgi=UserGroupInformation.createRemoteUser(REAL_USER_NAME);
    checkRemoteUgi(server,realUserUgi,conf);
    UserGroupInformation proxyUserUgi=UserGroupInformation.createProxyUserForTesting(PROXY_USER_NAME,realUserUgi,GROUP_NAMES);
    checkRemoteUgi(server,proxyUserUgi,conf);
  }
 catch (  Exception e) {
    e.printStackTrace();
    Assert.fail();
  }
 finally {
    server.stop();
    if (proxy != null) {
      RPC.stopProxy(proxy);
    }
  }
}
