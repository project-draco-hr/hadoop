{
  LOG.info("--- START: testResourceAllocation ---");
  final int memory=4 * 1024;
  String host1="host1";
  org.apache.hadoop.yarn.server.resourcemanager.NodeManager nm1=registerNode(host1,1234,2345,NetworkTopology.DEFAULT_RACK,memory);
  nm1.heartbeat();
  String host2="host2";
  org.apache.hadoop.yarn.server.resourcemanager.NodeManager nm2=registerNode(host2,1234,2345,NetworkTopology.DEFAULT_RACK,memory / 2);
  nm2.heartbeat();
  Application application=new Application("user1",resourceManager);
  application.submit();
  application.addNodeManager(host1,1234,nm1);
  application.addNodeManager(host2,1234,nm2);
  final int memory1=1024;
  Resource capability1=Resources.createResource(memory1);
  Priority priority1=org.apache.hadoop.yarn.server.resourcemanager.resource.Priority.create(1);
  application.addResourceRequestSpec(priority1,capability1);
  Task t1=new Task(application,priority1,new String[]{host1,host2});
  application.addTask(t1);
  final int memory2=2048;
  Resource capability2=Resources.createResource(memory2);
  Priority priority0=org.apache.hadoop.yarn.server.resourcemanager.resource.Priority.create(0);
  application.addResourceRequestSpec(priority0,capability2);
  application.schedule();
  nm1.heartbeat();
  application.schedule();
  nm1.heartbeat();
  checkResourceUsage(nm1,nm2);
  LOG.info("Adding new tasks...");
  Task t2=new Task(application,priority1,new String[]{host1,host2});
  application.addTask(t2);
  Task t3=new Task(application,priority0,new String[]{RMNode.ANY});
  application.addTask(t3);
  application.schedule();
  checkResourceUsage(nm1,nm2);
  LOG.info("Sending hb from host2");
  nm2.heartbeat();
  LOG.info("Sending hb from host1");
  nm1.heartbeat();
  LOG.info("Trying to allocate...");
  application.schedule();
  nm1.heartbeat();
  nm2.heartbeat();
  checkResourceUsage(nm1,nm2);
  LOG.info("Finishing up tasks...");
  application.finishTask(t1);
  application.finishTask(t2);
  application.finishTask(t3);
  nm1.heartbeat();
  nm2.heartbeat();
  checkResourceUsage(nm1,nm2);
  LOG.info("--- END: testResourceAllocation ---");
}
