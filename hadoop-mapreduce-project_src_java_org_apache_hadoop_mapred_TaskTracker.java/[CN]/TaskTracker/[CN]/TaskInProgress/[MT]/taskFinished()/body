{
  long start=System.currentTimeMillis();
  while (!done && (System.currentTimeMillis() - start < WAIT_FOR_DONE)) {
    try {
      Thread.sleep(1000);
    }
 catch (    InterruptedException ie) {
    }
  }
  boolean needCleanup=false;
synchronized (this) {
    if (done || !wasKilled) {
      removeFromMemoryManager(task.getTaskID());
    }
    if (!done) {
      if (!wasKilled) {
        failures+=1;
        setTaskFailState(true);
        if (debugCommand != null) {
          try {
            runDebugScript();
          }
 catch (          Exception e) {
            String msg="Debug-script could not be run successfully : " + StringUtils.stringifyException(e);
            LOG.warn(msg);
            reportDiagnosticInfo(msg);
          }
        }
      }
      taskStatus.setProgress(0.0f);
    }
    this.taskStatus.setFinishTime(System.currentTimeMillis());
    needCleanup=(taskStatus.getRunState() == TaskStatus.State.FAILED || taskStatus.getRunState() == TaskStatus.State.FAILED_UNCLEAN || taskStatus.getRunState() == TaskStatus.State.KILLED_UNCLEAN || taskStatus.getRunState() == TaskStatus.State.KILLED);
  }
  if (needCleanup) {
    removeTaskFromJob(task.getJobID(),this);
  }
  cleanup(needCleanup);
}
