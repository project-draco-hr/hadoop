{
  NodeStatus remoteNodeStatus=request.getNodeStatus();
  NodeId nodeId=remoteNodeStatus.getNodeId();
  if (!this.nodesListManager.isValidNode(nodeId.getHost())) {
    String message="Disallowed NodeManager nodeId: " + nodeId + " hostname: "+ nodeId.getHost();
    LOG.info(message);
    shutDown.setDiagnosticsMessage(message);
    return shutDown;
  }
  RMNode rmNode=this.rmContext.getRMNodes().get(nodeId);
  if (rmNode == null) {
    String message="Node not found resyncing " + remoteNodeStatus.getNodeId();
    LOG.info(message);
    resync.setDiagnosticsMessage(message);
    return resync;
  }
  this.nmLivelinessMonitor.receivedPing(nodeId);
  NodeHeartbeatResponse lastNodeHeartbeatResponse=rmNode.getLastNodeHeartBeatResponse();
  if (remoteNodeStatus.getResponseId() + 1 == lastNodeHeartbeatResponse.getResponseId()) {
    LOG.info("Received duplicate heartbeat from node " + rmNode.getNodeAddress() + " responseId="+ remoteNodeStatus.getResponseId());
    return lastNodeHeartbeatResponse;
  }
 else   if (remoteNodeStatus.getResponseId() + 1 < lastNodeHeartbeatResponse.getResponseId()) {
    String message="Too far behind rm response id:" + lastNodeHeartbeatResponse.getResponseId() + " nm response id:"+ remoteNodeStatus.getResponseId();
    LOG.info(message);
    resync.setDiagnosticsMessage(message);
    this.rmContext.getDispatcher().getEventHandler().handle(new RMNodeEvent(nodeId,RMNodeEventType.REBOOTING));
    return resync;
  }
  NodeHeartbeatResponse nodeHeartBeatResponse=YarnServerBuilderUtils.newNodeHeartbeatResponse(lastNodeHeartbeatResponse.getResponseId() + 1,NodeAction.NORMAL,null,null,null,null,nextHeartBeatInterval);
  rmNode.updateNodeHeartbeatResponseForCleanup(nodeHeartBeatResponse);
  populateKeys(request,nodeHeartBeatResponse);
  ConcurrentMap<ApplicationId,ByteBuffer> systemCredentials=rmContext.getSystemCredentialsForApps();
  if (!systemCredentials.isEmpty()) {
    nodeHeartBeatResponse.setSystemCredentialsForApps(systemCredentials);
  }
  this.rmContext.getDispatcher().getEventHandler().handle(new RMNodeStatusEvent(nodeId,remoteNodeStatus.getNodeHealthStatus(),remoteNodeStatus.getContainersStatuses(),remoteNodeStatus.getKeepAliveApplications(),nodeHeartBeatResponse));
  return nodeHeartBeatResponse;
}
