{
  Configuration conf=new HdfsConfiguration();
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(0).build();
  NNStorage mockStorage=Mockito.mock(NNStorage.class);
  List<File> localPaths=ImmutableList.of(new File("/xxxxx-does-not-exist/blah"),new File(TEST_DIR,"testfile"));
  try {
    URL fsName=DFSUtil.getInfoServer(cluster.getNameNode().getServiceRpcAddress(),conf,DFSUtil.getHttpClientScheme(conf)).toURL();
    String id="getimage=1&txid=0";
    TransferFsImage.getFileClient(fsName,id,localPaths,mockStorage,false);
    Mockito.verify(mockStorage).reportErrorOnFile(localPaths.get(0));
    assertTrue("The valid local file should get saved properly",localPaths.get(1).length() > 0);
  }
  finally {
    cluster.shutdown();
  }
}
