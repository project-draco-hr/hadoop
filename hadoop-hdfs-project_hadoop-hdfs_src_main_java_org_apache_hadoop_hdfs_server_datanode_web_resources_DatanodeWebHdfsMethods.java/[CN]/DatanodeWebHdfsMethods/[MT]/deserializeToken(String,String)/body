{
  final DataNode datanode=(DataNode)context.getAttribute("datanode");
  final Configuration conf=datanode.getConf();
  final Token<DelegationTokenIdentifier> token=new Token<DelegationTokenIdentifier>();
  token.decodeFromUrlString(delegation);
  URI nnUri=URI.create(HdfsConstants.HDFS_URI_SCHEME + "://" + nnId);
  boolean isLogical=HAUtil.isLogicalUri(conf,nnUri);
  if (isLogical) {
    token.setService(HAUtil.buildTokenServiceForLogicalUri(nnUri,HdfsConstants.HDFS_URI_SCHEME));
  }
 else {
    token.setService(SecurityUtil.buildTokenService(nnUri));
  }
  token.setKind(DelegationTokenIdentifier.HDFS_DELEGATION_KIND);
  return token;
}
