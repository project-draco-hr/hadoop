{
  final INodesInPath iip=fsdir.getINodesInPath4Write(file.toString());
  final INodeFile fileNode=iip.getLastINode().asFile();
  fileNode.recordModification(iip.getLatestSnapshotId(),true);
  final long diff=fileNode.computeQuotaDeltaForTruncate(newLength);
  Assert.assertEquals(expectedDiff,diff);
  dfs.truncate(file,newLength);
  TestFileTruncate.checkBlockRecovery(file,dfs);
  final INodeDirectory dirNode=fsdir.getINode4Write(dir.toString()).asDirectory();
  final long spaceUsed=dirNode.getDirectoryWithQuotaFeature().getSpaceConsumed().getStorageSpace();
  final long diskUsed=dirNode.getDirectoryWithQuotaFeature().getSpaceConsumed().getTypeSpaces().get(StorageType.DISK);
  Assert.assertEquals(expectedUsage,spaceUsed);
  Assert.assertEquals(expectedUsage,diskUsed);
}
