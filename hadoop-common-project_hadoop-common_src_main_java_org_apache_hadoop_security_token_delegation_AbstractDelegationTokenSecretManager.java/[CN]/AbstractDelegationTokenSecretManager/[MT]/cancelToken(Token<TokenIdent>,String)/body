{
  ByteArrayInputStream buf=new ByteArrayInputStream(token.getIdentifier());
  DataInputStream in=new DataInputStream(buf);
  TokenIdent id=createIdentifier();
  id.readFields(in);
  LOG.info("Token cancelation requested for identifier: " + id);
  if (id.getUser() == null) {
    throw new InvalidToken("Token with no owner");
  }
  String owner=id.getUser().getUserName();
  Text renewer=id.getRenewer();
  HadoopKerberosName cancelerKrbName=new HadoopKerberosName(canceller);
  String cancelerShortName=cancelerKrbName.getShortName();
  if (!canceller.equals(owner) && (renewer == null || renewer.toString().isEmpty() || !cancelerShortName.equals(renewer.toString()))) {
    throw new AccessControlException(canceller + " is not authorized to cancel the token");
  }
  DelegationTokenInformation info=currentTokens.remove(id);
  if (info == null) {
    throw new InvalidToken("Token not found");
  }
  removeStoredToken(id);
  return id;
}
