{
  boolean deleteNow=false;
  ArrayList<Block> collectedBlocks=new ArrayList<Block>();
  writeLock();
  try {
    if (isInSafeMode()) {
      throw new SafeModeException("Cannot delete " + src,safeMode);
    }
    if (!recursive && !dir.isDirEmpty(src)) {
      throw new IOException(src + " is non empty");
    }
    if (enforcePermission && isPermissionEnabled) {
      checkPermission(src,false,null,FsAction.WRITE,null,FsAction.ALL);
    }
    if (!dir.delete(src,collectedBlocks)) {
      return false;
    }
    deleteNow=collectedBlocks.size() <= BLOCK_DELETION_INCREMENT;
    if (deleteNow) {
      removeBlocks(collectedBlocks);
    }
  }
  finally {
    writeUnlock();
  }
  getEditLog().logSync();
  writeLock();
  try {
    if (!deleteNow) {
      removeBlocks(collectedBlocks);
    }
  }
  finally {
    writeUnlock();
  }
  collectedBlocks.clear();
  if (NameNode.stateChangeLog.isDebugEnabled()) {
    NameNode.stateChangeLog.debug("DIR* Namesystem.delete: " + src + " is removed");
  }
  return true;
}
