{
  String bpid=nn.getNamesystem().getBlockPoolId();
  BPOfferService bpos=null;
  for (  BPOfferService thisBpos : dn.getAllBpOs()) {
    if (thisBpos.getBlockPoolId().equals(bpid)) {
      bpos=thisBpos;
      break;
    }
  }
  Preconditions.checkArgument(bpos != null,"No such bpid: %s",bpid);
  BPServiceActor bpsa=null;
  for (  BPServiceActor thisBpsa : bpos.getBPServiceActors()) {
    if (thisBpsa.getNNSocketAddress().equals(nn.getServiceRpcAddress())) {
      bpsa=thisBpsa;
      break;
    }
  }
  Preconditions.checkArgument(bpsa != null,"No service actor to NN at %s",nn.getServiceRpcAddress());
  DatanodeProtocolClientSideTranslatorPB origNN=bpsa.getNameNodeProxy();
  DatanodeProtocolClientSideTranslatorPB spy=Mockito.spy(origNN);
  bpsa.setNameNode(spy);
  return spy;
}
