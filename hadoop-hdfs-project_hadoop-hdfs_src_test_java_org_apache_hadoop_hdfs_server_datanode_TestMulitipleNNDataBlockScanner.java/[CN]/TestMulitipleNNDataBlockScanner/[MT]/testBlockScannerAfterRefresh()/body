{
  setUp();
  try {
    Configuration dnConf=cluster.getDataNodes().get(0).getConf();
    Configuration conf=new HdfsConfiguration(dnConf);
    StringBuilder namenodesBuilder=new StringBuilder();
    String bpidToShutdown=cluster.getNamesystem(2).getBlockPoolId();
    for (int i=0; i < 2; i++) {
      String nsId=DFSUtil.getNamenodeNameServiceId(cluster.getConfiguration(i));
      namenodesBuilder.append(nsId);
      namenodesBuilder.append(",");
    }
    conf.set(DFSConfigKeys.DFS_FEDERATION_NAMESERVICES,namenodesBuilder.toString());
    DataNode dn=cluster.getDataNodes().get(0);
    dn.refreshNamenodes(conf);
    try {
      while (true) {
        dn.blockScanner.getBlocksScannedInLastRun(bpidToShutdown);
        Thread.sleep(1000);
      }
    }
 catch (    IOException ex) {
      LOG.info(ex.getMessage());
    }
    namenodesBuilder.append(DFSUtil.getNamenodeNameServiceId(cluster.getConfiguration(2)));
    conf.set(DFSConfigKeys.DFS_FEDERATION_NAMESERVICES,namenodesBuilder.toString());
    dn.refreshNamenodes(conf);
    for (int i=0; i < 3; i++) {
      long blocksScanned=0;
      while (blocksScanned != 20) {
        blocksScanned=dn.blockScanner.getBlocksScannedInLastRun(bpids[i]);
        LOG.info("Waiting for all blocks to be scanned for bpid=" + bpids[i] + "; Scanned so far="+ blocksScanned);
        Thread.sleep(5000);
      }
    }
  }
  finally {
    cluster.shutdown();
  }
}
