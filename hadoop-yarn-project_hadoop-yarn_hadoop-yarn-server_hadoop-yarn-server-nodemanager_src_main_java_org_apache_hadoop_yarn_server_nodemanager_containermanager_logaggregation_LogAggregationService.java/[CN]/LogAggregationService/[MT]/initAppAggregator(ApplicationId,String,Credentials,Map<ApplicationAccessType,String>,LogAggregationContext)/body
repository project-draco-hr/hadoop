{
  final UserGroupInformation userUgi=UserGroupInformation.createRemoteUser(user);
  if (credentials != null) {
    userUgi.addCredentials(credentials);
  }
  final AppLogAggregator appLogAggregator=new AppLogAggregatorImpl(this.dispatcher,this.deletionService,getConfig(),appId,userUgi,this.nodeId,dirsHandler,getRemoteNodeLogFileForApp(appId,user),appAcls,logAggregationContext,this.context,getLocalFileContext(getConfig()));
  if (this.appLogAggregators.putIfAbsent(appId,appLogAggregator) != null) {
    throw new YarnRuntimeException("Duplicate initApp for " + appId);
  }
  YarnRuntimeException appDirException=null;
  try {
    createAppDir(user,appId,userUgi);
  }
 catch (  Exception e) {
    appLogAggregator.disableLogAggregation();
    if (!(e instanceof YarnRuntimeException)) {
      appDirException=new YarnRuntimeException(e);
    }
 else {
      appDirException=(YarnRuntimeException)e;
    }
  }
  Runnable aggregatorWrapper=new Runnable(){
    public void run(){
      try {
        appLogAggregator.run();
      }
  finally {
        appLogAggregators.remove(appId);
        closeFileSystems(userUgi);
      }
    }
  }
;
  this.threadPool.execute(aggregatorWrapper);
  if (appDirException != null) {
    throw appDirException;
  }
}
