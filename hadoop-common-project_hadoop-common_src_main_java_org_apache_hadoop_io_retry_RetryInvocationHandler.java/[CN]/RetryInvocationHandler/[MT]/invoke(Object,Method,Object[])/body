{
  RetryPolicy policy=methodNameToPolicyMap.get(method.getName());
  if (policy == null) {
    policy=defaultPolicy;
  }
  int invocationFailoverCount=0;
  final boolean isRpc=isRpcInvocation(currentProxy.proxy);
  final int callId=isRpc ? Client.nextCallId() : RpcConstants.INVALID_CALL_ID;
  int retries=0;
  while (true) {
    long invocationAttemptFailoverCount;
synchronized (proxyProvider) {
      invocationAttemptFailoverCount=proxyProviderFailoverCount;
    }
    if (isRpc) {
      Client.setCallIdAndRetryCount(callId,retries);
    }
    try {
      Object ret=invokeMethod(method,args);
      hasMadeASuccessfulCall=true;
      return ret;
    }
 catch (    Exception ex) {
      if (Thread.currentThread().isInterrupted()) {
        throw ex;
      }
      boolean isIdempotentOrAtMostOnce=proxyProvider.getInterface().getMethod(method.getName(),method.getParameterTypes()).isAnnotationPresent(Idempotent.class);
      if (!isIdempotentOrAtMostOnce) {
        isIdempotentOrAtMostOnce=proxyProvider.getInterface().getMethod(method.getName(),method.getParameterTypes()).isAnnotationPresent(AtMostOnce.class);
      }
      List<RetryAction> actions=extractActions(policy,ex,retries++,invocationFailoverCount,isIdempotentOrAtMostOnce);
      RetryAction failAction=getFailAction(actions);
      if (failAction != null) {
        if (failAction.reason != null) {
          LOG.warn("Exception while invoking " + currentProxy.proxy.getClass() + "."+ method.getName()+ " over "+ currentProxy.proxyInfo+ ". Not retrying because "+ failAction.reason,ex);
        }
        throw ex;
      }
 else {
        boolean worthLogging=!(invocationFailoverCount == 0 && !hasMadeASuccessfulCall);
        worthLogging|=LOG.isDebugEnabled();
        RetryAction failOverAction=getFailOverAction(actions);
        long delay=getDelayMillis(actions);
        if (failOverAction != null && worthLogging) {
          String msg="Exception while invoking " + method.getName() + " of class "+ currentProxy.proxy.getClass().getSimpleName()+ " over "+ currentProxy.proxyInfo;
          if (invocationFailoverCount > 0) {
            msg+=" after " + invocationFailoverCount + " fail over attempts";
          }
          msg+=". Trying to fail over " + formatSleepMessage(delay);
          LOG.info(msg,ex);
        }
 else {
          if (LOG.isDebugEnabled()) {
            LOG.debug("Exception while invoking " + method.getName() + " of class "+ currentProxy.proxy.getClass().getSimpleName()+ " over "+ currentProxy.proxyInfo+ ". Retrying "+ formatSleepMessage(delay),ex);
          }
        }
        if (delay > 0) {
          Thread.sleep(delay);
        }
        if (failOverAction != null) {
synchronized (proxyProvider) {
            if (invocationAttemptFailoverCount == proxyProviderFailoverCount) {
              proxyProvider.performFailover(currentProxy.proxy);
              proxyProviderFailoverCount++;
            }
 else {
              LOG.warn("A failover has occurred since the start of this method" + " invocation attempt.");
            }
            currentProxy=proxyProvider.getProxy();
          }
          invocationFailoverCount++;
        }
      }
    }
  }
}
