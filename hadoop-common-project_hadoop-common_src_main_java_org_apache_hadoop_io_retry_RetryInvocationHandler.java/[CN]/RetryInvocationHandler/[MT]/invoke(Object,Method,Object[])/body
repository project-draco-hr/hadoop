{
  RetryPolicy policy=methodNameToPolicyMap.get(method.getName());
  if (policy == null) {
    policy=defaultPolicy;
  }
  int invocationFailoverCount=0;
  int retries=0;
  while (true) {
    long invocationAttemptFailoverCount;
synchronized (proxyProvider) {
      invocationAttemptFailoverCount=proxyProviderFailoverCount;
    }
    try {
      return invokeMethod(method,args);
    }
 catch (    Exception e) {
      boolean isMethodIdempotent=proxyProvider.getInterface().getMethod(method.getName(),method.getParameterTypes()).isAnnotationPresent(Idempotent.class);
      RetryAction action=policy.shouldRetry(e,retries++,invocationFailoverCount,isMethodIdempotent);
      if (action.action == RetryAction.RetryDecision.FAIL) {
        LOG.warn("Exception while invoking " + method.getName() + " of "+ currentProxy.getClass()+ ". Not retrying.",e);
        if (!method.getReturnType().equals(Void.TYPE)) {
          throw e;
        }
        return null;
      }
 else {
        if (action.delayMillis > 0) {
          ThreadUtil.sleepAtLeastIgnoreInterrupts(action.delayMillis);
        }
        if (action.action == RetryAction.RetryDecision.FAILOVER_AND_RETRY) {
          LOG.warn("Exception while invoking " + method.getName() + " of "+ currentProxy.getClass()+ " after "+ invocationFailoverCount+ " fail over attempts."+ " Trying to fail over.",e);
synchronized (proxyProvider) {
            if (invocationAttemptFailoverCount == proxyProviderFailoverCount) {
              proxyProvider.performFailover(currentProxy);
              proxyProviderFailoverCount++;
              currentProxy=proxyProvider.getProxy();
            }
 else {
              LOG.warn("A failover has occurred since the start of this method" + " invocation attempt.");
            }
          }
          invocationFailoverCount++;
        }
      }
      if (LOG.isDebugEnabled()) {
        LOG.debug("Exception while invoking " + method.getName() + " of "+ currentProxy.getClass()+ ". Retrying.",e);
      }
    }
  }
}
