{
  List<RecoveredContainerState> recoveredContainers=stateStore.loadContainersState();
  assertTrue(recoveredContainers.isEmpty());
  ApplicationId appId=ApplicationId.newInstance(1234,3);
  ApplicationAttemptId appAttemptId=ApplicationAttemptId.newInstance(appId,4);
  ContainerId containerId=ContainerId.newContainerId(appAttemptId,5);
  StartContainerRequest containerReq=createContainerRequest(containerId);
  stateStore.storeContainer(containerId,0,containerReq);
  DB db=stateStore.getDB();
  assertNull("version key present for new container",db.get(bytes(stateStore.getContainerVersionKey(containerId.toString()))));
  restartStateStore();
  recoveredContainers=stateStore.loadContainersState();
  assertEquals(1,recoveredContainers.size());
  RecoveredContainerState rcs=recoveredContainers.get(0);
  assertEquals(0,rcs.getVersion());
  assertEquals(RecoveredContainerStatus.REQUESTED,rcs.getStatus());
  assertEquals(ContainerExitStatus.INVALID,rcs.getExitCode());
  assertEquals(false,rcs.getKilled());
  assertEquals(containerReq,rcs.getStartRequest());
  assertTrue(rcs.getDiagnostics().isEmpty());
  ContainerId containerId1=ContainerId.newContainerId(appAttemptId,6);
  stateStore.storeContainerLaunched(containerId1);
  recoveredContainers=stateStore.loadContainersState();
  assertEquals(1,recoveredContainers.size());
  stateStore.storeContainerQueued(containerId);
  restartStateStore();
  recoveredContainers=stateStore.loadContainersState();
  assertEquals(1,recoveredContainers.size());
  rcs=recoveredContainers.get(0);
  assertEquals(RecoveredContainerStatus.QUEUED,rcs.getStatus());
  assertEquals(ContainerExitStatus.INVALID,rcs.getExitCode());
  assertEquals(false,rcs.getKilled());
  assertEquals(containerReq,rcs.getStartRequest());
  assertTrue(rcs.getDiagnostics().isEmpty());
  StringBuilder diags=new StringBuilder();
  stateStore.storeContainerLaunched(containerId);
  diags.append("some diags for container");
  stateStore.storeContainerDiagnostics(containerId,diags);
  restartStateStore();
  recoveredContainers=stateStore.loadContainersState();
  assertEquals(1,recoveredContainers.size());
  rcs=recoveredContainers.get(0);
  assertEquals(RecoveredContainerStatus.LAUNCHED,rcs.getStatus());
  assertEquals(ContainerExitStatus.INVALID,rcs.getExitCode());
  assertEquals(false,rcs.getKilled());
  assertEquals(containerReq,rcs.getStartRequest());
  assertEquals(diags.toString(),rcs.getDiagnostics());
  stateStore.storeContainerResourceChanged(containerId,2,Resource.newInstance(2468,4));
  restartStateStore();
  recoveredContainers=stateStore.loadContainersState();
  assertEquals(1,recoveredContainers.size());
  rcs=recoveredContainers.get(0);
  assertEquals(2,rcs.getVersion());
  assertEquals(RecoveredContainerStatus.LAUNCHED,rcs.getStatus());
  assertEquals(ContainerExitStatus.INVALID,rcs.getExitCode());
  assertEquals(false,rcs.getKilled());
  assertEquals(Resource.newInstance(2468,4),rcs.getCapability());
  diags.append("some more diags for container");
  stateStore.storeContainerDiagnostics(containerId,diags);
  stateStore.storeContainerKilled(containerId);
  restartStateStore();
  recoveredContainers=stateStore.loadContainersState();
  assertEquals(1,recoveredContainers.size());
  rcs=recoveredContainers.get(0);
  assertEquals(RecoveredContainerStatus.LAUNCHED,rcs.getStatus());
  assertEquals(ContainerExitStatus.INVALID,rcs.getExitCode());
  assertTrue(rcs.getKilled());
  assertEquals(containerReq,rcs.getStartRequest());
  assertEquals(diags.toString(),rcs.getDiagnostics());
  diags.append("some final diags");
  stateStore.storeContainerDiagnostics(containerId,diags);
  stateStore.storeContainerCompleted(containerId,21);
  restartStateStore();
  recoveredContainers=stateStore.loadContainersState();
  assertEquals(1,recoveredContainers.size());
  rcs=recoveredContainers.get(0);
  assertEquals(RecoveredContainerStatus.COMPLETED,rcs.getStatus());
  assertEquals(21,rcs.getExitCode());
  assertTrue(rcs.getKilled());
  assertEquals(containerReq,rcs.getStartRequest());
  assertEquals(diags.toString(),rcs.getDiagnostics());
  stateStore.storeContainerRemainingRetryAttempts(containerId,6);
  stateStore.storeContainerWorkDir(containerId,"/test/workdir");
  stateStore.storeContainerLogDir(containerId,"/test/logdir");
  restartStateStore();
  recoveredContainers=stateStore.loadContainersState();
  assertEquals(1,recoveredContainers.size());
  rcs=recoveredContainers.get(0);
  assertEquals(6,rcs.getRemainingRetryAttempts());
  assertEquals("/test/workdir",rcs.getWorkDir());
  assertEquals("/test/logdir",rcs.getLogDir());
  stateStore.removeContainer(containerId);
  restartStateStore();
  recoveredContainers=stateStore.loadContainersState();
  assertTrue(recoveredContainers.isEmpty());
}
