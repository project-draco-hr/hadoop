{
  final Configuration newConf=new Configuration(conf);
  newConf.set(SERVER_PRINCIPAL_KEY,principal);
  newConf.set(SERVER_KEYTAB_KEY,keytab);
  SecurityUtil.login(newConf,SERVER_KEYTAB_KEY,SERVER_PRINCIPAL_KEY);
  UserGroupInformation current=UserGroupInformation.getCurrentUser();
  System.out.println("UGI: " + current);
  Server server=RPC.getServer(TestSaslProtocol.class,new TestSaslImpl(),ADDRESS,0,5,true,newConf,null);
  TestSaslProtocol proxy=null;
  server.start();
  InetSocketAddress addr=NetUtils.getConnectAddress(server);
  try {
    proxy=(TestSaslProtocol)RPC.getProxy(TestSaslProtocol.class,TestSaslProtocol.versionID,addr,newConf);
    proxy.ping();
  }
  finally {
    server.stop();
    if (proxy != null) {
      RPC.stopProxy(proxy);
    }
  }
  System.out.println("Test is successful.");
}
