{
  try {
    final int available=fsdis.available();
    final byte[] buffer;
    final ByteArrayOutputStream baos;
    if (available < 0) {
      buffer=new byte[1024];
      baos=new ByteArrayOutputStream(buffer.length * 2);
    }
 else {
      buffer=new byte[available];
      baos=new ByteArrayOutputStream(available);
    }
    int readIntoBuffer=0;
    int read;
    while (true) {
      read=fsdis.read(buffer,readIntoBuffer,buffer.length - readIntoBuffer);
      if (read < 0) {
        if (readIntoBuffer > 0) {
          baos.write(buffer,0,readIntoBuffer);
        }
        return baos.toByteArray();
      }
 else {
        readIntoBuffer+=read;
        if (readIntoBuffer == buffer.length) {
          baos.write(buffer);
          readIntoBuffer=0;
        }
 else         if (readIntoBuffer > buffer.length) {
          throw new IOException("Read more than the buffer length: " + readIntoBuffer + ", buffer length = "+ buffer.length);
        }
      }
    }
  }
  finally {
    if (close) {
      fsdis.close();
    }
  }
}
