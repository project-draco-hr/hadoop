{
  RecoveredNMTokensState state=stateStore.loadNMTokensState();
  MasterKey key=state.getCurrentMasterKey();
  if (key != null) {
    super.currentMasterKey=new MasterKeyData(key,createSecretKey(key.getBytes().array()));
  }
  key=state.getPreviousMasterKey();
  if (key != null) {
    previousMasterKey=new MasterKeyData(key,createSecretKey(key.getBytes().array()));
  }
  if (super.currentMasterKey != null) {
    super.serialNo=super.currentMasterKey.getMasterKey().getKeyId() + 1;
  }
  for (  Map.Entry<ApplicationAttemptId,MasterKey> entry : state.getApplicationMasterKeys().entrySet()) {
    key=entry.getValue();
    oldMasterKeys.put(entry.getKey(),new MasterKeyData(key,createSecretKey(key.getBytes().array())));
  }
  appToAppAttemptMap.clear();
  for (  ApplicationAttemptId attempt : oldMasterKeys.keySet()) {
    ApplicationId app=attempt.getApplicationId();
    List<ApplicationAttemptId> attempts=appToAppAttemptMap.get(app);
    if (attempts == null) {
      attempts=new ArrayList<ApplicationAttemptId>();
      appToAppAttemptMap.put(app,attempts);
    }
    attempts.add(attempt);
  }
}
