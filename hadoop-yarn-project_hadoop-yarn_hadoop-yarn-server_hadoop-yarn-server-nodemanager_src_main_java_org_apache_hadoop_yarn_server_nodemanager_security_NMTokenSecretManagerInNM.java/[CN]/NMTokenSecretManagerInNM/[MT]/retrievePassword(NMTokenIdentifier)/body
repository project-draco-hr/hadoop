{
  int keyId=identifier.getMastKeyId();
  ApplicationAttemptId appAttemptId=identifier.getApplicationAttemptId();
  MasterKeyData oldMasterKey=oldMasterKeys.get(appAttemptId);
  MasterKeyData masterKeyToUse=oldMasterKey;
  if (previousMasterKey != null && keyId == previousMasterKey.getMasterKey().getKeyId()) {
    masterKeyToUse=previousMasterKey;
  }
 else   if (keyId == currentMasterKey.getMasterKey().getKeyId()) {
    masterKeyToUse=currentMasterKey;
  }
  if (masterKeyToUse != null) {
    byte[] password=retrivePasswordInternal(identifier,masterKeyToUse);
    if (masterKeyToUse.getMasterKey().getKeyId() != oldMasterKey.getMasterKey().getKeyId()) {
      oldMasterKeys.put(appAttemptId,masterKeyToUse);
    }
    return password;
  }
  throw new InvalidToken("Given NMToken for application : " + appAttemptId.toString() + " seems to have been generated illegally.");
}
