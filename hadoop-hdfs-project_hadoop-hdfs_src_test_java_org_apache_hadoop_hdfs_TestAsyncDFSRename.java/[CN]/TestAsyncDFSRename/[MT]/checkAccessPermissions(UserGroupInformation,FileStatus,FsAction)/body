{
  FsPermission perm=stat.getPermission();
  String user=ugi.getShortUserName();
  List<String> groups=Arrays.asList(ugi.getGroupNames());
  if (user.equals(stat.getOwner())) {
    if (perm.getUserAction().implies(mode)) {
      return;
    }
  }
 else   if (groups.contains(stat.getGroup())) {
    if (perm.getGroupAction().implies(mode)) {
      return;
    }
  }
 else {
    if (perm.getOtherAction().implies(mode)) {
      return;
    }
  }
  throw new AccessControlException(String.format("Permission denied: user=%s, path=\"%s\":%s:%s:%s%s",user,stat.getPath(),stat.getOwner(),stat.getGroup(),stat.isDirectory() ? "d" : "-",perm));
}
