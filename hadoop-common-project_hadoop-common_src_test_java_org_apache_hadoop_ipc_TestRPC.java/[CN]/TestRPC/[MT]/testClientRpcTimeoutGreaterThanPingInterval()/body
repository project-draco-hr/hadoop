{
  final Server server=new RPC.Builder(conf).setProtocol(TestProtocol.class).setInstance(new TestImpl()).setBindAddress(ADDRESS).setPort(0).setQueueSizePerHandler(1).setNumHandlers(1).setVerbose(true).build();
  server.start();
  final Configuration conf=new Configuration();
  conf.setBoolean(CommonConfigurationKeys.IPC_CLIENT_PING_KEY,true);
  conf.setInt(CommonConfigurationKeys.IPC_PING_INTERVAL_KEY,800);
  conf.setInt(CommonConfigurationKeys.IPC_CLIENT_RPC_TIMEOUT_KEY,1000);
  final TestProtocol proxy=RPC.getProxy(TestProtocol.class,TestProtocol.versionID,NetUtils.getConnectAddress(server),conf);
  proxy.sleep(300);
  proxy.sleep(1300);
  try {
    proxy.sleep(2000);
    fail("RPC should time out.");
  }
 catch (  SocketTimeoutException e) {
    LOG.info("got expected timeout.",e);
  }
 finally {
    server.stop();
    RPC.stopProxy(proxy);
  }
}
