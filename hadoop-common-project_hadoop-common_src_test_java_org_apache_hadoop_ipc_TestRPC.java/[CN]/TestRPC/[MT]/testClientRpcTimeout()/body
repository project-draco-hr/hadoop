{
  Server server;
  TestRpcService proxy=null;
  RPC.Builder builder=newServerBuilder(conf).setQueueSizePerHandler(1).setNumHandlers(1).setVerbose(true);
  server=setupTestServer(builder);
  try {
    try {
      Configuration c=new Configuration(conf);
      c.setInt(CommonConfigurationKeys.IPC_CLIENT_RPC_TIMEOUT_KEY,1000);
      proxy=getClient(addr,c);
      proxy.sleep(null,newSleepRequest(3000));
      fail("RPC should time out.");
    }
 catch (    ServiceException e) {
      assertTrue(e.getCause() instanceof SocketTimeoutException);
      LOG.info("got expected timeout.",e);
    }
    try {
      Configuration c=new Configuration(conf);
      c.setBoolean(CommonConfigurationKeys.IPC_CLIENT_PING_KEY,false);
      c.setInt(CommonConfigurationKeys.IPC_CLIENT_RPC_TIMEOUT_KEY,1000);
      proxy=getClient(addr,c);
      proxy.sleep(null,newSleepRequest(3000));
      fail("RPC should time out.");
    }
 catch (    ServiceException e) {
      assertTrue(e.getCause() instanceof SocketTimeoutException);
      LOG.info("got expected timeout.",e);
    }
    try {
      Configuration c=new Configuration(conf);
      c.setInt(CommonConfigurationKeys.IPC_CLIENT_RPC_TIMEOUT_KEY,-1);
      proxy=getClient(addr,c);
      proxy.sleep(null,newSleepRequest(2000));
    }
 catch (    ServiceException e) {
      LOG.info("got unexpected exception.",e);
      fail("RPC should not time out.");
    }
    try {
      Configuration c=new Configuration(conf);
      c.setBoolean(CommonConfigurationKeys.IPC_CLIENT_PING_KEY,true);
      c.setInt(CommonConfigurationKeys.IPC_PING_INTERVAL_KEY,800);
      c.setInt(CommonConfigurationKeys.IPC_CLIENT_RPC_TIMEOUT_KEY,1000);
      proxy=getClient(addr,c);
      try {
        proxy.sleep(null,newSleepRequest(1300));
      }
 catch (      ServiceException e) {
        LOG.info("got unexpected exception.",e);
        fail("RPC should not time out.");
      }
      proxy.sleep(null,newSleepRequest(2000));
      fail("RPC should time out.");
    }
 catch (    ServiceException e) {
      assertTrue(e.getCause() instanceof SocketTimeoutException);
      LOG.info("got expected timeout.",e);
    }
  }
  finally {
    stop(server,proxy);
  }
}
