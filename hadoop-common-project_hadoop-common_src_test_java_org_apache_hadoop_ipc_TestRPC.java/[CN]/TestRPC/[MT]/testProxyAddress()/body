{
  Server server=new RPC.Builder(conf).setProtocol(TestProtocol.class).setInstance(new TestImpl()).setBindAddress(ADDRESS).setPort(0).build();
  TestProtocol proxy=null;
  try {
    server.start();
    InetSocketAddress addr=NetUtils.getConnectAddress(server);
    proxy=(TestProtocol)RPC.getProxy(TestProtocol.class,TestProtocol.versionID,addr,conf);
    assertEquals(addr,RPC.getServerAddress(proxy));
  }
  finally {
    server.stop();
    if (proxy != null) {
      RPC.stopProxy(proxy);
    }
  }
}
