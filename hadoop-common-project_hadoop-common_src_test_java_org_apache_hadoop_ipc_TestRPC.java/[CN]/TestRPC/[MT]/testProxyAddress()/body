{
  Server server=RPC.getServer(TestProtocol.class,new TestImpl(),ADDRESS,0,conf);
  TestProtocol proxy=null;
  try {
    server.start();
    InetSocketAddress addr=NetUtils.getConnectAddress(server);
    proxy=(TestProtocol)RPC.getProxy(TestProtocol.class,TestProtocol.versionID,addr,conf);
    assertEquals(addr,RPC.getServerAddress(proxy));
  }
  finally {
    server.stop();
    if (proxy != null) {
      RPC.stopProxy(proxy);
    }
  }
}
