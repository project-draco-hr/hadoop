{
  final Configuration conf=new Configuration();
  Server server=new RPC.Builder(conf).setProtocol(TestProtocol.class).setInstance(new TestImpl()).setBindAddress(ADDRESS).setPort(0).setNumHandlers(5).setVerbose(true).setSecretManager(null).build();
  server.start();
  try {
    InetSocketAddress addr=NetUtils.getConnectAddress(server);
    final TestProtocol proxy=RPC.getProxy(TestProtocol.class,TestProtocol.versionID,addr,conf);
    proxy.ping();
    Thread.currentThread().interrupt();
    try {
      proxy.ping();
      fail("Interruption did not cause IPC to fail");
    }
 catch (    IOException ioe) {
      if (!ioe.toString().contains("InterruptedException")) {
        throw ioe;
      }
      Thread.interrupted();
    }
  }
  finally {
    server.stop();
  }
}
