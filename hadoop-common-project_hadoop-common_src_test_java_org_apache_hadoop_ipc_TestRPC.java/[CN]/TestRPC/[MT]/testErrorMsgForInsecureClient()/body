{
  Configuration serverConf=new Configuration(conf);
  SecurityUtil.setAuthenticationMethod(AuthenticationMethod.KERBEROS,serverConf);
  UserGroupInformation.setConfiguration(serverConf);
  final Server server=new RPC.Builder(serverConf).setProtocol(TestProtocol.class).setInstance(new TestImpl()).setBindAddress(ADDRESS).setPort(0).setNumHandlers(5).setVerbose(true).build();
  server.start();
  UserGroupInformation.setConfiguration(conf);
  boolean succeeded=false;
  final InetSocketAddress addr=NetUtils.getConnectAddress(server);
  TestProtocol proxy=null;
  try {
    proxy=RPC.getProxy(TestProtocol.class,TestProtocol.versionID,addr,conf);
    proxy.echo("");
  }
 catch (  RemoteException e) {
    LOG.info("LOGGING MESSAGE: " + e.getLocalizedMessage());
    assertTrue(e.unwrapRemoteException() instanceof AccessControlException);
    succeeded=true;
  }
 finally {
    server.stop();
    if (proxy != null) {
      RPC.stopProxy(proxy);
    }
  }
  assertTrue(succeeded);
  conf.setInt(CommonConfigurationKeys.IPC_SERVER_RPC_READ_THREADS_KEY,2);
  UserGroupInformation.setConfiguration(serverConf);
  final Server multiServer=new RPC.Builder(serverConf).setProtocol(TestProtocol.class).setInstance(new TestImpl()).setBindAddress(ADDRESS).setPort(0).setNumHandlers(5).setVerbose(true).build();
  multiServer.start();
  succeeded=false;
  final InetSocketAddress mulitServerAddr=NetUtils.getConnectAddress(multiServer);
  proxy=null;
  try {
    UserGroupInformation.setConfiguration(conf);
    proxy=RPC.getProxy(TestProtocol.class,TestProtocol.versionID,mulitServerAddr,conf);
    proxy.echo("");
  }
 catch (  RemoteException e) {
    LOG.info("LOGGING MESSAGE: " + e.getLocalizedMessage());
    assertTrue(e.unwrapRemoteException() instanceof AccessControlException);
    succeeded=true;
  }
 finally {
    multiServer.stop();
    if (proxy != null) {
      RPC.stopProxy(proxy);
    }
  }
  assertTrue(succeeded);
}
