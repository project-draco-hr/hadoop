{
  final Path test=new Path("/test");
  final Path dir1=new Path(test,"dir1");
  final Path dir2=new Path(test,"dir2");
  final Path subdir2=new Path(dir2,"subdir2");
  hdfs.mkdirs(dir1);
  hdfs.mkdirs(subdir2);
  final Path foo=new Path(dir1,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,dir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,dir2,"s2");
  hdfs.setQuota(dir2,5,Long.MAX_VALUE - 1);
  final Path foo2=new Path(subdir2,foo.getName());
  boolean rename=hdfs.rename(foo,foo2);
  assertFalse(rename);
  assertTrue(hdfs.exists(foo));
  assertTrue(hdfs.exists(bar));
  INodeDirectory dir1Node=fsdir.getINode4Write(dir1.toString()).asDirectory();
  List<INode> childrenList=ReadOnlyList.Util.asList(dir1Node.getChildrenList(null));
  assertEquals(1,childrenList.size());
  INode fooNode=childrenList.get(0);
  assertTrue(fooNode.getClass() == INodeDirectoryWithSnapshot.class);
  INode barNode=fsdir.getINode4Write(bar.toString());
  assertTrue(barNode.getClass() == INodeFile.class);
  assertSame(fooNode,barNode.getParent());
  List<DirectoryDiff> diffList=((INodeDirectorySnapshottable)dir1Node).getDiffs().asList();
  assertEquals(1,diffList.size());
  DirectoryDiff diff=diffList.get(0);
  assertTrue(diff.getChildrenDiff().getList(ListType.CREATED).isEmpty());
  assertTrue(diff.getChildrenDiff().getList(ListType.DELETED).isEmpty());
  INode dir2Node=fsdir.getINode4Write(dir2.toString());
  assertTrue(dir2Node.getClass() == INodeDirectorySnapshottable.class);
  Quota.Counts counts=dir2Node.computeQuotaUsage();
  assertEquals(3,counts.get(Quota.NAMESPACE));
  assertEquals(0,counts.get(Quota.DISKSPACE));
  childrenList=ReadOnlyList.Util.asList(dir2Node.asDirectory().getChildrenList(null));
  assertEquals(1,childrenList.size());
  INode subdir2Node=childrenList.get(0);
  assertSame(dir2Node,subdir2Node.getParent());
  assertSame(subdir2Node,fsdir.getINode4Write(subdir2.toString()));
  diffList=((INodeDirectorySnapshottable)dir2Node).getDiffs().asList();
  assertEquals(1,diffList.size());
  diff=diffList.get(0);
  assertTrue(diff.getChildrenDiff().getList(ListType.CREATED).isEmpty());
  assertTrue(diff.getChildrenDiff().getList(ListType.DELETED).isEmpty());
}
