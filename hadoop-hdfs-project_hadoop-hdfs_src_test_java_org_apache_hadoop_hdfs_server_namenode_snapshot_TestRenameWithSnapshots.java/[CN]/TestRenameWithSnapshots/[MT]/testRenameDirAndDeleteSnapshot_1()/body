{
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  final Path foo=new Path(sdir2,"foo");
  final Path bar=new Path(foo,"bar");
  final Path bar2=new Path(foo,"bar2");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  DFSTestUtil.createFile(hdfs,bar2,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  hdfs.createSnapshot(sdir1,"s3");
  final Path newfoo=new Path(sdir1,"foo");
  hdfs.rename(foo,newfoo);
  final Path newbar=new Path(newfoo,bar.getName());
  final Path newbar2=new Path(newfoo,bar2.getName());
  final Path newbar3=new Path(newfoo,"bar3");
  DFSTestUtil.createFile(hdfs,newbar3,BLOCKSIZE,REPL,SEED);
  hdfs.createSnapshot(sdir1,"s4");
  hdfs.delete(newbar,true);
  hdfs.delete(newbar3,true);
  assertFalse(hdfs.exists(newbar3));
  assertFalse(hdfs.exists(bar));
  final Path bar_s4=SnapshotTestHelper.getSnapshotPath(sdir1,"s4","foo/bar");
  final Path bar3_s4=SnapshotTestHelper.getSnapshotPath(sdir1,"s4","foo/bar3");
  assertTrue(hdfs.exists(bar_s4));
  assertTrue(hdfs.exists(bar3_s4));
  hdfs.createSnapshot(sdir1,"s5");
  hdfs.delete(newbar2,true);
  assertFalse(hdfs.exists(bar2));
  final Path bar2_s5=SnapshotTestHelper.getSnapshotPath(sdir1,"s5","foo/bar2");
  assertTrue(hdfs.exists(bar2_s5));
  hdfs.deleteSnapshot(sdir1,"s5");
  restartClusterAndCheckImage();
  assertFalse(hdfs.exists(bar2_s5));
  final Path bar2_s4=SnapshotTestHelper.getSnapshotPath(sdir1,"s4","foo/bar2");
  assertTrue(hdfs.exists(bar2_s4));
  hdfs.deleteSnapshot(sdir1,"s4");
  assertFalse(hdfs.exists(bar_s4));
  Path bar_s3=SnapshotTestHelper.getSnapshotPath(sdir1,"s3","foo/bar");
  assertFalse(hdfs.exists(bar_s3));
  bar_s3=SnapshotTestHelper.getSnapshotPath(sdir2,"s3","foo/bar");
  assertFalse(hdfs.exists(bar_s3));
  final Path bar_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo/bar");
  assertTrue(hdfs.exists(bar_s2));
  assertFalse(hdfs.exists(bar2_s4));
  Path bar2_s3=SnapshotTestHelper.getSnapshotPath(sdir1,"s3","foo/bar2");
  assertFalse(hdfs.exists(bar2_s3));
  bar2_s3=SnapshotTestHelper.getSnapshotPath(sdir2,"s3","foo/bar2");
  assertFalse(hdfs.exists(bar2_s3));
  final Path bar2_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo/bar2");
  assertTrue(hdfs.exists(bar2_s2));
  assertFalse(hdfs.exists(bar3_s4));
  Path bar3_s3=SnapshotTestHelper.getSnapshotPath(sdir1,"s3","foo/bar3");
  assertFalse(hdfs.exists(bar3_s3));
  bar3_s3=SnapshotTestHelper.getSnapshotPath(sdir2,"s3","foo/bar3");
  assertFalse(hdfs.exists(bar3_s3));
  final Path bar3_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo/bar3");
  assertFalse(hdfs.exists(bar3_s2));
  restartClusterAndCheckImage();
  hdfs.deleteSnapshot(sdir2,"s2");
  assertFalse(hdfs.exists(bar_s2));
  assertFalse(hdfs.exists(bar2_s2));
  restartClusterAndCheckImage();
  hdfs.deleteSnapshot(sdir1,"s3");
  restartClusterAndCheckImage();
  hdfs.deleteSnapshot(sdir1,"s1");
  restartClusterAndCheckImage();
}
