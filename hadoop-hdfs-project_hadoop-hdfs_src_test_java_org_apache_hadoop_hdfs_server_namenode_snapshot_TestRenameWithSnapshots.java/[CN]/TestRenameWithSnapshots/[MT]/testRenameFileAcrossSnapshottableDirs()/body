{
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  final Path foo=new Path(sdir2,"foo");
  DFSTestUtil.createFile(hdfs,foo,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  hdfs.createSnapshot(sdir1,"s3");
  final Path newfoo=new Path(sdir1,"foo");
  hdfs.rename(foo,newfoo);
  hdfs.setReplication(newfoo,REPL_1);
  final Path foo_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo");
  assertTrue(hdfs.exists(foo_s2));
  FileStatus status=hdfs.getFileStatus(foo_s2);
  assertEquals(REPL,status.getReplication());
  final Path foo_s3=SnapshotTestHelper.getSnapshotPath(sdir1,"s3","foo");
  assertFalse(hdfs.exists(foo_s3));
  INodeDirectory sdir2Node=fsdir.getINode(sdir2.toString()).asDirectory();
  Snapshot s2=sdir2Node.getSnapshot(DFSUtil.string2Bytes("s2"));
  INodeFile sfoo=fsdir.getINode(newfoo.toString()).asFile();
  assertEquals(s2.getId(),sfoo.getDiffs().getLastSnapshotId());
}
