{
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  final Path foo=new Path(sdir1,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  final Path dir2file=new Path(sdir2,"file");
  DFSTestUtil.createFile(hdfs,dir2file,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  INodeDirectory dir2=fsdir.getINode4Write(sdir2.toString()).asDirectory();
  INodeDirectory mockDir2=spy(dir2);
  doReturn(false).when(mockDir2).addChild((INode)anyObject(),anyBoolean(),Mockito.anyInt());
  INodeDirectory root=fsdir.getINode4Write("/").asDirectory();
  root.replaceChild(dir2,mockDir2,fsdir.getINodeMap());
  final Path newfoo=new Path(sdir2,"foo");
  boolean result=hdfs.rename(foo,newfoo);
  assertFalse(result);
  INodeDirectory dir1Node=fsdir.getINode4Write(sdir1.toString()).asDirectory();
  Snapshot s1=dir1Node.getSnapshot(DFSUtil.string2Bytes("s1"));
  ReadOnlyList<INode> dir1Children=dir1Node.getChildrenList(Snapshot.CURRENT_STATE_ID);
  assertEquals(1,dir1Children.size());
  assertEquals(foo.getName(),dir1Children.get(0).getLocalName());
  List<DirectoryDiff> dir1Diffs=dir1Node.getDiffs().asList();
  assertEquals(1,dir1Diffs.size());
  assertEquals(s1.getId(),dir1Diffs.get(0).getSnapshotId());
  ChildrenDiff childrenDiff=dir1Diffs.get(0).getChildrenDiff();
  assertEquals(0,childrenDiff.getList(ListType.DELETED).size());
  assertEquals(0,childrenDiff.getList(ListType.CREATED).size());
  INode fooNode=fsdir.getINode4Write(foo.toString());
  assertTrue(fooNode.isDirectory() && fooNode.asDirectory().isWithSnapshot());
  List<DirectoryDiff> fooDiffs=fooNode.asDirectory().getDiffs().asList();
  assertEquals(1,fooDiffs.size());
  assertEquals(s1.getId(),fooDiffs.get(0).getSnapshotId());
  final Path foo_s1=SnapshotTestHelper.getSnapshotPath(sdir1,"s1","foo");
  INode fooNode_s1=fsdir.getINode(foo_s1.toString());
  assertTrue(fooNode_s1 == fooNode);
  assertFalse(hdfs.exists(newfoo));
  INodeDirectory dir2Node=fsdir.getINode4Write(sdir2.toString()).asDirectory();
  assertFalse(dir2Node.isWithSnapshot());
  ReadOnlyList<INode> dir2Children=dir2Node.getChildrenList(Snapshot.CURRENT_STATE_ID);
  assertEquals(1,dir2Children.size());
  assertEquals(dir2file.getName(),dir2Children.get(0).getLocalName());
}
