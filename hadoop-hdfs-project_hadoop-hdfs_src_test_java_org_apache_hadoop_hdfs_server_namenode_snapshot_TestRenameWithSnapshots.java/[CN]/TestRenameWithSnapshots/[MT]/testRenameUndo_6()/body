{
  final Path test=new Path("/test");
  final Path dir1=new Path(test,"dir1");
  final Path dir2=new Path(test,"dir2");
  final Path sub_dir2=new Path(dir2,"subdir");
  final Path subsub_dir2=new Path(sub_dir2,"subdir");
  hdfs.mkdirs(dir1);
  hdfs.mkdirs(subsub_dir2);
  final Path foo=new Path(dir1,"foo");
  hdfs.mkdirs(foo);
  SnapshotTestHelper.createSnapshot(hdfs,dir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,dir2,"s2");
  hdfs.setQuota(dir2,4,Long.MAX_VALUE - 1);
  FSDirectory fsdir2=Mockito.spy(fsdir);
  Mockito.doThrow(new RuntimeException("fake exception")).when(fsdir2).removeLastINode((INodesInPath)Mockito.anyObject());
  Whitebox.setInternalState(fsn,"dir",fsdir2);
  try {
    hdfs.rename(foo,subsub_dir2,Rename.OVERWRITE);
    fail("Expect QuotaExceedException");
  }
 catch (  Exception e) {
    String msg="fake exception";
    GenericTestUtils.assertExceptionContains(msg,e);
  }
  assertTrue(hdfs.exists(foo));
  INodeDirectory dir1Node=fsdir2.getINode4Write(dir1.toString()).asDirectory();
  List<INode> childrenList=ReadOnlyList.Util.asList(dir1Node.getChildrenList(Snapshot.CURRENT_STATE_ID));
  assertEquals(1,childrenList.size());
  INode fooNode=childrenList.get(0);
  assertTrue(fooNode.asDirectory().isWithSnapshot());
  assertSame(dir1Node,fooNode.getParent());
  List<DirectoryDiff> diffList=dir1Node.getDiffs().asList();
  assertEquals(1,diffList.size());
  DirectoryDiff diff=diffList.get(0);
  assertTrue(diff.getChildrenDiff().getList(ListType.CREATED).isEmpty());
  assertTrue(diff.getChildrenDiff().getList(ListType.DELETED).isEmpty());
  INodeDirectory dir2Node=fsdir2.getINode4Write(dir2.toString()).asDirectory();
  assertTrue(dir2Node.isSnapshottable());
  QuotaCounts counts=dir2Node.computeQuotaUsage(fsdir.getBlockStoragePolicySuite());
  assertEquals(3,counts.getNameSpace());
  assertEquals(0,counts.getStorageSpace());
  childrenList=ReadOnlyList.Util.asList(dir2Node.asDirectory().getChildrenList(Snapshot.CURRENT_STATE_ID));
  assertEquals(1,childrenList.size());
  INode subdir2Node=childrenList.get(0);
  assertSame(dir2Node,subdir2Node.getParent());
  assertSame(subdir2Node,fsdir2.getINode4Write(sub_dir2.toString()));
  INode subsubdir2Node=fsdir2.getINode4Write(subsub_dir2.toString());
  assertTrue(subsubdir2Node.getClass() == INodeDirectory.class);
  assertSame(subdir2Node,subsubdir2Node.getParent());
  diffList=(dir2Node).getDiffs().asList();
  assertEquals(1,diffList.size());
  diff=diffList.get(0);
  assertTrue(diff.getChildrenDiff().getList(ListType.CREATED).isEmpty());
  assertTrue(diff.getChildrenDiff().getList(ListType.DELETED).isEmpty());
}
