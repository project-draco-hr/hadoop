{
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  final Path sdir3=new Path("/dir3");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  hdfs.mkdirs(sdir3);
  final Path foo=new Path(sdir1,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  INodeDirectory dir3=fsdir.getINode4Write(sdir3.toString()).asDirectory();
  INodeDirectory mockDir3=spy(dir3);
  doReturn(false).when(mockDir3).addChild((INode)anyObject(),anyBoolean(),(Snapshot)anyObject(),(INodeMap)anyObject());
  INodeDirectory root=fsdir.getINode4Write("/").asDirectory();
  root.replaceChild(dir3,mockDir3,fsdir.getINodeMap());
  final Path foo_dir2=new Path(sdir2,"foo2");
  final Path foo_dir3=new Path(sdir3,"foo3");
  hdfs.rename(foo,foo_dir2);
  boolean result=hdfs.rename(foo_dir2,foo_dir3);
  assertFalse(result);
  INodeDirectorySnapshottable dir2Node=(INodeDirectorySnapshottable)fsdir.getINode4Write(sdir2.toString());
  ReadOnlyList<INode> dir2Children=dir2Node.getChildrenList(null);
  assertEquals(1,dir2Children.size());
  List<DirectoryDiff> dir2Diffs=dir2Node.getDiffs().asList();
  assertEquals(1,dir2Diffs.size());
  assertEquals("s2",Snapshot.getSnapshotName(dir2Diffs.get(0).snapshot));
  ChildrenDiff childrenDiff=dir2Diffs.get(0).getChildrenDiff();
  assertEquals(0,childrenDiff.getList(ListType.DELETED).size());
  assertEquals(1,childrenDiff.getList(ListType.CREATED).size());
  final Path foo_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo2");
  assertFalse(hdfs.exists(foo_s2));
  INode fooNode=fsdir.getINode4Write(foo_dir2.toString());
  assertTrue(childrenDiff.getList(ListType.CREATED).get(0) == fooNode);
  assertTrue(fooNode instanceof INodeReference.DstReference);
  List<DirectoryDiff> fooDiffs=((INodeDirectoryWithSnapshot)fooNode.asDirectory()).getDiffs().asList();
  assertEquals(1,fooDiffs.size());
  assertEquals("s1",fooDiffs.get(0).snapshot.getRoot().getLocalName());
  hdfs.createSnapshot(sdir2,"s3");
  result=hdfs.rename(foo_dir2,foo_dir3);
  assertFalse(result);
  dir2Node=(INodeDirectorySnapshottable)fsdir.getINode4Write(sdir2.toString());
  fooNode=fsdir.getINode4Write(foo_dir2.toString());
  dir2Children=dir2Node.getChildrenList(null);
  assertEquals(1,dir2Children.size());
  dir2Diffs=dir2Node.getDiffs().asList();
  assertEquals(2,dir2Diffs.size());
  assertEquals("s2",Snapshot.getSnapshotName(dir2Diffs.get(0).snapshot));
  assertEquals("s3",Snapshot.getSnapshotName(dir2Diffs.get(1).snapshot));
  childrenDiff=dir2Diffs.get(0).getChildrenDiff();
  assertEquals(0,childrenDiff.getList(ListType.DELETED).size());
  assertEquals(1,childrenDiff.getList(ListType.CREATED).size());
  assertTrue(childrenDiff.getList(ListType.CREATED).get(0) == fooNode);
  childrenDiff=dir2Diffs.get(1).getChildrenDiff();
  assertEquals(0,childrenDiff.getList(ListType.DELETED).size());
  assertEquals(0,childrenDiff.getList(ListType.CREATED).size());
  final Path foo_s3=SnapshotTestHelper.getSnapshotPath(sdir2,"s3","foo2");
  assertFalse(hdfs.exists(foo_s2));
  assertTrue(hdfs.exists(foo_s3));
  assertTrue(fooNode instanceof INodeReference.DstReference);
  fooDiffs=((INodeDirectoryWithSnapshot)fooNode.asDirectory()).getDiffs().asList();
  assertEquals(2,fooDiffs.size());
  assertEquals("s1",fooDiffs.get(0).snapshot.getRoot().getLocalName());
  assertEquals("s3",fooDiffs.get(1).snapshot.getRoot().getLocalName());
}
