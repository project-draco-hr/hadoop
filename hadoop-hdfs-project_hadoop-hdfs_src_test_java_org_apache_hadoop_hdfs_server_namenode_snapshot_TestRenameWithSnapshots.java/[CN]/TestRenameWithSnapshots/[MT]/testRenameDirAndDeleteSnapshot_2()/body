{
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  final Path foo=new Path(sdir2,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s3");
  final Path newfoo=new Path(sdir1,"foo");
  hdfs.rename(foo,newfoo);
  restartClusterAndCheckImage();
  final Path bar2=new Path(newfoo,"bar2");
  DFSTestUtil.createFile(hdfs,bar2,BLOCKSIZE,REPL,SEED);
  hdfs.createSnapshot(sdir1,"s4");
  hdfs.delete(newfoo,true);
  final Path bar2_s4=SnapshotTestHelper.getSnapshotPath(sdir1,"s4","foo/bar2");
  assertTrue(hdfs.exists(bar2_s4));
  final Path bar_s4=SnapshotTestHelper.getSnapshotPath(sdir1,"s4","foo/bar");
  assertTrue(hdfs.exists(bar_s4));
  hdfs.deleteSnapshot(sdir1,"s4");
  restartClusterAndCheckImage();
  Path bar_s3=SnapshotTestHelper.getSnapshotPath(sdir1,"s3","foo/bar");
  assertFalse(hdfs.exists(bar_s3));
  bar_s3=SnapshotTestHelper.getSnapshotPath(sdir2,"s3","foo/bar");
  assertTrue(hdfs.exists(bar_s3));
  Path bar2_s3=SnapshotTestHelper.getSnapshotPath(sdir1,"s3","foo/bar2");
  assertFalse(hdfs.exists(bar2_s3));
  bar2_s3=SnapshotTestHelper.getSnapshotPath(sdir2,"s3","foo/bar2");
  assertFalse(hdfs.exists(bar2_s3));
  hdfs.deleteSnapshot(sdir2,"s3");
  final Path bar_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo/bar");
  assertTrue(hdfs.exists(bar_s2));
  final Path foo_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo");
  INodeReference fooRef=fsdir.getINode(foo_s2.toString()).asReference();
  assertTrue(fooRef instanceof INodeReference.WithName);
  INodeReference.WithCount fooWC=(WithCount)fooRef.getReferredINode();
  assertEquals(1,fooWC.getReferenceCount());
  INodeDirectoryWithSnapshot fooDir=(INodeDirectoryWithSnapshot)fooWC.getReferredINode().asDirectory();
  List<DirectoryDiff> diffs=fooDir.getDiffs().asList();
  assertEquals(1,diffs.size());
  assertEquals("s2",diffs.get(0).snapshot.getRoot().getLocalName());
  restartClusterAndCheckImage();
  hdfs.deleteSnapshot(sdir2,"s2");
  assertFalse(hdfs.exists(bar_s2));
  restartClusterAndCheckImage();
  assertEquals(4,fsdir.getRoot().getNamespace());
  assertEquals(0,fsdir.getRoot().getDiskspace());
  hdfs.deleteSnapshot(sdir1,"s1");
  restartClusterAndCheckImage();
  assertEquals(3,fsdir.getRoot().getNamespace());
  assertEquals(0,fsdir.getRoot().getDiskspace());
}
