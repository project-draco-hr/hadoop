{
  Path sub1=new Path(dir,"sub1");
  Path sub1file1=new Path(sub1,"sub1file1");
  Path sub1file2=new Path(sub1,"sub1file2");
  DFSTestUtil.createFile(hdfs,sub1file1,BLOCKSIZE,(short)1,seed);
  DFSTestUtil.createFile(hdfs,sub1file2,BLOCKSIZE,(short)1,seed);
  hdfs.allowSnapshot(dir);
  hdfs.createSnapshot(dir,"s0");
  HdfsDataOutputStream out=appendFileWithoutClosing(sub1file1,BLOCKSIZE);
  out.hsync(EnumSet.of(SyncFlag.UPDATE_LENGTH));
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
  hdfs.saveNamespace();
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
  cluster.shutdown();
  cluster=new MiniDFSCluster.Builder(conf).format(false).numDataNodes(NUM_DATANODES).build();
  cluster.waitActive();
  fsn=cluster.getNamesystem();
  hdfs=cluster.getFileSystem();
}
