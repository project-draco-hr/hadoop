{
  HdfsConfiguration conf=new HdfsConfiguration();
  conf.set(DFSConfigKeys.DFS_FEDERATION_NAMESERVICES,"nn1,nn2");
  Collection<String> nameserviceIds=DFSUtil.getNameServiceIds(conf);
  Iterator<String> it=nameserviceIds.iterator();
  assertEquals(2,nameserviceIds.size());
  assertEquals("nn1",it.next().toString());
  assertEquals("nn2",it.next().toString());
  conf.set(DFSConfigKeys.DFS_FEDERATION_NAMESERVICE_ID,"nn1");
  assertEquals("nn1",DFSUtil.getNameServiceId(conf));
  final String NN1_ADDRESS="localhost:9000";
  final String NN2_ADDRESS="localhost:9001";
  final String NN3_ADDRESS="localhost:9002";
  conf.set(DFSUtil.getNameServiceIdKey(DFSConfigKeys.DFS_NAMENODE_RPC_ADDRESS_KEY,"nn1"),NN1_ADDRESS);
  conf.set(DFSUtil.getNameServiceIdKey(DFSConfigKeys.DFS_NAMENODE_RPC_ADDRESS_KEY,"nn2"),NN2_ADDRESS);
  Collection<InetSocketAddress> nnAddresses=DFSUtil.getNNServiceRpcAddresses(conf);
  assertEquals(2,nnAddresses.size());
  Iterator<InetSocketAddress> iterator=nnAddresses.iterator();
  assertEquals(2,nameserviceIds.size());
  InetSocketAddress addr=iterator.next();
  assertEquals("localhost",addr.getHostName());
  assertEquals(9000,addr.getPort());
  addr=iterator.next();
  assertEquals("localhost",addr.getHostName());
  assertEquals(9001,addr.getPort());
  InetSocketAddress testAddress1=NetUtils.createSocketAddr(NN1_ADDRESS);
  String nameserviceId=DFSUtil.getNameServiceIdFromAddress(conf,testAddress1,DFSConfigKeys.DFS_NAMENODE_SERVICE_RPC_ADDRESS_KEY,DFSConfigKeys.DFS_NAMENODE_RPC_ADDRESS_KEY);
  assertEquals("nn1",nameserviceId);
  InetSocketAddress testAddress2=NetUtils.createSocketAddr(NN2_ADDRESS);
  nameserviceId=DFSUtil.getNameServiceIdFromAddress(conf,testAddress2,DFSConfigKeys.DFS_NAMENODE_SERVICE_RPC_ADDRESS_KEY,DFSConfigKeys.DFS_NAMENODE_RPC_ADDRESS_KEY);
  assertEquals("nn2",nameserviceId);
  InetSocketAddress testAddress3=NetUtils.createSocketAddr(NN3_ADDRESS);
  nameserviceId=DFSUtil.getNameServiceIdFromAddress(conf,testAddress3,DFSConfigKeys.DFS_NAMENODE_SERVICE_RPC_ADDRESS_KEY,DFSConfigKeys.DFS_NAMENODE_RPC_ADDRESS_KEY);
  assertNull(nameserviceId);
}
