{
  final int FETCHER=2;
  InMemoryMapOutput<Text,Text> immo=spy(new InMemoryMapOutput<Text,Text>(job,id,mm,100,null,true));
  when(mm.reserve(any(TaskAttemptID.class),anyLong(),anyInt())).thenReturn(immo);
  doNothing().when(mm).waitForResource();
  when(ss.getHost()).thenReturn(host);
  String replyHash=SecureShuffleUtils.generateHash(encHash.getBytes(),key);
  when(connection.getResponseCode()).thenReturn(200);
  when(connection.getHeaderField(ShuffleHeader.HTTP_HEADER_NAME)).thenReturn(ShuffleHeader.DEFAULT_HTTP_HEADER_NAME);
  when(connection.getHeaderField(ShuffleHeader.HTTP_HEADER_VERSION)).thenReturn(ShuffleHeader.DEFAULT_HTTP_HEADER_VERSION);
  when(connection.getHeaderField(SecureShuffleUtils.HTTP_HEADER_REPLY_URL_HASH)).thenReturn(replyHash);
  ShuffleHeader header=new ShuffleHeader(map1ID.toString(),10,10,1);
  ByteArrayOutputStream bout=new ByteArrayOutputStream();
  header.write(new DataOutputStream(bout));
  final StuckInputStream in=new StuckInputStream(new ByteArrayInputStream(bout.toByteArray()));
  when(connection.getInputStream()).thenReturn(in);
  doAnswer(new Answer<Void>(){
    public Void answer(    InvocationOnMock ignore) throws IOException {
      in.close();
      return null;
    }
  }
).when(connection).disconnect();
  Fetcher<Text,Text> underTest=new FakeFetcher<Text,Text>(job,id,ss,mm,r,metrics,except,key,connection,FETCHER);
  underTest.start();
  in.waitForFetcher();
  underTest.shutDown();
  underTest.join();
  assertTrue(in.wasClosedProperly());
  verify(immo).abort();
}
