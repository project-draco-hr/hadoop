{
  Configuration clientConf=new Configuration(conf);
  final long CLIENT_EXPIRY_MS=60000L;
  clientConf.setLong(DFS_CLIENT_SOCKET_CACHE_EXPIRY_MSEC_KEY,CLIENT_EXPIRY_MS);
  PeerCache.setInstance(DFS_CLIENT_SOCKET_CACHE_CAPACITY_DEFAULT,CLIENT_EXPIRY_MS);
  DistributedFileSystem fs=(DistributedFileSystem)FileSystem.get(cluster.getURI(),clientConf);
  DFSTestUtil.createFile(fs,TEST_FILE,1L,(short)1,0L);
  assertEquals(0,fs.dfs.peerCache.size());
  assertXceiverCount(0);
  DFSTestUtil.readFile(fs,TEST_FILE);
  assertEquals(1,fs.dfs.peerCache.size());
  assertXceiverCount(1);
  Thread.sleep(DFS_DATANODE_SOCKET_REUSE_KEEPALIVE_DEFAULT + 1);
  assertXceiverCount(0);
  assertEquals(1,fs.dfs.peerCache.size());
  Peer peer=fs.dfs.peerCache.get(dn.getDatanodeId(),false);
  assertNotNull(peer);
  assertEquals(-1,peer.getInputStream().read());
  PeerCache.setInstance(DFS_CLIENT_SOCKET_CACHE_CAPACITY_DEFAULT,DFS_DATANODE_SOCKET_REUSE_KEEPALIVE_DEFAULT);
}
