{
  DataNodeProperties props=cluster.stopDataNode(0);
  props.conf.setInt(DFS_DATANODE_SOCKET_WRITE_TIMEOUT_KEY,WRITE_TIMEOUT);
  props.conf.setInt(DFS_DATANODE_SOCKET_REUSE_KEEPALIVE_KEY,120000);
  assertTrue(cluster.restartDataNode(props,true));
  cluster.triggerHeartbeats();
  dn=cluster.getDataNodes().get(0);
  DFSTestUtil.createFile(fs,TEST_FILE,1024 * 1024 * 8L,(short)1,0L);
  FSDataInputStream stm=fs.open(TEST_FILE);
  try {
    stm.read();
    assertXceiverCount(1);
    long totalSleepTime=0;
    long sleepTime=WRITE_TIMEOUT + 100;
    while (getXceiverCountWithoutServer() > 0 && totalSleepTime < 5000) {
      Thread.sleep(sleepTime);
      totalSleepTime+=sleepTime;
      sleepTime=100;
    }
    assertXceiverCount(0);
  }
  finally {
    IOUtils.closeStream(stm);
  }
}
