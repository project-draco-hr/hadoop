{
  try {
    AccessControlContext context=AccessController.getContext();
    Subject subject=Subject.getSubject(context);
    if (subject == null) {
      subject=new Subject();
      LoginContext login=new LoginContext("",subject,null,new KerberosConfiguration());
      login.login();
    }
    Subject.doAs(subject,new PrivilegedExceptionAction<Void>(){
      @Override public Void run() throws Exception {
        GSSContext gssContext=null;
        try {
          GSSManager gssManager=GSSManager.getInstance();
          String servicePrincipal="HTTP/" + KerberosAuthenticator.this.url.getHost();
          GSSName serviceName=gssManager.createName(servicePrincipal,GSSName.NT_HOSTBASED_SERVICE);
          Oid oid=KerberosUtil.getOidClassInstance(servicePrincipal,gssManager);
          gssContext=gssManager.createContext(serviceName,oid,null,GSSContext.DEFAULT_LIFETIME);
          gssContext.requestCredDeleg(true);
          gssContext.requestMutualAuth(true);
          byte[] inToken=new byte[0];
          byte[] outToken;
          boolean established=false;
          while (!established) {
            outToken=gssContext.initSecContext(inToken,0,inToken.length);
            if (outToken != null) {
              sendToken(outToken);
            }
            if (!gssContext.isEstablished()) {
              inToken=readToken();
            }
 else {
              established=true;
            }
          }
        }
  finally {
          if (gssContext != null) {
            gssContext.dispose();
            gssContext=null;
          }
        }
        return null;
      }
    }
);
  }
 catch (  PrivilegedActionException ex) {
    throw new AuthenticationException(ex.getException());
  }
catch (  LoginException ex) {
    throw new AuthenticationException(ex);
  }
  AuthenticatedURL.extractToken(conn,token);
}
