{
  if (snapshots.size() + 1 > snapshotQuota) {
    throw new SnapshotException("Failed to add snapshot: there are already " + snapshots.size() + " snapshot(s) and the snapshot quota is "+ snapshotQuota);
  }
  final Snapshot s=new Snapshot(id,name,this);
  final byte[] nameBytes=s.getRoot().getLocalNameBytes();
  final int i=searchSnapshot(nameBytes);
  if (i >= 0) {
    throw new SnapshotException("Failed to add snapshot: there is already a " + "snapshot with the same name \"" + name + "\".");
  }
  snapshots.add(s);
  snapshotsByNames.add(-i - 1,s);
  final long timestamp=Time.now();
  s.getRoot().setModificationTime(timestamp);
  setModificationTime(timestamp);
  return s;
}
