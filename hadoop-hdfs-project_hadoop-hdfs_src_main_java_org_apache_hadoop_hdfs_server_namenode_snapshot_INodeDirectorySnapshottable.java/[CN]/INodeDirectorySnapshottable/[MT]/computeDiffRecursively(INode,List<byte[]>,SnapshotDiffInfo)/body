{
  ChildrenDiff diff=new ChildrenDiff();
  byte[][] relativePath=parentPath.toArray(new byte[parentPath.size()][]);
  if (node.isDirectory()) {
    INodeDirectory dir=node.asDirectory();
    DirectoryWithSnapshotFeature sf=dir.getDirectoryWithSnapshotFeature();
    if (sf != null) {
      boolean change=sf.computeDiffBetweenSnapshots(diffReport.from,diffReport.to,diff,dir);
      if (change) {
        diffReport.addDirDiff(dir,relativePath,diff);
      }
    }
    ReadOnlyList<INode> children=dir.getChildrenList(diffReport.isFromEarlier() ? diffReport.to : diffReport.from);
    for (    INode child : children) {
      final byte[] name=child.getLocalNameBytes();
      if (diff.searchIndex(ListType.CREATED,name) < 0 && diff.searchIndex(ListType.DELETED,name) < 0) {
        parentPath.add(name);
        computeDiffRecursively(child,parentPath,diffReport);
        parentPath.remove(parentPath.size() - 1);
      }
    }
  }
 else   if (node.isFile() && node.asFile().isWithSnapshot()) {
    INodeFile file=node.asFile();
    Snapshot earlierSnapshot=diffReport.isFromEarlier() ? diffReport.from : diffReport.to;
    Snapshot laterSnapshot=diffReport.isFromEarlier() ? diffReport.to : diffReport.from;
    boolean change=file.getDiffs().changedBetweenSnapshots(earlierSnapshot,laterSnapshot);
    if (change) {
      diffReport.addFileDiff(file,relativePath);
    }
  }
}
