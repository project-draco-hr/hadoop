{
  T proxy=(T)Proxy.newProxyInstance(protocol.getClassLoader(),new Class[]{protocol},new Invoker(protocol,addr,ticket,conf,factory,rpcTimeout));
  int[] serverMethods=null;
  if (proxy instanceof VersionedProtocol) {
    ProtocolSignature serverInfo=((VersionedProtocol)proxy).getProtocolSignature(protocol.getName(),clientVersion,ProtocolSignature.getFingerprint(protocol.getMethods()));
    long serverVersion=serverInfo.getVersion();
    if (serverVersion != clientVersion) {
      throw new RPC.VersionMismatch(protocol.getName(),clientVersion,serverVersion);
    }
    serverMethods=serverInfo.getMethods();
  }
  return new ProtocolProxy<T>(protocol,proxy,serverMethods);
}
