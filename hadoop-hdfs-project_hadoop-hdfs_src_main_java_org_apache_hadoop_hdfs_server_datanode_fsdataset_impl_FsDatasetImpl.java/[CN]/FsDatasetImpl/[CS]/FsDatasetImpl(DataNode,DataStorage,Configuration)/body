{
  this.fsRunning=true;
  this.datanode=datanode;
  this.dataStorage=storage;
  this.conf=conf;
  this.smallBufferSize=DFSUtilClient.getSmallBufferSize(conf);
  this.datasetLock=new AutoCloseableLock();
  volFailuresTolerated=datanode.getDnConf().getVolFailuresTolerated();
  Collection<StorageLocation> dataLocations=DataNode.getStorageLocations(conf);
  List<VolumeFailureInfo> volumeFailureInfos=getInitialVolumeFailureInfos(dataLocations,storage);
  int volsConfigured=datanode.getDnConf().getVolsConfigured();
  int volsFailed=volumeFailureInfos.size();
  if (volsFailed > volFailuresTolerated) {
    throw new DiskErrorException("Too many failed volumes - " + "current valid volumes: " + storage.getNumStorageDirs() + ", volumes configured: "+ volsConfigured+ ", volumes failed: "+ volsFailed+ ", volume failures tolerated: "+ volFailuresTolerated);
  }
  storageMap=new ConcurrentHashMap<String,DatanodeStorage>();
  volumeMap=new ReplicaMap(this);
  ramDiskReplicaTracker=RamDiskReplicaTracker.getInstance(conf,this);
  @SuppressWarnings("unchecked") final VolumeChoosingPolicy<FsVolumeImpl> blockChooserImpl=ReflectionUtils.newInstance(conf.getClass(DFSConfigKeys.DFS_DATANODE_FSDATASET_VOLUME_CHOOSING_POLICY_KEY,RoundRobinVolumeChoosingPolicy.class,VolumeChoosingPolicy.class),conf);
  volumes=new FsVolumeList(volumeFailureInfos,datanode.getBlockScanner(),blockChooserImpl);
  asyncDiskService=new FsDatasetAsyncDiskService(datanode,this);
  asyncLazyPersistService=new RamDiskAsyncLazyPersistService(datanode,conf);
  deletingBlock=new HashMap<String,Set<Long>>();
  for (int idx=0; idx < storage.getNumStorageDirs(); idx++) {
    addVolume(dataLocations,storage.getStorageDir(idx));
  }
  setupAsyncLazyPersistThreads();
  cacheManager=new FsDatasetCache(this);
  if (ramDiskReplicaTracker.numReplicasNotPersisted() > 0 || datanode.getDnConf().getMaxLockedMemory() > 0) {
    lazyWriter=new Daemon(new LazyWriter(conf));
    lazyWriter.start();
  }
 else {
    lazyWriter=null;
  }
  registerMBean(datanode.getDatanodeUuid());
  MetricsSystem ms=DefaultMetricsSystem.instance();
  ms.register("FSDatasetState","FSDatasetState",this);
  localFS=FileSystem.getLocal(conf);
  blockPinningEnabled=conf.getBoolean(DFSConfigKeys.DFS_DATANODE_BLOCK_PINNING_ENABLED,DFSConfigKeys.DFS_DATANODE_BLOCK_PINNING_ENABLED_DEFAULT);
  maxDataLength=conf.getInt(CommonConfigurationKeys.IPC_MAXIMUM_DATA_LENGTH,CommonConfigurationKeys.IPC_MAXIMUM_DATA_LENGTH_DEFAULT);
}
