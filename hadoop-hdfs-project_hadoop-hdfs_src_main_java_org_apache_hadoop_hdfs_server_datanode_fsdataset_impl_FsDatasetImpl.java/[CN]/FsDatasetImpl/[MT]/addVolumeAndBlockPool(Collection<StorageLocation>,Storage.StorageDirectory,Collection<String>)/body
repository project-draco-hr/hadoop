{
  final File dir=sd.getCurrentDir();
  final StorageType storageType=getStorageTypeFromLocations(dataLocations,sd.getRoot());
  final FsVolumeImpl fsVolume=new FsVolumeImpl(this,sd.getStorageUuid(),dir,this.conf,storageType);
  final ReplicaMap tempVolumeMap=new ReplicaMap(fsVolume);
  List<IOException> exceptions=Lists.newArrayList();
  for (  final String bpid : bpids) {
    try {
      fsVolume.addBlockPool(bpid,this.conf);
      fsVolume.getVolumeMap(bpid,tempVolumeMap,lazyWriteReplicaTracker);
    }
 catch (    IOException e) {
      LOG.warn("Caught exception when adding " + fsVolume + ". Will throw later.",e);
      exceptions.add(e);
    }
  }
  if (!exceptions.isEmpty()) {
    throw MultipleIOException.createIOException(exceptions);
  }
  volumeMap.addAll(tempVolumeMap);
  storageMap.put(sd.getStorageUuid(),new DatanodeStorage(sd.getStorageUuid(),DatanodeStorage.State.NORMAL,storageType));
  asyncDiskService.addVolume(sd.getCurrentDir());
  volumes.addVolume(fsVolume);
  LOG.info("Added volume - " + dir + ", StorageType: "+ storageType);
}
