{
  ReplicaInfo replicaInfo=volumeMap.get(b.getBlockPoolId(),b.getBlockId());
  if (replicaInfo != null) {
    if (replicaInfo.getGenerationStamp() < b.getGenerationStamp() && replicaInfo instanceof ReplicaInPipeline) {
      ((ReplicaInPipeline)replicaInfo).stopWriter(datanode.getDnConf().getXceiverStopTimeout());
      invalidate(b.getBlockPoolId(),new Block[]{replicaInfo});
    }
 else {
      throw new ReplicaAlreadyExistsException("Block " + b + " already exists in state "+ replicaInfo.getState()+ " and thus cannot be created.");
    }
  }
  FsVolumeReference ref=volumes.getNextVolume(storageType,b.getNumBytes());
  FsVolumeImpl v=(FsVolumeImpl)ref.getVolume();
  File f;
  try {
    f=v.createTmpFile(b.getBlockPoolId(),b.getLocalBlock());
  }
 catch (  IOException e) {
    IOUtils.cleanup(null,ref);
    throw e;
  }
  ReplicaInPipeline newReplicaInfo=new ReplicaInPipeline(b.getBlockId(),b.getGenerationStamp(),v,f.getParentFile(),0);
  volumeMap.add(b.getBlockPoolId(),newReplicaInfo);
  return new ReplicaHandler(newReplicaInfo,ref);
}
