{
  ReplicaInfo replicaInfo=getReplicaInfo(block);
  if (replicaInfo.getState() != ReplicaState.FINALIZED) {
    throw new ReplicaNotFoundException(ReplicaNotFoundException.UNFINALIZED_REPLICA + block);
  }
  if (replicaInfo.getNumBytes() != block.getNumBytes()) {
    throw new IOException("Corrupted replica " + replicaInfo + " with a length of "+ replicaInfo.getNumBytes()+ " expected length is "+ block.getNumBytes());
  }
  if (replicaInfo.getVolume().getStorageType() == targetStorageType) {
    throw new ReplicaAlreadyExistsException("Replica " + replicaInfo + " already exists on storage "+ targetStorageType);
  }
  if (replicaInfo.isOnTransientStorage()) {
    throw new IOException("Replica " + replicaInfo + " cannot be moved from storageType : "+ replicaInfo.getVolume().getStorageType());
  }
  FsVolumeReference volumeRef=null;
  try (AutoCloseableLock lock=datasetLock.acquire()){
    volumeRef=volumes.getNextVolume(targetStorageType,block.getNumBytes());
  }
   try {
    moveBlock(block,replicaInfo,volumeRef);
  }
  finally {
    if (volumeRef != null) {
      volumeRef.close();
    }
  }
  return replicaInfo;
}
