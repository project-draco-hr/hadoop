{
  ReplicaInfo replicaInfo=volumeMap.get(b.getBlockPoolId(),b.getBlockId());
  if (replicaInfo != null) {
    throw new ReplicaAlreadyExistsException("Block " + b + " already exists in state "+ replicaInfo.getState()+ " and thus cannot be created.");
  }
  FsVolumeImpl v=volumes.getNextVolume(b.getNumBytes());
  File f=v.createTmpFile(b.getBlockPoolId(),b.getLocalBlock());
  ReplicaInPipeline newReplicaInfo=new ReplicaInPipeline(b.getBlockId(),b.getGenerationStamp(),v,f.getParentFile());
  volumeMap.add(b.getBlockPoolId(),newReplicaInfo);
  perVolumeReplicaMap.get(v).add(b.getBlockPoolId(),newReplicaInfo);
  return newReplicaInfo;
}
