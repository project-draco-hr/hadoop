{
  File oldBlockFile=replicaInfo.getBlockFile();
  File oldMetaFile=replicaInfo.getMetaFile();
  FsVolumeImpl targetVolume=(FsVolumeImpl)volumeRef.getVolume();
  File[] blockFiles=copyBlockFiles(block.getBlockId(),block.getGenerationStamp(),oldMetaFile,oldBlockFile,targetVolume.getTmpDir(block.getBlockPoolId()),replicaInfo.isOnTransientStorage(),smallBufferSize,conf);
  ReplicaInfo newReplicaInfo=new ReplicaInPipeline(replicaInfo.getBlockId(),replicaInfo.getGenerationStamp(),targetVolume,blockFiles[0].getParentFile(),0);
  newReplicaInfo.setNumBytes(blockFiles[1].length());
  newReplicaInfo=finalizeReplica(block.getBlockPoolId(),newReplicaInfo);
synchronized (this) {
    FsVolumeImpl volume=(FsVolumeImpl)newReplicaInfo.getVolume();
    volume.getBlockPoolSlice(block.getBlockPoolId()).incrNumBlocks();
  }
  removeOldReplica(replicaInfo,newReplicaInfo,oldBlockFile,oldMetaFile,oldBlockFile.length(),oldMetaFile.length(),block.getBlockPoolId());
  return newReplicaInfo;
}
