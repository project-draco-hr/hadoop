{
  FinalizedReplica newReplicaInfo=null;
  if (replicaInfo.getState() == ReplicaState.RUR && ((ReplicaUnderRecovery)replicaInfo).getOriginalReplica().getState() == ReplicaState.FINALIZED) {
    newReplicaInfo=(FinalizedReplica)((ReplicaUnderRecovery)replicaInfo).getOriginalReplica();
  }
 else {
    FsVolumeImpl v=(FsVolumeImpl)replicaInfo.getVolume();
    File f=replicaInfo.getBlockFile();
    if (v == null) {
      throw new IOException("No volume for temporary file " + f + " for block "+ replicaInfo);
    }
    File dest=v.addBlock(bpid,replicaInfo,f);
    newReplicaInfo=new FinalizedReplica(replicaInfo,v,dest.getParentFile());
  }
  volumeMap.add(bpid,newReplicaInfo);
  perVolumeReplicaMap.get(newReplicaInfo.getVolume().getStorageID()).add(bpid,newReplicaInfo);
  return newReplicaInfo;
}
