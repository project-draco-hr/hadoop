{
  FinalizedReplica newReplicaInfo=null;
  if (replicaInfo.getState() == ReplicaState.RUR && ((ReplicaUnderRecovery)replicaInfo).getOriginalReplica().getState() == ReplicaState.FINALIZED) {
    newReplicaInfo=(FinalizedReplica)((ReplicaUnderRecovery)replicaInfo).getOriginalReplica();
  }
 else {
    FsVolumeImpl v=(FsVolumeImpl)replicaInfo.getVolume();
    File f=replicaInfo.getBlockFile();
    if (v == null) {
      throw new IOException("No volume for temporary file " + f + " for block "+ replicaInfo);
    }
    File dest=v.addFinalizedBlock(bpid,replicaInfo,f,replicaInfo.getBytesReserved());
    newReplicaInfo=new FinalizedReplica(replicaInfo,v,dest.getParentFile());
    if (v.isTransientStorage()) {
      ramDiskReplicaTracker.addReplica(bpid,replicaInfo.getBlockId(),v);
      datanode.getMetrics().addRamDiskBytesWrite(replicaInfo.getNumBytes());
    }
  }
  volumeMap.add(bpid,newReplicaInfo);
  return newReplicaInfo;
}
