{
  final ReplicaInfo replica=map.get(bpid,block.getBlockId());
  LOG.info("initReplicaRecovery: " + block + ", recoveryId="+ recoveryId+ ", replica="+ replica);
  if (replica == null) {
    return null;
  }
  if (replica.getState() == ReplicaState.TEMPORARY || replica.getState() == ReplicaState.RBW) {
    final ReplicaInPipeline rip=(ReplicaInPipeline)replica;
    if (!rip.attemptToSetWriter(null,Thread.currentThread())) {
      throw new MustStopExistingWriter(rip);
    }
    if (replica.getBytesOnDisk() < replica.getVisibleLength()) {
      throw new IOException("THIS IS NOT SUPPOSED TO HAPPEN:" + " getBytesOnDisk() < getVisibleLength(), rip=" + replica);
    }
    checkReplicaFiles(replica);
  }
  if (replica.getGenerationStamp() < block.getGenerationStamp()) {
    throw new IOException("replica.getGenerationStamp() < block.getGenerationStamp(), block=" + block + ", replica="+ replica);
  }
  if (replica.getGenerationStamp() >= recoveryId) {
    throw new IOException("THIS IS NOT SUPPOSED TO HAPPEN:" + " replica.getGenerationStamp() >= recoveryId = " + recoveryId + ", block="+ block+ ", replica="+ replica);
  }
  final ReplicaInfo rur;
  if (replica.getState() == ReplicaState.RUR) {
    rur=replica;
    if (rur.getRecoveryID() >= recoveryId) {
      throw new RecoveryInProgressException("rur.getRecoveryID() >= recoveryId = " + recoveryId + ", block="+ block+ ", rur="+ rur);
    }
    final long oldRecoveryID=rur.getRecoveryID();
    rur.setRecoveryID(recoveryId);
    LOG.info("initReplicaRecovery: update recovery id for " + block + " from "+ oldRecoveryID+ " to "+ recoveryId);
  }
 else {
    rur=new ReplicaBuilder(ReplicaState.RUR).from(replica).setRecoveryId(recoveryId).build();
    map.add(bpid,rur);
    LOG.info("initReplicaRecovery: changing replica state for " + block + " from "+ replica.getState()+ " to "+ rur.getState());
  }
  return rur.createInfo();
}
