{
  LOG.info("Recover RBW replica " + b);
  while (true) {
    try {
synchronized (this) {
        ReplicaInfo replicaInfo=getReplicaInfo(b.getBlockPoolId(),b.getBlockId());
        if (replicaInfo.getState() != ReplicaState.RBW) {
          throw new ReplicaNotFoundException(ReplicaNotFoundException.NON_RBW_REPLICA + replicaInfo);
        }
        ReplicaBeingWritten rbw=(ReplicaBeingWritten)replicaInfo;
        if (!rbw.attemptToSetWriter(null,Thread.currentThread())) {
          throw new MustStopExistingWriter(rbw);
        }
        LOG.info("Recovering " + rbw);
        return recoverRbwImpl(rbw,b,newGS,minBytesRcvd,maxBytesRcvd);
      }
    }
 catch (    MustStopExistingWriter e) {
      e.getReplica().stopWriter(datanode.getDnConf().getXceiverStopTimeout());
    }
  }
}
