{
  LOG.info("Recover RBW replica " + b);
  while (true) {
    try {
      try (AutoCloseableLock lock=datasetLock.acquire()){
        ReplicaInfo replicaInfo=getReplicaInfo(b.getBlockPoolId(),b.getBlockId());
        if (replicaInfo.getState() != ReplicaState.RBW) {
          throw new ReplicaNotFoundException(ReplicaNotFoundException.NON_RBW_REPLICA + replicaInfo);
        }
        ReplicaInPipeline rbw=(ReplicaInPipeline)replicaInfo;
        if (!rbw.attemptToSetWriter(null,Thread.currentThread())) {
          throw new MustStopExistingWriter(rbw);
        }
        LOG.info("At " + datanode.getDisplayName() + ", Recovering "+ rbw);
        return recoverRbwImpl(rbw,b,newGS,minBytesRcvd,maxBytesRcvd);
      }
     }
 catch (    MustStopExistingWriter e) {
      e.getReplicaInPipeline().stopWriter(datanode.getDnConf().getXceiverStopTimeout());
    }
  }
}
