{
  LOG.info("Recover RBW replica " + b);
  ReplicaInfo replicaInfo=getReplicaInfo(b.getBlockPoolId(),b.getBlockId());
  if (replicaInfo.getState() != ReplicaState.RBW) {
    throw new ReplicaNotFoundException(ReplicaNotFoundException.NON_RBW_REPLICA + replicaInfo);
  }
  ReplicaBeingWritten rbw=(ReplicaBeingWritten)replicaInfo;
  LOG.info("Recovering " + rbw);
  rbw.stopWriter();
  rbw.setWriter(Thread.currentThread());
  long replicaGenerationStamp=rbw.getGenerationStamp();
  if (replicaGenerationStamp < b.getGenerationStamp() || replicaGenerationStamp > newGS) {
    throw new ReplicaNotFoundException(ReplicaNotFoundException.UNEXPECTED_GS_REPLICA + b + ". Expected GS range is ["+ b.getGenerationStamp()+ ", "+ newGS+ "].");
  }
  if (rbw.getBytesAcked() < minBytesRcvd || rbw.getNumBytes() > maxBytesRcvd) {
    throw new ReplicaNotFoundException("Unmatched length replica " + replicaInfo + ": BytesAcked = "+ rbw.getBytesAcked()+ " BytesRcvd = "+ rbw.getNumBytes()+ " are not in the range of ["+ minBytesRcvd+ ", "+ maxBytesRcvd+ "].");
  }
  bumpReplicaGS(rbw,newGS);
  return rbw;
}
