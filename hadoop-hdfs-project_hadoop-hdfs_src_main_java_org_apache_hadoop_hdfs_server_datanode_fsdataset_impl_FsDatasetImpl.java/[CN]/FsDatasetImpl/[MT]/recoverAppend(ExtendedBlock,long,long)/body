{
  LOG.info("Recover failed append to " + b);
  while (true) {
    try {
      try (AutoCloseableLock lock=datasetLock.acquire()){
        ReplicaInfo replicaInfo=recoverCheck(b,newGS,expectedBlockLen);
        FsVolumeReference ref=replicaInfo.getVolume().obtainReference();
        ReplicaInPipeline replica;
        try {
          if (replicaInfo.getState() == ReplicaState.FINALIZED) {
            replica=append(b.getBlockPoolId(),replicaInfo,newGS,b.getNumBytes());
          }
 else {
            replicaInfo.bumpReplicaGS(newGS);
            replica=(ReplicaInPipeline)replicaInfo;
          }
        }
 catch (        IOException e) {
          IOUtils.cleanup(null,ref);
          throw e;
        }
        return new ReplicaHandler(replica,ref);
      }
     }
 catch (    MustStopExistingWriter e) {
      e.getReplicaInPipeline().stopWriter(datanode.getDnConf().getXceiverStopTimeout());
    }
  }
}
