{
  long totalBlocks=0, removedBlocks=0;
  List<FsVolumeImpl> failedVols=volumes.checkDirs();
  if (failedVols == null) {
    return;
  }
  long mlsec=Time.now();
synchronized (this) {
    for (    FsVolumeImpl fv : failedVols) {
      for (      String bpid : fv.getBlockPoolList()) {
        Iterator<ReplicaInfo> ib=volumeMap.replicas(bpid).iterator();
        while (ib.hasNext()) {
          ReplicaInfo b=ib.next();
          totalBlocks++;
          if (b.getVolume() == fv) {
            LOG.warn("Removing replica " + bpid + ":"+ b.getBlockId()+ " on failed volume "+ fv.getCurrentDir().getAbsolutePath());
            ib.remove();
            perVolumeReplicaMap.get(fv.getStorageID()).remove(bpid,b.getBlockId());
            removedBlocks++;
          }
        }
      }
    }
  }
  mlsec=Time.now() - mlsec;
  LOG.warn("Removed " + removedBlocks + " out of "+ totalBlocks+ "(took "+ mlsec+ " millisecs)");
  StringBuilder sb=new StringBuilder();
  for (  FsVolumeImpl fv : failedVols) {
    sb.append(fv.getCurrentDir().getAbsolutePath() + ";");
  }
  throw new DiskErrorException("DataNode failed volumes:" + sb);
}
