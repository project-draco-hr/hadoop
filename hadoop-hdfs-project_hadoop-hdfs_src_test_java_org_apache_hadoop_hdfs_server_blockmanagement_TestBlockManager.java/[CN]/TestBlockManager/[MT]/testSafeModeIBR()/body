{
  DatanodeDescriptor node=spy(nodes.get(0));
  DatanodeStorageInfo ds=node.getStorageInfos()[0];
  node.setStorageID(ds.getStorageID());
  node.isAlive=true;
  DatanodeRegistration nodeReg=new DatanodeRegistration(node,null,null,"");
  doReturn(true).when(fsn).isInStartupSafeMode();
  bm.getDatanodeManager().registerDatanode(nodeReg);
  bm.getDatanodeManager().addDatanode(node);
  assertEquals(node,bm.getDatanodeManager().getDatanode(node));
  assertEquals(0,ds.getBlockReportCount());
  reset(node);
  bm.processReport(node,new DatanodeStorage(ds.getStorageID()),"pool",new BlockListAsLongs(null,null));
  assertEquals(1,ds.getBlockReportCount());
  reset(node);
  bm.processReport(node,new DatanodeStorage(ds.getStorageID()),"pool",new BlockListAsLongs(null,null));
  assertEquals(1,ds.getBlockReportCount());
  bm.getDatanodeManager().removeDatanode(node);
  reset(node);
  bm.getDatanodeManager().registerDatanode(nodeReg);
  verify(node).updateRegInfo(nodeReg);
  assertEquals(0,ds.getBlockReportCount());
  reset(node);
  bm.processReport(node,new DatanodeStorage(ds.getStorageID()),"pool",new BlockListAsLongs(null,null));
  assertEquals(1,ds.getBlockReportCount());
}
