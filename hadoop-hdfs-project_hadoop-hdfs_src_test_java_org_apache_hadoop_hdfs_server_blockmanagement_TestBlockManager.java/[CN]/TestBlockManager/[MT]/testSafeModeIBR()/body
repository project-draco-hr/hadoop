{
  DatanodeDescriptor node=spy(nodes.get(0));
  node.setStorageID("dummy-storage");
  node.isAlive=true;
  DatanodeRegistration nodeReg=new DatanodeRegistration(node,null,null,"");
  doReturn(true).when(fsn).isInStartupSafeMode();
  bm.getDatanodeManager().registerDatanode(nodeReg);
  bm.getDatanodeManager().addDatanode(node);
  assertEquals(node,bm.getDatanodeManager().getDatanode(node));
  assertTrue(node.isFirstBlockReport());
  reset(node);
  bm.processReport(node,"pool",new BlockListAsLongs());
  verify(node).receivedBlockReport();
  assertFalse(node.isFirstBlockReport());
  reset(node);
  bm.processReport(node,"pool",new BlockListAsLongs());
  verify(node,never()).receivedBlockReport();
  assertFalse(node.isFirstBlockReport());
  bm.getDatanodeManager().removeDatanode(node);
  reset(node);
  bm.getDatanodeManager().registerDatanode(nodeReg);
  verify(node).updateRegInfo(nodeReg);
  assertTrue(node.isFirstBlockReport());
  reset(node);
  bm.processReport(node,"pool",new BlockListAsLongs());
  verify(node).receivedBlockReport();
  assertFalse(node.isFirstBlockReport());
}
