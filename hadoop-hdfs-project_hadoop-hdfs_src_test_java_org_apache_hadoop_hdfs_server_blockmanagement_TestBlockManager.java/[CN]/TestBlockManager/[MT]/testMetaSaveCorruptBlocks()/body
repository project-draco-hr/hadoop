{
  List<DatanodeStorageInfo> origStorages=getStorages(0,1);
  List<DatanodeDescriptor> origNodes=getNodes(origStorages);
  addCorruptBlockOnNodes(0,origNodes);
  File file=new File("test.log");
  PrintWriter out=new PrintWriter(file);
  bm.metaSave(out);
  out.flush();
  FileInputStream fstream=new FileInputStream(file);
  DataInputStream in=new DataInputStream(fstream);
  BufferedReader reader=new BufferedReader(new InputStreamReader(in));
  try {
    for (int i=0; i < 6; i++) {
      reader.readLine();
    }
    String corruptBlocksLine=reader.readLine();
    assertEquals("Unexpected text in metasave," + "was expecting corrupt blocks section!",0,corruptBlocksLine.compareTo("Corrupt Blocks:"));
    corruptBlocksLine=reader.readLine();
    String regex="Block=[0-9]+\\tNode=.*\\tStorageID=.*StorageState.*" + "TotalReplicas=.*Reason=GENSTAMP_MISMATCH";
    assertTrue("Unexpected corrupt block section in metasave!",corruptBlocksLine.matches(regex));
    corruptBlocksLine=reader.readLine();
    regex="Metasave: Number of datanodes.*";
    assertTrue("Unexpected corrupt block section in metasave!",corruptBlocksLine.matches(regex));
  }
  finally {
    if (reader != null)     reader.close();
    file.delete();
  }
}
