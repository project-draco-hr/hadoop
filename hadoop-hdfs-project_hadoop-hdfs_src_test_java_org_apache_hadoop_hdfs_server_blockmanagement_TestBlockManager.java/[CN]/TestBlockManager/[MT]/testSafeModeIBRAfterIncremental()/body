{
  DatanodeDescriptor node=spy(nodes.get(0));
  Iterator<DatanodeStorageInfo> i=node.getStorageInfos().iterator();
  DatanodeStorageInfo ds=i.next();
  node.setStorageID(ds.getStorageID());
  node.isAlive=true;
  DatanodeRegistration nodeReg=new DatanodeRegistration(node,null,null,"");
  doReturn(true).when(fsn).isInStartupSafeMode();
  bm.getDatanodeManager().registerDatanode(nodeReg);
  bm.getDatanodeManager().addDatanode(node);
  assertEquals(node,bm.getDatanodeManager().getDatanode(node));
  assertEquals(0,ds.getBlockReportCount());
  reset(node);
  doReturn(1).when(node).numBlocks();
  bm.processReport(node,new DatanodeStorage(ds.getStorageID()),"pool",new BlockListAsLongs(null,null));
  assertEquals(1,ds.getBlockReportCount());
}
