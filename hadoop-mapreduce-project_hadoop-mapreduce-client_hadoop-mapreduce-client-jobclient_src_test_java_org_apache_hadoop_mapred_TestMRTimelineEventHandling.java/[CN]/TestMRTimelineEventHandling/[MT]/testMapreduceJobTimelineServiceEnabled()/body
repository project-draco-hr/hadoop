{
  Configuration conf=new YarnConfiguration();
  conf.setBoolean(YarnConfiguration.TIMELINE_SERVICE_ENABLED,true);
  conf.setBoolean(MRJobConfig.MAPREDUCE_JOB_EMIT_TIMELINE_DATA,false);
  MiniMRYarnCluster cluster=null;
  try {
    cluster=new MiniMRYarnCluster(TestJobHistoryEventHandler.class.getSimpleName(),1);
    cluster.init(conf);
    cluster.start();
    conf.set(YarnConfiguration.TIMELINE_SERVICE_WEBAPP_ADDRESS,MiniYARNCluster.getHostname() + ":" + cluster.getApplicationHistoryServer().getPort());
    TimelineStore ts=cluster.getApplicationHistoryServer().getTimelineStore();
    Path inDir=new Path("input");
    Path outDir=new Path("output");
    RunningJob job=UtilsForTests.runJobSucceed(new JobConf(conf),inDir,outDir);
    Assert.assertEquals(JobStatus.SUCCEEDED,job.getJobStatus().getState().getValue());
    TimelineEntities entities=ts.getEntities("MAPREDUCE_JOB",null,null,null,null,null,null,null,null,null);
    Assert.assertEquals(0,entities.getEntities().size());
    conf.setBoolean(MRJobConfig.MAPREDUCE_JOB_EMIT_TIMELINE_DATA,true);
    job=UtilsForTests.runJobSucceed(new JobConf(conf),inDir,outDir);
    Assert.assertEquals(JobStatus.SUCCEEDED,job.getJobStatus().getState().getValue());
    entities=ts.getEntities("MAPREDUCE_JOB",null,null,null,null,null,null,null,null,null);
    Assert.assertEquals(1,entities.getEntities().size());
    TimelineEntity tEntity=entities.getEntities().get(0);
    Assert.assertEquals(job.getID().toString(),tEntity.getEntityId());
  }
  finally {
    if (cluster != null) {
      cluster.stop();
    }
  }
  conf=new YarnConfiguration();
  conf.setBoolean(YarnConfiguration.TIMELINE_SERVICE_ENABLED,true);
  conf.setBoolean(MRJobConfig.MAPREDUCE_JOB_EMIT_TIMELINE_DATA,true);
  cluster=null;
  try {
    cluster=new MiniMRYarnCluster(TestJobHistoryEventHandler.class.getSimpleName(),1);
    cluster.init(conf);
    cluster.start();
    conf.set(YarnConfiguration.TIMELINE_SERVICE_WEBAPP_ADDRESS,MiniYARNCluster.getHostname() + ":" + cluster.getApplicationHistoryServer().getPort());
    TimelineStore ts=cluster.getApplicationHistoryServer().getTimelineStore();
    Path inDir=new Path("input");
    Path outDir=new Path("output");
    conf.setBoolean(MRJobConfig.MAPREDUCE_JOB_EMIT_TIMELINE_DATA,false);
    RunningJob job=UtilsForTests.runJobSucceed(new JobConf(conf),inDir,outDir);
    Assert.assertEquals(JobStatus.SUCCEEDED,job.getJobStatus().getState().getValue());
    TimelineEntities entities=ts.getEntities("MAPREDUCE_JOB",null,null,null,null,null,null,null,null,null);
    Assert.assertEquals(0,entities.getEntities().size());
    conf.setBoolean(MRJobConfig.MAPREDUCE_JOB_EMIT_TIMELINE_DATA,true);
    job=UtilsForTests.runJobSucceed(new JobConf(conf),inDir,outDir);
    Assert.assertEquals(JobStatus.SUCCEEDED,job.getJobStatus().getState().getValue());
    entities=ts.getEntities("MAPREDUCE_JOB",null,null,null,null,null,null,null,null,null);
    Assert.assertEquals(1,entities.getEntities().size());
    TimelineEntity tEntity=entities.getEntities().get(0);
    Assert.assertEquals(job.getID().toString(),tEntity.getEntityId());
  }
  finally {
    if (cluster != null) {
      cluster.stop();
    }
  }
}
