{
  assumeTrue(!System.getProperty("os.name").startsWith("Windows"));
  cluster.shutdownDataNodes();
  conf.setInt(DFSConfigKeys.DFS_DATANODE_FAILED_VOLUMES_TOLERATED_KEY,1);
  File tld=new File(MiniDFSCluster.getBaseDirectory(),"badData");
  File dataDir1=new File(tld,"data1");
  File dataDir1Actual=new File(dataDir1,"1");
  dataDir1Actual.mkdirs();
  File dataDir2=new File(tld,"data2");
  prepareDirToFail(dataDir2);
  File dataDir2Actual=new File(dataDir2,"2");
  conf.set(DFSConfigKeys.DFS_DATANODE_DATA_DIR_KEY,dataDir1Actual.getPath() + "," + dataDir2Actual.getPath());
  cluster.startDataNodes(conf,1,false,null,null);
  cluster.waitActive();
  try {
    assertTrue("The DN should have started up fine.",cluster.isDataNodeUp());
    DataNode dn=cluster.getDataNodes().get(0);
    String si=dn.getFSDataset().getStorageInfo();
    assertTrue("The DN should have started with this directory",si.contains(dataDir1Actual.getPath()));
    assertFalse("The DN shouldn't have a bad directory.",si.contains(dataDir2Actual.getPath()));
  }
  finally {
    cluster.shutdownDataNodes();
    FileUtil.chmod(dataDir2.toString(),"755");
  }
}
