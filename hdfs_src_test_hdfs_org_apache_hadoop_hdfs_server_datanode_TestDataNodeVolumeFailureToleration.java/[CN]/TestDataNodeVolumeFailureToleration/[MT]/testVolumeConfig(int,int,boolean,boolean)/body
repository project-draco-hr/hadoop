{
  assumeTrue(!System.getProperty("os.name").startsWith("Windows"));
  final int dnIndex=0;
  File[] dirs={new File(MiniDFSCluster.getStorageDir(dnIndex,0),"current"),new File(MiniDFSCluster.getStorageDir(dnIndex,1),"current")};
  try {
    for (int i=0; i < volumesFailed; i++) {
      prepareDirToFail(dirs[i]);
    }
    restartCluster(volumesTolerated,clusterManaged);
    assertEquals(expectedBPServiceState,cluster.getDataNodes().get(0).isBPServiceAlive(cluster.getNamesystem().getBlockPoolId()));
  }
  finally {
    for (    File dir : dirs) {
      FileUtil.chmod(dir.toString(),"755");
    }
  }
}
