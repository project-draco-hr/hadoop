{
  boolean listLiveNodes=type == DatanodeReportType.ALL || type == DatanodeReportType.LIVE;
  boolean listDeadNodes=type == DatanodeReportType.ALL || type == DatanodeReportType.DEAD;
  HashMap<String,String> mustList=new HashMap<String,String>();
  if (listDeadNodes) {
    Iterator<String> it=hostsReader.getHosts().iterator();
    while (it.hasNext()) {
      mustList.put(it.next(),"");
    }
    it=hostsReader.getExcludedHosts().iterator();
    while (it.hasNext()) {
      mustList.put(it.next(),"");
    }
  }
  ArrayList<DatanodeDescriptor> nodes=null;
synchronized (datanodeMap) {
    nodes=new ArrayList<DatanodeDescriptor>(datanodeMap.size() + mustList.size());
    Iterator<DatanodeDescriptor> it=datanodeMap.values().iterator();
    while (it.hasNext()) {
      DatanodeDescriptor dn=it.next();
      final boolean isDead=isDatanodeDead(dn);
      if ((isDead && listDeadNodes) || (!isDead && listLiveNodes)) {
        nodes.add(dn);
      }
      try {
        InetAddress inet=InetAddress.getByName(dn.getIpAddr());
        mustList.remove(inet.getHostName());
        mustList.remove(inet.getHostName() + ":" + dn.getXferPort());
        mustList.remove(inet.getHostAddress().toString());
        mustList.remove(inet.getHostAddress().toString() + ":" + dn.getXferPort());
      }
 catch (      UnknownHostException e) {
        mustList.remove(dn.getName());
        mustList.remove(dn.getIpAddr());
        LOG.warn(e);
      }
    }
  }
  if (listDeadNodes) {
    Iterator<String> it=mustList.keySet().iterator();
    while (it.hasNext()) {
      DatanodeID dnId=parseDNFromHostsEntry(it.next());
      DatanodeDescriptor dn=new DatanodeDescriptor(dnId);
      dn.setLastUpdate(0);
      nodes.add(dn);
    }
  }
  return nodes;
}
