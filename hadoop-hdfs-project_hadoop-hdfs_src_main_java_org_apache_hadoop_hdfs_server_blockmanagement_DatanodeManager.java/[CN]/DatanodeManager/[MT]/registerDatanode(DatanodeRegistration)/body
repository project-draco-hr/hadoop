{
  String dnAddress=Server.getRemoteAddress();
  if (dnAddress == null) {
    dnAddress=nodeReg.getHost();
  }
  if (!inHostsList(nodeReg,dnAddress)) {
    throw new DisallowedDatanodeException(nodeReg);
  }
  String hostName=nodeReg.getHost();
  DatanodeID dnReg=new DatanodeID(dnAddress + ":" + nodeReg.getPort(),hostName,nodeReg.getStorageID(),nodeReg.getInfoPort(),nodeReg.getIpcPort());
  nodeReg.updateRegInfo(dnReg);
  nodeReg.exportedKeys=blockManager.getBlockKeys();
  NameNode.stateChangeLog.info("BLOCK* NameSystem.registerDatanode: " + "node registration from " + nodeReg.getName() + " storage "+ nodeReg.getStorageID());
  DatanodeDescriptor nodeS=datanodeMap.get(nodeReg.getStorageID());
  DatanodeDescriptor nodeN=getDatanodeByHost(nodeReg.getName());
  if (nodeN != null && nodeN != nodeS) {
    NameNode.LOG.info("BLOCK* NameSystem.registerDatanode: " + "node from name: " + nodeN.getName());
    removeDatanode(nodeN);
    wipeDatanode(nodeN);
    nodeN=null;
  }
  if (nodeS != null) {
    if (nodeN == nodeS) {
      if (NameNode.stateChangeLog.isDebugEnabled()) {
        NameNode.stateChangeLog.debug("BLOCK* NameSystem.registerDatanode: " + "node restarted.");
      }
    }
 else {
      NameNode.stateChangeLog.info("BLOCK* NameSystem.registerDatanode: " + "node " + nodeS.getName() + " is replaced by "+ nodeReg.getName()+ " with the same storageID "+ nodeReg.getStorageID());
    }
    getNetworkTopology().remove(nodeS);
    nodeS.updateRegInfo(nodeReg);
    nodeS.setHostName(hostName);
    nodeS.setDisallowed(false);
    resolveNetworkLocation(nodeS);
    getNetworkTopology().add(nodeS);
    heartbeatManager.register(nodeS);
    checkDecommissioning(nodeS,dnAddress);
    return;
  }
  if ("".equals(nodeReg.getStorageID())) {
    nodeReg.setStorageID(newStorageID());
    if (NameNode.stateChangeLog.isDebugEnabled()) {
      NameNode.stateChangeLog.debug("BLOCK* NameSystem.registerDatanode: " + "new storageID " + nodeReg.getStorageID() + " assigned.");
    }
  }
  DatanodeDescriptor nodeDescr=new DatanodeDescriptor(nodeReg,NetworkTopology.DEFAULT_RACK);
  resolveNetworkLocation(nodeDescr);
  addDatanode(nodeDescr);
  checkDecommissioning(nodeDescr,dnAddress);
  heartbeatManager.addDatanode(nodeDescr);
}
