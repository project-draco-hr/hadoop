{
  DatanodeID dnId=parseDNFromHostsEntry(address);
  String host=dnId.getIpAddr();
  int xferPort=dnId.getXferPort();
  DatanodeDescriptor node=getDatanodeByXferAddr(host,xferPort);
  if (node == null) {
    node=getDatanodeByHost(host);
  }
  if (node == null) {
    String networkLocation=resolveNetworkLocationWithFallBackToDefaultLocation(dnId);
    List<Node> rackNodes=getNetworkTopology().getDatanodesInRack(networkLocation);
    if (rackNodes != null) {
      for (      Node rackNode : rackNodes) {
        if (((DatanodeDescriptor)rackNode).getIpAddr().equals(host)) {
          node=(DatanodeDescriptor)rackNode;
          break;
        }
      }
      if (node == null && !rackNodes.isEmpty()) {
        node=(DatanodeDescriptor)(rackNodes.get(DFSUtil.getRandom().nextInt(rackNodes.size())));
      }
    }
    if (node == null) {
      node=(DatanodeDescriptor)getNetworkTopology().chooseRandom(NodeBase.ROOT);
    }
  }
  return node;
}
