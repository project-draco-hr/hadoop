{
  final INode referred=withCount.getReferredINode();
  final boolean firstReferred=!(referred instanceof INodeReferenceWithId);
  out.writeBoolean(firstReferred);
  if (firstReferred) {
    FSImageSerialization.saveINode2Image(referred,out,writeUnderConstruction,this);
    final long id=++referenceId;
    referenceMap.put(id,withCount);
    final INodeReferenceWithId withId=new INodeReferenceWithId(withCount,referred,id);
    withCount.setReferredINode(withId);
    referred.setParentReference(withId);
  }
 else {
    final long id=((INodeReferenceWithId)referred).getReferenceId();
    Preconditions.checkState(referenceMap.containsKey(id));
    out.writeLong(id);
  }
}
