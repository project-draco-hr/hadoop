{
  List<String> cmd=Shell.WINDOWS ? Arrays.asList("ping","-n","100","127.0.0.1",">nul") : Arrays.asList("sleep","100");
  ContainerLaunchContext amContainer=BuilderUtils.newContainerLaunchContext("testUser",Collections.<String,LocalResource>emptyMap(),new HashMap<String,String>(),cmd,new HashMap<String,ByteBuffer>(),null,new HashMap<ApplicationAccessType,String>());
  ApplicationSubmissionContext appSubmissionContext=recordFactory.newRecordInstance(ApplicationSubmissionContext.class);
  appSubmissionContext.setApplicationId(appID);
  appSubmissionContext.setAMContainerSpec(amContainer);
  appSubmissionContext.getAMContainerSpec().setUser("testUser");
  appSubmissionContext.setResource(BuilderUtils.newResource(1024,1));
  SubmitApplicationRequest submitRequest=recordFactory.newRecordInstance(SubmitApplicationRequest.class);
  submitRequest.setApplicationSubmissionContext(appSubmissionContext);
  resourceManager.getClientRMService().submitApplication(submitRequest);
  int waitCounter=0;
  RMApp app=resourceManager.getRMContext().getRMApps().get(appID);
  RMAppAttempt appAttempt=app == null ? null : app.getCurrentAppAttempt();
  RMAppAttemptState state=appAttempt == null ? null : appAttempt.getAppAttemptState();
  while ((app == null || appAttempt == null || state == null || !state.equals(RMAppAttemptState.LAUNCHED)) && waitCounter++ != 20) {
    LOG.info("Waiting for applicationAttempt to be created.. ");
    Thread.sleep(1000);
    app=resourceManager.getRMContext().getRMApps().get(appID);
    appAttempt=app == null ? null : app.getCurrentAppAttempt();
    state=appAttempt == null ? null : appAttempt.getAppAttemptState();
  }
  Assert.assertNotNull(app);
  Assert.assertNotNull(appAttempt);
  Assert.assertNotNull(state);
  Assert.assertEquals(RMAppAttemptState.LAUNCHED,state);
  UserGroupInformation currentUser=UserGroupInformation.createRemoteUser(appAttempt.getAppAttemptId().toString());
  final InetSocketAddress schedulerAddr=resourceManager.getApplicationMasterService().getBindAddress();
  if (UserGroupInformation.isSecurityEnabled()) {
    ApplicationTokenIdentifier appTokenIdentifier=new ApplicationTokenIdentifier(appAttempt.getAppAttemptId());
    ApplicationTokenSecretManager appTokenSecretManager=new ApplicationTokenSecretManager(conf);
    appTokenSecretManager.setMasterKey(resourceManager.getApplicationTokenSecretManager().getMasterKey());
    Token<ApplicationTokenIdentifier> appToken=new Token<ApplicationTokenIdentifier>(appTokenIdentifier,appTokenSecretManager);
    SecurityUtil.setTokenService(appToken,schedulerAddr);
    currentUser.addToken(appToken);
  }
  AMRMProtocol scheduler=currentUser.doAs(new PrivilegedAction<AMRMProtocol>(){
    @Override public AMRMProtocol run(){
      return (AMRMProtocol)yarnRPC.getProxy(AMRMProtocol.class,schedulerAddr,conf);
    }
  }
);
  RegisterApplicationMasterRequest request=recordFactory.newRecordInstance(RegisterApplicationMasterRequest.class);
  request.setApplicationAttemptId(resourceManager.getRMContext().getRMApps().get(appID).getCurrentAppAttempt().getAppAttemptId());
  scheduler.registerApplicationMaster(request);
  return scheduler;
}
