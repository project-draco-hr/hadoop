{
  LOG.info("Running test for malice user");
  NMTokenSecretManagerInRM nmTokenSecretManagerInRM=yarnCluster.getResourceManager().getRMContext().getNMTokenSecretManager();
  ApplicationId appId=ApplicationId.newInstance(1,1);
  ApplicationAttemptId appAttemptId=ApplicationAttemptId.newInstance(appId,0);
  ContainerId cId=ContainerId.newContainerId(appAttemptId,0);
  NodeManager nm=yarnCluster.getNodeManager(0);
  NMTokenSecretManagerInNM nmTokenSecretManagerInNM=nm.getNMContext().getNMTokenSecretManager();
  String user="test";
  waitForNMToReceiveNMTokenKey(nmTokenSecretManagerInNM,nm);
  NodeId nodeId=nm.getNMContext().getNodeId();
  Assert.assertEquals(nmTokenSecretManagerInNM.getCurrentKey().getKeyId(),nmTokenSecretManagerInRM.getCurrentKey().getKeyId());
  RMContainerTokenSecretManager containerTokenSecretManager=yarnCluster.getResourceManager().getRMContext().getContainerTokenSecretManager();
  Resource r=Resource.newInstance(1230,2);
  Token containerToken=containerTokenSecretManager.createContainerToken(cId,nodeId,user,r,Priority.newInstance(0),0);
  ContainerTokenIdentifier containerTokenIdentifier=getContainerTokenIdentifierFromToken(containerToken);
  ContainerTokenIdentifierForTest newVersionTokenIdentifier=new ContainerTokenIdentifierForTest(containerTokenIdentifier,"message");
  byte[] password=containerTokenSecretManager.createPassword(newVersionTokenIdentifier);
  Token newContainerToken=BuilderUtils.newContainerToken(nodeId,password,newVersionTokenIdentifier);
  Token nmToken=nmTokenSecretManagerInRM.createNMToken(appAttemptId,nodeId,user);
  YarnRPC rpc=YarnRPC.create(conf);
  Assert.assertTrue(testStartContainer(rpc,appAttemptId,nodeId,newContainerToken,nmToken,false).isEmpty());
  RMContainerTokenSecretManager tamperedContainerTokenSecretManager=new RMContainerTokenSecretManager(conf);
  tamperedContainerTokenSecretManager.rollMasterKey();
  do {
    tamperedContainerTokenSecretManager.rollMasterKey();
    tamperedContainerTokenSecretManager.activateNextMasterKey();
  }
 while (containerTokenSecretManager.getCurrentKey().getKeyId() == tamperedContainerTokenSecretManager.getCurrentKey().getKeyId());
  ContainerId cId2=ContainerId.newContainerId(appAttemptId,1);
  Token containerToken2=tamperedContainerTokenSecretManager.createContainerToken(cId2,nodeId,user,r,Priority.newInstance(0),0);
  StringBuilder sb=new StringBuilder("Given Container ");
  sb.append(cId2);
  sb.append(" seems to have an illegally generated token.");
  Assert.assertTrue(testStartContainer(rpc,appAttemptId,nodeId,containerToken2,nmToken,true).contains(sb.toString()));
}
