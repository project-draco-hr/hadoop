{
  writeLock.lock();
  try {
    N node=nodes.remove(nodeId);
    if (node == null) {
      LOG.warn("Attempting to remove a non-existent node " + nodeId);
      return null;
    }
    String rackName=node.getRackName();
    Integer numNodes=nodesPerRack.get(rackName);
    if (numNodes > 0) {
      nodesPerRack.put(rackName,--numNodes);
    }
 else {
      LOG.error("Attempting to remove node from an empty rack " + rackName);
    }
    Resources.subtractFrom(clusterCapacity,node.getTotalResource());
    updateMaxResources(node,false);
    return node;
  }
  finally {
    writeLock.unlock();
  }
}
