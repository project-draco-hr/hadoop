{
  NameNode nameNode=null;
  try {
    Configuration conf=new HdfsConfiguration();
    File nameDir=new File(MiniDFSCluster.getBaseDirectory(),"name");
    conf.set(DFSConfigKeys.DFS_NAMENODE_NAME_DIR_KEY,nameDir.getAbsolutePath());
    Random rand=new Random();
    final int port=30000 + rand.nextInt(30000);
    FileSystem.setDefaultUri(conf,"hdfs://localhost:" + port);
    conf.set(DFSConfigKeys.DFS_NAMENODE_HTTP_ADDRESS_KEY,"127.0.0.1:" + port);
    DFSTestUtil.formatNameNode(conf);
    nameNode=new NameNode(conf);
  }
  finally {
    if (nameNode != null) {
      nameNode.stop();
    }
  }
}
