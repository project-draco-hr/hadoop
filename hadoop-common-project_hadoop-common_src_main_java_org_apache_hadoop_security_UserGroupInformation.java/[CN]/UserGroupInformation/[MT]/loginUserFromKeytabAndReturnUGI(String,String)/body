{
  if (!isSecurityEnabled())   return UserGroupInformation.getCurrentUser();
  String oldKeytabFile=null;
  String oldKeytabPrincipal=null;
  long start=0;
  try {
    oldKeytabFile=keytabFile;
    oldKeytabPrincipal=keytabPrincipal;
    keytabFile=path;
    keytabPrincipal=user;
    Subject subject=new Subject();
    LoginContext login=newLoginContext(HadoopConfiguration.KEYTAB_KERBEROS_CONFIG_NAME,subject,new HadoopConfiguration());
    start=Time.now();
    login.login();
    metrics.loginSuccess.add(Time.now() - start);
    UserGroupInformation newLoginUser=new UserGroupInformation(subject);
    newLoginUser.setLogin(login);
    newLoginUser.setAuthenticationMethod(AuthenticationMethod.KERBEROS);
    return newLoginUser;
  }
 catch (  LoginException le) {
    if (start > 0) {
      metrics.loginFailure.add(Time.now() - start);
    }
    throw new IOException("Login failure for " + user + " from keytab "+ path,le);
  }
 finally {
    if (oldKeytabFile != null)     keytabFile=oldKeytabFile;
    if (oldKeytabPrincipal != null)     keytabPrincipal=oldKeytabPrincipal;
  }
}
