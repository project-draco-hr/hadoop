{
  if (LOG.isDebugEnabled()) {
    LOG.debug("hadoop login commit");
  }
  if (!subject.getPrincipals(User.class).isEmpty()) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("using existing subject:" + subject.getPrincipals());
    }
    return true;
  }
  Principal user=null;
  if (isAuthenticationMethodEnabled(AuthenticationMethod.KERBEROS)) {
    user=getCanonicalUser(KerberosPrincipal.class);
    if (LOG.isDebugEnabled()) {
      LOG.debug("using kerberos user:" + user);
    }
  }
  if (!isSecurityEnabled() && (user == null)) {
    String envUser=System.getenv(HADOOP_USER_NAME);
    if (envUser == null) {
      envUser=System.getProperty(HADOOP_USER_NAME);
    }
    user=envUser == null ? null : new User(envUser);
  }
  if (user == null) {
    user=getCanonicalUser(OS_PRINCIPAL_CLASS);
    if (LOG.isDebugEnabled()) {
      LOG.debug("using local user:" + user);
    }
  }
  if (user != null) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Using user: \"" + user + "\" with name "+ user.getName());
    }
    User userEntry=null;
    try {
      userEntry=new User(user.getName());
    }
 catch (    Exception e) {
      throw (LoginException)(new LoginException(e.toString()).initCause(e));
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug("User entry: \"" + userEntry.toString() + "\"");
    }
    subject.getPrincipals().add(userEntry);
    return true;
  }
  LOG.error("Can't find user in " + subject);
  throw new LoginException("Can't find user name");
}
