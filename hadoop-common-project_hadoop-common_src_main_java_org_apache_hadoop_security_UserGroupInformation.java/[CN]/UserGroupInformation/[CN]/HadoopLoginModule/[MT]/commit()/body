{
  if (LOG.isDebugEnabled()) {
    LOG.debug("hadoop login commit");
  }
  if (!subject.getPrincipals(User.class).isEmpty()) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("using existing subject:" + subject.getPrincipals());
    }
    return true;
  }
  Principal user=null;
  if (useKerberos) {
    user=getCanonicalUser(KerberosPrincipal.class);
    if (LOG.isDebugEnabled()) {
      LOG.debug("using kerberos user:" + user);
    }
  }
  if (user == null) {
    user=getCanonicalUser(OS_PRINCIPAL_CLASS);
    if (LOG.isDebugEnabled()) {
      LOG.debug("using local user:" + user);
    }
  }
  if (user != null) {
    subject.getPrincipals().add(new User(user.getName()));
    return true;
  }
  LOG.error("Can't find user in " + subject);
  throw new LoginException("Can't find user name");
}
