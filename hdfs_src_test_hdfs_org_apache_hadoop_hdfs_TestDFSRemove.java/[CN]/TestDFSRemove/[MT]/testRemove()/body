{
  Configuration conf=new HdfsConfiguration();
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(2).build();
  try {
    FileSystem fs=cluster.getFileSystem();
    assertTrue(fs.mkdirs(dir));
    long dfsUsedStart=getTotalDfsUsed(cluster);
{
      final int fileCount=100;
      for (int i=0; i < fileCount; i++) {
        Path a=new Path(dir,"a" + i);
        createFile(fs,a);
      }
      long dfsUsedMax=getTotalDfsUsed(cluster);
      for (int i=0; i < fileCount; i++) {
        Path a=new Path(dir,"a" + i);
        fs.delete(a,false);
      }
      Thread.sleep(3 * FSConstants.HEARTBEAT_INTERVAL * 1000);
      long dfsUsedFinal=getTotalDfsUsed(cluster);
      assertEquals("All blocks should be gone. start=" + dfsUsedStart + " max="+ dfsUsedMax+ " final="+ dfsUsedFinal,dfsUsedStart,dfsUsedFinal);
    }
    fs.delete(dir,true);
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
