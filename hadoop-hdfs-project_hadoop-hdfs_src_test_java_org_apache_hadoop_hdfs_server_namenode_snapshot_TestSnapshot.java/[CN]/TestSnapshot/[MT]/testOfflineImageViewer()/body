{
  runTestSnapshot(SNAPSHOT_ITERATION_NUMBER);
  File originalFsimage=FSImageTestUtil.findLatestImageFile(FSImageTestUtil.getFSImage(cluster.getNameNode()).getStorage().getStorageDir(0));
  assertNotNull("Didn't generate or can't find fsimage",originalFsimage);
  String ROOT=System.getProperty("test.build.data","build/test/data");
  File testFile=new File(ROOT,"/image");
  String xmlImage=ROOT + "/image_xml";
  boolean success=false;
  try {
    DFSTestUtil.copyFile(originalFsimage,testFile);
    XmlImageVisitor v=new XmlImageVisitor(xmlImage,true);
    OfflineImageViewer oiv=new OfflineImageViewer(testFile.getPath(),v,true);
    oiv.go();
    success=true;
  }
  finally {
    if (testFile.exists()) {
      testFile.delete();
    }
    if (success) {
      File xmlImageFile=new File(xmlImage);
      if (xmlImageFile.exists()) {
        xmlImageFile.delete();
      }
    }
  }
}
