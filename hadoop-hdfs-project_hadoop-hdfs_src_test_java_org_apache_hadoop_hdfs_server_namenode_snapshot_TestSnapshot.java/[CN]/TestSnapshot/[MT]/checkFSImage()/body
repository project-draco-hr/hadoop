{
  File fsnBefore=getDumpTreeFile(testDir,"before");
  File fsnMiddle=getDumpTreeFile(testDir,"middle");
  File fsnAfter=getDumpTreeFile(testDir,"after");
  SnapshotTestHelper.dumpTree2File(fsdir,fsnBefore);
  cluster.shutdown();
  cluster=new MiniDFSCluster.Builder(conf).format(false).numDataNodes(REPLICATION).build();
  cluster.waitActive();
  fsn=cluster.getNamesystem();
  hdfs=cluster.getFileSystem();
  SnapshotTestHelper.dumpTree2File(fsdir,fsnMiddle);
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
  hdfs.saveNamespace();
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
  cluster.shutdown();
  cluster=new MiniDFSCluster.Builder(conf).format(false).numDataNodes(REPLICATION).build();
  cluster.waitActive();
  fsn=cluster.getNamesystem();
  hdfs=cluster.getFileSystem();
  SnapshotTestHelper.dumpTree2File(fsdir,fsnAfter);
  SnapshotTestHelper.compareDumpedTreeInFile(fsnBefore,fsnMiddle,true);
  SnapshotTestHelper.compareDumpedTreeInFile(fsnBefore,fsnAfter,true);
}
