{
  File fsnBefore=getDumpTreeFile(testDir,"before");
  File fsnMiddle=getDumpTreeFile(testDir,"middle");
  File fsnAfter=getDumpTreeFile(testDir,"after");
  String rootDir="/";
  PrintWriter out=new PrintWriter(new FileWriter(fsnBefore,false),true);
  fsn.getFSDirectory().getINode(rootDir).dumpTreeRecursively(out,new StringBuilder(),null);
  out.close();
  cluster.shutdown();
  cluster=new MiniDFSCluster.Builder(conf).format(false).numDataNodes(REPLICATION).build();
  cluster.waitActive();
  fsn=cluster.getNamesystem();
  hdfs=cluster.getFileSystem();
  out=new PrintWriter(new FileWriter(fsnMiddle,false),true);
  fsn.getFSDirectory().getINode(rootDir).dumpTreeRecursively(out,new StringBuilder(),null);
  out.close();
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
  hdfs.saveNamespace();
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
  cluster.shutdown();
  cluster=new MiniDFSCluster.Builder(conf).format(false).numDataNodes(REPLICATION).build();
  cluster.waitActive();
  fsn=cluster.getNamesystem();
  hdfs=cluster.getFileSystem();
  out=new PrintWriter(new FileWriter(fsnAfter,false),true);
  fsn.getFSDirectory().getINode(rootDir).dumpTreeRecursively(out,new StringBuilder(),null);
  out.close();
  compareFile(fsnBefore,fsnMiddle);
  compareFile(fsnBefore,fsnAfter);
}
