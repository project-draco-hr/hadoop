{
  complexNodeLabelMappingToManager();
  CapacitySchedulerConfiguration config=(CapacitySchedulerConfiguration)TestUtils.getComplexConfigurationWithQueueLabels(conf);
  final String A1=CapacitySchedulerConfiguration.ROOT + ".a" + ".a1";
  final String B1=CapacitySchedulerConfiguration.ROOT + ".b" + ".b1";
  config.setMaximumAMResourcePercentPerPartition(A1,"y",0.25f);
  config.setMaximumApplicationMasterResourcePerQueuePercent(B1,0.15f);
  MockRM rm1=new MockRM(config){
    @Override public RMNodeLabelsManager createNodeLabelManager(){
      return mgr;
    }
  }
;
  rm1.getRMContext().setNodeLabelManager(mgr);
  rm1.start();
  rm1.registerNode("h1:1234",10 * GB);
  MockNM nm2=rm1.registerNode("h2:1234",10 * GB);
  MockNM nm3=rm1.registerNode("h3:1234",10 * GB);
  rm1.registerNode("h4:1234",10 * GB);
  MockNM nm5=rm1.registerNode("h5:1234",10 * GB);
  RMApp app1=rm1.submitApp(2 * GB,"app","user",null,"a1","y");
  MockRM.launchAndRegisterAM(app1,rm1,nm2);
  RMApp app2=rm1.submitApp(GB,"app","user",null,"a1","y");
  MockRM.launchAndRegisterAM(app2,rm1,nm3);
  rm1.submitApp(GB,"app","user",null,"a1","y");
  CapacityScheduler cs=(CapacityScheduler)rm1.getResourceScheduler();
  LeafQueue leafQueue=(LeafQueue)cs.getQueue("a1");
  Assert.assertNotNull(leafQueue);
  Assert.assertEquals(2,leafQueue.getNumActiveApplications());
  Assert.assertEquals(1,leafQueue.getNumPendingApplications());
  RMApp app3=rm1.submitApp(GB,"app","user",null,"b1");
  MockRM.launchAndRegisterAM(app3,rm1,nm5);
  rm1.submitApp(GB,"app","user",null,"b1");
  leafQueue=(LeafQueue)cs.getQueue("b1");
  Assert.assertNotNull(leafQueue);
  Assert.assertEquals(1,leafQueue.getNumActiveApplications());
  Assert.assertEquals(1,leafQueue.getNumPendingApplications());
  rm1.close();
}
