{
  if (nodes.length == 0)   return nodes;
synchronized (clusterMap) {
    int index=0;
    if (writer == null || !clusterMap.contains(writer)) {
      writer=nodes[0];
    }
    for (; index < nodes.length; index++) {
      DatanodeDescriptor shortestNode=nodes[index];
      int shortestDistance=clusterMap.getDistance(writer,shortestNode);
      int shortestIndex=index;
      for (int i=index + 1; i < nodes.length; i++) {
        DatanodeDescriptor currentNode=nodes[i];
        int currentDistance=clusterMap.getDistance(writer,currentNode);
        if (shortestDistance > currentDistance) {
          shortestDistance=currentDistance;
          shortestNode=currentNode;
          shortestIndex=i;
        }
      }
      if (index != shortestIndex) {
        nodes[shortestIndex]=nodes[index];
        nodes[index]=shortestNode;
      }
      writer=shortestNode;
    }
  }
  return nodes;
}
