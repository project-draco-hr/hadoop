{
  int serverThreads=10, callerCount=100, perCallerCallCount=100;
  TestServer server=new TestIPC.TestServer(serverThreads,false,conf);
  final List<Integer> callIds=Collections.synchronizedList(new ArrayList<Integer>());
  server.callListener=new Runnable(){
    @Override public void run(){
      callIds.add(Server.getCallId());
    }
  }
;
  Client client=new Client(LongWritable.class,conf);
  try {
    InetSocketAddress addr=NetUtils.getConnectAddress(server);
    server.start();
    AsyncCaller[] callers=new AsyncCaller[callerCount];
    for (int i=0; i < callerCount; ++i) {
      callers[i]=new AsyncCaller(client,addr,perCallerCallCount);
      callers[i].start();
    }
    for (int i=0; i < callerCount; ++i) {
      callers[i].join();
      callers[i].waitForReturnValues();
      String msg=String.format("Expected not failed for caller-%d: %s.",i,callers[i]);
      assertFalse(msg,callers[i].failed);
    }
  }
  finally {
    client.stop();
    server.stop();
  }
  int expectedCallCount=callerCount * perCallerCallCount;
  assertEquals(expectedCallCount,callIds.size());
  Collections.sort(callIds);
  final int startID=callIds.get(0).intValue();
  for (int i=0; i < expectedCallCount; ++i) {
    assertEquals(startID + i,callIds.get(i).intValue());
  }
}
