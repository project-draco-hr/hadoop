{
  long start=Time.monotonicNow();
  LOG.info("Checking for block replication for " + filename);
  while (true) {
    boolean replOk=true;
    LocatedBlocks blocks=namenode.getBlockLocations(filename,0,Long.MAX_VALUE);
    for (Iterator<LocatedBlock> iter=blocks.getLocatedBlocks().iterator(); iter.hasNext(); ) {
      LocatedBlock block=iter.next();
      if (isUnderConstruction && !iter.hasNext()) {
        break;
      }
      int actual=block.getLocations().length;
      if (noOverReplication) {
        assertTrue(actual <= expected);
      }
      if (actual < expected) {
        LOG.info("Not enough replicas for " + block.getBlock() + " yet. Expecting "+ expected+ ", got "+ actual+ ".");
        replOk=false;
        break;
      }
    }
    if (replOk) {
      return;
    }
    if (maxWaitSec > 0 && (Time.monotonicNow() - start) > (maxWaitSec * 1000)) {
      throw new IOException("Timedout while waiting for all blocks to " + " be replicated for " + filename);
    }
    try {
      Thread.sleep(500);
    }
 catch (    InterruptedException ignored) {
    }
  }
}
