{
  Set<Node> excludedNodes;
  DatanodeDescriptor[] targets;
  List<DatanodeDescriptor> chosenNodes=new ArrayList<DatanodeDescriptor>();
  excludedNodes=new HashSet<Node>();
  excludedNodes.add(dataNodes[1]);
  targets=chooseTarget(0,chosenNodes,excludedNodes);
  assertEquals(targets.length,0);
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[1]);
  targets=chooseTarget(1,chosenNodes,excludedNodes);
  assertEquals(targets.length,1);
  assertEquals(targets[0],dataNodes[0]);
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[1]);
  targets=chooseTarget(2,chosenNodes,excludedNodes);
  assertEquals(targets.length,2);
  assertEquals(targets[0],dataNodes[0]);
  assertFalse(cluster.isOnSameRack(targets[0],targets[1]));
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[1]);
  targets=chooseTarget(3,chosenNodes,excludedNodes);
  assertEquals(targets.length,3);
  assertEquals(targets[0],dataNodes[0]);
  assertFalse(cluster.isOnSameRack(targets[0],targets[1]));
  assertTrue(cluster.isOnSameRack(targets[1],targets[2]));
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[1]);
  targets=chooseTarget(4,chosenNodes,excludedNodes);
  assertEquals(targets.length,4);
  assertEquals(targets[0],dataNodes[0]);
  for (int i=1; i < 4; i++) {
    assertFalse(cluster.isOnSameRack(targets[0],targets[i]));
  }
  assertTrue(cluster.isOnSameRack(targets[1],targets[2]) || cluster.isOnSameRack(targets[2],targets[3]));
  assertFalse(cluster.isOnSameRack(targets[1],targets[3]));
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[1]);
  chosenNodes.add(dataNodes[2]);
  targets=replicator.chooseTarget(filename,1,dataNodes[0],chosenNodes,true,excludedNodes,BLOCK_SIZE);
  System.out.println("targets=" + Arrays.asList(targets));
  assertEquals(2,targets.length);
  int i=0;
  for (; i < targets.length && !dataNodes[2].equals(targets[i]); i++)   ;
  assertTrue(i < targets.length);
}
