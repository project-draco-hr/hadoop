{
  Namesystem mockNS=mock(Namesystem.class);
  when(mockNS.isPopulatingReplQueues()).thenReturn(true);
  FSClusterStats mockStats=mock(FSClusterStats.class);
  BlockManager bm=new BlockManager(mockNS,mockStats,new HdfsConfiguration());
  UnderReplicatedBlocks underReplicatedBlocks=bm.neededReplications;
  Block block1=new Block(random.nextLong());
  Block block2=new Block(random.nextLong());
  underReplicatedBlocks.add(block1,0,1,1);
  underReplicatedBlocks.add(block2,0,1,1);
  List<List<Block>> chosenBlocks;
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,1,0,0,0,0);
  final BlockInfo info=new BlockInfo(block1,1);
  final MutableBlockCollection mbc=mock(MutableBlockCollection.class);
  when(mbc.getLastBlock()).thenReturn(info);
  when(mbc.getPreferredBlockSize()).thenReturn(block1.getNumBytes() + 1);
  when(mbc.getBlockReplication()).thenReturn((short)1);
  ContentSummary cs=mock(ContentSummary.class);
  when(cs.getLength()).thenReturn((long)1);
  when(mbc.computeContentSummary()).thenReturn(cs);
  info.setBlockCollection(mbc);
  bm.addBlockCollection(info,mbc);
  DatanodeStorageInfo[] storageAry={new DatanodeStorageInfo(dataNodes[0],new DatanodeStorage("s1"))};
  final BlockInfoUnderConstruction ucBlock=info.convertToBlockUnderConstruction(BlockUCState.UNDER_CONSTRUCTION,storageAry);
  when(mbc.setLastBlock((BlockInfo)any(),(DatanodeStorageInfo[])any())).thenReturn(ucBlock);
  bm.convertLastBlockToUnderConstruction(mbc);
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,1,0,0,0,0);
}
