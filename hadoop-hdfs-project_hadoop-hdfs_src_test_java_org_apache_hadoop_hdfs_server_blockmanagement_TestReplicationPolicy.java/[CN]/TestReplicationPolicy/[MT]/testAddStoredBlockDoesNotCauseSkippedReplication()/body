{
  Namesystem mockNS=mock(Namesystem.class);
  when(mockNS.isPopulatingReplQueues()).thenReturn(true);
  when(mockNS.hasWriteLock()).thenReturn(true);
  BlockManager bm=new BlockManager(mockNS,new HdfsConfiguration());
  UnderReplicatedBlocks underReplicatedBlocks=bm.neededReplications;
  BlockInfo block1=genBlockInfo(ThreadLocalRandom.current().nextLong());
  BlockInfo block2=genBlockInfo(ThreadLocalRandom.current().nextLong());
  underReplicatedBlocks.add(block1,0,1,1);
  underReplicatedBlocks.add(block2,0,1,1);
  List<List<BlockInfo>> chosenBlocks;
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,1,0,0,0,0);
  BlockInfoContiguous info=new BlockInfoContiguous(block1,(short)1);
  info.convertToBlockUnderConstruction(BlockUCState.UNDER_CONSTRUCTION,null);
  BlockCollection bc=mock(BlockCollection.class);
  bm.addBlockCollection(info,bc);
  bm.addStoredBlockUnderConstruction(new StatefulBlockInfo(info,info,ReplicaState.FINALIZED),TestReplicationPolicy.storages[0]);
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,1,0,0,0,0);
}
