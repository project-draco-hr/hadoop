{
  Namesystem mockNS=mock(Namesystem.class);
  when(mockNS.isPopulatingReplQueues()).thenReturn(true);
  when(mockNS.hasWriteLock()).thenReturn(true);
  BlockManager bm=new BlockManager(mockNS,new HdfsConfiguration());
  UnderReplicatedBlocks underReplicatedBlocks=bm.neededReplications;
  Block block1=new Block(random.nextLong());
  Block block2=new Block(random.nextLong());
  underReplicatedBlocks.add(block1,0,1,1);
  underReplicatedBlocks.add(block2,0,1,1);
  List<List<Block>> chosenBlocks;
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,1,0,0,0,0);
  BlockInfoUnderConstruction info=new BlockInfoUnderConstruction(block1,(short)1);
  BlockCollection bc=mock(BlockCollection.class);
  when(bc.getBlockReplication()).thenReturn((short)1);
  bm.addBlockCollection(info,bc);
  bm.addStoredBlockUnderConstruction(new StatefulBlockInfo(info,info,ReplicaState.FINALIZED),TestReplicationPolicy.storages[0]);
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,1,0,0,0,0);
}
