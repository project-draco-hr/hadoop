{
  List<DatanodeStorageInfo> replicaList=new ArrayList<DatanodeStorageInfo>();
  final Map<String,List<DatanodeStorageInfo>> rackMap=new HashMap<String,List<DatanodeStorageInfo>>();
  dataNodes[0].setRemaining(4 * 1024 * 1024);
  replicaList.add(storages[0]);
  dataNodes[1].setRemaining(3 * 1024 * 1024);
  replicaList.add(storages[1]);
  dataNodes[2].setRemaining(2 * 1024 * 1024);
  replicaList.add(storages[2]);
  dataNodes[5].setRemaining(1 * 1024 * 1024);
  replicaList.add(storages[5]);
  for (int i=0; i < dataNodes.length; i++) {
    DFSTestUtil.resetLastUpdatesWithOffset(dataNodes[i],0);
  }
  List<DatanodeStorageInfo> first=new ArrayList<DatanodeStorageInfo>();
  List<DatanodeStorageInfo> second=new ArrayList<DatanodeStorageInfo>();
  replicator.splitNodesWithRack(replicaList,rackMap,first,second);
  assertEquals(2,first.size());
  assertEquals(2,second.size());
  List<StorageType> excessTypes=new ArrayList<StorageType>();
{
    excessTypes.add(StorageType.SSD);
    assertNull(replicator.chooseReplicaToDelete(null,null,(short)3,first,second,excessTypes));
  }
  excessTypes.add(StorageType.DEFAULT);
  DatanodeStorageInfo chosen=replicator.chooseReplicaToDelete(null,null,(short)3,first,second,excessTypes);
  assertEquals(chosen,storages[1]);
  replicator.adjustSetsWithChosenReplica(rackMap,first,second,chosen);
  assertEquals(0,first.size());
  assertEquals(3,second.size());
  excessTypes.add(StorageType.DEFAULT);
  chosen=replicator.chooseReplicaToDelete(null,null,(short)2,first,second,excessTypes);
  assertEquals(chosen,storages[5]);
}
