{
  dataNodes[0].setLastUpdate(Time.now() - staleInterval - 1);
  namenode.getNamesystem().getBlockManager().getDatanodeManager().getHeartbeatManager().heartbeatCheck();
  assertTrue(namenode.getNamesystem().getBlockManager().getDatanodeManager().shouldAvoidStaleDataNodesForWrite());
  DatanodeDescriptor[] targets;
  targets=chooseTarget(1);
  assertEquals(targets.length,1);
  assertEquals(targets[0],dataNodes[1]);
  HashMap<Node,Node> excludedNodes=new HashMap<Node,Node>();
  excludedNodes.put(dataNodes[1],dataNodes[1]);
  List<DatanodeDescriptor> chosenNodes=new ArrayList<DatanodeDescriptor>();
  targets=chooseTarget(1,chosenNodes,excludedNodes);
  assertEquals(targets.length,1);
  assertFalse(cluster.isOnSameRack(targets[0],dataNodes[0]));
  dataNodes[0].setLastUpdate(Time.now());
  namenode.getNamesystem().getBlockManager().getDatanodeManager().getHeartbeatManager().heartbeatCheck();
}
