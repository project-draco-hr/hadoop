{
  DFSTestUtil.resetLastUpdatesWithOffset(dataNodes[0],-(staleInterval + 1));
  namenode.getNamesystem().getBlockManager().getDatanodeManager().getHeartbeatManager().heartbeatCheck();
  assertTrue(namenode.getNamesystem().getBlockManager().getDatanodeManager().shouldAvoidStaleDataNodesForWrite());
  DatanodeStorageInfo[] targets;
  targets=chooseTarget(1);
  assertEquals(targets.length,1);
  assertEquals(storages[1],targets[0]);
  Set<Node> excludedNodes=new HashSet<Node>();
  excludedNodes.add(dataNodes[1]);
  List<DatanodeStorageInfo> chosenNodes=new ArrayList<DatanodeStorageInfo>();
  targets=chooseTarget(1,chosenNodes,excludedNodes);
  assertEquals(targets.length,1);
  assertFalse(isOnSameRack(targets[0],dataNodes[0]));
  DFSTestUtil.resetLastUpdatesWithOffset(dataNodes[0],0);
  namenode.getNamesystem().getBlockManager().getDatanodeManager().getHeartbeatManager().heartbeatCheck();
}
