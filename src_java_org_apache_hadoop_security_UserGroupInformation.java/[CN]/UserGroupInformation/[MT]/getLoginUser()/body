{
  if (loginUser == null) {
    try {
      Subject subject=new Subject();
      LoginContext login;
      if (isSecurityEnabled()) {
        login=new LoginContext(HadoopConfiguration.USER_KERBEROS_CONFIG_NAME,subject);
      }
 else {
        login=new LoginContext(HadoopConfiguration.SIMPLE_CONFIG_NAME,subject);
      }
      login.login();
      loginUser=new UserGroupInformation(subject);
      loginUser.setLogin(login);
      loginUser.setAuthenticationMethod(isSecurityEnabled() ? AuthenticationMethod.KERBEROS : AuthenticationMethod.SIMPLE);
      loginUser=new UserGroupInformation(login.getSubject());
      String fileLocation=System.getenv(HADOOP_TOKEN_FILE_LOCATION);
      if (fileLocation != null && isSecurityEnabled()) {
        Credentials cred=Credentials.readTokenStorageFile(new Path("file:///" + fileLocation),conf);
        for (        Token<?> token : cred.getAllTokens()) {
          loginUser.addToken(token);
        }
      }
      loginUser.spawnAutoRenewalThreadForUserCreds();
    }
 catch (    LoginException le) {
      throw new IOException("failure to login",le);
    }
  }
  return loginUser;
}
