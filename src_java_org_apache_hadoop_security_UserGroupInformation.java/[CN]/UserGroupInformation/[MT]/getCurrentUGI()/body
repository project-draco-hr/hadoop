{
  Subject user=getCurrentUser();
  if (user == null) {
    user=currentUser.get();
    if (user == null) {
      return null;
    }
  }
  Set<UserGroupInformation> ugiPrincipals=user.getPrincipals(UserGroupInformation.class);
  UserGroupInformation ugi=null;
  if (ugiPrincipals != null && ugiPrincipals.size() == 1) {
    ugi=ugiPrincipals.iterator().next();
    if (ugi == null) {
      throw new RuntimeException("Cannot find _current user_ UGI in the Subject!");
    }
  }
 else {
    throw new RuntimeException("Cannot resolve current user from subject, " + "which had " + ugiPrincipals.size() + " UGI principals!");
  }
  return ugi;
}
