{
  HdfsConfiguration conf=new HdfsConfiguration();
  conf.setLong(DFSConfigKeys.DFS_BLOCK_SIZE_KEY,BLOCK_SIZE);
  try {
    setup(conf);
    ArrayList<DataNode> dataNodes=cluster.getDataNodes();
    int numDatanodes=dataNodes.size();
    while (numDatanodes >= NUM_DATA_BLOCKS) {
      cluster.stopDataNode(0);
      numDatanodes--;
    }
    cluster.restartNameNodes();
    cluster.triggerHeartbeats();
    DatanodeInfo[] info=dfs.getClient().datanodeReport(DatanodeReportType.LIVE);
    assertEquals("Mismatches number of live Dns ",numDatanodes,info.length);
    final Path dirFile=new Path(dir,"ecfile");
    FSDataOutputStream out;
    try {
      out=dfs.create(dirFile,true);
      out.write("something".getBytes());
      out.flush();
      out.close();
      Assert.fail("Failed to validate available dns against blkGroupSize");
    }
 catch (    IOException ioe) {
      GenericTestUtils.assertExceptionContains("Failed to get " + NUM_DATA_BLOCKS + " nodes from namenode: blockGroupSize= "+ (NUM_DATA_BLOCKS + NUM_PARITY_BLOCKS)+ ", blocks.length= "+ numDatanodes,ioe);
    }
  }
  finally {
    tearDown();
  }
}
