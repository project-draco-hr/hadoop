{
  HdfsConfiguration conf=new HdfsConfiguration();
  conf.setLong(DFSConfigKeys.DFS_BLOCK_SIZE_KEY,BLOCK_SIZE);
  try {
    setup(conf);
    ArrayList<DataNode> dataNodes=cluster.getDataNodes();
    int killDns=dataNodes.size() / 2;
    int numDatanodes=dataNodes.size() - killDns;
    for (int i=0; i < killDns; i++) {
      cluster.stopDataNode(i);
    }
    cluster.restartNameNodes();
    cluster.triggerHeartbeats();
    DatanodeInfo[] info=dfs.getClient().datanodeReport(DatanodeReportType.LIVE);
    assertEquals("Mismatches number of live Dns ",numDatanodes,info.length);
    final Path dirFile=new Path(dir,"ecfile");
    FSDataOutputStream out=null;
    try {
      out=dfs.create(dirFile,true);
      out.write("something".getBytes());
      out.flush();
      out.close();
      Assert.fail("Failed to validate available dns against blkGroupSize");
    }
 catch (    IOException ioe) {
      GenericTestUtils.assertExceptionContains("Failed: the number of " + "remaining blocks = 5 < the number of data blocks = 6",ioe);
      DFSStripedOutputStream dfsout=(DFSStripedOutputStream)out.getWrappedStream();
      StripedDataStreamer datastreamer=dfsout.getStripedDataStreamer(0);
      try {
        datastreamer.getLastException().check(true);
        Assert.fail("Failed to validate available dns against blkGroupSize");
      }
 catch (      IOException le) {
        GenericTestUtils.assertExceptionContains("Failed to get datablocks number of nodes from" + " namenode: blockGroupSize= 9, blocks.length= " + numDatanodes,le);
      }
    }
  }
  finally {
    tearDown();
  }
}
