{
  CSAssignment assigned;
  NodeType requestType=null;
  MutableObject allocatedContainer=new MutableObject();
  ResourceRequest nodeLocalResourceRequest=getResourceRequest(priority,node.getNodeName());
  if (nodeLocalResourceRequest != null) {
    requestType=NodeType.NODE_LOCAL;
    assigned=assignNodeLocalContainers(clusterResource,nodeLocalResourceRequest,node,priority,reservedContainer,allocatedContainer,schedulingMode,currentResoureLimits);
    if (Resources.greaterThan(rc,clusterResource,assigned.getResource(),Resources.none())) {
      if (allocatedContainer.getValue() != null) {
        incNumAllocatedContainers(NodeType.NODE_LOCAL,requestType);
      }
      assigned.setType(NodeType.NODE_LOCAL);
      return assigned;
    }
  }
  ResourceRequest rackLocalResourceRequest=getResourceRequest(priority,node.getRackName());
  if (rackLocalResourceRequest != null) {
    if (!rackLocalResourceRequest.getRelaxLocality()) {
      return SKIP_ASSIGNMENT;
    }
    if (requestType != NodeType.NODE_LOCAL) {
      requestType=NodeType.RACK_LOCAL;
    }
    assigned=assignRackLocalContainers(clusterResource,rackLocalResourceRequest,node,priority,reservedContainer,allocatedContainer,schedulingMode,currentResoureLimits);
    if (Resources.greaterThan(rc,clusterResource,assigned.getResource(),Resources.none())) {
      if (allocatedContainer.getValue() != null) {
        incNumAllocatedContainers(NodeType.RACK_LOCAL,requestType);
      }
      assigned.setType(NodeType.RACK_LOCAL);
      return assigned;
    }
  }
  ResourceRequest offSwitchResourceRequest=getResourceRequest(priority,ResourceRequest.ANY);
  if (offSwitchResourceRequest != null) {
    if (!offSwitchResourceRequest.getRelaxLocality()) {
      return SKIP_ASSIGNMENT;
    }
    if (requestType != NodeType.NODE_LOCAL && requestType != NodeType.RACK_LOCAL) {
      requestType=NodeType.OFF_SWITCH;
    }
    assigned=assignOffSwitchContainers(clusterResource,offSwitchResourceRequest,node,priority,reservedContainer,allocatedContainer,schedulingMode,currentResoureLimits);
    if (allocatedContainer.getValue() != null) {
      incNumAllocatedContainers(NodeType.OFF_SWITCH,requestType);
    }
    assigned.setType(NodeType.OFF_SWITCH);
    return assigned;
  }
  return SKIP_ASSIGNMENT;
}
