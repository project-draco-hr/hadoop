{
  final FsDatasetSpi.Factory<? extends FsDatasetSpi<?>> factory=FsDatasetSpi.Factory.getFactory(conf);
  if (!factory.isSimulated()) {
    final StartupOption startOpt=getStartupOption(conf);
    if (startOpt == null) {
      throw new IOException("Startup option not set.");
    }
    final String bpid=nsInfo.getBlockPoolID();
synchronized (this) {
      storage.recoverTransitionRead(this,nsInfo,dataDirs,startOpt);
    }
    final StorageInfo bpStorage=storage.getBPStorage(bpid);
    LOG.info("Setting up storage: nsid=" + bpStorage.getNamespaceID() + ";bpid="+ bpid+ ";lv="+ storage.getLayoutVersion()+ ";nsInfo="+ nsInfo+ ";dnuuid="+ storage.getDatanodeUuid());
  }
  checkDatanodeUuid();
synchronized (this) {
    if (data == null) {
      data=factory.newInstance(this,storage,conf);
    }
  }
}
