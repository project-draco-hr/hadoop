{
  StorageInfo storageInfo=storage.getBPStorage(nsInfo.getBlockPoolID());
  if (storageInfo == null) {
    storageInfo=new StorageInfo(nsInfo);
  }
  checkDatanodeUuid();
  DatanodeID dnId=new DatanodeID(streamingAddr.getAddress().getHostAddress(),hostName,storage.getDatanodeUuid(),getXferPort(),getInfoPort(),infoSecurePort,getIpcPort());
  return new DatanodeRegistration(dnId,storageInfo,new ExportedBlockKeys(),VersionInfo.getVersion());
}
