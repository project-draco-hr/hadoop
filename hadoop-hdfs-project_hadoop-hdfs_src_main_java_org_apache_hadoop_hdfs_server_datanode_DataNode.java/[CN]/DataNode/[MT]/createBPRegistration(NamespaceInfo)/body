{
  final String xferIp=streamingAddr.getAddress().getHostAddress();
  DatanodeRegistration bpRegistration=new DatanodeRegistration(xferIp);
  bpRegistration.setXferPort(getXferPort());
  bpRegistration.setInfoPort(getInfoPort());
  bpRegistration.setIpcPort(getIpcPort());
  bpRegistration.setHostName(hostName);
  bpRegistration.setStorageID(getStorageId());
  StorageInfo storageInfo=storage.getBPStorage(nsInfo.getBlockPoolID());
  if (storageInfo == null) {
    bpRegistration.getStorageInfo().layoutVersion=HdfsConstants.LAYOUT_VERSION;
    bpRegistration.setStorageInfo(nsInfo);
  }
 else {
    bpRegistration.setStorageInfo(storageInfo);
  }
  return bpRegistration;
}
