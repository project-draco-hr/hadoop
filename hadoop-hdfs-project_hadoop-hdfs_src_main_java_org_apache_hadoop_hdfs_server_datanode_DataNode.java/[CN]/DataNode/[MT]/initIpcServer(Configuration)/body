{
  InetSocketAddress ipcAddr=NetUtils.createSocketAddr(conf.get(DFS_DATANODE_IPC_ADDRESS_KEY));
  RPC.setProtocolEngine(conf,ClientDatanodeProtocolPB.class,ProtobufRpcEngine.class);
  ClientDatanodeProtocolServerSideTranslatorPB clientDatanodeProtocolXlator=new ClientDatanodeProtocolServerSideTranslatorPB(this);
  BlockingService service=ClientDatanodeProtocolService.newReflectiveBlockingService(clientDatanodeProtocolXlator);
  ipcServer=new RPC.Builder(conf).setProtocol(ClientDatanodeProtocolPB.class).setInstance(service).setBindAddress(ipcAddr.getHostName()).setPort(ipcAddr.getPort()).setNumHandlers(conf.getInt(DFS_DATANODE_HANDLER_COUNT_KEY,DFS_DATANODE_HANDLER_COUNT_DEFAULT)).setVerbose(false).setSecretManager(blockPoolTokenSecretManager).build();
  InterDatanodeProtocolServerSideTranslatorPB interDatanodeProtocolXlator=new InterDatanodeProtocolServerSideTranslatorPB(this);
  service=InterDatanodeProtocolService.newReflectiveBlockingService(interDatanodeProtocolXlator);
  DFSUtil.addPBProtocol(conf,InterDatanodeProtocolPB.class,service,ipcServer);
  TraceAdminProtocolServerSideTranslatorPB traceAdminXlator=new TraceAdminProtocolServerSideTranslatorPB(this);
  BlockingService traceAdminService=TraceAdminService.newReflectiveBlockingService(traceAdminXlator);
  DFSUtil.addPBProtocol(conf,TraceAdminProtocolPB.class,traceAdminService,ipcServer);
  LOG.info("Opened IPC server at " + ipcServer.getListenerAddress());
  if (conf.getBoolean(CommonConfigurationKeys.HADOOP_SECURITY_AUTHORIZATION,false)) {
    ipcServer.refreshServiceAcl(conf,new HDFSPolicyProvider());
  }
}
