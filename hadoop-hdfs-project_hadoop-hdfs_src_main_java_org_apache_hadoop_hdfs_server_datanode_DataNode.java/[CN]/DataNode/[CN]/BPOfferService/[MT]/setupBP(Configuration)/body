{
  DatanodeProtocol dnp=(DatanodeProtocol)RPC.waitForProxy(DatanodeProtocol.class,DatanodeProtocol.versionID,nnAddr,conf);
  setNameNode(dnp);
  NamespaceInfo nsInfo=handshake();
  setNamespaceInfo(nsInfo);
  dn.initBlockPool(this,nsInfo);
  bpRegistration.setStorageID(dn.getStorageId());
  StorageInfo storageInfo=dn.storage.getBPStorage(blockPoolId);
  if (storageInfo == null) {
    bpRegistration.storageInfo.layoutVersion=HdfsConstants.LAYOUT_VERSION;
    bpRegistration.setStorageInfo(nsInfo);
  }
 else {
    bpRegistration.setStorageInfo(storageInfo);
  }
}
