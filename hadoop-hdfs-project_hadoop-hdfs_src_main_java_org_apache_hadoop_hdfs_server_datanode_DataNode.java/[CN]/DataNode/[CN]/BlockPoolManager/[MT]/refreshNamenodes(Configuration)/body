{
  LOG.info("Refresh request received for nameservices: " + conf.get(DFS_FEDERATION_NAMESERVICES));
  Map<String,Map<String,InetSocketAddress>> newAddressMap=DFSUtil.getNNServiceRpcAddresses(conf);
  Set<InetSocketAddress> newAddresses=Sets.newHashSet();
  for (  ConfiguredNNAddress cnn : DFSUtil.flattenAddressMap(newAddressMap)) {
    newAddresses.add(cnn.getAddress());
  }
  List<BPOfferService> toShutdown=new ArrayList<BPOfferService>();
  List<InetSocketAddress> toStart=new ArrayList<InetSocketAddress>();
synchronized (refreshNamenodesLock) {
synchronized (this) {
      for (      InetSocketAddress nnaddr : nameNodeThreads.keySet()) {
        if (!(newAddresses.contains(nnaddr))) {
          toShutdown.add(nameNodeThreads.get(nnaddr));
        }
      }
      for (      InetSocketAddress nnaddr : newAddresses) {
        if (!(nameNodeThreads.containsKey(nnaddr))) {
          toStart.add(nnaddr);
        }
      }
      for (      InetSocketAddress nnaddr : toStart) {
        BPOfferService bpos=new BPOfferService(nnaddr,DataNode.this);
        nameNodeThreads.put(bpos.getNNSocketAddress(),bpos);
      }
    }
    for (    BPOfferService bpos : toShutdown) {
      bpos.stop();
      bpos.join();
    }
    startAll();
  }
}
