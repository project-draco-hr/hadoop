{
  checkStream();
  if (in instanceof ByteBufferReadable) {
    int unread=outBuffer.remaining();
    if (unread > 0) {
      int toRead=buf.remaining();
      if (toRead <= unread) {
        int limit=outBuffer.limit();
        outBuffer.limit(outBuffer.position() + toRead);
        buf.put(outBuffer);
        outBuffer.limit(limit);
        return toRead;
      }
 else {
        buf.put(outBuffer);
      }
    }
    int pos=buf.position();
    int n=((ByteBufferReadable)in).read(buf);
    if (n > 0) {
      streamOffset+=n;
      decrypt(buf,n,pos);
    }
    return n;
  }
  throw new UnsupportedOperationException("ByteBuffer read unsupported " + "by input stream.");
}
