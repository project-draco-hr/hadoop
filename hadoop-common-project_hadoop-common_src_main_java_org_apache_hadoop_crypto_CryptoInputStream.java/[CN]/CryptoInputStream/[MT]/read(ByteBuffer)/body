{
  checkStream();
  if (in instanceof ByteBufferReadable) {
    final int unread=outBuffer.remaining();
    if (unread > 0) {
      int toRead=buf.remaining();
      if (toRead <= unread) {
        final int limit=outBuffer.limit();
        outBuffer.limit(outBuffer.position() + toRead);
        buf.put(outBuffer);
        outBuffer.limit(limit);
        return toRead;
      }
 else {
        buf.put(outBuffer);
      }
    }
    final int pos=buf.position();
    final int n=((ByteBufferReadable)in).read(buf);
    if (n > 0) {
      streamOffset+=n;
      decrypt(buf,n,pos);
    }
    if (n >= 0) {
      return unread + n;
    }
 else {
      if (unread == 0) {
        return -1;
      }
 else {
        return unread;
      }
    }
  }
  throw new UnsupportedOperationException("ByteBuffer read unsupported " + "by input stream.");
}
