{
  byte[] tmp=getTmpBuf();
  int unread=outBuffer.remaining();
  if (unread > 0) {
    outBuffer.get(tmp,0,unread);
  }
  long curOffset=streamOffset;
  resetStreamOffset(position);
  int n=0;
  while (n < length) {
    int toDecrypt=Math.min(length - n,inBuffer.remaining());
    inBuffer.put(buffer,offset + n,toDecrypt);
    decrypt();
    outBuffer.get(buffer,offset + n,toDecrypt);
    n+=toDecrypt;
  }
  resetStreamOffset(curOffset);
  if (unread > 0) {
    outBuffer.clear();
    outBuffer.put(tmp,0,unread);
    outBuffer.flip();
  }
}
