{
  ByteBuffer inBuffer=getBuffer();
  ByteBuffer outBuffer=getBuffer();
  Decryptor decryptor=null;
  try {
    decryptor=getDecryptor();
    byte[] iv=initIV.clone();
    updateDecryptor(decryptor,position,iv);
    byte padding=getPadding(position);
    inBuffer.position(padding);
    int n=0;
    while (n < length) {
      int toDecrypt=Math.min(length - n,inBuffer.remaining());
      inBuffer.put(buffer,offset + n,toDecrypt);
      decrypt(decryptor,inBuffer,outBuffer,padding);
      outBuffer.get(buffer,offset + n,toDecrypt);
      n+=toDecrypt;
      padding=afterDecryption(decryptor,inBuffer,position + n,iv);
    }
  }
  finally {
    returnBuffer(inBuffer);
    returnBuffer(outBuffer);
    returnDecryptor(decryptor);
  }
}
