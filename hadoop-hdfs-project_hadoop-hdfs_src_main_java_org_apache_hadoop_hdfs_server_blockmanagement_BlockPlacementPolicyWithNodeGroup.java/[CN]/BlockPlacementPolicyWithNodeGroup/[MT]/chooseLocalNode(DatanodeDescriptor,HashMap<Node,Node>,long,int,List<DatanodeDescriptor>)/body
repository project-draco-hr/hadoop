{
  if (localMachine == null)   return chooseRandom(NodeBase.ROOT,excludedNodes,blocksize,maxNodesPerRack,results);
  Node oldNode=excludedNodes.put(localMachine,localMachine);
  if (oldNode == null) {
    if (isGoodTarget(localMachine,blocksize,maxNodesPerRack,false,results)) {
      results.add(localMachine);
      addNodeGroupToExcludedNodes(excludedNodes,localMachine.getNetworkLocation());
      return localMachine;
    }
  }
  DatanodeDescriptor chosenNode=chooseLocalNodeGroup((NetworkTopologyWithNodeGroup)clusterMap,localMachine,excludedNodes,blocksize,maxNodesPerRack,results);
  if (chosenNode != null) {
    return chosenNode;
  }
  return chooseLocalRack(localMachine,excludedNodes,blocksize,maxNodesPerRack,results);
}
