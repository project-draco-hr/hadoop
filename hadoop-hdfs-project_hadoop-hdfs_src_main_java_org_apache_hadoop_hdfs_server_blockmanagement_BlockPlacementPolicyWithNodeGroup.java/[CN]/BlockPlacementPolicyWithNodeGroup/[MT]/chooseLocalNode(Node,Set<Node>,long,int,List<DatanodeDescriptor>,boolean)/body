{
  if (localMachine == null)   return chooseRandom(NodeBase.ROOT,excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes);
  if (localMachine instanceof DatanodeDescriptor) {
    DatanodeDescriptor localDataNode=(DatanodeDescriptor)localMachine;
    if (excludedNodes.add(localMachine)) {
      if (addIfIsGoodTarget(localDataNode,excludedNodes,blocksize,maxNodesPerRack,false,results,avoidStaleNodes) >= 0) {
        return localDataNode;
      }
    }
  }
  DatanodeDescriptor chosenNode=chooseLocalNodeGroup((NetworkTopologyWithNodeGroup)clusterMap,localMachine,excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes);
  if (chosenNode != null) {
    return chosenNode;
  }
  return chooseLocalRack(localMachine,excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes);
}
