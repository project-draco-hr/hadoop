{
  if (localMachine == null) {
    return chooseRandom(NodeBase.ROOT,excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes,storageType);
  }
  try {
    final String scope=NetworkTopology.getFirstHalf(localMachine.getNetworkLocation());
    return chooseRandom(scope,excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes,storageType);
  }
 catch (  NotEnoughReplicasException e1) {
    final DatanodeDescriptor newLocal=secondNode(localMachine,results);
    if (newLocal != null) {
      try {
        return chooseRandom(clusterMap.getRack(newLocal.getNetworkLocation()),excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes,storageType);
      }
 catch (      NotEnoughReplicasException e2) {
        return chooseRandom(NodeBase.ROOT,excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes,storageType);
      }
    }
 else {
      return chooseRandom(NodeBase.ROOT,excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes,storageType);
    }
  }
}
