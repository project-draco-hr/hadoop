{
  if (localMachine == null)   return chooseRandom(NodeBase.ROOT,excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes,storageTypes);
  if (localMachine instanceof DatanodeDescriptor) {
    DatanodeDescriptor localDataNode=(DatanodeDescriptor)localMachine;
    if (excludedNodes.add(localMachine)) {
      for (Iterator<Map.Entry<StorageType,Integer>> iter=storageTypes.entrySet().iterator(); iter.hasNext(); ) {
        Map.Entry<StorageType,Integer> entry=iter.next();
        for (        DatanodeStorageInfo localStorage : DFSUtil.shuffle(localDataNode.getStorageInfos())) {
          StorageType type=entry.getKey();
          if (addIfIsGoodTarget(localStorage,excludedNodes,blocksize,maxNodesPerRack,false,results,avoidStaleNodes,type) >= 0) {
            int num=entry.getValue();
            if (num == 1) {
              iter.remove();
            }
 else {
              entry.setValue(num - 1);
            }
            return localStorage;
          }
        }
      }
    }
  }
  DatanodeStorageInfo chosenStorage=chooseLocalNodeGroup((NetworkTopologyWithNodeGroup)clusterMap,localMachine,excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes,storageTypes);
  if (chosenStorage != null) {
    return chosenStorage;
  }
  if (!fallbackToLocalRack) {
    return null;
  }
  return chooseLocalRack(localMachine,excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes,storageTypes);
}
