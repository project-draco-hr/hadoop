{
  DatanodeInfo d=cluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().getDatanodeByXferAddr(datanodes.get(0).getXferAddress().getAddress().getHostAddress(),datanodes.get(0).getXferAddress().getPort());
  d.setDecommissioned();
  InetSocketAddress addrs[]=new InetSocketAddress[3];
  for (int i=0; i < 3; i++) {
    addrs[i]=datanodes.get(i).getXferAddress();
  }
  Path p=new Path("/filename-foo-bar-baz");
  FSDataOutputStream out=dfs.create(p,FsPermission.getDefault(),true,4096,(short)3,(long)4096,null,addrs);
  out.write(SOME_BYTES);
  out.close();
  d.stopDecommission();
  BlockLocation[] locations=getBlockLocations(p);
  String datanode0=datanodes.get(0).getXferAddress().getAddress().getHostAddress() + ":" + datanodes.get(0).getXferAddress().getPort();
  for (int i=0; i < 3; i++) {
    if (locations[0].getNames()[i].equals(datanode0)) {
      fail(datanode0 + " not supposed to be a replica for the block");
    }
  }
}
