{
  if (checkForUpgrades) {
    boolean needUpgrade=false;
    try {
      needUpgrade=upgradeManager.startUpgrade();
    }
 catch (    IOException e) {
      FSNamesystem.LOG.error("IOException in startDistributedUpgradeIfNeeded",e);
    }
    if (needUpgrade) {
      safeMode=new SafeModeInfo(false);
      return;
    }
  }
  if (!isPopulatingReplQueues() && !isInStandbyState()) {
    initializeReplQueues();
  }
  long timeInSafemode=now() - systemStart;
  NameNode.stateChangeLog.info("STATE* Leaving safe mode after " + timeInSafemode / 1000 + " secs.");
  NameNode.getNameNodeMetrics().setSafeModeTime((int)timeInSafemode);
  if (reached >= 0) {
    NameNode.stateChangeLog.info("STATE* Safe mode is OFF.");
  }
  reached=-1;
  safeMode=null;
  final NetworkTopology nt=blockManager.getDatanodeManager().getNetworkTopology();
  NameNode.stateChangeLog.info("STATE* Network topology has " + nt.getNumOfRacks() + " racks and "+ nt.getNumOfLeaves()+ " datanodes");
  NameNode.stateChangeLog.info("STATE* UnderReplicatedBlocks has " + blockManager.numOfUnderReplicatedBlocks() + " blocks");
}
