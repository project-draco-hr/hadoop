{
  readLock();
  try {
    final int maxTransfer=blockManager.getMaxReplicationStreams() - xmitsInProgress;
    DatanodeCommand[] cmds=blockManager.getDatanodeManager().handleHeartbeat(nodeReg,reports,getBlockPoolId(),cacheCapacity,cacheUsed,xceiverCount,maxTransfer,failedVolumes,volumeFailureSummary);
    long blockReportLeaseId=0;
    if (requestFullBlockReportLease) {
      blockReportLeaseId=blockManager.requestBlockReportLeaseId(nodeReg);
    }
    final NNHAStatusHeartbeat haState=new NNHAStatusHeartbeat(haContext.getState().getServiceState(),getFSImage().getLastAppliedOrWrittenTxId());
    return new HeartbeatResponse(cmds,haState,rollingUpgradeInfo,blockReportLeaseId);
  }
  finally {
    readUnlock();
  }
}
