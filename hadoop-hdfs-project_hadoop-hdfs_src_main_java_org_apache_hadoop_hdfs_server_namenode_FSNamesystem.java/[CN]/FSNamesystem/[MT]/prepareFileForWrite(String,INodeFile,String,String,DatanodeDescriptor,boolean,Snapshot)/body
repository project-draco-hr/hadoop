{
  if (latestSnapshot != null) {
    file=(INodeFile)file.recordModification(latestSnapshot).left;
  }
  final INodeFileUnderConstruction cons=file.toUnderConstruction(leaseHolder,clientMachine,clientNode);
  dir.replaceINodeFile(src,file,cons,latestSnapshot);
  leaseManager.addLease(cons.getClientName(),src);
  LocatedBlock ret=blockManager.convertLastBlockToUnderConstruction(cons);
  if (writeToEditLog) {
    getEditLog().logOpenFile(src,cons);
  }
  return ret;
}
