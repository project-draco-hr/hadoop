{
  checkConfiguration(conf);
  FSImage fsImage=new FSImage(conf,FSNamesystem.getNamespaceDirs(conf),FSNamesystem.getNamespaceEditsDirs(conf));
  FSNamesystem namesystem=new FSNamesystem(conf,fsImage,false);
  StartupOption startOpt=NameNode.getStartupOption(conf);
  if (startOpt == StartupOption.RECOVER) {
    namesystem.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
  }
  long loadStart=now();
  String nameserviceId=DFSUtil.getNamenodeNameServiceId(conf);
  try {
    namesystem.loadFSImage(startOpt,fsImage,HAUtil.isHAEnabled(conf,nameserviceId));
  }
 catch (  IOException ioe) {
    LOG.warn("Encountered exception loading fsimage",ioe);
    fsImage.close();
    throw ioe;
  }
  long timeTakenToLoadFSImage=now() - loadStart;
  LOG.info("Finished loading FSImage in " + timeTakenToLoadFSImage + " msecs");
  NameNodeMetrics nnMetrics=NameNode.getNameNodeMetrics();
  if (nnMetrics != null) {
    nnMetrics.setFsImageLoadTime((int)timeTakenToLoadFSImage);
  }
  return namesystem;
}
