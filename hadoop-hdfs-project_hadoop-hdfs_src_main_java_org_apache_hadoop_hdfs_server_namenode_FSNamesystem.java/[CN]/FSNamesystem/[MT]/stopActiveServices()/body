{
  LOG.info("Stopping services started for active state");
  writeLock();
  try {
    stopSecretManager();
    leaseManager.stopMonitor();
    if (nnrmthread != null) {
      ((NameNodeResourceMonitor)nnrmthread.getRunnable()).stopMonitor();
      nnrmthread.interrupt();
    }
    if (nnEditLogRoller != null) {
      ((NameNodeEditLogRoller)nnEditLogRoller.getRunnable()).stop();
      nnEditLogRoller.interrupt();
    }
    if (lazyPersistFileScrubber != null) {
      ((LazyPersistFileScrubber)lazyPersistFileScrubber.getRunnable()).stop();
      lazyPersistFileScrubber.interrupt();
    }
    if (dir != null && getFSImage() != null) {
      if (getFSImage().editLog != null) {
        getFSImage().editLog.close();
      }
      getFSImage().updateLastAppliedTxIdFromWritten();
    }
    if (cacheManager != null) {
      cacheManager.stopMonitorThread();
      cacheManager.clearDirectiveStats();
    }
    if (blockManager != null) {
      blockManager.getDatanodeManager().clearPendingCachingCommands();
      blockManager.getDatanodeManager().setShouldSendCachingCommands(false);
      blockManager.clearQueues();
    }
    initializedReplQueues=false;
  }
  finally {
    writeUnlock();
  }
}
