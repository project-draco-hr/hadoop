{
  LOG.info("Stopping services started for active state");
  writeLock();
  try {
    stopSecretManager();
    if (leaseManager != null) {
      leaseManager.stopMonitor();
    }
    if (nnrmthread != null) {
      ((NameNodeResourceMonitor)nnrmthread.getRunnable()).stopMonitor();
      nnrmthread.interrupt();
    }
    if (nnEditLogRoller != null) {
      ((NameNodeEditLogRoller)nnEditLogRoller.getRunnable()).stop();
      nnEditLogRoller.interrupt();
    }
    if (dir != null && dir.fsImage != null) {
      if (dir.fsImage.editLog != null) {
        dir.fsImage.editLog.close();
      }
      dir.fsImage.updateLastAppliedTxIdFromWritten();
    }
    cacheManager.deactivate();
    blockManager.getDatanodeManager().setShouldSendCachingCommands(false);
  }
  finally {
    writeUnlock();
  }
}
