{
  readLock();
  try {
    final int maxTransfer=blockManager.getMaxReplicationStreams() - xmitsInProgress;
    DatanodeCommand[] cmds=blockManager.getDatanodeManager().handleHeartbeat(nodeReg,reports,blockPoolId,xceiverCount,maxTransfer,failedVolumes);
    return new HeartbeatResponse(cmds,createHaStatusHeartbeat());
  }
  finally {
    readUnlock();
  }
}
