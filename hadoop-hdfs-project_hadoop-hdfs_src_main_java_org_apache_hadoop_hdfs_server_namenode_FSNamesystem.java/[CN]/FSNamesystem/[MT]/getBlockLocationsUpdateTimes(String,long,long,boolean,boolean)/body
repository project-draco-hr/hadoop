{
  FSPermissionChecker pc=getPermissionChecker();
  byte[][] pathComponents=FSDirectory.getPathComponentsForReservedPath(src);
  for (int attempt=0; attempt < 2; attempt++) {
    boolean isReadOp=(attempt == 0);
    if (isReadOp) {
      checkOperation(OperationCategory.READ);
      readLock();
    }
 else {
      checkOperation(OperationCategory.WRITE);
      writeLock();
    }
    src=FSDirectory.resolvePath(src,pathComponents,dir);
    try {
      if (isReadOp) {
        checkOperation(OperationCategory.READ);
      }
 else {
        checkOperation(OperationCategory.WRITE);
      }
      if (isPermissionEnabled) {
        checkPathAccess(pc,src,FsAction.READ);
      }
      if (isInSafeMode()) {
        doAccessTime=false;
      }
      final INodesInPath iip=dir.getLastINodeInPath(src);
      final INodeFile inode=INodeFile.valueOf(iip.getLastINode(),src);
      if (!iip.isSnapshot() && doAccessTime && isAccessTimeSupported()) {
        final long now=now();
        if (now > inode.getAccessTime() + getAccessTimePrecision()) {
          if (isReadOp) {
            continue;
          }
          boolean changed=dir.setTimes(inode,-1,now,false,iip.getLatestSnapshotId());
          if (changed) {
            getEditLog().logTimes(src,-1,now);
          }
        }
      }
      final long fileSize=iip.isSnapshot() ? inode.computeFileSize(iip.getPathSnapshotId()) : inode.computeFileSizeNotIncludingLastUcBlock();
      boolean isUc=inode.isUnderConstruction();
      if (iip.isSnapshot()) {
        length=Math.min(length,fileSize - offset);
        isUc=false;
      }
      LocatedBlocks blocks=blockManager.createLocatedBlocks(inode.getBlocks(),fileSize,isUc,offset,length,needBlockToken,iip.isSnapshot());
      for (      LocatedBlock lb : blocks.getLocatedBlocks()) {
        cacheManager.setCachedLocations(lb);
      }
      return blocks;
    }
  finally {
      if (isReadOp) {
        readUnlock();
      }
 else {
        writeUnlock();
      }
    }
  }
  return null;
}
