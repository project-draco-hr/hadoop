{
  for (int attempt=0; attempt < 2; attempt++) {
    boolean isReadOp=(attempt == 0);
    if (isReadOp) {
      checkOperation(OperationCategory.READ);
      readLock();
    }
 else {
      checkOperation(OperationCategory.WRITE);
      writeLock();
    }
    try {
      if (isReadOp) {
        checkOperation(OperationCategory.READ);
      }
 else {
        checkOperation(OperationCategory.WRITE);
      }
      if (isInSafeMode()) {
        doAccessTime=false;
      }
      long now=now();
      final INodeFile inode=INodeFile.valueOf(dir.getINode(src),src);
      if (doAccessTime && isAccessTimeSupported()) {
        if (now <= inode.getAccessTime() + getAccessTimePrecision()) {
          if (isReadOp) {
            continue;
          }
        }
        dir.setTimes(src,inode,-1,now,false);
      }
      return blockManager.createLocatedBlocks(inode.getBlocks(),inode.computeFileSize(false),inode.isUnderConstruction(),offset,length,needBlockToken);
    }
  finally {
      if (isReadOp) {
        readUnlock();
      }
 else {
        writeUnlock();
      }
    }
  }
  return null;
}
