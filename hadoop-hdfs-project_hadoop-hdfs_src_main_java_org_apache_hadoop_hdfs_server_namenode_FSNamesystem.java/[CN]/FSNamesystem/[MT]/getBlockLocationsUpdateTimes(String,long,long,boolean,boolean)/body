{
  for (int attempt=0; attempt < 2; attempt++) {
    if (attempt == 0) {
      readLock();
    }
 else {
      writeLock();
    }
    try {
      checkOperation(OperationCategory.READ);
      if (isInSafeMode()) {
        doAccessTime=false;
      }
      final INodesInPath iip=dir.getLastINodeInPath(src);
      final INodeFile inode=INodeFile.valueOf(iip.getLastINode(),src);
      if (!iip.isSnapshot() && doAccessTime && isAccessTimeSupported()) {
        final long now=now();
        if (now <= inode.getAccessTime() + getAccessTimePrecision()) {
          if (attempt == 0) {
            continue;
          }
        }
        dir.setTimes(src,inode,-1,now,false,iip.getLatestSnapshot());
      }
      final long fileSize=iip.getPathSnapshot() != null ? inode.computeFileSize(iip.getPathSnapshot()) : inode.computeFileSizeNotIncludingLastUcBlock();
      return blockManager.createLocatedBlocks(inode.getBlocks(),fileSize,inode.isUnderConstruction(),offset,length,needBlockToken);
    }
  finally {
      if (attempt == 0) {
        readUnlock();
      }
 else {
        writeUnlock();
      }
    }
  }
  return null;
}
