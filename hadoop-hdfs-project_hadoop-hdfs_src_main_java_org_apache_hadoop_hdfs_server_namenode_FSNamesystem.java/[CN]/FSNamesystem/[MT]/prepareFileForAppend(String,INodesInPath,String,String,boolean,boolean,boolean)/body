{
  final INodeFile file=iip.getLastINode().asFile();
  file.recordModification(iip.getLatestSnapshotId());
  file.toUnderConstruction(leaseHolder,clientMachine);
  leaseManager.addLease(file.getFileUnderConstructionFeature().getClientName(),src);
  LocatedBlock ret=null;
  if (!newBlock) {
    ret=blockManager.convertLastBlockToUnderConstruction(file,0);
    if (ret != null) {
      final long diff=file.getPreferredBlockSize() - ret.getBlockSize();
      dir.updateSpaceConsumed(iip,0,diff * file.getBlockReplication());
    }
  }
 else {
    BlockInfoContiguous lastBlock=file.getLastBlock();
    if (lastBlock != null) {
      ExtendedBlock blk=new ExtendedBlock(this.getBlockPoolId(),lastBlock);
      ret=new LocatedBlock(blk,new DatanodeInfo[0]);
    }
  }
  if (writeToEditLog) {
    getEditLog().logAppendFile(src,file,newBlock,logRetryCache);
  }
  return ret;
}
