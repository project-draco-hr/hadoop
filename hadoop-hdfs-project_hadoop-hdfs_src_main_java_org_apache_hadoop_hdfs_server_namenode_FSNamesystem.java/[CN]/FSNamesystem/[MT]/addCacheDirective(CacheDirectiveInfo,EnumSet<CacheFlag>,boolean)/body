{
  checkOperation(OperationCategory.WRITE);
  CacheDirectiveInfo effectiveDirective=null;
  if (!flags.contains(CacheFlag.FORCE)) {
    cacheManager.waitForRescanIfNeeded();
  }
  writeLock();
  try {
    checkOperation(OperationCategory.WRITE);
    if (isInSafeMode()) {
      throw new SafeModeException("Cannot add cache directive",safeMode);
    }
    effectiveDirective=FSNDNCacheOp.addCacheDirective(this,cacheManager,directive,flags,logRetryCache);
  }
  finally {
    writeUnlock();
    boolean success=effectiveDirective != null;
    if (success) {
      getEditLog().logSync();
    }
    String effectiveDirectiveStr=effectiveDirective != null ? effectiveDirective.toString() : null;
    logAuditEvent(success,"addCacheDirective",effectiveDirectiveStr,null,null);
  }
  return effectiveDirective != null ? effectiveDirective.getId() : 0;
}
