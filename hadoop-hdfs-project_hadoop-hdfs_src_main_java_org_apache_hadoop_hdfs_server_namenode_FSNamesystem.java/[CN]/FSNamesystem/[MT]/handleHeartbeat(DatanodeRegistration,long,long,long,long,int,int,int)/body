{
  readLock();
  try {
    final int maxTransfer=blockManager.getMaxReplicationStreams() - xmitsInProgress;
    DatanodeCommand[] cmds=blockManager.getDatanodeManager().handleHeartbeat(nodeReg,blockPoolId,capacity,dfsUsed,remaining,blockPoolUsed,xceiverCount,maxTransfer,failedVolumes);
    if (cmds == null) {
      DatanodeCommand cmd=upgradeManager.getBroadcastCommand();
      if (cmd != null) {
        cmds=new DatanodeCommand[]{cmd};
      }
    }
    return new HeartbeatResponse(cmds,createHaStatusHeartbeat());
  }
  finally {
    readUnlock();
  }
}
