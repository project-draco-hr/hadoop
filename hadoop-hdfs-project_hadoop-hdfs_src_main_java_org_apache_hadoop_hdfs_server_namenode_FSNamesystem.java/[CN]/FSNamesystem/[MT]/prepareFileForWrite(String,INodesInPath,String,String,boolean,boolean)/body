{
  final INodeFile file=iip.getLastINode().asFile();
  file.recordModification(iip.getLatestSnapshotId());
  file.toUnderConstruction(leaseHolder,clientMachine);
  leaseManager.addLease(file.getFileUnderConstructionFeature().getClientName(),src);
  LocatedBlock ret=blockManager.convertLastBlockToUnderConstruction(file,0);
  if (ret != null) {
    final long diff=file.getPreferredBlockSize() - ret.getBlockSize();
    dir.updateSpaceConsumed(iip,0,diff * file.getBlockReplication());
  }
  if (writeToEditLog) {
    getEditLog().logOpenFile(src,file,false,logRetryCache);
  }
  return ret;
}
