{
  final LocatedBlock locatedBlock;
  checkOperation(OperationCategory.WRITE);
  writeLock();
  try {
    checkOperation(OperationCategory.WRITE);
    final INodeFile file=checkUCBlock(block,clientName);
    block.setGenerationStamp(nextGenerationStamp(blockIdManager.isLegacyBlock(block.getLocalBlock())));
    locatedBlock=BlockManager.newLocatedBlock(block,file.getLastBlock(),null,-1);
    blockManager.setBlockToken(locatedBlock,BlockTokenIdentifier.AccessMode.WRITE);
  }
  finally {
    writeUnlock();
  }
  getEditLog().logSync();
  return locatedBlock;
}
