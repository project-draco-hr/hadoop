{
  long expiryTime;
  checkOperation(OperationCategory.WRITE);
  writeLock();
  try {
    checkOperation(OperationCategory.WRITE);
    checkNameNodeSafeMode("Cannot renew delegation token");
    if (!isAllowedDelegationTokenOp()) {
      throw new IOException("Delegation Token can be renewed only with kerberos or web authentication");
    }
    String renewer=getRemoteUser().getShortUserName();
    expiryTime=dtSecretManager.renewToken(token,renewer);
    DelegationTokenIdentifier id=new DelegationTokenIdentifier();
    ByteArrayInputStream buf=new ByteArrayInputStream(token.getIdentifier());
    DataInputStream in=new DataInputStream(buf);
    id.readFields(in);
    getEditLog().logRenewDelegationToken(id,expiryTime);
  }
  finally {
    writeUnlock();
  }
  getEditLog().logSync();
  return expiryTime;
}
