{
  long numUCBlocks=0;
  readLock();
  try {
    for (    Lease lease : leaseManager.getSortedLeases()) {
      for (      String path : lease.getPaths()) {
        final INodeFileUnderConstruction cons;
        try {
          cons=INodeFileUnderConstruction.valueOf(dir.getINode(path),path);
        }
 catch (        UnresolvedLinkException e) {
          throw new AssertionError("Lease files should reside on this FS");
        }
catch (        IOException e) {
          throw new RuntimeException(e);
        }
        BlockInfo[] blocks=cons.getBlocks();
        if (blocks == null)         continue;
        for (        BlockInfo b : blocks) {
          if (!b.isComplete())           numUCBlocks++;
        }
      }
    }
    LOG.info("Number of blocks under construction: " + numUCBlocks);
    return getBlocksTotal() - numUCBlocks;
  }
  finally {
    readUnlock();
  }
}
