{
  file=file.recordModification(latestSnapshot);
  final INodeFile cons=file.toUnderConstruction(leaseHolder,clientMachine,clientNode);
  leaseManager.addLease(cons.getFileUnderConstructionFeature().getClientName(),src);
  LocatedBlock ret=blockManager.convertLastBlockToUnderConstruction(cons);
  if (ret != null) {
    final long diff=file.getPreferredBlockSize() - ret.getBlockSize();
    dir.updateSpaceConsumed(src,0,diff);
  }
  if (writeToEditLog) {
    getEditLog().logOpenFile(src,cons,logRetryCache);
  }
  return ret;
}
