{
  readLock();
  try {
    final int maxTransfer=blockManager.getMaxReplicationStreams() - xmitsInProgress;
    DatanodeCommand[] cmds=blockManager.getDatanodeManager().handleHeartbeat(nodeReg,reports,blockPoolId,cacheCapacity,cacheUsed,xceiverCount,maxTransfer,failedVolumes);
    final NNHAStatusHeartbeat haState=new NNHAStatusHeartbeat(haContext.getState().getServiceState(),getFSImage().getLastAppliedOrWrittenTxId());
    return new HeartbeatResponse(cmds,haState,rollingUpgradeInfo);
  }
  finally {
    readUnlock();
  }
}
