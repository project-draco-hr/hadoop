{
  NameNode nn=null;
  try {
    nn=startNameNode(withService);
    Configuration conf2=new HdfsConfiguration(config);
    conf2.set(DFSConfigKeys.DFS_NAMENODE_NAME_DIR_KEY,fileAsURI(new File(hdfsDir,"name2")).toString());
    DFSTestUtil.formatNameNode(conf2);
    boolean started=canStartNameNode(conf2);
    assertFalse(started);
    FileSystem.setDefaultUri(conf2,"hdfs://" + THIS_HOST);
    started=canStartNameNode(conf2);
    assertFalse(started);
    FileSystem.setDefaultUri(conf2,"hdfs://" + THIS_HOST);
    conf2.set(DFSConfigKeys.DFS_NAMENODE_HTTP_ADDRESS_KEY,THIS_HOST);
    started=canStartNameNode(conf2);
    if (withService) {
      assertFalse("Should've failed on service port",started);
      FileSystem.setDefaultUri(conf2,"hdfs://" + THIS_HOST);
      conf2.set(DFSConfigKeys.DFS_NAMENODE_HTTP_ADDRESS_KEY,THIS_HOST);
      conf2.set(DFSConfigKeys.DFS_NAMENODE_SERVICE_RPC_ADDRESS_KEY,THIS_HOST);
      started=canStartNameNode(conf2);
    }
    assertTrue(started);
  }
  finally {
    stopNameNode(nn);
  }
}
