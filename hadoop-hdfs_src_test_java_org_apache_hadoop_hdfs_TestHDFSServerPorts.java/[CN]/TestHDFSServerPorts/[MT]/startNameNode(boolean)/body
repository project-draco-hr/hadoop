{
  String dataDir=getTestingDir();
  hdfsDir=new File(dataDir,"dfs");
  if (hdfsDir.exists() && !FileUtil.fullyDelete(hdfsDir)) {
    throw new IOException("Could not delete hdfs directory '" + hdfsDir + "'");
  }
  config=new HdfsConfiguration();
  config.set(DFSConfigKeys.DFS_NAMENODE_NAME_DIR_KEY,fileAsURI(new File(hdfsDir,"name1")).toString());
  FileSystem.setDefaultUri(config,"hdfs://" + THIS_HOST);
  if (withService) {
    NameNode.setServiceAddress(config,THIS_HOST);
  }
  config.set(DFSConfigKeys.DFS_NAMENODE_HTTP_ADDRESS_KEY,THIS_HOST);
  DFSTestUtil.formatNameNode(config);
  String[] args=new String[]{};
  return NameNode.createNameNode(args,config);
}
