{
  LOG.info("Running testBlackListedNodesWithSchedulingToThatNode");
  Configuration conf=new Configuration();
  conf.setBoolean(MRJobConfig.MR_AM_JOB_NODE_BLACKLISTING_ENABLE,true);
  conf.setInt(MRJobConfig.MAX_TASK_FAILURES_PER_TRACKER,1);
  conf.setInt(MRJobConfig.MR_AM_IGNORE_BLACKLISTING_BLACKLISTED_NODE_PERECENT,-1);
  MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher dispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp app=rm.submitApp(1024);
  dispatcher.await();
  MockNM amNodeManager=rm.registerNode("amNM:1234",2048);
  amNodeManager.nodeHeartbeat(true);
  dispatcher.await();
  ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  dispatcher.await();
  JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  Job mockJob=mock(Job.class);
  when(mockJob.getReport()).thenReturn(MRBuilderUtils.newJobReport(jobId,"job","user",JobState.RUNNING,0,0,0,0,0,0,0,"jobfile",null,false,""));
  MyContainerAllocator allocator=new MyContainerAllocator(rm,conf,appAttemptId,mockJob);
  MockNM nodeManager1=rm.registerNode("h1:1234",10240);
  MockNM nodeManager3=rm.registerNode("h3:1234",10240);
  dispatcher.await();
  LOG.info("Requesting 1 Containers _1 on H1");
  ContainerRequestEvent event1=createReq(jobId,1,1024,new String[]{"h1"});
  allocator.sendRequest(event1);
  LOG.info("RM Heartbeat (to send the container requests)");
  List<TaskAttemptContainerAssignedEvent> assigned=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  LOG.info("h1 Heartbeat (To actually schedule the containers)");
  nodeManager1.nodeHeartbeat(true);
  dispatcher.await();
  LOG.info("RM Heartbeat (To process the scheduled containers)");
  assigned=allocator.schedule();
  dispatcher.await();
  assertBlacklistAdditionsAndRemovals(0,0,rm);
  Assert.assertEquals("No of assignments must be 1",1,assigned.size());
  LOG.info("Failing container _1 on H1 (should blacklist the node)");
  ContainerFailedEvent f1=createFailEvent(jobId,1,"h1",false);
  allocator.sendFailure(f1);
  ContainerRequestEvent event1f=createReq(jobId,1,1024,new String[]{"h1"},true,false);
  allocator.sendRequest(event1f);
  assigned=allocator.schedule();
  dispatcher.await();
  assertBlacklistAdditionsAndRemovals(1,0,rm);
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  ContainerRequestEvent event3=createReq(jobId,3,1024,new String[]{"h1","h3"});
  allocator.sendRequest(event3);
  LOG.info("h1 Heartbeat (To actually schedule the containers)");
  nodeManager1.nodeHeartbeat(true);
  dispatcher.await();
  LOG.info("RM Heartbeat (To process the scheduled containers)");
  assigned=allocator.schedule();
  dispatcher.await();
  assertBlacklistAdditionsAndRemovals(0,0,rm);
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  LOG.info("RM Heartbeat (To process the re-scheduled containers)");
  assigned=allocator.schedule();
  dispatcher.await();
  assertBlacklistAdditionsAndRemovals(0,0,rm);
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  LOG.info("h3 Heartbeat (To re-schedule the containers)");
  nodeManager3.nodeHeartbeat(true);
  dispatcher.await();
  LOG.info("RM Heartbeat (To process the re-scheduled containers for H3)");
  assigned=allocator.schedule();
  assertBlacklistAdditionsAndRemovals(0,0,rm);
  dispatcher.await();
  for (  TaskAttemptContainerAssignedEvent assig : assigned) {
    LOG.info(assig.getTaskAttemptID() + " assgined to " + assig.getContainer().getId()+ " with priority "+ assig.getContainer().getPriority());
  }
  Assert.assertEquals("No of assignments must be 2",2,assigned.size());
  for (  TaskAttemptContainerAssignedEvent assig : assigned) {
    Assert.assertEquals("Assigned container " + assig.getContainer().getId() + " host not correct","h3",assig.getContainer().getNodeId().getHost());
  }
}
