{
  Configuration conf=new HdfsConfiguration();
  conf.setInt(DFSConfigKeys.DFS_REPLICATION_KEY,2);
  conf.setLong(DFSConfigKeys.DFS_BLOCKREPORT_INTERVAL_MSEC_KEY,300);
  conf.setLong(DFSConfigKeys.DFS_DATANODE_DIRECTORYSCAN_INTERVAL_KEY,1);
  conf.setLong(DFSConfigKeys.DFS_HEARTBEAT_INTERVAL_KEY,1);
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(2).build();
  FSDataOutputStream out=null;
  try {
    final FSNamesystem namesystem=cluster.getNamesystem();
    FileSystem fs=cluster.getFileSystem();
    Path testPath=new Path(MiniDFSCluster.getBaseDirectory(),"foo1");
    out=fs.create(testPath,(short)2);
    out.writeBytes("HDFS-3157: " + testPath);
    out.hsync();
    cluster.startDataNodes(conf,1,true,null,null,null);
    String bpid=namesystem.getBlockPoolId();
    ExtendedBlock blk=DFSTestUtil.getFirstBlock(fs,testPath);
    Block block=blk.getLocalBlock();
    DataNode dn=cluster.getDataNodes().get(0);
    File blockFile=DataNodeTestUtils.getBlockFile(dn,bpid,block);
    File metaFile=DataNodeTestUtils.getMetaFile(dn,bpid,block);
    assertTrue("Could not delete the block file from the RBW folder",blockFile.delete());
    assertTrue("Could not delete the block meta file from the RBW folder",metaFile.delete());
    out.close();
    boolean isCorruptReported=false;
    while (!isCorruptReported) {
      if (countReplicas(namesystem,blk).corruptReplicas() > 0) {
        isCorruptReported=true;
      }
      Thread.sleep(100);
    }
    assertEquals("There should be 1 replica in the corruptReplicasMap",1,countReplicas(namesystem,blk).corruptReplicas());
    blk=DFSTestUtil.getFirstBlock(fs,testPath);
    boolean isReplicated=false;
    while (!isReplicated) {
      if (countReplicas(namesystem,blk).liveReplicas() > 1) {
        isReplicated=true;
      }
      Thread.sleep(100);
    }
    assertEquals("There should be two live replicas",2,countReplicas(namesystem,blk).liveReplicas());
    Thread.sleep(1000);
    assertEquals("There should not be any replica in the corruptReplicasMap",0,countReplicas(namesystem,blk).corruptReplicas());
  }
  finally {
    if (out != null) {
      out.close();
    }
    cluster.shutdown();
  }
}
