{
  if (allowNestedSnapshots) {
    return;
  }
  for (  INodeDirectorySnapshottable s : snapshottables.values()) {
    if (s.isAncestorDirectory(dir)) {
      throw new SnapshotException("Nested snapshottable directories not allowed: path=" + path + ", the ancestor "+ s.getFullPathName()+ " is already a snapshottable directory.");
    }
    if (dir.isAncestorDirectory(s)) {
      throw new SnapshotException("Nested snapshottable directories not allowed: path=" + path + ", the subdirectory "+ s.getFullPathName()+ " is already a snapshottable directory.");
    }
  }
}
