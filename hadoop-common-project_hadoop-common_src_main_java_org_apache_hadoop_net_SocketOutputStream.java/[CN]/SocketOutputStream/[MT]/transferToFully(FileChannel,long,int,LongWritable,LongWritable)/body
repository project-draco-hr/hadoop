{
  long waitTime=0;
  long transferTime=0;
  while (count > 0) {
    long start=System.nanoTime();
    waitForWritable();
    long wait=System.nanoTime();
    int nTransfered=(int)fileCh.transferTo(position,count,getChannel());
    if (nTransfered == 0) {
      if (position >= fileCh.size()) {
        throw new EOFException("EOF Reached. file size is " + fileCh.size() + " and "+ count+ " more bytes left to be "+ "transfered.");
      }
    }
 else     if (nTransfered < 0) {
      throw new IOException("Unexpected return of " + nTransfered + " from transferTo()");
    }
 else {
      position+=nTransfered;
      count-=nTransfered;
    }
    long transfer=System.nanoTime();
    waitTime+=wait - start;
    transferTime+=transfer - wait;
  }
  if (waitForWritableTime != null) {
    waitForWritableTime.set(waitTime);
  }
  if (transferToTime != null) {
    transferToTime.set(transferTime);
  }
}
