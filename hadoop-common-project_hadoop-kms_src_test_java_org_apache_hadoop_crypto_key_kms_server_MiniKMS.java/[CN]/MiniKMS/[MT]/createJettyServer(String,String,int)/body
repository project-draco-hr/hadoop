{
  try {
    boolean ssl=keyStore != null;
    InetAddress localhost=InetAddress.getByName("localhost");
    String host="localhost";
    ServerSocket ss=new ServerSocket((inPort < 0) ? 0 : inPort,50,localhost);
    int port=ss.getLocalPort();
    ss.close();
    Server server=new Server(0);
    if (!ssl) {
      server.getConnectors()[0].setHost(host);
      server.getConnectors()[0].setPort(port);
    }
 else {
      SslSocketConnector c=new SslSocketConnectorSecure();
      c.setHost(host);
      c.setPort(port);
      c.setNeedClientAuth(false);
      c.setKeystore(keyStore);
      c.setKeystoreType("jks");
      c.setKeyPassword(password);
      server.setConnectors(new Connector[]{c});
    }
    return server;
  }
 catch (  Exception ex) {
    throw new RuntimeException("Could not start embedded servlet container, " + ex.getMessage(),ex);
  }
}
