{
  final Configuration conf=new HdfsConfiguration();
  MiniDFSCluster cluster=null;
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(0).build();
    cluster.waitActive();
    final FSNamesystem namesystem=cluster.getNamesystem();
    final Path foo=new Path("/foo");
    final Path bar=new Path("/bar");
{
      final DistributedFileSystem dfs=cluster.getFileSystem();
      dfs.mkdirs(foo);
      namesystem.startRollingUpgrade();
      dfs.mkdirs(bar);
      Assert.assertTrue(dfs.exists(foo));
      Assert.assertTrue(dfs.exists(bar));
    }
    try {
      cluster.restartNameNode();
      Assert.fail();
    }
 catch (    RollingUpgradeException e) {
      LOG.info("The exception is expected: ",e);
    }
    cluster.restartNameNode("-rollingUpgrade","rollback");
{
      final DistributedFileSystem dfs=cluster.getFileSystem();
      Assert.assertTrue(dfs.exists(foo));
      Assert.assertFalse(dfs.exists(bar));
    }
  }
  finally {
    if (cluster != null)     cluster.shutdown();
  }
}
