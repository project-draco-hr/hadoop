{
  Quota.Counts counts=Quota.Counts.newInstance();
  Deque<INode> queue=new ArrayDeque<INode>();
  queue.addLast(inode);
  while (!queue.isEmpty()) {
    INode topNode=queue.pollFirst();
    if (topNode instanceof INodeReference.WithName) {
      INodeReference.WithName wn=(INodeReference.WithName)topNode;
      if (wn.getLastSnapshotId() >= post.getId()) {
        wn.cleanSubtree(post,prior,collectedBlocks,removedINodes,countDiffChange);
      }
    }
 else     if (topNode.isFile() && topNode.asFile() instanceof INodeFileWithSnapshot) {
      INodeFileWithSnapshot fs=(INodeFileWithSnapshot)topNode.asFile();
      counts.add(fs.getDiffs().deleteSnapshotDiff(post,prior,fs,collectedBlocks,removedINodes,countDiffChange));
    }
 else     if (topNode.isDirectory()) {
      INodeDirectory dir=topNode.asDirectory();
      ChildrenDiff priorChildrenDiff=null;
      if (dir instanceof INodeDirectoryWithSnapshot) {
        INodeDirectoryWithSnapshot sdir=(INodeDirectoryWithSnapshot)dir;
        DirectoryDiff priorDiff=sdir.getDiffs().getDiff(prior);
        if (priorDiff != null && priorDiff.getSnapshot().equals(prior)) {
          priorChildrenDiff=priorDiff.getChildrenDiff();
          counts.add(priorChildrenDiff.destroyCreatedList(sdir,collectedBlocks,removedINodes));
        }
      }
      for (      INode child : dir.getChildrenList(prior)) {
        if (priorChildrenDiff != null && priorChildrenDiff.search(ListType.DELETED,child.getLocalNameBytes()) != null) {
          continue;
        }
        queue.addLast(child);
      }
    }
  }
  return counts;
}
