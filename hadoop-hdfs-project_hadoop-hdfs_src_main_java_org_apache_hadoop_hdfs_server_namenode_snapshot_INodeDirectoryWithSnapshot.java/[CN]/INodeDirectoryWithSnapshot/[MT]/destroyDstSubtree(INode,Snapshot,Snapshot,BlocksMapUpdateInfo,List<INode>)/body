{
  Preconditions.checkArgument(prior != null);
  if (inode.isReference()) {
    if (inode instanceof INodeReference.WithName && snapshot != null) {
      inode.cleanSubtree(snapshot,prior,collectedBlocks,removedINodes,true);
    }
 else {
      destroyDstSubtree(inode.asReference().getReferredINode(),snapshot,prior,collectedBlocks,removedINodes);
    }
  }
 else   if (inode.isFile()) {
    inode.cleanSubtree(snapshot,prior,collectedBlocks,removedINodes,true);
  }
 else   if (inode.isDirectory()) {
    Map<INode,INode> excludedNodes=null;
    if (inode instanceof INodeDirectoryWithSnapshot) {
      INodeDirectoryWithSnapshot sdir=(INodeDirectoryWithSnapshot)inode;
      DirectoryDiffList diffList=sdir.getDiffs();
      DirectoryDiff priorDiff=diffList.getDiff(prior);
      if (priorDiff != null && priorDiff.getSnapshot().equals(prior)) {
        List<INode> dList=priorDiff.diff.getList(ListType.DELETED);
        excludedNodes=cloneDiffList(dList);
      }
      if (snapshot != null) {
        diffList.deleteSnapshotDiff(snapshot,prior,sdir,collectedBlocks,removedINodes,true);
      }
      priorDiff=diffList.getDiff(prior);
      if (priorDiff != null && priorDiff.getSnapshot().equals(prior)) {
        priorDiff.diff.destroyCreatedList(sdir,collectedBlocks,removedINodes);
      }
    }
    for (    INode child : inode.asDirectory().getChildrenList(prior)) {
      if (excludedNodes != null && excludedNodes.containsKey(child)) {
        continue;
      }
      destroyDstSubtree(child,snapshot,prior,collectedBlocks,removedINodes);
    }
  }
}
