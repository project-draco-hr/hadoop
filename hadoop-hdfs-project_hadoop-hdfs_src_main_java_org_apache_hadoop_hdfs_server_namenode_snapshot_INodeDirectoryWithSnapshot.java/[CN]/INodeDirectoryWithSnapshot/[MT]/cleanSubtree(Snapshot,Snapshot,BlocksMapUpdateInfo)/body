{
  Quota.Counts counts=Quota.Counts.newInstance();
  if (snapshot == null) {
    recordModification(prior);
    DirectoryDiff lastDiff=diffs.getLast();
    if (lastDiff != null) {
      lastDiff.diff.destroyCreatedList(this,collectedBlocks);
    }
  }
 else {
    Snapshot s=getDiffs().getPrior(snapshot);
    if (s != null && (prior == null || Snapshot.ID_COMPARATOR.compare(s,prior) > 0)) {
      prior=s;
    }
    counts.add(getDiffs().deleteSnapshotDiff(snapshot,prior,this,collectedBlocks));
    if (prior != null) {
      DirectoryDiff priorDiff=this.getDiffs().getDiff(prior);
      if (priorDiff != null) {
        for (        INode cNode : priorDiff.getChildrenDiff().getCreatedList()) {
          counts.add(cNode.cleanSubtree(snapshot,null,collectedBlocks));
        }
      }
    }
  }
  counts.add(cleanSubtreeRecursively(snapshot,prior,collectedBlocks));
  if (isQuotaSet()) {
    this.addSpaceConsumed2Cache(-counts.get(Quota.NAMESPACE),-counts.get(Quota.DISKSPACE));
  }
  return counts;
}
