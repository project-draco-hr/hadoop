{
  Configuration conf=new Configuration();
  FSEditLog fsEditLog=Mockito.mock(FSEditLog.class);
  FSImage fsImage=Mockito.mock(FSImage.class);
  Mockito.when(fsImage.getEditLog()).thenReturn(fsEditLog);
  FSNamesystem fsNamesystem=new FSNamesystem(conf,fsImage);
  FSNamesystem fsn=Mockito.spy(fsNamesystem);
  BlockManager bm=fsn.getBlockManager();
  Whitebox.setInternalState(bm,"namesystem",fsn);
  HAContext haContext=Mockito.mock(HAContext.class);
  HAState haState=Mockito.mock(HAState.class);
  Mockito.when(haContext.getState()).thenReturn(haState);
  Mockito.when(haState.shouldPopulateReplQueues()).thenReturn(true);
  Mockito.when(fsn.getHAContext()).thenReturn(haContext);
  NameNode.initMetrics(conf,NamenodeRole.NAMENODE);
  fsn.enterSafeMode(false);
  assertTrue("FSNamesystem didn't enter safemode",fsn.isInSafeMode());
  assertTrue("Replication queues were being populated during very first " + "safemode",!bm.isPopulatingReplQueues());
  fsn.leaveSafeMode(false);
  assertTrue("FSNamesystem didn't leave safemode",!fsn.isInSafeMode());
  assertTrue("Replication queues weren't being populated even after leaving " + "safemode",bm.isPopulatingReplQueues());
  fsn.enterSafeMode(false);
  assertTrue("FSNamesystem didn't enter safemode",fsn.isInSafeMode());
  assertTrue("Replication queues weren't being populated after entering " + "safemode 2nd time",bm.isPopulatingReplQueues());
}
