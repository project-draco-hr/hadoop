{
  INode inode=store.retrieveINode(makeAbsolute(file));
  if (inode != null) {
    if (overwrite && !inode.isDirectory()) {
      delete(file,true);
    }
 else {
      String message=String.format("File already exists: '%s'",file);
      if (inode.isDirectory()) {
        message=message + " is a directory";
      }
      throw new FileAlreadyExistsException(message);
    }
  }
 else {
    Path parent=file.getParent();
    if (parent != null) {
      if (!mkdirs(parent)) {
        throw new IOException("Mkdirs failed to create " + parent.toString());
      }
    }
  }
  return new FSDataOutputStream(new S3OutputStream(getConf(),store,makeAbsolute(file),blockSize,progress,bufferSize),statistics);
}
