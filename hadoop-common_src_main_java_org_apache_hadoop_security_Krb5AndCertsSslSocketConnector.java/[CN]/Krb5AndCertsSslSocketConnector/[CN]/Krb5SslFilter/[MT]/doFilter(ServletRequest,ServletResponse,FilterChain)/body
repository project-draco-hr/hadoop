{
  final Principal princ=(Principal)req.getAttribute(Krb5AndCertsSslSocketConnector.REMOTE_PRINCIPAL);
  if (princ == null || !(princ instanceof KerberosPrincipal)) {
    LOG.warn("User not authenticated via kerberos from " + req.getRemoteAddr());
    ((HttpServletResponse)resp).sendError(HttpServletResponse.SC_FORBIDDEN,"User not authenticated via Kerberos");
    return;
  }
  ServletRequest wrapper=new HttpServletRequestWrapper((HttpServletRequest)req){
    @Override public Principal getUserPrincipal(){
      return princ;
    }
    @Override public String getRemoteUser(){
      return princ.getName();
    }
  }
;
  chain.doFilter(wrapper,resp);
}
