{
  File blockFile=getBlockFile();
  File metaFile=getMetaFile();
  if (DataNode.LOG.isDebugEnabled()) {
    DataNode.LOG.debug("writeTo blockfile is " + blockFile + " of size "+ blockFile.length());
    DataNode.LOG.debug("writeTo metafile is " + metaFile + " of size "+ metaFile.length());
  }
  long blockDiskSize=0L;
  long crcDiskSize=0L;
  if (!isCreate) {
    blockDiskSize=bytesOnDisk;
    crcDiskSize=BlockMetadataHeader.getHeaderSize() + (blockDiskSize + bytesPerChunk - 1) / bytesPerChunk * checksumSize;
    if (blockDiskSize > 0 && (blockDiskSize > blockFile.length() || crcDiskSize > metaFile.length())) {
      throw new IOException("Corrupted block: " + this);
    }
  }
  FileOutputStream blockOut=null;
  FileOutputStream crcOut=null;
  try {
    blockOut=new FileOutputStream(new RandomAccessFile(blockFile,"rw").getFD());
    crcOut=new FileOutputStream(new RandomAccessFile(metaFile,"rw").getFD());
    if (!isCreate) {
      blockOut.getChannel().position(blockDiskSize);
      crcOut.getChannel().position(crcDiskSize);
    }
    return new BlockWriteStreams(blockOut,crcOut);
  }
 catch (  IOException e) {
    IOUtils.closeStream(blockOut);
    IOUtils.closeStream(crcOut);
    throw e;
  }
}
