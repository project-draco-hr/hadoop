{
  long now=System.currentTimeMillis();
  ByteArrayInputStream buf=new ByteArrayInputStream(token.getIdentifier());
  DataInputStream in=new DataInputStream(buf);
  TokenIdent id=createIdentifier();
  id.readFields(in);
synchronized (currentTokens) {
    if (currentTokens.get(id) == null) {
      LOG.warn("Renewal request for unknown token");
      return false;
    }
  }
  if (id.getMaxDate() < now) {
    LOG.warn("Client " + renewer + " tries to renew an expired token");
    return false;
  }
  if (id.getRenewer() == null || !id.getRenewer().toString().equals(renewer)) {
    LOG.warn("Client " + renewer + " tries to renew a token with "+ "renewer specified as "+ id.getRenewer());
    return false;
  }
  DelegationKey key=null;
synchronized (this) {
    key=allKeys.get(id.getMasterKeyId());
  }
  if (key == null) {
    LOG.warn("Unable to find master key for keyId=" + id.getMasterKeyId() + " from cache. Failed to renew an unexpired token with sequenceNumber="+ id.getSequenceNumber()+ ", issued by this key");
    return false;
  }
  byte[] password=createPassword(token.getIdentifier(),key.getKey());
  if (!Arrays.equals(password,token.getPassword())) {
    LOG.warn("Client " + renewer + " is trying to renew a token with wrong password");
    return false;
  }
  DelegationTokenInformation info=new DelegationTokenInformation(Math.min(id.getMaxDate(),now + tokenRenewInterval),password);
synchronized (currentTokens) {
    currentTokens.put(id,info);
  }
  return true;
}
