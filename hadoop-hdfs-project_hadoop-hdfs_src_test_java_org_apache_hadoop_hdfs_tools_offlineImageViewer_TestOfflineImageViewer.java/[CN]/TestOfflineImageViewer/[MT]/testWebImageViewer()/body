{
  WebImageViewer viewer=new WebImageViewer(NetUtils.createSocketAddr("localhost:0"));
  try {
    viewer.initServer(originalFsimage.getAbsolutePath());
    int port=viewer.getPort();
    URI uri=new URI("webhdfs://localhost:" + String.valueOf(port));
    Configuration conf=new Configuration();
    WebHdfsFileSystem webhdfs=(WebHdfsFileSystem)FileSystem.get(uri,conf);
    FileStatus[] statuses=webhdfs.listStatus(new Path("/"));
    assertEquals(NUM_DIRS,statuses.length);
    statuses=webhdfs.listStatus(new Path("/dir0"));
    assertEquals(FILES_PER_DIR,statuses.length);
    FileStatus status=webhdfs.listStatus(new Path("/dir0/file0"))[0];
    FileStatus expected=writtenFiles.get("/dir0/file0");
    assertEquals(expected.getAccessTime(),status.getAccessTime());
    assertEquals(expected.getBlockSize(),status.getBlockSize());
    assertEquals(expected.getGroup(),status.getGroup());
    assertEquals(expected.getLen(),status.getLen());
    assertEquals(expected.getModificationTime(),status.getModificationTime());
    assertEquals(expected.getOwner(),status.getOwner());
    assertEquals(expected.getPermission(),status.getPermission());
    assertEquals(expected.getReplication(),status.getReplication());
    assertEquals(expected.isDirectory(),status.isDirectory());
    URL url=new URL("http://localhost:" + port + "/webhdfs/v1/invalid/?op=LISTSTATUS");
    HttpURLConnection connection=(HttpURLConnection)url.openConnection();
    connection.setRequestMethod("GET");
    connection.connect();
    assertEquals(HttpURLConnection.HTTP_NOT_FOUND,connection.getResponseCode());
    url=new URL("http://localhost:" + port + "/webhdfs/v1?op=LISTSTATUS");
    connection=(HttpURLConnection)url.openConnection();
    connection.setRequestMethod("GET");
    connection.connect();
    assertEquals(HttpURLConnection.HTTP_NOT_FOUND,connection.getResponseCode());
    url=new URL("http://localhost:" + port + "/webhdfs/v1/?op=INVALID");
    connection=(HttpURLConnection)url.openConnection();
    connection.setRequestMethod("GET");
    connection.connect();
    assertEquals(HttpURLConnection.HTTP_BAD_REQUEST,connection.getResponseCode());
    url=new URL("http://localhost:" + port + "/webhdfs/v1/?op=LISTSTATUS");
    connection=(HttpURLConnection)url.openConnection();
    connection.setRequestMethod("POST");
    connection.connect();
    assertEquals(HttpURLConnection.HTTP_BAD_METHOD,connection.getResponseCode());
  }
  finally {
    viewer.shutdown();
  }
}
