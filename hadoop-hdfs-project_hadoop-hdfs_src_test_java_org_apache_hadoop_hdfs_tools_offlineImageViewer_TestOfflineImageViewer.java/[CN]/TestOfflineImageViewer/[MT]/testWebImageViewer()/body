{
  WebImageViewer viewer=new WebImageViewer(NetUtils.createSocketAddr("localhost:0"));
  try {
    viewer.initServer(originalFsimage.getAbsolutePath());
    int port=viewer.getPort();
    URI uri=new URI("webhdfs://localhost:" + String.valueOf(port));
    Configuration conf=new Configuration();
    WebHdfsFileSystem webhdfs=(WebHdfsFileSystem)FileSystem.get(uri,conf);
    FileStatus[] statuses=webhdfs.listStatus(new Path("/"));
    assertEquals(dirCount,statuses.length);
    statuses=webhdfs.listStatus(new Path("/dir0"));
    assertEquals(FILES_PER_DIR,statuses.length);
    FileStatus status=webhdfs.listStatus(new Path("/dir0/file0"))[0];
    FileStatus expected=writtenFiles.get("/dir0/file0");
    compareFile(expected,status);
    statuses=webhdfs.listStatus(new Path("/emptydir"));
    assertEquals(0,statuses.length);
    URL url=new URL("http://localhost:" + port + "/webhdfs/v1/invalid/?op=LISTSTATUS");
    verifyHttpResponseCode(HttpURLConnection.HTTP_NOT_FOUND,url);
    url=new URL("http://localhost:" + port + "/foo");
    verifyHttpResponseCode(HttpURLConnection.HTTP_NOT_FOUND,url);
    status=webhdfs.getFileStatus(new Path("/dir0/file0"));
    compareFile(expected,status);
    url=new URL("http://localhost:" + port + "/webhdfs/v1/invalid/?op=GETFILESTATUS");
    verifyHttpResponseCode(HttpURLConnection.HTTP_NOT_FOUND,url);
    url=new URL("http://localhost:" + port + "/webhdfs/v1/?op=INVALID");
    verifyHttpResponseCode(HttpURLConnection.HTTP_BAD_REQUEST,url);
    url=new URL("http://localhost:" + port + "/webhdfs/v1/?op=LISTSTATUS");
    HttpURLConnection connection=(HttpURLConnection)url.openConnection();
    connection.setRequestMethod("POST");
    connection.connect();
    assertEquals(HttpURLConnection.HTTP_BAD_METHOD,connection.getResponseCode());
  }
  finally {
    viewer.close();
  }
}
