{
  lock.lock();
  try {
    Map<ExtendedBlockId,ShortCircuitReplica> replicas=new HashMap<ExtendedBlockId,ShortCircuitReplica>();
    Map<ExtendedBlockId,InvalidToken> failedLoads=new HashMap<ExtendedBlockId,InvalidToken>();
    for (    Entry<ExtendedBlockId,Waitable<ShortCircuitReplicaInfo>> entry : replicaInfoMap.entrySet()) {
      Waitable<ShortCircuitReplicaInfo> waitable=entry.getValue();
      if (waitable.hasVal()) {
        if (waitable.getVal().getReplica() != null) {
          replicas.put(entry.getKey(),waitable.getVal().getReplica());
        }
 else {
          failedLoads.put(entry.getKey(),waitable.getVal().getInvalidTokenException());
        }
      }
    }
    LOG.debug("visiting {} with outstandingMmapCount={}, replicas={}, " + "failedLoads={}, evictable={}, evictableMmapped={}",visitor.getClass().getName(),outstandingMmapCount,replicas,failedLoads,evictable,evictableMmapped);
    visitor.visit(outstandingMmapCount,replicas,failedLoads,evictable,evictableMmapped);
  }
  finally {
    lock.unlock();
  }
}
