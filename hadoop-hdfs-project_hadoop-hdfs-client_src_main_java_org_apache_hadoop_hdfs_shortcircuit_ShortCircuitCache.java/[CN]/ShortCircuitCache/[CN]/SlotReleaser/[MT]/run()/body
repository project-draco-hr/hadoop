{
  LOG.trace("{}: about to release {}",ShortCircuitCache.this,slot);
  final DfsClientShm shm=(DfsClientShm)slot.getShm();
  final DomainSocket shmSock=shm.getPeer().getDomainSocket();
  final String path=shmSock.getPath();
  boolean success=false;
  try (DomainSocket sock=DomainSocket.connect(path);DataOutputStream out=new DataOutputStream(new BufferedOutputStream(sock.getOutputStream()))){
    new Sender(out).releaseShortCircuitFds(slot.getSlotId());
    DataInputStream in=new DataInputStream(sock.getInputStream());
    ReleaseShortCircuitAccessResponseProto resp=ReleaseShortCircuitAccessResponseProto.parseFrom(PBHelperClient.vintPrefixed(in));
    if (resp.getStatus() != Status.SUCCESS) {
      String error=resp.hasError() ? resp.getError() : "(unknown)";
      throw new IOException(resp.getStatus().toString() + ": " + error);
    }
    LOG.trace("{}: released {}",this,slot);
    success=true;
  }
 catch (  IOException e) {
    LOG.error(ShortCircuitCache.this + ": failed to release " + "short-circuit shared memory slot "+ slot+ " by sending "+ "ReleaseShortCircuitAccessRequestProto to "+ path+ ".  Closing shared memory segment.",e);
  }
 finally {
    if (success) {
      shmManager.freeSlot(slot);
    }
 else {
      shm.getEndpointShmManager().shutdown(shm);
    }
  }
}
