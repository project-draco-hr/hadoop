{
  setupMultiLevelQueues(csConf);
  Map<String,CSQueue> queues=new HashMap<String,CSQueue>();
  CSQueue root=CapacityScheduler.parseQueue(csContext,csConf,null,CapacitySchedulerConfiguration.ROOT,queues,queues,TestUtils.spyHook);
  final int memoryPerNode=10;
  final int coresPerNode=10;
  final int numNodes=2;
  FiCaSchedulerNode node_0=TestUtils.getMockNode("host_0",DEFAULT_RACK,0,memoryPerNode * GB);
  FiCaSchedulerNode node_1=TestUtils.getMockNode("host_1",DEFAULT_RACK,0,memoryPerNode * GB);
  final Resource clusterResource=Resources.createResource(numNodes * (memoryPerNode * GB),numNodes * coresPerNode);
  when(csContext.getNumClusterNodes()).thenReturn(numNodes);
  LeafQueue b3=(LeafQueue)queues.get(B3);
  LeafQueue b2=(LeafQueue)queues.get(B2);
  b2.getQueueResourceUsage().incPending(Resources.createResource(1 * GB));
  b3.getQueueResourceUsage().incPending(Resources.createResource(1 * GB));
  queues.get(CapacitySchedulerConfiguration.ROOT).getQueueResourceUsage().incPending(Resources.createResource(1 * GB));
  CSQueue b=queues.get(B);
  b.getQueueResourceUsage().incPending(Resources.createResource(1 * GB));
  stubQueueAllocation(b2,clusterResource,node_0,0 * GB,NodeType.OFF_SWITCH);
  stubQueueAllocation(b3,clusterResource,node_0,1 * GB,NodeType.OFF_SWITCH);
  root.assignContainers(clusterResource,node_0,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY);
  verifyQueueMetrics(b2,0 * GB,clusterResource);
  verifyQueueMetrics(b3,1 * GB,clusterResource);
  stubQueueAllocation(b2,clusterResource,node_1,1 * GB,NodeType.RACK_LOCAL);
  stubQueueAllocation(b3,clusterResource,node_1,1 * GB,NodeType.OFF_SWITCH);
  root.assignContainers(clusterResource,node_1,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY);
  InOrder allocationOrder=inOrder(b2,b3);
  allocationOrder.verify(b2).assignContainers(eq(clusterResource),any(FiCaSchedulerNode.class),anyResourceLimits(),any(SchedulingMode.class));
  allocationOrder.verify(b3).assignContainers(eq(clusterResource),any(FiCaSchedulerNode.class),anyResourceLimits(),any(SchedulingMode.class));
  verifyQueueMetrics(b2,1 * GB,clusterResource);
  verifyQueueMetrics(b3,2 * GB,clusterResource);
  stubQueueAllocation(b2,clusterResource,node_0,1 * GB,NodeType.NODE_LOCAL);
  stubQueueAllocation(b3,clusterResource,node_0,1 * GB,NodeType.OFF_SWITCH);
  root.assignContainers(clusterResource,node_0,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY);
  allocationOrder=inOrder(b3,b2);
  allocationOrder.verify(b3).assignContainers(eq(clusterResource),any(FiCaSchedulerNode.class),anyResourceLimits(),any(SchedulingMode.class));
  allocationOrder.verify(b2).assignContainers(eq(clusterResource),any(FiCaSchedulerNode.class),anyResourceLimits(),any(SchedulingMode.class));
  verifyQueueMetrics(b2,1 * GB,clusterResource);
  verifyQueueMetrics(b3,3 * GB,clusterResource);
}
