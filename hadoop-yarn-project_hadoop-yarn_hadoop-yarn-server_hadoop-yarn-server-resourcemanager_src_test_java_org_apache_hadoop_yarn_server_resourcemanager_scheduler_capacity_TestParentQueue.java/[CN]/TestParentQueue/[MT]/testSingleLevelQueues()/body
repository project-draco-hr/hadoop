{
  setupSingleLevelQueues(csConf);
  Map<String,CSQueue> queues=new HashMap<String,CSQueue>();
  CSQueue root=CapacityScheduler.parseQueue(csContext,csConf,null,CapacitySchedulerConfiguration.ROOT,queues,queues,TestUtils.spyHook);
  final int memoryPerNode=10;
  final int coresPerNode=16;
  final int numNodes=2;
  FiCaSchedulerNode node_0=TestUtils.getMockNode("host_0",DEFAULT_RACK,0,memoryPerNode * GB);
  FiCaSchedulerNode node_1=TestUtils.getMockNode("host_1",DEFAULT_RACK,0,memoryPerNode * GB);
  final Resource clusterResource=Resources.createResource(numNodes * (memoryPerNode * GB),numNodes * coresPerNode);
  when(csContext.getNumClusterNodes()).thenReturn(numNodes);
  LeafQueue a=(LeafQueue)queues.get(A);
  LeafQueue b=(LeafQueue)queues.get(B);
  a.getQueueResourceUsage().incPending(Resources.createResource(1 * GB));
  b.getQueueResourceUsage().incPending(Resources.createResource(1 * GB));
  queues.get(CapacitySchedulerConfiguration.ROOT).getQueueResourceUsage().incPending(Resources.createResource(1 * GB));
  stubQueueAllocation(a,clusterResource,node_0,0 * GB);
  stubQueueAllocation(b,clusterResource,node_0,1 * GB);
  root.assignContainers(clusterResource,node_0,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY);
  verifyQueueMetrics(a,0 * GB,clusterResource);
  verifyQueueMetrics(b,1 * GB,clusterResource);
  stubQueueAllocation(a,clusterResource,node_1,2 * GB);
  stubQueueAllocation(b,clusterResource,node_1,1 * GB);
  root.assignContainers(clusterResource,node_1,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY);
  InOrder allocationOrder=inOrder(a,b);
  allocationOrder.verify(a).assignContainers(eq(clusterResource),any(FiCaSchedulerNode.class),anyResourceLimits(),any(SchedulingMode.class));
  allocationOrder.verify(b).assignContainers(eq(clusterResource),any(FiCaSchedulerNode.class),anyResourceLimits(),any(SchedulingMode.class));
  verifyQueueMetrics(a,2 * GB,clusterResource);
  verifyQueueMetrics(b,2 * GB,clusterResource);
  stubQueueAllocation(a,clusterResource,node_0,1 * GB);
  stubQueueAllocation(b,clusterResource,node_0,2 * GB);
  root.assignContainers(clusterResource,node_0,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY);
  allocationOrder=inOrder(b,a);
  allocationOrder.verify(b).assignContainers(eq(clusterResource),any(FiCaSchedulerNode.class),anyResourceLimits(),any(SchedulingMode.class));
  allocationOrder.verify(a).assignContainers(eq(clusterResource),any(FiCaSchedulerNode.class),anyResourceLimits(),any(SchedulingMode.class));
  verifyQueueMetrics(a,3 * GB,clusterResource);
  verifyQueueMetrics(b,4 * GB,clusterResource);
  stubQueueAllocation(a,clusterResource,node_0,0 * GB);
  stubQueueAllocation(b,clusterResource,node_0,4 * GB);
  root.assignContainers(clusterResource,node_0,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY);
  allocationOrder=inOrder(b,a);
  allocationOrder.verify(b).assignContainers(eq(clusterResource),any(FiCaSchedulerNode.class),anyResourceLimits(),any(SchedulingMode.class));
  allocationOrder.verify(a).assignContainers(eq(clusterResource),any(FiCaSchedulerNode.class),anyResourceLimits(),any(SchedulingMode.class));
  verifyQueueMetrics(a,3 * GB,clusterResource);
  verifyQueueMetrics(b,8 * GB,clusterResource);
  stubQueueAllocation(a,clusterResource,node_1,1 * GB);
  stubQueueAllocation(b,clusterResource,node_1,1 * GB);
  root.assignContainers(clusterResource,node_1,new ResourceLimits(clusterResource),SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY);
  allocationOrder=inOrder(a,b);
  allocationOrder.verify(b).assignContainers(eq(clusterResource),any(FiCaSchedulerNode.class),anyResourceLimits(),any(SchedulingMode.class));
  allocationOrder.verify(a).assignContainers(eq(clusterResource),any(FiCaSchedulerNode.class),anyResourceLimits(),any(SchedulingMode.class));
  verifyQueueMetrics(a,4 * GB,clusterResource);
  verifyQueueMetrics(b,9 * GB,clusterResource);
}
