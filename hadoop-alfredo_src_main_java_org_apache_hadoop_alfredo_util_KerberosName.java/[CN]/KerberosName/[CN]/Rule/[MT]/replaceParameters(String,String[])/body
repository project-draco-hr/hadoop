{
  Matcher match=parameterPattern.matcher(format);
  int start=0;
  StringBuilder result=new StringBuilder();
  while (start < format.length() && match.find(start)) {
    result.append(match.group(1));
    String paramNum=match.group(3);
    if (paramNum != null) {
      try {
        int num=Integer.parseInt(paramNum);
        if (num < 0 || num > params.length) {
          throw new BadFormatString("index " + num + " from "+ format+ " is outside of the valid range 0 to "+ (params.length - 1));
        }
        result.append(params[num]);
      }
 catch (      NumberFormatException nfe) {
        throw new BadFormatString("bad format in username mapping in " + paramNum,nfe);
      }
    }
    start=match.end();
  }
  return result.toString();
}
