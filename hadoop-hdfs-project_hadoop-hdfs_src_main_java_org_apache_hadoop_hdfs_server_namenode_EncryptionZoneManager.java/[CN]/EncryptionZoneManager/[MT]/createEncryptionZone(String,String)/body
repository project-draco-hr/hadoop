{
  if (dir.isNonEmptyDirectory(src)) {
    throw new IOException("Attempt to create an encryption zone for a non-empty directory.");
  }
  final INodesInPath srcIIP=dir.getINodesInPath4Write(src,false);
  final EncryptionZoneInt ezi=getEncryptionZoneForPath(srcIIP);
  if (ezi != null) {
    throw new IOException("Directory " + src + " is already in an encryption zone. ("+ ezi.getFullPathName()+ ")");
  }
  final XAttr keyIdXAttr=XAttrHelper.buildXAttr(CRYPTO_XATTR_ENCRYPTION_ZONE,keyId.getBytes());
  final List<XAttr> xattrs=Lists.newArrayListWithCapacity(1);
  xattrs.add(keyIdXAttr);
  final INode inode=dir.unprotectedSetXAttrs(src,xattrs,EnumSet.of(XAttrSetFlag.CREATE));
  addEncryptionZone(inode.getId(),keyId);
  return keyIdXAttr;
}
