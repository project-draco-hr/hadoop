{
  HdfsConfiguration conf=new HdfsConfiguration();
  conf.setInt(DFSConfigKeys.DFS_HA_TAILEDITS_PERIOD_KEY,1);
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(1).nnTopology(MiniDFSNNTopology.simpleHATopology()).build();
  try {
    cluster.transitionToActive(0);
    FileSystem fs=HATestUtil.configureFailoverFs(cluster,conf);
    OutputStream out=fs.create(filePath);
    out.write("foo bar baz".getBytes());
    out.close();
    HATestUtil.waitForStandbyToCatchUp(cluster.getNameNode(0),cluster.getNameNode(1));
    ExtendedBlock block=DFSTestUtil.getFirstBlock(fs,filePath);
    assertTrue(MiniDFSCluster.changeGenStampOfBlock(0,block,900));
    DataNodeProperties dnProps=cluster.stopDataNode(0);
    cluster.restartNameNode(1,false);
    assertTrue(cluster.restartDataNode(dnProps,true));
    while (cluster.getNamesystem(1).getBlockManager().getPendingDataNodeMessageCount() < 1) {
      ThreadUtil.sleepAtLeastIgnoreInterrupts(1000);
    }
    assertEquals(1,cluster.getNamesystem(1).getBlockManager().getPendingDataNodeMessageCount());
    String oldStorageId=getRegisteredDatanodeUid(cluster,1);
    assertTrue(wipeAndRestartDn(cluster,0));
    String newStorageId="";
    do {
      ThreadUtil.sleepAtLeastIgnoreInterrupts(1000);
      newStorageId=getRegisteredDatanodeUid(cluster,1);
      System.out.println("====> oldStorageId: " + oldStorageId + " newStorageId: "+ newStorageId);
    }
 while (newStorageId.equals(oldStorageId));
    assertEquals(0,cluster.getNamesystem(1).getBlockManager().getPendingDataNodeMessageCount());
    cluster.transitionToStandby(0);
    cluster.transitionToActive(1);
  }
  finally {
    cluster.shutdown();
  }
}
