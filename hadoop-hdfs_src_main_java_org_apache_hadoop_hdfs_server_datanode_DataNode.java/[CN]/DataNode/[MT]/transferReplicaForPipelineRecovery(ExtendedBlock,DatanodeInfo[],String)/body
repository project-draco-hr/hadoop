{
  final long storedGS;
  final long visible;
  final BlockConstructionStage stage;
synchronized (data) {
    if (data.isValidRbw(b)) {
      stage=BlockConstructionStage.TRANSFER_RBW;
    }
 else     if (data.isValidBlock(b)) {
      stage=BlockConstructionStage.TRANSFER_FINALIZED;
    }
 else {
      final String r=data.getReplicaString(b.getBlockPoolId(),b.getBlockId());
      throw new IOException(b + " is neither a RBW nor a Finalized, r=" + r);
    }
    storedGS=data.getStoredBlock(b.getBlockPoolId(),b.getBlockId()).getGenerationStamp();
    if (storedGS < b.getGenerationStamp()) {
      throw new IOException(storedGS + " = storedGS < b.getGenerationStamp(), b=" + b);
    }
    visible=data.getReplicaVisibleLength(b);
  }
  b.setGenerationStamp(storedGS);
  b.setNumBytes(visible);
  if (targets.length > 0) {
    new DataTransfer(targets,b,stage,client).run();
  }
}
