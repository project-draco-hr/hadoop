{
  DatanodeProtocol dnp=(DatanodeProtocol)RPC.waitForProxy(DatanodeProtocol.class,DatanodeProtocol.versionID,nnAddr,conf);
  setNameNode(dnp);
  NamespaceInfo nsInfo=handshake();
  setNamespaceInfo(nsInfo);
synchronized (DataNode.this) {
    if (clusterId != null && !clusterId.equals(nsInfo.clusterID)) {
      throw new IOException("cannot register with the namenode because clusterid do not match:" + " nn=" + nsInfo.getBlockPoolID() + "; nn cid="+ nsInfo.clusterID+ ";dn cid="+ clusterId);
    }
    setupBPStorage();
    setClusterId(nsInfo.clusterID);
  }
  initPeriodicScanners(conf);
}
