{
  try {
    NameNodeAdapter.setLeasePeriod(fsn,100,200);
    final Path foo=new Path(dir,"foo");
    final Path bar=new Path(foo,"bar");
    DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPLICATION,0);
    HdfsDataOutputStream out=appendFileWithoutClosing(bar,100);
    out.hsync(EnumSet.of(SyncFlag.UPDATE_LENGTH));
    SnapshotTestHelper.createSnapshot(hdfs,dir,"s0");
    hdfs.delete(foo,true);
    Thread.sleep(1000);
    try {
      fsn.writeLock();
      NameNodeAdapter.getLeaseManager(fsn).runLeaseChecks();
    }
  finally {
      fsn.writeUnlock();
    }
  }
  finally {
    NameNodeAdapter.setLeasePeriod(fsn,HdfsServerConstants.LEASE_SOFTLIMIT_PERIOD,HdfsServerConstants.LEASE_HARDLIMIT_PERIOD);
  }
}
