{
  FileChecksum checksum=writeUnencryptedAndThenRestartEncryptedCluster();
  BlockTokenSecretManager btsm=cluster.getNamesystem().getBlockManager().getBlockTokenSecretManager();
  btsm.setKeyUpdateIntervalForTesting(2 * 1000);
  btsm.setTokenLifetime(2 * 1000);
  btsm.clearAllKeysForTesting();
  assertEquals(PLAIN_TEXT,DFSTestUtil.readFile(fs,TEST_PATH));
  assertEquals(checksum,fs.getFileChecksum(TEST_PATH));
  LOG.info("Sleeping so that encryption keys expire...");
  Thread.sleep(15 * 1000);
  LOG.info("Done sleeping.");
  assertEquals(PLAIN_TEXT,DFSTestUtil.readFile(fs,TEST_PATH));
  assertEquals(checksum,fs.getFileChecksum(TEST_PATH));
}
