{
  AMRMClient<AMRMClient.ContainerRequest> amClient=null;
  try {
    amClient=AMRMClient.<AMRMClient.ContainerRequest>createAMRMClient();
    amClient.setNMTokenCache(new NMTokenCache());
    Assert.assertNotSame(NMTokenCache.getSingleton(),amClient.getNMTokenCache());
    amClient.init(conf);
    amClient.start();
    amClient.registerApplicationMaster("Host",10000,"");
    testAllocation((AMRMClientImpl<AMRMClient.ContainerRequest>)amClient);
    amClient.unregisterApplicationMaster(FinalApplicationStatus.SUCCEEDED,null,null);
  }
  finally {
    if (amClient != null && amClient.getServiceState() == Service.STATE.STARTED) {
      amClient.stop();
    }
  }
}
