{
  AuthenticationToken token;
  String delegationParam=getDelegationToken(request);
  LOG.debug("Authenticating with delegationParam: {}, query string: {}",delegationParam,request.getQueryString());
  if (delegationParam != null) {
    try {
      Token<AbstractDelegationTokenIdentifier> dt=new Token();
      dt.decodeFromUrlString(delegationParam);
      UserGroupInformation ugi=tokenManager.verifyToken(dt);
      final String shortName=ugi.getShortUserName();
      token=new AuthenticationToken(shortName,ugi.getUserName(),getType());
      token.setExpires(0);
      request.setAttribute(DELEGATION_TOKEN_UGI_ATTRIBUTE,ugi);
    }
 catch (    Throwable ex) {
      token=null;
      HttpExceptionUtils.createServletExceptionResponse(response,HttpServletResponse.SC_FORBIDDEN,new AuthenticationException(ex));
    }
  }
 else {
    token=authHandler.authenticate(request,response);
  }
  return token;
}
