{
  AuthenticationToken token;
  String delegationParam=ServletUtils.getParameter(request,KerberosDelegationTokenAuthenticator.DELEGATION_PARAM);
  if (delegationParam != null) {
    try {
      Token<DelegationTokenIdentifier> dt=new Token<DelegationTokenIdentifier>();
      dt.decodeFromUrlString(delegationParam);
      UserGroupInformation ugi=tokenManager.verifyToken(dt);
      final String shortName=ugi.getShortUserName();
      token=new AuthenticationToken(shortName,ugi.getUserName(),getType());
      token.setExpires(0);
      request.setAttribute(DELEGATION_TOKEN_UGI_ATTRIBUTE,ugi);
    }
 catch (    Throwable ex) {
      throw new AuthenticationException("Could not verify DelegationToken, " + ex.toString(),ex);
    }
  }
 else {
    token=authHandler.authenticate(request,response);
  }
  return token;
}
