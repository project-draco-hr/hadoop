{
  MiniDFSCluster cluster=null;
  try {
    bld.format(false).startupOption(StartupOption.UPGRADE).clusterId("testClusterId");
    cluster=bld.build();
    cluster.waitActive();
    DistributedFileSystem dfs=cluster.getFileSystem();
    DFSClient dfsClient=dfs.dfs;
    while (dfsClient.setSafeMode(HdfsConstants.SafeModeAction.SAFEMODE_GET)) {
      LOG.info("Waiting for SafeMode to be OFF.");
      try {
        Thread.sleep(1000);
      }
 catch (      InterruptedException ignored) {
      }
    }
    recoverAllLeases(dfsClient,new Path("/"));
    verifyFileSystem(dfs);
    if (verifier != null) {
      verifier.verifyClusterPostUpgrade(cluster);
    }
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
