{
  unpackStorage(HADOOP22_IMAGE);
  File baseDir=new File(MiniDFSCluster.getBaseDirectory());
  FSImageTestUtil.corruptVersionFile(new File(baseDir,"name1/current/VERSION"),"imageMD5Digest","22222222222222222222222222222222");
  FSImageTestUtil.corruptVersionFile(new File(baseDir,"name2/current/VERSION"),"imageMD5Digest","22222222222222222222222222222222");
  try {
    upgradeAndVerify(new MiniDFSCluster.Builder(upgradeConf).numDataNodes(4));
    fail("Upgrade did not fail with bad MD5");
  }
 catch (  IOException ioe) {
    String msg=StringUtils.stringifyException(ioe);
    if (!msg.contains("is corrupt with MD5 checksum")) {
      throw ioe;
    }
  }
}
