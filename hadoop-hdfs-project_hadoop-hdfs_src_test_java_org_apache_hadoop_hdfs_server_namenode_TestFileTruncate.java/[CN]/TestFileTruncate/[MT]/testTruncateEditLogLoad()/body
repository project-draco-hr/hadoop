{
  fs.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
  fs.saveNamespace();
  fs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
  int startingFileSize=2 * BLOCK_SIZE + BLOCK_SIZE / 2;
  int toTruncate=1;
  final String s="/testTruncateEditLogLoad";
  final Path p=new Path(s);
  byte[] contents=AppendTestUtil.initBuffer(startingFileSize);
  writeContents(contents,startingFileSize,p);
  int newLength=startingFileSize - toTruncate;
  boolean isReady=fs.truncate(p,newLength);
  assertThat("truncate should have triggered block recovery.",isReady,is(false));
  cluster.restartNameNode();
  String holder=UserGroupInformation.getCurrentUser().getUserName();
  cluster.getNamesystem().recoverLease(s,holder,"");
  checkBlockRecovery(p);
  FileStatus fileStatus=fs.getFileStatus(p);
  assertThat(fileStatus.getLen(),is((long)newLength));
  checkFullFile(p,newLength,contents);
  fs.delete(p,false);
}
