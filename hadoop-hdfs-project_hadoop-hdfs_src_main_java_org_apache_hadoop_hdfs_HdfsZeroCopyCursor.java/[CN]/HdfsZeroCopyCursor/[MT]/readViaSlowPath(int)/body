{
  if (fallbackBuffer == null) {
    throw new UnsupportedOperationException("unable to read via " + "the fastpath, and there was no fallback buffer provided.");
  }
  fallbackBuffer.clear();
  fallbackBuffer.limit(toRead);
  int totalRead=0;
  readBuffer=fallbackBuffer;
  try {
    while (toRead > 0) {
      int nread=stream.read(fallbackBuffer);
      if (nread < 0) {
        break;
      }
      toRead-=nread;
      totalRead+=nread;
      if (allowShortReads) {
        break;
      }
    }
  }
  finally {
    fallbackBuffer.flip();
  }
  if ((toRead > 0) && (!allowShortReads)) {
    throw new EOFException("only read " + totalRead + " bytes out of "+ "a requested "+ toRead+ " before hitting EOF");
  }
  return totalRead;
}
