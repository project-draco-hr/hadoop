{
  try {
    fs=FileSystem.get(conf);
    fs.setPermission(new Path("/"),new FsPermission((short)0777));
    PermissionGenerator ancestorPermissionGenerator=new PermissionGenerator(r);
    PermissionGenerator dirPermissionGenerator=new PermissionGenerator(r);
    PermissionGenerator filePermissionGenerator=new PermissionGenerator(r);
    short[] ancestorPermissions=new short[NUM_TEST_PERMISSIONS];
    short[] parentPermissions=new short[NUM_TEST_PERMISSIONS];
    short[] permissions=new short[NUM_TEST_PERMISSIONS];
    Path[] ancestorPaths=new Path[NUM_TEST_PERMISSIONS];
    Path[] parentPaths=new Path[NUM_TEST_PERMISSIONS];
    Path[] filePaths=new Path[NUM_TEST_PERMISSIONS];
    Path[] dirPaths=new Path[NUM_TEST_PERMISSIONS];
    for (int i=0; i < NUM_TEST_PERMISSIONS; i++) {
      ancestorPaths[i]=new Path(ANCESTOR_NAME + i);
      create(OpType.MKDIRS,ancestorPaths[i]);
      fs.setOwner(ancestorPaths[i],USER1_NAME,GROUP2_NAME);
      parentPaths[i]=new Path(ancestorPaths[i],PARENT_NAME + i);
      create(OpType.MKDIRS,parentPaths[i]);
      fs.setOwner(parentPaths[i],USER1_NAME,GROUP2_NAME);
      filePaths[i]=new Path(parentPaths[i],FILE_NAME + i);
      dirPaths[i]=new Path(parentPaths[i],DIR_NAME + i);
      ancestorPermissions[i]=ancestorPermissionGenerator.next();
      parentPermissions[i]=dirPermissionGenerator.next();
      permissions[i]=filePermissionGenerator.next();
      fs.setPermission(ancestorPaths[i],new FsPermission(ancestorPermissions[i]));
      fs.setPermission(parentPaths[i],new FsPermission(parentPermissions[i]));
    }
    testPermissionCheckingPerUser(USER1,ancestorPermissions,parentPermissions,permissions,parentPaths,filePaths,dirPaths);
    testPermissionCheckingPerUser(USER2,ancestorPermissions,parentPermissions,permissions,parentPaths,filePaths,dirPaths);
    testPermissionCheckingPerUser(USER3,ancestorPermissions,parentPermissions,permissions,parentPaths,filePaths,dirPaths);
    testPermissionCheckingPerUser(SUPERUSER,ancestorPermissions,parentPermissions,permissions,parentPaths,filePaths,dirPaths);
  }
  finally {
    fs.close();
  }
}
