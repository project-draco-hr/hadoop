{
  cluster.getNamesystem().getSnapshotManager().setAllowNestedSnapshots(true);
  SnapshottableDirectoryStatus[] dirs=hdfs.getSnapshottableDirListing();
  assertNull(dirs);
  final Path root=new Path("/");
  hdfs.allowSnapshot(root);
  dirs=hdfs.getSnapshottableDirListing();
  assertEquals(1,dirs.length);
  assertEquals("",dirs[0].getDirStatus().getLocalName());
  assertEquals(root,dirs[0].getFullPath());
  hdfs.disallowSnapshot(root);
  dirs=hdfs.getSnapshottableDirListing();
  assertNull(dirs);
  hdfs.allowSnapshot(dir1);
  dirs=hdfs.getSnapshottableDirListing();
  assertEquals(1,dirs.length);
  assertEquals(dir1.getName(),dirs[0].getDirStatus().getLocalName());
  assertEquals(dir1,dirs[0].getFullPath());
  assertEquals(0,dirs[0].getSnapshotNumber());
  hdfs.allowSnapshot(dir2);
  dirs=hdfs.getSnapshottableDirListing();
  assertEquals(2,dirs.length);
  assertEquals(dir1.getName(),dirs[0].getDirStatus().getLocalName());
  assertEquals(dir1,dirs[0].getFullPath());
  assertEquals(dir2.getName(),dirs[1].getDirStatus().getLocalName());
  assertEquals(dir2,dirs[1].getFullPath());
  assertEquals(0,dirs[1].getSnapshotNumber());
  final Path dir3=new Path("/TestSnapshot3");
  hdfs.mkdirs(dir3);
  hdfs.rename(dir3,dir2,Rename.OVERWRITE);
  dirs=hdfs.getSnapshottableDirListing();
  assertEquals(1,dirs.length);
  assertEquals(dir1,dirs[0].getFullPath());
  hdfs.allowSnapshot(dir2);
  hdfs.createSnapshot(dir2,"s1");
  hdfs.createSnapshot(dir2,"s2");
  dirs=hdfs.getSnapshottableDirListing();
  assertEquals(dir2,dirs[1].getFullPath());
  assertEquals(2,dirs[1].getSnapshotNumber());
  Path sub1=new Path(dir1,"sub1");
  Path file1=new Path(sub1,"file1");
  Path sub2=new Path(dir1,"sub2");
  Path file2=new Path(sub2,"file2");
  DFSTestUtil.createFile(hdfs,file1,BLOCKSIZE,REPLICATION,seed);
  DFSTestUtil.createFile(hdfs,file2,BLOCKSIZE,REPLICATION,seed);
  hdfs.allowSnapshot(sub1);
  hdfs.allowSnapshot(sub2);
  dirs=hdfs.getSnapshottableDirListing();
  assertEquals(4,dirs.length);
  assertEquals(dir1,dirs[0].getFullPath());
  assertEquals(dir2,dirs[1].getFullPath());
  assertEquals(sub1,dirs[2].getFullPath());
  assertEquals(sub2,dirs[3].getFullPath());
  hdfs.disallowSnapshot(sub1);
  dirs=hdfs.getSnapshottableDirListing();
  assertEquals(3,dirs.length);
  assertEquals(dir1,dirs[0].getFullPath());
  assertEquals(dir2,dirs[1].getFullPath());
  assertEquals(sub2,dirs[2].getFullPath());
  hdfs.delete(dir1,true);
  dirs=hdfs.getSnapshottableDirListing();
  assertEquals(1,dirs.length);
  assertEquals(dir2.getName(),dirs[0].getDirStatus().getLocalName());
  assertEquals(dir2,dirs[0].getFullPath());
}
