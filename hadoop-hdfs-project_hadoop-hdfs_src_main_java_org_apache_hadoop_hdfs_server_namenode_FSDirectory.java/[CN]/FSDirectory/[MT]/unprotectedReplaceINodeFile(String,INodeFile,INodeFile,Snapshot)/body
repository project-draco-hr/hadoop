{
  Preconditions.checkState(hasWriteLock());
  INodeDirectory parent=oldnode.getParent();
  final INode removed=parent.removeChild(oldnode,latest);
  Preconditions.checkState(removed == oldnode,"removed != oldnode=%s, removed=%s",oldnode,removed);
  parent=removed.getParent();
  removed.clearReferences();
  if (removed instanceof FileWithSnapshot) {
    final FileWithSnapshot withSnapshot=(FileWithSnapshot)removed;
    if (withSnapshot.isEverythingDeleted()) {
      withSnapshot.removeSelf();
    }
  }
  parent.addChild(newnode,false,latest);
  int index=0;
  for (  BlockInfo b : newnode.getBlocks()) {
    BlockInfo info=getBlockManager().addBlockCollection(b,newnode);
    newnode.setBlock(index,info);
    index++;
  }
}
