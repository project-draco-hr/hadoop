{
  List<XAttr> xAttrs=Lists.newArrayListWithCapacity(existingXAttrs != null ? existingXAttrs.size() + 1 : 1);
  int userVisibleXAttrsNum=0;
  boolean exist=false;
  if (existingXAttrs != null) {
    for (    XAttr a : existingXAttrs) {
      if ((a.getNameSpace() == xAttr.getNameSpace() && a.getName().equals(xAttr.getName()))) {
        exist=true;
      }
 else {
        xAttrs.add(a);
        if (isUserVisible(a)) {
          userVisibleXAttrsNum++;
        }
      }
    }
  }
  XAttrSetFlag.validate(xAttr.getName(),exist,flag);
  xAttrs.add(xAttr);
  if (isUserVisible(xAttr)) {
    userVisibleXAttrsNum++;
  }
  if (userVisibleXAttrsNum > inodeXAttrsLimit) {
    throw new IOException("Cannot add additional XAttr to inode, " + "would exceed limit of " + inodeXAttrsLimit);
  }
  return xAttrs;
}
