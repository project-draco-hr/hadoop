{
  if (NameNode.stateChangeLog.isDebugEnabled()) {
    NameNode.stateChangeLog.debug("DIR* FSDirectory.delete: " + iip.getPath());
  }
  final long filesRemoved;
  writeLock();
  try {
    if (!deleteAllowed(iip,iip.getPath())) {
      filesRemoved=-1;
    }
 else {
      List<INodeDirectory> snapshottableDirs=new ArrayList<INodeDirectory>();
      FSDirSnapshotOp.checkSnapshot(iip.getLastINode(),snapshottableDirs);
      filesRemoved=unprotectedDelete(iip,collectedBlocks,removedINodes,mtime);
      namesystem.removeSnapshottableDirs(snapshottableDirs);
    }
  }
  finally {
    writeUnlock();
  }
  return filesRemoved;
}
