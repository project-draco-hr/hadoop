{
  waitForReady();
  final INodeFile src=rootDir.getINodeFile(srcPath);
  INodeFileSnapshot snapshot=new INodeFileSnapshot(src,src.computeFileSize(true));
  writeLock();
  try {
    snapshot=addNode(dstPath,snapshot,UNKNOWN_DISK_SPACE);
    final INodeFileWithLink srcWithLink;
    if (snapshot != null) {
      if (src instanceof INodeFileWithLink) {
        srcWithLink=(INodeFileWithLink)src;
      }
 else {
        srcWithLink=new INodeFileWithLink(src);
        replaceNode(srcPath,src,srcWithLink);
      }
      srcWithLink.insert(snapshot);
    }
  }
  finally {
    writeUnlock();
    if (snapshot == null) {
      NameNode.stateChangeLog.info("DIR* FSDirectory.addFileSnapshot: failed to add " + dstPath);
      return null;
    }
  }
  if (NameNode.stateChangeLog.isDebugEnabled()) {
    NameNode.stateChangeLog.debug("DIR* FSDirectory.addFileSnapshot: " + dstPath + " is added to the file system");
  }
  return snapshot;
}
