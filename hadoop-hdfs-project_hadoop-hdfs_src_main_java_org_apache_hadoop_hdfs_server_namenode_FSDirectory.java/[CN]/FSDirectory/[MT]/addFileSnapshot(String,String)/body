{
  waitForReady();
  final INodeFile src=rootDir.getINodeFile(srcPath);
  INodeFileSnapshot snapshot=new INodeFileSnapshot(src,src.computeFileSize(true));
  writeLock();
  try {
    snapshot=addNode(dstPath,snapshot,UNKNOWN_DISK_SPACE);
    if (snapshot != null && src.getClass() == INodeFile.class) {
      replaceNode(srcPath,src,new INodeFileWithLink(src));
    }
  }
  finally {
    writeUnlock();
    if (snapshot == null) {
      NameNode.stateChangeLog.info("DIR* FSDirectory.addFileSnapshot: failed to add " + dstPath);
      return null;
    }
  }
  if (NameNode.stateChangeLog.isDebugEnabled()) {
    NameNode.stateChangeLog.debug("DIR* FSDirectory.addFileSnapshot: " + dstPath + " is added to the file system");
  }
  return snapshot;
}
