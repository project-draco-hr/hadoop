{
  DistributedFileSystem fs=cluster.getFileSystem();
  final Path file1=new Path("/file1");
  DFSTestUtil.createFile(fs,file1,BLOCKSIZE - 1,REPLICATION,0L);
  FSDataOutputStream out=null;
  try {
    out=fs.append(file1);
    String appendContent="appending-content";
    out.writeBytes(appendContent);
    ((DFSOutputStream)out.getWrappedStream()).hsync(EnumSet.of(SyncFlag.UPDATE_LENGTH));
    cluster.restartNameNode(true);
    FSDirectory fsdir=cluster.getNamesystem().getFSDirectory();
    INodeFile fileNode=fsdir.getINode4Write(file1.toString()).asFile();
    BlockInfo[] fileBlocks=fileNode.getBlocks();
    assertEquals(2,fileBlocks.length);
    assertEquals(BLOCKSIZE,fileBlocks[0].getNumBytes());
    assertEquals(BlockUCState.COMPLETE,fileBlocks[0].getBlockUCState());
    assertEquals(appendContent.length() - 1,fileBlocks[1].getNumBytes());
    assertEquals(BlockUCState.UNDER_CONSTRUCTION,fileBlocks[1].getBlockUCState());
  }
  finally {
    if (out != null) {
      out.close();
    }
  }
}
