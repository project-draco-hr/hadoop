{
  DatanodeInfo[] nodes=block.getLocations();
  StorageType[] storageTypes=block.getStorageTypes();
  DatanodeInfo chosenNode=null;
  StorageType storageType=null;
  if (nodes != null) {
    for (int i=0; i < nodes.length; i++) {
      if (!deadNodes.containsKey(nodes[i]) && (ignoredNodes == null || !ignoredNodes.contains(nodes[i]))) {
        chosenNode=nodes[i];
        if (storageTypes != null && i < storageTypes.length) {
          storageType=storageTypes[i];
        }
        break;
      }
    }
  }
  if (chosenNode == null) {
    throw new IOException("No live nodes contain block " + block.getBlock() + " after checking nodes = "+ Arrays.toString(nodes)+ ", ignoredNodes = "+ ignoredNodes);
  }
  final String dnAddr=chosenNode.getXferAddr(dfsClient.getConf().connectToDnViaHostname);
  if (DFSClient.LOG.isDebugEnabled()) {
    DFSClient.LOG.debug("Connecting to datanode " + dnAddr);
  }
  InetSocketAddress targetAddr=NetUtils.createSocketAddr(dnAddr);
  return new DNAddrPair(chosenNode,targetAddr,storageType);
}
