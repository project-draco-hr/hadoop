{
  if (dfsClient.shouldTryShortCircuitRead(dnAddr) && !blockUnderConstruction()) {
    return DFSClient.getLocalBlockReader(dfsClient.conf,src,block,blockToken,chosenNode,dfsClient.hdfsTimeout,startOffset,dfsClient.connectToDnViaHostname());
  }
  IOException err=null;
  boolean fromCache=true;
  for (int retries=0; retries <= nCachedConnRetry && fromCache; ++retries) {
    Peer peer=null;
    if (retries < nCachedConnRetry) {
      peer=peerCache.get(chosenNode);
    }
    if (peer == null) {
      peer=newPeer(dnAddr);
      fromCache=false;
    }
    try {
      BlockReader reader=BlockReaderFactory.newBlockReader(new BlockReaderFactory.Params(dfsClient.getConf()).setFile(file).setBlock(block).setBlockToken(blockToken).setStartOffset(startOffset).setLen(len).setBufferSize(bufferSize).setVerifyChecksum(verifyChecksum).setClientName(clientName).setDatanodeID(chosenNode).setPeer(peer));
      return reader;
    }
 catch (    IOException ex) {
      DFSClient.LOG.debug("Error making BlockReader. Closing stale " + peer,ex);
      IOUtils.closeQuietly(peer);
      err=ex;
    }
  }
  throw err;
}
