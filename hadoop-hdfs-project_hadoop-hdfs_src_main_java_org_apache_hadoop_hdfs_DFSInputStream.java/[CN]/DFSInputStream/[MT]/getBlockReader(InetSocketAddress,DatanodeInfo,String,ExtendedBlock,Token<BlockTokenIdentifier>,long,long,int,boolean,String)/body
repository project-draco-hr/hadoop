{
  if (dfsClient.shouldTryShortCircuitRead(dnAddr) && !blockUnderConstruction()) {
    return DFSClient.getLocalBlockReader(dfsClient.conf,src,block,blockToken,chosenNode,dfsClient.hdfsTimeout,startOffset,dfsClient.connectToDnViaHostname());
  }
  IOException err=null;
  boolean fromCache=true;
  for (int retries=0; retries <= nCachedConnRetry && fromCache; ++retries) {
    SocketAndStreams sockAndStreams=null;
    if (retries < nCachedConnRetry) {
      sockAndStreams=socketCache.get(dnAddr);
    }
    Socket sock;
    if (sockAndStreams == null) {
      fromCache=false;
      sock=dfsClient.socketFactory.createSocket();
      sock.setTcpNoDelay(true);
      NetUtils.connect(sock,dnAddr,dfsClient.getRandomLocalInterfaceAddr(),dfsClient.getConf().socketTimeout);
      sock.setSoTimeout(dfsClient.getConf().socketTimeout);
    }
 else {
      sock=sockAndStreams.sock;
    }
    try {
      BlockReader reader=BlockReaderFactory.newBlockReader(dfsClient.getConf(),sock,file,block,blockToken,startOffset,len,bufferSize,verifyChecksum,clientName,dfsClient.getDataEncryptionKey(),sockAndStreams == null ? null : sockAndStreams.ioStreams);
      return reader;
    }
 catch (    IOException ex) {
      DFSClient.LOG.debug("Error making BlockReader. Closing stale " + sock,ex);
      if (sockAndStreams != null) {
        sockAndStreams.close();
      }
 else {
        sock.close();
      }
      err=ex;
    }
  }
  throw err;
}
