{
  response.setCharacterEncoding("UTF-8");
  String uri=HtmlQuoting.quoteHtmlChars(request.getRequestURI());
  if (uri == null) {
    uri="/";
  }
  RMWebApp rmWebApp=injector.getInstance(RMWebApp.class);
  rmWebApp.checkIfStandbyRM();
  if (rmWebApp.isStandby() && shouldRedirect(rmWebApp,uri)) {
    String redirectPath=rmWebApp.getRedirectPath();
    if (redirectPath != null && !redirectPath.isEmpty()) {
      redirectPath+=uri;
      String redirectMsg="This is standby RM. The redirect url is: " + redirectPath;
      PrintWriter out=response.getWriter();
      out.println(redirectMsg);
      response.setHeader("Location",redirectPath);
      response.setStatus(HttpServletResponse.SC_TEMPORARY_REDIRECT);
      return;
    }
 else {
      boolean doRetry=true;
      String retryIntervalStr=request.getParameter(YarnWebParams.NEXT_REFRESH_INTERVAL);
      int retryInterval=0;
      if (retryIntervalStr != null) {
        try {
          retryInterval=Integer.parseInt(retryIntervalStr.trim());
        }
 catch (        NumberFormatException ex) {
          doRetry=false;
        }
      }
      int next=calculateExponentialTime(retryInterval);
      String redirectUrl=appendOrReplaceParamter(path + uri,YarnWebParams.NEXT_REFRESH_INTERVAL + "=" + (retryInterval + 1));
      if (redirectUrl == null || next > MAX_SLEEP_TIME) {
        doRetry=false;
      }
      String redirectMsg=doRetry ? "Can not find any active RM. Will retry in next " + next + " seconds." : "There is no active RM right now.";
      PrintWriter out=response.getWriter();
      out.println(redirectMsg);
      if (doRetry) {
        response.setHeader("Refresh",next + ";url=" + redirectUrl);
        response.setStatus(HttpServletResponse.SC_TEMPORARY_REDIRECT);
      }
    }
    return;
  }
  super.doFilter(request,response,chain);
}
