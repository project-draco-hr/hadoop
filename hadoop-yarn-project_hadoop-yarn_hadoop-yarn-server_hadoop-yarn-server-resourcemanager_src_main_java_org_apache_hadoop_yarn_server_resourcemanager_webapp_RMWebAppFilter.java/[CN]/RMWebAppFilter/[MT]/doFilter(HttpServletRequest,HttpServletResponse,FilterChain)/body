{
  response.setCharacterEncoding("UTF-8");
  String htmlEscapedUri=HtmlQuoting.quoteHtmlChars(request.getRequestURI());
  if (htmlEscapedUri == null) {
    htmlEscapedUri="/";
  }
  String uriWithQueryString=htmlEscapedUri;
  String htmlEscapedUriWithQueryString=htmlEscapedUri;
  String queryString=request.getQueryString();
  if (queryString != null && !queryString.isEmpty()) {
    String reqEncoding=request.getCharacterEncoding();
    if (reqEncoding == null || reqEncoding.isEmpty()) {
      reqEncoding="ISO-8859-1";
    }
    Charset encoding=Charset.forName(reqEncoding);
    List<NameValuePair> params=URLEncodedUtils.parse(queryString,encoding);
    String urlEncodedQueryString=URLEncodedUtils.format(params,encoding);
    uriWithQueryString+="?" + urlEncodedQueryString;
    htmlEscapedUriWithQueryString=HtmlQuoting.quoteHtmlChars(request.getRequestURI() + "?" + urlEncodedQueryString);
  }
  RMWebApp rmWebApp=injector.getInstance(RMWebApp.class);
  rmWebApp.checkIfStandbyRM();
  if (rmWebApp.isStandby() && shouldRedirect(rmWebApp,htmlEscapedUri)) {
    String redirectPath=rmWebApp.getRedirectPath();
    if (redirectPath != null && !redirectPath.isEmpty()) {
      redirectPath+=uriWithQueryString;
      String redirectMsg="This is standby RM. The redirect url is: " + htmlEscapedUriWithQueryString;
      PrintWriter out=response.getWriter();
      out.println(redirectMsg);
      response.setHeader("Location",redirectPath);
      response.setStatus(HttpServletResponse.SC_TEMPORARY_REDIRECT);
      return;
    }
 else {
      boolean doRetry=true;
      String retryIntervalStr=request.getParameter(YarnWebParams.NEXT_REFRESH_INTERVAL);
      int retryInterval=0;
      if (retryIntervalStr != null) {
        try {
          retryInterval=Integer.parseInt(retryIntervalStr.trim());
        }
 catch (        NumberFormatException ex) {
          doRetry=false;
        }
      }
      int next=calculateExponentialTime(retryInterval);
      String redirectUrl=appendOrReplaceParamter(path + uriWithQueryString,YarnWebParams.NEXT_REFRESH_INTERVAL + "=" + (retryInterval + 1));
      if (redirectUrl == null || next > MAX_SLEEP_TIME) {
        doRetry=false;
      }
      String redirectMsg=doRetry ? "Can not find any active RM. Will retry in next " + next + " seconds." : "There is no active RM right now.";
      redirectMsg+="\nHA Zookeeper Connection State: " + rmWebApp.getHAZookeeperConnectionState();
      PrintWriter out=response.getWriter();
      out.println(redirectMsg);
      if (doRetry) {
        response.setHeader("Refresh",next + ";url=" + redirectUrl);
        response.setStatus(HttpServletResponse.SC_TEMPORARY_REDIRECT);
      }
    }
    return;
  }
 else   if (ahsEnabled) {
    String ahsRedirectUrl=ahsRedirectPath(uriWithQueryString,rmWebApp);
    if (ahsRedirectUrl != null) {
      response.setHeader("Location",ahsRedirectUrl);
      response.setStatus(HttpServletResponse.SC_TEMPORARY_REDIRECT);
      return;
    }
  }
  super.doFilter(request,response,chain);
}
