{
  if (!dir.isWithSnapshot()) {
    dir.addSnapshotFeature(null);
  }
  DirectoryDiffList diffs=dir.getDiffs();
  final LoaderContext state=parent.getLoaderContext();
  for (int i=0; i < size; i++) {
    SnapshotDiffSection.DirectoryDiff diffInPb=SnapshotDiffSection.DirectoryDiff.parseDelimitedFrom(in);
    final int snapshotId=diffInPb.getSnapshotId();
    final Snapshot snapshot=snapshotMap.get(snapshotId);
    int childrenSize=diffInPb.getChildrenSize();
    boolean useRoot=diffInPb.getIsSnapshotRoot();
    INodeDirectoryAttributes copy=null;
    if (useRoot) {
      copy=snapshot.getRoot();
    }
 else     if (diffInPb.hasSnapshotCopy()) {
      INodeSection.INodeDirectory dirCopyInPb=diffInPb.getSnapshotCopy();
      final byte[] name=diffInPb.getName().toByteArray();
      PermissionStatus permission=loadPermission(dirCopyInPb.getPermission(),state.getStringTable());
      AclFeature acl=null;
      if (dirCopyInPb.hasAcl()) {
        int[] entries=AclEntryStatusFormat.toInt(FSImageFormatPBINode.Loader.loadAclEntries(dirCopyInPb.getAcl(),state.getStringTable()));
        acl=new AclFeature(entries);
      }
      XAttrFeature xAttrs=null;
      if (dirCopyInPb.hasXAttrs()) {
        xAttrs=new XAttrFeature(FSImageFormatPBINode.Loader.loadXAttrs(dirCopyInPb.getXAttrs(),state.getStringTable()));
      }
      long modTime=dirCopyInPb.getModificationTime();
      boolean noQuota=dirCopyInPb.getNsQuota() == -1 && dirCopyInPb.getDsQuota() == -1 && (!dirCopyInPb.hasTypeQuotas());
      if (noQuota) {
        copy=new INodeDirectoryAttributes.SnapshotCopy(name,permission,acl,modTime,xAttrs);
      }
 else {
        EnumCounters<StorageType> typeQuotas=null;
        if (dirCopyInPb.hasTypeQuotas()) {
          ImmutableList<QuotaByStorageTypeEntry> qes=FSImageFormatPBINode.Loader.loadQuotaByStorageTypeEntries(dirCopyInPb.getTypeQuotas());
          typeQuotas=new EnumCounters<StorageType>(StorageType.class,HdfsConstants.QUOTA_RESET);
          for (          QuotaByStorageTypeEntry qe : qes) {
            if (qe.getQuota() >= 0 && qe.getStorageType() != null && qe.getStorageType().supportTypeQuota()) {
              typeQuotas.set(qe.getStorageType(),qe.getQuota());
            }
          }
        }
        copy=new INodeDirectoryAttributes.CopyWithQuota(name,permission,acl,modTime,dirCopyInPb.getNsQuota(),dirCopyInPb.getDsQuota(),typeQuotas,xAttrs);
      }
    }
    List<INode> clist=loadCreatedList(in,dir,diffInPb.getCreatedListSize());
    List<INode> dlist=loadDeletedList(refList,in,dir,diffInPb.getDeletedINodeList(),diffInPb.getDeletedINodeRefList());
    DirectoryDiff diff=new DirectoryDiff(snapshotId,copy,null,childrenSize,clist,dlist,useRoot);
    diffs.addFirst(diff);
  }
}
