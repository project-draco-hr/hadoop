{
  if (!isAMReachableFromClient) {
    return;
  }
  ResourceMgrDelegate rm=mock(ResourceMgrDelegate.class);
  when(rm.getApplicationReport(TypeConverter.toYarn(oldJobId).getAppId())).thenReturn(getRunningApplicationReport("am1",78));
  final MRClientProtocol amProxy=mock(MRClientProtocol.class);
  when(amProxy.getJobReport(any(GetJobReportRequest.class))).thenThrow(new RuntimeException("11")).thenThrow(new RuntimeException("22")).thenThrow(new RuntimeException("33")).thenThrow(new RuntimeException("44")).thenReturn(getJobReportResponse());
  Configuration conf=new YarnConfiguration();
  conf.set(MRConfig.FRAMEWORK_NAME,MRConfig.YARN_FRAMEWORK_NAME);
  conf.setBoolean(MRJobConfig.JOB_AM_ACCESS_DISABLED,!isAMReachableFromClient);
  ClientServiceDelegate clientServiceDelegate=new ClientServiceDelegate(conf,rm,oldJobId,null){
    @Override MRClientProtocol instantiateAMProxy(    final InetSocketAddress serviceAddr) throws IOException {
      super.instantiateAMProxy(serviceAddr);
      return amProxy;
    }
  }
;
  JobStatus jobStatus=clientServiceDelegate.getJobStatus(oldJobId);
  Assert.assertNotNull(jobStatus);
  Assert.assertEquals(conf.getInt(MRJobConfig.MR_CLIENT_MAX_RETRIES,MRJobConfig.DEFAULT_MR_CLIENT_MAX_RETRIES),clientServiceDelegate.getMaxClientRetry());
  verify(amProxy,times(5)).getJobReport(any(GetJobReportRequest.class));
}
