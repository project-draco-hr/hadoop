{
  LOG.info("Running Client");
  yarnClient.start();
  YarnClusterMetrics clusterMetrics=yarnClient.getYarnClusterMetrics();
  LOG.info("Got Cluster metric info from ASM" + ", numNodeManagers=" + clusterMetrics.getNumNodeManagers());
  List<NodeReport> clusterNodeReports=yarnClient.getNodeReports(NodeState.RUNNING);
  LOG.info("Got Cluster node info from ASM");
  for (  NodeReport node : clusterNodeReports) {
    LOG.info("Got node report from ASM for" + ", nodeId=" + node.getNodeId() + ", nodeAddress"+ node.getHttpAddress()+ ", nodeRackName"+ node.getRackName()+ ", nodeNumContainers"+ node.getNumContainers());
  }
  QueueInfo queueInfo=yarnClient.getQueueInfo(this.amQueue);
  LOG.info("Queue info" + ", queueName=" + queueInfo.getQueueName() + ", queueCurrentCapacity="+ queueInfo.getCurrentCapacity()+ ", queueMaxCapacity="+ queueInfo.getMaximumCapacity()+ ", queueApplicationCount="+ queueInfo.getApplications().size()+ ", queueChildQueueCount="+ queueInfo.getChildQueues().size());
  List<QueueUserACLInfo> listAclInfo=yarnClient.getQueueAclsInfo();
  for (  QueueUserACLInfo aclInfo : listAclInfo) {
    for (    QueueACL userAcl : aclInfo.getUserAcls()) {
      LOG.info("User ACL Info for Queue" + ", queueName=" + aclInfo.getQueueName() + ", userAcl="+ userAcl.name());
    }
  }
  YarnClientApplication app=yarnClient.createApplication();
  GetNewApplicationResponse appResponse=app.getNewApplicationResponse();
  int maxMem=appResponse.getMaximumResourceCapability().getMemory();
  LOG.info("Max mem capabililty of resources in this cluster " + maxMem);
  if (amMemory > maxMem) {
    LOG.info("AM memory specified above max threshold of cluster. Using max value." + ", specified=" + amMemory + ", max="+ maxMem);
    amMemory=maxMem;
  }
  int maxVCores=appResponse.getMaximumResourceCapability().getVirtualCores();
  LOG.info("Max virtual cores capabililty of resources in this cluster " + maxVCores);
  if (amVCores > maxVCores) {
    LOG.info("AM virtual cores specified above max threshold of cluster. " + "Using max value." + ", specified=" + amVCores + ", max="+ maxVCores);
    amVCores=maxVCores;
  }
  ApplicationSubmissionContext appContext=app.getApplicationSubmissionContext();
  ApplicationId appId=appContext.getApplicationId();
  appContext.setApplicationName(appName);
  ContainerLaunchContext amContainer=Records.newRecord(ContainerLaunchContext.class);
  Map<String,LocalResource> localResources=new HashMap<String,LocalResource>();
  LOG.info("Copy App Master jar from local filesystem and add to local environment");
  FileSystem fs=FileSystem.get(conf);
  Path src=new Path(appMasterJar);
  String pathSuffix=appName + "/" + appId.getId()+ "/AppMaster.jar";
  Path dst=new Path(fs.getHomeDirectory(),pathSuffix);
  fs.copyFromLocalFile(false,true,src,dst);
  FileStatus destStatus=fs.getFileStatus(dst);
  LocalResource amJarRsrc=Records.newRecord(LocalResource.class);
  amJarRsrc.setType(LocalResourceType.FILE);
  amJarRsrc.setVisibility(LocalResourceVisibility.APPLICATION);
  amJarRsrc.setResource(ConverterUtils.getYarnUrlFromPath(dst));
  amJarRsrc.setTimestamp(destStatus.getModificationTime());
  amJarRsrc.setSize(destStatus.getLen());
  localResources.put("AppMaster.jar",amJarRsrc);
  if (!log4jPropFile.isEmpty()) {
    Path log4jSrc=new Path(log4jPropFile);
    Path log4jDst=new Path(fs.getHomeDirectory(),"log4j.props");
    fs.copyFromLocalFile(false,true,log4jSrc,log4jDst);
    FileStatus log4jFileStatus=fs.getFileStatus(log4jDst);
    LocalResource log4jRsrc=Records.newRecord(LocalResource.class);
    log4jRsrc.setType(LocalResourceType.FILE);
    log4jRsrc.setVisibility(LocalResourceVisibility.APPLICATION);
    log4jRsrc.setResource(ConverterUtils.getYarnUrlFromURI(log4jDst.toUri()));
    log4jRsrc.setTimestamp(log4jFileStatus.getModificationTime());
    log4jRsrc.setSize(log4jFileStatus.getLen());
    localResources.put("log4j.properties",log4jRsrc);
  }
  String hdfsShellScriptLocation="";
  long hdfsShellScriptLen=0;
  long hdfsShellScriptTimestamp=0;
  if (!shellScriptPath.isEmpty()) {
    Path shellSrc=new Path(shellScriptPath);
    String shellPathSuffix=appName + "/" + appId.getId()+ "/ExecShellScript.sh";
    Path shellDst=new Path(fs.getHomeDirectory(),shellPathSuffix);
    fs.copyFromLocalFile(false,true,shellSrc,shellDst);
    hdfsShellScriptLocation=shellDst.toUri().toString();
    FileStatus shellFileStatus=fs.getFileStatus(shellDst);
    hdfsShellScriptLen=shellFileStatus.getLen();
    hdfsShellScriptTimestamp=shellFileStatus.getModificationTime();
  }
  if (!shellCommand.isEmpty()) {
    String shellCommandSuffix=appName + "/" + appId.getId()+ "/"+ shellCommandPath;
    Path shellCommandDst=new Path(fs.getHomeDirectory(),shellCommandSuffix);
    FSDataOutputStream ostream=null;
    try {
      ostream=FileSystem.create(fs,shellCommandDst,new FsPermission((short)0710));
      ostream.writeUTF(shellCommand);
    }
  finally {
      IOUtils.closeQuietly(ostream);
    }
    FileStatus scFileStatus=fs.getFileStatus(shellCommandDst);
    LocalResource scRsrc=LocalResource.newInstance(ConverterUtils.getYarnUrlFromURI(shellCommandDst.toUri()),LocalResourceType.FILE,LocalResourceVisibility.APPLICATION,scFileStatus.getLen(),scFileStatus.getModificationTime());
    localResources.put(shellCommandPath,scRsrc);
  }
  amContainer.setLocalResources(localResources);
  LOG.info("Set the environment for the application master");
  Map<String,String> env=new HashMap<String,String>();
  env.put(DSConstants.DISTRIBUTEDSHELLSCRIPTLOCATION,hdfsShellScriptLocation);
  env.put(DSConstants.DISTRIBUTEDSHELLSCRIPTTIMESTAMP,Long.toString(hdfsShellScriptTimestamp));
  env.put(DSConstants.DISTRIBUTEDSHELLSCRIPTLEN,Long.toString(hdfsShellScriptLen));
  StringBuilder classPathEnv=new StringBuilder(Environment.CLASSPATH.$()).append(File.pathSeparatorChar).append("./*");
  for (  String c : conf.getStrings(YarnConfiguration.YARN_APPLICATION_CLASSPATH,YarnConfiguration.DEFAULT_YARN_APPLICATION_CLASSPATH)) {
    classPathEnv.append(File.pathSeparatorChar);
    classPathEnv.append(c.trim());
  }
  classPathEnv.append(File.pathSeparatorChar).append("./log4j.properties");
  if (conf.getBoolean(YarnConfiguration.IS_MINI_YARN_CLUSTER,false)) {
    classPathEnv.append(':');
    classPathEnv.append(System.getProperty("java.class.path"));
  }
  env.put("CLASSPATH",classPathEnv.toString());
  amContainer.setEnvironment(env);
  Vector<CharSequence> vargs=new Vector<CharSequence>(30);
  LOG.info("Setting up app master command");
  vargs.add(Environment.JAVA_HOME.$() + "/bin/java");
  vargs.add("-Xmx" + amMemory + "m");
  vargs.add(appMasterMainClass);
  vargs.add("--container_memory " + String.valueOf(containerMemory));
  vargs.add("--container_vcores " + String.valueOf(containerVirtualCores));
  vargs.add("--num_containers " + String.valueOf(numContainers));
  vargs.add("--priority " + String.valueOf(shellCmdPriority));
  if (!shellArgs.isEmpty()) {
    vargs.add("--shell_args " + shellArgs + "");
  }
  for (  Map.Entry<String,String> entry : shellEnv.entrySet()) {
    vargs.add("--shell_env " + entry.getKey() + "="+ entry.getValue());
  }
  if (debugFlag) {
    vargs.add("--debug");
  }
  vargs.add("1>" + ApplicationConstants.LOG_DIR_EXPANSION_VAR + "/AppMaster.stdout");
  vargs.add("2>" + ApplicationConstants.LOG_DIR_EXPANSION_VAR + "/AppMaster.stderr");
  StringBuilder command=new StringBuilder();
  for (  CharSequence str : vargs) {
    command.append(str).append(" ");
  }
  LOG.info("Completed setting up app master command " + command.toString());
  List<String> commands=new ArrayList<String>();
  commands.add(command.toString());
  amContainer.setCommands(commands);
  Resource capability=Records.newRecord(Resource.class);
  capability.setMemory(amMemory);
  capability.setVirtualCores(amVCores);
  appContext.setResource(capability);
  if (UserGroupInformation.isSecurityEnabled()) {
    Credentials credentials=new Credentials();
    String tokenRenewer=conf.get(YarnConfiguration.RM_PRINCIPAL);
    if (tokenRenewer == null || tokenRenewer.length() == 0) {
      throw new IOException("Can't get Master Kerberos principal for the RM to use as renewer");
    }
    final Token<?> tokens[]=fs.addDelegationTokens(tokenRenewer,credentials);
    if (tokens != null) {
      for (      Token<?> token : tokens) {
        LOG.info("Got dt for " + fs.getUri() + "; "+ token);
      }
    }
    DataOutputBuffer dob=new DataOutputBuffer();
    credentials.writeTokenStorageToStream(dob);
    ByteBuffer fsTokens=ByteBuffer.wrap(dob.getData(),0,dob.getLength());
    amContainer.setTokens(fsTokens);
  }
  appContext.setAMContainerSpec(amContainer);
  Priority pri=Records.newRecord(Priority.class);
  pri.setPriority(amPriority);
  appContext.setPriority(pri);
  appContext.setQueue(amQueue);
  LOG.info("Submitting application to ASM");
  yarnClient.submitApplication(appContext);
  return monitorApplication(appId);
}
