{
  String user=application.getUser();
  User queueUser=getUser(user);
  Resource userLimit=computeUserLimit(application,clusterResource,required,queueUser,nodePartition,schedulingMode);
  setQueueResourceLimitsInfo(clusterResource);
  Resource headroom=getHeadroom(queueUser,cachedResourceLimitsForHeadroom.getLimit(),clusterResource,userLimit);
  if (LOG.isDebugEnabled()) {
    LOG.debug("Headroom calculation for user " + user + ": "+ " userLimit="+ userLimit+ " queueMaxAvailRes="+ cachedResourceLimitsForHeadroom.getLimit()+ " consumed="+ queueUser.getUsed()+ " headroom="+ headroom);
  }
  CapacityHeadroomProvider headroomProvider=new CapacityHeadroomProvider(queueUser,this,application,required,queueResourceLimitsInfo);
  application.setHeadroomProvider(headroomProvider);
  metrics.setAvailableResourcesToUser(user,headroom);
  return userLimit;
}
