{
  Resource amLimit=getAMResourceLimit();
  Resource userAMLimit=getUserAMResourceLimit();
  for (Iterator<FiCaSchedulerApp> i=pendingApplications.iterator(); i.hasNext(); ) {
    FiCaSchedulerApp application=i.next();
    ApplicationId applicationId=application.getApplicationId();
    Resource amIfStarted=Resources.add(application.getAMResource(),queueUsage.getAMUsed());
    if (LOG.isDebugEnabled()) {
      LOG.debug("application AMResource " + application.getAMResource() + " maxAMResourcePerQueuePercent "+ maxAMResourcePerQueuePercent+ " amLimit "+ amLimit+ " lastClusterResource "+ lastClusterResource+ " amIfStarted "+ amIfStarted);
    }
    if (!Resources.lessThanOrEqual(resourceCalculator,lastClusterResource,amIfStarted,amLimit)) {
      if (getNumActiveApplications() < 1) {
        LOG.warn("maximum-am-resource-percent is insufficient to start a" + " single application in queue, it is likely set too low." + " skipping enforcement to allow at least one application to start");
      }
 else {
        LOG.info("Not activating application " + applicationId + " as  amIfStarted: "+ amIfStarted+ " exceeds amLimit: "+ amLimit);
        continue;
      }
    }
    User user=getUser(application.getUser());
    Resource userAmIfStarted=Resources.add(application.getAMResource(),user.getConsumedAMResources());
    if (!Resources.lessThanOrEqual(resourceCalculator,lastClusterResource,userAmIfStarted,userAMLimit)) {
      if (getNumActiveApplications() < 1) {
        LOG.warn("maximum-am-resource-percent is insufficient to start a" + " single application in queue for user, it is likely set too low." + " skipping enforcement to allow at least one application to start");
      }
 else {
        LOG.info("Not activating application " + applicationId + " for user: "+ user+ " as userAmIfStarted: "+ userAmIfStarted+ " exceeds userAmLimit: "+ userAMLimit);
        continue;
      }
    }
    user.activateApplication();
    orderingPolicy.addSchedulableEntity(application);
    queueUsage.incAMUsed(application.getAMResource());
    user.getResourceUsage().incAMUsed(application.getAMResource());
    metrics.incAMUsed(application.getUser(),application.getAMResource());
    metrics.setAMResouceLimitForUser(application.getUser(),userAMLimit);
    i.remove();
    LOG.info("Application " + applicationId + " from user: "+ application.getUser()+ " activated in queue: "+ getQueueName());
  }
}
