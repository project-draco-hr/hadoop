{
  final Resource queueCapacity=Resources.max(resourceCalculator,clusterResource,Resources.multiplyAndNormalizeUp(resourceCalculator,clusterResource,absoluteCapacity,minimumAllocation),required);
  Resource currentCapacity=Resources.lessThan(resourceCalculator,clusterResource,usedResources,queueCapacity) ? queueCapacity : Resources.add(usedResources,required);
  final int activeUsers=activeUsersManager.getNumActiveUsers();
  Resource limit=Resources.roundUp(resourceCalculator,Resources.min(resourceCalculator,clusterResource,Resources.max(resourceCalculator,clusterResource,Resources.divideAndCeil(resourceCalculator,currentCapacity,activeUsers),Resources.divideAndCeil(resourceCalculator,Resources.multiplyAndRoundDown(currentCapacity,userLimit),100)),Resources.multiplyAndRoundDown(queueCapacity,userLimitFactor)),minimumAllocation);
  if (LOG.isDebugEnabled()) {
    String userName=application.getUser();
    LOG.debug("User limit computation for " + userName + " in queue "+ getQueueName()+ " userLimit="+ userLimit+ " userLimitFactor="+ userLimitFactor+ " required: "+ required+ " consumed: "+ user.getConsumedResources()+ " limit: "+ limit+ " queueCapacity: "+ queueCapacity+ " qconsumed: "+ usedResources+ " currentCapacity: "+ currentCapacity+ " activeUsers: "+ activeUsers+ " clusterCapacity: "+ clusterResource);
  }
  return limit;
}
