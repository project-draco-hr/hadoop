{
  Resource partitionResource=labelManager.getResourceByLabel(nodePartition,clusterResource);
  Resource queueCapacity=Resources.multiplyAndNormalizeUp(resourceCalculator,partitionResource,queueCapacities.getAbsoluteCapacity(nodePartition),minimumAllocation);
  Resource required=minimumAllocation;
  queueCapacity=Resources.max(resourceCalculator,partitionResource,queueCapacity,required);
  Resource consumed=Resources.multiplyAndNormalizeUp(resourceCalculator,partitionResource,qUsageRatios.getUsageRatio(nodePartition),minimumAllocation);
  Resource currentCapacity=Resources.lessThan(resourceCalculator,partitionResource,consumed,queueCapacity) ? queueCapacity : Resources.add(consumed,required);
  final int activeUsers=activeUsersManager.getNumActiveUsers();
  Resource userLimitResource=Resources.max(resourceCalculator,partitionResource,Resources.divideAndCeil(resourceCalculator,currentCapacity,activeUsers),Resources.divideAndCeil(resourceCalculator,Resources.multiplyAndRoundDown(currentCapacity,userLimit),100));
  Resource maxUserLimit=Resources.none();
  if (schedulingMode == SchedulingMode.RESPECT_PARTITION_EXCLUSIVITY) {
    maxUserLimit=Resources.multiplyAndRoundDown(queueCapacity,userLimitFactor);
  }
 else   if (schedulingMode == SchedulingMode.IGNORE_PARTITION_EXCLUSIVITY) {
    maxUserLimit=partitionResource;
  }
  userLimitResource=Resources.roundUp(resourceCalculator,Resources.min(resourceCalculator,partitionResource,userLimitResource,maxUserLimit),minimumAllocation);
  if (LOG.isDebugEnabled()) {
    String userName=application.getUser();
    LOG.debug("User limit computation for " + userName + " in queue "+ getQueueName()+ " userLimitPercent="+ userLimit+ " userLimitFactor="+ userLimitFactor+ " required: "+ required+ " consumed: "+ consumed+ " user-limit-resource: "+ userLimitResource+ " queueCapacity: "+ queueCapacity+ " qconsumed: "+ queueUsage.getUsed()+ " consumedRatio: "+ totalUserConsumedRatio+ " currentCapacity: "+ currentCapacity+ " activeUsers: "+ activeUsers+ " clusterCapacity: "+ clusterResource+ " resourceByLabel: "+ partitionResource+ " usageratio: "+ qUsageRatios.getUsageRatio(nodePartition)+ " Partition: "+ nodePartition);
  }
  user.setUserResourceLimit(userLimitResource);
  return userLimitResource;
}
