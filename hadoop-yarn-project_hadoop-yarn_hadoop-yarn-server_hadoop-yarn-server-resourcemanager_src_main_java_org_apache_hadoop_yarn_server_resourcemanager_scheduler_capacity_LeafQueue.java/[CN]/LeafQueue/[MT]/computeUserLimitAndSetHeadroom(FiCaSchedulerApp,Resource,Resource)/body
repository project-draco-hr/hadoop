{
  String user=application.getUser();
  Resource userLimit=computeUserLimit(application,clusterResource,required);
  float absoluteMaxAvailCapacity=CSQueueUtils.getAbsoluteMaxAvailCapacity(resourceCalculator,clusterResource,this);
  Resource queueMaxCap=Resources.multiplyAndNormalizeDown(resourceCalculator,clusterResource,absoluteMaxAvailCapacity,minimumAllocation);
  Resource userConsumed=getUser(user).getConsumedResources();
  Resource headroom=Resources.subtract(Resources.min(resourceCalculator,clusterResource,userLimit,queueMaxCap),userConsumed);
  if (LOG.isDebugEnabled()) {
    LOG.debug("Headroom calculation for user " + user + ": "+ " userLimit="+ userLimit+ " queueMaxCap="+ queueMaxCap+ " consumed="+ userConsumed+ " headroom="+ headroom);
  }
  application.setHeadroom(headroom);
  metrics.setAvailableResourcesToUser(user,headroom);
  return userLimit;
}
