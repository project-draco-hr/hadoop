{
  try {
    if (!isLastAMRetry) {
      if (((JobImpl)job).getInternalState() != JobStateInternal.REBOOT) {
        LOG.info("We are finishing cleanly so this is the last retry");
        isLastAMRetry=true;
      }
    }
    notifyIsLastAMRetry(isLastAMRetry);
    LOG.info("Calling stop for all the services");
    MRAppMaster.this.stop();
    if (isLastAMRetry) {
      if (getConfig().get(MRJobConfig.MR_JOB_END_NOTIFICATION_URL) != null) {
        try {
          LOG.info("Job end notification started for jobID : " + job.getReport().getJobId());
          JobEndNotifier notifier=new JobEndNotifier();
          notifier.setConf(getConfig());
          JobReport report=job.getReport();
          if (!context.hasSuccessfullyUnregistered()) {
            report.setJobState(JobState.FAILED);
          }
          notifier.notify(report);
        }
 catch (        InterruptedException ie) {
          LOG.warn("Job end notification interrupted for jobID : " + job.getReport().getJobId(),ie);
        }
      }
    }
    try {
      Thread.sleep(5000);
    }
 catch (    InterruptedException e) {
      e.printStackTrace();
    }
    clientService.stop();
  }
 catch (  Throwable t) {
    LOG.warn("Graceful stop failed ",t);
  }
}
