{
  downloadTokensAndSetupUGI(conf);
  context=new RunningAppContext(conf);
  appName=conf.get(MRJobConfig.JOB_NAME,"<missing app name>");
  conf.setInt(MRJobConfig.APPLICATION_ATTEMPT_ID,appAttemptID.getAttemptId());
  newApiCommitter=false;
  jobId=MRBuilderUtils.newJobId(appAttemptID.getApplicationId(),appAttemptID.getApplicationId().getId());
  int numReduceTasks=conf.getInt(MRJobConfig.NUM_REDUCES,0);
  if ((numReduceTasks > 0 && conf.getBoolean("mapred.reducer.new-api",false)) || (numReduceTasks == 0 && conf.getBoolean("mapred.mapper.new-api",false))) {
    newApiCommitter=true;
    LOG.info("Using mapred newApiCommitter.");
  }
  committer=createOutputCommitter(conf);
  boolean recoveryEnabled=conf.getBoolean(MRJobConfig.MR_AM_JOB_RECOVERY_ENABLE,true);
  boolean recoverySupportedByCommitter=committer.isRecoverySupported();
  if (recoveryEnabled && recoverySupportedByCommitter && appAttemptID.getAttemptId() > 1) {
    LOG.info("Recovery is enabled. " + "Will try to recover from previous life on best effort basis.");
    recoveryServ=new RecoveryService(appAttemptID,clock,committer);
    addIfService(recoveryServ);
    dispatcher=recoveryServ.getDispatcher();
    clock=recoveryServ.getClock();
    inRecovery=true;
  }
 else {
    LOG.info("Not starting RecoveryService: recoveryEnabled: " + recoveryEnabled + " recoverySupportedByCommitter: "+ recoverySupportedByCommitter+ " ApplicationAttemptID: "+ appAttemptID.getAttemptId());
    dispatcher=new AsyncDispatcher();
    addIfService(dispatcher);
  }
  taskAttemptListener=createTaskAttemptListener(context);
  addIfService(taskAttemptListener);
  taskCleaner=createTaskCleaner(context);
  addIfService(taskCleaner);
  clientService=createClientService(context);
  addIfService(clientService);
  EventHandler<JobHistoryEvent> historyService=createJobHistoryHandler(context);
  dispatcher.register(org.apache.hadoop.mapreduce.jobhistory.EventType.class,historyService);
  this.jobEventDispatcher=new JobEventDispatcher();
  dispatcher.register(JobEventType.class,jobEventDispatcher);
  dispatcher.register(TaskEventType.class,new TaskEventDispatcher());
  dispatcher.register(TaskAttemptEventType.class,new TaskAttemptEventDispatcher());
  dispatcher.register(TaskCleaner.EventType.class,taskCleaner);
  if (conf.getBoolean(MRJobConfig.MAP_SPECULATIVE,false) || conf.getBoolean(MRJobConfig.REDUCE_SPECULATIVE,false)) {
    speculator=createSpeculator(conf,context);
    addIfService(speculator);
  }
  dispatcher.register(Speculator.EventType.class,new SpeculatorEventDispatcher(conf));
  containerAllocator=createContainerAllocator(clientService,context);
  addIfService(containerAllocator);
  dispatcher.register(ContainerAllocator.EventType.class,containerAllocator);
  containerLauncher=createContainerLauncher(context);
  addIfService(containerLauncher);
  dispatcher.register(ContainerLauncher.EventType.class,containerLauncher);
  addIfService(historyService);
  super.init(conf);
}
