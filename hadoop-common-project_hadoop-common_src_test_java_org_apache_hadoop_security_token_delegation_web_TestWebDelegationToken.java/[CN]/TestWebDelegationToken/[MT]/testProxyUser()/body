{
  final Server jetty=createJettyServer();
  Context context=new Context();
  context.setContextPath("/foo");
  jetty.setHandler(context);
  context.addFilter(new FilterHolder(PseudoDTAFilter.class),"/*",0);
  context.addServlet(new ServletHolder(UserServlet.class),"/bar");
  try {
    jetty.start();
    final URL url=new URL(getJettyURL() + "/foo/bar");
    UserGroupInformation ugi=UserGroupInformation.createRemoteUser(FOO_USER);
    ugi.doAs(new PrivilegedExceptionAction<Void>(){
      @Override public Void run() throws Exception {
        DelegationTokenAuthenticatedURL.Token token=new DelegationTokenAuthenticatedURL.Token();
        DelegationTokenAuthenticatedURL aUrl=new DelegationTokenAuthenticatedURL();
        HttpURLConnection conn=aUrl.openConnection(url,token,OK_USER);
        Assert.assertEquals(HttpURLConnection.HTTP_OK,conn.getResponseCode());
        List<String> ret=IOUtils.readLines(conn.getInputStream());
        Assert.assertEquals(1,ret.size());
        Assert.assertEquals(OK_USER,ret.get(0));
        conn=aUrl.openConnection(url,token,FAIL_USER);
        Assert.assertEquals(HttpURLConnection.HTTP_FORBIDDEN,conn.getResponseCode());
        aUrl.getDelegationToken(url,token,FOO_USER);
        UserGroupInformation ugi=UserGroupInformation.getCurrentUser();
        ugi.addToken(token.getDelegationToken());
        token=new DelegationTokenAuthenticatedURL.Token();
        conn=aUrl.openConnection(url,token,OK_USER);
        Assert.assertEquals(HttpURLConnection.HTTP_OK,conn.getResponseCode());
        ret=IOUtils.readLines(conn.getInputStream());
        Assert.assertEquals(1,ret.size());
        Assert.assertEquals(FOO_USER,ret.get(0));
        return null;
      }
    }
);
  }
  finally {
    jetty.stop();
  }
}
