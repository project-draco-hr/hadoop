{
synchronized (lock) {
    if (event.getHistoryEvent().getEventType() == EventType.AM_STARTED) {
      try {
        AMStartedEvent amStartedEvent=(AMStartedEvent)event.getHistoryEvent();
        setupEventWriter(event.getJobID(),amStartedEvent.getForcedJobStateOnShutDown());
      }
 catch (      IOException ioe) {
        LOG.error("Error JobHistoryEventHandler in handleEvent: " + event,ioe);
        throw new YarnRuntimeException(ioe);
      }
    }
    MetaInfo mi=fileMap.get(event.getJobID());
    try {
      HistoryEvent historyEvent=event.getHistoryEvent();
      if (!(historyEvent instanceof NormalizedResourceEvent)) {
        mi.writeEvent(historyEvent);
      }
      processEventForJobSummary(event.getHistoryEvent(),mi.getJobSummary(),event.getJobID());
      processEventForTimelineServer(historyEvent,event.getJobID(),event.getTimestamp());
      if (LOG.isDebugEnabled()) {
        LOG.debug("In HistoryEventHandler " + event.getHistoryEvent().getEventType());
      }
    }
 catch (    IOException e) {
      LOG.error("Error writing History Event: " + event.getHistoryEvent(),e);
      throw new YarnRuntimeException(e);
    }
    if (event.getHistoryEvent().getEventType() == EventType.JOB_SUBMITTED) {
      JobSubmittedEvent jobSubmittedEvent=(JobSubmittedEvent)event.getHistoryEvent();
      mi.getJobIndexInfo().setSubmitTime(jobSubmittedEvent.getSubmitTime());
      mi.getJobIndexInfo().setQueueName(jobSubmittedEvent.getJobQueueName());
    }
    if (event.getHistoryEvent().getEventType() == EventType.JOB_INITED) {
      JobInitedEvent jie=(JobInitedEvent)event.getHistoryEvent();
      mi.getJobIndexInfo().setJobStartTime(jie.getLaunchTime());
    }
    if (event.getHistoryEvent().getEventType() == EventType.JOB_QUEUE_CHANGED) {
      JobQueueChangeEvent jQueueEvent=(JobQueueChangeEvent)event.getHistoryEvent();
      mi.getJobIndexInfo().setQueueName(jQueueEvent.getJobQueueName());
    }
    if (event.getHistoryEvent().getEventType() == EventType.JOB_FINISHED) {
      try {
        JobFinishedEvent jFinishedEvent=(JobFinishedEvent)event.getHistoryEvent();
        mi.getJobIndexInfo().setFinishTime(jFinishedEvent.getFinishTime());
        mi.getJobIndexInfo().setNumMaps(jFinishedEvent.getFinishedMaps());
        mi.getJobIndexInfo().setNumReduces(jFinishedEvent.getFinishedReduces());
        mi.getJobIndexInfo().setJobStatus(JobState.SUCCEEDED.toString());
        closeEventWriter(event.getJobID());
        processDoneFiles(event.getJobID());
      }
 catch (      IOException e) {
        throw new YarnRuntimeException(e);
      }
    }
    if (event.getHistoryEvent().getEventType() == EventType.JOB_ERROR) {
      try {
        JobUnsuccessfulCompletionEvent jucEvent=(JobUnsuccessfulCompletionEvent)event.getHistoryEvent();
        mi.getJobIndexInfo().setFinishTime(jucEvent.getFinishTime());
        mi.getJobIndexInfo().setNumMaps(jucEvent.getFinishedMaps());
        mi.getJobIndexInfo().setNumReduces(jucEvent.getFinishedReduces());
        mi.getJobIndexInfo().setJobStatus(jucEvent.getStatus());
        closeEventWriter(event.getJobID());
        if (context.isLastAMRetry())         processDoneFiles(event.getJobID());
      }
 catch (      IOException e) {
        throw new YarnRuntimeException(e);
      }
    }
    if (event.getHistoryEvent().getEventType() == EventType.JOB_FAILED || event.getHistoryEvent().getEventType() == EventType.JOB_KILLED) {
      try {
        JobUnsuccessfulCompletionEvent jucEvent=(JobUnsuccessfulCompletionEvent)event.getHistoryEvent();
        mi.getJobIndexInfo().setFinishTime(jucEvent.getFinishTime());
        mi.getJobIndexInfo().setNumMaps(jucEvent.getFinishedMaps());
        mi.getJobIndexInfo().setNumReduces(jucEvent.getFinishedReduces());
        mi.getJobIndexInfo().setJobStatus(jucEvent.getStatus());
        closeEventWriter(event.getJobID());
        processDoneFiles(event.getJobID());
      }
 catch (      IOException e) {
        throw new YarnRuntimeException(e);
      }
    }
  }
}
