{
  ensureOperational();
  Check.notNull(klass,"serviceKlass");
  if (getStatus() == Status.SHUTTING_DOWN) {
    throw new IllegalStateException("Server shutting down");
  }
  try {
    Service newService=klass.newInstance();
    Service oldService=services.get(newService.getInterface());
    if (oldService != null) {
      try {
        oldService.destroy();
      }
 catch (      Throwable ex) {
        log.error("Could not destroy service [{}], {}",new Object[]{oldService.getInterface(),ex.getMessage(),ex});
      }
    }
    newService.init(this);
    services.put(newService.getInterface(),newService);
  }
 catch (  Exception ex) {
    log.error("Could not set service [{}] programmatically -server shutting down-, {}",klass,ex);
    destroy();
    throw new ServerException(ServerException.ERROR.S09,klass,ex.getMessage(),ex);
  }
}
