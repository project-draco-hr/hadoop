{
  Server server=new TestServer(1,true);
  InetSocketAddress addr=NetUtils.getConnectAddress(server);
  server.start();
  Socket socket=new Socket();
  try {
    NetUtils.connect(socket,addr,5000);
    OutputStream out=socket.getOutputStream();
    InputStream in=socket.getInputStream();
    out.write(requestData,0,requestData.length);
    out.flush();
    ByteArrayOutputStream baos=new ByteArrayOutputStream();
    IOUtils.copyBytes(in,baos,256);
    byte[] responseData=baos.toByteArray();
    assertEquals(StringUtils.byteToHexString(expectedResponse),StringUtils.byteToHexString(responseData));
  }
  finally {
    IOUtils.closeSocket(socket);
    server.stop();
  }
}
