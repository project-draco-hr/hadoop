{
  Server[] servers=new Server[serverCount];
  for (int i=0; i < serverCount; i++) {
    servers[i]=new TestServer(handlerCount,handlerSleep);
    servers[i].start();
  }
  InetSocketAddress[] addresses=new InetSocketAddress[addressCount];
  for (int i=0; i < addressCount; i++) {
    addresses[i]=NetUtils.getConnectAddress(servers[i % serverCount]);
  }
  Client[] clients=new Client[clientCount];
  for (int i=0; i < clientCount; i++) {
    clients[i]=new Client(LongWritable.class,conf);
  }
  ParallelCaller[] callers=new ParallelCaller[callerCount];
  for (int i=0; i < callerCount; i++) {
    callers[i]=new ParallelCaller(clients[i % clientCount],addresses,callCount);
    callers[i].start();
  }
  for (int i=0; i < callerCount; i++) {
    callers[i].join();
    assertFalse(callers[i].failed);
  }
  for (int i=0; i < clientCount; i++) {
    clients[i].stop();
  }
  for (int i=0; i < serverCount; i++) {
    servers[i].stop();
  }
}
