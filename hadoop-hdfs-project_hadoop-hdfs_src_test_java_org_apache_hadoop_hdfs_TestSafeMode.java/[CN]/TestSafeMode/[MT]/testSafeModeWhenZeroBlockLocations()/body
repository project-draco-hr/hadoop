{
  try {
    Path file1=new Path("/tmp/testManualSafeMode/file1");
    Path file2=new Path("/tmp/testManualSafeMode/file2");
    System.out.println("Created file1 and file2.");
    DFSTestUtil.createFile(fs,file1,1000,(short)1,0);
    DFSTestUtil.createFile(fs,file2,2000,(short)1,0);
    checkGetBlockLocationsWorks(fs,file1);
    NameNode namenode=cluster.getNameNode();
    dfs.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
    assertTrue("should still be in SafeMode",namenode.isInSafeMode());
    checkGetBlockLocationsWorks(fs,file1);
    dfs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
    assertFalse("should not be in SafeMode",namenode.isInSafeMode());
    cluster.shutdownDataNodes();
    cluster.shutdownNameNode(0);
    cluster.restartNameNode();
    cluster.waitActive();
    System.out.println("Restarted cluster with just the NameNode");
    namenode=cluster.getNameNode();
    assertTrue("No datanode is started. Should be in SafeMode",namenode.isInSafeMode());
    FileStatus stat=fs.getFileStatus(file1);
    try {
      fs.getFileBlockLocations(stat,0,1000);
      assertTrue("Should have got safemode exception",false);
    }
 catch (    SafeModeException e) {
    }
catch (    RemoteException re) {
      if (!re.getClassName().equals(SafeModeException.class.getName()))       assertTrue("Should have got safemode exception",false);
    }
    dfs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
    assertFalse("Should not be in safemode",namenode.isInSafeMode());
    checkGetBlockLocationsWorks(fs,file1);
  }
  finally {
    if (fs != null)     fs.close();
    if (cluster != null)     cluster.shutdown();
  }
}
