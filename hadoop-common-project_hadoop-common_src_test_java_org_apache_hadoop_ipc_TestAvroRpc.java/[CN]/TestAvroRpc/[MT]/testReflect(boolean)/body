{
  Configuration conf=new Configuration();
  TestTokenSecretManager sm=null;
  if (secure) {
    makeSecure(conf);
    sm=new TestTokenSecretManager();
  }
  UserGroupInformation.setConfiguration(conf);
  RPC.setProtocolEngine(conf,EmptyProtocol.class,AvroRpcEngine.class);
  RPC.setProtocolEngine(conf,AvroTestProtocol.class,AvroRpcEngine.class);
  RPC.Server server=RPC.getServer(EmptyProtocol.class,new EmptyImpl(),ADDRESS,0,5,true,conf,sm);
  server.addProtocol(RpcKind.RPC_WRITABLE,AvroTestProtocol.class,new TestImpl());
  try {
    server.start();
    InetSocketAddress addr=NetUtils.getConnectAddress(server);
    if (secure) {
      addToken(sm,addr);
      Assert.assertEquals("auth",SaslRpcServer.SASL_PROPS.get(Sasl.QOP));
    }
    AvroTestProtocol proxy=(AvroTestProtocol)RPC.getProxy(AvroTestProtocol.class,0,addr,conf);
    proxy.ping();
    String echo=proxy.echo("hello world");
    assertEquals("hello world",echo);
    int intResult=proxy.add(1,2);
    assertEquals(3,intResult);
    boolean caught=false;
    try {
      proxy.error();
    }
 catch (    AvroRemoteException e) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Caught " + e);
      }
      caught=true;
    }
    assertTrue(caught);
  }
  finally {
    resetSecurity();
    server.stop();
  }
}
