{
  StorageDirectory sd=new StorageDirectory(dataDir,null,true);
  try {
    StorageState curState=sd.analyzeStorage(startOpt,this);
switch (curState) {
case NORMAL:
      break;
case NON_EXISTENT:
    LOG.info("Block pool storage directory " + dataDir + " does not exist");
  throw new IOException("Storage directory " + dataDir + " does not exist");
case NOT_FORMATTED:
LOG.info("Block pool storage directory " + dataDir + " is not formatted for "+ nsInfo.getBlockPoolID());
LOG.info("Formatting ...");
format(sd,nsInfo);
break;
default :
sd.doRecover(curState);
}
doTransition(datanode,sd,nsInfo,startOpt);
if (getCTime() != nsInfo.getCTime()) {
throw new IOException("Data-node and name-node CTimes must be the same.");
}
setServiceLayoutVersion(getServiceLayoutVersion());
writeProperties(sd);
return sd;
}
 catch (IOException ioe) {
sd.unlock();
throw ioe;
}
}
