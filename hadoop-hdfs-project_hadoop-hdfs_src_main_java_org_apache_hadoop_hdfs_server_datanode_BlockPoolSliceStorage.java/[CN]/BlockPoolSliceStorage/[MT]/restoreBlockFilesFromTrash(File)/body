{
  int filesRestored=0;
  File[] children=trashRoot.exists() ? trashRoot.listFiles() : null;
  if (children == null) {
    return 0;
  }
  File restoreDirectory=null;
  for (  File child : children) {
    if (child.isDirectory()) {
      filesRestored+=restoreBlockFilesFromTrash(child);
      continue;
    }
    if (restoreDirectory == null) {
      restoreDirectory=new File(getRestoreDirectory(child));
      if (!restoreDirectory.exists() && !restoreDirectory.mkdirs()) {
        throw new IOException("Failed to create directory " + restoreDirectory);
      }
    }
    final File newChild=new File(restoreDirectory,child.getName());
    if (newChild.exists() && newChild.length() >= child.length()) {
      LOG.info("Not overwriting " + newChild + " with smaller file from "+ "trash directory. This message can be safely ignored.");
    }
 else     if (!child.renameTo(newChild)) {
      throw new IOException("Failed to rename " + child + " to "+ newChild);
    }
 else {
      ++filesRestored;
    }
  }
  FileUtil.fullyDelete(trashRoot);
  return filesRestored;
}
