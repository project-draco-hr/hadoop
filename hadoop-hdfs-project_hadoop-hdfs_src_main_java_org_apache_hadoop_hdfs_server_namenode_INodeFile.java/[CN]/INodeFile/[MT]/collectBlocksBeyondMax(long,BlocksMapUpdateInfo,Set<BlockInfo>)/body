{
  final BlockInfo[] oldBlocks=getBlocks();
  if (oldBlocks == null) {
    return 0;
  }
  int n=0;
  long size=0;
  for (; n < oldBlocks.length && max > size; n++) {
    size+=oldBlocks[n].getNumBytes();
  }
  if (n >= oldBlocks.length) {
    return size;
  }
  truncateBlocksTo(n);
  if (collectedBlocks != null) {
    for (; n < oldBlocks.length; n++) {
      final BlockInfo del=oldBlocks[n];
      if (toRetain == null || !toRetain.contains(del)) {
        collectedBlocks.addDeleteBlock(del);
      }
    }
  }
  return size;
}
