{
  long nsDelta=1;
  final long ssDeltaNoReplication;
  short replication;
  FileWithSnapshotFeature sf=getFileWithSnapshotFeature();
  if (sf != null) {
    FileDiffList fileDiffList=sf.getDiffs();
    int last=fileDiffList.getLastSnapshotId();
    if (lastSnapshotId == Snapshot.CURRENT_STATE_ID || last == Snapshot.CURRENT_STATE_ID) {
      ssDeltaNoReplication=storagespaceConsumedNoReplication();
      replication=getBlockReplication();
    }
 else     if (last < lastSnapshotId) {
      ssDeltaNoReplication=computeFileSize(true,false);
      replication=getFileReplication();
    }
 else {
      int sid=fileDiffList.getSnapshotById(lastSnapshotId);
      ssDeltaNoReplication=storagespaceConsumedNoReplication(sid);
      replication=getReplication(sid);
    }
  }
 else {
    ssDeltaNoReplication=storagespaceConsumedNoReplication();
    replication=getBlockReplication();
  }
  counts.addNameSpace(nsDelta);
  counts.addStorageSpace(ssDeltaNoReplication * replication);
  if (getStoragePolicyID() != BlockStoragePolicySuite.ID_UNSPECIFIED) {
    BlockStoragePolicy bsp=bsps.getPolicy(getStoragePolicyID());
    List<StorageType> storageTypes=bsp.chooseStorageTypes(replication);
    for (    StorageType t : storageTypes) {
      if (!t.supportTypeQuota()) {
        continue;
      }
      counts.addTypeSpace(t,ssDeltaNoReplication);
    }
  }
  return counts;
}
