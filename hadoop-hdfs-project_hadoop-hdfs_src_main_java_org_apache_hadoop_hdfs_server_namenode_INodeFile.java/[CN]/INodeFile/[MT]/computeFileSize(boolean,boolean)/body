{
  BlockInfo[] blockInfos=getBlocks();
  if (blockInfos == null || blockInfos.length == 0) {
    return 0;
  }
  final int last=blockInfos.length - 1;
  long size=blockInfos[last].getNumBytes();
  if (blockInfos[last] instanceof BlockInfoContiguousUnderConstruction) {
    if (!includesLastUcBlock) {
      size=0;
    }
 else     if (usePreferredBlockSize4LastUcBlock) {
      size=getPreferredBlockSize();
    }
  }
 else   if (blockInfos[last] instanceof BlockInfoStripedUnderConstruction) {
    if (!includesLastUcBlock) {
      size=0;
    }
 else     if (usePreferredBlockSize4LastUcBlock) {
      BlockInfoStripedUnderConstruction blockInfoStripedUC=(BlockInfoStripedUnderConstruction)blockInfos[last];
      size=getPreferredBlockSize() * blockInfoStripedUC.getTotalBlockNum();
    }
  }
  for (int i=0; i < last; i++) {
    size+=blockInfos[i].getNumBytes();
  }
  return size;
}
