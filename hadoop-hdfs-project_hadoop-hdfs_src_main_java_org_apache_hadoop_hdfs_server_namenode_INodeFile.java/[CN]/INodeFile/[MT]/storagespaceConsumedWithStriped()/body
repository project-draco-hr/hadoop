{
  QuotaCounts counts=new QuotaCounts.Builder().build();
  BlockInfo[] blockInfos=getBlocks();
  if (blockInfos == null || blockInfos.length == 0) {
    return counts;
  }
  long size;
  final int last=blockInfos.length - 1;
  if (blockInfos[last] instanceof BlockInfoStripedUnderConstruction) {
    BlockInfoStripedUnderConstruction blockInfoStripedUC=(BlockInfoStripedUnderConstruction)blockInfos[last];
    size=getPreferredBlockSize() * blockInfoStripedUC.getTotalBlockNum();
  }
 else {
    BlockInfoStriped blockInfoStriped=(BlockInfoStriped)blockInfos[last];
    size=blockInfoStriped.spaceConsumed();
  }
  for (int i=0; i < last; i++) {
    BlockInfoStriped blockInfoStriped=(BlockInfoStriped)blockInfos[i];
    size+=blockInfoStriped.spaceConsumed();
  }
  counts.addStorageSpace(size);
  return counts;
}
