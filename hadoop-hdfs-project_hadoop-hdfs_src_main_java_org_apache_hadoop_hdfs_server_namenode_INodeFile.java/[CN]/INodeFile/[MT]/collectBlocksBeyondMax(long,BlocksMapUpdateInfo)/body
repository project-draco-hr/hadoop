{
  final BlockInfo[] oldBlocks=getBlocks();
  if (oldBlocks == null)   return 0;
  int n=0;
  long size=0;
  for (; n < oldBlocks.length && max > size; n++) {
    size+=oldBlocks[n].getNumBytes();
  }
  if (n >= oldBlocks.length)   return size;
  final BlockInfo[] newBlocks;
  if (n == 0) {
    newBlocks=BlockInfo.EMPTY_ARRAY;
  }
 else {
    newBlocks=new BlockInfo[n];
    System.arraycopy(oldBlocks,0,newBlocks,0,n);
  }
  setBlocks(newBlocks);
  if (collectedBlocks != null) {
    for (; n < oldBlocks.length; n++) {
      collectedBlocks.addDeleteBlock(oldBlocks[n]);
    }
  }
  return size;
}
