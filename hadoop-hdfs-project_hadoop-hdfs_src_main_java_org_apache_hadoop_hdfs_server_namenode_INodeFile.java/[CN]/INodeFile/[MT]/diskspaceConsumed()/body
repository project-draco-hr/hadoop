{
  FileWithSnapshotFeature sf=getFileWithSnapshotFeature();
  if (sf == null) {
    return computeFileSize(true,true) * getBlockReplication();
  }
  long size=0;
  Set<Block> allBlocks=new HashSet<Block>(Arrays.asList(getBlocks()));
  List<FileDiff> diffs=sf.getDiffs().asList();
  for (  FileDiff diff : diffs) {
    BlockInfoContiguous[] diffBlocks=diff.getBlocks();
    if (diffBlocks != null) {
      allBlocks.addAll(Arrays.asList(diffBlocks));
    }
  }
  for (  Block block : allBlocks) {
    size+=block.getNumBytes();
  }
  BlockInfoContiguous lastBlock=getLastBlock();
  if (lastBlock != null && lastBlock instanceof BlockInfoContiguousUnderConstruction) {
    size+=getPreferredBlockSize() - lastBlock.getNumBytes();
  }
  return size * getBlockReplication();
}
