{
  ApplicationId applicationId=submissionContext.getApplicationId();
  RMApp application=null;
  try {
    String clientTokenStr=null;
    String user=UserGroupInformation.getCurrentUser().getShortUserName();
    if (UserGroupInformation.isSecurityEnabled()) {
      Token<ApplicationTokenIdentifier> clientToken=new Token<ApplicationTokenIdentifier>(new ApplicationTokenIdentifier(applicationId),this.clientToAMSecretManager);
      clientTokenStr=clientToken.encodeToUrlString();
      LOG.debug("Sending client token as " + clientTokenStr);
    }
    submissionContext.setQueue(submissionContext.getQueue() == null ? "default" : submissionContext.getQueue());
    submissionContext.setApplicationName(submissionContext.getApplicationName() == null ? "N/A" : submissionContext.getApplicationName());
    ApplicationStore appStore=rmContext.getApplicationsStore().createApplicationStore(submissionContext.getApplicationId(),submissionContext);
    application=new RMAppImpl(applicationId,rmContext,this.conf,submissionContext.getApplicationName(),user,submissionContext.getQueue(),submissionContext,clientTokenStr,appStore,rmContext.getAMLivelinessMonitor(),this.scheduler,this.masterService);
    if (rmContext.getRMApps().putIfAbsent(applicationId,application) != null) {
      LOG.info("Application with id " + applicationId + " is already present! Cannot add a duplicate!");
      application.handle(new RMAppRejectedEvent(applicationId,"Application with this id is already present! Cannot add a duplicate!"));
    }
 else {
      this.rmContext.getDispatcher().getEventHandler().handle(new RMAppEvent(applicationId,RMAppEventType.START));
    }
  }
 catch (  IOException ie) {
    LOG.info("RMAppManager submit application exception",ie);
    if (application != null) {
      this.rmContext.getDispatcher().getEventHandler().handle(new RMAppRejectedEvent(applicationId,ie.getMessage()));
    }
  }
}
