{
  DataStatistics stats=null;
  InputStream trace=null;
  int exitCode=0;
  try {
    Path scratchDir=new Path(ioPath,conf.get(GRIDMIX_OUT_DIR,"gridmix"));
    Runtime.getRuntime().addShutdownHook(sdh);
    CountDownLatch startFlag=new CountDownLatch(1);
    try {
      startThreads(conf,traceIn,ioPath,scratchDir,startFlag,userResolver);
      Path inputDir=getGridmixInputDataPath(ioPath);
      exitCode=writeInputData(genbytes,inputDir);
      if (exitCode != 0) {
        return exitCode;
      }
      stats=GenerateData.publishDataStatistics(inputDir,genbytes,conf);
      submitter.refreshFilePool();
      boolean shouldGenerate=(genbytes > 0);
      exitCode=setupEmulation(conf,traceIn,scratchDir,ioPath,shouldGenerate);
      if (exitCode != 0) {
        return exitCode;
      }
      summarizer.start(conf);
      factory.start();
      statistics.start();
    }
 catch (    Throwable e) {
      LOG.error("Startup failed. " + e.toString() + "\n");
      if (LOG.isDebugEnabled()) {
        e.printStackTrace();
      }
      if (factory != null)       factory.abort();
      exitCode=STARTUP_FAILED_ERROR;
    }
 finally {
      startFlag.countDown();
    }
    if (factory != null) {
      factory.join(Long.MAX_VALUE);
      final Throwable badTraceException=factory.error();
      if (null != badTraceException) {
        LOG.error("Error in trace",badTraceException);
        throw new IOException("Error in trace",badTraceException);
      }
      submitter.shutdown();
      submitter.join(Long.MAX_VALUE);
      monitor.shutdown();
      monitor.join(Long.MAX_VALUE);
      statistics.shutdown();
      statistics.join(Long.MAX_VALUE);
    }
  }
  finally {
    if (factory != null) {
      summarizer.finalize(factory,traceIn,genbytes,userResolver,stats,conf);
    }
    IOUtils.cleanup(LOG,trace);
  }
  return exitCode;
}
