{
  MiniYARNCluster cluster=new MiniYARNCluster("testAMRMProxyE2E",1,1,1);
  YarnClient rmClient=null;
  ApplicationMasterProtocol client;
  try {
    Configuration conf=new YarnConfiguration();
    conf.setBoolean(YarnConfiguration.AMRM_PROXY_ENABLED,true);
    cluster.init(conf);
    cluster.start();
    final Configuration yarnConf=cluster.getConfig();
    yarnConf.set(YarnConfiguration.RM_SCHEDULER_ADDRESS,YarnConfiguration.DEFAULT_AMRM_PROXY_ADDRESS);
    rmClient=YarnClient.createYarnClient();
    rmClient.init(yarnConf);
    rmClient.start();
    ApplicationAttemptId appAttmptId=createApp(rmClient,cluster,conf);
    ApplicationId appId=appAttmptId.getApplicationId();
    client=createAMRMProtocol(rmClient,appId,cluster,yarnConf);
    LOG.info("testAMRMProxyE2E - Register Application Master");
    RegisterApplicationMasterResponse responseRegister=client.registerApplicationMaster(RegisterApplicationMasterRequest.newInstance(NetUtils.getHostname(),1024,""));
    Assert.assertNotNull(responseRegister);
    Assert.assertNotNull(responseRegister.getQueue());
    Assert.assertNotNull(responseRegister.getApplicationACLs());
    Assert.assertNotNull(responseRegister.getClientToAMTokenMasterKey());
    Assert.assertNotNull(responseRegister.getContainersFromPreviousAttempts());
    Assert.assertNotNull(responseRegister.getSchedulerResourceTypes());
    Assert.assertNotNull(responseRegister.getMaximumResourceCapability());
    RMApp rmApp=cluster.getResourceManager().getRMContext().getRMApps().get(appId);
    Assert.assertEquals(RMAppState.RUNNING,rmApp.getState());
    LOG.info("testAMRMProxyE2E - Allocate Resources Application Master");
    AllocateRequest request=createAllocateRequest(rmClient.getNodeReports(NodeState.RUNNING));
    AllocateResponse allocResponse=client.allocate(request);
    Assert.assertNotNull(allocResponse);
    Assert.assertEquals(0,allocResponse.getAllocatedContainers().size());
    request.setAskList(new ArrayList<ResourceRequest>());
    request.setResponseId(request.getResponseId() + 1);
    Thread.sleep(1000);
    allocResponse=client.allocate(request);
    Assert.assertNotNull(allocResponse);
    Assert.assertEquals(2,allocResponse.getAllocatedContainers().size());
    LOG.info("testAMRMPRoxy - Finish Application Master");
    FinishApplicationMasterResponse responseFinish=client.finishApplicationMaster(FinishApplicationMasterRequest.newInstance(FinalApplicationStatus.SUCCEEDED,"success",null));
    Assert.assertNotNull(responseFinish);
    Thread.sleep(500);
    Assert.assertNotEquals(RMAppState.FINISHED,rmApp.getState());
  }
  finally {
    if (rmClient != null) {
      rmClient.stop();
    }
    cluster.stop();
  }
}
