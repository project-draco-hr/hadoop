{
  MiniYARNCluster cluster=new MiniYARNCluster("testE2ETokenSwap",1,1,1);
  YarnClient rmClient=null;
  ApplicationMasterProtocol client;
  try {
    Configuration conf=new YarnConfiguration();
    conf.setBoolean(YarnConfiguration.AMRM_PROXY_ENABLED,true);
    cluster.init(conf);
    cluster.start();
    final Configuration yarnConf=cluster.getConfig();
    rmClient=YarnClient.createYarnClient();
    rmClient.init(yarnConf);
    rmClient.start();
    ApplicationAttemptId appAttmptId=createApp(rmClient,cluster,conf);
    ApplicationId appId=appAttmptId.getApplicationId();
    client=createAMRMProtocol(rmClient,appId,cluster,yarnConf);
    try {
      client.registerApplicationMaster(RegisterApplicationMasterRequest.newInstance(NetUtils.getHostname(),1024,""));
      Assert.fail();
    }
 catch (    IOException e) {
      Assert.assertTrue(e.getMessage().startsWith("Invalid AMRMToken from appattempt_"));
    }
  }
  finally {
    if (rmClient != null) {
      rmClient.stop();
    }
    cluster.stop();
  }
}
