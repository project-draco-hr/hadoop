{
  Preconditions.checkState(state == State.WRITING);
  if (buf.remaining() < size) {
    int newCapacity=buf.capacity() * 2;
    int newRemaining=buf.capacity() + buf.remaining();
    while (newRemaining < size) {
      newRemaining+=newCapacity;
      newCapacity*=2;
    }
    ByteBuffer newbuf=ByteBuffer.allocate(newCapacity);
    buf.flip();
    newbuf.put(buf);
    buf=newbuf;
  }
}
