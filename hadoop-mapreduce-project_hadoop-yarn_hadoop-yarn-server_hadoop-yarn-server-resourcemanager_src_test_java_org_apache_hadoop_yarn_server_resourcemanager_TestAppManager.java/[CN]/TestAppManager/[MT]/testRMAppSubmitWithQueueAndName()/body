{
  long now=System.currentTimeMillis();
  RMContext rmContext=mockRMContext(1,now - 10);
  ResourceScheduler scheduler=new CapacityScheduler();
  ApplicationMasterService masterService=new ApplicationMasterService(rmContext,new ApplicationTokenSecretManager(),scheduler);
  Configuration conf=new Configuration();
  TestRMAppManager appMonitor=new TestRMAppManager(rmContext,new ClientToAMSecretManager(),scheduler,masterService,conf);
  ApplicationId appID=MockApps.newAppID(10);
  RecordFactory recordFactory=RecordFactoryProvider.getRecordFactory(null);
  ApplicationSubmissionContext context=recordFactory.newRecordInstance(ApplicationSubmissionContext.class);
  context.setApplicationId(appID);
  context.setApplicationName("testApp1");
  context.setQueue("testQueue");
  setupDispatcher(rmContext,conf);
  appMonitor.submitApplication(context);
  RMApp app=rmContext.getRMApps().get(appID);
  Assert.assertNotNull("app is null",app);
  Assert.assertEquals("app id doesn't match",appID,app.getApplicationId());
  Assert.assertEquals("app name doesn't match","testApp1",app.getName());
  Assert.assertEquals("app queue doesn't match","testQueue",app.getQueue());
  Assert.assertEquals("app state doesn't match",RMAppState.NEW,app.getState());
  Assert.assertNotNull("app store is null",app.getApplicationStore());
  int timeoutSecs=0;
  while ((getAppEventType() == RMAppEventType.KILL) && timeoutSecs++ < 20) {
    Thread.sleep(1000);
  }
  Assert.assertEquals("app event type sent is wrong",RMAppEventType.START,getAppEventType());
  setAppEventType(RMAppEventType.KILL);
  ((Service)rmContext.getDispatcher()).stop();
}
