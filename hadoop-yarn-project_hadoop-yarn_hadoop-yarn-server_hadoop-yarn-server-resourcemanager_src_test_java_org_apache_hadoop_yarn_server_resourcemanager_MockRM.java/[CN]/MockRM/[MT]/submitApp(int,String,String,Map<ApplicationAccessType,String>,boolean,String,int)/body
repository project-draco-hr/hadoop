{
  ClientRMProtocol client=getClientRMService();
  GetNewApplicationResponse resp=client.getNewApplication(Records.newRecord(GetNewApplicationRequest.class));
  ApplicationId appId=resp.getApplicationId();
  SubmitApplicationRequest req=Records.newRecord(SubmitApplicationRequest.class);
  ApplicationSubmissionContext sub=Records.newRecord(ApplicationSubmissionContext.class);
  sub.setApplicationId(appId);
  sub.setApplicationName(name);
  sub.setUser(user);
  sub.setMaxAppAttempts(maxAppAttempts);
  if (unmanaged) {
    sub.setUnmanagedAM(true);
  }
  if (queue != null) {
    sub.setQueue(queue);
  }
  ContainerLaunchContext clc=Records.newRecord(ContainerLaunchContext.class);
  Resource capability=Records.newRecord(Resource.class);
  capability.setMemory(masterMemory);
  clc.setResource(capability);
  clc.setApplicationACLs(acls);
  sub.setAMContainerSpec(clc);
  req.setApplicationSubmissionContext(sub);
  UserGroupInformation fakeUser=UserGroupInformation.createUserForTesting(user,new String[]{"someGroup"});
  PrivilegedAction<SubmitApplicationResponse> action=new PrivilegedAction<SubmitApplicationResponse>(){
    ClientRMProtocol client;
    SubmitApplicationRequest req;
    @Override public SubmitApplicationResponse run(){
      try {
        return client.submitApplication(req);
      }
 catch (      YarnRemoteException e) {
        e.printStackTrace();
      }
      return null;
    }
    PrivilegedAction<SubmitApplicationResponse> setClientReq(    ClientRMProtocol client,    SubmitApplicationRequest req){
      this.client=client;
      this.req=req;
      return this;
    }
  }
.setClientReq(client,req);
  fakeUser.doAs(action);
  waitForState(appId,RMAppState.ACCEPTED);
  return getRMContext().getRMApps().get(appId);
}
