{
  Configuration conf=mock(Configuration.class);
  Token<?> token1=mock(Token.class);
  Token<?> token2=mock(Token.class);
  long renewCycle=1000;
  DelegationTokenRenewer.renewCycle=renewCycle;
  WebHdfsFileSystem fs=spy(new WebHdfsFileSystem());
  doReturn(conf).when(fs).getConf();
  doReturn(token1).doReturn(token2).when(fs).getDelegationToken(null);
  doThrow(new IOException("renew failed")).when(token1).renew(conf);
  doThrow(new IOException("get failed")).when(fs).addDelegationTokens(null,null);
  Token<?> token=fs.getDelegationToken();
  RenewAction<?> action=fs.action;
  assertSame(token1,token);
  assertTrue(action.isValid());
  token=fs.getDelegationToken();
  assertSame(token1,token);
  assertSame(action,fs.action);
  assertTrue(fs.action.isValid());
  Thread.sleep(renewCycle);
  assertSame(action,fs.action);
  assertFalse(fs.action.isValid());
  token=fs.getDelegationToken();
  assertSame(token2,token);
  assertNotSame(action,fs.action);
  assertTrue(fs.action.isValid());
  action=fs.action;
  token=fs.getDelegationToken();
  assertSame(token2,token);
  assertSame(action,fs.action);
  assertTrue(fs.action.isValid());
}
