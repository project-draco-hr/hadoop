{
  try {
    while (!Thread.currentThread().isInterrupted()) {
      try {
        Future<Path> completed=queue.take();
        LocalizerResourceRequestEvent assoc=pending.remove(completed);
        try {
          Path local=completed.get();
          if (null == assoc) {
            LOG.error("Localized unkonwn resource to " + completed);
            return;
          }
          LocalResourceRequest key=assoc.getResource().getRequest();
          assoc.getResource().handle(new ResourceLocalizedEvent(key,local,FileUtil.getDU(new File(local.toUri()))));
          publicRsrc.localizationCompleted(key,true);
synchronized (attempts) {
            attempts.remove(key);
          }
        }
 catch (        ExecutionException e) {
          LOG.info("Failed to download rsrc " + assoc.getResource(),e.getCause());
          LocalResourceRequest req=assoc.getResource().getRequest();
          dispatcher.getEventHandler().handle(new ContainerResourceFailedEvent(assoc.getContext().getContainerId(),req,e.getCause()));
          publicRsrc.localizationCompleted(req,false);
          List<LocalizerResourceRequestEvent> reqs;
synchronized (attempts) {
            reqs=attempts.get(req);
            if (null == reqs) {
              LOG.error("Missing pending list for " + req);
              return;
            }
            attempts.remove(req);
          }
          for (          LocalizerResourceRequestEvent reqEvent : reqs) {
            dispatcher.getEventHandler().handle(new ContainerResourceFailedEvent(reqEvent.getContext().getContainerId(),reqEvent.getResource().getRequest(),e.getCause()));
          }
        }
catch (        CancellationException e) {
        }
      }
 catch (      InterruptedException e) {
        return;
      }
    }
  }
 catch (  Throwable t) {
    LOG.fatal("Error: Shutting down",t);
  }
 finally {
    LOG.info("Public cache exiting");
    threadPool.shutdownNow();
  }
}
