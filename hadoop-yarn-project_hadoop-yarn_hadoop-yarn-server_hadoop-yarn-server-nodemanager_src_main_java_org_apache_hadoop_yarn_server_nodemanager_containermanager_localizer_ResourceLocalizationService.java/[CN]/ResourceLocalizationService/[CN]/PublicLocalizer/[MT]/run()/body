{
  try {
    while (!Thread.currentThread().isInterrupted()) {
      try {
        Future<Path> completed=queue.take();
        LocalizerResourceRequestEvent assoc=pending.remove(completed);
        try {
          Path local=completed.get();
          if (null == assoc) {
            LOG.error("Localized unknown resource to " + completed);
            return;
          }
          LocalResourceRequest key=assoc.getResource().getRequest();
          publicRsrc.handle(new ResourceLocalizedEvent(key,local,FileUtil.getDU(new File(local.toUri()))));
          assoc.getResource().unlock();
        }
 catch (        ExecutionException e) {
          LOG.info("Failed to download resource " + assoc.getResource(),e.getCause());
          LocalResourceRequest req=assoc.getResource().getRequest();
          publicRsrc.handle(new ResourceFailedLocalizationEvent(req,e.getMessage()));
          assoc.getResource().unlock();
        }
catch (        CancellationException e) {
        }
      }
 catch (      InterruptedException e) {
        return;
      }
    }
  }
 catch (  Throwable t) {
    LOG.fatal("Error: Shutting down",t);
  }
 finally {
    LOG.info("Public cache exiting");
    threadPool.shutdownNow();
  }
}
