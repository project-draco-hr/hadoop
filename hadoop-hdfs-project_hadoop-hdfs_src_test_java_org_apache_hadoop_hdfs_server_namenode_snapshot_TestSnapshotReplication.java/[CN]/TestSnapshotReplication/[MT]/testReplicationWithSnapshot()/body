{
  short fileRep=1;
  DFSTestUtil.createFile(hdfs,file1,BLOCKSIZE,fileRep,seed);
  Map<Path,Short> snapshotRepMap=new HashMap<Path,Short>();
  for (; fileRep < NUMDATANODE; ) {
    Path snapshotRoot=SnapshotTestHelper.createSnapshot(hdfs,sub1,"s" + fileRep);
    Path snapshot=new Path(snapshotRoot,file1.getName());
    INode inode=fsdir.getINode(snapshot.toString());
    assertTrue(inode instanceof INodeFileWithLink);
    assertEquals(fileRep,((INodeFileWithLink)inode).getFileReplication());
    snapshotRepMap.put(snapshot,fileRep);
    hdfs.setReplication(file1,++fileRep);
    checkFileReplication(file1,fileRep,fileRep);
    checkSnapshotFileReplication(file1,snapshotRepMap,fileRep);
  }
  hdfs.setReplication(file1,REPLICATION);
  checkFileReplication(file1,REPLICATION,(short)(NUMDATANODE - 1));
  checkSnapshotFileReplication(file1,snapshotRepMap,(short)(NUMDATANODE - 1));
}
