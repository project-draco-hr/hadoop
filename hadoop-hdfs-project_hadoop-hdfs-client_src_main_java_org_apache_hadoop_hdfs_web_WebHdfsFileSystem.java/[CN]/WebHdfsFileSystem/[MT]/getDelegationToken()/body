{
  if (canRefreshDelegationToken && delegationToken == null) {
    Token<?> token=tokenSelector.selectToken(new Text(getCanonicalServiceName()),ugi.getTokens());
    if (token != null) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Using UGI token: " + token);
      }
      canRefreshDelegationToken=false;
    }
 else {
      token=getDelegationToken(null);
      if (token != null) {
        if (LOG.isDebugEnabled()) {
          LOG.debug("Fetched new token: " + token);
        }
      }
 else {
        canRefreshDelegationToken=false;
      }
    }
    setDelegationToken(token);
  }
  return delegationToken;
}
