{
  StorageDirectory sd=new StorageDirectory(dataDir,null,false);
  try {
    StorageState curState=sd.analyzeStorage(startOpt,this);
switch (curState) {
case NORMAL:
      break;
case NON_EXISTENT:
    LOG.info("Storage directory " + dataDir + " does not exist");
  throw new IOException("Storage directory " + dataDir + " does not exist");
case NOT_FORMATTED:
LOG.info("Storage directory " + dataDir + " is not formatted for "+ nsInfo.getBlockPoolID());
LOG.info("Formatting ...");
format(sd,nsInfo,datanode.getDatanodeUuid());
break;
default :
sd.doRecover(curState);
}
doTransition(datanode,sd,nsInfo,startOpt);
setServiceLayoutVersion(getServiceLayoutVersion());
writeProperties(sd);
return sd;
}
 catch (IOException ioe) {
sd.unlock();
throw ioe;
}
}
