{
  task.failedAttempts++;
  TaskTAttemptEvent castEvent=(TaskTAttemptEvent)event;
  if (castEvent.getTaskAttemptID().equals(task.commitAttempt)) {
    task.commitAttempt=null;
  }
  TaskAttempt attempt=task.attempts.get(castEvent.getTaskAttemptID());
  if (attempt.getAssignedContainerMgrAddress() != null) {
    task.eventHandler.handle(new ContainerFailedEvent(attempt.getID(),attempt.getAssignedContainerMgrAddress()));
  }
  if (task.failedAttempts < task.maxAttempts) {
    task.handleTaskAttemptCompletion(((TaskTAttemptEvent)event).getTaskAttemptID(),TaskAttemptCompletionEventStatus.FAILED);
    if (--task.numberUncompletedAttempts == 0 && task.successfulAttempt == null) {
      task.addAndScheduleAttempt();
    }
  }
 else {
    task.handleTaskAttemptCompletion(((TaskTAttemptEvent)event).getTaskAttemptID(),TaskAttemptCompletionEventStatus.TIPFAILED);
    TaskTAttemptEvent ev=(TaskTAttemptEvent)event;
    TaskAttemptId taId=ev.getTaskAttemptID();
    if (task.historyTaskStartGenerated) {
      TaskFailedEvent taskFailedEvent=createTaskFailedEvent(task,attempt.getDiagnostics(),TaskState.FAILED,taId);
      task.eventHandler.handle(new JobHistoryEvent(task.taskId.getJobId(),taskFailedEvent));
    }
 else {
      LOG.debug("Not generating HistoryFinish event since start event not" + " generated for task: " + task.getID());
    }
    task.eventHandler.handle(new JobTaskEvent(task.taskId,TaskState.FAILED));
    return task.finished(TaskState.FAILED);
  }
  return getDefaultState(task);
}
