{
  TaskTAttemptEvent castEvent=(TaskTAttemptEvent)event;
  TaskAttemptId taskAttemptId=castEvent.getTaskAttemptID();
  task.failedAttempts.add(taskAttemptId);
  if (taskAttemptId.equals(task.commitAttempt)) {
    task.commitAttempt=null;
  }
  TaskAttempt attempt=task.attempts.get(taskAttemptId);
  if (attempt.getAssignedContainerMgrAddress() != null) {
    task.eventHandler.handle(new ContainerFailedEvent(attempt.getID(),attempt.getAssignedContainerMgrAddress()));
  }
  task.finishedAttempts.add(taskAttemptId);
  if (task.failedAttempts.size() < task.maxAttempts) {
    task.handleTaskAttemptCompletion(taskAttemptId,TaskAttemptCompletionEventStatus.FAILED);
    task.inProgressAttempts.remove(taskAttemptId);
    if (task.successfulAttempt == null) {
      boolean shouldAddNewAttempt=true;
      if (task.inProgressAttempts.size() > 0) {
        for (        TaskAttemptId attemptId : task.inProgressAttempts) {
          if (((TaskAttemptImpl)task.getAttempt(attemptId)).isContainerAssigned()) {
            shouldAddNewAttempt=false;
            break;
          }
        }
      }
      if (shouldAddNewAttempt) {
        task.addAndScheduleAttempt(Avataar.VIRGIN);
      }
    }
  }
 else {
    task.handleTaskAttemptCompletion(taskAttemptId,TaskAttemptCompletionEventStatus.TIPFAILED);
    for (    TaskAttempt taskAttempt : task.attempts.values()) {
      task.killUnfinishedAttempt(taskAttempt,"Task has failed. Killing attempt!");
    }
    task.inProgressAttempts.clear();
    if (task.historyTaskStartGenerated) {
      TaskFailedEvent taskFailedEvent=createTaskFailedEvent(task,attempt.getDiagnostics(),TaskStateInternal.FAILED,taskAttemptId);
      task.eventHandler.handle(new JobHistoryEvent(task.taskId.getJobId(),taskFailedEvent));
    }
 else {
      LOG.debug("Not generating HistoryFinish event since start event not" + " generated for task: " + task.getID());
    }
    task.eventHandler.handle(new JobTaskEvent(task.taskId,TaskState.FAILED));
    return task.finished(TaskStateInternal.FAILED);
  }
  return getDefaultState(task);
}
