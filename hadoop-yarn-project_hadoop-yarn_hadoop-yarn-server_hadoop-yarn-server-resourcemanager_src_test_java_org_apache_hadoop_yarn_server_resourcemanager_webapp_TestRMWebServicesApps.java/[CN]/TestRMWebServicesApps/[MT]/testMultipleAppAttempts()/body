{
  rm.start();
  MockNM amNodeManager=rm.registerNode("amNM:1234",2048);
  RMApp app1=rm.submitApp(1024,"testwordcount","user1");
  amNodeManager.nodeHeartbeat(true);
  int maxAppAttempts=rm.getConfig().getInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,YarnConfiguration.DEFAULT_RM_AM_MAX_ATTEMPTS);
  int retriesLeft=maxAppAttempts;
  while (--retriesLeft > 0) {
    RMAppEvent event=new RMAppFailedAttemptEvent(app1.getApplicationId(),RMAppEventType.ATTEMPT_FAILED,"");
    app1.handle(event);
    rm.waitForState(app1.getApplicationId(),RMAppState.ACCEPTED);
    amNodeManager.nodeHeartbeat(true);
  }
  assertEquals("incorrect number of attempts",maxAppAttempts,app1.getAppAttempts().values().size());
  testAppAttemptsHelper(app1.getApplicationId().toString(),app1,MediaType.APPLICATION_JSON);
  rm.stop();
}
