{
  while (!done && (numCompletedContainers.get() != numTotalContainers)) {
    try {
      Thread.sleep(200);
    }
 catch (    InterruptedException ex) {
    }
  }
  if (timelineClient != null) {
    if (newTimelineService) {
      publishApplicationAttemptEventOnNewTimelineService(timelineClient,appAttemptID.toString(),DSEvent.DS_APP_ATTEMPT_END,domainId,appSubmitterUgi);
    }
 else {
      publishApplicationAttemptEvent(timelineClient,appAttemptID.toString(),DSEvent.DS_APP_ATTEMPT_END,domainId,appSubmitterUgi);
    }
  }
  for (  Thread launchThread : launchThreads) {
    try {
      launchThread.join(10000);
    }
 catch (    InterruptedException e) {
      LOG.info("Exception thrown in thread join: " + e.getMessage());
      e.printStackTrace();
    }
  }
  LOG.info("Application completed. Stopping running containers");
  nmClientAsync.stop();
  LOG.info("Application completed. Signalling finish to RM");
  FinalApplicationStatus appStatus;
  String appMessage=null;
  boolean success=true;
  if (numCompletedContainers.get() - numFailedContainers.get() >= numTotalContainers) {
    appStatus=FinalApplicationStatus.SUCCEEDED;
  }
 else {
    appStatus=FinalApplicationStatus.FAILED;
    appMessage="Diagnostics." + ", total=" + numTotalContainers + ", completed="+ numCompletedContainers.get()+ ", allocated="+ numAllocatedContainers.get()+ ", failed="+ numFailedContainers.get();
    LOG.info(appMessage);
    success=false;
  }
  try {
    amRMClient.unregisterApplicationMaster(appStatus,appMessage,null);
  }
 catch (  YarnException ex) {
    LOG.error("Failed to unregister application",ex);
  }
catch (  IOException e) {
    LOG.error("Failed to unregister application",e);
  }
  amRMClient.stop();
  if (timelineClient != null) {
    timelineClient.stop();
  }
  return success;
}
