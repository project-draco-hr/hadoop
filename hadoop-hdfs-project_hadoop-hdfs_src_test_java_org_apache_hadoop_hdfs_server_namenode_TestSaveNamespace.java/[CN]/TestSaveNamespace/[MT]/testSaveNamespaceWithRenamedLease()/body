{
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(new Configuration()).numDataNodes(1).build();
  cluster.waitActive();
  DistributedFileSystem fs=cluster.getFileSystem();
  OutputStream out=null;
  try {
    fs.mkdirs(new Path("/test-target"));
    out=fs.create(new Path("/test-source/foo"));
    fs.rename(new Path("/test-source/"),new Path("/test-target/"));
    fs.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
    cluster.getNameNodeRpc().saveNamespace();
    fs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
  }
  finally {
    IOUtils.cleanup(LOG,out,fs);
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
