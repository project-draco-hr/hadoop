{
  Configuration conf=getConf();
  NameNode.initMetrics(conf,NamenodeRole.NAMENODE);
  DFSTestUtil.formatNameNode(conf);
  FSNamesystem fsn=FSNamesystem.loadFromDisk(conf);
  FSImage originalImage=fsn.getFSImage();
  NNStorage storage=originalImage.getStorage();
  NNStorage spyStorage=spy(storage);
  originalImage.storage=spyStorage;
  FSImage spyImage=spy(originalImage);
  Whitebox.setInternalState(fsn,"fsImage",spyImage);
  boolean shouldFail=false;
switch (fault) {
case SAVE_SECOND_FSIMAGE_RTE:
    doAnswer(new FaultySaveImage(true)).when(spyImage).saveFSImage(anyObject(),anyObject(),anyObject());
  shouldFail=false;
break;
case SAVE_SECOND_FSIMAGE_IOE:
doAnswer(new FaultySaveImage(false)).when(spyImage).saveFSImage(anyObject(),anyObject(),anyObject());
shouldFail=false;
break;
case SAVE_ALL_FSIMAGES:
doThrow(new RuntimeException("Injected")).when(spyImage).saveFSImage(anyObject(),anyObject(),anyObject());
shouldFail=true;
break;
case WRITE_STORAGE_ALL:
doAnswer(new FaultyWriteProperties(Fault.WRITE_STORAGE_ALL)).when(spyStorage).writeProperties(anyObject());
shouldFail=true;
break;
case WRITE_STORAGE_ONE:
doAnswer(new FaultyWriteProperties(Fault.WRITE_STORAGE_ONE)).when(spyStorage).writeProperties(anyObject());
shouldFail=false;
break;
default :
fail("Unknown fail type");
break;
}
try {
doAnEdit(fsn,1);
fsn.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
try {
fsn.saveNamespace(0,0);
if (shouldFail) {
fail("Did not fail!");
}
}
 catch (Exception e) {
if (!shouldFail) {
throw e;
}
 else {
LOG.info("Test caught expected exception",e);
}
}
fsn.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
doAnEdit(fsn,2);
originalImage.close();
fsn.close();
fsn=null;
fsn=FSNamesystem.loadFromDisk(conf);
checkEditExists(fsn,1);
checkEditExists(fsn,2);
}
  finally {
if (fsn != null) {
fsn.close();
}
}
}
