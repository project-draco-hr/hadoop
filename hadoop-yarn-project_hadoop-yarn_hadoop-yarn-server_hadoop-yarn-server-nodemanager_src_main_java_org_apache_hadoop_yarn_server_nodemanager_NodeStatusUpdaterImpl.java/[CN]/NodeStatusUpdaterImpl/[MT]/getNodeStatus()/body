{
  NodeStatus nodeStatus=recordFactory.newRecordInstance(NodeStatus.class);
  nodeStatus.setNodeId(this.nodeId);
  List<ContainerStatus> containersStatuses=new ArrayList<ContainerStatus>();
  if (previousHeartBeatSucceeded) {
    previousContainersStatuses.clear();
  }
 else {
    containersStatuses.addAll(previousContainersStatuses);
  }
  int numActiveContainers=0;
  for (Iterator<Entry<ContainerId,Container>> i=this.context.getContainers().entrySet().iterator(); i.hasNext(); ) {
    Entry<ContainerId,Container> e=i.next();
    ContainerId containerId=e.getKey();
    Container container=e.getValue();
    org.apache.hadoop.yarn.api.records.ContainerStatus containerStatus=container.cloneAndGetContainerStatus();
    containersStatuses.add(containerStatus);
    ++numActiveContainers;
    LOG.info("Sending out status for container: " + containerStatus);
    if (containerStatus.getState() == ContainerState.COMPLETE) {
      previousContainersStatuses.add(containerStatus);
      i.remove();
      LOG.info("Removed completed container " + containerId);
    }
  }
  nodeStatus.setContainersStatuses(containersStatuses);
  LOG.debug(this.nodeId + " sending out status for " + numActiveContainers+ " containers");
  NodeHealthStatus nodeHealthStatus=this.context.getNodeHealthStatus();
  nodeHealthStatus.setHealthReport(healthChecker.getHealthReport());
  nodeHealthStatus.setIsNodeHealthy(healthChecker.isHealthy());
  nodeHealthStatus.setLastHealthReportTime(healthChecker.getLastHealthReportTime());
  if (LOG.isDebugEnabled()) {
    LOG.debug("Node's health-status : " + nodeHealthStatus.getIsNodeHealthy() + ", "+ nodeHealthStatus.getHealthReport());
  }
  nodeStatus.setNodeHealthStatus(nodeHealthStatus);
  List<ApplicationId> keepAliveAppIds=createKeepAliveApplicationList();
  nodeStatus.setKeepAliveApplications(keepAliveAppIds);
  return nodeStatus;
}
