{
  Configuration conf=getConfig();
  rmConnectWaitMS=conf.getInt(YarnConfiguration.RESOURCEMANAGER_CONNECT_WAIT_SECS,YarnConfiguration.DEFAULT_RESOURCEMANAGER_CONNECT_WAIT_SECS) * 1000;
  rmConnectionRetryIntervalMS=conf.getLong(YarnConfiguration.RESOURCEMANAGER_CONNECT_RETRY_INTERVAL_SECS,YarnConfiguration.DEFAULT_RESOURCEMANAGER_CONNECT_RETRY_INTERVAL_SECS) * 1000;
  if (rmConnectionRetryIntervalMS < 0) {
    throw new YarnRuntimeException("Invalid Configuration. " + YarnConfiguration.RESOURCEMANAGER_CONNECT_RETRY_INTERVAL_SECS + " should not be negative.");
  }
  waitForEver=(rmConnectWaitMS == -1000);
  if (!waitForEver) {
    if (rmConnectWaitMS < 0) {
      throw new YarnRuntimeException("Invalid Configuration. " + YarnConfiguration.RESOURCEMANAGER_CONNECT_WAIT_SECS + " can be -1, but can not be other negative numbers");
    }
    if (rmConnectWaitMS < rmConnectionRetryIntervalMS) {
      LOG.warn(YarnConfiguration.RESOURCEMANAGER_CONNECT_WAIT_SECS + " is smaller than " + YarnConfiguration.RESOURCEMANAGER_CONNECT_RETRY_INTERVAL_SECS+ ". Only try connect once.");
      rmConnectWaitMS=0;
    }
  }
  int rmRetryCount=0;
  long waitStartTime=System.currentTimeMillis();
  RegisterNodeManagerRequest request=recordFactory.newRecordInstance(RegisterNodeManagerRequest.class);
  request.setHttpPort(this.httpPort);
  request.setResource(this.totalResource);
  request.setNodeId(this.nodeId);
  RegisterNodeManagerResponse regNMResponse;
  while (true) {
    try {
      rmRetryCount++;
      LOG.info("Connecting to ResourceManager at " + this.rmAddress + ". current no. of attempts is "+ rmRetryCount);
      this.resourceTracker=getRMClient();
      regNMResponse=this.resourceTracker.registerNodeManager(request);
      this.rmIdentifier=regNMResponse.getRMIdentifier();
      break;
    }
 catch (    Throwable e) {
      LOG.warn("Trying to connect to ResourceManager, " + "current no. of failed attempts is " + rmRetryCount);
      if (System.currentTimeMillis() - waitStartTime < rmConnectWaitMS || waitForEver) {
        try {
          LOG.info("Sleeping for " + rmConnectionRetryIntervalMS / 1000 + " seconds before next connection retry to RM");
          Thread.sleep(rmConnectionRetryIntervalMS);
        }
 catch (        InterruptedException ex) {
        }
      }
 else {
        String errorMessage="Failed to Connect to RM, " + "no. of failed attempts is " + rmRetryCount;
        LOG.error(errorMessage,e);
        throw new YarnRuntimeException(errorMessage,e);
      }
    }
  }
  if (NodeAction.SHUTDOWN.equals(regNMResponse.getNodeAction())) {
    String message="Message from ResourceManager: " + regNMResponse.getDiagnosticsMessage();
    throw new YarnRuntimeException("Recieved SHUTDOWN signal from Resourcemanager ,Registration of NodeManager failed, " + message);
  }
  MasterKey masterKey=regNMResponse.getMasterKey();
  if (masterKey != null) {
    this.context.getContainerTokenSecretManager().setMasterKey(masterKey);
  }
  LOG.info("Registered with ResourceManager as " + this.nodeId + " with total resource of "+ this.totalResource);
  LOG.info("Notifying ContainerManager to unblock new container-requests");
  ((ContainerManagerImpl)this.context.getContainerManager()).setBlockNewContainerRequests(false);
}
