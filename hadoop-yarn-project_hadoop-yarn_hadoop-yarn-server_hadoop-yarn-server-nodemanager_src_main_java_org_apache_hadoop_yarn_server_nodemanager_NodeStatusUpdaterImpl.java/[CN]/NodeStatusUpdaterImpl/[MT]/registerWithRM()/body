{
  List<NMContainerStatus> containerReports=getNMContainerStatuses();
  Set<NodeLabel> nodeLabels=null;
  if (hasNodeLabelsProvider) {
    nodeLabels=nodeLabelsProvider.getNodeLabels();
    nodeLabels=(null == nodeLabels) ? CommonNodeLabelsManager.EMPTY_NODELABEL_SET : nodeLabels;
  }
  RegisterNodeManagerRequest request=RegisterNodeManagerRequest.newInstance(nodeId,httpPort,totalResource,nodeManagerVersionId,containerReports,getRunningApplications(),nodeLabels);
  if (containerReports != null) {
    LOG.info("Registering with RM using containers :" + containerReports);
  }
  RegisterNodeManagerResponse regNMResponse=resourceTracker.registerNodeManager(request);
  this.rmIdentifier=regNMResponse.getRMIdentifier();
  if (NodeAction.SHUTDOWN.equals(regNMResponse.getNodeAction())) {
    String message="Message from ResourceManager: " + regNMResponse.getDiagnosticsMessage();
    throw new YarnRuntimeException("Recieved SHUTDOWN signal from Resourcemanager, Registration of NodeManager failed, " + message);
  }
  if (!minimumResourceManagerVersion.equals("NONE")) {
    if (minimumResourceManagerVersion.equals("EqualToNM")) {
      minimumResourceManagerVersion=nodeManagerVersionId;
    }
    String rmVersion=regNMResponse.getRMVersion();
    if (rmVersion == null) {
      String message="The Resource Manager's did not return a version. " + "Valid version cannot be checked.";
      throw new YarnRuntimeException("Shutting down the Node Manager. " + message);
    }
    if (VersionUtil.compareVersions(rmVersion,minimumResourceManagerVersion) < 0) {
      String message="The Resource Manager's version (" + rmVersion + ") is less than the minimum "+ "allowed version "+ minimumResourceManagerVersion;
      throw new YarnRuntimeException("Shutting down the Node Manager on RM " + "version error, " + message);
    }
  }
  MasterKey masterKey=regNMResponse.getContainerTokenMasterKey();
  if (masterKey != null) {
    this.context.getContainerTokenSecretManager().setMasterKey(masterKey);
  }
  masterKey=regNMResponse.getNMTokenMasterKey();
  if (masterKey != null) {
    this.context.getNMTokenSecretManager().setMasterKey(masterKey);
  }
  StringBuilder successfullRegistrationMsg=new StringBuilder();
  successfullRegistrationMsg.append("Registered with ResourceManager as ").append(this.nodeId).append(" with total resource of ").append(this.totalResource);
  if (regNMResponse.getAreNodeLabelsAcceptedByRM()) {
    successfullRegistrationMsg.append(" and with following Node label(s) : {").append(StringUtils.join(",",nodeLabels)).append("}");
  }
 else   if (hasNodeLabelsProvider) {
    LOG.error(regNMResponse.getDiagnosticsMessage());
  }
  LOG.info(successfullRegistrationMsg);
  LOG.info("Notifying ContainerManager to unblock new container-requests");
  ((ContainerManagerImpl)this.context.getContainerManager()).setBlockNewContainerRequests(false);
}
