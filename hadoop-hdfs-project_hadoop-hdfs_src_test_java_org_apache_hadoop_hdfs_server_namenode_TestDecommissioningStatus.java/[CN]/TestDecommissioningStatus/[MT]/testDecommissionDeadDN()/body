{
  DatanodeID dnID=cluster.getDataNodes().get(0).getDatanodeId();
  String dnName=dnID.getXferAddr();
  DataNodeProperties stoppedDN=cluster.stopDataNode(0);
  DFSTestUtil.waitForDatanodeState(cluster,dnID.getDatanodeUuid(),false,30000);
  FSNamesystem fsn=cluster.getNamesystem();
  final DatanodeManager dm=fsn.getBlockManager().getDatanodeManager();
  DatanodeDescriptor dnDescriptor=dm.getDatanode(dnID);
  decommissionNode(fsn,localFileSys,dnName);
  dm.refreshNodes(conf);
  BlockManagerTestUtil.checkDecommissionState(dm,dnDescriptor);
  assertTrue(dnDescriptor.isDecommissioned());
  cluster.restartDataNode(stoppedDN,true);
  cluster.waitActive();
  writeConfigFile(localFileSys,excludeFile,null);
  dm.refreshNodes(conf);
}
