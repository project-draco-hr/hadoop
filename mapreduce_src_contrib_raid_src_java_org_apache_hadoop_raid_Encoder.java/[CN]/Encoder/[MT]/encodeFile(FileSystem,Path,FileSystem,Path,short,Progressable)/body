{
  FileStatus srcStat=fs.getFileStatus(srcFile);
  long srcSize=srcStat.getLen();
  long blockSize=srcStat.getBlockSize();
  configureBuffers(blockSize);
  Path tmpDir=getParityTempPath();
  if (!parityFs.mkdirs(tmpDir)) {
    throw new IOException("Could not create tmp dir " + tmpDir);
  }
  Path parityTmp=new Path(tmpDir,parityFile.getName() + rand.nextLong());
  FSDataOutputStream out=parityFs.create(parityTmp,true,conf.getInt("io.file.buffer.size",64 * 1024),parityRepl,blockSize);
  try {
    encodeFileToStream(fs,srcFile,srcSize,blockSize,out,reporter);
    out.close();
    out=null;
    LOG.info("Wrote temp parity file " + parityTmp);
    if (parityFs.exists(parityFile)) {
      parityFs.delete(parityFile,false);
    }
    parityFs.mkdirs(parityFile.getParent());
    if (!parityFs.rename(parityTmp,parityFile)) {
      String msg="Unable to rename file " + parityTmp + " to "+ parityFile;
      throw new IOException(msg);
    }
    LOG.info("Wrote parity file " + parityFile);
  }
  finally {
    if (out != null) {
      out.close();
    }
    parityFs.delete(parityTmp,false);
  }
}
