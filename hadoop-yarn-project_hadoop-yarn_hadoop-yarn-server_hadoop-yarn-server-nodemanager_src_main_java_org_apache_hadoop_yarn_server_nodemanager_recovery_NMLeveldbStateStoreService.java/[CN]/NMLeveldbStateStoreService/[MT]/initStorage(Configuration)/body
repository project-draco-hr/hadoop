{
  Path storeRoot=createStorageDir(conf);
  Options options=new Options();
  options.createIfMissing(false);
  options.logger(new LeveldbLogger());
  LOG.info("Using state database at " + storeRoot + " for recovery");
  File dbfile=new File(storeRoot.toString());
  byte[] schemaVersionData=null;
  try {
    db=JniDBFactory.factory.open(dbfile,options);
    try {
      schemaVersionData=db.get(bytes(DB_SCHEMA_VERSION_KEY));
    }
 catch (    DBException e) {
      throw new IOException(e.getMessage(),e);
    }
  }
 catch (  NativeDB.DBException e) {
    if (e.isNotFound() || e.getMessage().contains(" does not exist ")) {
      LOG.info("Creating state database at " + dbfile);
      options.createIfMissing(true);
      try {
        db=JniDBFactory.factory.open(dbfile,options);
        schemaVersionData=bytes(DB_SCHEMA_VERSION);
        db.put(bytes(DB_SCHEMA_VERSION_KEY),schemaVersionData);
      }
 catch (      DBException dbErr) {
        throw new IOException(dbErr.getMessage(),dbErr);
      }
    }
 else {
      throw e;
    }
  }
  if (schemaVersionData != null) {
    String schemaVersion=asString(schemaVersionData);
    if (!DB_SCHEMA_VERSION.equals(schemaVersion)) {
      throw new IOException("Incompatible state database schema, found " + schemaVersion + " expected "+ DB_SCHEMA_VERSION);
    }
  }
 else {
    throw new IOException("State database schema version not found");
  }
}
