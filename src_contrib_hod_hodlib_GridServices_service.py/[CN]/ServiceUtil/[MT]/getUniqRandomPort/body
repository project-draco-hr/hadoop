def getUniqRandomPort(h=None, low=50000, high=60000, retry=900, log=None):
    'This allocates a randome free port between low and high'
    while (retry > 0):
        n = random.randint(low, high)
        if (n in ServiceUtil.localPortUsed):
            continue
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        if (not h):
            h = socket.gethostname()
        avail = False
        if log:
            log.debug(('Trying to see if port %s is available' % n))
        try:
            s.bind((h, n))
            if log:
                log.debug(('Yes, port %s is available' % n))
            avail = True
        except socket.error as e:
            if log:
                log.debug(('Could not bind to the port %s. Reason %s' % (n, e)))
            retry -= 1
            pass
        s.close()
        if avail:
            ServiceUtil.localPortUsed[n] = True
            return n
    raise ValueError, ("Can't find unique local port between %d and %d" % (low, high))
