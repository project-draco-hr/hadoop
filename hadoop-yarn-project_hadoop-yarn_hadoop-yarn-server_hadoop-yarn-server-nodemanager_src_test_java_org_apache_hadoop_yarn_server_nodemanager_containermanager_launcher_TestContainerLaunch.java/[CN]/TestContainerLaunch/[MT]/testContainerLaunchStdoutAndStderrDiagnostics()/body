{
  File shellFile=null;
  try {
    shellFile=Shell.appendScriptExtension(tmpDir,"hello");
    String command=Shell.WINDOWS ? "@echo \"hello\" & @echo \"error\" 1>&2 & exit /b 2" : "echo \"hello\"; echo \"error\" 1>&2; exit 2;";
    PrintWriter writer=new PrintWriter(new FileOutputStream(shellFile));
    FileUtil.setExecutable(shellFile,true);
    writer.println(command);
    writer.close();
    Map<Path,List<String>> resources=new HashMap<Path,List<String>>();
    FileOutputStream fos=new FileOutputStream(shellFile,true);
    Map<String,String> env=new HashMap<String,String>();
    List<String> commands=new ArrayList<String>();
    commands.add(command);
    ContainerExecutor exec=new DefaultContainerExecutor();
    exec.writeLaunchEnv(fos,env,resources,commands);
    fos.flush();
    fos.close();
    Shell.ShellCommandExecutor shexc=new Shell.ShellCommandExecutor(new String[]{shellFile.getAbsolutePath()},tmpDir);
    String diagnostics=null;
    try {
      shexc.execute();
      Assert.fail("Should catch exception");
    }
 catch (    ExitCodeException e) {
      diagnostics=e.getMessage();
    }
    Assert.assertTrue(diagnostics.contains("error"));
    Assert.assertTrue(shexc.getOutput().contains("hello"));
    Assert.assertTrue(shexc.getExitCode() == 2);
  }
  finally {
    if (shellFile != null && shellFile.exists()) {
      shellFile.delete();
    }
  }
}
