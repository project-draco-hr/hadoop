{
  final int NUM_PRE_ALLOCATED_ENTRIES=16;
  if (filterPath != null) {
    if (!DFSUtil.isValidName(filterPath)) {
      throw new IOException("invalid path name '" + filterPath + "'");
    }
  }
  ArrayList<PathBasedCacheEntry> replies=new ArrayList<PathBasedCacheEntry>(NUM_PRE_ALLOCATED_ENTRIES);
  int numReplies=0;
  SortedMap<Long,PathBasedCacheEntry> tailMap=entriesById.tailMap(prevId + 1);
  for (  Entry<Long,PathBasedCacheEntry> cur : tailMap.entrySet()) {
    if (numReplies >= maxListCacheDirectivesResponses) {
      return new BatchedListEntries<PathBasedCacheEntry>(replies,true);
    }
    PathBasedCacheEntry curEntry=cur.getValue();
    PathBasedCacheDirective directive=cur.getValue().getDirective();
    if (filterPool != null && !directive.getPool().equals(filterPool)) {
      continue;
    }
    if (filterPath != null && !directive.getPath().equals(filterPath)) {
      continue;
    }
    CachePool pool=cachePools.get(curEntry.getDirective().getPool());
    if (pool == null) {
      LOG.error("invalid pool for PathBasedCacheEntry " + curEntry);
      continue;
    }
    if (pc.checkPermission(pool,FsAction.READ)) {
      replies.add(cur.getValue());
      numReplies++;
    }
  }
  return new BatchedListEntries<PathBasedCacheEntry>(replies,false);
}
