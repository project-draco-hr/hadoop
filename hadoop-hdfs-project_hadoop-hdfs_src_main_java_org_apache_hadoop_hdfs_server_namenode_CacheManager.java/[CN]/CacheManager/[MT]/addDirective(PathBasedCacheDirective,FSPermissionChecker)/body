{
  CachePool pool=cachePools.get(directive.getPool());
  if (pool == null) {
    LOG.info("addDirective " + directive + ": pool not found.");
    return new Fallible<PathBasedCacheEntry>(new InvalidPoolNameError(directive));
  }
  if ((pc != null) && (!pc.checkPermission(pool,FsAction.WRITE))) {
    LOG.info("addDirective " + directive + ": write permission denied.");
    return new Fallible<PathBasedCacheEntry>(new PoolWritePermissionDeniedError(directive));
  }
  try {
    directive.validate();
  }
 catch (  IOException ioe) {
    LOG.info("addDirective " + directive + ": validation failed.");
    return new Fallible<PathBasedCacheEntry>(ioe);
  }
  PathBasedCacheEntry existing=entriesByDirective.get(directive);
  if (existing != null) {
    LOG.info("addDirective " + directive + ": there is an "+ "existing directive "+ existing);
    return new Fallible<PathBasedCacheEntry>(existing);
  }
  PathBasedCacheEntry entry;
  try {
    entry=new PathBasedCacheEntry(getNextEntryId(),directive);
  }
 catch (  IOException ioe) {
    return new Fallible<PathBasedCacheEntry>(new UnexpectedAddPathBasedCacheDirectiveException(directive));
  }
  LOG.info("addDirective " + directive + ": added cache directive "+ directive);
  entriesByDirective.put(directive,entry);
  entriesById.put(entry.getEntryId(),entry);
  return new Fallible<PathBasedCacheEntry>(entry);
}
