{
  if (excludedScope != null) {
    if (scope.startsWith(excludedScope)) {
      return null;
    }
    if (!excludedScope.startsWith(scope)) {
      excludedScope=null;
    }
  }
  Node node=getNode(scope);
  if (!(node instanceof InnerNode)) {
    return node;
  }
  InnerNode innerNode=(InnerNode)node;
  int numOfDatanodes=innerNode.getNumOfLeaves();
  if (excludedScope == null) {
    node=null;
  }
 else {
    node=getNode(excludedScope);
    if (!(node instanceof InnerNode)) {
      numOfDatanodes-=1;
    }
 else {
      numOfDatanodes-=((InnerNode)node).getNumOfLeaves();
    }
  }
  if (numOfDatanodes == 0) {
    throw new InvalidTopologyException("Failed to find datanode (scope=\"" + String.valueOf(scope) + "\" excludedScope=\""+ String.valueOf(excludedScope)+ "\").");
  }
  int leaveIndex=r.nextInt(numOfDatanodes);
  return innerNode.getLeaf(leaveIndex,node);
}
