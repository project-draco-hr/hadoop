{
  if (expr == null) {
    return null;
  }
  Matcher match=VAR_PATTERN.matcher("");
  String eval=expr;
  Set<String> evalSet=new HashSet<String>();
  for (int s=0; s < MAX_SUBST; s++) {
    if (evalSet.contains(eval)) {
      return eval;
    }
    evalSet.add(eval);
    match.reset(eval);
    if (!match.find()) {
      return eval;
    }
    String var=match.group();
    var=var.substring(2,var.length() - 1);
    String val=null;
    try {
      val=System.getProperty(var);
    }
 catch (    SecurityException se) {
      LOG.warn("Unexpected SecurityException in Configuration",se);
    }
    if (val == null) {
      val=getRaw(var);
    }
    if (val == null) {
      return eval;
    }
    eval=eval.substring(0,match.start()) + val + eval.substring(match.end());
  }
  throw new IllegalStateException("Variable substitution depth too large: " + MAX_SUBST + " "+ expr);
}
