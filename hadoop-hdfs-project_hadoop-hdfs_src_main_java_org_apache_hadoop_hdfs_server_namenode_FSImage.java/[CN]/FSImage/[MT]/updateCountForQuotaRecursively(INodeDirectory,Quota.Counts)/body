{
  final long parentNamespace=counts.get(Quota.NAMESPACE);
  final long parentDiskspace=counts.get(Quota.DISKSPACE);
  dir.computeQuotaUsage4CurrentDirectory(counts);
  for (  INode child : dir.getChildrenList(Snapshot.CURRENT_STATE_ID)) {
    if (child.isDirectory()) {
      updateCountForQuotaRecursively(child.asDirectory(),counts);
    }
 else {
      child.computeQuotaUsage(counts,false);
    }
  }
  if (dir.isQuotaSet()) {
    final Quota.Counts q=dir.getQuotaCounts();
    final long namespace=counts.get(Quota.NAMESPACE) - parentNamespace;
    final long nsQuota=q.get(Quota.NAMESPACE);
    if (Quota.isViolated(nsQuota,namespace)) {
      LOG.error("BUG: Namespace quota violation in image for " + dir.getFullPathName() + " quota = "+ nsQuota+ " < consumed = "+ namespace);
    }
    final long diskspace=counts.get(Quota.DISKSPACE) - parentDiskspace;
    final long dsQuota=q.get(Quota.DISKSPACE);
    if (Quota.isViolated(dsQuota,diskspace)) {
      LOG.error("BUG: Diskspace quota violation in image for " + dir.getFullPathName() + " quota = "+ dsQuota+ " < consumed = "+ diskspace);
    }
    dir.getDirectoryWithQuotaFeature().setSpaceConsumed(namespace,diskspace);
  }
}
