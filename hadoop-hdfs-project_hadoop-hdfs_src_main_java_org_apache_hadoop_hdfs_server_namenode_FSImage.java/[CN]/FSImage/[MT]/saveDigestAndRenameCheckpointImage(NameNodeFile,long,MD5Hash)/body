{
  List<StorageDirectory> badSds=Lists.newArrayList();
  for (  StorageDirectory sd : storage.dirIterable(NameNodeDirType.IMAGE)) {
    File imageFile=NNStorage.getImageFile(sd,nnf,txid);
    try {
      MD5FileUtils.saveMD5File(imageFile,digest);
    }
 catch (    IOException ioe) {
      badSds.add(sd);
    }
  }
  storage.reportErrorsOnDirectories(badSds);
  CheckpointFaultInjector.getInstance().afterMD5Rename();
  renameCheckpoint(txid,NameNodeFile.IMAGE_NEW,nnf,false);
  if (txid > storage.getMostRecentCheckpointTxId()) {
    storage.setMostRecentCheckpointInfo(txid,Time.now());
  }
}
