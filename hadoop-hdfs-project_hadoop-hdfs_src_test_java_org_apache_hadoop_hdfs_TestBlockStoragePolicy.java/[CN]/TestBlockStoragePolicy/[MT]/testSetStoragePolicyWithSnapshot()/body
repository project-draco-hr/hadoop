{
  final MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(REPLICATION).build();
  cluster.waitActive();
  final DistributedFileSystem fs=cluster.getFileSystem();
  try {
    final Path dir=new Path("/testSetStoragePolicyWithSnapshot");
    final Path fooDir=new Path(dir,"foo");
    final Path fooFile1=new Path(fooDir,"f1");
    final Path fooFile2=new Path(fooDir,"f2");
    DFSTestUtil.createFile(fs,fooFile1,FILE_LEN,REPLICATION,0L);
    DFSTestUtil.createFile(fs,fooFile2,FILE_LEN,REPLICATION,0L);
    fs.setStoragePolicy(fooDir,"WARM");
    HdfsFileStatus[] dirList=fs.getClient().listPaths(dir.toString(),HdfsFileStatus.EMPTY_NAME,true).getPartialListing();
    checkDirectoryListing(dirList,WARM);
    HdfsFileStatus[] fooList=fs.getClient().listPaths(fooDir.toString(),HdfsFileStatus.EMPTY_NAME,true).getPartialListing();
    checkDirectoryListing(fooList,WARM,WARM);
    SnapshotTestHelper.createSnapshot(fs,dir,"s1");
    fs.setStoragePolicy(fooFile1,"COLD");
    fooList=fs.getClient().listPaths(fooDir.toString(),HdfsFileStatus.EMPTY_NAME).getPartialListing();
    checkDirectoryListing(fooList,COLD,WARM);
    Path s1f1=SnapshotTestHelper.getSnapshotPath(dir,"s1","foo/f1");
    DirectoryListing f1Listing=fs.getClient().listPaths(s1f1.toString(),HdfsFileStatus.EMPTY_NAME);
    checkDirectoryListing(f1Listing.getPartialListing(),WARM);
    fs.delete(fooFile1,true);
    fooList=fs.getClient().listPaths(fooDir.toString(),HdfsFileStatus.EMPTY_NAME).getPartialListing();
    checkDirectoryListing(fooList,WARM);
    checkDirectoryListing(fs.getClient().listPaths(s1f1.toString(),HdfsFileStatus.EMPTY_NAME).getPartialListing(),WARM);
    fs.setStoragePolicy(fooDir,"HOT");
    dirList=fs.getClient().listPaths(dir.toString(),HdfsFileStatus.EMPTY_NAME,true).getPartialListing();
    checkDirectoryListing(dirList,HOT);
    fooList=fs.getClient().listPaths(fooDir.toString(),HdfsFileStatus.EMPTY_NAME).getPartialListing();
    checkDirectoryListing(fooList,HOT);
    Path s1=SnapshotTestHelper.getSnapshotRoot(dir,"s1");
    Path s1foo=SnapshotTestHelper.getSnapshotPath(dir,"s1","foo");
    checkDirectoryListing(fs.getClient().listPaths(s1.toString(),HdfsFileStatus.EMPTY_NAME).getPartialListing(),WARM);
    checkDirectoryListing(fs.getClient().listPaths(s1foo.toString(),HdfsFileStatus.EMPTY_NAME).getPartialListing(),WARM,WARM);
    fs.delete(fooDir,true);
    checkDirectoryListing(fs.getClient().listPaths(s1.toString(),HdfsFileStatus.EMPTY_NAME).getPartialListing(),WARM);
    checkDirectoryListing(fs.getClient().listPaths(s1foo.toString(),HdfsFileStatus.EMPTY_NAME).getPartialListing(),WARM,WARM);
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
