{
  final MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(REPLICATION).storageTypes(new StorageType[]{StorageType.DISK,StorageType.ARCHIVE}).build();
  cluster.waitActive();
  final DistributedFileSystem fs=cluster.getFileSystem();
  try {
    final String file="/testScheduleWithinSameNode/file";
    Path dir=new Path("/testScheduleWithinSameNode");
    fs.mkdirs(dir);
    fs.setStoragePolicy(dir,"COLD");
    final FSDataOutputStream out=fs.create(new Path(file));
    out.writeChars("testScheduleWithinSameNode");
    out.close();
    fs.setStoragePolicy(dir,"HOT");
    HdfsFileStatus status=fs.getClient().getFileInfo(file);
    Assert.assertTrue("File storage policy should be HOT",status.getStoragePolicy() == HOT);
    cluster.restartNameNode(true);
    status=fs.getClient().getFileInfo(file);
    Assert.assertTrue("File storage policy should be HOT",status.getStoragePolicy() == HOT);
  }
  finally {
    cluster.shutdown();
  }
}
