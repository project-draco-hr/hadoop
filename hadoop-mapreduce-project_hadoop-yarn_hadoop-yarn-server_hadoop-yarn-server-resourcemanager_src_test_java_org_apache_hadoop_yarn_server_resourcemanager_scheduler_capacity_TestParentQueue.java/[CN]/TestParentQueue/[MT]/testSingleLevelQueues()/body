{
  setupSingleLevelQueues(csConf);
  Map<String,CSQueue> queues=new HashMap<String,CSQueue>();
  CSQueue root=CapacityScheduler.parseQueue(csContext,csConf,null,CapacitySchedulerConfiguration.ROOT,queues,queues,CapacityScheduler.queueComparator,CapacityScheduler.applicationComparator,TestUtils.spyHook);
  final int memoryPerNode=10;
  final int numNodes=2;
  SchedulerNode node_0=TestUtils.getMockNode("host_0",DEFAULT_RACK,0,memoryPerNode * GB);
  SchedulerNode node_1=TestUtils.getMockNode("host_1",DEFAULT_RACK,0,memoryPerNode * GB);
  final Resource clusterResource=Resources.createResource(numNodes * (memoryPerNode * GB));
  when(csContext.getNumClusterNodes()).thenReturn(numNodes);
  LeafQueue a=(LeafQueue)queues.get(A);
  LeafQueue b=(LeafQueue)queues.get(B);
  stubQueueAllocation(a,clusterResource,node_0,0 * GB);
  stubQueueAllocation(b,clusterResource,node_0,1 * GB);
  root.assignContainers(clusterResource,node_0);
  verifyQueueMetrics(a,0 * GB,clusterResource);
  verifyQueueMetrics(b,1 * GB,clusterResource);
  stubQueueAllocation(a,clusterResource,node_1,2 * GB);
  stubQueueAllocation(b,clusterResource,node_1,1 * GB);
  root.assignContainers(clusterResource,node_1);
  InOrder allocationOrder=inOrder(a,b);
  allocationOrder.verify(a).assignContainers(eq(clusterResource),any(SchedulerNode.class));
  allocationOrder.verify(b).assignContainers(eq(clusterResource),any(SchedulerNode.class));
  verifyQueueMetrics(a,2 * GB,clusterResource);
  verifyQueueMetrics(b,2 * GB,clusterResource);
  stubQueueAllocation(a,clusterResource,node_0,1 * GB);
  stubQueueAllocation(b,clusterResource,node_0,2 * GB);
  root.assignContainers(clusterResource,node_0);
  allocationOrder=inOrder(b,a);
  allocationOrder.verify(b).assignContainers(eq(clusterResource),any(SchedulerNode.class));
  allocationOrder.verify(a).assignContainers(eq(clusterResource),any(SchedulerNode.class));
  verifyQueueMetrics(a,3 * GB,clusterResource);
  verifyQueueMetrics(b,4 * GB,clusterResource);
  stubQueueAllocation(a,clusterResource,node_0,0 * GB);
  stubQueueAllocation(b,clusterResource,node_0,4 * GB);
  root.assignContainers(clusterResource,node_0);
  allocationOrder=inOrder(b,a);
  allocationOrder.verify(b).assignContainers(eq(clusterResource),any(SchedulerNode.class));
  allocationOrder.verify(a).assignContainers(eq(clusterResource),any(SchedulerNode.class));
  verifyQueueMetrics(a,3 * GB,clusterResource);
  verifyQueueMetrics(b,8 * GB,clusterResource);
  stubQueueAllocation(a,clusterResource,node_1,1 * GB);
  stubQueueAllocation(b,clusterResource,node_1,1 * GB);
  root.assignContainers(clusterResource,node_1);
  allocationOrder=inOrder(a,b);
  allocationOrder.verify(b).assignContainers(eq(clusterResource),any(SchedulerNode.class));
  allocationOrder.verify(a).assignContainers(eq(clusterResource),any(SchedulerNode.class));
  verifyQueueMetrics(a,4 * GB,clusterResource);
  verifyQueueMetrics(b,9 * GB,clusterResource);
}
