{
  MiniDFSCluster cluster=null;
  Configuration conf=new HdfsConfiguration();
  conf.setInt(DFSConfigKeys.DFS_NAMENODE_CHECKPOINT_TXNS_KEY,CHECKPOINT_ON_STARTUP_MIN_TXNS);
  try {
    LOG.info("\n===========================================\n" + "Starting empty cluster");
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(NUM_DATA_NODES).format(true).build();
    cluster.waitActive();
    FileSystem fs=cluster.getFileSystem();
    for (int i=0; i < numTransactions; i++) {
      fs.mkdirs(new Path("/test" + i));
    }
    File nameDir=new File(cluster.getNameDirs(0).iterator().next().getPath());
    File dfsDir=nameDir.getParentFile();
    assertEquals(dfsDir.getName(),"dfs");
    LOG.info("Copying data directory aside to a hot backup");
    File backupDir=new File(dfsDir.getParentFile(),"dfs.backup-while-running");
    FileUtils.copyDirectory(dfsDir,backupDir);
    LOG.info("Shutting down cluster #1");
    cluster.shutdown();
    cluster=null;
    FileUtil.fullyDeleteContents(dfsDir);
    dfsDir.delete();
    backupDir.renameTo(dfsDir);
    File currentDir=new File(nameDir,"current");
    File editsFile=new File(currentDir,NNStorage.getInProgressEditsFileName(1));
    assertTrue("Edits file " + editsFile + " should exist",editsFile.exists());
    File imageFile=FSImageTestUtil.findNewestImageFile(currentDir.getAbsolutePath());
    assertNotNull("No image found in " + nameDir,imageFile);
    assertEquals(NNStorage.getImageFileName(0),imageFile.getName());
    LOG.info("\n===========================================\n" + "Starting same cluster after simulated crash");
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(NUM_DATA_NODES).format(false).build();
    cluster.waitActive();
    fs=cluster.getFileSystem();
    for (int i=0; i < numTransactions; i++) {
      assertTrue(fs.exists(new Path("/test" + i)));
    }
    long expectedTxId;
    if (numTransactions > CHECKPOINT_ON_STARTUP_MIN_TXNS) {
      expectedTxId=numTransactions + 1;
    }
 else {
      expectedTxId=0;
    }
    imageFile=FSImageTestUtil.findNewestImageFile(currentDir.getAbsolutePath());
    assertNotNull("No image found in " + nameDir,imageFile);
    assertEquals(NNStorage.getImageFileName(expectedTxId),imageFile.getName());
    cluster.shutdown();
    cluster=null;
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(NUM_DATA_NODES).format(false).build();
    cluster.waitActive();
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
