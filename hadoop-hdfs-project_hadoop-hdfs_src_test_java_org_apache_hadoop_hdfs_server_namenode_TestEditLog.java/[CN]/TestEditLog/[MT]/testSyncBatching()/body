{
  Configuration conf=new HdfsConfiguration();
  MiniDFSCluster cluster=null;
  FileSystem fileSys=null;
  ExecutorService threadA=Executors.newSingleThreadExecutor();
  ExecutorService threadB=Executors.newSingleThreadExecutor();
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(NUM_DATA_NODES).build();
    cluster.waitActive();
    fileSys=cluster.getFileSystem();
    final FSNamesystem namesystem=cluster.getNamesystem();
    FSImage fsimage=namesystem.getFSImage();
    final FSEditLog editLog=fsimage.getEditLog();
    assertEquals("should start with only the BEGIN_LOG_SEGMENT txn synced",1,editLog.getSyncTxId());
    doLogEdit(threadA,editLog,"thread-a 1");
    assertEquals("logging edit without syncing should do not affect txid",1,editLog.getSyncTxId());
    doLogEdit(threadB,editLog,"thread-b 1");
    assertEquals("logging edit without syncing should do not affect txid",1,editLog.getSyncTxId());
    doCallLogSync(threadB,editLog);
    assertEquals("logSync from second thread should bump txid up to 3",3,editLog.getSyncTxId());
    doCallLogSync(threadA,editLog);
    assertEquals("logSync from first thread shouldn't change txid",3,editLog.getSyncTxId());
    assertCounter("TransactionsBatchedInSync",1L,getMetrics("NameNodeActivity"));
  }
  finally {
    threadA.shutdown();
    threadB.shutdown();
    if (fileSys != null)     fileSys.close();
    if (cluster != null)     cluster.shutdown();
  }
}
