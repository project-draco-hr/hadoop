{
  DataInputStream dis=getValueStream();
  try {
    if (isValueLengthKnown()) {
      if ((offset | (buf.length - offset - vlen)) < 0) {
        throw new IndexOutOfBoundsException("Buffer too small to hold value");
      }
      dis.readFully(buf,offset,vlen);
      return vlen;
    }
    int nextOffset=offset;
    while (nextOffset < buf.length) {
      int n=dis.read(buf,nextOffset,buf.length - nextOffset);
      if (n < 0) {
        break;
      }
      nextOffset+=n;
    }
    if (dis.read() >= 0) {
      throw new IndexOutOfBoundsException("Buffer too small to hold value");
    }
    return nextOffset - offset;
  }
  finally {
    dis.close();
  }
}
