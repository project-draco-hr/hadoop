{
  List<INode> children=current.getChildrenRaw();
  if (children == null || children.isEmpty())   return;
  int prefixLen=currentDirName.position();
  if (prefixLen == 0) {
    out.writeShort(PATH_SEPARATOR.length);
    out.write(PATH_SEPARATOR);
  }
 else {
    out.writeShort(prefixLen);
    out.write(currentDirName.array(),0,prefixLen);
  }
  out.writeInt(children.size());
  int i=0;
  for (  INode child : children) {
    FSImageSerialization.saveINode2Image(child,out);
    if (i++ % 50 == 0) {
      context.checkCancelled();
    }
  }
  for (  INode child : children) {
    if (!child.isDirectory())     continue;
    currentDirName.put(PATH_SEPARATOR).put(child.getLocalNameBytes());
    saveImage(currentDirName,(INodeDirectory)child,out);
    currentDirName.position(prefixLen);
  }
}
