{
  checkNotSaved();
  final FSNamesystem sourceNamesystem=context.getSourceNamesystem();
  FSDirectory fsDir=sourceNamesystem.dir;
  long startTime=now();
  MessageDigest digester=MD5Hash.getDigester();
  FileOutputStream fout=new FileOutputStream(newFile);
  DigestOutputStream fos=new DigestOutputStream(fout,digester);
  DataOutputStream out=new DataOutputStream(fos);
  try {
    out.writeInt(HdfsConstants.LAYOUT_VERSION);
    out.writeInt(sourceNamesystem.unprotectedGetNamespaceInfo().getNamespaceID());
    out.writeLong(fsDir.rootDir.numItemsInTree());
    out.writeLong(sourceNamesystem.getGenerationStampV1());
    out.writeLong(sourceNamesystem.getGenerationStampV2());
    out.writeLong(sourceNamesystem.getGenerationStampAtblockIdSwitch());
    out.writeLong(sourceNamesystem.getLastAllocatedBlockId());
    out.writeLong(context.getTxId());
    out.writeLong(sourceNamesystem.getLastInodeId());
    sourceNamesystem.getSnapshotManager().write(out);
    out=compression.writeHeaderAndWrapStream(fos);
    LOG.info("Saving image file " + newFile + " using "+ compression);
    FSImageSerialization.saveINode2Image(fsDir.rootDir,out,false,referenceMap);
    saveImage(fsDir.rootDir,out,true);
    sourceNamesystem.saveFilesUnderConstruction(out);
    context.checkCancelled();
    sourceNamesystem.saveSecretManagerState(out);
    context.checkCancelled();
    out.flush();
    context.checkCancelled();
    fout.getChannel().force(true);
  }
  finally {
    out.close();
  }
  saved=true;
  savedDigest=new MD5Hash(digester.digest());
  LOG.info("Image file " + newFile + " of size "+ newFile.length()+ " bytes saved in "+ (now() - startTime) / 1000 + " seconds.");
}
