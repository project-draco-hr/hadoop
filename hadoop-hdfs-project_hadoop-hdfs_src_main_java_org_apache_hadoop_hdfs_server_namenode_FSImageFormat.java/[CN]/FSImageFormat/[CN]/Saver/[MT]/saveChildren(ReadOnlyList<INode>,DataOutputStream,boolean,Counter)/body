{
  out.writeInt(children.size());
  int dirNum=0;
  for (  INode child : children) {
    saveINode2Image(child,out,false,referenceMap,counter);
    if (child.isDirectory()) {
      dirNum++;
    }
 else     if (inSnapshot && child.isFile() && child.asFile().isUnderConstruction()) {
      this.snapshotUCMap.put(child.getId(),child.asFile());
    }
    if (checkCancelCounter++ % CHECK_CANCEL_INTERVAL == 0) {
      context.checkCancelled();
    }
  }
  return dirNum;
}
