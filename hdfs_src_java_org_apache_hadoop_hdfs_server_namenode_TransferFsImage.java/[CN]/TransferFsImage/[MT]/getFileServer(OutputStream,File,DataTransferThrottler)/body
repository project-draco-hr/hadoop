{
  byte buf[]=new byte[BUFFER_SIZE];
  FileInputStream infile=null;
  try {
    infile=new FileInputStream(localfile);
    if (ErrorSimulator.getErrorSimulation(2) && localfile.getAbsolutePath().contains("secondary")) {
      throw new IOException("If this exception is not caught by the " + "name-node fs image will be truncated.");
    }
    if (ErrorSimulator.getErrorSimulation(3) && localfile.getAbsolutePath().contains("fsimage")) {
      long len=localfile.length();
      buf=new byte[(int)Math.min(len / 2,BUFFER_SIZE)];
      infile.read(buf);
    }
    int num=1;
    while (num > 0) {
      num=infile.read(buf);
      if (num <= 0) {
        break;
      }
      if (ErrorSimulator.getErrorSimulation(4)) {
        LOG.warn("SIMULATING A CORRUPT BYTE IN IMAGE TRANSFER!");
        buf[0]++;
      }
      outstream.write(buf,0,num);
      if (throttler != null) {
        throttler.throttle(num);
      }
    }
  }
  finally {
    if (infile != null) {
      infile.close();
    }
  }
}
