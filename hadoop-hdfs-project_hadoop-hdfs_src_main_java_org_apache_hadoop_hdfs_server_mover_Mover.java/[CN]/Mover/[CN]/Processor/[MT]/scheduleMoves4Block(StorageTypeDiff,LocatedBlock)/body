{
  final List<MLocation> locations=MLocation.toLocations(lb);
  Collections.shuffle(locations);
  final DBlock db=new DBlock(lb.getBlock().getLocalBlock());
  for (  MLocation ml : locations) {
    db.addLocation(storages.getTarget(ml));
  }
  for (final Iterator<StorageType> i=diff.existing.iterator(); i.hasNext(); ) {
    final StorageType t=i.next();
    for (final Iterator<MLocation> j=locations.iterator(); j.hasNext(); ) {
      final MLocation ml=j.next();
      final Source source=storages.getSource(ml);
      if (ml.storageType == t) {
        if (scheduleMoveReplica(db,ml,source,diff.expected)) {
          i.remove();
          j.remove();
        }
      }
    }
  }
}
