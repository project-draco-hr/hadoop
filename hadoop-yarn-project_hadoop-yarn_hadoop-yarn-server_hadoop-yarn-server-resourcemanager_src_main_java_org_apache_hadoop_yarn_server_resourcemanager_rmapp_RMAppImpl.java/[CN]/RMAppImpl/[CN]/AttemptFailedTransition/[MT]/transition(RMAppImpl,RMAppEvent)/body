{
  if (!app.submissionContext.getUnmanagedAM() && app.getNumFailedAppAttempts() < app.maxAppAttempts) {
    boolean transferStateFromPreviousAttempt=false;
    RMAppFailedAttemptEvent failedEvent=(RMAppFailedAttemptEvent)event;
    transferStateFromPreviousAttempt=failedEvent.getTransferStateFromPreviousAttempt();
    RMAppAttempt oldAttempt=app.currentAttempt;
    app.createAndStartNewAttempt(transferStateFromPreviousAttempt);
    if (transferStateFromPreviousAttempt) {
      ((RMAppAttemptImpl)app.currentAttempt).transferStateFromPreviousAttempt(oldAttempt);
    }
    return initialState;
  }
 else {
    app.rememberTargetTransitionsAndStoreState(event,new AttemptFailedFinalStateSavedTransition(),RMAppState.FAILED,RMAppState.FAILED);
    return RMAppState.FINAL_SAVING;
  }
}
