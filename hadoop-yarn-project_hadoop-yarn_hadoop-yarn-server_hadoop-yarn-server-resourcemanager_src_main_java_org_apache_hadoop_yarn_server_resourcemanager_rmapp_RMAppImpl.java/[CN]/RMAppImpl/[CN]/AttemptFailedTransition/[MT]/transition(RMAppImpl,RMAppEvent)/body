{
  int numberOfFailure=app.getNumFailedAppAttempts();
  if (!app.submissionContext.getUnmanagedAM() && numberOfFailure < app.maxAppAttempts) {
    boolean transferStateFromPreviousAttempt;
    RMAppFailedAttemptEvent failedEvent=(RMAppFailedAttemptEvent)event;
    transferStateFromPreviousAttempt=failedEvent.getTransferStateFromPreviousAttempt();
    RMAppAttempt oldAttempt=app.currentAttempt;
    app.createAndStartNewAttempt(transferStateFromPreviousAttempt);
    ((RMAppAttemptImpl)app.currentAttempt).transferStateFromPreviousAttempt(oldAttempt);
    return initialState;
  }
 else {
    if (numberOfFailure >= app.maxAppAttempts) {
      app.isNumAttemptsBeyondThreshold=true;
    }
    app.rememberTargetTransitionsAndStoreState(event,new AttemptFailedFinalStateSavedTransition(),RMAppState.FAILED,RMAppState.FAILED);
    return RMAppState.FINAL_SAVING;
  }
}
