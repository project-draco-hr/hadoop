{
  DataInputStream in=new DataInputStream(underlyingIn);
  DataOutputStream out=new DataOutputStream(underlyingOut);
  Map<String,String> saslProps=Maps.newHashMap(SASL_PROPS);
  saslProps.put("com.sun.security.sasl.digest.cipher",encryptionAlgorithm);
  if (LOG.isDebugEnabled()) {
    LOG.debug("Server using encryption algorithm " + encryptionAlgorithm);
  }
  SaslParticipant sasl=new SaslParticipant(Sasl.createSaslServer(MECHANISM,PROTOCOL,SERVER_NAME,saslProps,new SaslServerCallbackHandler(blockPoolTokenSecretManager)));
  int magicNumber=in.readInt();
  if (magicNumber != ENCRYPTED_TRANSFER_MAGIC_NUMBER) {
    throw new InvalidMagicNumberException(magicNumber);
  }
  try {
    performSaslStep1(out,in,sasl);
    byte[] remoteResponse=readSaslMessage(in);
    byte[] localResponse=sasl.evaluateChallengeOrResponse(remoteResponse);
    sendSaslMessage(out,localResponse);
    checkSaslComplete(sasl);
    return sasl.createEncryptedStreamPair(out,in);
  }
 catch (  IOException ioe) {
    if (ioe instanceof SaslException && ioe.getCause() != null && ioe.getCause() instanceof InvalidEncryptionKeyException) {
      sendInvalidKeySaslErrorMessage(out,ioe.getCause().getMessage());
    }
 else {
      sendGenericSaslErrorMessage(out,ioe.getMessage());
    }
    throw ioe;
  }
}
