{
  MockFiller filler=new MockFiller();
  final ValueQueue<String> vq=new ValueQueue<String>(10,0.1f,300,1,SyncGenerationPolicy.ALL,filler);
  Assert.assertEquals("test",vq.getNext("k1"));
  Assert.assertEquals(1,filler.getTop().num);
  Assert.assertEquals("Failed in sync call.",10,vq.getAtMost("k1",10).size());
  Assert.assertEquals("Sync call filler got wrong number.",10,filler.getTop().num);
  GenericTestUtils.waitFor(new Supplier<Boolean>(){
    @Override public Boolean get(){
      try {
        int size=vq.getSize("k1");
        if (size != 10) {
          LOG.info("Current ValueQueue size is " + size);
          return false;
        }
        return true;
      }
 catch (      ExecutionException e) {
        LOG.error("Exception when getSize.",e);
        return false;
      }
    }
  }
,100,3000);
  Assert.assertEquals("Failed in async call.",10,filler.getTop().num);
  Assert.assertEquals("Failed to drain completely after async.",10,vq.getAtMost("k1",10).size());
  Assert.assertEquals("Failed to get all 19.",19,vq.getAtMost("k1",19).size());
  Assert.assertEquals("Failed in sync call.",19,filler.getTop().num);
  vq.shutdown();
}
