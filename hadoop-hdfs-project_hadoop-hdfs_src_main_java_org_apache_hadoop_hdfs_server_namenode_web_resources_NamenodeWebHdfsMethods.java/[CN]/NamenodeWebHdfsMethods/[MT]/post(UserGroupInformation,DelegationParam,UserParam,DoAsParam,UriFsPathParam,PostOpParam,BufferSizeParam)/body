{
  init(ugi,delegation,username,doAsUser,path,op,bufferSize);
  return ugi.doAs(new PrivilegedExceptionAction<Response>(){
    @Override public Response run() throws IOException, URISyntaxException {
      REMOTE_ADDRESS.set(request.getRemoteAddr());
      try {
        final String fullpath=path.getAbsolutePath();
        final NameNode namenode=(NameNode)context.getAttribute("name.node");
switch (op.getValue()) {
case APPEND:
{
            final URI uri=redirectURI(namenode,ugi,delegation,username,doAsUser,fullpath,op.getValue(),-1L,bufferSize);
            return Response.temporaryRedirect(uri).type(MediaType.APPLICATION_OCTET_STREAM).build();
          }
default :
        throw new UnsupportedOperationException(op + " is not supported");
    }
  }
  finally {
    REMOTE_ADDRESS.set(null);
  }
}
}
);
}
