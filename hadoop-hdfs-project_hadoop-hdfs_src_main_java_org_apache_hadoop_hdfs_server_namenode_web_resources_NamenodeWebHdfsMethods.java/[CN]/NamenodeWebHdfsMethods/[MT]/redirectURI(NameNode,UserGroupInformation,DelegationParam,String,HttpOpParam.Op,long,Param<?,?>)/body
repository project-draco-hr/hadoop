{
  final DatanodeInfo dn=chooseDatanode(namenode,path,op,openOffset);
  final String delegationQuery;
  if (!UserGroupInformation.isSecurityEnabled()) {
    delegationQuery="";
  }
 else   if (delegation.getValue() != null) {
    delegationQuery="&" + delegation;
  }
 else {
    final Token<? extends TokenIdentifier> t=generateDelegationToken(namenode,ugi,request.getUserPrincipal().getName());
    delegationQuery="&" + new DelegationParam(t.encodeToUrlString());
  }
  final String query=op.toQueryString() + '&' + new UserParam(ugi)+ delegationQuery+ Param.toSortedString("&",parameters);
  final String uripath="/" + WebHdfsFileSystem.PATH_PREFIX + path;
  final URI uri=new URI("http",null,dn.getHostName(),dn.getInfoPort(),uripath,query,null);
  if (LOG.isTraceEnabled()) {
    LOG.trace("redirectURI=" + uri);
  }
  return uri;
}
