{
  try {
    EnumSetWritable<CreateFlag> flags=req.hasFlag() ? PBHelper.convertCreateFlag(req.getFlag()) : new EnumSetWritable<>(EnumSet.of(CreateFlag.APPEND));
    LastBlockWithStatus result=server.append(req.getSrc(),req.getClientName(),flags);
    AppendResponseProto.Builder builder=AppendResponseProto.newBuilder();
    if (result.getLastBlock() != null) {
      builder.setBlock(PBHelper.convert(result.getLastBlock()));
    }
    if (result.getFileStatus() != null) {
      builder.setStat(PBHelper.convert(result.getFileStatus()));
    }
    return builder.build();
  }
 catch (  IOException e) {
    throw new ServiceException(e);
  }
}
