{
  Configuration conf=new Configuration();
  AsyncDispatcher dispatcher=new AsyncDispatcher();
  dispatcher.init(conf);
  dispatcher.start();
  OutputCommitter committer=mock(OutputCommitter.class);
  doThrow(new IOException("forcefail")).when(committer).setupJob(any(JobContext.class));
  CommitterEventHandler commitHandler=createCommitterEventHandler(dispatcher,committer);
  commitHandler.init(conf);
  commitHandler.start();
  AppContext mockContext=mock(AppContext.class);
  when(mockContext.hasSuccessfullyUnregistered()).thenReturn(false);
  JobImpl job=createStubbedJob(conf,dispatcher,2,mockContext);
  JobId jobId=job.getID();
  job.handle(new JobEvent(jobId,JobEventType.JOB_INIT));
  assertJobState(job,JobStateInternal.INITED);
  job.handle(new JobStartEvent(jobId));
  assertJobState(job,JobStateInternal.FAILED);
  job.handle(new JobEvent(jobId,JobEventType.JOB_TASK_COMPLETED));
  assertJobState(job,JobStateInternal.FAILED);
  job.handle(new JobEvent(jobId,JobEventType.JOB_TASK_ATTEMPT_COMPLETED));
  assertJobState(job,JobStateInternal.FAILED);
  job.handle(new JobEvent(jobId,JobEventType.JOB_MAP_TASK_RESCHEDULED));
  assertJobState(job,JobStateInternal.FAILED);
  job.handle(new JobEvent(jobId,JobEventType.JOB_TASK_ATTEMPT_FETCH_FAILURE));
  assertJobState(job,JobStateInternal.FAILED);
  Assert.assertEquals(JobState.RUNNING,job.getState());
  when(mockContext.hasSuccessfullyUnregistered()).thenReturn(true);
  Assert.assertEquals(JobState.FAILED,job.getState());
  dispatcher.stop();
  commitHandler.stop();
}
