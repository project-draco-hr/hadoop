{
  Configuration conf=new Configuration();
  conf.set(MRJobConfig.MR_AM_STAGING_DIR,stagingDir);
  conf.set(MRJobConfig.MR_AM_COMMITTER_CANCEL_TIMEOUT_MS,"1000");
  InlineDispatcher dispatcher=new InlineDispatcher();
  dispatcher.init(conf);
  dispatcher.start();
  OutputCommitter committer=Mockito.mock(OutputCommitter.class);
  CommitterEventHandler commitHandler=createCommitterEventHandler(dispatcher,committer);
  commitHandler.init(conf);
  commitHandler.start();
  JobImpl job=createRunningStubbedJob(conf,dispatcher,2);
  job.handle(new JobTaskEvent(MRBuilderUtils.newTaskId(job.getID(),1,TaskType.MAP),TaskState.FAILED));
  Mockito.verify(committer,Mockito.never()).abortJob((JobContext)Mockito.any(),(State)Mockito.any());
  assertJobState(job,JobStateInternal.FAIL_WAIT);
  Mockito.verify(committer,Mockito.timeout(2000).times(1)).abortJob((JobContext)Mockito.any(),(State)Mockito.any());
  assertJobState(job,JobStateInternal.FAILED);
  dispatcher.stop();
}
