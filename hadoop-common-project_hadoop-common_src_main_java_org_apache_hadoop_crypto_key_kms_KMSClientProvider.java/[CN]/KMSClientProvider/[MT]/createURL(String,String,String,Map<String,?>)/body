{
  try {
    StringBuilder sb=new StringBuilder();
    sb.append(kmsUrl);
    sb.append(collection);
    if (resource != null) {
      sb.append("/").append(URLEncoder.encode(resource,UTF8));
    }
    if (subResource != null) {
      sb.append("/").append(subResource);
    }
    URIBuilder uriBuilder=new URIBuilder(sb.toString());
    if (parameters != null) {
      for (      Map.Entry<String,?> param : parameters.entrySet()) {
        Object value=param.getValue();
        if (value instanceof String) {
          uriBuilder.addParameter(param.getKey(),(String)value);
        }
 else {
          for (          String s : (String[])value) {
            uriBuilder.addParameter(param.getKey(),s);
          }
        }
      }
    }
    return uriBuilder.build().toURL();
  }
 catch (  URISyntaxException ex) {
    throw new IOException(ex);
  }
}
