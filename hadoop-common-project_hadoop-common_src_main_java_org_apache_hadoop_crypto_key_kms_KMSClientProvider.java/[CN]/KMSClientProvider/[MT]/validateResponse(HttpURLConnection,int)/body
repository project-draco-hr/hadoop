{
  int status=conn.getResponseCode();
  if (status != expected) {
    InputStream es=null;
    try {
      Exception toThrow;
      String contentType=conn.getHeaderField(CONTENT_TYPE);
      if (contentType != null && contentType.toLowerCase().startsWith(APPLICATION_JSON_MIME)) {
        es=conn.getErrorStream();
        ObjectMapper mapper=new ObjectMapper();
        Map json=mapper.readValue(es,Map.class);
        String exClass=(String)json.get(KMSRESTConstants.ERROR_EXCEPTION_JSON);
        String exMsg=(String)json.get(KMSRESTConstants.ERROR_MESSAGE_JSON);
        try {
          ClassLoader cl=KMSClientProvider.class.getClassLoader();
          Class klass=cl.loadClass(exClass);
          Constructor constr=klass.getConstructor(String.class);
          toThrow=(Exception)constr.newInstance(exMsg);
        }
 catch (        Exception ex) {
          toThrow=new IOException(MessageFormat.format("HTTP status [{0}], {1}",status,conn.getResponseMessage()));
        }
      }
 else {
        toThrow=new IOException(MessageFormat.format("HTTP status [{0}], {1}",status,conn.getResponseMessage()));
      }
      throwEx(toThrow);
    }
  finally {
      if (es != null) {
        es.close();
      }
    }
  }
}
