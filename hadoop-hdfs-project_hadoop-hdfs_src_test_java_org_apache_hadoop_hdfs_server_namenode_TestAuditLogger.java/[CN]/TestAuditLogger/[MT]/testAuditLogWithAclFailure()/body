{
  final Configuration conf=new HdfsConfiguration();
  conf.setBoolean(DFS_NAMENODE_ACLS_ENABLED_KEY,true);
  conf.set(DFS_NAMENODE_AUDIT_LOGGERS_KEY,DummyAuditLogger.class.getName());
  final MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).build();
  try {
    cluster.waitClusterUp();
    final FSDirectory dir=cluster.getNamesystem().getFSDirectory();
    final FSDirectory mockedDir=Mockito.spy(dir);
    AccessControlException ex=new AccessControlException();
    doThrow(ex).when(mockedDir).getPermissionChecker();
    cluster.getNamesystem().setFSDirectory(mockedDir);
    assertTrue(DummyAuditLogger.initialized);
    DummyAuditLogger.resetLogCount();
    final FileSystem fs=cluster.getFileSystem();
    final Path p=new Path("/");
    final List<AclEntry> acls=Lists.newArrayList();
    try {
      fs.getAclStatus(p);
    }
 catch (    AccessControlException ignored) {
    }
    try {
      fs.setAcl(p,acls);
    }
 catch (    AccessControlException ignored) {
    }
    try {
      fs.removeAcl(p);
    }
 catch (    AccessControlException ignored) {
    }
    try {
      fs.removeDefaultAcl(p);
    }
 catch (    AccessControlException ignored) {
    }
    try {
      fs.removeAclEntries(p,acls);
    }
 catch (    AccessControlException ignored) {
    }
    try {
      fs.modifyAclEntries(p,acls);
    }
 catch (    AccessControlException ignored) {
    }
    assertEquals(6,DummyAuditLogger.logCount);
    assertEquals(6,DummyAuditLogger.unsuccessfulCount);
  }
  finally {
    cluster.shutdown();
  }
}
