{
  boolean success=false;
  Socket sock=null;
  try {
    sock=socketFactory.createSocket();
    String dnAddr=dn.getXferAddr(connectToDnViaHostname);
    LOG.debug("Connecting to datanode {}",dnAddr);
    NetUtils.connect(sock,NetUtils.createSocketAddr(dnAddr),timeout);
    sock.setTcpNoDelay(getClientDataTransferTcpNoDelay(conf));
    sock.setSoTimeout(timeout);
    OutputStream unbufOut=NetUtils.getOutputStream(sock);
    InputStream unbufIn=NetUtils.getInputStream(sock);
    IOStreamPair pair=saslClient.newSocketSend(sock,unbufOut,unbufIn,dekFactory,blockToken,dn);
    IOStreamPair result=new IOStreamPair(new DataInputStream(pair.in),new DataOutputStream(new BufferedOutputStream(pair.out,DFSUtilClient.getSmallBufferSize(conf))));
    success=true;
    return result;
  }
  finally {
    if (!success) {
      IOUtils.closeSocket(sock);
    }
  }
}
