{
  URLConnectionFactory factory=mock(URLConnectionFactory.class);
  ByteRangeInputStream brs=spy(new HftpFileSystem.RangeHeaderInputStream(factory,new URL("http://test/")));
  InputStream mockStream=mock(InputStream.class);
  doReturn(mockStream).when(brs).openInputStream();
  int brisOpens=0;
  int brisCloses=0;
  int isCloses=0;
  brs.getInputStream();
  verify(brs,times(++brisOpens)).openInputStream();
  verify(brs,times(brisCloses)).close();
  verify(mockStream,times(isCloses)).close();
  brs.getInputStream();
  verify(brs,times(brisOpens)).openInputStream();
  verify(brs,times(brisCloses)).close();
  verify(mockStream,times(isCloses)).close();
  brs.seek(1);
  brs.getInputStream();
  verify(brs,times(++brisOpens)).openInputStream();
  verify(brs,times(brisCloses)).close();
  verify(mockStream,times(++isCloses)).close();
  brs.getInputStream();
  verify(brs,times(brisOpens)).openInputStream();
  verify(brs,times(brisCloses)).close();
  verify(mockStream,times(isCloses)).close();
  brs.seek(1);
  brs.getInputStream();
  verify(brs,times(brisOpens)).openInputStream();
  verify(brs,times(brisCloses)).close();
  verify(mockStream,times(isCloses)).close();
  brs.close();
  verify(brs,times(++brisCloses)).close();
  verify(mockStream,times(++isCloses)).close();
  brs.close();
  verify(brs,times(++brisCloses)).close();
  verify(mockStream,times(isCloses)).close();
  boolean errored=false;
  try {
    brs.getInputStream();
  }
 catch (  IOException e) {
    errored=true;
    assertEquals("Stream closed",e.getMessage());
  }
 finally {
    assertTrue("Read a closed steam",errored);
  }
  verify(brs,times(brisOpens)).openInputStream();
  verify(brs,times(brisCloses)).close();
  verify(mockStream,times(isCloses)).close();
}
