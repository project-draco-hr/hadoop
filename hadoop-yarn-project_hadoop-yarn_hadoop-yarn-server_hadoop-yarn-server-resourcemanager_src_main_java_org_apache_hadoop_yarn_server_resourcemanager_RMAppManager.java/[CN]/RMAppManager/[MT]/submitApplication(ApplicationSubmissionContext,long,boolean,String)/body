{
  ApplicationId applicationId=submissionContext.getApplicationId();
  if (!submissionContext.getUnmanagedAM()) {
    ResourceRequest amReq=BuilderUtils.newResourceRequest(RMAppAttemptImpl.AM_CONTAINER_PRIORITY,ResourceRequest.ANY,submissionContext.getResource(),1);
    try {
      SchedulerUtils.validateResourceRequest(amReq,scheduler.getMaximumResourceCapability());
    }
 catch (    InvalidResourceRequestException e) {
      LOG.warn("RM app submission failed in validating AM resource request" + " for application " + applicationId,e);
      throw e;
    }
  }
  RMApp application=new RMAppImpl(applicationId,rmContext,this.conf,submissionContext.getApplicationName(),user,submissionContext.getQueue(),submissionContext,this.scheduler,this.masterService,submitTime,submissionContext.getApplicationType());
  if (rmContext.getRMApps().putIfAbsent(applicationId,application) != null) {
    String message="Application with id " + applicationId + " is already present! Cannot add a duplicate!";
    LOG.warn(message);
    throw RPCUtil.getRemoteException(message);
  }
  this.applicationACLsManager.addApplication(applicationId,submissionContext.getAMContainerSpec().getApplicationACLs());
  try {
    if (UserGroupInformation.isSecurityEnabled()) {
      this.rmContext.getDelegationTokenRenewer().addApplication(applicationId,parseCredentials(submissionContext),submissionContext.getCancelTokensWhenComplete());
    }
  }
 catch (  IOException ie) {
    LOG.warn("Unable to add the application to the delegation token renewer.",ie);
    this.rmContext.getDispatcher().getEventHandler().handle(new RMAppRejectedEvent(applicationId,ie.getMessage()));
    throw RPCUtil.getRemoteException(ie);
  }
  this.rmContext.getDispatcher().getEventHandler().handle(new RMAppEvent(applicationId,isRecovered ? RMAppEventType.RECOVER : RMAppEventType.START));
}
