{
  if (!isRecovery) {
    if (rmContext.getQueuePlacementManager() != null) {
      rmContext.getQueuePlacementManager().placeApplication(submissionContext,user);
    }
  }
  ApplicationId applicationId=submissionContext.getApplicationId();
  ResourceRequest amReq=validateAndCreateResourceRequest(submissionContext,isRecovery);
  Priority appPriority=rmContext.getScheduler().checkAndGetApplicationPriority(submissionContext.getPriority(),user,submissionContext.getQueue(),applicationId);
  submissionContext.setPriority(appPriority);
  UserGroupInformation userUgi=UserGroupInformation.createRemoteUser(user);
  if (!isRecovery && isAclEnabled && scheduler instanceof CapacityScheduler&& !scheduler.checkAccess(userUgi,QueueACL.SUBMIT_APPLICATIONS,submissionContext.getQueue())&& !scheduler.checkAccess(userUgi,QueueACL.ADMINISTER_QUEUE,submissionContext.getQueue())) {
    throw new AccessControlException("User " + user + " does not have permission to submit "+ applicationId+ " to queue "+ submissionContext.getQueue());
  }
  RMAppImpl application=new RMAppImpl(applicationId,rmContext,this.conf,submissionContext.getApplicationName(),user,submissionContext.getQueue(),submissionContext,this.scheduler,this.masterService,submitTime,submissionContext.getApplicationType(),submissionContext.getApplicationTags(),amReq);
  if (rmContext.getRMApps().putIfAbsent(applicationId,application) != null) {
    String message="Application with id " + applicationId + " is already present! Cannot add a duplicate!";
    LOG.warn(message);
    throw new YarnException(message);
  }
  this.applicationACLsManager.addApplication(applicationId,submissionContext.getAMContainerSpec().getApplicationACLs());
  String appViewACLs=submissionContext.getAMContainerSpec().getApplicationACLs().get(ApplicationAccessType.VIEW_APP);
  rmContext.getSystemMetricsPublisher().appACLsUpdated(application,appViewACLs,System.currentTimeMillis());
  return application;
}
