{
  try {
    cluster.start();
    long session0=cluster.getElector(0).getZKSessionIdForTests();
    long session1=cluster.getElector(1).getZKSessionIdForTests();
    LOG.info("====== Stopping ZK server");
    stopServer();
    waitForServerDown(hostPort,CONNECTION_TIMEOUT);
    LOG.info("====== Waiting for services to enter NEUTRAL mode");
    cluster.waitForElectorState(0,ActiveStandbyElector.State.NEUTRAL);
    cluster.waitForElectorState(1,ActiveStandbyElector.State.NEUTRAL);
    LOG.info("====== Checking that the services didn't change HA state");
    assertEquals(HAServiceState.ACTIVE,cluster.getService(0).state);
    assertEquals(HAServiceState.STANDBY,cluster.getService(1).state);
    LOG.info("====== Restarting server");
    startServer();
    waitForServerUp(hostPort,CONNECTION_TIMEOUT);
    cluster.waitForElectorState(0,ActiveStandbyElector.State.ACTIVE);
    cluster.waitForElectorState(1,ActiveStandbyElector.State.STANDBY);
    cluster.waitForHAState(0,HAServiceState.ACTIVE);
    cluster.waitForHAState(1,HAServiceState.STANDBY);
    assertEquals(session0,cluster.getElector(0).getZKSessionIdForTests());
    assertEquals(session1,cluster.getElector(1).getZKSessionIdForTests());
  }
  finally {
    cluster.stop();
  }
}
