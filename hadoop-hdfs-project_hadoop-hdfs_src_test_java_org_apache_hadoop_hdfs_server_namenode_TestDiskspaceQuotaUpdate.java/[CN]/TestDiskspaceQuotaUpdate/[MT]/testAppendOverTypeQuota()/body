{
  final Path dir=getParent(GenericTestUtils.getMethodName());
  final Path file=new Path(dir,"file");
  getDFS().mkdirs(dir);
  getDFS().setStoragePolicy(dir,HdfsConstants.ONESSD_STORAGE_POLICY_NAME);
  DFSTestUtil.createFile(getDFS(),file,BLOCKSIZE / 2,REPLICATION,seed);
  getDFS().setQuotaByStorageType(dir,StorageType.SSD,1L);
  final INodeDirectory dirNode=getFSDirectory().getINode4Write(dir.toString()).asDirectory();
  final long spaceUsed=dirNode.getDirectoryWithQuotaFeature().getSpaceConsumed().getStorageSpace();
  try {
    DFSTestUtil.appendFile(getDFS(),file,BLOCKSIZE);
    Assert.fail("append didn't fail");
  }
 catch (  QuotaByStorageTypeExceededException e) {
  }
  LeaseManager lm=cluster.getNamesystem().getLeaseManager();
  INodeFile inode=getFSDirectory().getINode(file.toString()).asFile();
  Assert.assertNotNull(inode);
  Assert.assertFalse("should not be UC",inode.isUnderConstruction());
  Assert.assertNull("should not have a lease",lm.getLease(inode));
  final long newSpaceUsed=dirNode.getDirectoryWithQuotaFeature().getSpaceConsumed().getStorageSpace();
  assertEquals(spaceUsed,newSpaceUsed);
  getDFS().recoverLease(file);
  cluster.restartNameNodes();
}
