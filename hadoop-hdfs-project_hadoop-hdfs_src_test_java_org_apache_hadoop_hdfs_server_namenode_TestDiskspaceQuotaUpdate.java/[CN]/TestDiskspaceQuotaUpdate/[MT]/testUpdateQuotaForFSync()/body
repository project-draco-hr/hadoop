{
  final Path foo=new Path("/foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(dfs,bar,BLOCKSIZE,REPLICATION,0L);
  dfs.setQuota(foo,Long.MAX_VALUE - 1,Long.MAX_VALUE - 1);
  FSDataOutputStream out=dfs.append(bar);
  out.write(new byte[BLOCKSIZE / 4]);
  ((DFSOutputStream)out.getWrappedStream()).hsync(EnumSet.of(HdfsDataOutputStream.SyncFlag.UPDATE_LENGTH));
  INodeDirectory fooNode=fsdir.getINode4Write(foo.toString()).asDirectory();
  Quota.Counts quota=fooNode.getDirectoryWithQuotaFeature().getSpaceConsumed();
  long ns=quota.get(Quota.NAMESPACE);
  long ds=quota.get(Quota.DISKSPACE);
  assertEquals(2,ns);
  assertEquals(BLOCKSIZE * 2 * REPLICATION,ds);
  out.write(new byte[BLOCKSIZE / 4]);
  out.close();
  fooNode=fsdir.getINode4Write(foo.toString()).asDirectory();
  quota=fooNode.getDirectoryWithQuotaFeature().getSpaceConsumed();
  ns=quota.get(Quota.NAMESPACE);
  ds=quota.get(Quota.DISKSPACE);
  assertEquals(2,ns);
  assertEquals((BLOCKSIZE + BLOCKSIZE / 2) * REPLICATION,ds);
  DFSTestUtil.appendFile(dfs,bar,BLOCKSIZE);
  quota=fooNode.getDirectoryWithQuotaFeature().getSpaceConsumed();
  ns=quota.get(Quota.NAMESPACE);
  ds=quota.get(Quota.DISKSPACE);
  assertEquals(2,ns);
  assertEquals((BLOCKSIZE * 2 + BLOCKSIZE / 2) * REPLICATION,ds);
}
