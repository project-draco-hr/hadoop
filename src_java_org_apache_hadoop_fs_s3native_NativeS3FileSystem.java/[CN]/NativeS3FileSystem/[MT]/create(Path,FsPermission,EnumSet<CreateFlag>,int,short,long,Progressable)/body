{
  if (exists(f)) {
    if (flag.contains(CreateFlag.APPEND)) {
      return append(f,bufferSize,progress);
    }
 else     if (!flag.contains(CreateFlag.OVERWRITE)) {
      throw new IOException("File already exists: " + f);
    }
  }
 else {
    if (flag.contains(CreateFlag.APPEND) && !flag.contains(CreateFlag.CREATE))     throw new IOException("File already exists: " + f.toString());
  }
  LOG.debug("Creating new file '" + f + "' in S3");
  Path absolutePath=makeAbsolute(f);
  String key=pathToKey(absolutePath);
  return new FSDataOutputStream(new NativeS3FsOutputStream(getConf(),store,key,progress,bufferSize),statistics);
}
