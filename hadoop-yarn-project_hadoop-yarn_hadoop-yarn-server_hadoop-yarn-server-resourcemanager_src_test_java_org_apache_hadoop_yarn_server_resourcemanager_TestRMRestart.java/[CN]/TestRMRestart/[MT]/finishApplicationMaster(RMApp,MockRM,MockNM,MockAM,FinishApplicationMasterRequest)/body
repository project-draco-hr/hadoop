{
  RMState rmState=((MemoryRMStateStore)rm.getRMContext().getStateStore()).getState();
  Map<ApplicationId,ApplicationStateData> rmAppState=rmState.getApplicationState();
  am.unregisterAppAttempt(req,true);
  rm.waitForState(am.getApplicationAttemptId(),RMAppAttemptState.FINISHING);
  nm.nodeHeartbeat(am.getApplicationAttemptId(),1,ContainerState.COMPLETE);
  rm.waitForState(am.getApplicationAttemptId(),RMAppAttemptState.FINISHED);
  rm.waitForState(rmApp.getApplicationId(),RMAppState.FINISHED);
  ApplicationStateData appState=rmAppState.get(rmApp.getApplicationId());
  Assert.assertEquals(RMAppState.FINISHED,appState.getState());
  Assert.assertEquals(RMAppAttemptState.FINISHED,appState.getAttempt(am.getApplicationAttemptId()).getState());
}
