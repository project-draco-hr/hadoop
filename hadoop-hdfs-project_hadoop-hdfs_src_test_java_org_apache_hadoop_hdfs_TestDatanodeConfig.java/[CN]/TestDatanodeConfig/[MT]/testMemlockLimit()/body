{
  assumeTrue(NativeIO.isAvailable());
  final long memlockLimit=NativeIO.getMemlockLimit();
  Configuration conf=cluster.getConfiguration(0);
  conf.setLong(DFSConfigKeys.DFS_DATANODE_MAX_LOCKED_MEMORY_KEY,memlockLimit);
  if (memlockLimit == Long.MAX_VALUE) {
    return;
  }
  DataNode dn=null;
  dn=DataNode.createDataNode(new String[]{},conf);
  dn.shutdown();
  conf.setLong(DFSConfigKeys.DFS_DATANODE_MAX_LOCKED_MEMORY_KEY,memlockLimit + 1);
  try {
    dn=DataNode.createDataNode(new String[]{},conf);
  }
 catch (  RuntimeException e) {
    GenericTestUtils.assertExceptionContains("less than the datanode's available RLIMIT_MEMLOCK",e);
  }
}
