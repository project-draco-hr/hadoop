{
  int numOfAvailableNodes=clusterMap.countNumOfAvailableNodes(nodes,excludedNodes.keySet());
  StringBuilder builder=null;
  if (LOG.isDebugEnabled()) {
    builder=threadLocalBuilder.get();
    builder.setLength(0);
    builder.append("[");
  }
  boolean badTarget=false;
  while (numOfAvailableNodes > 0) {
    DatanodeDescriptor chosenNode=(DatanodeDescriptor)(clusterMap.chooseRandom(nodes));
    Node oldNode=excludedNodes.put(chosenNode,chosenNode);
    if (oldNode == null) {
      numOfAvailableNodes--;
      if (isGoodTarget(chosenNode,blocksize,maxNodesPerRack,results,avoidStaleNodes)) {
        results.add(chosenNode);
        adjustExcludedNodes(excludedNodes,chosenNode);
        return chosenNode;
      }
 else {
        badTarget=true;
      }
    }
  }
  String detail=enableDebugLogging;
  if (LOG.isDebugEnabled()) {
    if (badTarget && builder != null) {
      detail=builder.append("]").toString();
      builder.setLength(0);
    }
 else     detail="";
  }
  throw new NotEnoughReplicasException(detail);
}
