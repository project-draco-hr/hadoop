{
  if (numOfReplicas == 0 || clusterMap.getNumOfLeaves() == 0) {
    return new DatanodeDescriptor[0];
  }
  if (excludedNodes == null) {
    excludedNodes=new HashMap<Node,Node>();
  }
  int[] result=getMaxNodesPerRack(chosenNodes,numOfReplicas);
  numOfReplicas=result[0];
  int maxNodesPerRack=result[1];
  List<DatanodeDescriptor> results=new ArrayList<DatanodeDescriptor>(chosenNodes);
  for (  DatanodeDescriptor node : chosenNodes) {
    addToExcludedNodes(node,excludedNodes);
    adjustExcludedNodes(excludedNodes,node);
  }
  if (!clusterMap.contains(writer)) {
    writer=null;
  }
  boolean avoidStaleNodes=(stats != null && stats.isAvoidingStaleDataNodesForWrite());
  DatanodeDescriptor localNode=chooseTarget(numOfReplicas,writer,excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes);
  if (!returnChosenNodes) {
    results.removeAll(chosenNodes);
  }
  return getPipeline((writer == null) ? localNode : writer,results.toArray(new DatanodeDescriptor[results.size()]));
}
