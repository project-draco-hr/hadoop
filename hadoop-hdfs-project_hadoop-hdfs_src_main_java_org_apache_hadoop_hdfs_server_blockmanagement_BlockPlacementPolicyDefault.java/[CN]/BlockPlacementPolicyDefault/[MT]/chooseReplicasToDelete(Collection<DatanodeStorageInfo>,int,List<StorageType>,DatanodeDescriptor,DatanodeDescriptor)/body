{
  List<DatanodeStorageInfo> excessReplicas=new ArrayList<>();
  final Map<String,List<DatanodeStorageInfo>> rackMap=new HashMap<>();
  final List<DatanodeStorageInfo> moreThanOne=new ArrayList<>();
  final List<DatanodeStorageInfo> exactlyOne=new ArrayList<>();
  splitNodesWithRack(candidates,rackMap,moreThanOne,exactlyOne);
  boolean firstOne=true;
  final DatanodeStorageInfo delNodeHintStorage=DatanodeStorageInfo.getDatanodeStorageInfo(candidates,delNodeHint);
  final DatanodeStorageInfo addedNodeStorage=DatanodeStorageInfo.getDatanodeStorageInfo(candidates,addedNode);
  while (candidates.size() - expectedNumOfReplicas > excessReplicas.size()) {
    final DatanodeStorageInfo cur;
    if (useDelHint(firstOne,delNodeHintStorage,addedNodeStorage,moreThanOne,excessTypes)) {
      cur=delNodeHintStorage;
    }
 else {
      cur=chooseReplicaToDelete((short)expectedNumOfReplicas,moreThanOne,exactlyOne,excessTypes);
    }
    firstOne=false;
    if (cur == null) {
      LOG.warn("No excess replica can be found. excessTypes: {}." + " moreThanOne: {}. exactlyOne: {}.",excessTypes,moreThanOne,exactlyOne);
      break;
    }
    adjustSetsWithChosenReplica(rackMap,moreThanOne,exactlyOne,cur);
    excessReplicas.add(cur);
  }
  return excessReplicas;
}
