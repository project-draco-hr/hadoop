{
  int numOfAvailableNodes=clusterMap.countNumOfAvailableNodes(scope,excludedNodes);
  StringBuilder builder=null;
  if (LOG.isDebugEnabled()) {
    builder=debugLoggingBuilder.get();
    builder.setLength(0);
    builder.append("[");
  }
  boolean goodTarget=false;
  DatanodeStorageInfo firstChosen=null;
  while (numOfReplicas > 0 && numOfAvailableNodes > 0) {
    DatanodeDescriptor chosenNode=(DatanodeDescriptor)clusterMap.chooseRandom(scope);
    if (excludedNodes.add(chosenNode)) {
      numOfAvailableNodes--;
      final DatanodeStorageInfo[] storages=DFSUtil.shuffle(chosenNode.getStorageInfos());
      for (int i=0; i < storages.length && !goodTarget; i++) {
        final int newExcludedNodes=addIfIsGoodTarget(storages[i],excludedNodes,blocksize,maxNodesPerRack,considerLoad,results,avoidStaleNodes,storageType);
        goodTarget=newExcludedNodes >= 0;
        if (goodTarget) {
          numOfReplicas--;
          if (firstChosen == null) {
            firstChosen=storages[i];
          }
          numOfAvailableNodes-=newExcludedNodes;
        }
      }
    }
  }
  if (numOfReplicas > 0) {
    String detail=enableDebugLogging;
    if (LOG.isDebugEnabled()) {
      if (!goodTarget && builder != null) {
        detail=builder.append("]").toString();
        builder.setLength(0);
      }
 else       detail="";
    }
    throw new NotEnoughReplicasException(detail);
  }
  return firstChosen;
}
