{
  if (localMachine == null) {
    return chooseRandom(NodeBase.ROOT,excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes,storageType);
  }
  if (preferLocalNode && localMachine instanceof DatanodeDescriptor) {
    DatanodeDescriptor localDatanode=(DatanodeDescriptor)localMachine;
    if (excludedNodes.add(localMachine)) {
      for (      DatanodeStorageInfo localStorage : DFSUtil.shuffle(localDatanode.getStorageInfos())) {
        if (addIfIsGoodTarget(localStorage,excludedNodes,blocksize,maxNodesPerRack,false,results,avoidStaleNodes,storageType) >= 0) {
          return localStorage;
        }
      }
    }
  }
  if (!fallbackToLocalRack) {
    return null;
  }
  return chooseLocalRack(localMachine,excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes,storageType);
}
