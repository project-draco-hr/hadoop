{
  if (localMachine == null) {
    return chooseRandom(NodeBase.ROOT,excludedNodes,blocksize,maxNodesPerRack,results,avoidStaleNodes,storageTypes);
  }
  if (preferLocalNode && localMachine instanceof DatanodeDescriptor && clusterMap.contains(localMachine)) {
    DatanodeDescriptor localDatanode=(DatanodeDescriptor)localMachine;
    if (excludedNodes.add(localMachine) && isGoodDatanode(localDatanode,maxNodesPerRack,false,results,avoidStaleNodes)) {
      for (Iterator<Map.Entry<StorageType,Integer>> iter=storageTypes.entrySet().iterator(); iter.hasNext(); ) {
        Map.Entry<StorageType,Integer> entry=iter.next();
        DatanodeStorageInfo localStorage=chooseStorage4Block(localDatanode,blocksize,results,entry.getKey());
        if (localStorage != null) {
          addToExcludedNodes(localDatanode,excludedNodes);
          int num=entry.getValue();
          if (num == 1) {
            iter.remove();
          }
 else {
            entry.setValue(num - 1);
          }
          return localStorage;
        }
      }
    }
  }
  return null;
}
