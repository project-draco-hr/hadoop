{
  ClassLoader loader;
  if (useClientClassLoader()) {
    StringBuilder sb=new StringBuilder();
    sb.append(workDir + "/").append(File.pathSeparator).append(file).append(File.pathSeparator).append(workDir + "/classes/").append(File.pathSeparator).append(workDir + "/lib/*");
    String hadoopClasspath=getHadoopClasspath();
    if (hadoopClasspath != null && !hadoopClasspath.isEmpty()) {
      sb.append(File.pathSeparator).append(hadoopClasspath);
    }
    String clientClasspath=sb.toString();
    String systemClasses=getSystemClasses();
    List<String> systemClassesList=systemClasses == null ? null : Arrays.asList(StringUtils.getTrimmedStrings(systemClasses));
    loader=new ApplicationClassLoader(clientClasspath,getClass().getClassLoader(),systemClassesList);
  }
 else {
    List<URL> classPath=new ArrayList<URL>();
    classPath.add(new File(workDir + "/").toURI().toURL());
    classPath.add(file.toURI().toURL());
    classPath.add(new File(workDir,"classes/").toURI().toURL());
    File[] libs=new File(workDir,"lib").listFiles();
    if (libs != null) {
      for (int i=0; i < libs.length; i++) {
        classPath.add(libs[i].toURI().toURL());
      }
    }
    loader=new URLClassLoader(classPath.toArray(new URL[0]));
  }
  return loader;
}
