{
  BPOfferService bpos=setupBPOSForNNs(mockNN1,mockNN2);
  bpos.start();
  try {
    waitForInitialization(bpos);
    assertNull(bpos.getActiveNN());
    mockHaStatuses[0]=new NNHAStatusHeartbeat(State.ACTIVE,1);
    waitForHeartbeats(bpos);
    assertSame(mockNN1,bpos.getActiveNN());
    mockHaStatuses[1]=new NNHAStatusHeartbeat(State.ACTIVE,2);
    waitForHeartbeats(bpos);
    assertSame(mockNN2,bpos.getActiveNN());
    waitForHeartbeats(bpos);
    assertSame(mockNN2,bpos.getActiveNN());
    mockHaStatuses[1]=new NNHAStatusHeartbeat(State.STANDBY,2);
    waitForHeartbeats(bpos);
    assertNull(bpos.getActiveNN());
    mockHaStatuses[0]=new NNHAStatusHeartbeat(State.ACTIVE,3);
    waitForHeartbeats(bpos);
    assertSame(mockNN1,bpos.getActiveNN());
  }
  finally {
    bpos.stop();
  }
}
