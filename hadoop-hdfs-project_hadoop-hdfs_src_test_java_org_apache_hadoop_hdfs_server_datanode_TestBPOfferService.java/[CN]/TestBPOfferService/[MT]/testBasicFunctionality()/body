{
  BPOfferService bpos=setupBPOSForNNs(mockNN1,mockNN2);
  bpos.start();
  try {
    waitForInitialization(bpos);
    Mockito.verify(mockNN1).registerDatanode((DatanodeRegistration)Mockito.anyObject());
    Mockito.verify(mockNN2).registerDatanode((DatanodeRegistration)Mockito.anyObject());
    waitForBlockReport(mockNN1);
    waitForBlockReport(mockNN2);
    bpos.notifyNamenodeReceivedBlock(FAKE_BLOCK,"");
    ReceivedDeletedBlockInfo[] ret=waitForBlockReceived(FAKE_BLOCK,mockNN1);
    assertEquals(1,ret.length);
    assertEquals(FAKE_BLOCK.getLocalBlock(),ret[0].getBlock());
    ret=waitForBlockReceived(FAKE_BLOCK,mockNN2);
    assertEquals(1,ret.length);
    assertEquals(FAKE_BLOCK.getLocalBlock(),ret[0].getBlock());
  }
  finally {
    bpos.stop();
  }
}
