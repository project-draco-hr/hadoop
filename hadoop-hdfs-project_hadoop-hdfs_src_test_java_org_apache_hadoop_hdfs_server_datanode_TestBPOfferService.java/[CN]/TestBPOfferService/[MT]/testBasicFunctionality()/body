{
  BPOfferService bpos=setupBPOSForNNs(mockNN1,mockNN2);
  bpos.start();
  try {
    waitForInitialization(bpos);
    Mockito.verify(mockNN1).registerDatanode(Mockito.any(DatanodeRegistration.class));
    Mockito.verify(mockNN2).registerDatanode(Mockito.any(DatanodeRegistration.class));
    waitForBlockReport(mockNN1);
    waitForBlockReport(mockNN2);
    bpos.notifyNamenodeReceivedBlock(FAKE_BLOCK,"");
    ReceivedDeletedBlockInfo[] ret=waitForBlockReceived(FAKE_BLOCK,mockNN1);
    assertEquals(1,ret.length);
    assertEquals(FAKE_BLOCK.getLocalBlock(),ret[0].getBlock());
    ret=waitForBlockReceived(FAKE_BLOCK,mockNN2);
    assertEquals(1,ret.length);
    assertEquals(FAKE_BLOCK.getLocalBlock(),ret[0].getBlock());
  }
  finally {
    bpos.stop();
  }
}
