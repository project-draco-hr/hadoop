{
  BPOfferService bpos=setupBPOSForNNs(mockNN1,mockNN2);
  bpos.start();
  try {
    waitForInitialization(bpos);
    assertNull(bpos.getActiveNN());
    mockHaStatuses[0]=new NNHAStatusHeartbeat(HAServiceState.ACTIVE,1);
    bpos.triggerHeartbeatForTests();
    assertSame(mockNN1,bpos.getActiveNN());
    Mockito.doNothing().when(mockNN1).reportBadBlocks(Mockito.any(LocatedBlock[].class));
    RemoteException re=new RemoteException(StandbyException.class.getName(),"Operation category WRITE is not supported in state " + "standby",RpcErrorCodeProto.ERROR_APPLICATION);
    Mockito.doThrow(re).when(mockNN2).reportBadBlocks(Mockito.any(LocatedBlock[].class));
    bpos.reportBadBlocks(FAKE_BLOCK,mockFSDataset.getVolume(FAKE_BLOCK).getStorageID(),mockFSDataset.getVolume(FAKE_BLOCK).getStorageType());
    bpos.triggerHeartbeatForTests();
    Mockito.verify(mockNN2,Mockito.times(1)).reportBadBlocks(Mockito.any(LocatedBlock[].class));
    bpos.triggerHeartbeatForTests();
    Mockito.verify(mockNN2,Mockito.times(1)).reportBadBlocks(Mockito.any(LocatedBlock[].class));
  }
  finally {
    bpos.stop();
  }
}
