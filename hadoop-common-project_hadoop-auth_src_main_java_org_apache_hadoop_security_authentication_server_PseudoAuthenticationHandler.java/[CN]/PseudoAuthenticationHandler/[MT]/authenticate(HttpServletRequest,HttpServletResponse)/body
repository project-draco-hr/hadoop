{
  AuthenticationToken token;
  String userName=getUserName(request);
  if (userName == null) {
    if (getAcceptAnonymous()) {
      token=AuthenticationToken.ANONYMOUS;
    }
 else {
      throw new AuthenticationException("Anonymous requests are disallowed");
    }
  }
 else {
    token=new AuthenticationToken(userName,userName,getType());
  }
  return token;
}
