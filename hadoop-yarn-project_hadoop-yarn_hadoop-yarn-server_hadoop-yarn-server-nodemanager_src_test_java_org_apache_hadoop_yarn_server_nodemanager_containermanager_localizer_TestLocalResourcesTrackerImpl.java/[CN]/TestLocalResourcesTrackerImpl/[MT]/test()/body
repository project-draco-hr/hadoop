{
  String user="testuser";
  DrainDispatcher dispatcher=null;
  try {
    Configuration conf=new Configuration();
    dispatcher=createDispatcher(conf);
    EventHandler<LocalizerEvent> localizerEventHandler=mock(EventHandler.class);
    EventHandler<LocalizerEvent> containerEventHandler=mock(EventHandler.class);
    dispatcher.register(LocalizerEventType.class,localizerEventHandler);
    dispatcher.register(ContainerEventType.class,containerEventHandler);
    DeletionService mockDelService=mock(DeletionService.class);
    ContainerId cId1=BuilderUtils.newContainerId(1,1,1,1);
    LocalizerContext lc1=new LocalizerContext(user,cId1,null);
    ContainerId cId2=BuilderUtils.newContainerId(1,1,1,2);
    LocalizerContext lc2=new LocalizerContext(user,cId2,null);
    LocalResourceRequest req1=createLocalResourceRequest(user,1,1,LocalResourceVisibility.PUBLIC);
    LocalResourceRequest req2=createLocalResourceRequest(user,2,1,LocalResourceVisibility.PUBLIC);
    LocalizedResource lr1=createLocalizedResource(req1,dispatcher);
    LocalizedResource lr2=createLocalizedResource(req2,dispatcher);
    ConcurrentMap<LocalResourceRequest,LocalizedResource> localrsrc=new ConcurrentHashMap<LocalResourceRequest,LocalizedResource>();
    localrsrc.put(req1,lr1);
    localrsrc.put(req2,lr2);
    LocalResourcesTracker tracker=new LocalResourcesTrackerImpl(user,null,dispatcher,localrsrc,false,conf,new NMNullStateStoreService());
    ResourceEvent req11Event=new ResourceRequestEvent(req1,LocalResourceVisibility.PUBLIC,lc1);
    ResourceEvent req12Event=new ResourceRequestEvent(req1,LocalResourceVisibility.PUBLIC,lc2);
    ResourceEvent req21Event=new ResourceRequestEvent(req2,LocalResourceVisibility.PUBLIC,lc1);
    ResourceEvent rel11Event=new ResourceReleaseEvent(req1,cId1);
    ResourceEvent rel12Event=new ResourceReleaseEvent(req1,cId2);
    ResourceEvent rel21Event=new ResourceReleaseEvent(req2,cId1);
    tracker.handle(req11Event);
    tracker.handle(req12Event);
    tracker.handle(req21Event);
    dispatcher.await();
    verify(localizerEventHandler,times(3)).handle(any(LocalizerResourceRequestEvent.class));
    Assert.assertEquals(2,lr1.getRefCount());
    Assert.assertEquals(1,lr2.getRefCount());
    tracker.handle(rel21Event);
    dispatcher.await();
    verifyTrackedResourceCount(tracker,2);
    Assert.assertEquals(2,lr1.getRefCount());
    Assert.assertFalse(tracker.remove(lr1,mockDelService));
    verifyTrackedResourceCount(tracker,2);
    ResourceLocalizedEvent rle=new ResourceLocalizedEvent(req1,new Path("file:///tmp/r1"),1);
    lr1.handle(rle);
    Assert.assertTrue(lr1.getState().equals(ResourceState.LOCALIZED));
    tracker.handle(rel11Event);
    tracker.handle(rel12Event);
    Assert.assertEquals(0,lr1.getRefCount());
    Assert.assertTrue(tracker.remove(lr1,mockDelService));
    verifyTrackedResourceCount(tracker,1);
  }
  finally {
    if (dispatcher != null) {
      dispatcher.stop();
    }
  }
}
