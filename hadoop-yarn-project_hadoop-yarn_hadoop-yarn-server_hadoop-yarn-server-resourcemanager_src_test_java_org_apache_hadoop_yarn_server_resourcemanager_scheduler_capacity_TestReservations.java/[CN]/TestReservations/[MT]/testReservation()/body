{
  CapacitySchedulerConfiguration csConf=new CapacitySchedulerConfiguration();
  setup(csConf);
  LeafQueue a=stubLeafQueue((LeafQueue)queues.get(A));
  final String user_0="user_0";
  final ApplicationAttemptId appAttemptId_0=TestUtils.getMockApplicationAttemptId(0,0);
  FiCaSchedulerApp app_0=new FiCaSchedulerApp(appAttemptId_0,user_0,a,mock(ActiveUsersManager.class),spyRMContext);
  a.submitApplicationAttempt(app_0,user_0);
  final ApplicationAttemptId appAttemptId_1=TestUtils.getMockApplicationAttemptId(1,0);
  FiCaSchedulerApp app_1=new FiCaSchedulerApp(appAttemptId_1,user_0,a,mock(ActiveUsersManager.class),spyRMContext);
  a.submitApplicationAttempt(app_1,user_0);
  String host_0="host_0";
  FiCaSchedulerNode node_0=TestUtils.getMockNode(host_0,DEFAULT_RACK,0,8 * GB);
  String host_1="host_1";
  FiCaSchedulerNode node_1=TestUtils.getMockNode(host_1,DEFAULT_RACK,0,8 * GB);
  String host_2="host_2";
  FiCaSchedulerNode node_2=TestUtils.getMockNode(host_2,DEFAULT_RACK,0,8 * GB);
  when(csContext.getNode(node_0.getNodeID())).thenReturn(node_0);
  when(csContext.getNode(node_1.getNodeID())).thenReturn(node_1);
  when(csContext.getNode(node_2.getNodeID())).thenReturn(node_2);
  final int numNodes=3;
  Resource clusterResource=Resources.createResource(numNodes * (8 * GB));
  when(csContext.getNumClusterNodes()).thenReturn(numNodes);
  Priority priorityAM=TestUtils.createMockPriority(1);
  Priority priorityMap=TestUtils.createMockPriority(5);
  Priority priorityReduce=TestUtils.createMockPriority(10);
  app_0.updateResourceRequests(Collections.singletonList(TestUtils.createResourceRequest(ResourceRequest.ANY,2 * GB,1,true,priorityAM,recordFactory)));
  app_0.updateResourceRequests(Collections.singletonList(TestUtils.createResourceRequest(ResourceRequest.ANY,5 * GB,2,true,priorityReduce,recordFactory)));
  app_0.updateResourceRequests(Collections.singletonList(TestUtils.createResourceRequest(ResourceRequest.ANY,3 * GB,2,true,priorityMap,recordFactory)));
  a.assignContainers(clusterResource,node_0,false,new ResourceLimits(clusterResource));
  assertEquals(2 * GB,a.getUsedResources().getMemory());
  assertEquals(2 * GB,app_0.getCurrentConsumption().getMemory());
  assertEquals(0 * GB,a.getMetrics().getReservedMB());
  assertEquals(2 * GB,a.getMetrics().getAllocatedMB());
  assertEquals(22 * GB,a.getMetrics().getAvailableMB());
  assertEquals(2 * GB,node_0.getUsedResource().getMemory());
  assertEquals(0 * GB,node_1.getUsedResource().getMemory());
  assertEquals(0 * GB,node_2.getUsedResource().getMemory());
  a.assignContainers(clusterResource,node_0,false,new ResourceLimits(clusterResource));
  assertEquals(5 * GB,a.getUsedResources().getMemory());
  assertEquals(5 * GB,app_0.getCurrentConsumption().getMemory());
  assertEquals(0 * GB,a.getMetrics().getReservedMB());
  assertEquals(5 * GB,a.getMetrics().getAllocatedMB());
  assertEquals(19 * GB,a.getMetrics().getAvailableMB());
  assertEquals(5 * GB,node_0.getUsedResource().getMemory());
  assertEquals(0 * GB,node_1.getUsedResource().getMemory());
  assertEquals(0 * GB,node_2.getUsedResource().getMemory());
  a.assignContainers(clusterResource,node_1,false,new ResourceLimits(clusterResource));
  assertEquals(8 * GB,a.getUsedResources().getMemory());
  assertEquals(8 * GB,app_0.getCurrentConsumption().getMemory());
  assertEquals(0 * GB,a.getMetrics().getReservedMB());
  assertEquals(8 * GB,a.getMetrics().getAllocatedMB());
  assertEquals(16 * GB,a.getMetrics().getAvailableMB());
  assertEquals(16 * GB,app_0.getHeadroom().getMemory());
  assertEquals(null,node_0.getReservedContainer());
  assertEquals(5 * GB,node_0.getUsedResource().getMemory());
  assertEquals(3 * GB,node_1.getUsedResource().getMemory());
  assertEquals(0 * GB,node_2.getUsedResource().getMemory());
  assertEquals(2,app_0.getTotalRequiredResources(priorityReduce));
  a.assignContainers(clusterResource,node_0,false,new ResourceLimits(clusterResource));
  assertEquals(13 * GB,a.getUsedResources().getMemory());
  assertEquals(8 * GB,app_0.getCurrentConsumption().getMemory());
  assertEquals(5 * GB,a.getMetrics().getReservedMB());
  assertEquals(8 * GB,a.getMetrics().getAllocatedMB());
  assertEquals(11 * GB,a.getMetrics().getAvailableMB());
  assertEquals(11 * GB,app_0.getHeadroom().getMemory());
  assertEquals(5 * GB,node_0.getReservedContainer().getReservedResource().getMemory());
  assertEquals(5 * GB,node_0.getUsedResource().getMemory());
  assertEquals(3 * GB,node_1.getUsedResource().getMemory());
  assertEquals(0 * GB,node_2.getUsedResource().getMemory());
  assertEquals(2,app_0.getTotalRequiredResources(priorityReduce));
  a.assignContainers(clusterResource,node_2,false,new ResourceLimits(clusterResource));
  assertEquals(18 * GB,a.getUsedResources().getMemory());
  assertEquals(13 * GB,app_0.getCurrentConsumption().getMemory());
  assertEquals(5 * GB,a.getMetrics().getReservedMB());
  assertEquals(13 * GB,a.getMetrics().getAllocatedMB());
  assertEquals(6 * GB,a.getMetrics().getAvailableMB());
  assertEquals(6 * GB,app_0.getHeadroom().getMemory());
  assertEquals(5 * GB,node_0.getReservedContainer().getReservedResource().getMemory());
  assertEquals(5 * GB,node_0.getUsedResource().getMemory());
  assertEquals(3 * GB,node_1.getUsedResource().getMemory());
  assertEquals(5 * GB,node_2.getUsedResource().getMemory());
  assertEquals(1,app_0.getTotalRequiredResources(priorityReduce));
  a.assignContainers(clusterResource,node_1,false,new ResourceLimits(clusterResource));
  assertEquals(18 * GB,a.getUsedResources().getMemory());
  assertEquals(18 * GB,app_0.getCurrentConsumption().getMemory());
  assertEquals(0 * GB,a.getMetrics().getReservedMB());
  assertEquals(18 * GB,a.getMetrics().getAllocatedMB());
  assertEquals(6 * GB,a.getMetrics().getAvailableMB());
  assertEquals(6 * GB,app_0.getHeadroom().getMemory());
  assertEquals(null,node_0.getReservedContainer());
  assertEquals(5 * GB,node_0.getUsedResource().getMemory());
  assertEquals(8 * GB,node_1.getUsedResource().getMemory());
  assertEquals(5 * GB,node_2.getUsedResource().getMemory());
  assertEquals(0,app_0.getTotalRequiredResources(priorityReduce));
}
