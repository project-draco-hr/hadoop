{
  while (running) {
    SelectionKey key=null;
    try {
      int size=pendingConnections.size();
      for (int i=size; i > 0; i--) {
        Connection conn=pendingConnections.take();
        conn.channel.register(readSelector,SelectionKey.OP_READ,conn);
      }
      readSelector.select();
      Iterator<SelectionKey> iter=readSelector.selectedKeys().iterator();
      while (iter.hasNext()) {
        key=iter.next();
        iter.remove();
        try {
          if (key.isReadable()) {
            doRead(key);
          }
        }
 catch (        CancelledKeyException cke) {
          LOG.info(Thread.currentThread().getName() + ": connection aborted from " + key.attachment());
        }
        key=null;
      }
    }
 catch (    InterruptedException e) {
      if (running) {
        LOG.info(Thread.currentThread().getName() + " unexpectedly interrupted",e);
      }
    }
catch (    IOException ex) {
      LOG.error("Error in Reader",ex);
    }
catch (    Throwable re) {
      LOG.fatal("Bug in read selector!",re);
      ExitUtil.terminate(1,"Bug in read selector!");
    }
  }
}
