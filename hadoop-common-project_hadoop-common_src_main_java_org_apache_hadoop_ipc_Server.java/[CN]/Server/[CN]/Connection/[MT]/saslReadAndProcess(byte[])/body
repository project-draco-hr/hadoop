{
  if (!saslContextEstablished) {
    byte[] replyToken=null;
    try {
      if (LOG.isDebugEnabled())       LOG.debug("Have read input token of size " + saslToken.length + " for processing by saslServer.evaluateResponse()");
      replyToken=saslServer.evaluateResponse(saslToken);
    }
 catch (    IOException e) {
      IOException sendToClient=e;
      Throwable cause=e;
      while (cause != null) {
        if (cause instanceof InvalidToken) {
          sendToClient=(InvalidToken)cause;
          break;
        }
        cause=cause.getCause();
      }
      doSaslReply(SaslStatus.ERROR,null,sendToClient.getClass().getName(),sendToClient.getLocalizedMessage());
      rpcMetrics.incrAuthenticationFailures();
      String clientIP=this.toString();
      AUDITLOG.warn(AUTH_FAILED_FOR + clientIP + ":"+ attemptingUser+ " ("+ e.getLocalizedMessage()+ ")");
      throw e;
    }
    if (saslServer.isComplete() && replyToken == null) {
      replyToken=new byte[0];
    }
    if (replyToken != null) {
      if (LOG.isDebugEnabled())       LOG.debug("Will send token of size " + replyToken.length + " from saslServer.");
      doSaslReply(SaslStatus.SUCCESS,new BytesWritable(replyToken),null,null);
    }
    if (saslServer.isComplete()) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("SASL server context established. Negotiated QoP is " + saslServer.getNegotiatedProperty(Sasl.QOP));
      }
      String qop=(String)saslServer.getNegotiatedProperty(Sasl.QOP);
      useWrap=qop != null && !"auth".equalsIgnoreCase(qop);
      user=getAuthorizedUgi(saslServer.getAuthorizationID());
      if (LOG.isDebugEnabled()) {
        LOG.debug("SASL server successfully authenticated client: " + user);
      }
      rpcMetrics.incrAuthenticationSuccesses();
      AUDITLOG.info(AUTH_SUCCESSFUL_FOR + user);
      saslContextEstablished=true;
    }
  }
 else {
    if (LOG.isDebugEnabled())     LOG.debug("Have read input token of size " + saslToken.length + " for processing by saslServer.unwrap()");
    if (!useWrap) {
      processOneRpc(saslToken);
    }
 else {
      byte[] plaintextData=saslServer.unwrap(saslToken,0,saslToken.length);
      processUnwrappedData(plaintextData);
    }
  }
}
