{
  DataInputStream dis=new DataInputStream(new ByteArrayInputStream(buf));
  RpcPayloadHeader header=new RpcPayloadHeader();
  header.readFields(dis);
  if (LOG.isDebugEnabled())   LOG.debug(" got #" + header.getCallId());
  if (header.getOperation() != RpcPayloadOperation.RPC_FINAL_PAYLOAD) {
    throw new IOException("IPC Server does not implement operation" + header.getOperation());
  }
  Class<? extends Writable> rpcRequestClass=getRpcRequestWrapper(header.getkind());
  if (rpcRequestClass == null) {
    LOG.warn("Unknown rpc kind " + header.getkind() + " from client "+ getHostAddress());
    final Call readParamsFailedCall=new Call(header.getCallId(),null,this);
    ByteArrayOutputStream responseBuffer=new ByteArrayOutputStream();
    setupResponse(responseBuffer,readParamsFailedCall,Status.FATAL,null,IOException.class.getName(),"Unknown rpc kind " + header.getkind());
    responder.doRespond(readParamsFailedCall);
    return;
  }
  Writable rpcRequest;
  try {
    rpcRequest=ReflectionUtils.newInstance(rpcRequestClass,conf);
    rpcRequest.readFields(dis);
  }
 catch (  Throwable t) {
    LOG.warn("Unable to read call parameters for client " + getHostAddress() + "on connection protocol "+ this.protocolName+ " for rpcKind "+ header.getkind(),t);
    final Call readParamsFailedCall=new Call(header.getCallId(),null,this);
    ByteArrayOutputStream responseBuffer=new ByteArrayOutputStream();
    setupResponse(responseBuffer,readParamsFailedCall,Status.FATAL,null,t.getClass().getName(),"IPC server unable to read call parameters: " + t.getMessage());
    responder.doRespond(readParamsFailedCall);
    return;
  }
  Call call=new Call(header.getCallId(),rpcRequest,this,header.getkind());
  callQueue.put(call);
  incRpcCount();
}
