{
  RpcResponseHeaderProto.Builder headerBuilder=RpcResponseHeaderProto.newBuilder();
  headerBuilder.setClientId(ByteString.copyFrom(call.clientId));
  headerBuilder.setCallId(call.callId);
  headerBuilder.setRetryCount(call.retryCount);
  headerBuilder.setStatus(status);
  headerBuilder.setServerIpcVersionNum(CURRENT_VERSION);
  if (status == RpcStatusProto.SUCCESS) {
    RpcResponseHeaderProto header=headerBuilder.build();
    try {
      setupResponse(call,header,rv);
    }
 catch (    Throwable t) {
      LOG.warn("Error serializing call response for call " + call,t);
      setupResponse(call,RpcStatusProto.ERROR,RpcErrorCodeProto.ERROR_SERIALIZING_RESPONSE,null,t.getClass().getName(),StringUtils.stringifyException(t));
      return;
    }
  }
 else {
    headerBuilder.setExceptionClassName(errorClass);
    headerBuilder.setErrorMsg(error);
    headerBuilder.setErrorDetail(erCode);
    setupResponse(call,headerBuilder.build(),null);
  }
}
