{
  final RpcSaslProto saslResponse;
  final SaslState state=saslMessage.getState();
switch (state) {
case NEGOTIATE:
{
      if (sentNegotiate) {
        throw new AccessControlException("Client already attempted negotiation");
      }
      saslResponse=buildSaslNegotiateResponse();
      if (saslResponse.getState() == SaslState.SUCCESS) {
        switchToSimple();
      }
      break;
    }
case INITIATE:
{
    if (saslMessage.getAuthsCount() != 1) {
      throw new SaslException("Client mechanism is malformed");
    }
    SaslAuth clientSaslAuth=saslMessage.getAuths(0);
    if (!negotiateResponse.getAuthsList().contains(clientSaslAuth)) {
      if (sentNegotiate) {
        throw new AccessControlException(clientSaslAuth.getMethod() + " authentication is not enabled." + "  Available:"+ enabledAuthMethods);
      }
      saslResponse=buildSaslNegotiateResponse();
      break;
    }
    authMethod=AuthMethod.valueOf(clientSaslAuth.getMethod());
    if (authMethod == AuthMethod.SIMPLE) {
      switchToSimple();
      saslResponse=null;
      break;
    }
    if (saslServer == null || authMethod != AuthMethod.TOKEN) {
      saslServer=createSaslServer(authMethod);
    }
    saslResponse=processSaslToken(saslMessage);
    break;
  }
case RESPONSE:
{
  saslResponse=processSaslToken(saslMessage);
  break;
}
default :
throw new SaslException("Client sent unsupported state " + state);
}
return saslResponse;
}
