{
  if (ckptState != CheckpointStates.UPLOAD_DONE && !(ckptState == CheckpointStates.ROLLED_EDITS && storage.getNumStorageDirs(NameNodeDirType.IMAGE) == 0)) {
    throw new IOException("Cannot roll fsImage before rolling edits log.");
  }
  for (Iterator<StorageDirectory> it=storage.dirIterator(NameNodeDirType.IMAGE); it.hasNext(); ) {
    StorageDirectory sd=it.next();
    File ckpt=NNStorage.getStorageFile(sd,NameNodeFile.IMAGE_NEW);
    if (!ckpt.exists()) {
      throw new IOException("Checkpoint file " + ckpt + " does not exist");
    }
  }
  editLog.purgeEditLog();
  if (LOG.isDebugEnabled()) {
    LOG.debug("rollFSImage after purgeEditLog: storageList=" + storage.listStorageDirectories());
  }
  renameCheckpoint();
  resetVersion(renewCheckpointTime,newImageDigest);
}
