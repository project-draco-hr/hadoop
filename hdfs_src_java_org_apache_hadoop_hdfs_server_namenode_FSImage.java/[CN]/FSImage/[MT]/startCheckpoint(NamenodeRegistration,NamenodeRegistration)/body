{
  String msg=null;
  if (bnReg.getNamespaceID() != storage.getNamespaceID())   msg="Name node " + bnReg.getAddress() + " has incompatible namespace id: "+ bnReg.getNamespaceID()+ " expected: "+ storage.getNamespaceID();
 else   if (bnReg.isRole(NamenodeRole.ACTIVE))   msg="Name node " + bnReg.getAddress() + " role "+ bnReg.getRole()+ ": checkpoint is not allowed.";
 else   if (bnReg.getLayoutVersion() < storage.getLayoutVersion() || (bnReg.getLayoutVersion() == storage.getLayoutVersion() && bnReg.getCTime() > storage.getCTime()) || (bnReg.getLayoutVersion() == storage.getLayoutVersion() && bnReg.getCTime() == storage.getCTime() && bnReg.getCheckpointTime() > storage.getCheckpointTime()))   msg="Name node " + bnReg.getAddress() + " has newer image layout version: LV = "+ bnReg.getLayoutVersion()+ " cTime = "+ bnReg.getCTime()+ " checkpointTime = "+ bnReg.getCheckpointTime()+ ". Current version: LV = "+ storage.getLayoutVersion()+ " cTime = "+ storage.getCTime()+ " checkpointTime = "+ storage.getCheckpointTime();
  if (msg != null) {
    LOG.error(msg);
    return new NamenodeCommand(NamenodeProtocol.ACT_SHUTDOWN);
  }
  boolean isImgObsolete=true;
  if (bnReg.getLayoutVersion() == storage.getLayoutVersion() && bnReg.getCTime() == storage.getCTime() && bnReg.getCheckpointTime() == storage.getCheckpointTime())   isImgObsolete=false;
  boolean needToReturnImg=true;
  if (storage.getNumStorageDirs(NameNodeDirType.IMAGE) == 0)   needToReturnImg=false;
  CheckpointSignature sig=rollEditLog();
  getEditLog().logJSpoolStart(bnReg,nnReg);
  return new CheckpointCommand(sig,isImgObsolete,needToReturnImg);
}
