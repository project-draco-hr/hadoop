{
  ArrayList<StorageDirectory> al=null;
  for (Iterator<StorageDirectory> it=storage.dirIterator(NameNodeDirType.IMAGE); it.hasNext(); ) {
    StorageDirectory sd=it.next();
    File ckpt=NNStorage.getStorageFile(sd,NameNodeFile.IMAGE_NEW);
    File curFile=NNStorage.getStorageFile(sd,NameNodeFile.IMAGE);
    if (LOG.isDebugEnabled()) {
      LOG.debug("renaming  " + ckpt.getAbsolutePath() + " to "+ curFile.getAbsolutePath());
    }
    if (!ckpt.renameTo(curFile)) {
      if (!curFile.delete() || !ckpt.renameTo(curFile)) {
        LOG.warn("renaming  " + ckpt.getAbsolutePath() + " to "+ curFile.getAbsolutePath()+ " FAILED");
        if (al == null)         al=new ArrayList<StorageDirectory>(1);
        al.add(sd);
      }
    }
  }
  if (al != null)   storage.reportErrorsOnDirectories(al);
}
