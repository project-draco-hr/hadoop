{
  FSImageFormat.Loader loader=new FSImageFormat.Loader(conf,getFSNamesystem());
  loader.load(curFile);
  namesystem.setBlockPoolId(this.getBlockPoolID());
  MD5Hash readImageMd5=loader.getLoadedImageMd5();
  if (storage.getImageDigest() == null) {
    storage.setImageDigest(readImageMd5);
  }
 else   if (!storage.getImageDigest().equals(readImageMd5)) {
    throw new IOException("Image file " + curFile + " is corrupt with MD5 checksum of "+ readImageMd5+ " but expecting "+ storage.getImageDigest());
  }
  storage.namespaceID=loader.getLoadedNamespaceID();
  storage.layoutVersion=loader.getLoadedImageVersion();
  boolean needToSave=loader.getLoadedImageVersion() != FSConstants.LAYOUT_VERSION;
  return needToSave;
}
