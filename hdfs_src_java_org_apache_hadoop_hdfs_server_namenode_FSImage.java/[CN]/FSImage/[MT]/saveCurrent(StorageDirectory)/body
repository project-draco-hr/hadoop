{
  if (storage.getLayoutVersion() != FSConstants.LAYOUT_VERSION) {
    throw new IllegalStateException("NN with storage version " + FSConstants.LAYOUT_VERSION + "cannot save an image with version "+ storage.getLayoutVersion());
  }
  File curDir=sd.getCurrentDir();
  NameNodeDirType dirType=(NameNodeDirType)sd.getStorageDirType();
  if (!curDir.exists() && !curDir.mkdir())   throw new IOException("Cannot create directory " + curDir);
  if (dirType.isOfType(NameNodeDirType.IMAGE))   saveFSImage(NNStorage.getStorageFile(sd,NameNodeFile.IMAGE));
  if (dirType.isOfType(NameNodeDirType.EDITS))   editLog.createEditLogFile(NNStorage.getStorageFile(sd,NameNodeFile.EDITS));
  sd.write();
}
