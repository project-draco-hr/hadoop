{
  Configuration conf=new HdfsConfiguration();
  conf.set(HdfsClientConfigKeys.DFS_CLIENT_DATANODE_RESTART_TIMEOUT_KEY,"15");
  MiniDFSCluster cluster=null;
  try {
    int numDataNodes=1;
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(numDataNodes).build();
    cluster.waitActive();
    FileSystem fileSys=cluster.getFileSystem();
    Path file=new Path("dataprotocol2.dat");
    DFSTestUtil.createFile(fileSys,file,10240L,(short)1,0L);
    DFSOutputStream out=(DFSOutputStream)(fileSys.append(file).getWrappedStream());
    out.write(1);
    out.hflush();
    DFSAdmin dfsadmin=new DFSAdmin(conf);
    DataNode dn=cluster.getDataNodes().get(0);
    final String dnAddr=dn.getDatanodeId().getIpcAddr(false);
    final String[] args1={"-shutdownDatanode",dnAddr,"upgrade"};
    Assert.assertEquals(0,dfsadmin.run(args1));
    Thread.sleep(4000);
    cluster.restartDataNode(0,true);
    out.close();
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
