{
  RPC.setProtocolEngine(conf,ClientNamenodeProtocolPB.class,ProtobufRpcEngine.class);
  final RetryPolicy defaultPolicy=RetryUtils.getDefaultRetryPolicy(conf,HdfsClientConfigKeys.Retry.POLICY_ENABLED_KEY,HdfsClientConfigKeys.Retry.POLICY_ENABLED_DEFAULT,HdfsClientConfigKeys.Retry.POLICY_SPEC_KEY,HdfsClientConfigKeys.Retry.POLICY_SPEC_DEFAULT,SafeModeException.class.getName());
  final long version=RPC.getProtocolVersion(ClientNamenodeProtocolPB.class);
  ClientNamenodeProtocolPB proxy=RPC.getProtocolProxy(ClientNamenodeProtocolPB.class,version,address,ugi,conf,NetUtils.getDefaultSocketFactory(conf),org.apache.hadoop.ipc.Client.getTimeout(conf),defaultPolicy,fallbackToSimpleAuth).getProxy();
  if (withRetries) {
    RetryPolicy createPolicy=RetryPolicies.retryUpToMaximumCountWithFixedSleep(5,HdfsServerConstants.LEASE_SOFTLIMIT_PERIOD,TimeUnit.MILLISECONDS);
    Map<Class<? extends Exception>,RetryPolicy> remoteExceptionToPolicyMap=new HashMap<Class<? extends Exception>,RetryPolicy>();
    remoteExceptionToPolicyMap.put(AlreadyBeingCreatedException.class,createPolicy);
    RetryPolicy methodPolicy=RetryPolicies.retryByRemoteException(defaultPolicy,remoteExceptionToPolicyMap);
    Map<String,RetryPolicy> methodNameToPolicyMap=new HashMap<String,RetryPolicy>();
    methodNameToPolicyMap.put("create",methodPolicy);
    ClientProtocol translatorProxy=new ClientNamenodeProtocolTranslatorPB(proxy);
    return (ClientProtocol)RetryProxy.create(ClientProtocol.class,new DefaultFailoverProxyProvider<ClientProtocol>(ClientProtocol.class,translatorProxy),methodNameToPolicyMap,defaultPolicy);
  }
 else {
    return new ClientNamenodeProtocolTranslatorPB(proxy);
  }
}
