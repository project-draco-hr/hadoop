{
  storage.analyzeStorage(nsInfo);
  if (epoch <= getLastPromisedEpoch()) {
    throw new IOException("Proposed epoch " + epoch + " <= last promise "+ getLastPromisedEpoch());
  }
  lastPromisedEpoch.set(epoch);
  if (curSegment != null) {
    curSegment.close();
    curSegment=null;
  }
  NewEpochResponseProto.Builder builder=NewEpochResponseProto.newBuilder();
  scanStorage();
  if (curSegmentTxId != HdfsConstants.INVALID_TXID) {
    builder.setLastSegmentTxId(curSegmentTxId);
  }
  return builder.build();
}
