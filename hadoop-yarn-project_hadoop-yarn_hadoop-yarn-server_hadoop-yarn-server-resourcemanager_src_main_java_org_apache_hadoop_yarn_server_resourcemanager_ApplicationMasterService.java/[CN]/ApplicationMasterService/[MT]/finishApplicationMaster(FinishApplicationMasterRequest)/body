{
  ApplicationAttemptId applicationAttemptId=authorizeRequest();
  AllocateResponseLock lock=responseMap.get(applicationAttemptId);
  if (lock == null) {
    throwApplicationDoesNotExistInCacheException(applicationAttemptId);
  }
synchronized (lock) {
    this.amLivelinessMonitor.receivedPing(applicationAttemptId);
    RMApp rmApp=rmContext.getRMApps().get(applicationAttemptId.getApplicationId());
    if (rmApp.getApplicationSubmissionContext().getUnmanagedAM()) {
      rmContext.getDispatcher().getEventHandler().handle(new RMAppAttemptUnregistrationEvent(applicationAttemptId,request.getTrackingUrl(),request.getFinalApplicationStatus(),request.getDiagnostics()));
      return FinishApplicationMasterResponse.newInstance(true);
    }
    if (rmApp.isAppSafeToTerminate()) {
      return FinishApplicationMasterResponse.newInstance(true);
    }
 else {
      rmContext.getDispatcher().getEventHandler().handle(new RMAppAttemptUnregistrationEvent(applicationAttemptId,request.getTrackingUrl(),request.getFinalApplicationStatus(),request.getDiagnostics()));
      return FinishApplicationMasterResponse.newInstance(false);
    }
  }
}
