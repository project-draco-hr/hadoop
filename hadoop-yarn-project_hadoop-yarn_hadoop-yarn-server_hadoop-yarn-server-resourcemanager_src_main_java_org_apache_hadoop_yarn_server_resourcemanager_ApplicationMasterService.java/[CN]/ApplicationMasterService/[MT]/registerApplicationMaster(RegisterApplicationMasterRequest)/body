{
  ApplicationAttemptId applicationAttemptId=authorizeRequest();
  ApplicationId appID=applicationAttemptId.getApplicationId();
  AllocateResponse lastResponse=responseMap.get(applicationAttemptId);
  if (lastResponse == null) {
    String message="Application doesn't exist in cache " + applicationAttemptId;
    LOG.error(message);
    RMAuditLogger.logFailure(this.rmContext.getRMApps().get(appID).getUser(),AuditConstants.REGISTER_AM,message,"ApplicationMasterService","Error in registering application master",appID,applicationAttemptId);
    throw RPCUtil.getRemoteException(message);
  }
synchronized (lastResponse) {
    if (hasApplicationMasterRegistered(applicationAttemptId)) {
      String message="Application Master is already registered : " + applicationAttemptId.getApplicationId();
      LOG.warn(message);
      RMAuditLogger.logFailure(this.rmContext.getRMApps().get(applicationAttemptId.getApplicationId()).getUser(),AuditConstants.REGISTER_AM,"","ApplicationMasterService",message,applicationAttemptId.getApplicationId(),applicationAttemptId);
      throw new InvalidApplicationMasterRequestException(message);
    }
    this.amLivelinessMonitor.receivedPing(applicationAttemptId);
    RMApp app=this.rmContext.getRMApps().get(appID);
    lastResponse.setResponseId(0);
    responseMap.put(applicationAttemptId,lastResponse);
    LOG.info("AM registration " + applicationAttemptId);
    this.rmContext.getDispatcher().getEventHandler().handle(new RMAppAttemptRegistrationEvent(applicationAttemptId,request.getHost(),request.getRpcPort(),request.getTrackingUrl()));
    RMAuditLogger.logSuccess(app.getUser(),AuditConstants.REGISTER_AM,"ApplicationMasterService",appID,applicationAttemptId);
    RegisterApplicationMasterResponse response=recordFactory.newRecordInstance(RegisterApplicationMasterResponse.class);
    response.setMaximumResourceCapability(rScheduler.getMaximumResourceCapability());
    response.setApplicationACLs(app.getRMAppAttempt(applicationAttemptId).getSubmissionContext().getAMContainerSpec().getApplicationACLs());
    if (UserGroupInformation.isSecurityEnabled()) {
      LOG.info("Setting client token master key");
      response.setClientToAMTokenMasterKey(java.nio.ByteBuffer.wrap(rmContext.getClientToAMTokenSecretManager().getMasterKey(applicationAttemptId).getEncoded()));
    }
    return response;
  }
}
