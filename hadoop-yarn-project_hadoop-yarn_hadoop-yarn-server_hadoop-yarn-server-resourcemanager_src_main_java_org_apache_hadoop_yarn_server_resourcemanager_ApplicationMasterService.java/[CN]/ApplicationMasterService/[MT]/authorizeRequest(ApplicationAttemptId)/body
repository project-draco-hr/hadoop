{
  String appAttemptIDStr=appAttemptID.toString();
  UserGroupInformation remoteUgi;
  try {
    remoteUgi=UserGroupInformation.getCurrentUser();
  }
 catch (  IOException e) {
    String msg="Cannot obtain the user-name for ApplicationAttemptID: " + appAttemptIDStr + ". Got exception: "+ StringUtils.stringifyException(e);
    LOG.warn(msg);
    throw RPCUtil.getRemoteException(msg);
  }
  boolean tokenFound=false;
  String message="";
  AMRMTokenIdentifier appTokenIdentifier=null;
  try {
    appTokenIdentifier=selectAMRMTokenIdentifier(remoteUgi);
    if (appTokenIdentifier == null) {
      tokenFound=false;
      message="No AMRMToken found for " + appAttemptIDStr;
    }
 else {
      tokenFound=true;
    }
  }
 catch (  IOException e) {
    tokenFound=false;
    message="Got exception while looking for AMRMToken for " + appAttemptIDStr;
  }
  if (!tokenFound) {
    LOG.warn(message);
    throw RPCUtil.getRemoteException(message);
  }
  ApplicationAttemptId remoteApplicationAttemptId=appTokenIdentifier.getApplicationAttemptId();
  if (!remoteApplicationAttemptId.equals(appAttemptID)) {
    String msg="Unauthorized request from ApplicationMaster. " + "Expected ApplicationAttemptID: " + remoteApplicationAttemptId + " Found: "+ appAttemptIDStr;
    LOG.warn(msg);
    throw RPCUtil.getRemoteException(msg);
  }
}
