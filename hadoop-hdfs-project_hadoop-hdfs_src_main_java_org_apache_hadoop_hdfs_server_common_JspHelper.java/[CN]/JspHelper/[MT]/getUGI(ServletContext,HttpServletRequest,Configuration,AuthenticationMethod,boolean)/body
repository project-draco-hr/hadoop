{
  final UserGroupInformation ugi;
  final String usernameFromQuery=getUsernameFromQuery(request,tryUgiParameter);
  if (UserGroupInformation.isSecurityEnabled()) {
    final String user=request.getRemoteUser();
    String tokenString=request.getParameter(DELEGATION_PARAMETER_NAME);
    if (tokenString != null) {
      Token<DelegationTokenIdentifier> token=new Token<DelegationTokenIdentifier>();
      token.decodeFromUrlString(tokenString);
      String serviceAddress=getNNServiceAddress(context,request);
      if (serviceAddress != null) {
        token.setService(new Text(serviceAddress));
        token.setKind(DelegationTokenIdentifier.HDFS_DELEGATION_KIND);
      }
      ByteArrayInputStream buf=new ByteArrayInputStream(token.getIdentifier());
      DataInputStream in=new DataInputStream(buf);
      DelegationTokenIdentifier id=new DelegationTokenIdentifier();
      id.readFields(in);
      if (context != null) {
        final NameNode nn=NameNodeHttpServer.getNameNodeFromContext(context);
        if (nn != null) {
          nn.getNamesystem().verifyToken(id,token.getPassword());
        }
      }
      ugi=id.getUser();
      checkUsername(ugi.getShortUserName(),usernameFromQuery);
      checkUsername(ugi.getShortUserName(),user);
      ugi.addToken(token);
      ugi.setAuthenticationMethod(AuthenticationMethod.TOKEN);
    }
 else {
      if (user == null) {
        throw new IOException("Security enabled but user not " + "authenticated by filter");
      }
      ugi=UserGroupInformation.createRemoteUser(user);
      checkUsername(ugi.getShortUserName(),usernameFromQuery);
      ugi.setAuthenticationMethod(secureAuthMethod);
    }
  }
 else {
    ugi=usernameFromQuery == null ? getDefaultWebUser(conf) : UserGroupInformation.createRemoteUser(usernameFromQuery);
    ugi.setAuthenticationMethod(AuthenticationMethod.SIMPLE);
  }
  if (LOG.isDebugEnabled())   LOG.debug("getUGI is returning: " + ugi.getShortUserName());
  return ugi;
}
