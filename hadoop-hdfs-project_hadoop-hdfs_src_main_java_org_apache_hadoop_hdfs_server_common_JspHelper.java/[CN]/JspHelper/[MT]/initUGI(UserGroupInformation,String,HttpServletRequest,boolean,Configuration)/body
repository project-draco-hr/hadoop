{
  final UserGroupInformation ugi;
  if (doAsUserFromQuery == null) {
    ugi=realUgi;
  }
 else {
    ugi=UserGroupInformation.createProxyUser(doAsUserFromQuery,realUgi);
    ugi.setAuthenticationMethod(isSecurityEnabled ? AuthenticationMethod.PROXY : AuthenticationMethod.SIMPLE);
    ProxyUsers.authorize(ugi,request.getRemoteAddr(),conf);
  }
  return ugi;
}
