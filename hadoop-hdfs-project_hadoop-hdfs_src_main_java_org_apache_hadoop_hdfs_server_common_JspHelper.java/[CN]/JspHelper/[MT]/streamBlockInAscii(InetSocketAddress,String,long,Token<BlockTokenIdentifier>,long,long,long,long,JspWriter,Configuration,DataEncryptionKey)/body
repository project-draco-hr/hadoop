{
  if (chunkSizeToView == 0)   return;
  Socket s=NetUtils.getDefaultSocketFactory(conf).createSocket();
  s.connect(addr,HdfsServerConstants.READ_TIMEOUT);
  s.setSoTimeout(HdfsServerConstants.READ_TIMEOUT);
  int amtToRead=(int)Math.min(chunkSizeToView,blockSize - offsetIntoBlock);
  BlockReader blockReader=BlockReaderFactory.newBlockReader(new BlockReaderFactory.Params(new Conf(conf)).setPeer(TcpPeerServer.peerFromSocketAndKey(s,encryptionKey)).setBlockToken(blockToken).setStartOffset(offsetIntoBlock).setLen(amtToRead).setFile(BlockReaderFactory.getFileName(addr,poolId,blockId)).setBlock(new ExtendedBlock(poolId,blockId,0,genStamp)).setDatanodeID(new DatanodeID(addr.getAddress().toString(),addr.getHostName(),poolId,addr.getPort(),0,0)));
  byte[] buf=new byte[(int)amtToRead];
  int readOffset=0;
  int retries=2;
  while (amtToRead > 0) {
    int numRead=amtToRead;
    try {
      blockReader.readFully(buf,readOffset,amtToRead);
    }
 catch (    IOException e) {
      retries--;
      if (retries == 0)       throw new IOException("Could not read data from datanode");
      continue;
    }
    amtToRead-=numRead;
    readOffset+=numRead;
  }
  blockReader.close(null);
  out.print(HtmlQuoting.quoteHtmlChars(new String(buf)));
}
