{
  if (app.attempts.size() == app.maxRetries) {
    app.diagnostics.append("Application " + app.getApplicationId() + " failed "+ app.maxRetries+ " times. Failing the application.");
    FINAL_TRANSITION.transition(app,event);
    return RMAppState.FAILED;
  }
  ApplicationAttemptId appAttemptId=Records.newRecord(ApplicationAttemptId.class);
  appAttemptId.setApplicationId(app.applicationId);
  appAttemptId.setAttemptId(app.attempts.size() + 1);
  RMAppAttempt attempt=new RMAppAttemptImpl(appAttemptId,app.clientTokenStr,app.rmContext,app.scheduler,app.masterService,app.submissionContext);
  app.attempts.put(appAttemptId,attempt);
  app.currentAttempt=attempt;
  app.dispatcher.getEventHandler().handle(new RMAppAttemptEvent(appAttemptId,RMAppAttemptEventType.START));
  return initialState;
}
