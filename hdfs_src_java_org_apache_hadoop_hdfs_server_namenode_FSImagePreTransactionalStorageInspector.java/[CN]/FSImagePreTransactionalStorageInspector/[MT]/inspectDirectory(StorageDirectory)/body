{
  if (!sd.getVersionFile().exists()) {
    hasOutOfDateStorageDirs=true;
    return;
  }
  boolean imageExists=false;
  boolean editsExists=false;
  if (sd.getStorageDirType().isOfType(NameNodeDirType.IMAGE)) {
    imageExists=NNStorage.getStorageFile(sd,NameNodeFile.IMAGE).exists();
    imageDirs.add(sd.getRoot().getCanonicalPath());
  }
  if (sd.getStorageDirType().isOfType(NameNodeDirType.EDITS)) {
    editsExists=NNStorage.getStorageFile(sd,NameNodeFile.EDITS).exists();
    editsDirs.add(sd.getRoot().getCanonicalPath());
  }
  long checkpointTime=readCheckpointTime(sd);
  checkpointTimes.add(checkpointTime);
  if (sd.getStorageDirType().isOfType(NameNodeDirType.IMAGE) && (latestNameCheckpointTime < checkpointTime) && imageExists) {
    latestNameCheckpointTime=checkpointTime;
    latestNameSD=sd;
  }
  if (sd.getStorageDirType().isOfType(NameNodeDirType.EDITS) && (latestEditsCheckpointTime < checkpointTime) && editsExists) {
    latestEditsCheckpointTime=checkpointTime;
    latestEditsSD=sd;
  }
  if (checkpointTime <= 0L)   hasOutOfDateStorageDirs=true;
  isUpgradeFinalized=isUpgradeFinalized && !sd.getPreviousDir().exists();
}
