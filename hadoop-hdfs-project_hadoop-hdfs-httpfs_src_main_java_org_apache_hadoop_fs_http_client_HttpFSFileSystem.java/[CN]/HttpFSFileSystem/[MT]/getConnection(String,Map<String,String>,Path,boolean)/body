{
  params.put(DO_AS_PARAM,doAs);
  if (makeQualified) {
    path=makeQualified(path);
  }
  URI uri=path.toUri();
  StringBuilder sb=new StringBuilder();
  sb.append(uri.getScheme()).append("://").append(uri.getAuthority()).append(SERVICE_PREFIX).append(uri.getPath());
  String separator="?";
  for (  Map.Entry<String,String> entry : params.entrySet()) {
    sb.append(separator).append(entry.getKey()).append("=").append(URLEncoder.encode(entry.getValue(),"UTF8"));
    separator="&";
  }
  URL url=new URL(sb.toString());
  return getConnection(url,method);
}
