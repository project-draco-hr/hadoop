{
  if (limit == null) {
    limit=DEFAULT_LIMIT;
  }
  if (windowStart == null) {
    windowStart=Long.MIN_VALUE;
  }
  if (windowEnd == null) {
    windowEnd=Long.MAX_VALUE;
  }
  if (fields == null) {
    fields=EnumSet.allOf(Field.class);
  }
  List<ATSEntity> entitiesSelected=new ArrayList<ATSEntity>();
  for (  ATSEntity entity : new PriorityQueue<ATSEntity>(entities.values())) {
    if (entitiesSelected.size() >= limit) {
      break;
    }
    if (!entity.getEntityType().equals(entityType)) {
      continue;
    }
    if (entity.getStartTime() <= windowStart) {
      continue;
    }
    if (entity.getStartTime() > windowEnd) {
      continue;
    }
    if (primaryFilter != null && !matchFilter(entity.getPrimaryFilters(),primaryFilter)) {
      continue;
    }
    if (secondaryFilters != null) {
      boolean flag=false;
      for (      NameValuePair secondaryFilter : secondaryFilters) {
        if (secondaryFilter != null && matchFilter(entity.getOtherInfo(),secondaryFilter)) {
          flag=true;
          break;
        }
      }
      if (!flag) {
        continue;
      }
    }
    entitiesSelected.add(entity);
  }
  List<ATSEntity> entitiesToReturn=new ArrayList<ATSEntity>();
  for (  ATSEntity entitySelected : entitiesSelected) {
    entitiesToReturn.add(maskFields(entitySelected,fields));
  }
  Collections.sort(entitiesToReturn);
  ATSEntities entitiesWrapper=new ATSEntities();
  entitiesWrapper.setEntities(entitiesToReturn);
  return entitiesWrapper;
}
