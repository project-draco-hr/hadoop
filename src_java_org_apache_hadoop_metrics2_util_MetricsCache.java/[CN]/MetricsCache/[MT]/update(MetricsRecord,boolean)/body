{
  String name=mr.name();
  RecordCache recordCache=map.get(name);
  if (recordCache == null) {
    recordCache=new RecordCache();
    map.put(name,recordCache);
  }
  Collection<MetricsTag> tags=mr.tags();
  Record record=recordCache.get(tags);
  if (record == null) {
    record=new Record();
    recordCache.put(tags,record);
  }
  for (  AbstractMetric m : mr.metrics()) {
    record.metrics.put(m.name(),m.value());
  }
  if (includingTags) {
    for (    MetricsTag t : mr.tags()) {
      record.tags.put(t.name(),t.value());
    }
  }
  return record;
}
