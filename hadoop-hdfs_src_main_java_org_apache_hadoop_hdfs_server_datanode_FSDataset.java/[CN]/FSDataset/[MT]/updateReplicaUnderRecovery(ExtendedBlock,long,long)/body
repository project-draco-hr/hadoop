{
  final ReplicaInfo replica=volumeMap.get(oldBlock.getBlockPoolId(),oldBlock.getBlockId());
  DataNode.LOG.info("updateReplica: block=" + oldBlock + ", recoveryId="+ recoveryId+ ", length="+ newlength+ ", replica="+ replica);
  if (replica == null) {
    throw new ReplicaNotFoundException(oldBlock);
  }
  if (replica.getState() != ReplicaState.RUR) {
    throw new IOException("replica.getState() != " + ReplicaState.RUR + ", replica="+ replica);
  }
  if (replica.getBytesOnDisk() != oldBlock.getNumBytes()) {
    throw new IOException("THIS IS NOT SUPPOSED TO HAPPEN:" + " replica.getBytesOnDisk() != block.getNumBytes(), block=" + oldBlock + ", replica="+ replica);
  }
  checkReplicaFiles(replica);
  final FinalizedReplica finalized=updateReplicaUnderRecovery(oldBlock.getBlockPoolId(),(ReplicaUnderRecovery)replica,recoveryId,newlength);
  checkReplicaFiles(finalized);
  return finalized;
}
