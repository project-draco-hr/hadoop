{
  final Configuration conf=new HdfsConfiguration();
  try {
    initSecureConf(conf);
    final UserGroupInformation ugi=UserGroupInformation.loginUserFromKeytabAndReturnUGI(principal,keytabFile.getAbsolutePath());
    ugi.doAs(new PrivilegedExceptionAction<Void>(){
      @Override public Void run() throws Exception {
        testWithinSameNode(conf);
        Assert.assertTrue(UserGroupInformation.isLoginKeytabBased());
        return null;
      }
    }
);
  }
  finally {
    UserGroupInformation.reset();
    UserGroupInformation.setConfiguration(new Configuration());
  }
}
