{
  AuthenticationToken token=null;
  String serializedJWT=null;
  HttpServletRequest req=(HttpServletRequest)request;
  serializedJWT=getJWTFromCookie(req);
  if (serializedJWT == null) {
    String loginURL=constructLoginURL(request,response);
    LOG.info("sending redirect to: " + loginURL);
    ((HttpServletResponse)response).sendRedirect(loginURL);
  }
 else {
    String userName=null;
    SignedJWT jwtToken=null;
    boolean valid=false;
    try {
      jwtToken=SignedJWT.parse(serializedJWT);
      valid=validateToken(jwtToken);
      if (valid) {
        userName=jwtToken.getJWTClaimsSet().getSubject();
        LOG.info("USERNAME: " + userName);
      }
 else {
        LOG.warn("jwtToken failed validation: " + jwtToken.serialize());
      }
    }
 catch (    ParseException pe) {
      LOG.warn("Unable to parse the JWT token",pe);
    }
    if (valid) {
      LOG.debug("Issuing AuthenticationToken for user.");
      token=new AuthenticationToken(userName,userName,getType());
    }
 else {
      String loginURL=constructLoginURL(request,response);
      LOG.info("token validation failed - sending redirect to: " + loginURL);
      ((HttpServletResponse)response).sendRedirect(loginURL);
    }
  }
  return token;
}
