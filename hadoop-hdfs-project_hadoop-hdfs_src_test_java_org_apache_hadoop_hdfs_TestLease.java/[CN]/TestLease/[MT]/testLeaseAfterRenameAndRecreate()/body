{
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(2).build();
  try {
    final Path path1=new Path("/test-file");
    final String contents1="contents1";
    final Path path2=new Path("/test-file-new-location");
    final String contents2="contents2";
    FileSystem fs=cluster.getFileSystem();
    FSDataOutputStream out1=fs.create(path1);
    out1.writeBytes(contents1);
    Assert.assertTrue(hasLease(cluster,path1));
    Assert.assertEquals(1,leaseCount(cluster));
    DistributedFileSystem fs2=(DistributedFileSystem)FileSystem.newInstance(fs.getUri(),fs.getConf());
    fs2.rename(path1,path2);
    FSDataOutputStream out2=fs2.create(path1);
    out2.writeBytes(contents2);
    out2.close();
    Assert.assertTrue(hasLease(cluster,path2));
    out1.close();
    DistributedFileSystem fs3=(DistributedFileSystem)FileSystem.newInstance(fs.getUri(),fs.getConf());
    Assert.assertEquals(contents1,DFSTestUtil.readFile(fs3,path2));
    Assert.assertEquals(contents2,DFSTestUtil.readFile(fs3,path1));
  }
  finally {
    cluster.shutdown();
  }
}
