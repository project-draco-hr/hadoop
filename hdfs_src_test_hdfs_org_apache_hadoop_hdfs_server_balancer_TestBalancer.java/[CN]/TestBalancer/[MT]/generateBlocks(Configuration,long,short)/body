{
  cluster=new MiniDFSCluster.Builder(conf).numDataNodes(numNodes).build();
  try {
    cluster.waitActive();
    client=DFSClient.createNamenode(conf);
    short replicationFactor=(short)(numNodes - 1);
    long fileLen=size / replicationFactor;
    createFile(fileLen,replicationFactor);
    List<LocatedBlock> locatedBlocks=client.getBlockLocations(fileName,0,fileLen).getLocatedBlocks();
    int numOfBlocks=locatedBlocks.size();
    ExtendedBlock[] blocks=new ExtendedBlock[numOfBlocks];
    for (int i=0; i < numOfBlocks; i++) {
      ExtendedBlock b=locatedBlocks.get(i).getBlock();
      blocks[i]=new ExtendedBlock(b.getBlockPoolId(),b.getBlockId(),b.getNumBytes(),b.getGenerationStamp());
    }
    return blocks;
  }
  finally {
    cluster.shutdown();
  }
}
