{
  ReceivedDeletedBlockInfo[] receivedAndDeletedBlockArray=null;
synchronized (pendingIncrementalBR) {
    int numBlocks=pendingIncrementalBR.size();
    if (numBlocks > 0) {
      receivedAndDeletedBlockArray=pendingIncrementalBR.values().toArray(new ReceivedDeletedBlockInfo[numBlocks]);
    }
    pendingIncrementalBR.clear();
  }
  if (receivedAndDeletedBlockArray != null) {
    StorageReceivedDeletedBlocks[] report={new StorageReceivedDeletedBlocks(bpRegistration.getDatanodeUuid(),receivedAndDeletedBlockArray)};
    boolean success=false;
    try {
      bpNamenode.blockReceivedAndDeleted(bpRegistration,bpos.getBlockPoolId(),report);
      success=true;
    }
  finally {
synchronized (pendingIncrementalBR) {
        if (!success) {
          for (          ReceivedDeletedBlockInfo rdbi : receivedAndDeletedBlockArray) {
            if (!pendingIncrementalBR.containsKey(rdbi.getBlock().getBlockId())) {
              pendingIncrementalBR.put(rdbi.getBlock().getBlockId(),rdbi);
            }
          }
        }
        pendingReceivedRequests=pendingIncrementalBR.size();
      }
    }
  }
}
