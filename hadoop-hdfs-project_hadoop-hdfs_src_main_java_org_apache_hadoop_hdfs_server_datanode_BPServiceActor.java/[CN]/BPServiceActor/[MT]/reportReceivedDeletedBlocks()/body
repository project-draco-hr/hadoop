{
  Map<String,ReceivedDeletedBlockInfo[]> blockArrays=Maps.newHashMap();
synchronized (pendingIncrementalBRperStorage) {
    for (    Map.Entry<String,PerStoragePendingIncrementalBR> entry : pendingIncrementalBRperStorage.entrySet()) {
      final String storageUuid=entry.getKey();
      final PerStoragePendingIncrementalBR perStorageMap=entry.getValue();
      if (perStorageMap.getBlockInfoCount() > 0) {
        ReceivedDeletedBlockInfo[] rdbi=perStorageMap.dequeueBlockInfos();
        pendingReceivedRequests=(pendingReceivedRequests > rdbi.length ? (pendingReceivedRequests - rdbi.length) : 0);
        blockArrays.put(storageUuid,rdbi);
      }
    }
  }
  for (  Map.Entry<String,ReceivedDeletedBlockInfo[]> entry : blockArrays.entrySet()) {
    final String storageUuid=entry.getKey();
    final ReceivedDeletedBlockInfo[] rdbi=entry.getValue();
    StorageReceivedDeletedBlocks[] report={new StorageReceivedDeletedBlocks(storageUuid,rdbi)};
    boolean success=false;
    try {
      bpNamenode.blockReceivedAndDeleted(bpRegistration,bpos.getBlockPoolId(),report);
      success=true;
    }
  finally {
      if (!success) {
synchronized (pendingIncrementalBRperStorage) {
          PerStoragePendingIncrementalBR perStorageMap=pendingIncrementalBRperStorage.get(storageUuid);
          pendingReceivedRequests+=perStorageMap.putMissingBlockInfos(rdbi);
        }
      }
    }
  }
}
