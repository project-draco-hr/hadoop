{
  ArrayList<StorageReceivedDeletedBlocks> reports=new ArrayList<StorageReceivedDeletedBlocks>(pendingIncrementalBRperStorage.size());
synchronized (pendingIncrementalBRperStorage) {
    for (    Map.Entry<DatanodeStorage,PerStoragePendingIncrementalBR> entry : pendingIncrementalBRperStorage.entrySet()) {
      final DatanodeStorage storage=entry.getKey();
      final PerStoragePendingIncrementalBR perStorageMap=entry.getValue();
      if (perStorageMap.getBlockInfoCount() > 0) {
        ReceivedDeletedBlockInfo[] rdbi=perStorageMap.dequeueBlockInfos();
        reports.add(new StorageReceivedDeletedBlocks(storage,rdbi));
      }
    }
    sendImmediateIBR=false;
  }
  if (reports.size() == 0) {
    return;
  }
  boolean success=false;
  final long startTime=Time.monotonicNow();
  try {
    bpNamenode.blockReceivedAndDeleted(bpRegistration,bpos.getBlockPoolId(),reports.toArray(new StorageReceivedDeletedBlocks[reports.size()]));
    success=true;
  }
  finally {
    dn.getMetrics().addIncrementalBlockReport(Time.monotonicNow() - startTime);
    if (!success) {
synchronized (pendingIncrementalBRperStorage) {
        for (        StorageReceivedDeletedBlocks report : reports) {
          PerStoragePendingIncrementalBR perStorageMap=pendingIncrementalBRperStorage.get(report.getStorage());
          perStorageMap.putMissingBlockInfos(report.getBlocks());
          sendImmediateIBR=true;
        }
      }
    }
  }
}
