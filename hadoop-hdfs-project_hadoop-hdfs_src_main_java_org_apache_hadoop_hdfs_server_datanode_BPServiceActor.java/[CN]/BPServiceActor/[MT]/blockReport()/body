{
  DatanodeCommand cmd=null;
  long startTime=now();
  if (startTime - lastBlockReport > dnConf.blockReportInterval) {
    reportReceivedDeletedBlocks();
    long brCreateStartTime=now();
    BlockListAsLongs bReport=dn.getFSDataset().getBlockReport(bpos.getBlockPoolId());
    long brSendStartTime=now();
    StorageBlockReport[] report={new StorageBlockReport(bpRegistration.getStorageID(),bReport.getBlockListAsLongs())};
    cmd=bpNamenode.blockReport(bpRegistration,bpos.getBlockPoolId(),report);
    long brSendCost=now() - brSendStartTime;
    long brCreateCost=brSendStartTime - brCreateStartTime;
    dn.getMetrics().addBlockReport(brSendCost);
    LOG.info("BlockReport of " + bReport.getNumberOfBlocks() + " blocks took "+ brCreateCost+ " msec to generate and "+ brSendCost+ " msecs for RPC and NN processing");
    if (resetBlockReportTime) {
      lastBlockReport=startTime - DFSUtil.getRandom().nextInt((int)(dnConf.blockReportInterval));
      resetBlockReportTime=false;
    }
 else {
      lastBlockReport+=(now() - lastBlockReport) / dnConf.blockReportInterval * dnConf.blockReportInterval;
    }
    LOG.info("sent block report, processed command:" + cmd);
  }
  return cmd;
}
