{
  final long startTime=now();
  if (startTime - lastBlockReport <= dnConf.blockReportInterval) {
    return null;
  }
  final ArrayList<DatanodeCommand> cmds=new ArrayList<DatanodeCommand>();
  reportReceivedDeletedBlocks();
  lastDeletedReport=startTime;
  long brCreateStartTime=now();
  Map<DatanodeStorage,BlockListAsLongs> perVolumeBlockLists=dn.getFSDataset().getBlockReports(bpos.getBlockPoolId());
  int i=0;
  int totalBlockCount=0;
  StorageBlockReport reports[]=new StorageBlockReport[perVolumeBlockLists.size()];
  for (  Map.Entry<DatanodeStorage,BlockListAsLongs> kvPair : perVolumeBlockLists.entrySet()) {
    BlockListAsLongs blockList=kvPair.getValue();
    reports[i++]=new StorageBlockReport(kvPair.getKey(),blockList.getBlockListAsLongs());
    totalBlockCount+=blockList.getNumberOfBlocks();
  }
  int numReportsSent=0;
  int numRPCs=0;
  boolean success=false;
  long brSendStartTime=now();
  try {
    if (totalBlockCount < dnConf.blockReportSplitThreshold) {
      DatanodeCommand cmd=bpNamenode.blockReport(bpRegistration,bpos.getBlockPoolId(),reports);
      numRPCs=1;
      numReportsSent=reports.length;
      if (cmd != null) {
        cmds.add(cmd);
      }
    }
 else {
      for (      StorageBlockReport report : reports) {
        StorageBlockReport singleReport[]={report};
        DatanodeCommand cmd=bpNamenode.blockReport(bpRegistration,bpos.getBlockPoolId(),singleReport);
        numReportsSent++;
        numRPCs++;
        if (cmd != null) {
          cmds.add(cmd);
        }
      }
    }
    success=true;
  }
  finally {
    long brSendCost=now() - brSendStartTime;
    long brCreateCost=brSendStartTime - brCreateStartTime;
    dn.getMetrics().addBlockReport(brSendCost);
    final int nCmds=cmds.size();
    LOG.info((success ? "S" : "Uns") + "uccessfully sent " + numReportsSent+ " of "+ reports.length+ " blockreports for "+ totalBlockCount+ " total blocks using "+ numRPCs+ " RPCs. This took "+ brCreateCost+ " msec to generate and "+ brSendCost+ " msecs for RPC and NN processing."+ " Got back "+ ((nCmds == 0) ? "no commands" : ((nCmds == 1) ? "one command: " + cmds.get(0) : (nCmds + " commands: " + Joiner.on("; ").join(cmds))))+ ".");
  }
  scheduleNextBlockReport(startTime);
  return cmds.size() == 0 ? null : cmds;
}
