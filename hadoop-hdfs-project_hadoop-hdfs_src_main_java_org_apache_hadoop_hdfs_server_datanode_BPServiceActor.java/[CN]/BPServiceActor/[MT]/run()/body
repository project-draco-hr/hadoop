{
  LOG.info(this + " starting to offer service");
  try {
    while (true) {
      try {
        connectToNNAndHandshake();
        break;
      }
 catch (      IOException ioe) {
        runningState=RunningState.INIT_FAILED;
        if (shouldRetryInit()) {
          LOG.error("Initialization failed for " + this + " "+ ioe.getLocalizedMessage());
          sleepAndLogInterrupts(5000,"initializing");
        }
 else {
          runningState=RunningState.FAILED;
          LOG.error("Initialization failed for " + this + ". Exiting. ",ioe);
          return;
        }
      }
    }
    runningState=RunningState.RUNNING;
    if (initialRegistrationComplete != null) {
      initialRegistrationComplete.countDown();
    }
    while (shouldRun()) {
      try {
        offerService();
      }
 catch (      Exception ex) {
        LOG.error("Exception in BPOfferService for " + this,ex);
        sleepAndLogInterrupts(5000,"offering service");
      }
    }
    runningState=RunningState.EXITED;
  }
 catch (  Throwable ex) {
    LOG.warn("Unexpected exception in block pool " + this,ex);
    runningState=RunningState.FAILED;
  }
 finally {
    LOG.warn("Ending block pool service for: " + this);
    cleanUp();
  }
}
