{
  boolean inserted=false;
  try {
synchronized (this) {
      if (closed)       return;
      if (map.size() + 1 > maxCacheSize) {
        Iterator<Entry<Key,Value>> iter=map.entries().iterator();
        if (!iter.hasNext())         return;
        Entry<Key,Value> entry=iter.next();
        entry.getValue().close();
        iter.remove();
      }
      if (cacheCleaner == null) {
        cacheCleaner=new CacheCleaner(this);
        ScheduledFuture<?> future=executor.scheduleAtFixedRate(cacheCleaner,expiryTimeMs,expiryTimeMs,TimeUnit.MILLISECONDS);
        cacheCleaner.setFuture(future);
      }
      map.put(new Key(datanodeID,block),new Value(fis));
      inserted=true;
    }
  }
  finally {
    if (!inserted) {
      IOUtils.cleanup(LOG,fis);
    }
  }
}
