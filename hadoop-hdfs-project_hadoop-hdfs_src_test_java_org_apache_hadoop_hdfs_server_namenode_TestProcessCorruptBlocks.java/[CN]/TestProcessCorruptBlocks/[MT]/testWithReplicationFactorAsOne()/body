{
  Configuration conf=new HdfsConfiguration();
  conf.setLong(DFSConfigKeys.DFS_BLOCKREPORT_INTERVAL_MSEC_KEY,1000L);
  conf.set(DFSConfigKeys.DFS_NAMENODE_REPLICATION_PENDING_TIMEOUT_SEC_KEY,Integer.toString(2));
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(2).build();
  FileSystem fs=cluster.getFileSystem();
  final FSNamesystem namesystem=cluster.getNamesystem();
  try {
    final Path fileName=new Path("/foo1");
    DFSTestUtil.createFile(fs,fileName,2,(short)2,0L);
    DFSTestUtil.waitReplication(fs,fileName,(short)2);
    ExtendedBlock block=DFSTestUtil.getFirstBlock(fs,fileName);
    corruptBlock(cluster,fs,fileName,0,block);
    DFSTestUtil.waitReplication(fs,fileName,(short)1);
    assertEquals(1,countReplicas(namesystem,block).liveReplicas());
    assertEquals(1,countReplicas(namesystem,block).corruptReplicas());
    namesystem.setReplication(fileName.toString(),(short)1);
    for (int i=0; i < 10; i++) {
      try {
        Thread.sleep(1000);
      }
 catch (      InterruptedException ignored) {
      }
      if (countReplicas(namesystem,block).corruptReplicas() == 0) {
        break;
      }
    }
    assertEquals(1,countReplicas(namesystem,block).liveReplicas());
    assertEquals(0,countReplicas(namesystem,block).corruptReplicas());
  }
  finally {
    cluster.shutdown();
  }
}
