{
  if (LOG.isDebugEnabled()) {
    LOG.debug("Running " + GenericTestUtils.getMethodName());
  }
  DataNode spyDN=spy(dn);
  doReturn(new ReplicaRecoveryInfo(block.getBlockId(),0,block.getGenerationStamp(),ReplicaState.FINALIZED)).when(spyDN).initReplicaRecovery(any(RecoveringBlock.class));
  Daemon d=spyDN.recoverBlocks(initRecoveringBlocks());
  d.join();
  DatanodeProtocol dnP=dn.getActiveNamenodeForBP(POOL_ID);
  verify(dnP).commitBlockSynchronization(block,RECOVERY_ID,0,true,true,DatanodeID.EMPTY_ARRAY,null);
}
