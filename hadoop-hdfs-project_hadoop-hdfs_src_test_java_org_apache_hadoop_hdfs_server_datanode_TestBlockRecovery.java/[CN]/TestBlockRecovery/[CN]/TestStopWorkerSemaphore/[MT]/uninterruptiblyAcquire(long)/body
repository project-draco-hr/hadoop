{
  long startTimeMs=Time.monotonicNow();
  while (true) {
    long remTime=startTimeMs + timeoutMs - Time.monotonicNow();
    if (remTime < 0) {
      throw new RuntimeException("Failed to acquire the semaphore within " + timeoutMs + " milliseconds.");
    }
    try {
      if (sem.tryAcquire(1,remTime,TimeUnit.MILLISECONDS)) {
        return;
      }
    }
 catch (    InterruptedException e) {
      gotInterruption.set(true);
    }
  }
}
