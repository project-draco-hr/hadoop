{
  @SuppressWarnings("unchecked") Map<String,String[]> pmap=request.getParameterMap();
  isGetImage=isGetEdit=isPutImage=fetchLatest=false;
  remoteport=0;
  for (  Map.Entry<String,String[]> entry : pmap.entrySet()) {
    String key=entry.getKey();
    String[] val=entry.getValue();
    if (key.equals("getimage")) {
      isGetImage=true;
      try {
        txId=ServletUtil.parseLongParam(request,TXID_PARAM);
        String imageType=ServletUtil.getParameter(request,IMAGE_FILE_TYPE);
        nnf=imageType == null ? NameNodeFile.IMAGE : NameNodeFile.valueOf(imageType);
      }
 catch (      NumberFormatException nfe) {
        if (request.getParameter(TXID_PARAM).equals(LATEST_FSIMAGE_VALUE)) {
          fetchLatest=true;
        }
 else {
          throw nfe;
        }
      }
    }
 else     if (key.equals("getedit")) {
      isGetEdit=true;
      startTxId=ServletUtil.parseLongParam(request,START_TXID_PARAM);
      endTxId=ServletUtil.parseLongParam(request,END_TXID_PARAM);
    }
 else     if (key.equals("putimage")) {
      isPutImage=true;
      txId=ServletUtil.parseLongParam(request,TXID_PARAM);
      String imageType=ServletUtil.getParameter(request,IMAGE_FILE_TYPE);
      nnf=imageType == null ? NameNodeFile.IMAGE : NameNodeFile.valueOf(imageType);
    }
 else     if (key.equals("port")) {
      remoteport=new Integer(val[0]).intValue();
    }
 else     if (key.equals("machine")) {
      machineName=val[0];
    }
 else     if (key.equals(STORAGEINFO_PARAM)) {
      storageInfoString=val[0];
    }
  }
  if (machineName == null) {
    machineName=request.getRemoteHost();
    if (InetAddresses.isInetAddress(machineName)) {
      machineName=NetUtils.getHostNameOfIP(machineName);
    }
  }
  int numGets=(isGetImage ? 1 : 0) + (isGetEdit ? 1 : 0);
  if ((numGets > 1) || (numGets == 0) && !isPutImage) {
    throw new IOException("Illegal parameters to TransferFsImage");
  }
}
