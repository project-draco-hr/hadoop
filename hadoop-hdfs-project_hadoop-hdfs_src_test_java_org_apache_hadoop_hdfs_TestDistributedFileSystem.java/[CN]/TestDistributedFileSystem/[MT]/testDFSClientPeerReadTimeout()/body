{
  final int timeout=1000;
  final Configuration conf=new HdfsConfiguration();
  conf.setInt(HdfsClientConfigKeys.DFS_CLIENT_SOCKET_TIMEOUT_KEY,timeout);
  final MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).build();
  try {
    cluster.waitActive();
    DistributedFileSystem dfs=cluster.getFileSystem();
    ServerSocket socket=new ServerSocket(0);
    Peer peer=dfs.getClient().newConnectedPeer((InetSocketAddress)socket.getLocalSocketAddress(),null,null);
    long start=Time.now();
    try {
      peer.getInputStream().read();
      Assert.fail("read should timeout");
    }
 catch (    SocketTimeoutException ste) {
      long delta=Time.now() - start;
      if (delta < timeout * 0.9) {
        throw new IOException("read timedout too soon in " + delta + " ms.",ste);
      }
      if (delta > timeout * 1.1) {
        throw new IOException("read timedout too late in " + delta + " ms.",ste);
      }
    }
  }
  finally {
    cluster.shutdown();
  }
}
