{
  final int timeout=1000;
  final Configuration conf=new HdfsConfiguration();
  conf.setInt(DFSConfigKeys.DFS_CLIENT_SOCKET_TIMEOUT_KEY,timeout);
  final MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).build();
  try {
    cluster.waitActive();
    DistributedFileSystem dfs=cluster.getFileSystem();
    ServerSocket socket=new ServerSocket(0);
    Peer peer=dfs.getClient().newConnectedPeer((InetSocketAddress)socket.getLocalSocketAddress(),null,null);
    long start=Time.now();
    try {
      byte[] buf=new byte[10 * 1024 * 1024];
      peer.getOutputStream().write(buf);
      long delta=Time.now() - start;
      Assert.fail("write finish in " + delta + " ms"+ "but should timedout");
    }
 catch (    SocketTimeoutException ste) {
      long delta=Time.now() - start;
      Assert.assertTrue("write timedout too soon in " + delta + " ms",delta >= timeout * 0.9);
      Assert.assertTrue("write timedout too late in " + delta + " ms",delta <= timeout * 1.2);
    }
catch (    Throwable t) {
      Assert.fail("wrong exception:" + t);
    }
  }
  finally {
    cluster.shutdown();
  }
}
