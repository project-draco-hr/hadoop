{
  if (mappings != null && mappings.size() > 0) {
    try {
      String mappedQueue=getMappedQueue(user);
      if (mappedQueue != null) {
        if (queueName.equals(YarnConfiguration.DEFAULT_QUEUE_NAME) || overrideWithQueueMappings) {
          LOG.info("Application " + applicationId + " user "+ user+ " mapping ["+ queueName+ "] to ["+ mappedQueue+ "] override "+ overrideWithQueueMappings);
          queueName=mappedQueue;
          RMApp rmApp=rmContext.getRMApps().get(applicationId);
          rmApp.setQueue(queueName);
        }
      }
    }
 catch (    IOException ioex) {
      String message="Failed to submit application " + applicationId + " submitted by user "+ user+ " reason: "+ ioex.getMessage();
      this.rmContext.getDispatcher().getEventHandler().handle(new RMAppRejectedEvent(applicationId,message));
      return;
    }
  }
  CSQueue queue=getQueue(queueName);
  if (queue == null) {
    if (isAppRecovering) {
      String queueErrorMsg="Queue named " + queueName + " missing during application recovery."+ " Queue removal during recovery is not presently supported by the"+ " capacity scheduler, please restart with all queues configured"+ " which were present before shutdown/restart.";
      LOG.fatal(queueErrorMsg);
      throw new RuntimeException(queueErrorMsg);
    }
    String message="Application " + applicationId + " submitted by user "+ user+ " to unknown queue: "+ queueName;
    this.rmContext.getDispatcher().getEventHandler().handle(new RMAppRejectedEvent(applicationId,message));
    return;
  }
  if (!(queue instanceof LeafQueue)) {
    String message="Application " + applicationId + " submitted by user "+ user+ " to non-leaf queue: "+ queueName;
    this.rmContext.getDispatcher().getEventHandler().handle(new RMAppRejectedEvent(applicationId,message));
    return;
  }
  try {
    queue.submitApplication(applicationId,user,queueName);
  }
 catch (  AccessControlException ace) {
    LOG.info("Failed to submit application " + applicationId + " to queue "+ queueName+ " from user "+ user,ace);
    this.rmContext.getDispatcher().getEventHandler().handle(new RMAppRejectedEvent(applicationId,ace.toString()));
    return;
  }
  queue.getMetrics().submitApp(user);
  SchedulerApplication<FiCaSchedulerApp> application=new SchedulerApplication<FiCaSchedulerApp>(queue,user);
  applications.put(applicationId,application);
  LOG.info("Accepted application " + applicationId + " from user: "+ user+ ", in queue: "+ queueName);
  if (isAppRecovering) {
    if (LOG.isDebugEnabled()) {
      LOG.debug(applicationId + " is recovering. Skip notifying APP_ACCEPTED");
    }
  }
 else {
    rmContext.getDispatcher().getEventHandler().handle(new RMAppEvent(applicationId,RMAppEventType.APP_ACCEPTED));
  }
}
