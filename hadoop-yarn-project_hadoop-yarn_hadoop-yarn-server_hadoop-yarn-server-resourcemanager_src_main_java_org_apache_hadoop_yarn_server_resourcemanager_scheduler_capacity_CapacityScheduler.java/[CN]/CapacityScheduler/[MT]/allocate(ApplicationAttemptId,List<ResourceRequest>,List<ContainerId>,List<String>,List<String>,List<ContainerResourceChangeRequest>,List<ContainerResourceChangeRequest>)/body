{
  FiCaSchedulerApp application=getApplicationAttempt(applicationAttemptId);
  if (application == null) {
    return EMPTY_ALLOCATION;
  }
  SchedulerUtils.normalizeRequests(ask,getResourceCalculator(),getClusterResource(),getMinimumResourceCapability(),getMaximumResourceCapability());
  List<SchedContainerChangeRequest> normalizedIncreaseRequests=checkAndNormalizeContainerChangeRequests(increaseRequests,true);
  List<SchedContainerChangeRequest> normalizedDecreaseRequests=checkAndNormalizeContainerChangeRequests(decreaseRequests,false);
  releaseContainers(release,application);
  Allocation allocation;
  LeafQueue updateDemandForQueue=null;
synchronized (application) {
    if (application.isStopped()) {
      return EMPTY_ALLOCATION;
    }
    if (!ask.isEmpty()) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("allocate: pre-update " + applicationAttemptId + " ask size ="+ ask.size());
        application.showRequests();
      }
      if (application.updateResourceRequests(ask)) {
        updateDemandForQueue=(LeafQueue)application.getQueue();
      }
      if (LOG.isDebugEnabled()) {
        LOG.debug("allocate: post-update");
        application.showRequests();
      }
    }
    if (application.updateIncreaseRequests(normalizedIncreaseRequests) && (updateDemandForQueue == null)) {
      updateDemandForQueue=(LeafQueue)application.getQueue();
    }
    if (application.isWaitingForAMContainer()) {
      application.updateAMBlacklist(blacklistAdditions,blacklistRemovals);
    }
 else {
      application.updateBlacklist(blacklistAdditions,blacklistRemovals);
    }
    decreaseContainers(normalizedDecreaseRequests,application);
    allocation=application.getAllocation(getResourceCalculator(),clusterResource,getMinimumResourceCapability());
  }
  if (updateDemandForQueue != null) {
    updateDemandForQueue.getOrderingPolicy().demandUpdated(application);
  }
  return allocation;
}
