{
  FiCaSchedulerApp application=getApplicationAttempt(applicationAttemptId);
  if (application == null) {
    LOG.info("Calling allocate on removed " + "or non existant application " + applicationAttemptId);
    return EMPTY_ALLOCATION;
  }
  SchedulerUtils.normalizeRequests(ask,getResourceCalculator(),getClusterResource(),getMinimumResourceCapability(),maximumAllocation);
  releaseContainers(release,application);
synchronized (application) {
    if (application.isStopped()) {
      LOG.info("Calling allocate on a stopped " + "application " + applicationAttemptId);
      return EMPTY_ALLOCATION;
    }
    if (!ask.isEmpty()) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("allocate: pre-update" + " applicationAttemptId=" + applicationAttemptId + " application="+ application);
      }
      application.showRequests();
      application.updateResourceRequests(ask);
      LOG.debug("allocate: post-update");
      application.showRequests();
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug("allocate:" + " applicationAttemptId=" + applicationAttemptId + " #ask="+ ask.size());
    }
    application.updateBlacklist(blacklistAdditions,blacklistRemovals);
    return application.getAllocation(getResourceCalculator(),clusterResource,getMinimumResourceCapability());
  }
}
