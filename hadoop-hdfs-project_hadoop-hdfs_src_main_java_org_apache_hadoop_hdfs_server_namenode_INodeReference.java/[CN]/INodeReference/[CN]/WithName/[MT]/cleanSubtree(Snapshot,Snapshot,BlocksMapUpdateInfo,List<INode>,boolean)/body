{
  Preconditions.checkArgument(snapshot != null);
  if (prior == null) {
    prior=getPriorSnapshot(this);
  }
  if (prior != null && Snapshot.ID_COMPARATOR.compare(snapshot,prior) <= 0) {
    return Quota.Counts.newInstance();
  }
  Quota.Counts counts=getReferredINode().cleanSubtree(snapshot,prior,collectedBlocks,removedINodes,false);
  INodeReference ref=getReferredINode().getParentReference();
  if (ref != null) {
    ref.addSpaceConsumed(-counts.get(Quota.NAMESPACE),-counts.get(Quota.DISKSPACE),true);
  }
  if (snapshot.getId() < lastSnapshotId) {
    counts=Quota.Counts.newInstance();
  }
  return counts;
}
