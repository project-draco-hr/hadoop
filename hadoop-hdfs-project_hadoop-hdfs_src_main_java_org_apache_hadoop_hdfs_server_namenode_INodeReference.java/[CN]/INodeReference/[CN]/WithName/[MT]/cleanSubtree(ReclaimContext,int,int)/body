{
  Preconditions.checkArgument(snapshot != Snapshot.CURRENT_STATE_ID);
  if (prior == Snapshot.NO_SNAPSHOT_ID) {
    prior=getPriorSnapshot(this);
  }
  if (prior != Snapshot.NO_SNAPSHOT_ID && Snapshot.ID_INTEGER_COMPARATOR.compare(snapshot,prior) <= 0) {
    return;
  }
  QuotaCounts old=reclaimContext.quotaDelta().getCountsCopy();
  getReferredINode().cleanSubtree(reclaimContext,snapshot,prior);
  INodeReference ref=getReferredINode().getParentReference();
  if (ref != null) {
    QuotaCounts current=reclaimContext.quotaDelta().getCountsCopy();
    current.subtract(old);
    reclaimContext.quotaDelta().addUpdatePath(ref,current);
  }
  if (snapshot < lastSnapshotId) {
    reclaimContext.quotaDelta().setCounts(old);
  }
}
