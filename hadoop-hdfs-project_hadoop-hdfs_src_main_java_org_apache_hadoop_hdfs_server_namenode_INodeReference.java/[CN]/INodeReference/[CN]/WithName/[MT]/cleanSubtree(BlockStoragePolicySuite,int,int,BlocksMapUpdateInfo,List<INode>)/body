{
  Preconditions.checkArgument(snapshot != Snapshot.CURRENT_STATE_ID);
  if (prior == Snapshot.NO_SNAPSHOT_ID) {
    prior=getPriorSnapshot(this);
  }
  if (prior != Snapshot.NO_SNAPSHOT_ID && Snapshot.ID_INTEGER_COMPARATOR.compare(snapshot,prior) <= 0) {
    return new QuotaCounts.Builder().build();
  }
  QuotaCounts counts=getReferredINode().cleanSubtree(bsps,snapshot,prior,collectedBlocks,removedINodes);
  INodeReference ref=getReferredINode().getParentReference();
  if (ref != null) {
    try {
      ref.addSpaceConsumed(counts.negation(),true);
    }
 catch (    QuotaExceededException e) {
      Log.warn("Should not have QuotaExceededException");
    }
  }
  if (snapshot < lastSnapshotId) {
    counts=new QuotaCounts.Builder().build();
  }
  return counts;
}
