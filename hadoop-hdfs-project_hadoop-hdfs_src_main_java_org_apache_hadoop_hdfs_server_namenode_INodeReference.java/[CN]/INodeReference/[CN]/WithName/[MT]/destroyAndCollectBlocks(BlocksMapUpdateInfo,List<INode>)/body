{
  Snapshot snapshot=getSelfSnapshot();
  if (removeReference(this) <= 0) {
    getReferredINode().destroyAndCollectBlocks(collectedBlocks,removedINodes);
  }
 else {
    Snapshot prior=getPriorSnapshot(this);
    INode referred=getReferredINode().asReference().getReferredINode();
    if (snapshot != null) {
      if (prior != null && snapshot.getId() <= prior.getId()) {
        return;
      }
      try {
        Quota.Counts counts=referred.cleanSubtree(snapshot,prior,collectedBlocks,removedINodes,false);
        INodeReference ref=getReferredINode().getParentReference();
        if (ref != null) {
          ref.addSpaceConsumed(-counts.get(Quota.NAMESPACE),-counts.get(Quota.DISKSPACE),true);
        }
      }
 catch (      QuotaExceededException e) {
        LOG.error("should not exceed quota while snapshot deletion",e);
      }
    }
  }
}
