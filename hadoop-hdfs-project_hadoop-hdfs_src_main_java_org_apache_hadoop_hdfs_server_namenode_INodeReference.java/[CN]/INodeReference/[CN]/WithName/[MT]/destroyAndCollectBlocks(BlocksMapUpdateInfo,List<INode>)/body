{
  int snapshot=getSelfSnapshot();
  if (removeReference(this) <= 0) {
    getReferredINode().destroyAndCollectBlocks(collectedBlocks,removedINodes);
  }
 else {
    int prior=getPriorSnapshot(this);
    INode referred=getReferredINode().asReference().getReferredINode();
    if (snapshot != Snapshot.NO_SNAPSHOT_ID) {
      if (prior != Snapshot.NO_SNAPSHOT_ID && snapshot <= prior) {
        return;
      }
      try {
        Quota.Counts counts=referred.cleanSubtree(snapshot,prior,collectedBlocks,removedINodes);
        INodeReference ref=getReferredINode().getParentReference();
        if (ref != null) {
          ref.addSpaceConsumed(-counts.get(Quota.NAMESPACE),-counts.get(Quota.DISKSPACE),true);
        }
      }
 catch (      QuotaExceededException e) {
        LOG.error("should not exceed quota while snapshot deletion",e);
      }
    }
  }
}
