{
  WithCount wc=(WithCount)getReferredINode().asReference();
  INode referred=wc.getReferredINode();
  int lastSnapshot=Snapshot.CURRENT_STATE_ID;
  if (referred.isFile() && referred.asFile().isWithSnapshot()) {
    lastSnapshot=referred.asFile().getDiffs().getLastSnapshotId();
  }
 else   if (referred.isDirectory()) {
    DirectoryWithSnapshotFeature sf=referred.asDirectory().getDirectoryWithSnapshotFeature();
    if (sf != null) {
      lastSnapshot=sf.getLastSnapshotId();
    }
  }
  if (lastSnapshot != Snapshot.CURRENT_STATE_ID && lastSnapshot != prior) {
    return lastSnapshot;
  }
 else {
    return Snapshot.CURRENT_STATE_ID;
  }
}
