{
  if (removeReference(this) <= 0) {
    getReferredINode().destroyAndCollectBlocks(collectedBlocks,removedINodes);
  }
 else {
    Snapshot prior=getPriorSnapshot(this);
    Preconditions.checkState(prior != null);
    Snapshot snapshot=getSelfSnapshot(prior);
    INode referred=getReferredINode().asReference().getReferredINode();
    if (referred.isFile()) {
      INodeFile file=referred.asFile();
      Preconditions.checkState(file.isWithSnapshot());
      file.getFileWithSnapshotFeature().deleteCurrentFile();
      try {
        referred.cleanSubtree(snapshot,prior,collectedBlocks,removedINodes,true);
      }
 catch (      QuotaExceededException e) {
        LOG.error("should not exceed quota while snapshot deletion",e);
      }
    }
 else     if (referred.isDirectory()) {
      INodeDirectory dir=referred.asDirectory();
      Preconditions.checkState(dir.isWithSnapshot());
      try {
        DirectoryWithSnapshotFeature.destroyDstSubtree(dir,snapshot,prior,collectedBlocks,removedINodes);
      }
 catch (      QuotaExceededException e) {
        LOG.error("should not exceed quota while snapshot deletion",e);
      }
    }
  }
}
