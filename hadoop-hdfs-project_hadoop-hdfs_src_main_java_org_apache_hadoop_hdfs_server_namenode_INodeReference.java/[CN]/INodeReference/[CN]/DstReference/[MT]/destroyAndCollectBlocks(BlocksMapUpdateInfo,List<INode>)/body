{
  if (removeReference(this) <= 0) {
    getReferredINode().destroyAndCollectBlocks(collectedBlocks,removedINodes);
  }
 else {
    Snapshot prior=getPriorSnapshot(this);
    Preconditions.checkState(prior != null);
    Snapshot snapshot=getSelfSnapshot(prior);
    INode referred=getReferredINode().asReference().getReferredINode();
    if (referred instanceof FileWithSnapshot) {
      FileWithSnapshot sfile=(FileWithSnapshot)referred;
      sfile.deleteCurrentFile();
      if (snapshot != null) {
        try {
          referred.cleanSubtree(snapshot,prior,collectedBlocks,removedINodes);
        }
 catch (        QuotaExceededException e) {
          LOG.error("should not exceed quota while snapshot deletion",e);
        }
      }
    }
 else     if (referred instanceof INodeDirectoryWithSnapshot) {
      INodeDirectoryWithSnapshot sdir=(INodeDirectoryWithSnapshot)referred;
      try {
        INodeDirectoryWithSnapshot.destroyDstSubtree(sdir,snapshot,prior,collectedBlocks,removedINodes);
      }
 catch (      QuotaExceededException e) {
        LOG.error("should not exceed quota while snapshot deletion",e);
      }
    }
  }
}
