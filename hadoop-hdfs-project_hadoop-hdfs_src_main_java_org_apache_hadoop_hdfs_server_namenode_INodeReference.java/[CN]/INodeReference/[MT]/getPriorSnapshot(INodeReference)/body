{
  WithCount wc=(WithCount)ref.getReferredINode();
  WithName wn=null;
  if (ref instanceof DstReference) {
    wn=wc.getLastWithName();
  }
 else   if (ref instanceof WithName) {
    wn=wc.getPriorWithName((WithName)ref);
  }
  if (wn != null) {
    INode referred=wc.getReferredINode();
    if (referred.isFile() && referred.asFile().isWithSnapshot()) {
      return referred.asFile().getDiffs().getPrior(wn.lastSnapshotId);
    }
 else     if (referred instanceof INodeDirectoryWithSnapshot) {
      return ((INodeDirectoryWithSnapshot)referred).getDiffs().getPrior(wn.lastSnapshotId);
    }
  }
  return null;
}
