{
  if (UserGroupInformation.isSecurityEnabled()) {
    return tokenUGI();
  }
  final String usernameFromQuery=params.userName();
  final String doAsUserFromQuery=params.doAsUser();
  final String remoteUser=usernameFromQuery == null ? JspHelper.getDefaultWebUserName(params.conf()) : usernameFromQuery;
  UserGroupInformation ugi=UserGroupInformation.createRemoteUser(remoteUser);
  JspHelper.checkUsername(ugi.getShortUserName(),usernameFromQuery);
  if (doAsUserFromQuery != null) {
    ugi=UserGroupInformation.createProxyUser(doAsUserFromQuery,ugi);
  }
  return ugi;
}
