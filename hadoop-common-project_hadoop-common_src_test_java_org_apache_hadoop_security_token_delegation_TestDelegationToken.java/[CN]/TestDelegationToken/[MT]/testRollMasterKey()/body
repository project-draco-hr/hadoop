{
  TestDelegationTokenSecretManager dtSecretManager=new TestDelegationTokenSecretManager(800,800,1 * 1000,3600000);
  try {
    dtSecretManager.startThreads();
    Token<TestDelegationTokenIdentifier> token=generateDelegationToken(dtSecretManager,"SomeUser","JobTracker");
    byte[] oldPasswd=token.getPassword();
    int prevNumKeys=dtSecretManager.getAllKeys().length;
    dtSecretManager.rollMasterKey();
    Assert.assertTrue(dtSecretManager.isStoreNewMasterKeyCalled);
    int currNumKeys=dtSecretManager.getAllKeys().length;
    Assert.assertEquals((currNumKeys - prevNumKeys) >= 1,true);
    ByteArrayInputStream bi=new ByteArrayInputStream(token.getIdentifier());
    TestDelegationTokenIdentifier identifier=dtSecretManager.createIdentifier();
    identifier.readFields(new DataInputStream(bi));
    byte[] newPasswd=dtSecretManager.retrievePassword(identifier);
    Assert.assertEquals(oldPasswd,newPasswd);
    while (!dtSecretManager.isRemoveStoredMasterKeyCalled) {
      Thread.sleep(200);
    }
  }
  finally {
    dtSecretManager.stopThreads();
  }
}
