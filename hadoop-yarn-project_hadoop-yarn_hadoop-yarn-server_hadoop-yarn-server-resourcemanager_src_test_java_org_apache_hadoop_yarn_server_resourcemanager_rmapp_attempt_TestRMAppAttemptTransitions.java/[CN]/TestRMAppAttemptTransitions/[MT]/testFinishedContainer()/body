{
  Container amContainer=allocateApplicationAttempt();
  launchApplicationAttempt(amContainer);
  runApplicationAttempt(amContainer,"host",8042,"oldtrackingurl",false);
  ContainerId containerId1=BuilderUtils.newContainerId(applicationAttempt.getAppAttemptId(),2);
  Container container1=mock(Container.class);
  ContainerStatus containerStatus1=mock(ContainerStatus.class);
  when(container1.getId()).thenReturn(containerId1);
  when(containerStatus1.getContainerId()).thenReturn(containerId1);
  when(container1.getNodeId()).thenReturn(NodeId.newInstance("host",1234));
  application.handle(new RMAppRunningOnNodeEvent(application.getApplicationId(),container1.getNodeId()));
  applicationAttempt.handle(new RMAppAttemptContainerFinishedEvent(applicationAttempt.getAppAttemptId(),containerStatus1,container1.getNodeId()));
  ArgumentCaptor<RMNodeFinishedContainersPulledByAMEvent> captor=ArgumentCaptor.forClass(RMNodeFinishedContainersPulledByAMEvent.class);
  Assert.assertEquals(1,applicationAttempt.getJustFinishedContainers().size());
  Assert.assertEquals(container1.getId(),applicationAttempt.getJustFinishedContainers().get(0).getContainerId());
  Assert.assertEquals(0,getFinishedContainersSentToAM(applicationAttempt).size());
  List<ContainerStatus> containerStatuses=applicationAttempt.pullJustFinishedContainers();
  Assert.assertEquals(1,containerStatuses.size());
  Mockito.verify(rmnodeEventHandler,never()).handle(Mockito.any(RMNodeEvent.class));
  Assert.assertTrue(applicationAttempt.getJustFinishedContainers().isEmpty());
  Assert.assertEquals(1,getFinishedContainersSentToAM(applicationAttempt).size());
  containerStatuses=applicationAttempt.pullJustFinishedContainers();
  Assert.assertEquals(0,containerStatuses.size());
  Mockito.verify(rmnodeEventHandler).handle(captor.capture());
  Assert.assertEquals(container1.getId(),captor.getValue().getContainers().get(0));
  Assert.assertTrue(applicationAttempt.getJustFinishedContainers().isEmpty());
  Assert.assertEquals(0,getFinishedContainersSentToAM(applicationAttempt).size());
}
