{
  Container amContainer=allocateApplicationAttempt();
  launchApplicationAttempt(amContainer);
  runApplicationAttempt(amContainer,"host",8042,"oldtrackingurl",false);
  applicationAttempt.handle(new RMAppAttemptEvent(applicationAttempt.getAppAttemptId(),RMAppAttemptEventType.KILL));
  assertEquals(RMAppAttemptState.FINAL_SAVING,applicationAttempt.getAppAttemptState());
  NodeId anyNodeId=NodeId.newInstance("host",1234);
  applicationAttempt.handle(new RMAppAttemptContainerFinishedEvent(applicationAttempt.getAppAttemptId(),BuilderUtils.newContainerStatus(amContainer.getId(),ContainerState.COMPLETE,"",0),anyNodeId));
  applicationAttempt.handle(new RMAppAttemptEvent(applicationAttempt.getAppAttemptId(),RMAppAttemptEventType.EXPIRE));
  assertEquals(RMAppAttemptState.FINAL_SAVING,applicationAttempt.getAppAttemptState());
  assertEquals(YarnApplicationAttemptState.RUNNING,applicationAttempt.createApplicationAttemptState());
  sendAttemptUpdateSavedEvent(applicationAttempt);
  assertEquals(RMAppAttemptState.KILLED,applicationAttempt.getAppAttemptState());
  assertEquals(0,applicationAttempt.getJustFinishedContainers().size());
  assertEquals(amContainer,applicationAttempt.getMasterContainer());
  assertEquals(0,application.getRanNodes().size());
  String rmAppPageUrl=pjoin(RM_WEBAPP_ADDR,"cluster","app",applicationAttempt.getAppAttemptId().getApplicationId());
  assertEquals(rmAppPageUrl,applicationAttempt.getOriginalTrackingUrl());
  assertEquals(rmAppPageUrl,applicationAttempt.getTrackingUrl());
  verifyTokenCount(applicationAttempt.getAppAttemptId(),1);
  verifyAMHostAndPortInvalidated();
  verifyApplicationAttemptFinished(RMAppAttemptState.KILLED);
}
