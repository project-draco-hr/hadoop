{
  AuthenticationMethod authMethod=AuthenticationMethod.SIMPLE;
  if (isSecurityEnabled) {
    authMethod=AuthenticationMethod.KERBEROS;
  }
  SecurityUtil.setAuthenticationMethod(authMethod,conf);
  UserGroupInformation.setConfiguration(conf);
  InlineDispatcher rmDispatcher=new InlineDispatcher();
  ContainerAllocationExpirer containerAllocationExpirer=mock(ContainerAllocationExpirer.class);
  amLivelinessMonitor=mock(AMLivelinessMonitor.class);
  amFinishingMonitor=mock(AMLivelinessMonitor.class);
  writer=mock(RMApplicationHistoryWriter.class);
  MasterKeyData masterKeyData=amRMTokenManager.createNewMasterKey();
  when(amRMTokenManager.getMasterKey()).thenReturn(masterKeyData);
  rmContext=new RMContextImpl(rmDispatcher,containerAllocationExpirer,amLivelinessMonitor,amFinishingMonitor,null,amRMTokenManager,new RMContainerTokenSecretManager(conf),nmTokenManager,clientToAMTokenManager,writer);
  store=mock(RMStateStore.class);
  ((RMContextImpl)rmContext).setStateStore(store);
  publisher=mock(SystemMetricsPublisher.class);
  ((RMContextImpl)rmContext).setSystemMetricsPublisher(publisher);
  scheduler=mock(YarnScheduler.class);
  masterService=mock(ApplicationMasterService.class);
  applicationMasterLauncher=mock(ApplicationMasterLauncher.class);
  rmDispatcher.register(RMAppAttemptEventType.class,new TestApplicationAttemptEventDispatcher());
  rmDispatcher.register(RMAppEventType.class,new TestApplicationEventDispatcher());
  rmDispatcher.register(SchedulerEventType.class,new TestSchedulerEventDispatcher());
  rmDispatcher.register(AMLauncherEventType.class,new TestAMLauncherEventDispatcher());
  rmnodeEventHandler=mock(RMNodeImpl.class);
  rmDispatcher.register(RMNodeEventType.class,rmnodeEventHandler);
  rmDispatcher.init(conf);
  rmDispatcher.start();
  ApplicationId applicationId=MockApps.newAppID(appId++);
  ApplicationAttemptId applicationAttemptId=ApplicationAttemptId.newInstance(applicationId,0);
  resourceScheduler=mock(ResourceScheduler.class);
  ApplicationResourceUsageReport appResUsgRpt=mock(ApplicationResourceUsageReport.class);
  when(appResUsgRpt.getMemorySeconds()).thenReturn(0L);
  when(appResUsgRpt.getVcoreSeconds()).thenReturn(0L);
  when(resourceScheduler.getAppResourceUsageReport((ApplicationAttemptId)Matchers.any())).thenReturn(appResUsgRpt);
  spyRMContext=spy(rmContext);
  Mockito.doReturn(resourceScheduler).when(spyRMContext).getScheduler();
  final String user=MockApps.newUserName();
  final String queue=MockApps.newQueue();
  submissionContext=mock(ApplicationSubmissionContext.class);
  when(submissionContext.getQueue()).thenReturn(queue);
  Resource resource=BuilderUtils.newResource(1536,1);
  ContainerLaunchContext amContainerSpec=BuilderUtils.newContainerLaunchContext(null,null,null,null,null,null);
  when(submissionContext.getAMContainerSpec()).thenReturn(amContainerSpec);
  when(submissionContext.getResource()).thenReturn(resource);
  unmanagedAM=false;
  application=mock(RMAppImpl.class);
  applicationAttempt=new RMAppAttemptImpl(applicationAttemptId,spyRMContext,scheduler,masterService,submissionContext,new Configuration(),false,BuilderUtils.newResourceRequest(RMAppAttemptImpl.AM_CONTAINER_PRIORITY,ResourceRequest.ANY,submissionContext.getResource(),1));
  when(application.getCurrentAppAttempt()).thenReturn(applicationAttempt);
  when(application.getApplicationId()).thenReturn(applicationId);
  spyRMContext.getRMApps().put(application.getApplicationId(),application);
  testAppAttemptNewState();
}
