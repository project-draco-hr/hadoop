{
  Container amContainer=allocateApplicationAttempt();
  launchApplicationAttempt(amContainer);
  runApplicationAttempt(amContainer,"host",8042,"oldtrackingurl",false);
  String containerDiagMsg="some error";
  int exitCode=123;
  ContainerStatus cs=BuilderUtils.newContainerStatus(amContainer.getId(),ContainerState.COMPLETE,containerDiagMsg,exitCode);
  ApplicationAttemptId appAttemptId=applicationAttempt.getAppAttemptId();
  applicationAttempt.handle(new RMAppAttemptContainerFinishedEvent(appAttemptId,cs));
  assertEquals(RMAppAttemptState.FINAL_SAVING,applicationAttempt.getAppAttemptState());
  applicationAttempt.handle(new RMAppAttemptContainerFinishedEvent(applicationAttempt.getAppAttemptId(),BuilderUtils.newContainerStatus(amContainer.getId(),ContainerState.COMPLETE,"",0)));
  applicationAttempt.handle(new RMAppAttemptEvent(applicationAttempt.getAppAttemptId(),RMAppAttemptEventType.EXPIRE));
  assertEquals(RMAppAttemptState.FINAL_SAVING,applicationAttempt.getAppAttemptState());
  assertEquals(YarnApplicationAttemptState.RUNNING,applicationAttempt.createApplicationAttemptState());
  sendAttemptUpdateSavedEvent(applicationAttempt);
  assertEquals(RMAppAttemptState.FAILED,applicationAttempt.getAppAttemptState());
  assertEquals(0,applicationAttempt.getJustFinishedContainers().size());
  assertEquals(amContainer,applicationAttempt.getMasterContainer());
  assertEquals(0,application.getRanNodes().size());
  String rmAppPageUrl=pjoin(RM_WEBAPP_ADDR,"cluster","app",applicationAttempt.getAppAttemptId().getApplicationId());
  assertEquals(rmAppPageUrl,applicationAttempt.getOriginalTrackingUrl());
  assertEquals(rmAppPageUrl,applicationAttempt.getTrackingUrl());
  verifyAMHostAndPortInvalidated();
  verifyApplicationAttemptFinished(RMAppAttemptState.FAILED);
}
