{
  String scheme=request.getScheme();
  final LocatedBlocks blks=nnproxy.getBlockLocations(status.getFullPath(new Path(path)).toUri().getPath(),0,1);
  final Configuration conf=NameNodeHttpServer.getConfFromContext(getServletContext());
  final DatanodeID host=pickSrcDatanode(blks,status,conf);
  final String hostname;
  if (host instanceof DatanodeInfo) {
    hostname=((DatanodeInfo)host).getHostName();
  }
 else {
    hostname=host.getIpAddr();
  }
  int port=host.getInfoPort();
  if ("https".equals(scheme)) {
    final Integer portObject=(Integer)getServletContext().getAttribute(DFSConfigKeys.DFS_DATANODE_HTTPS_PORT_KEY);
    if (portObject != null) {
      port=portObject;
    }
  }
  String dtParam="";
  if (dt != null) {
    dtParam=JspHelper.getDelegationTokenUrlParam(dt);
  }
  NameNode nn=NameNodeHttpServer.getNameNodeFromContext(getServletContext());
  String addr=nn.getNameNodeAddressHostPortString();
  String addrParam=JspHelper.getUrlParam(JspHelper.NAMENODE_ADDRESS,addr);
  return new URL(scheme,hostname,port,"/streamFile" + encodedPath + '?'+ "ugi="+ ServletUtil.encodeQueryValue(ugi.getShortUserName())+ dtParam+ addrParam);
}
