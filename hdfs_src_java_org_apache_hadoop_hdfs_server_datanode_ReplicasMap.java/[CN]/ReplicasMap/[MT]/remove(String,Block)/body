{
  checkBlockPool(bpid);
  checkBlock(block);
synchronized (mutex) {
    Map<Long,ReplicaInfo> m=map.get(bpid);
    if (m != null) {
      Long key=Long.valueOf(block.getBlockId());
      ReplicaInfo replicaInfo=m.get(key);
      if (replicaInfo != null && block.getGenerationStamp() == replicaInfo.getGenerationStamp()) {
        return m.remove(key);
      }
    }
  }
  return null;
}
