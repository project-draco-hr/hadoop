{
  Set<NodeId> allNMs=new HashSet<NodeId>();
  for (  Entry<String,Host> entry : before.entrySet()) {
    allNMs.addAll(entry.getValue().nms.keySet());
  }
  for (  Entry<String,Host> entry : after.entrySet()) {
    allNMs.addAll(entry.getValue().nms.keySet());
  }
  Map<NodeId,Set<String>> newNodeToLabelsMap=new HashMap<NodeId,Set<String>>();
  for (  NodeId nodeId : allNMs) {
    Node oldNM;
    if ((oldNM=getNMInNodeSet(nodeId,before,true)) != null) {
      Set<String> oldLabels=getLabelsByNode(nodeId,before);
      if (oldLabels.isEmpty()) {
        NodeLabel label=labelCollections.get(NO_LABEL);
        label.removeNode(oldNM.resource);
        for (        Queue q : queueCollections.values()) {
          Resources.subtractFrom(q.resource,oldNM.resource);
        }
      }
 else {
        for (        String labelName : oldLabels) {
          NodeLabel label=labelCollections.get(labelName);
          if (null == label) {
            continue;
          }
          label.removeNode(oldNM.resource);
        }
        for (        Queue q : queueCollections.values()) {
          if (isNodeUsableByQueue(oldLabels,q)) {
            Resources.subtractFrom(q.resource,oldNM.resource);
          }
        }
      }
    }
    Node newNM;
    if ((newNM=getNMInNodeSet(nodeId,after,true)) != null) {
      Set<String> newLabels=getLabelsByNode(nodeId,after);
      newNodeToLabelsMap.put(nodeId,ImmutableSet.copyOf(newLabels));
      if (newLabels.isEmpty()) {
        NodeLabel label=labelCollections.get(NO_LABEL);
        label.addNode(newNM.resource);
        for (        Queue q : queueCollections.values()) {
          Resources.addTo(q.resource,newNM.resource);
        }
      }
 else {
        for (        String labelName : newLabels) {
          NodeLabel label=labelCollections.get(labelName);
          label.addNode(newNM.resource);
        }
        for (        Queue q : queueCollections.values()) {
          if (isNodeUsableByQueue(newLabels,q)) {
            Resources.addTo(q.resource,newNM.resource);
          }
        }
      }
    }
  }
  if (rmContext != null && rmContext.getDispatcher() != null) {
    rmContext.getDispatcher().getEventHandler().handle(new NodeLabelsUpdateSchedulerEvent(newNodeToLabelsMap));
  }
}
