{
  if (LOG.isDebugEnabled()) {
    LOG.debug("Node offered to app: " + getName() + " reserved: "+ reserved);
  }
  Collection<Priority> prioritiesToTry=(reserved) ? Arrays.asList(node.getReservedContainer().getReservedPriority()) : app.getPriorities();
synchronized (app) {
    for (    Priority priority : prioritiesToTry) {
      if (app.getTotalRequiredResources(priority) <= 0 || !hasContainerForNode(priority,node)) {
        continue;
      }
      app.addSchedulingOpportunity(priority);
      ResourceRequest rackLocalRequest=app.getResourceRequest(priority,node.getRackName());
      ResourceRequest localRequest=app.getResourceRequest(priority,node.getNodeName());
      if (localRequest != null && !localRequest.getRelaxLocality()) {
        LOG.warn("Relax locality off is not supported on local request: " + localRequest);
      }
      NodeType allowedLocality;
      if (scheduler.isContinuousSchedulingEnabled()) {
        allowedLocality=app.getAllowedLocalityLevelByTime(priority,scheduler.getNodeLocalityDelayMs(),scheduler.getRackLocalityDelayMs(),scheduler.getClock().getTime());
      }
 else {
        allowedLocality=app.getAllowedLocalityLevel(priority,scheduler.getNumClusterNodes(),scheduler.getNodeLocalityThreshold(),scheduler.getRackLocalityThreshold());
      }
      if (rackLocalRequest != null && rackLocalRequest.getNumContainers() != 0 && localRequest != null && localRequest.getNumContainers() != 0) {
        return assignContainer(node,localRequest,NodeType.NODE_LOCAL,reserved);
      }
      if (rackLocalRequest != null && !rackLocalRequest.getRelaxLocality()) {
        continue;
      }
      if (rackLocalRequest != null && rackLocalRequest.getNumContainers() != 0 && (allowedLocality.equals(NodeType.RACK_LOCAL) || allowedLocality.equals(NodeType.OFF_SWITCH))) {
        return assignContainer(node,rackLocalRequest,NodeType.RACK_LOCAL,reserved);
      }
      ResourceRequest offSwitchRequest=app.getResourceRequest(priority,ResourceRequest.ANY);
      if (offSwitchRequest != null && !offSwitchRequest.getRelaxLocality()) {
        continue;
      }
      if (offSwitchRequest != null && offSwitchRequest.getNumContainers() != 0 && allowedLocality.equals(NodeType.OFF_SWITCH)) {
        return assignContainer(node,offSwitchRequest,NodeType.OFF_SWITCH,reserved);
      }
    }
  }
  return Resources.none();
}
