{
  LOG.info("Node offered to app: " + getName() + " reserved: "+ reserved);
  if (reserved) {
    RMContainer rmContainer=node.getReservedContainer();
    Priority priority=rmContainer.getReservedPriority();
    if (app.getTotalRequiredResources(priority) == 0) {
      unreserve(priority,node);
      return Resources.none();
    }
  }
 else {
    if (!(getRunnable())) {
      return Resources.none();
    }
  }
  Collection<Priority> prioritiesToTry=(reserved) ? Arrays.asList(node.getReservedContainer().getReservedPriority()) : app.getPriorities();
synchronized (app) {
    for (    Priority priority : prioritiesToTry) {
      if (app.getTotalRequiredResources(priority) <= 0 || !hasContainerForNode(priority,node)) {
        continue;
      }
      app.addSchedulingOpportunity(priority);
      ResourceRequest rackLocalRequest=app.getResourceRequest(priority,node.getRackName());
      ResourceRequest localRequest=app.getResourceRequest(priority,node.getHostName());
      NodeType allowedLocality=app.getAllowedLocalityLevel(priority,scheduler.getNumClusterNodes(),scheduler.getNodeLocalityThreshold(),scheduler.getRackLocalityThreshold());
      if (rackLocalRequest != null && rackLocalRequest.getNumContainers() != 0 && localRequest != null && localRequest.getNumContainers() != 0) {
        return assignContainer(node,priority,localRequest,NodeType.NODE_LOCAL,reserved);
      }
      if (rackLocalRequest != null && rackLocalRequest.getNumContainers() != 0 && (allowedLocality.equals(NodeType.RACK_LOCAL) || allowedLocality.equals(NodeType.OFF_SWITCH))) {
        return assignContainer(node,priority,rackLocalRequest,NodeType.RACK_LOCAL,reserved);
      }
      ResourceRequest offSwitchRequest=app.getResourceRequest(priority,ResourceRequest.ANY);
      if (offSwitchRequest != null && offSwitchRequest.getNumContainers() != 0 && allowedLocality.equals(NodeType.OFF_SWITCH)) {
        return assignContainer(node,priority,offSwitchRequest,NodeType.OFF_SWITCH,reserved);
      }
    }
  }
  return Resources.none();
}
