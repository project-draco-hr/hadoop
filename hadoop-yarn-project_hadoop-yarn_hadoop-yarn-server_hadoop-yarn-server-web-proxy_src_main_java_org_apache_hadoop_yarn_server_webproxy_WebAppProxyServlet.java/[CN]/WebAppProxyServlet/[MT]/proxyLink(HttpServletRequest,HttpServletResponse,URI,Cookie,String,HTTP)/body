{
  DefaultHttpClient client=new DefaultHttpClient();
  client.getParams().setParameter(ClientPNames.COOKIE_POLICY,CookiePolicy.BROWSER_COMPATIBILITY).setBooleanParameter(ClientPNames.ALLOW_CIRCULAR_REDIRECTS,true);
  InetAddress localAddress=InetAddress.getByName(proxyHost);
  if (LOG.isDebugEnabled()) {
    LOG.debug("local InetAddress for proxy host: {}",localAddress);
  }
  client.getParams().setParameter(ConnRoutePNames.LOCAL_ADDRESS,localAddress);
  HttpRequestBase base=null;
  if (method.equals(HTTP.GET)) {
    base=new HttpGet(link);
  }
 else   if (method.equals(HTTP.PUT)) {
    base=new HttpPut(link);
    StringBuilder sb=new StringBuilder();
    BufferedReader reader=new BufferedReader(new InputStreamReader(req.getInputStream(),"UTF-8"));
    String line;
    while ((line=reader.readLine()) != null) {
      sb.append(line);
    }
    ((HttpPut)base).setEntity(new StringEntity(sb.toString()));
  }
 else {
    resp.setStatus(HttpServletResponse.SC_METHOD_NOT_ALLOWED);
    return;
  }
  @SuppressWarnings("unchecked") Enumeration<String> names=req.getHeaderNames();
  while (names.hasMoreElements()) {
    String name=names.nextElement();
    if (passThroughHeaders.contains(name)) {
      String value=req.getHeader(name);
      if (LOG.isDebugEnabled()) {
        LOG.debug("REQ HEADER: {} : {}",name,value);
      }
      base.setHeader(name,value);
    }
  }
  String user=req.getRemoteUser();
  if (user != null && !user.isEmpty()) {
    base.setHeader("Cookie",PROXY_USER_COOKIE_NAME + "=" + URLEncoder.encode(user,"ASCII"));
  }
  OutputStream out=resp.getOutputStream();
  try {
    HttpResponse httpResp=client.execute(base);
    resp.setStatus(httpResp.getStatusLine().getStatusCode());
    for (    Header header : httpResp.getAllHeaders()) {
      resp.setHeader(header.getName(),header.getValue());
    }
    if (c != null) {
      resp.addCookie(c);
    }
    InputStream in=httpResp.getEntity().getContent();
    if (in != null) {
      IOUtils.copyBytes(in,out,4096,true);
    }
  }
  finally {
    base.releaseConnection();
  }
}
