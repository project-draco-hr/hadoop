{
  final int queueCapacity=Math.max(roundUp((int)(absoluteCapacity * clusterResource.getMemory())),required.getMemory());
  final int consumed=usedResources.getMemory();
  final int currentCapacity=(consumed < queueCapacity) ? queueCapacity : (consumed + required.getMemory());
  String userName=application.getUser();
  final int activeUsers=users.size();
  User user=getUser(userName);
  int limit=roundUp(Math.min(Math.max(divideAndCeil(currentCapacity,activeUsers),divideAndCeil((int)userLimit * currentCapacity,100)),(int)(queueCapacity * userLimitFactor)));
  if (LOG.isDebugEnabled()) {
    LOG.debug("User limit computation for " + userName + " in queue "+ getQueueName()+ " userLimit="+ userLimit+ " userLimitFactor="+ userLimitFactor+ " required: "+ required+ " consumed: "+ user.getConsumedResources()+ " limit: "+ limit+ " queueCapacity: "+ queueCapacity+ " qconsumed: "+ consumed+ " currentCapacity: "+ currentCapacity+ " activeUsers: "+ activeUsers+ " clusterCapacity: "+ clusterResource.getMemory());
  }
  return Resources.createResource(limit);
}
