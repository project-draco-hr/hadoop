{
  final FSPermissionChecker pc=fsd.getPermissionChecker();
  String snapshotPath=null;
  if (fsd.isPermissionEnabled()) {
    fsd.checkOwner(pc,snapshotRoot);
  }
  if (snapshotName == null || snapshotName.isEmpty()) {
    snapshotName=Snapshot.generateDefaultSnapshotName();
  }
  if (snapshotName != null) {
    if (!DFSUtil.isValidNameForComponent(snapshotName)) {
      throw new InvalidPathException("Invalid snapshot name: " + snapshotName);
    }
  }
  verifySnapshotName(fsd,snapshotName,snapshotRoot);
  fsd.writeLock();
  try {
    snapshotPath=snapshotManager.createSnapshot(snapshotRoot,snapshotName);
  }
  finally {
    fsd.writeUnlock();
  }
  fsd.getEditLog().logCreateSnapshot(snapshotRoot,snapshotName,logRetryCache);
  return snapshotPath;
}
