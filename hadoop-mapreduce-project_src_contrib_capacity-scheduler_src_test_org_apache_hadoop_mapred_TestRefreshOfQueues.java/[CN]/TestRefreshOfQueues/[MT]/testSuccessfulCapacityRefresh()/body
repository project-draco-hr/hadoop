{
  JobQueueInfo[] queues=TestQueueManagerRefresh.getSimpleQueueHierarchy();
  queues[0].getProperties().setProperty(CapacitySchedulerConf.CAPACITY_PROPERTY,String.valueOf(100));
  queues[1].getProperties().setProperty(CapacitySchedulerConf.CAPACITY_PROPERTY,String.valueOf(50));
  queues[2].getProperties().setProperty(CapacitySchedulerConf.CAPACITY_PROPERTY,String.valueOf(50));
  QueueManagerTestUtils.writeQueueConfigurationFile(queueConfigFile.getAbsolutePath(),new JobQueueInfo[]{queues[0]});
  setupAndStartSchedulerFramework(2,2,2);
  FakeJobInProgress job1=taskTrackerManager.submitJobAndInit(JobStatus.PREP,2,2,queues[1].getQueueName(),"user");
  FakeJobInProgress job2=taskTrackerManager.submitJobAndInit(JobStatus.PREP,2,2,queues[2].getQueueName(),"user");
  Map<String,String> expectedStrings=new HashMap<String,String>();
  expectedStrings.put(MAP,"attempt_test_0001_m_000001_0 on tt1");
  expectedStrings.put(REDUCE,"attempt_test_0001_r_000001_0 on tt1");
  checkMultipleTaskAssignment(taskTrackerManager,scheduler,"tt1",expectedStrings);
  expectedStrings.clear();
  expectedStrings.put(MAP,"attempt_test_0002_m_000001_0 on tt1");
  expectedStrings.put(REDUCE,"attempt_test_0002_r_000001_0 on tt1");
  checkMultipleTaskAssignment(taskTrackerManager,scheduler,"tt1",expectedStrings);
  expectedStrings.clear();
  expectedStrings.put(MAP,"attempt_test_0002_m_000002_0 on tt2");
  expectedStrings.put(REDUCE,"attempt_test_0002_r_000002_0 on tt2");
  checkMultipleTaskAssignment(taskTrackerManager,scheduler,"tt2",expectedStrings);
  expectedStrings.clear();
  expectedStrings.put(MAP,"attempt_test_0001_m_000002_0 on tt2");
  expectedStrings.put(REDUCE,"attempt_test_0001_r_000002_0 on tt2");
  checkMultipleTaskAssignment(taskTrackerManager,scheduler,"tt2",expectedStrings);
  taskTrackerManager.killJob(job1.getJobID());
  taskTrackerManager.killJob(job2.getJobID());
  queues[1].getProperties().setProperty(CapacitySchedulerConf.CAPACITY_PROPERTY,String.valueOf(25));
  queues[2].getProperties().setProperty(CapacitySchedulerConf.CAPACITY_PROPERTY,String.valueOf(75));
  QueueManagerTestUtils.writeQueueConfigurationFile(queueConfigFile.getAbsolutePath(),new JobQueueInfo[]{queues[0]});
  refreshQueues(taskTrackerManager.getQueueManager(),null,scheduler);
  job1=taskTrackerManager.submitJobAndInit(JobStatus.PREP,2,2,queues[1].getQueueName(),"user");
  job2=taskTrackerManager.submitJobAndInit(JobStatus.PREP,4,4,queues[2].getQueueName(),"user");
  expectedStrings.clear();
  expectedStrings.put(MAP,"attempt_test_0003_m_000001_0 on tt1");
  expectedStrings.put(REDUCE,"attempt_test_0003_r_000001_0 on tt1");
  checkMultipleTaskAssignment(taskTrackerManager,scheduler,"tt1",expectedStrings);
  expectedStrings.clear();
  expectedStrings.put(MAP,"attempt_test_0004_m_000001_0 on tt1");
  expectedStrings.put(REDUCE,"attempt_test_0004_r_000001_0 on tt1");
  checkMultipleTaskAssignment(taskTrackerManager,scheduler,"tt1",expectedStrings);
  expectedStrings.clear();
  expectedStrings.put(MAP,"attempt_test_0004_m_000002_0 on tt2");
  expectedStrings.put(REDUCE,"attempt_test_0004_r_000002_0 on tt2");
  checkMultipleTaskAssignment(taskTrackerManager,scheduler,"tt2",expectedStrings);
  expectedStrings.clear();
  expectedStrings.put(MAP,"attempt_test_0004_m_000003_0 on tt2");
  expectedStrings.put(REDUCE,"attempt_test_0004_r_000003_0 on tt2");
  checkMultipleTaskAssignment(taskTrackerManager,scheduler,"tt2",expectedStrings);
}
