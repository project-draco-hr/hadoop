{
  System.err.println("Testing bulk checksums of length " + dataLength + " with "+ (useDirect ? "direct" : "array-backed")+ " buffers");
  int numSums=(dataLength - 1) / checksum.getBytesPerChecksum() + 1;
  int sumsLength=numSums * checksum.getChecksumSize();
  byte data[]=new byte[dataLength + DATA_OFFSET_IN_BUFFER + DATA_TRAILER_IN_BUFFER];
  new Random().nextBytes(data);
  ByteBuffer dataBuf=ByteBuffer.wrap(data,DATA_OFFSET_IN_BUFFER,dataLength);
  byte checksums[]=new byte[SUMS_OFFSET_IN_BUFFER + sumsLength];
  ByteBuffer checksumBuf=ByteBuffer.wrap(checksums,SUMS_OFFSET_IN_BUFFER,sumsLength);
  if (useDirect) {
    dataBuf=directify(dataBuf);
    checksumBuf=directify(checksumBuf);
  }
  checksum.calculateChunkedSums(dataBuf,checksumBuf);
  checksum.verifyChunkedSums(dataBuf,checksumBuf,"fake file",0);
  corruptBufferOffset(checksumBuf,0);
  checksum.verifyChunkedSums(dataBuf,checksumBuf,"fake file",0);
  corruptBufferOffset(dataBuf,0);
  dataBuf.limit(dataBuf.limit() + 1);
  corruptBufferOffset(dataBuf,dataLength + DATA_OFFSET_IN_BUFFER);
  dataBuf.limit(dataBuf.limit() - 1);
  checksum.verifyChunkedSums(dataBuf,checksumBuf,"fake file",0);
  corruptBufferOffset(checksumBuf,SUMS_OFFSET_IN_BUFFER);
  try {
    checksum.verifyChunkedSums(dataBuf,checksumBuf,"fake file",0);
    fail("Did not throw on bad checksums");
  }
 catch (  ChecksumException ce) {
    assertEquals(0,ce.getPos());
  }
  uncorruptBufferOffset(checksumBuf,SUMS_OFFSET_IN_BUFFER);
  corruptBufferOffset(checksumBuf,SUMS_OFFSET_IN_BUFFER + sumsLength - 1);
  try {
    checksum.verifyChunkedSums(dataBuf,checksumBuf,"fake file",0);
    fail("Did not throw on bad checksums");
  }
 catch (  ChecksumException ce) {
    int expectedPos=checksum.getBytesPerChecksum() * (numSums - 1);
    assertEquals(expectedPos,ce.getPos());
    assertTrue(ce.getMessage().contains("fake file"));
  }
}
