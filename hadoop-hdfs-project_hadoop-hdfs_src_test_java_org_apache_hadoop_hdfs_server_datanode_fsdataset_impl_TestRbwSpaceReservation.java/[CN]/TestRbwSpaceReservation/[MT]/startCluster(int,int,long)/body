{
  initConfig(blockSize);
  cluster=new MiniDFSCluster.Builder(conf).storagesPerDatanode(STORAGES_PER_DATANODE).numDataNodes(numDatanodes).build();
  fs=cluster.getFileSystem();
  client=fs.getClient();
  cluster.waitActive();
  if (perVolumeCapacity >= 0) {
    for (    DataNode dn : cluster.getDataNodes()) {
      for (      FsVolumeSpi volume : dn.getFSDataset().getVolumes()) {
        ((FsVolumeImpl)volume).setCapacityForTesting(perVolumeCapacity);
      }
    }
  }
  if (numDatanodes == 1) {
    List<? extends FsVolumeSpi> volumes=cluster.getDataNodes().get(0).getFSDataset().getVolumes();
    assertThat(volumes.size(),is(1));
    singletonVolume=((FsVolumeImpl)volumes.get(0));
  }
}
