{
  MiniDFSCluster dfsCluster=null;
  try {
    Configuration config=new Configuration();
    dfsCluster=new MiniDFSCluster.Builder(config).numDataNodes(1).build();
    dfsCluster.waitActive();
    dfsCluster.restartNameNode(true);
    BlockManagerTestUtil.checkHeartbeat(dfsCluster.getNamesystem().getBlockManager());
    MBeanServer mbs=ManagementFactory.getPlatformMBeanServer();
    ObjectName mxbeanNameFsns=new ObjectName("Hadoop:service=NameNode,name=FSNamesystemState");
    Integer numStaleStorages=(Integer)(mbs.getAttribute(mxbeanNameFsns,"NumStaleStorages"));
    assertEquals(0,numStaleStorages.intValue());
  }
  finally {
    if (dfsCluster != null) {
      dfsCluster.shutdown();
    }
  }
  return;
}
