{
  Configuration conf=new Configuration();
  RPC.setProtocolEngine(conf,AvroTestProtocol.class,AvroRpcEngine.class);
  Server server=RPC.getServer(AvroTestProtocol.class,new TestImpl(),ADDRESS,0,conf);
  AvroTestProtocol proxy=null;
  try {
    server.start();
    InetSocketAddress addr=NetUtils.getConnectAddress(server);
    proxy=(AvroTestProtocol)RPC.getProxy(AvroTestProtocol.class,0,addr,conf);
    proxy.ping();
    Utf8 utf8Result=proxy.echo(new Utf8("hello world"));
    assertEquals(new Utf8("hello world"),utf8Result);
    int intResult=proxy.add(1,2);
    assertEquals(3,intResult);
    boolean caught=false;
    try {
      proxy.error();
    }
 catch (    AvroRemoteException e) {
      LOG.debug("Caught " + e);
      caught=true;
    }
    assertTrue(caught);
  }
  finally {
    server.stop();
  }
}
