{
  final FSDataset dataset=((FSDataset)datanode.data);
  final Collection<ReplicaInfo> replicas=dataset.volumeMap.replicas(bpid);
  for (int i=0; i < 5 && replicas.size() == 0; i++) {
    LOG.info("wait since replicas.size() == 0; i=" + i);
    Thread.sleep(1000);
  }
  Assert.assertEquals(1,replicas.size());
  final ReplicaInfo r=replicas.iterator().next();
  Assert.assertEquals(expectedState,r.getState());
  return (ReplicaInPipeline)r;
}
