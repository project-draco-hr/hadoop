{
  final DatanodeManager datanodeManager=getBlockManager().getDatanodeManager();
  if (isInSafeMode()) {
    return;
  }
  boolean allAlive=false;
  while (!allAlive) {
    boolean foundDead=false;
    DatanodeID nodeID=null;
synchronized (heartbeats) {
      for (Iterator<DatanodeDescriptor> it=heartbeats.iterator(); it.hasNext(); ) {
        DatanodeDescriptor nodeInfo=it.next();
        if (datanodeManager.isDatanodeDead(nodeInfo)) {
          expiredHeartbeats.incr();
          foundDead=true;
          nodeID=nodeInfo;
          break;
        }
      }
    }
    if (foundDead) {
      writeLock();
      if (isInSafeMode()) {
        return;
      }
      try {
        datanodeManager.removeDeadDatanode(nodeID);
      }
  finally {
        writeUnlock();
      }
    }
    allAlive=!foundDead;
  }
}
