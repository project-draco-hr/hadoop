{
  readLock();
  try {
    if (!isPopulatingReplQueues()) {
      throw new IOException("Cannot run listCorruptFileBlocks because " + "replication queues have not been initialized.");
    }
    checkSuperuserPrivilege();
    long startBlockId=0;
    int count=0;
    ArrayList<CorruptFileBlockInfo> corruptFiles=new ArrayList<CorruptFileBlockInfo>();
    if (startBlockAfter != null) {
      startBlockId=Block.filename2id(startBlockAfter);
    }
    BlockIterator blkIterator=blockManager.getCorruptReplicaBlockIterator();
    while (blkIterator.hasNext()) {
      Block blk=blkIterator.next();
      INode inode=blockManager.getINode(blk);
      if (inode != null && blockManager.countNodes(blk).liveReplicas() == 0) {
        String src=FSDirectory.getFullPathName(inode);
        if (((startBlockAfter == null) || (blk.getBlockId() > startBlockId)) && (src.startsWith(path))) {
          corruptFiles.add(new CorruptFileBlockInfo(src,blk));
          count++;
          if (count >= DEFAULT_MAX_CORRUPT_FILEBLOCKS_RETURNED)           break;
        }
      }
    }
    LOG.info("list corrupt file blocks returned: " + count);
    return corruptFiles;
  }
  finally {
    readUnlock();
  }
}
