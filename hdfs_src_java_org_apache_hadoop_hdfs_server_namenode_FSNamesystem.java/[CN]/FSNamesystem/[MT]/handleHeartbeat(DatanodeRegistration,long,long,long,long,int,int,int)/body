{
  readLock();
  try {
    final int maxTransfer=blockManager.getMaxReplicationStreams() - xmitsInProgress;
    DatanodeCommand[] cmds=blockManager.getDatanodeManager().handleHeartbeat(nodeReg,blockPoolId,capacity,dfsUsed,remaining,blockPoolUsed,xceiverCount,maxTransfer,failedVolumes);
    if (cmds != null) {
      return cmds;
    }
    DatanodeCommand cmd=getDistributedUpgradeCommand();
    if (cmd != null) {
      return new DatanodeCommand[]{cmd};
    }
    return null;
  }
  finally {
    readUnlock();
  }
}
