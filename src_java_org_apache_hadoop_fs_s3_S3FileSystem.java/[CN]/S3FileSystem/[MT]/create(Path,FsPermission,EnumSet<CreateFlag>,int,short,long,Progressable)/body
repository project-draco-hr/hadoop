{
  INode inode=store.retrieveINode(makeAbsolute(file));
  if (inode != null) {
    if (flag.contains(CreateFlag.OVERWRITE)) {
      delete(file,true);
    }
 else     if (flag.contains(CreateFlag.APPEND)) {
      return append(file,bufferSize,progress);
    }
 else {
      throw new IOException("File already exists: " + file);
    }
  }
 else {
    if (flag.contains(CreateFlag.APPEND) && !flag.contains(CreateFlag.CREATE))     throw new FileNotFoundException("File does not exist: " + file);
    Path parent=file.getParent();
    if (parent != null) {
      if (!mkdirs(parent)) {
        throw new IOException("Mkdirs failed to create " + parent.toString());
      }
    }
  }
  return new FSDataOutputStream(new S3OutputStream(getConf(),store,makeAbsolute(file),blockSize,progress,bufferSize),statistics);
}
