{
  setup();
  boolean isCapacityScheduler=resourceManager.getResourceScheduler() instanceof CapacityScheduler;
  assumeTrue("This test is only supported on Capacity Scheduler",isCapacityScheduler);
  String host_0="host_0";
  NodeManager nm_0=registerNode(host_0,1234,2345,NetworkTopology.DEFAULT_RACK,Resources.createResource(5 * 1024,1));
  Priority priority_0=org.apache.hadoop.yarn.server.resourcemanager.resource.Priority.create(0);
  Priority priority_1=org.apache.hadoop.yarn.server.resourcemanager.resource.Priority.create(1);
  Application application_0=new Application("user_0","default",resourceManager);
  application_0.submit();
  application_0.addNodeManager(host_0,1234,nm_0);
  Resource capability_0_0=Resources.createResource(1024,1);
  application_0.addResourceRequestSpec(priority_1,capability_0_0);
  Resource capability_0_1=Resources.createResource(2 * 1024,1);
  application_0.addResourceRequestSpec(priority_0,capability_0_1);
  Task task_0_0=new Task(application_0,priority_1,new String[]{host_0});
  application_0.addTask(task_0_0);
  Task task_0_1=new Task(application_0,priority_0,new String[]{host_0});
  application_0.addTask(task_0_1);
  application_0.schedule();
  nodeUpdate(nm_0);
  SchedulerHealth sh=((CapacityScheduler)resourceManager.getResourceScheduler()).getSchedulerHealth();
  Assert.assertEquals(2,sh.getAllocationCount().longValue());
  Assert.assertEquals(Resource.newInstance(3 * 1024,2),sh.getResourcesAllocated());
  Assert.assertEquals(2,sh.getAggregateAllocationCount().longValue());
  Assert.assertEquals("host_0:1234",sh.getLastAllocationDetails().getNodeId().toString());
  Assert.assertEquals("root.default",sh.getLastAllocationDetails().getQueue());
  Task task_0_2=new Task(application_0,priority_0,new String[]{host_0});
  application_0.addTask(task_0_2);
  application_0.schedule();
  nodeUpdate(nm_0);
  Assert.assertEquals(1,sh.getAllocationCount().longValue());
  Assert.assertEquals(Resource.newInstance(2 * 1024,1),sh.getResourcesAllocated());
  Assert.assertEquals(3,sh.getAggregateAllocationCount().longValue());
  Assert.assertEquals("host_0:1234",sh.getLastAllocationDetails().getNodeId().toString());
  Assert.assertEquals("root.default",sh.getLastAllocationDetails().getQueue());
}
