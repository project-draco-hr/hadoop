{
  bmSafeMode.activate(BLOCK_TOTAL);
  setSafeModeStatus(BMSafeModeStatus.PENDING_THRESHOLD);
  for (long i=0; i < BLOCK_THRESHOLD; i++) {
    setBlockSafe(i);
    bmSafeMode.checkSafeMode();
    assertEquals(BMSafeModeStatus.PENDING_THRESHOLD,getSafeModeStatus());
  }
  Whitebox.setInternalState(bmSafeMode,"extension",Integer.MAX_VALUE);
  setSafeModeStatus(BMSafeModeStatus.PENDING_THRESHOLD);
  setBlockSafe(BLOCK_THRESHOLD);
  bmSafeMode.checkSafeMode();
  assertEquals(BMSafeModeStatus.EXTENSION,getSafeModeStatus());
  Whitebox.setInternalState(bmSafeMode,"extension",0);
  setSafeModeStatus(BMSafeModeStatus.PENDING_THRESHOLD);
  setBlockSafe(BLOCK_THRESHOLD);
  bmSafeMode.checkSafeMode();
  assertEquals(BMSafeModeStatus.OFF,getSafeModeStatus());
  setBlockSafe(0);
  setSafeModeStatus(BMSafeModeStatus.EXTENSION);
  Whitebox.setInternalState(bmSafeMode,"extension",0);
  bmSafeMode.checkSafeMode();
  assertEquals(BMSafeModeStatus.EXTENSION,getSafeModeStatus());
  Whitebox.setInternalState(bmSafeMode,"extension",Integer.MAX_VALUE);
  setSafeModeStatus(BMSafeModeStatus.EXTENSION);
  setBlockSafe(BLOCK_THRESHOLD);
  bmSafeMode.checkSafeMode();
  assertEquals(BMSafeModeStatus.EXTENSION,getSafeModeStatus());
  doReturn(true).when(fsn).inTransitionToActive();
  Whitebox.setInternalState(bmSafeMode,"extension",0);
  setSafeModeStatus(BMSafeModeStatus.PENDING_THRESHOLD);
  setBlockSafe(BLOCK_THRESHOLD);
  bmSafeMode.checkSafeMode();
  assertEquals(BMSafeModeStatus.PENDING_THRESHOLD,getSafeModeStatus());
  doReturn(false).when(fsn).inTransitionToActive();
  bmSafeMode.checkSafeMode();
  assertEquals(BMSafeModeStatus.OFF,getSafeModeStatus());
}
