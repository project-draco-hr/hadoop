{
  Configuration conf=new HdfsConfiguration();
  conf.setDouble(DFSConfigKeys.DFS_NAMENODE_SAFEMODE_THRESHOLD_PCT_KEY,THRESHOLD);
  conf.setInt(DFSConfigKeys.DFS_NAMENODE_SAFEMODE_EXTENSION_KEY,EXTENSION);
  conf.setInt(DFSConfigKeys.DFS_NAMENODE_SAFEMODE_MIN_DATANODES_KEY,DATANODE_NUM);
  FSNamesystem fsn=mock(FSNamesystem.class);
  doReturn(true).when(fsn).hasWriteLock();
  doReturn(true).when(fsn).hasReadLock();
  doReturn(true).when(fsn).isRunning();
  NameNode.initMetrics(conf,NamenodeRole.NAMENODE);
  bm=spy(new BlockManager(fsn,false,conf));
  doReturn(true).when(bm).isGenStampInFuture(any(Block.class));
  dn=spy(bm.getDatanodeManager());
  Whitebox.setInternalState(bm,"datanodeManager",dn);
  when(dn.getNumLiveDataNodes()).thenReturn(DATANODE_NUM);
  bmSafeMode=new BlockManagerSafeMode(bm,fsn,false,conf);
}
