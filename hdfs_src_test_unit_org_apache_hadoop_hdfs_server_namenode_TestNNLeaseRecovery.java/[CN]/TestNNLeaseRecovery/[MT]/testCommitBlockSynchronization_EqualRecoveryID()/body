{
  if (LOG.isDebugEnabled()) {
    LOG.debug("Running " + GenericTestUtils.getMethodName());
  }
  long recoveryId=2002;
  long newSize=273487234;
  Path file=spy(new Path("/" + GenericTestUtils.getMethodName() + "_test.dat"));
  DatanodeDescriptor dnd=mock(DatanodeDescriptor.class);
  PermissionStatus ps=new PermissionStatus("test","test",new FsPermission((short)0777));
  mockFileBlocks(2,HdfsConstants.BlockUCState.COMMITTED,HdfsConstants.BlockUCState.UNDER_CONSTRUCTION,file,dnd,ps,true);
  BlockInfo lastBlock=fsn.dir.getFileINode(anyString()).getLastBlock();
  when(((BlockInfoUnderConstruction)lastBlock).getBlockRecoveryId()).thenReturn(recoveryId);
  boolean recoveryChecked=false;
  try {
    fsn.commitBlockSynchronization(fsn.getExtendedBlock(lastBlock),recoveryId,newSize,true,false,new DatanodeID[1]);
  }
 catch (  NullPointerException ioe) {
    LOG.info("Exception ",ioe);
    recoveryChecked=true;
  }
  assertTrue("commitBlockSynchronization had to throw NPE here",recoveryChecked);
}
