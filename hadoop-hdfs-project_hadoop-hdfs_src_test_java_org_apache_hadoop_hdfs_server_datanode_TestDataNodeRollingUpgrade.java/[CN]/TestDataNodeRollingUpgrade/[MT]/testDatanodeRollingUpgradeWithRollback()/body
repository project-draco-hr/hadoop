{
  try {
    startCluster();
    Path testFile1=new Path("/" + GenericTestUtils.getMethodName() + ".01.dat");
    DFSTestUtil.createFile(fs,testFile1,FILE_SIZE,REPL_FACTOR,SEED);
    String fileContents1=DFSTestUtil.readFile(fs,testFile1);
    startRollingUpgrade();
    File blockFile=getBlockForFile(testFile1,true);
    File trashFile=getTrashFileForBlock(blockFile,false);
    deleteAndEnsureInTrash(testFile1,blockFile,trashFile);
    rollbackRollingUpgrade();
    ensureTrashRestored(blockFile,trashFile);
    assert(fs.exists(testFile1));
    String fileContents2=DFSTestUtil.readFile(fs,testFile1);
    assertThat(fileContents1,is(fileContents2));
  }
  finally {
    shutdownCluster();
  }
}
