{
  try {
    conf=new HdfsConfiguration();
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(REPL_FACTOR).build();
    cluster.waitActive();
    fs=cluster.getFileSystem();
    Path testFile1=new Path("/TestDataNodeRollingUpgrade1.dat");
    DFSTestUtil.createFile(fs,testFile1,BLOCK_SIZE,BLOCK_SIZE,FILE_SIZE,REPL_FACTOR,SEED);
    String fileContents1=DFSTestUtil.readFile(fs,testFile1);
    startRollingUpgrade();
    cluster.triggerHeartbeats();
    Thread.sleep(5000);
    LOG.info("Deleting file during rolling upgrade");
    fs.delete(testFile1,false);
    cluster.triggerBlockReports();
    Thread.sleep(5000);
    assert(!fs.exists(testFile1));
    rollbackRollingUpgrade();
    assert(fs.exists(testFile1));
    String fileContents2=DFSTestUtil.readFile(fs,testFile1);
    assertThat(fileContents1,is(fileContents2));
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
      cluster=null;
    }
  }
}
