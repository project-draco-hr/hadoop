{
  try {
    startCluster();
    rollingUpgradeAndFinalize();
    DataNodeProperties dn=cluster.stopDataNode(0);
    cluster.restartNameNode(0,true,"-upgrade");
    cluster.restartDataNode(dn,true);
    cluster.waitActive();
    fs=cluster.getFileSystem(0);
    Path testFile3=new Path("/" + GenericTestUtils.getMethodName() + ".03.dat");
    DFSTestUtil.createFile(fs,testFile3,FILE_SIZE,REPL_FACTOR,SEED);
    cluster.getFileSystem().finalizeUpgrade();
  }
  finally {
    shutdownCluster();
  }
}
