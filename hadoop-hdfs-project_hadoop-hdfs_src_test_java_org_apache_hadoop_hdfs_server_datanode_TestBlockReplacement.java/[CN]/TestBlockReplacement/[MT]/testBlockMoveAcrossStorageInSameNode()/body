{
  final Configuration conf=new HdfsConfiguration();
  final MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(1).storageTypes(new StorageType[]{StorageType.DISK,StorageType.ARCHIVE}).build();
  try {
    cluster.waitActive();
    final DistributedFileSystem dfs=cluster.getFileSystem();
    final Path file=new Path("/testBlockMoveAcrossStorageInSameNode/file");
    DFSTestUtil.createFile(dfs,file,1024,(short)1,1024);
    LocatedBlocks locatedBlocks=dfs.getClient().getLocatedBlocks(file.toString(),0);
    LocatedBlock locatedBlock=locatedBlocks.get(0);
    ExtendedBlock block=locatedBlock.getBlock();
    DatanodeInfo[] locations=locatedBlock.getLocations();
    assertEquals(1,locations.length);
    StorageType[] storageTypes=locatedBlock.getStorageTypes();
    assertTrue(storageTypes[0] == StorageType.DISK);
    DatanodeInfo source=locations[0];
    assertTrue(replaceBlock(block,source,source,source,StorageType.ARCHIVE));
    Thread.sleep(3000);
    locatedBlocks=dfs.getClient().getLocatedBlocks(file.toString(),0);
    locatedBlock=locatedBlocks.get(0);
    assertEquals("Storage should be only one",1,locatedBlock.getLocations().length);
    assertTrue("Block should be moved to ARCHIVE",locatedBlock.getStorageTypes()[0] == StorageType.ARCHIVE);
  }
  finally {
    cluster.shutdown();
  }
}
