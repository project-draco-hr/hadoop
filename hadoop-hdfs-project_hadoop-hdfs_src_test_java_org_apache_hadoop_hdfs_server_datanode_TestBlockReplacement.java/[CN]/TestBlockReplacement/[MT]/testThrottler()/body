{
  Configuration conf=new HdfsConfiguration();
  FileSystem.setDefaultUri(conf,"hdfs://localhost:0");
  long bandwidthPerSec=1024 * 1024L;
  final long TOTAL_BYTES=6 * bandwidthPerSec;
  long bytesToSend=TOTAL_BYTES;
  long start=Time.monotonicNow();
  DataTransferThrottler throttler=new DataTransferThrottler(bandwidthPerSec);
  long bytesSent=1024 * 512L;
  throttler.throttle(bytesSent);
  bytesToSend-=bytesSent;
  bytesSent=1024 * 768L;
  throttler.throttle(bytesSent);
  bytesToSend-=bytesSent;
  try {
    Thread.sleep(1000);
  }
 catch (  InterruptedException ignored) {
  }
  throttler.throttle(bytesToSend);
  long end=Time.monotonicNow();
  assertTrue(TOTAL_BYTES * 1000 / (end - start) <= bandwidthPerSec);
}
