{
  configureScheduler();
  YarnConfiguration conf=getConf();
  MockRM rm1=new MockRM(conf);
  try {
    rm1.start();
    RMApp app1=rm1.submitApp(200,"name","user",new HashMap<ApplicationAccessType,String>(),false,"default",-1,null,"Test",false,true);
    MockNM nm1=new MockNM("127.0.0.1:1234",10240,rm1.getResourceTrackerService());
    nm1.registerNode();
    MockNM nm2=new MockNM("127.0.0.1:2351",10240,rm1.getResourceTrackerService());
    nm2.registerNode();
    MockAM am1=MockRM.launchAndRegisterAM(app1,rm1,nm1);
    int NUM_CONTAINERS=1;
    am1.allocate("127.0.0.1",1024,NUM_CONTAINERS,new ArrayList<ContainerId>());
    nm1.nodeHeartbeat(true);
    List<Container> containers=am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>()).getAllocatedContainers();
    while (containers.size() != NUM_CONTAINERS) {
      nm1.nodeHeartbeat(true);
      containers.addAll(am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>()).getAllocatedContainers());
      Thread.sleep(200);
    }
    nm1.nodeHeartbeat(am1.getApplicationAttemptId(),2,ContainerState.RUNNING);
    ContainerId containerId2=ContainerId.newContainerId(am1.getApplicationAttemptId(),2);
    rm1.waitForState(nm1,containerId2,RMContainerState.RUNNING);
    am1.allocate("127.0.0.1",1024,NUM_CONTAINERS,new ArrayList<ContainerId>());
    nm2.nodeHeartbeat(true);
    ContainerId containerId3=ContainerId.newContainerId(am1.getApplicationAttemptId(),3);
    rm1.waitForState(nm2,containerId3,RMContainerState.ALLOCATED);
    nm2.registerNode();
    rm1.waitForState(nm2,containerId3,RMContainerState.KILLED);
    containers=am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>()).getAllocatedContainers();
    while (containers.size() != NUM_CONTAINERS) {
      nm2.nodeHeartbeat(true);
      containers.addAll(am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>()).getAllocatedContainers());
      Thread.sleep(200);
    }
    nm2.nodeHeartbeat(am1.getApplicationAttemptId(),4,ContainerState.RUNNING);
    ContainerId containerId4=ContainerId.newContainerId(am1.getApplicationAttemptId(),4);
    rm1.waitForState(nm2,containerId4,RMContainerState.RUNNING);
  }
  finally {
    rm1.stop();
  }
}
