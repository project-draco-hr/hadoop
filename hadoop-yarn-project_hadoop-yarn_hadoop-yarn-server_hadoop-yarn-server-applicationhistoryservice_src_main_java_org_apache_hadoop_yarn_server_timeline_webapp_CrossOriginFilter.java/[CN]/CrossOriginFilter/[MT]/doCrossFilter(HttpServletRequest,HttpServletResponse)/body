{
  String origin=encodeHeader(req.getHeader(ORIGIN));
  if (!isCrossOrigin(origin)) {
    return;
  }
  if (!isOriginAllowed(origin)) {
    return;
  }
  String accessControlRequestMethod=req.getHeader(ACCESS_CONTROL_REQUEST_METHOD);
  if (!isMethodAllowed(accessControlRequestMethod)) {
    return;
  }
  String accessControlRequestHeaders=req.getHeader(ACCESS_CONTROL_REQUEST_HEADERS);
  if (!areHeadersAllowed(accessControlRequestHeaders)) {
    return;
  }
  res.setHeader(ACCESS_CONTROL_ALLOW_ORIGIN,origin);
  res.setHeader(ACCESS_CONTROL_ALLOW_CREDENTIALS,Boolean.TRUE.toString());
  res.setHeader(ACCESS_CONTROL_ALLOW_METHODS,getAllowedMethodsHeader());
  res.setHeader(ACCESS_CONTROL_ALLOW_HEADERS,getAllowedHeadersHeader());
  res.setHeader(ACCESS_CONTROL_MAX_AGE,maxAge);
}
