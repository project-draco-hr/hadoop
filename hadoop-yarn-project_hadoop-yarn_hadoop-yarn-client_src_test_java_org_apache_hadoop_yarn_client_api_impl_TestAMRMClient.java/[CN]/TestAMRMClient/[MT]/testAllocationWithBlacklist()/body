{
  AMRMClientImpl<ContainerRequest> amClient=null;
  try {
    amClient=(AMRMClientImpl<ContainerRequest>)AMRMClient.<ContainerRequest>createAMRMClient();
    amClient.init(conf);
    amClient.start();
    amClient.registerApplicationMaster("Host",10000,"");
    assertEquals(0,amClient.ask.size());
    assertEquals(0,amClient.release.size());
    ContainerRequest storedContainer1=new ContainerRequest(capability,nodes,racks,priority);
    amClient.addContainerRequest(storedContainer1);
    assertEquals(3,amClient.ask.size());
    assertEquals(0,amClient.release.size());
    List<String> localNodeBlacklist=new ArrayList<String>();
    localNodeBlacklist.add(node);
    amClient.updateBlacklist(localNodeBlacklist,null);
    int allocatedContainerCount=getAllocatedContainersNumber(amClient,DEFAULT_ITERATION);
    assertEquals(0,allocatedContainerCount);
    amClient.updateBlacklist(null,localNodeBlacklist);
    ContainerRequest storedContainer2=new ContainerRequest(capability,nodes,racks,priority);
    amClient.addContainerRequest(storedContainer2);
    allocatedContainerCount=getAllocatedContainersNumber(amClient,DEFAULT_ITERATION);
    assertEquals(2,allocatedContainerCount);
    assertTrue(amClient.blacklistAdditions.isEmpty());
    assertTrue(amClient.blacklistRemovals.isEmpty());
    ContainerRequest invalidContainerRequest=new ContainerRequest(Resource.newInstance(-1024,1),nodes,racks,priority);
    amClient.addContainerRequest(invalidContainerRequest);
    amClient.updateBlacklist(localNodeBlacklist,null);
    try {
      amClient.allocate(0.1f);
      fail("there should be an exception here.");
    }
 catch (    Exception e) {
      assertEquals(1,amClient.blacklistAdditions.size());
    }
  }
  finally {
    if (amClient != null && amClient.getServiceState() == STATE.STARTED) {
      amClient.stop();
    }
  }
}
