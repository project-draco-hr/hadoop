{
  AMRMClient<ContainerRequest> amClient=null;
  try {
    amClient=AMRMClient.<ContainerRequest>createAMRMClient();
    amClient.setNMTokenCache(new NMTokenCache());
    Assert.assertNotSame(NMTokenCache.getSingleton(),amClient.getNMTokenCache());
    amClient.init(conf);
    amClient.start();
    amClient.registerApplicationMaster("Host",10000,"");
    if (useAllocReqId) {
      testAllocRequestId((AMRMClientImpl<ContainerRequest>)amClient);
    }
 else {
      testAllocation((AMRMClientImpl<ContainerRequest>)amClient);
    }
    amClient.unregisterApplicationMaster(FinalApplicationStatus.SUCCEEDED,null,null);
  }
  finally {
    if (amClient != null && amClient.getServiceState() == STATE.STARTED) {
      amClient.stop();
    }
  }
}
