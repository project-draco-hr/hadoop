{
  NameNode nn=null;
  try {
    nn=startNameNode();
    Configuration conf2=new HdfsConfiguration(config);
    conf2.set(DFSConfigKeys.DFS_DATANODE_DATA_DIR_KEY,new File(hdfsDir,"data").getPath());
    conf2.set("dfs.datanode.address",FileSystem.getDefaultUri(config).getAuthority());
    conf2.set("dfs.datanode.http.address",THIS_HOST);
    boolean started=canStartDataNode(conf2);
    assertFalse(started);
    conf2.set("dfs.datanode.address",THIS_HOST);
    conf2.set("dfs.datanode.http.address",config.get(DFSConfigKeys.DFS_NAMENODE_HTTP_ADDRESS_KEY));
    started=canStartDataNode(conf2);
    assertFalse(started);
    conf2.set("dfs.datanode.address",THIS_HOST);
    conf2.set("dfs.datanode.http.address",THIS_HOST);
    conf2.set("dfs.datanode.ipc.address",THIS_HOST);
    started=canStartDataNode(conf2);
    assertTrue(started);
  }
  finally {
    stopNameNode(nn);
  }
}
