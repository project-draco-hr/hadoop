{
  Exception firstException=null;
  List<Service> services=getServices();
  for (int i=numOfServicesStarted - 1; i >= 0; i--) {
    Service service=services.get(i);
    if (LOG.isDebugEnabled()) {
      LOG.debug("Stopping service #" + i + ": "+ service);
    }
    STATE state=service.getServiceState();
    if (state == STATE.STARTED || (!stopOnlyStartedServices && state == STATE.INITED)) {
      Exception ex=ServiceOperations.stopQuietly(LOG,service);
      if (ex != null && firstException == null) {
        firstException=ex;
      }
    }
  }
  if (firstException != null) {
    throw ServiceStateException.convert(firstException);
  }
}
