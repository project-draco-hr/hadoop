{
  if (isCached(bpid,block)) {
    return;
  }
  MappableBlock mapBlock=null;
  try {
    mapBlock=new MappableBlock(bpid,block,volume,blockIn,metaIn);
  }
 catch (  IOException e) {
    LOG.warn("Failed to cache replica " + block + ": Could not instantiate"+ " MappableBlock",e);
    IOUtils.closeQuietly(blockIn);
    IOUtils.closeQuietly(metaIn);
    return;
  }
  boolean success=false;
  long bytes=mapBlock.getNumBytes();
  long used=usedBytes.get();
  while (used + bytes < maxBytes) {
    if (usedBytes.compareAndSet(used,used + bytes)) {
      success=true;
      break;
    }
    used=usedBytes.get();
  }
  if (!success) {
    LOG.warn(String.format("Failed to cache replica %s: %s exceeded (%d + %d > %d)",mapBlock.getBlock().toString(),DFSConfigKeys.DFS_DATANODE_MAX_LOCKED_MEMORY_KEY,used,bytes,maxBytes));
    mapBlock.close();
    return;
  }
  volume.getExecutor().execute(new WorkerTask(mapBlock));
}
