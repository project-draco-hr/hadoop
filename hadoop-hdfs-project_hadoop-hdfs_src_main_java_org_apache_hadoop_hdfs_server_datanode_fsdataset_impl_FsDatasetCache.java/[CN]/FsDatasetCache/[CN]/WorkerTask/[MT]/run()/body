{
  boolean success=false;
  try {
    block.map();
    block.lock();
    block.verifyChecksum();
    success=true;
  }
 catch (  ChecksumException e) {
    LOG.warn("Failed to cache block " + block.getBlock() + ": Checksum "+ "verification failed.");
  }
catch (  IOException e) {
    LOG.warn("Failed to cache block " + block.getBlock() + ": IOException",e);
  }
  if (!success || !dataset.validToCache(block.getBlockPoolId(),block.getBlock())) {
    block.close();
    long used=usedBytes.get();
    while (!usedBytes.compareAndSet(used,used - block.getNumBytes())) {
      used=usedBytes.get();
    }
  }
 else {
    cachedBlocks.put(block.getBlock().getBlockId(),block);
  }
}
