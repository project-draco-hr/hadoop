{
  final ExtendedBlock blk=constructInternalBlock(bg.getBlock(),cellSize,dataBlkNum,idxInBlockGroup);
  final LocatedBlock locatedBlock;
  if (idxInReturnedLocs < bg.getLocations().length) {
    locatedBlock=new LocatedBlock(blk,new DatanodeInfo[]{bg.getLocations()[idxInReturnedLocs]},new String[]{bg.getStorageIDs()[idxInReturnedLocs]},new StorageType[]{bg.getStorageTypes()[idxInReturnedLocs]},bg.getStartOffset(),bg.isCorrupt(),null);
  }
 else {
    locatedBlock=new LocatedBlock(blk,null,null,null,bg.getStartOffset(),bg.isCorrupt(),null);
  }
  Token<BlockTokenIdentifier>[] blockTokens=bg.getBlockTokens();
  if (idxInReturnedLocs < blockTokens.length) {
    locatedBlock.setBlockToken(blockTokens[idxInReturnedLocs]);
  }
  return locatedBlock;
}
