{
  if (!from.exists()) {
    return;
  }
  if (!from.isDirectory()) {
    if (from.getName().startsWith(COPY_FILE_PREFIX)) {
      FileInputStream in=new FileInputStream(from);
      try {
        FileOutputStream out=new FileOutputStream(to);
        try {
          IOUtils.copyBytes(in,out,16 * 1024);
          hl.linkStats.countPhysicalFileCopies++;
        }
  finally {
          out.close();
        }
      }
  finally {
        in.close();
      }
    }
 else {
      if (oldLV >= PRE_GENERATIONSTAMP_LAYOUT_VERSION) {
        to=new File(convertMetatadataFileName(to.getAbsolutePath()));
      }
      HardLink.createHardLink(from,to);
      hl.linkStats.countSingleLinks++;
    }
    return;
  }
  hl.linkStats.countDirs++;
  if (!to.mkdirs())   throw new IOException("Cannot create directory " + to);
  if (oldLV >= PRE_GENERATIONSTAMP_LAYOUT_VERSION) {
    String[] blockNames=from.list(new java.io.FilenameFilter(){
      public boolean accept(      File dir,      String name){
        return name.startsWith(BLOCK_SUBDIR_PREFIX) || name.startsWith(BLOCK_FILE_PREFIX) || name.startsWith(COPY_FILE_PREFIX);
      }
    }
);
    if (blockNames.length == 0) {
      hl.linkStats.countEmptyDirs++;
    }
 else     for (int i=0; i < blockNames.length; i++)     linkBlocks(new File(from,blockNames[i]),new File(to,blockNames[i]),oldLV,hl);
  }
 else {
    String[] blockNames=from.list(new java.io.FilenameFilter(){
      public boolean accept(      File dir,      String name){
        return name.startsWith(BLOCK_FILE_PREFIX);
      }
    }
);
    if (blockNames.length > 0) {
      HardLink.createHardLinkMult(from,blockNames,to);
      hl.linkStats.countMultLinks++;
      hl.linkStats.countFilesMultLinks+=blockNames.length;
    }
 else {
      hl.linkStats.countEmptyDirs++;
    }
    String[] otherNames=from.list(new java.io.FilenameFilter(){
      public boolean accept(      File dir,      String name){
        return name.startsWith(BLOCK_SUBDIR_PREFIX) || name.startsWith(COPY_FILE_PREFIX);
      }
    }
);
    for (int i=0; i < otherNames.length; i++)     linkBlocks(new File(from,otherNames[i]),new File(to,otherNames[i]),oldLV,hl);
  }
}
