{
  RMStateStore store=stateStoreHelper.getRMStateStore();
  TestDispatcher dispatcher=new TestDispatcher();
  store.setRMDispatcher(dispatcher);
  RMDelegationTokenIdentifier dtId1=new RMDelegationTokenIdentifier(new Text("owner1"),new Text("renewer1"),new Text("realuser1"));
  byte[] tokenBeforeStore=dtId1.getBytes();
  Long renewDate1=new Long(System.currentTimeMillis());
  int sequenceNumber=1111;
  store.storeRMDelegationTokenAndSequenceNumber(dtId1,renewDate1,sequenceNumber);
  modifyRMDelegationTokenState();
  Map<RMDelegationTokenIdentifier,Long> token1=new HashMap<RMDelegationTokenIdentifier,Long>();
  token1.put(dtId1,renewDate1);
  DelegationKey key=new DelegationKey(1234,4321,"keyBytes".getBytes());
  HashSet<DelegationKey> keySet=new HashSet<DelegationKey>();
  keySet.add(key);
  store.storeRMDTMasterKey(key);
  RMDTSecretManagerState secretManagerState=store.loadState().getRMDTSecretManagerState();
  Assert.assertEquals(token1,secretManagerState.getTokenState());
  Assert.assertEquals(keySet,secretManagerState.getMasterKeyState());
  Assert.assertEquals(sequenceNumber,secretManagerState.getDTSequenceNumber());
  RMDelegationTokenIdentifier tokenAfterStore=secretManagerState.getTokenState().keySet().iterator().next();
  Assert.assertTrue(Arrays.equals(tokenBeforeStore,tokenAfterStore.getBytes()));
  renewDate1=new Long(System.currentTimeMillis());
  ++sequenceNumber;
  store.updateRMDelegationTokenAndSequenceNumber(dtId1,renewDate1,sequenceNumber);
  token1.put(dtId1,renewDate1);
  RMDTSecretManagerState updateSecretManagerState=store.loadState().getRMDTSecretManagerState();
  Assert.assertEquals(token1,updateSecretManagerState.getTokenState());
  Assert.assertEquals(keySet,updateSecretManagerState.getMasterKeyState());
  Assert.assertEquals(sequenceNumber,updateSecretManagerState.getDTSequenceNumber());
  store.removeRMDTMasterKey(key);
  keySet.clear();
  RMDTSecretManagerState noKeySecretManagerState=store.loadState().getRMDTSecretManagerState();
  Assert.assertEquals(token1,noKeySecretManagerState.getTokenState());
  Assert.assertEquals(keySet,noKeySecretManagerState.getMasterKeyState());
  Assert.assertEquals(sequenceNumber,noKeySecretManagerState.getDTSequenceNumber());
  store.removeRMDelegationToken(dtId1,sequenceNumber);
  RMDTSecretManagerState noKeyAndTokenSecretManagerState=store.loadState().getRMDTSecretManagerState();
  token1.clear();
  Assert.assertEquals(token1,noKeyAndTokenSecretManagerState.getTokenState());
  Assert.assertEquals(keySet,noKeyAndTokenSecretManagerState.getMasterKeyState());
  Assert.assertEquals(sequenceNumber,noKeySecretManagerState.getDTSequenceNumber());
  store.close();
}
