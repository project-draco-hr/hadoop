{
  try {
    Configuration conf=new Configuration();
    InetSocketAddress mockRmAddress=new InetSocketAddress("localhost",4444);
    Text rmTokenSevice=SecurityUtil.buildTokenService(mockRmAddress);
    InetSocketAddress mockHsAddress=new InetSocketAddress("localhost",9200);
    Text hsTokenSevice=SecurityUtil.buildTokenService(mockHsAddress);
    RMDelegationTokenIdentifier tokenIdentifier=new RMDelegationTokenIdentifier(new Text("owner"),new Text("renewer"),new Text("real"));
    Token<RMDelegationTokenIdentifier> token=new Token<RMDelegationTokenIdentifier>(new byte[0],new byte[0],tokenIdentifier.getKind(),rmTokenSevice);
    token.setKind(RMDelegationTokenIdentifier.KIND_NAME);
    org.apache.hadoop.yarn.api.records.Token historyToken=BuilderUtils.newDelegationToken(new byte[0],MRDelegationTokenIdentifier.KIND_NAME.toString(),new byte[0],hsTokenSevice.toString());
    GetDelegationTokenResponse getDtResponse=Records.newRecord(GetDelegationTokenResponse.class);
    getDtResponse.setDelegationToken(historyToken);
    MRClientProtocol mockHsProxy=mock(MRClientProtocol.class);
    doReturn(mockHsAddress).when(mockHsProxy).getConnectAddress();
    doReturn(getDtResponse).when(mockHsProxy).getDelegationToken(any(GetDelegationTokenRequest.class));
    ResourceMgrDelegate rmDelegate=mock(ResourceMgrDelegate.class);
    doReturn(mockRmAddress).when(rmDelegate).getConnectAddress();
    ClientCache clientCache=mock(ClientCache.class);
    doReturn(mockHsProxy).when(clientCache).getInitializedHSProxy();
    Credentials creds=new Credentials();
    YARNRunner yarnRunner=new YARNRunner(conf,rmDelegate,clientCache);
    yarnRunner.addHistoyToken(creds);
    verify(mockHsProxy,times(0)).getDelegationToken(any(GetDelegationTokenRequest.class));
    creds.addToken(new Text("rmdt"),token);
    yarnRunner.addHistoyToken(creds);
    verify(mockHsProxy,times(0)).getDelegationToken(any(GetDelegationTokenRequest.class));
    conf.set(CommonConfigurationKeys.HADOOP_SECURITY_AUTHENTICATION,"kerberos");
    UserGroupInformation.setConfiguration(conf);
    creds=new Credentials();
    yarnRunner.addHistoyToken(creds);
    verify(mockHsProxy,times(0)).getDelegationToken(any(GetDelegationTokenRequest.class));
    creds.addToken(new Text("rmdt"),token);
    yarnRunner.addHistoyToken(creds);
    verify(mockHsProxy,times(1)).getDelegationToken(any(GetDelegationTokenRequest.class));
    yarnRunner.addHistoyToken(creds);
    verify(mockHsProxy,times(1)).getDelegationToken(any(GetDelegationTokenRequest.class));
  }
  finally {
    UserGroupInformation.setConfiguration(new Configuration());
  }
}
