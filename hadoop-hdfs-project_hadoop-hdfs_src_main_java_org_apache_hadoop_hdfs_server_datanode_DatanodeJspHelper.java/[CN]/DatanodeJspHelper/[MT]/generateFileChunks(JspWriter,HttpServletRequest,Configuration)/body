{
  long startOffset=0;
  int datanodePort=0;
  final String namenodeInfoPortStr=req.getParameter("namenodeInfoPort");
  final String nnAddr=req.getParameter(JspHelper.NAMENODE_ADDRESS);
  if (nnAddr == null) {
    out.print(JspHelper.NAMENODE_ADDRESS + " url param is null");
    return;
  }
  final String tokenString=req.getParameter(JspHelper.DELEGATION_PARAMETER_NAME);
  UserGroupInformation ugi=JspHelper.getUGI(req,conf);
  int namenodeInfoPort=-1;
  if (namenodeInfoPortStr != null)   namenodeInfoPort=Integer.parseInt(namenodeInfoPortStr);
  final String filename=JspHelper.validatePath(StringEscapeUtils.unescapeHtml(req.getParameter("filename")));
  if (filename == null) {
    out.print("Invalid input (filename absent)");
    return;
  }
  final Long blockId=JspHelper.validateLong(req.getParameter("blockId"));
  if (blockId == null) {
    out.print("Invalid input (blockId absent)");
    return;
  }
  final DFSClient dfs=getDFSClient(ugi,nnAddr,conf);
  String bpid=null;
  Token<BlockTokenIdentifier> blockToken=BlockTokenSecretManager.DUMMY_TOKEN;
  List<LocatedBlock> blks=dfs.getNamenode().getBlockLocations(filename,0,Long.MAX_VALUE).getLocatedBlocks();
  if (blks == null || blks.size() == 0) {
    out.print("Can't locate file blocks");
    dfs.close();
    return;
  }
  boolean needBlockToken=conf.getBoolean(DFSConfigKeys.DFS_BLOCK_ACCESS_TOKEN_ENABLE_KEY,DFSConfigKeys.DFS_BLOCK_ACCESS_TOKEN_ENABLE_DEFAULT);
  for (int i=0; i < blks.size(); i++) {
    if (blks.get(i).getBlock().getBlockId() == blockId) {
      bpid=blks.get(i).getBlock().getBlockPoolId();
      if (needBlockToken) {
        blockToken=blks.get(i).getBlockToken();
      }
      break;
    }
  }
  final Long genStamp=JspHelper.validateLong(req.getParameter("genstamp"));
  if (genStamp == null) {
    out.print("Invalid input (genstamp absent)");
    return;
  }
  long blockSize=0;
  final String blockSizeStr=req.getParameter("blockSize");
  if (blockSizeStr == null) {
    out.print("Invalid input (blockSize absent)");
    return;
  }
  blockSize=Long.parseLong(blockSizeStr);
  final int chunkSizeToView=JspHelper.string2ChunkSizeToView(req.getParameter("chunkSizeToView"),getDefaultChunkSize(conf));
  String startOffsetStr=req.getParameter("startOffset");
  if (startOffsetStr == null || Long.parseLong(startOffsetStr) < 0)   startOffset=0;
 else   startOffset=Long.parseLong(startOffsetStr);
  String datanodePortStr=req.getParameter("datanodePort");
  if (datanodePortStr == null) {
    out.print("Invalid input (datanodePort absent)");
    return;
  }
  datanodePort=Integer.parseInt(datanodePortStr);
  out.print("<h3>File: ");
  JspHelper.printPathWithLinks(filename,out,namenodeInfoPort,tokenString,nnAddr);
  out.print("</h3><hr>");
  String parent=new File(filename).getParent();
  JspHelper.printGotoForm(out,namenodeInfoPort,tokenString,parent,nnAddr);
  out.print("<hr>");
  out.print("<a href=\"/browseDirectory.jsp?dir=" + URLEncoder.encode(parent,"UTF-8") + "&namenodeInfoPort="+ namenodeInfoPort+ JspHelper.getDelegationTokenUrlParam(tokenString)+ JspHelper.getUrlParam(JspHelper.NAMENODE_ADDRESS,nnAddr)+ "\"><i>Go back to dir listing</i></a><br>");
  out.print("<a href=\"#viewOptions\">Advanced view/download options</a><br>");
  out.print("<hr>");
  String authority=req.getServerName() + ":" + req.getServerPort();
  String nextUrl=generateLinksForAdjacentBlock(NEXT_BLOCK,authority,datanodePort,startOffset,chunkSizeToView,blockSize,blockId,genStamp,dfs,filename,conf,req.getScheme(),tokenString,namenodeInfoPort,nnAddr);
  if (nextUrl != null) {
    out.print("<a href=\"" + nextUrl + "\">View Next chunk</a>&nbsp;&nbsp;");
  }
  String prevUrl=generateLinksForAdjacentBlock(PREV_BLOCK,authority,datanodePort,startOffset,chunkSizeToView,blockSize,blockId,genStamp,dfs,filename,conf,req.getScheme(),tokenString,namenodeInfoPort,nnAddr);
  if (prevUrl != null) {
    out.print("<a href=\"" + prevUrl + "\">View Prev chunk</a>&nbsp;&nbsp;");
  }
  out.print("<hr>");
  out.print("<textarea cols=\"100\" rows=\"25\" wrap=\"virtual\" style=\"width:100%\" READONLY>");
  try {
    JspHelper.streamBlockInAscii(new InetSocketAddress(req.getServerName(),datanodePort),bpid,blockId,blockToken,genStamp,blockSize,startOffset,chunkSizeToView,out,conf,dfs.getConf(),dfs.getDataEncryptionKey());
  }
 catch (  Exception e) {
    out.print(e);
  }
  out.print("</textarea>");
  dfs.close();
}
