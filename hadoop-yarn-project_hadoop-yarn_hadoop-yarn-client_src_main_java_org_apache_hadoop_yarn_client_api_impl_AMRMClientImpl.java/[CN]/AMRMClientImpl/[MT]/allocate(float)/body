{
  Preconditions.checkArgument(progressIndicator >= 0,"Progress indicator should not be negative");
  AllocateResponse allocateResponse=null;
  List<ResourceRequest> askList=null;
  List<ContainerId> releaseList=null;
  AllocateRequest allocateRequest=null;
  List<String> blacklistToAdd=new ArrayList<String>();
  List<String> blacklistToRemove=new ArrayList<String>();
  try {
synchronized (this) {
      askList=new ArrayList<ResourceRequest>(ask.size());
      for (      ResourceRequest r : ask) {
        askList.add(ResourceRequest.newInstance(r.getPriority(),r.getResourceName(),r.getCapability(),r.getNumContainers(),r.getRelaxLocality()));
      }
      releaseList=new ArrayList<ContainerId>(release);
      ask.clear();
      release.clear();
      blacklistToAdd.addAll(blacklistAdditions);
      blacklistToRemove.addAll(blacklistRemovals);
      ResourceBlacklistRequest blacklistRequest=(blacklistToAdd != null) || (blacklistToRemove != null) ? ResourceBlacklistRequest.newInstance(blacklistToAdd,blacklistToRemove) : null;
      allocateRequest=AllocateRequest.newInstance(lastResponseId,progressIndicator,askList,releaseList,blacklistRequest);
      blacklistAdditions.clear();
      blacklistRemovals.clear();
    }
    allocateResponse=rmClient.allocate(allocateRequest);
synchronized (this) {
      clusterNodeCount=allocateResponse.getNumClusterNodes();
      lastResponseId=allocateResponse.getResponseId();
      clusterAvailableResources=allocateResponse.getAvailableResources();
      if (!allocateResponse.getNMTokens().isEmpty()) {
        populateNMTokens(allocateResponse);
      }
    }
  }
  finally {
    if (allocateResponse == null) {
synchronized (this) {
        release.addAll(releaseList);
        for (        ResourceRequest oldAsk : askList) {
          if (!ask.contains(oldAsk)) {
            ask.add(oldAsk);
          }
        }
        blacklistAdditions.addAll(blacklistToAdd);
        blacklistRemovals.addAll(blacklistToRemove);
      }
    }
  }
  return allocateResponse;
}
