{
  if (setupHostsFile) {
    String hostsFile=conf.get(DFSConfigKeys.DFS_HOSTS,"").trim();
    if (hostsFile.length() == 0) {
      throw new IOException("Parameter dfs.hosts is not setup in conf");
    }
    String address="127.0.0.1:" + getFreeSocketPort();
    if (checkDataNodeAddrConfig) {
      conf.setIfUnset("dfs.datanode.address",address);
    }
 else {
      conf.set("dfs.datanode.address",address);
    }
    addToFile(hostsFile,address);
    LOG.info("Adding datanode " + address + " to hosts file "+ hostsFile);
  }
 else {
    if (checkDataNodeAddrConfig) {
      conf.setIfUnset("dfs.datanode.address","127.0.0.1:0");
      conf.setIfUnset("dfs.datanode.http.address","127.0.0.1:0");
      conf.setIfUnset("dfs.datanode.ipc.address","127.0.0.1:0");
    }
 else {
      conf.set("dfs.datanode.address","127.0.0.1:0");
      conf.set("dfs.datanode.http.address","127.0.0.1:0");
      conf.set("dfs.datanode.ipc.address","127.0.0.1:0");
    }
  }
}
