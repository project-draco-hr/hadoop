{
  if (LOG.isDebugEnabled()) {
    LOG.debug("Number of storages reported in heartbeat=" + reports.length + "; Number of storages in storageMap="+ storageMap.size());
  }
  HashMap<String,DatanodeStorageInfo> excessStorages;
synchronized (storageMap) {
    excessStorages=new HashMap<String,DatanodeStorageInfo>(storageMap);
    for (    final StorageReport report : reports) {
      excessStorages.remove(report.getStorage().getStorageID());
    }
    for (    final DatanodeStorageInfo storageInfo : excessStorages.values()) {
      if (storageInfo.numBlocks() == 0) {
        storageMap.remove(storageInfo.getStorageID());
        LOG.info("Removed storage " + storageInfo + " from DataNode"+ this);
      }
 else       if (LOG.isDebugEnabled()) {
        LOG.debug("Deferring removal of stale storage " + storageInfo + " with "+ storageInfo.numBlocks()+ " blocks");
      }
    }
  }
}
