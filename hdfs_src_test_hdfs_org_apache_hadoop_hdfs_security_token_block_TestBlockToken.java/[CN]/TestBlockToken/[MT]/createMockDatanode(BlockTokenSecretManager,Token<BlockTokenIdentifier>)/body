{
  ClientDatanodeProtocol mockDN=mock(ClientDatanodeProtocol.class);
  when(mockDN.getProtocolVersion(anyString(),anyLong())).thenReturn(ClientDatanodeProtocol.versionID);
  doReturn(ProtocolSignature.getProtocolSignature(mockDN,ClientDatanodeProtocol.class.getName(),ClientDatanodeProtocol.versionID,0)).when(mockDN).getProtocolSignature(anyString(),anyLong(),anyInt());
  BlockTokenIdentifier id=sm.createIdentifier();
  id.readFields(new DataInputStream(new ByteArrayInputStream(token.getIdentifier())));
  doAnswer(new getLengthAnswer(sm,id)).when(mockDN).getReplicaVisibleLength(any(ExtendedBlock.class));
  return RPC.getServer(ClientDatanodeProtocol.class,mockDN,ADDRESS,0,5,true,conf,sm);
}
