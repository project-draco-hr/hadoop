{
  final long blockId=b.getBlockId();
  final long expectedGs=b.getGenerationStamp();
  final long visible=b.getNumBytes();
  final long numBytes=temp.getNumBytes();
  BlockPoolSlice bpslice=getBlockPoolSlice(b.getBlockPoolId());
  final File dest=FsDatasetImpl.moveBlockFiles(b.getLocalBlock(),temp,bpslice.getRbwDir());
  final LocalReplicaInPipeline rbw=new ReplicaBuilder(ReplicaState.RBW).setBlockId(blockId).setLength(numBytes).setGenerationStamp(expectedGs).setFsVolume(this).setDirectoryToUse(dest.getParentFile()).setWriterThread(Thread.currentThread()).setBytesToReserve(0).buildLocalReplicaInPipeline();
  rbw.setBytesAcked(visible);
  return rbw;
}
