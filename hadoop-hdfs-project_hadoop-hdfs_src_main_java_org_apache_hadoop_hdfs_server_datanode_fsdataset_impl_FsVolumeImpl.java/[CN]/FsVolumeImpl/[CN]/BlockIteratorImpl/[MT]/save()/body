{
  state.lastSavedMs=Time.now();
  boolean success=false;
  ObjectMapper mapper=new ObjectMapper();
  try (BufferedWriter writer=new BufferedWriter(new OutputStreamWriter(new FileOutputStream(getTempSaveFile(),false),"UTF-8"))){
    mapper.writerWithDefaultPrettyPrinter().writeValue(writer,state);
    success=true;
  }
  finally {
    if (!success) {
      if (getTempSaveFile().delete()) {
        LOG.debug("save({}, {}): error deleting temporary file.",storageID,bpid);
      }
    }
  }
  Files.move(getTempSaveFile().toPath(),getSaveFile().toPath(),StandardCopyOption.ATOMIC_MOVE);
  if (LOG.isTraceEnabled()) {
    LOG.trace("save({}, {}): saved {}",storageID,bpid,mapper.writerWithDefaultPrettyPrinter().writeValueAsString(state));
  }
}
