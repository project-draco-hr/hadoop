{
  String user=System.getProperty("user.name");
  if (userNameKey != null)   user=conf.get(userNameKey,user);
  String keytabFile=null;
  if (keytabKey != null)   keytabFile=conf.get(keytabKey,keytabFile);
  MiniServer miniServer=null;
  UserGroupInformation.setConfiguration(conf);
  String shortUserName=UserGroupInformation.createRemoteUser(user).getShortUserName();
  try {
    conf.setStrings(DefaultImpersonationProvider.getProxySuperuserGroupConfKey(shortUserName),GROUP_NAME_1);
    configureSuperUserIPAddresses(conf,shortUserName);
    miniServer=new MiniServer(conf,user,keytabFile);
    InetSocketAddress addr=miniServer.getAddress();
    connectToServerAndGetDelegationToken(conf,addr);
    setLoggingLevel(logLevel);
    long elapsed=0L;
    for (int idx=0; idx < count; idx++) {
      elapsed+=connectToServerUsingDelegationToken(conf,addr);
    }
    return elapsed;
  }
  finally {
    if (miniServer != null)     miniServer.stop();
  }
}
