{
  if (!(oldReplicaInfo instanceof LocalReplica)) {
    throw new IOException("The source replica with blk id " + oldReplicaInfo.getBlockId() + " should be derived from LocalReplica");
  }
  LocalReplica localReplica=(LocalReplica)oldReplicaInfo;
  File oldmeta=localReplica.getMetaFile();
  File newmeta=getMetaFile();
  if (LOG.isDebugEnabled()) {
    LOG.debug("Renaming " + oldmeta + " to "+ newmeta);
  }
  try {
    NativeIO.renameTo(oldmeta,newmeta);
  }
 catch (  IOException e) {
    throw new IOException("Block " + oldReplicaInfo + " reopen failed. "+ " Unable to move meta file  "+ oldmeta+ " to rbw dir "+ newmeta,e);
  }
  File blkfile=localReplica.getBlockFile();
  if (LOG.isDebugEnabled()) {
    LOG.debug("Renaming " + blkfile + " to "+ newBlkFile+ ", file length="+ blkfile.length());
  }
  try {
    NativeIO.renameTo(blkfile,newBlkFile);
  }
 catch (  IOException e) {
    try {
      NativeIO.renameTo(newmeta,oldmeta);
    }
 catch (    IOException ex) {
      LOG.warn("Cannot move meta file " + newmeta + "back to the finalized directory "+ oldmeta,ex);
    }
    throw new IOException("Block " + oldReplicaInfo + " reopen failed. "+ " Unable to move block file "+ blkfile+ " to rbw dir "+ newBlkFile,e);
  }
}
