{
  final BlockInfo[] oldBlocks=getBlocks();
  if (oldBlocks != null) {
    int n=0;
    for (long size=0; n < oldBlocks.length && max > size; n++) {
      size+=oldBlocks[n].getNumBytes();
    }
    if (n < oldBlocks.length) {
      final BlockInfo[] newBlocks;
      if (n == 0) {
        newBlocks=null;
      }
 else {
        newBlocks=new BlockInfo[n];
        System.arraycopy(oldBlocks,0,newBlocks,0,n);
      }
      setBlocks(newBlocks);
      if (collectedBlocks != null) {
        for (; n < oldBlocks.length; n++) {
          collectedBlocks.addDeleteBlock(oldBlocks[n]);
        }
      }
    }
  }
}
