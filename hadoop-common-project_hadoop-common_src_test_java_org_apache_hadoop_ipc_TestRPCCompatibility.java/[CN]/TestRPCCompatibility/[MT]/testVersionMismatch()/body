{
  server=new RPC.Builder(conf).setProtocol(TestProtocol2.class).setInstance(new TestImpl2()).setBindAddress(ADDRESS).setPort(0).setNumHandlers(2).setVerbose(false).build();
  server.start();
  addr=NetUtils.getConnectAddress(server);
  TestProtocol4 proxy=RPC.getProxy(TestProtocol4.class,TestProtocol4.versionID,addr,conf);
  try {
    proxy.echo(21);
    fail("The call must throw VersionMismatch exception");
  }
 catch (  RemoteException ex) {
    Assert.assertEquals(RPC.VersionMismatch.class.getName(),ex.getClassName());
    Assert.assertTrue(ex.getErrorCode().equals(RpcErrorCodeProto.ERROR_RPC_VERSION_MISMATCH));
  }
catch (  IOException ex) {
    fail("Expected version mismatch but got " + ex);
  }
}
