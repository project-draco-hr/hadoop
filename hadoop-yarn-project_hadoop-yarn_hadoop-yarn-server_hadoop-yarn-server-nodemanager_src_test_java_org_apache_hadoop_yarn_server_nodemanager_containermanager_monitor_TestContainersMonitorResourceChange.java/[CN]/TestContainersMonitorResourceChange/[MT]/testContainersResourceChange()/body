{
  conf.setLong(YarnConfiguration.NM_CONTAINER_MON_INTERVAL_MS,20L);
  containersMonitor=createContainersMonitor(executor,dispatcher,context);
  containersMonitor.init(conf);
  containersMonitor.start();
  containersMonitor.handle(new ContainerStartMonitoringEvent(getContainerId(1),2100L,1000L,1,0,0));
  assertNotNull(getProcessTreeInfo(getContainerId(1)));
  assertEquals(1000L,getProcessTreeInfo(getContainerId(1)).getPmemLimit());
  assertEquals(2100L,getProcessTreeInfo(getContainerId(1)).getVmemLimit());
  Thread.sleep(200);
  MockResourceCalculatorProcessTree mockTree=(MockResourceCalculatorProcessTree)getProcessTreeInfo(getContainerId(1)).getProcessTree();
  mockTree.setRssMemorySize(2500L);
  Thread.sleep(200);
  assertTrue(containerEventHandler.isContainerKilled(getContainerId(1)));
  containersMonitor.handle(new ContainerStartMonitoringEvent(getContainerId(2),2202009L,1048576L,1,0,0));
  assertNotNull(getProcessTreeInfo(getContainerId(2)));
  assertEquals(1048576L,getProcessTreeInfo(getContainerId(2)).getPmemLimit());
  assertEquals(2202009L,getProcessTreeInfo(getContainerId(2)).getVmemLimit());
  containersMonitor.handle(new ChangeMonitoringContainerResourceEvent(getContainerId(2),Resource.newInstance(2,1)));
  assertEquals(2097152L,getProcessTreeInfo(getContainerId(2)).getPmemLimit());
  assertEquals(4404019L,getProcessTreeInfo(getContainerId(2)).getVmemLimit());
  Thread.sleep(200);
  mockTree=(MockResourceCalculatorProcessTree)getProcessTreeInfo(getContainerId(2)).getProcessTree();
  mockTree.setRssMemorySize(2000000L);
  Thread.sleep(200);
  assertFalse(containerEventHandler.isContainerKilled(getContainerId(2)));
  containersMonitor.stop();
}
