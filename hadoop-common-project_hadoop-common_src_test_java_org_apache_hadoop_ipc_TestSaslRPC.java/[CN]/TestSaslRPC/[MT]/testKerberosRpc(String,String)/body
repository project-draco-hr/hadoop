{
  final Configuration newConf=new Configuration(conf);
  newConf.set(SERVER_PRINCIPAL_KEY,principal);
  newConf.set(SERVER_KEYTAB_KEY,keytab);
  SecurityUtil.login(newConf,SERVER_KEYTAB_KEY,SERVER_PRINCIPAL_KEY);
  TestUserGroupInformation.verifyLoginMetrics(1,0);
  UserGroupInformation current=UserGroupInformation.getCurrentUser();
  System.out.println("UGI: " + current);
  Server server=new RPC.Builder(newConf).setProtocol(TestSaslProtocol.class).setInstance(new TestSaslImpl()).setBindAddress(ADDRESS).setPort(0).setNumHandlers(5).setVerbose(true).build();
  TestSaslProtocol proxy=null;
  server.start();
  InetSocketAddress addr=NetUtils.getConnectAddress(server);
  try {
    proxy=RPC.getProxy(TestSaslProtocol.class,TestSaslProtocol.versionID,addr,newConf);
    proxy.ping();
  }
  finally {
    server.stop();
    if (proxy != null) {
      RPC.stopProxy(proxy);
    }
  }
  System.out.println("Test is successful.");
}
