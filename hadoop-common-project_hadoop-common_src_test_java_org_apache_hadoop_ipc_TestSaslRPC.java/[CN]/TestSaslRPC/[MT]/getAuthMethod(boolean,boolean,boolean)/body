{
  Configuration serverConf=new Configuration(conf);
  SecurityUtil.setAuthenticationMethod(isSecureServer ? KERBEROS : SIMPLE,serverConf);
  UserGroupInformation.setConfiguration(serverConf);
  TestTokenSecretManager sm=new TestTokenSecretManager();
  Server server=new RPC.Builder(serverConf).setProtocol(TestSaslProtocol.class).setInstance(new TestSaslImpl()).setBindAddress(ADDRESS).setPort(0).setNumHandlers(5).setVerbose(true).setSecretManager(sm).build();
  server.start();
  final UserGroupInformation current=UserGroupInformation.getCurrentUser();
  final InetSocketAddress addr=NetUtils.getConnectAddress(server);
  if (useToken) {
    TestTokenIdentifier tokenId=new TestTokenIdentifier(new Text(current.getUserName()));
    Token<TestTokenIdentifier> token=new Token<TestTokenIdentifier>(tokenId,sm);
    SecurityUtil.setTokenService(token,addr);
    current.addToken(token);
  }
  final Configuration clientConf=new Configuration(conf);
  SecurityUtil.setAuthenticationMethod(isSecureClient ? KERBEROS : SIMPLE,clientConf);
  UserGroupInformation.setConfiguration(clientConf);
  try {
    return current.doAs(new PrivilegedExceptionAction<AuthenticationMethod>(){
      @Override public AuthenticationMethod run() throws IOException {
        TestSaslProtocol proxy=null;
        try {
          proxy=(TestSaslProtocol)RPC.getProxy(TestSaslProtocol.class,TestSaslProtocol.versionID,addr,clientConf);
          return proxy.getAuthMethod();
        }
  finally {
          if (proxy != null) {
            RPC.stopProxy(proxy);
          }
        }
      }
    }
);
  }
  finally {
    server.stop();
  }
}
