{
  TestTokenSecretManager sm=new TestTokenSecretManager();
  final Server server=setupTestServer(conf,5,sm);
  final UserGroupInformation current=UserGroupInformation.getCurrentUser();
  final InetSocketAddress addr=NetUtils.getConnectAddress(server);
  TestTokenIdentifier tokenId=new TestTokenIdentifier(new Text(current.getUserName()));
  Token<TestTokenIdentifier> token=new Token<>(tokenId,sm);
  SecurityUtil.setTokenService(token,addr);
  current.addToken(token);
  Configuration newConf=new Configuration(conf);
  newConf.set(CommonConfigurationKeysPublic.HADOOP_RPC_SOCKET_FACTORY_CLASS_DEFAULT_KEY,"");
  Client client=null;
  TestRpcService proxy1=null;
  TestRpcService proxy2=null;
  TestRpcService proxy3=null;
  int timeouts[]={111222,3333333};
  try {
    newConf.setInt(CommonConfigurationKeysPublic.IPC_CLIENT_CONNECTION_MAXIDLETIME_KEY,timeouts[0]);
    proxy1=getClient(addr,newConf);
    proxy1.getAuthMethod(null,newEmptyRequest());
    client=ProtobufRpcEngine.getClient(newConf);
    Set<ConnectionId> conns=client.getConnectionIds();
    assertEquals("number of connections in cache is wrong",1,conns.size());
    proxy2=getClient(addr,newConf);
    proxy2.getAuthMethod(null,newEmptyRequest());
    assertEquals("number of connections in cache is wrong",1,conns.size());
    newConf.setInt(CommonConfigurationKeysPublic.IPC_CLIENT_CONNECTION_MAXIDLETIME_KEY,timeouts[1]);
    proxy3=getClient(addr,newConf);
    proxy3.getAuthMethod(null,newEmptyRequest());
    assertEquals("number of connections in cache is wrong",2,conns.size());
    ConnectionId[] connsArray={RPC.getConnectionIdForProxy(proxy1),RPC.getConnectionIdForProxy(proxy2),RPC.getConnectionIdForProxy(proxy3)};
    assertEquals(connsArray[0],connsArray[1]);
    assertEquals(connsArray[0].getMaxIdleTime(),timeouts[0]);
    assertFalse(connsArray[0].equals(connsArray[2]));
    assertNotSame(connsArray[2].getMaxIdleTime(),timeouts[1]);
  }
  finally {
    server.stop();
    if (client != null) {
      client.getConnectionIds().clear();
    }
    if (proxy1 != null)     RPC.stopProxy(proxy1);
    if (proxy2 != null)     RPC.stopProxy(proxy2);
    if (proxy3 != null)     RPC.stopProxy(proxy3);
  }
}
