{
  final UserGroupInformation current=UserGroupInformation.getCurrentUser();
  addr=NetUtils.getConnectAddress(server);
  TestTokenIdentifier tokenId=new TestTokenIdentifier(new Text(current.getUserName()));
  Token<TestTokenIdentifier> token=new Token<TestTokenIdentifier>(tokenId,sm);
  SecurityUtil.setTokenService(token,addr);
  current.addToken(token);
  TestRpcService proxy=null;
  try {
    proxy=getClient(addr,conf);
    AuthMethod authMethod=convert(proxy.getAuthMethod(null,newEmptyRequest()));
    assertEquals(TOKEN,authMethod);
    assertEquals(expectedQop.saslQop,RPC.getConnectionIdForProxy(proxy).getSaslQop());
    int n=0;
    for (    Connection connection : server.getConnections()) {
      boolean hasServer=(connection.saslServer != null);
      assertTrue("qop:" + expectedQop + " hasServer:"+ hasServer,(expectedQop == QualityOfProtection.AUTHENTICATION) ^ hasServer);
      n++;
    }
    assertTrue(n > 0);
    proxy.ping(null,newEmptyRequest());
  }
  finally {
    stop(server,proxy);
  }
}
