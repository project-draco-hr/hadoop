{
  TestTokenSecretManager sm=new TestTokenSecretManager();
  Server server=new RPC.Builder(conf).setProtocol(TestSaslProtocol.class).setInstance(new TestSaslImpl()).setBindAddress(ADDRESS).setPort(0).setNumHandlers(5).setVerbose(true).setSecretManager(sm).build();
  if (secureServer) {
    server.enableSecurity();
  }
 else {
    server.disableSecurity();
  }
  server.start();
  final UserGroupInformation current=UserGroupInformation.getCurrentUser();
  final InetSocketAddress addr=NetUtils.getConnectAddress(server);
  TestTokenIdentifier tokenId=new TestTokenIdentifier(new Text(current.getUserName()));
  Token<TestTokenIdentifier> token=new Token<TestTokenIdentifier>(tokenId,sm);
  SecurityUtil.setTokenService(token,addr);
  current.addToken(token);
  current.doAs(new PrivilegedExceptionAction<Object>(){
    @Override public Object run() throws IOException {
      TestSaslProtocol proxy=null;
      try {
        proxy=(TestSaslProtocol)RPC.getProxy(TestSaslProtocol.class,TestSaslProtocol.versionID,addr,conf);
        Assert.assertEquals(AuthenticationMethod.TOKEN,proxy.getAuthMethod());
      }
  finally {
        if (proxy != null) {
          RPC.stopProxy(proxy);
        }
      }
      return null;
    }
  }
);
  server.stop();
}
