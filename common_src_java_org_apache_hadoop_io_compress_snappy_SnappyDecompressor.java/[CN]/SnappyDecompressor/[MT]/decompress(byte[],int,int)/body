{
  if (b == null) {
    throw new NullPointerException();
  }
  if (off < 0 || len < 0 || off > b.length - len) {
    throw new ArrayIndexOutOfBoundsException();
  }
  if ((outBuf.position() == 0 && uncompressedBuf.position() == 0) || finished) {
    reset();
    finished=true;
    return 0;
  }
  if (uncompressedBuf.position() == 0) {
    try {
      outBuf.limit(outBuf.position());
      outBuf.rewind();
      int neededLen=Snappy.uncompressedLength(outBuf);
      outBuf.rewind();
      if (neededLen > uncompressedBuf.capacity())       uncompressedBuf=ByteBuffer.allocateDirect(neededLen);
      int lim=Snappy.uncompress(outBuf,uncompressedBuf);
      uncompressedBuf.limit(lim);
      uncompressedBuf.rewind();
    }
 catch (    SnappyException e) {
      throw new IOException(e);
    }
  }
  int n=(uncompressedBuf.limit() - uncompressedBuf.position()) > len ? len : (uncompressedBuf.limit() - uncompressedBuf.position());
  if (n == 0) {
    reset();
    finished=true;
    return 0;
  }
  uncompressedBuf.get(b,off,n);
  bytesWritten+=n;
  if (uncompressedBuf.position() == uncompressedBuf.limit()) {
    reset();
    finished=true;
  }
  return n;
}
