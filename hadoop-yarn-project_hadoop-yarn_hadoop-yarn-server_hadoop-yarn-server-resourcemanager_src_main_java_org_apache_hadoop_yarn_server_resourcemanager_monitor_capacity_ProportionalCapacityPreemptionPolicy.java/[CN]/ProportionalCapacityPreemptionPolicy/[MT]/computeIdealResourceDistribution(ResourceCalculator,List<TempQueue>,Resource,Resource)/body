{
  List<TempQueue> qAlloc=new ArrayList<TempQueue>(queues);
  Resource unassigned=Resources.clone(tot_guarant);
  Set<TempQueue> nonZeroGuarQueues=new HashSet<TempQueue>();
  Set<TempQueue> zeroGuarQueues=new HashSet<TempQueue>();
  for (  TempQueue q : qAlloc) {
    if (Resources.greaterThan(rc,tot_guarant,q.guaranteed,Resources.none())) {
      nonZeroGuarQueues.add(q);
    }
 else {
      zeroGuarQueues.add(q);
    }
  }
  computeFixpointAllocation(rc,tot_guarant,nonZeroGuarQueues,unassigned,false);
  if (!zeroGuarQueues.isEmpty() && Resources.greaterThan(rc,tot_guarant,unassigned,Resources.none())) {
    computeFixpointAllocation(rc,tot_guarant,zeroGuarQueues,unassigned,true);
  }
  Resource totPreemptionNeeded=Resource.newInstance(0,0);
  for (  TempQueue t : queues) {
    if (Resources.greaterThan(rc,tot_guarant,t.current,t.idealAssigned)) {
      Resources.addTo(totPreemptionNeeded,Resources.subtract(t.current,t.idealAssigned));
    }
  }
  float scalingFactor=1.0F;
  if (Resources.greaterThan(rc,tot_guarant,totPreemptionNeeded,totalPreemptionAllowed)) {
    scalingFactor=Resources.divide(rc,tot_guarant,totalPreemptionAllowed,totPreemptionNeeded);
  }
  for (  TempQueue t : queues) {
    t.assignPreemption(scalingFactor,rc,tot_guarant);
  }
  if (LOG.isDebugEnabled()) {
    long time=clock.getTime();
    for (    TempQueue t : queues) {
      LOG.debug(time + ": " + t);
    }
  }
}
