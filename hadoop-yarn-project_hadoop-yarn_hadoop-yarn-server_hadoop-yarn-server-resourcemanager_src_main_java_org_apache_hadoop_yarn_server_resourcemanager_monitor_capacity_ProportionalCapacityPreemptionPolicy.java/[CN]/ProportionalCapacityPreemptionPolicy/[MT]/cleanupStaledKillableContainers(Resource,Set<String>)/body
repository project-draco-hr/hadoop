{
  for (  String q : leafQueueNames) {
    for (    TempQueuePerPartition tq : getQueuePartitions(q)) {
      if (Resources.lessThanOrEqual(rc,cluster,Resources.subtract(tq.current,tq.killable),tq.idealAssigned) && Resources.greaterThan(rc,cluster,tq.killable,Resources.none())) {
        Resource toBeRevertedFromKillable=Resources.subtract(tq.killable,Resources.subtract(tq.current,tq.idealAssigned));
        Resource alreadyReverted=Resources.createResource(0);
        for (        RMContainer c : preemptableEntities.get(q).getKillableContainers(tq.partition).values()) {
          if (Resources.greaterThanOrEqual(rc,cluster,alreadyReverted,toBeRevertedFromKillable)) {
            break;
          }
          if (Resources.greaterThan(rc,cluster,Resources.add(alreadyReverted,c.getAllocatedResource()),toBeRevertedFromKillable)) {
            continue;
          }
 else {
            Resources.addTo(alreadyReverted,c.getAllocatedResource());
            rmContext.getDispatcher().getEventHandler().handle(new ContainerPreemptEvent(c.getApplicationAttemptId(),c,SchedulerEventType.MARK_CONTAINER_FOR_NONKILLABLE));
          }
        }
      }
    }
  }
}
