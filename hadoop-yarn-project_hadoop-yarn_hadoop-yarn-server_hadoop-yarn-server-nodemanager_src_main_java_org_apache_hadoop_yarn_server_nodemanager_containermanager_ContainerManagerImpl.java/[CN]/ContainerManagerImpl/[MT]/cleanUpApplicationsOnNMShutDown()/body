{
  Map<ApplicationId,Application> applications=this.context.getApplications();
  if (applications.isEmpty()) {
    return;
  }
  LOG.info("Applications still running : " + applications.keySet());
  if (this.context.getNMStateStore().canRecover() && !this.context.getDecommissioned()) {
    return;
  }
  List<ApplicationId> appIds=new ArrayList<ApplicationId>(applications.keySet());
  this.handle(new CMgrCompletedAppsEvent(appIds,CMgrCompletedAppsEvent.Reason.ON_SHUTDOWN));
  LOG.info("Waiting for Applications to be Finished");
  long waitStartTime=System.currentTimeMillis();
  while (!applications.isEmpty() && System.currentTimeMillis() - waitStartTime < waitForContainersOnShutdownMillis) {
    try {
      Thread.sleep(1000);
    }
 catch (    InterruptedException ex) {
      LOG.warn("Interrupted while sleeping on applications finish on shutdown",ex);
    }
  }
  if (applications.isEmpty()) {
    LOG.info("All applications in FINISHED state");
  }
 else {
    LOG.info("Done waiting for Applications to be Finished. Still alive: " + applications.keySet());
  }
}
