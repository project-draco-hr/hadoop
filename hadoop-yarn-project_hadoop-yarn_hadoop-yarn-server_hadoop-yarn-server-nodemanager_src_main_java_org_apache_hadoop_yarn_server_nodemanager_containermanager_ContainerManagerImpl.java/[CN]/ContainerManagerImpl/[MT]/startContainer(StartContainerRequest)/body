{
  if (blockNewContainerRequests.get()) {
    throw RPCUtil.getRemoteException(new NMNotYetReadyException("Rejecting new containers as NodeManager has not" + " yet connected with ResourceManager"));
  }
  ContainerLaunchContext launchContext=request.getContainerLaunchContext();
  ContainerToken token=request.getContainerToken();
  ContainerTokenIdentifier tokenIdentifier=null;
  try {
    tokenIdentifier=BuilderUtils.newContainerTokenIdentifier(token);
  }
 catch (  IOException e) {
    throw RPCUtil.getRemoteException(e);
  }
  UserGroupInformation remoteUgi=getRemoteUgi();
  ContainerTokenIdentifier tokenId=getContainerTokenIdentifier(remoteUgi,tokenIdentifier);
  ContainerId containerID=tokenId.getContainerID();
  String containerIDStr=containerID.toString();
  authorizeRequest(containerIDStr,launchContext,remoteUgi,tokenId);
  if (tokenId.getRMIdentifer() != nodeStatusUpdater.getRMIdentifier()) {
    String msg="\nContainer " + containerIDStr + " rejected as it is allocated by a previous RM";
    LOG.error(msg);
    throw RPCUtil.getRemoteException(new InvalidContainerException(msg));
  }
  LOG.info("Start request for " + containerIDStr + " by user "+ tokenId.getApplicationSubmitter());
  ByteBuffer tokens=launchContext.getTokens();
  Credentials credentials=new Credentials();
  if (tokens != null) {
    DataInputByteBuffer buf=new DataInputByteBuffer();
    tokens.rewind();
    buf.reset(tokens);
    try {
      credentials.readTokenStorageStream(buf);
      if (LOG.isDebugEnabled()) {
        for (        Token<? extends TokenIdentifier> tk : credentials.getAllTokens()) {
          LOG.debug(tk.getService() + " = " + tk.toString());
        }
      }
    }
 catch (    IOException e) {
      throw RPCUtil.getRemoteException(e);
    }
  }
  String user=tokenId.getApplicationSubmitter();
  Container container=new ContainerImpl(getConfig(),this.dispatcher,launchContext,credentials,metrics,tokenId);
  ApplicationId applicationID=containerID.getApplicationAttemptId().getApplicationId();
  if (context.getContainers().putIfAbsent(containerID,container) != null) {
    NMAuditLogger.logFailure(user,AuditConstants.START_CONTAINER,"ContainerManagerImpl","Container already running on this node!",applicationID,containerID);
    throw RPCUtil.getRemoteException("Container " + containerIDStr + " already is running on this node!!");
  }
  Application application=new ApplicationImpl(dispatcher,this.aclsManager,user,applicationID,credentials,context);
  if (null == context.getApplications().putIfAbsent(applicationID,application)) {
    LOG.info("Creating a new application reference for app " + applicationID);
    dispatcher.getEventHandler().handle(new ApplicationInitEvent(applicationID,container.getLaunchContext().getApplicationACLs()));
  }
  dispatcher.getEventHandler().handle(new ApplicationContainerInitEvent(container));
  this.context.getContainerTokenSecretManager().startContainerSuccessful(tokenId);
  NMAuditLogger.logSuccess(user,AuditConstants.START_CONTAINER,"ContainerManageImpl",applicationID,containerID);
  StartContainerResponse response=recordFactory.newRecordInstance(StartContainerResponse.class);
  response.setAllServiceResponse(auxiliaryServices.getMeta());
  metrics.launchedContainer();
  metrics.allocateContainer(tokenId.getResource());
  return response;
}
