{
  Configuration conf=getConfig();
  final InetSocketAddress initialAddress=conf.getSocketAddr(YarnConfiguration.NM_BIND_HOST,YarnConfiguration.NM_ADDRESS,YarnConfiguration.DEFAULT_NM_ADDRESS,YarnConfiguration.DEFAULT_NM_PORT);
  boolean usingEphemeralPort=(initialAddress.getPort() == 0);
  if (context.getNMStateStore().canRecover() && usingEphemeralPort) {
    throw new IllegalArgumentException("Cannot support recovery with an " + "ephemeral server port. Check the setting of " + YarnConfiguration.NM_ADDRESS);
  }
  final boolean delayedRpcServerStart=context.getNMStateStore().canRecover();
  Configuration serverConf=new Configuration(conf);
  serverConf.set(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHENTICATION,SaslRpcServer.AuthMethod.TOKEN.toString());
  YarnRPC rpc=YarnRPC.create(conf);
  server=rpc.getServer(ContainerManagementProtocol.class,this,initialAddress,serverConf,this.context.getNMTokenSecretManager(),conf.getInt(YarnConfiguration.NM_CONTAINER_MGR_THREAD_COUNT,YarnConfiguration.DEFAULT_NM_CONTAINER_MGR_THREAD_COUNT));
  if (conf.getBoolean(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHORIZATION,false)) {
    refreshServiceAcls(conf,new NMPolicyProvider());
  }
  LOG.info("Blocking new container-requests as container manager rpc" + " server is still starting.");
  this.setBlockNewContainerRequests(true);
  String bindHost=conf.get(YarnConfiguration.NM_BIND_HOST);
  String nmAddress=conf.getTrimmed(YarnConfiguration.NM_ADDRESS);
  String hostOverride=null;
  if (bindHost != null && !bindHost.isEmpty() && nmAddress != null && !nmAddress.isEmpty()) {
    hostOverride=nmAddress.split(":")[0];
  }
  InetSocketAddress connectAddress;
  if (delayedRpcServerStart) {
    connectAddress=NetUtils.getConnectAddress(initialAddress);
  }
 else {
    server.start();
    connectAddress=NetUtils.getConnectAddress(server);
  }
  NodeId nodeId=buildNodeId(connectAddress,hostOverride);
  ((NodeManager.NMContext)context).setNodeId(nodeId);
  this.context.getNMTokenSecretManager().setNodeId(nodeId);
  this.context.getContainerTokenSecretManager().setNodeId(nodeId);
  super.serviceStart();
  if (delayedRpcServerStart) {
    waitForRecoveredContainers();
    server.start();
    connectAddress=NetUtils.getConnectAddress(server);
    NodeId serverNode=buildNodeId(connectAddress,hostOverride);
    if (!serverNode.equals(nodeId)) {
      throw new IOException("Node mismatch after server started, expected '" + nodeId + "' but found '"+ serverNode+ "'");
    }
  }
  LOG.info("ContainerManager started at " + connectAddress);
  LOG.info("ContainerManager bound to " + initialAddress);
}
