{
  authorizeStartRequest(nmTokenIdentifier,containerTokenIdentifier);
  if (containerTokenIdentifier.getRMIdentifer() != nodeStatusUpdater.getRMIdentifier()) {
    StringBuilder sb=new StringBuilder("\nContainer ");
    sb.append(containerTokenIdentifier.getContainerID().toString()).append(" rejected as it is allocated by a previous RM");
    throw new InvalidContainerException(sb.toString());
  }
  updateNMTokenIdentifier(nmTokenIdentifier);
  ContainerId containerId=containerTokenIdentifier.getContainerID();
  String containerIdStr=containerId.toString();
  String user=containerTokenIdentifier.getApplicationSubmitter();
  LOG.info("Start request for " + containerIdStr + " by user "+ user);
  ContainerLaunchContext launchContext=request.getContainerLaunchContext();
  Map<String,ByteBuffer> serviceData=getAuxServiceMetaData();
  if (launchContext.getServiceData() != null && !launchContext.getServiceData().isEmpty()) {
    for (    Map.Entry<String,ByteBuffer> meta : launchContext.getServiceData().entrySet()) {
      if (null == serviceData.get(meta.getKey())) {
        throw new InvalidAuxServiceException("The auxService:" + meta.getKey() + " does not exist");
      }
    }
  }
  Credentials credentials=parseCredentials(launchContext);
  Container container=new ContainerImpl(getConfig(),this.dispatcher,context.getNMStateStore(),launchContext,credentials,metrics,containerTokenIdentifier);
  ApplicationId applicationID=containerId.getApplicationAttemptId().getApplicationId();
  if (context.getContainers().putIfAbsent(containerId,container) != null) {
    NMAuditLogger.logFailure(user,AuditConstants.START_CONTAINER,"ContainerManagerImpl","Container already running on this node!",applicationID,containerId);
    throw RPCUtil.getRemoteException("Container " + containerIdStr + " already is running on this node!!");
  }
  this.readLock.lock();
  try {
    if (!serviceStopped) {
      Application application=new ApplicationImpl(dispatcher,user,applicationID,credentials,context);
      if (null == context.getApplications().putIfAbsent(applicationID,application)) {
        LOG.info("Creating a new application reference for app " + applicationID);
        LogAggregationContext logAggregationContext=containerTokenIdentifier.getLogAggregationContext();
        Map<ApplicationAccessType,String> appAcls=container.getLaunchContext().getApplicationACLs();
        context.getNMStateStore().storeApplication(applicationID,buildAppProto(applicationID,user,credentials,appAcls,logAggregationContext));
        dispatcher.getEventHandler().handle(new ApplicationInitEvent(applicationID,appAcls,logAggregationContext));
      }
      this.context.getNMStateStore().storeContainer(containerId,request);
      dispatcher.getEventHandler().handle(new ApplicationContainerInitEvent(container));
      this.context.getContainerTokenSecretManager().startContainerSuccessful(containerTokenIdentifier);
      NMAuditLogger.logSuccess(user,AuditConstants.START_CONTAINER,"ContainerManageImpl",applicationID,containerId);
      metrics.launchedContainer();
      metrics.allocateContainer(containerTokenIdentifier.getResource());
    }
 else {
      throw new YarnException("Container start failed as the NodeManager is " + "in the process of shutting down");
    }
  }
  finally {
    this.readLock.unlock();
  }
}
