{
  if (buffer != null) {
    return buffer;
  }
  int dataLen=dataPos - dataStart;
  int checksumLen=checksumPos - checksumStart;
  if (checksumPos != dataStart) {
    System.arraycopy(buf,checksumStart,buf,dataStart - checksumLen,checksumLen);
  }
  int pktLen=HdfsConstants.BYTES_IN_INTEGER + dataLen + checksumLen;
  buffer=ByteBuffer.wrap(buf,dataStart - checksumPos,PacketHeader.PKT_HEADER_LEN + pktLen - HdfsConstants.BYTES_IN_INTEGER);
  buf=null;
  buffer.mark();
  PacketHeader header=new PacketHeader(pktLen,offsetInBlock,seqno,lastPacketInBlock,dataLen);
  header.putInBuffer(buffer);
  buffer.reset();
  return buffer;
}
