{
  if (DataTransferProtocol.LOG.isDebugEnabled()) {
    DataTransferProtocol.LOG.debug("lastAckedSeqno = " + lastAckedSeqno);
  }
  if (!isAppend && lastAckedSeqno < 0 && stage == BlockConstructionStage.PIPELINE_SETUP_CREATE) {
    return;
  }
 else   if (stage == BlockConstructionStage.PIPELINE_CLOSE || stage == BlockConstructionStage.PIPELINE_CLOSE_RECOVERY) {
    return;
  }
  final DatanodeInfo[] original=nodes;
  final LocatedBlock lb=dfsClient.namenode.getAdditionalDatanode(src,fileId,block,nodes,storageIDs,failed.toArray(new DatanodeInfo[failed.size()]),1,dfsClient.clientName);
  setPipeline(lb);
  final int d=findNewDatanode(original);
  final DatanodeInfo src=d == 0 ? nodes[1] : nodes[d - 1];
  final DatanodeInfo[] targets={nodes[d]};
  final StorageType[] targetStorageTypes={storageTypes[d]};
  transfer(src,targets,targetStorageTypes,lb.getBlockToken());
}
