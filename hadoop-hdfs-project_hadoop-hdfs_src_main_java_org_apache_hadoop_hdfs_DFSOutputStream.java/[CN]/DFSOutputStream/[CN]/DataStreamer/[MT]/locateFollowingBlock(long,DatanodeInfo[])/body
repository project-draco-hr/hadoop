{
  int retries=dfsClient.getConf().nBlockWriteLocateFollowingRetry;
  long sleeptime=400;
  while (true) {
    long localstart=Time.now();
    while (true) {
      try {
        return dfsClient.namenode.addBlock(src,dfsClient.clientName,block,excludedNodes,fileId);
      }
 catch (      RemoteException e) {
        IOException ue=e.unwrapRemoteException(FileNotFoundException.class,AccessControlException.class,NSQuotaExceededException.class,DSQuotaExceededException.class,UnresolvedPathException.class);
        if (ue != e) {
          throw ue;
        }
        if (NotReplicatedYetException.class.getName().equals(e.getClassName())) {
          if (retries == 0) {
            throw e;
          }
 else {
            --retries;
            DFSClient.LOG.info("Exception while adding a block",e);
            if (Time.now() - localstart > 5000) {
              DFSClient.LOG.info("Waiting for replication for " + (Time.now() - localstart) / 1000 + " seconds");
            }
            try {
              DFSClient.LOG.warn("NotReplicatedYetException sleeping " + src + " retries left "+ retries);
              Thread.sleep(sleeptime);
              sleeptime*=2;
            }
 catch (            InterruptedException ie) {
              DFSClient.LOG.warn("Caught exception ",ie);
            }
          }
        }
 else {
          throw e;
        }
      }
    }
  }
}
