{
  LocatedBlock lb=null;
  DatanodeInfo[] nodes=null;
  int count=dfsClient.getConf().nBlockWriteRetry;
  boolean success=false;
  ExtendedBlock oldBlock=block;
  do {
    hasError=false;
    lastException=null;
    errorIndex=-1;
    success=false;
    long startTime=System.currentTimeMillis();
    DatanodeInfo[] excluded=excludedNodes.toArray(new DatanodeInfo[excludedNodes.size()]);
    block=oldBlock;
    lb=locateFollowingBlock(startTime,excluded.length > 0 ? excluded : null);
    block=lb.getBlock();
    block.setNumBytes(0);
    accessToken=lb.getBlockToken();
    nodes=lb.getLocations();
    success=createBlockOutputStream(nodes,0L,false);
    if (!success) {
      DFSClient.LOG.info("Abandoning block " + block);
      dfsClient.namenode.abandonBlock(block,src,dfsClient.clientName);
      block=null;
      DFSClient.LOG.info("Excluding datanode " + nodes[errorIndex]);
      excludedNodes.add(nodes[errorIndex]);
    }
  }
 while (!success && --count >= 0);
  if (!success) {
    throw new IOException("Unable to create new block.");
  }
  return nodes;
}
