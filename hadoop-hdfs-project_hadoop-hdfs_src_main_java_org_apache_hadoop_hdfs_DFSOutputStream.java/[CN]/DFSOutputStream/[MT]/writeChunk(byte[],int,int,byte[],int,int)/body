{
  dfsClient.checkOpen();
  checkClosed();
  if (len > bytesPerChecksum) {
    throw new IOException("writeChunk() buffer size is " + len + " is larger than supported  bytesPerChecksum "+ bytesPerChecksum);
  }
  if (cklen != 0 && cklen != getChecksumSize()) {
    throw new IOException("writeChunk() checksum size is supposed to be " + getChecksumSize() + " but found to be "+ cklen);
  }
  if (currentPacket == null) {
    currentPacket=createPacket(packetSize,chunksPerPacket,getStreamer().getBytesCurBlock(),getStreamer().getAndIncCurrentSeqno(),false);
    if (DFSClient.LOG.isDebugEnabled()) {
      DFSClient.LOG.debug("DFSClient writeChunk allocating new packet seqno=" + currentPacket.getSeqno() + ", src="+ src+ ", packetSize="+ packetSize+ ", chunksPerPacket="+ chunksPerPacket+ ", bytesCurBlock="+ getStreamer().getBytesCurBlock());
    }
  }
  currentPacket.writeChecksum(checksum,ckoff,cklen);
  currentPacket.writeData(b,offset,len);
  currentPacket.incNumChunks();
  getStreamer().incBytesCurBlock(len);
  if (currentPacket.getNumChunks() == currentPacket.getMaxChunks() || getStreamer().getBytesCurBlock() == blockSize) {
    enqueueCurrentPacketFull();
  }
}
