{
  dfsClient.checkOpen();
  checkClosed();
  if (len > bytesPerChecksum) {
    throw new IOException("writeChunk() buffer size is " + len + " is larger than supported  bytesPerChecksum "+ bytesPerChecksum);
  }
  if (cklen != 0 && cklen != getChecksumSize()) {
    throw new IOException("writeChunk() checksum size is supposed to be " + getChecksumSize() + " but found to be "+ cklen);
  }
  if (currentPacket == null) {
    currentPacket=createPacket(packetSize,chunksPerPacket,streamer.getBytesCurBlock(),streamer.getAndIncCurrentSeqno(),false);
    if (DFSClient.LOG.isDebugEnabled()) {
      DFSClient.LOG.debug("DFSClient writeChunk allocating new packet seqno=" + currentPacket.getSeqno() + ", src="+ src+ ", packetSize="+ packetSize+ ", chunksPerPacket="+ chunksPerPacket+ ", bytesCurBlock="+ streamer.getBytesCurBlock());
    }
  }
  currentPacket.writeChecksum(checksum,ckoff,cklen);
  currentPacket.writeData(b,offset,len);
  currentPacket.incNumChunks();
  streamer.incBytesCurBlock(len);
  if (currentPacket.getNumChunks() == currentPacket.getMaxChunks() || streamer.getBytesCurBlock() == blockSize) {
    if (DFSClient.LOG.isDebugEnabled()) {
      DFSClient.LOG.debug("DFSClient writeChunk packet full seqno=" + currentPacket.getSeqno() + ", src="+ src+ ", bytesCurBlock="+ streamer.getBytesCurBlock()+ ", blockSize="+ blockSize+ ", appendChunk="+ streamer.getAppendChunk());
    }
    streamer.waitAndQueuePacket(currentPacket);
    currentPacket=null;
    adjustChunkBoundary();
    endBlock();
  }
}
