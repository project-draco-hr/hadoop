{
  dfsClient.checkOpen();
  checkClosed();
  if (len > bytesPerChecksum) {
    throw new IOException("writeChunk() buffer size is " + len + " is larger than supported  bytesPerChecksum "+ bytesPerChecksum);
  }
  if (cklen != 0 && cklen != getChecksumSize()) {
    throw new IOException("writeChunk() checksum size is supposed to be " + getChecksumSize() + " but found to be "+ cklen);
  }
  if (currentPacket == null) {
    currentPacket=createPacket(packetSize,chunksPerPacket,bytesCurBlock,currentSeqno++,false);
    if (DFSClient.LOG.isDebugEnabled()) {
      DFSClient.LOG.debug("DFSClient writeChunk allocating new packet seqno=" + currentPacket.getSeqno() + ", src="+ src+ ", packetSize="+ packetSize+ ", chunksPerPacket="+ chunksPerPacket+ ", bytesCurBlock="+ bytesCurBlock);
    }
  }
  currentPacket.writeChecksum(checksum,ckoff,cklen);
  currentPacket.writeData(b,offset,len);
  currentPacket.incNumChunks();
  bytesCurBlock+=len;
  if (currentPacket.getNumChunks() == currentPacket.getMaxChunks() || bytesCurBlock == blockSize) {
    if (DFSClient.LOG.isDebugEnabled()) {
      DFSClient.LOG.debug("DFSClient writeChunk packet full seqno=" + currentPacket.getSeqno() + ", src="+ src+ ", bytesCurBlock="+ bytesCurBlock+ ", blockSize="+ blockSize+ ", appendChunk="+ appendChunk);
    }
    waitAndQueueCurrentPacket();
    if (appendChunk && bytesCurBlock % bytesPerChecksum == 0) {
      appendChunk=false;
      resetChecksumBufSize();
    }
    if (!appendChunk) {
      int psize=Math.min((int)(blockSize - bytesCurBlock),dfsClient.getConf().writePacketSize);
      computePacketChunkSize(psize,bytesPerChecksum);
    }
    if (bytesCurBlock == blockSize) {
      currentPacket=createPacket(0,0,bytesCurBlock,currentSeqno++,true);
      currentPacket.setSyncBlock(shouldSyncBlock);
      waitAndQueueCurrentPacket();
      bytesCurBlock=0;
      lastFlushOffset=0;
    }
  }
}
