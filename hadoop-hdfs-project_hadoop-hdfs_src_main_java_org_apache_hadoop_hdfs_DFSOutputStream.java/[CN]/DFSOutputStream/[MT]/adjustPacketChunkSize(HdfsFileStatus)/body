{
  long usedInLastBlock=stat.getLen() % blockSize;
  int freeInLastBlock=(int)(blockSize - usedInLastBlock);
  int usedInCksum=(int)(stat.getLen() % bytesPerChecksum);
  int freeInCksum=bytesPerChecksum - usedInCksum;
  if (freeInLastBlock == blockSize) {
    throw new IOException("The last block for file " + src + " is full.");
  }
  if (usedInCksum > 0 && freeInCksum > 0) {
    computePacketChunkSize(0,freeInCksum);
    setChecksumBufSize(freeInCksum);
    getStreamer().setAppendChunk(true);
  }
 else {
    computePacketChunkSize(Math.min(dfsClient.getConf().getWritePacketSize(),freeInLastBlock),bytesPerChecksum);
  }
}
