{
  if (closed) {
    IOException e=lastException;
    if (e == null)     return;
 else     throw e;
  }
  try {
    flushBuffer();
    if (currentPacket != null) {
      waitAndQueueCurrentPacket();
    }
    if (bytesCurBlock != 0) {
      currentPacket=new Packet(PacketHeader.PKT_HEADER_LEN,0,bytesCurBlock);
      currentPacket.lastPacketInBlock=true;
      currentPacket.syncBlock=shouldSyncBlock;
    }
    flushInternal();
    ExtendedBlock lastBlock=streamer.getBlock();
    closeThreads(false);
    completeFile(lastBlock);
    dfsClient.endFileLease(src);
  }
  finally {
    closed=true;
  }
}
