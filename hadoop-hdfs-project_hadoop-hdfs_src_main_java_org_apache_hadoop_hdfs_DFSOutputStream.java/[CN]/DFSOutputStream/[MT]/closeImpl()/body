{
  if (isClosed()) {
    getStreamer().getLastException().check(true);
    return;
  }
  try {
    flushBuffer();
    if (currentPacket != null) {
      getStreamer().waitAndQueuePacket(currentPacket);
      currentPacket=null;
    }
    if (getStreamer().getBytesCurBlock() != 0) {
      currentPacket=createPacket(0,0,getStreamer().getBytesCurBlock(),getStreamer().getAndIncCurrentSeqno(),true);
      currentPacket.setSyncBlock(shouldSyncBlock);
    }
    flushInternal();
    ExtendedBlock lastBlock=getStreamer().getBlock();
    closeThreads(false);
    TraceScope scope=Trace.startSpan("completeFile",Sampler.NEVER);
    try {
      completeFile(lastBlock);
    }
  finally {
      scope.close();
    }
    dfsClient.endFileLease(fileId);
  }
 catch (  ClosedChannelException e) {
  }
 finally {
    setClosed();
  }
}
