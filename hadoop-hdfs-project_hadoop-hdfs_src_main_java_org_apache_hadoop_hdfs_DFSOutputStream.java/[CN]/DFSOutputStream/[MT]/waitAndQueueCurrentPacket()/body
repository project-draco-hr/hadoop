{
synchronized (dataQueue) {
    try {
      while (!closed && dataQueue.size() + ackQueue.size() > MAX_PACKETS) {
        try {
          dataQueue.wait();
        }
 catch (        InterruptedException e) {
          Thread.currentThread().interrupt();
          break;
        }
      }
      checkClosed();
      queueCurrentPacket();
    }
 catch (    ClosedChannelException e) {
    }
  }
}
