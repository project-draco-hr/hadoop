{
  Preconditions.checkNotNull(existing);
  long modTime=now();
  INodesInPath newiip;
  fsd.writeLock();
  try {
    ErasureCodingPolicy ecPolicy=FSDirErasureCodingOp.getErasureCodingPolicy(fsd.getFSNamesystem(),existing);
    if (ecPolicy != null) {
      replication=ecPolicy.getId();
    }
    INodeFile newNode=newINodeFile(fsd.allocateNewInodeId(),permissions,modTime,modTime,replication,preferredBlockSize,ecPolicy != null);
    newNode.setLocalName(localName);
    newNode.toUnderConstruction(clientName,clientMachine);
    newiip=fsd.addINode(existing,newNode);
  }
  finally {
    fsd.writeUnlock();
  }
  if (newiip == null) {
    NameNode.stateChangeLog.info("DIR* addFile: failed to add " + existing.getPath() + "/"+ DFSUtil.bytes2String(localName));
    return null;
  }
  if (NameNode.stateChangeLog.isDebugEnabled()) {
    NameNode.stateChangeLog.debug("DIR* addFile: " + DFSUtil.bytes2String(localName) + " is added");
  }
  return newiip;
}
