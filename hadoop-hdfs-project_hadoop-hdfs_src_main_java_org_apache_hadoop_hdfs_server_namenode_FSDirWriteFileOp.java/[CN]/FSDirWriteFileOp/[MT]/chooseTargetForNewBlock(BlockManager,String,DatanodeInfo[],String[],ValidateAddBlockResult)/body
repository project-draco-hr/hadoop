{
  Node clientNode=bm.getDatanodeManager().getDatanodeByHost(r.clientMachine);
  if (clientNode == null) {
    clientNode=getClientNode(bm,r.clientMachine);
  }
  Set<Node> excludedNodesSet=null;
  if (excludedNodes != null) {
    excludedNodesSet=new HashSet<>(excludedNodes.length);
    Collections.addAll(excludedNodesSet,excludedNodes);
  }
  List<String> favoredNodesList=(favoredNodes == null) ? null : Arrays.asList(favoredNodes);
  return bm.chooseTarget4NewBlock(src,r.numTargets,clientNode,excludedNodesSet,r.blockSize,favoredNodesList,r.storagePolicyID,r.isStriped);
}
