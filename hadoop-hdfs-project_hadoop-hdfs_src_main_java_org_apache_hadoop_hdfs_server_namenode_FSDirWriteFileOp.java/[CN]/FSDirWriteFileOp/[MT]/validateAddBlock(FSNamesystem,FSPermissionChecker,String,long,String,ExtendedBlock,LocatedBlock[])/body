{
  final long blockSize;
  final short numTargets;
  final byte storagePolicyID;
  String clientMachine;
  final boolean isStriped;
  byte[][] pathComponents=FSDirectory.getPathComponentsForReservedPath(src);
  src=fsn.dir.resolvePath(pc,src,pathComponents);
  FileState fileState=analyzeFileState(fsn,src,fileId,clientName,previous,onRetryBlock);
  final INodeFile pendingFile=fileState.inode;
  if (!fsn.checkFileProgress(src,pendingFile,false)) {
    throw new NotReplicatedYetException("Not replicated yet: " + src);
  }
  if (onRetryBlock[0] != null && onRetryBlock[0].getLocations().length > 0) {
    return null;
  }
  if (pendingFile.getBlocks().length >= fsn.maxBlocksPerFile) {
    throw new IOException("File has reached the limit on maximum number of" + " blocks (" + DFSConfigKeys.DFS_NAMENODE_MAX_BLOCKS_PER_FILE_KEY + "): "+ pendingFile.getBlocks().length+ " >= "+ fsn.maxBlocksPerFile);
  }
  blockSize=pendingFile.getPreferredBlockSize();
  clientMachine=pendingFile.getFileUnderConstructionFeature().getClientMachine();
  isStriped=pendingFile.isStriped();
  numTargets=isStriped ? HdfsConstants.NUM_DATA_BLOCKS + HdfsConstants.NUM_PARITY_BLOCKS : pendingFile.getFileReplication();
  storagePolicyID=pendingFile.getStoragePolicyID();
  return new ValidateAddBlockResult(blockSize,numTargets,storagePolicyID,clientMachine,isStriped);
}
