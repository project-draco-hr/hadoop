{
  Configuration conf=new Configuration();
  MiniDFSCluster cluster=null;
  try {
    cluster=new MiniDFSCluster(port,conf,2,true,true,null,null);
    URI uri=cluster.getFileSystem().getUri();
    LOG.info("uri=" + uri);
{
      FileSystem fs=FileSystem.get(uri,new Configuration());
      checkPath(cluster,fs);
      for (int i=0; i < 100; i++) {
        assertTrue(fs == FileSystem.get(uri,new Configuration()));
      }
    }
    if (port == DFSConfigKeys.DFS_NAMENODE_RPC_PORT_DEFAULT) {
      URI uri2=new URI(uri.getScheme(),uri.getUserInfo(),uri.getHost(),DFSConfigKeys.DFS_NAMENODE_RPC_PORT_DEFAULT,uri.getPath(),uri.getQuery(),uri.getFragment());
      LOG.info("uri2=" + uri2);
      FileSystem fs=FileSystem.get(uri2,conf);
      checkPath(cluster,fs);
      for (int i=0; i < 100; i++) {
        assertTrue(fs == FileSystem.get(uri2,new Configuration()));
      }
    }
  }
  finally {
    if (cluster != null)     cluster.shutdown();
  }
}
