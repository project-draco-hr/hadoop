{
  Configuration conf=new Configuration();
  MiniDFSCluster cluster=null;
  try {
    cluster=new MiniDFSCluster.Builder(conf).nameNodePort(port).numDataNodes(2).build();
    URI uri=cluster.getFileSystem().getUri();
    LOG.info("uri=" + uri);
{
      FileSystem fs=FileSystem.get(uri,new Configuration());
      checkPath(cluster,fs);
      for (int i=0; i < 100; i++) {
        assertTrue(fs == FileSystem.get(uri,new Configuration()));
      }
    }
    if (port == NameNode.DEFAULT_PORT) {
      URI uri2=new URI(uri.getScheme(),uri.getUserInfo(),uri.getHost(),NameNode.DEFAULT_PORT,uri.getPath(),uri.getQuery(),uri.getFragment());
      LOG.info("uri2=" + uri2);
      FileSystem fs=FileSystem.get(uri2,conf);
      checkPath(cluster,fs);
      for (int i=0; i < 100; i++) {
        assertTrue(fs == FileSystem.get(uri2,new Configuration()));
      }
    }
  }
  finally {
    if (cluster != null)     cluster.shutdown();
  }
}
