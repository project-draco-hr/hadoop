{
  Preconditions.checkState(!running,"Can't load state from image in a running SecretManager.");
  currentId=state.section.getCurrentId();
  delegationTokenSequenceNumber=state.section.getTokenSequenceNumber();
  for (  SecretManagerSection.DelegationKey k : state.keys) {
    addKey(new DelegationKey(k.getId(),k.getExpiryDate(),k.hasKey() ? k.getKey().toByteArray() : null));
  }
  for (  SecretManagerSection.PersistToken t : state.tokens) {
    DelegationTokenIdentifier id=new DelegationTokenIdentifier(new Text(t.getOwner()),new Text(t.getRenewer()),new Text(t.getRealUser()));
    id.setIssueDate(t.getIssueDate());
    id.setMaxDate(t.getMaxDate());
    id.setSequenceNumber(t.getSequenceNumber());
    id.setMasterKeyId(t.getMasterKeyId());
    addPersistedDelegationToken(id,t.getExpiryDate());
  }
}
