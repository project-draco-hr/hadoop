{
  return Mockito.spy(new HAServiceProtocol(){
    @Override public void monitorHealth() throws HealthCheckFailedException, AccessControlException, IOException {
      checkUnreachable();
      if (!isHealthy) {
        throw new HealthCheckFailedException("not healthy");
      }
    }
    @Override public void transitionToActive() throws ServiceFailedException, AccessControlException, IOException {
      checkUnreachable();
      state=HAServiceState.ACTIVE;
    }
    @Override public void transitionToStandby() throws ServiceFailedException, AccessControlException, IOException {
      checkUnreachable();
      state=HAServiceState.STANDBY;
    }
    @Override public HAServiceStatus getServiceStatus() throws IOException {
      checkUnreachable();
      HAServiceStatus ret=new HAServiceStatus(state);
      if (state == HAServiceState.STANDBY) {
        ret.setReadyToBecomeActive();
      }
      return ret;
    }
    private void checkUnreachable() throws IOException {
      if (actUnreachable) {
        throw new IOException("Connection refused (fake)");
      }
    }
  }
);
}
