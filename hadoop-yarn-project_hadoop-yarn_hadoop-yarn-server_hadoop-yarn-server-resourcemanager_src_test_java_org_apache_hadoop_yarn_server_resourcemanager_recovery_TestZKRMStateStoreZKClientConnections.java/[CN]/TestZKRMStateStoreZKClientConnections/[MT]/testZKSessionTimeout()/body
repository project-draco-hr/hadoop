{
  TestZKClient zkClientTester=new TestZKClient();
  String path="/test";
  YarnConfiguration conf=new YarnConfiguration();
  conf.setInt(YarnConfiguration.RM_ZK_TIMEOUT_MS,ZK_TIMEOUT_MS);
  ZKRMStateStore store=(ZKRMStateStore)zkClientTester.getRMStateStore(conf);
  TestDispatcher dispatcher=new TestDispatcher();
  store.setRMDispatcher(dispatcher);
  zkClientTester.forExpire=true;
  store.createWithRetries(path,null,ZooDefs.Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
  store.getDataWithRetries(path,true);
  store.setDataWithRetries(path,"bytes".getBytes(),0);
  zkClientTester.syncBarrier.await();
  try {
    byte[] ret=store.getDataWithRetries(path,false);
    assertEquals("bytes",new String(ret));
  }
 catch (  Exception e) {
    String error="New session creation failed";
    LOG.error(error,e);
    fail(error);
  }
  Assert.assertTrue(zkClientTester.oldWatcher != null);
  WatchedEvent disconnectedEvent=new WatchedEvent(Watcher.Event.EventType.None,Watcher.Event.KeeperState.Disconnected,null);
  zkClientTester.oldWatcher.process(disconnectedEvent);
  Assert.assertTrue(store.zkClient != null);
  zkClientTester.watcher.process(disconnectedEvent);
  Assert.assertTrue(store.zkClient == null);
  WatchedEvent connectedEvent=new WatchedEvent(Watcher.Event.EventType.None,Watcher.Event.KeeperState.SyncConnected,null);
  zkClientTester.watcher.process(connectedEvent);
  Assert.assertTrue(store.zkClient != null);
  Assert.assertTrue(store.zkClient == store.activeZkClient);
}
