{
  try {
    UserGroupInformation ugi=UserGroupInformation.getCurrentUser();
    AuthenticationMethod authMethod=UserGroupInformation.getRealAuthenticationMethod(ugi);
    if (UserGroupInformation.isSecurityEnabled() && (authMethod != AuthenticationMethod.KERBEROS)) {
      throw new IOException("Delegation Token can be issued only with kerberos authentication");
    }
    GetDelegationTokenResponse response=recordFactory.newRecordInstance(GetDelegationTokenResponse.class);
    String user=ugi.getUserName();
    Text owner=new Text(user);
    Text realUser=null;
    if (ugi.getRealUser() != null) {
      realUser=new Text(ugi.getRealUser().getUserName());
    }
    MRDelegationTokenIdentifier tokenIdentifier=new MRDelegationTokenIdentifier(owner,new Text(request.getRenewer()),realUser);
    Token<MRDelegationTokenIdentifier> realJHSToken=new Token<MRDelegationTokenIdentifier>(tokenIdentifier,jhsDTSecretManager);
    DelegationToken mrDToken=BuilderUtils.newDelegationToken(realJHSToken.getIdentifier(),realJHSToken.getKind().toString(),realJHSToken.getPassword(),bindAddress.getAddress().getHostAddress() + ":" + bindAddress.getPort());
    response.setDelegationToken(mrDToken);
    return response;
  }
 catch (  IOException i) {
    throw RPCUtil.getRemoteException(i);
  }
}
