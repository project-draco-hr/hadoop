{
  String nameserviceId=conf.get(DFS_FEDERATION_NAMESERVICE_ID);
  if (nameserviceId != null) {
    return nameserviceId;
  }
  Collection<String> ids=getNameServiceIds(conf);
  if (ids == null || ids.size() == 0) {
    return null;
  }
  int found=0;
  for (  String id : ids) {
    String addr=conf.get(getNameServiceIdKey(addressKey,id));
    InetSocketAddress s=NetUtils.createSocketAddr(addr);
    if (NetUtils.isLocalAddress(s.getAddress())) {
      nameserviceId=id;
      found++;
    }
  }
  if (found > 1) {
    throw new HadoopIllegalArgumentException("Configuration has multiple RPC addresses that matches " + "the local node's address. Please configure the system with " + "the parameter "+ DFS_FEDERATION_NAMESERVICE_ID);
  }
  if (found == 0) {
    throw new HadoopIllegalArgumentException("Configuration address " + addressKey + " is missing in configuration with name service Id");
  }
  return nameserviceId;
}
