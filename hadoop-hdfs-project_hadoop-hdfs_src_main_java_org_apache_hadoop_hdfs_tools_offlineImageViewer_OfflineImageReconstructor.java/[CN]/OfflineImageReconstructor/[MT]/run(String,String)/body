{
  MessageDigest digester=MD5Hash.getDigester();
  FileOutputStream fout=null;
  File foutHash=new File(outputPath + ".md5");
  Files.deleteIfExists(foutHash.toPath());
  CountingOutputStream out=null;
  FileInputStream fis=null;
  InputStreamReader reader=null;
  try {
    Files.deleteIfExists(Paths.get(outputPath));
    fout=new FileOutputStream(outputPath);
    fis=new FileInputStream(inputPath);
    reader=new InputStreamReader(fis,Charset.forName("UTF-8"));
    out=new CountingOutputStream(new DigestOutputStream(new BufferedOutputStream(fout),digester));
    OfflineImageReconstructor oir=new OfflineImageReconstructor(out,reader);
    oir.processXml();
  }
  finally {
    IOUtils.cleanup(LOG,reader,fis,out,fout);
  }
  MD5FileUtils.saveMD5File(new File(outputPath),new MD5Hash(digester.digest()));
}
