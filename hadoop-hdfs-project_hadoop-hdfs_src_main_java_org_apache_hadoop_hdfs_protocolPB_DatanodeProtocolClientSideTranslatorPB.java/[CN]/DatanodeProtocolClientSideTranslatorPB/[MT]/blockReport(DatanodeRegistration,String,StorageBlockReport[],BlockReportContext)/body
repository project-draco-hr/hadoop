{
  BlockReportRequestProto.Builder builder=BlockReportRequestProto.newBuilder().setRegistration(PBHelper.convert(registration)).setBlockPoolId(poolId);
  boolean useBlocksBuffer=registration.getNamespaceInfo().isCapabilitySupported(Capability.STORAGE_BLOCK_REPORT_BUFFERS);
  for (  StorageBlockReport r : reports) {
    StorageBlockReportProto.Builder reportBuilder=StorageBlockReportProto.newBuilder().setStorage(PBHelper.convert(r.getStorage()));
    BlockListAsLongs blocks=r.getBlocks();
    if (useBlocksBuffer) {
      reportBuilder.setNumberOfBlocks(blocks.getNumberOfBlocks());
      reportBuilder.addAllBlocksBuffers(blocks.getBlocksBuffers());
    }
 else {
      for (      long value : blocks.getBlockListAsLongs()) {
        reportBuilder.addBlocks(value);
      }
    }
    builder.addReports(reportBuilder.build());
  }
  builder.setContext(PBHelper.convert(context));
  BlockReportResponseProto resp;
  try {
    resp=rpcProxy.blockReport(NULL_CONTROLLER,builder.build());
  }
 catch (  ServiceException se) {
    throw ProtobufHelper.getRemoteException(se);
  }
  return resp.hasCmd() ? PBHelper.convert(resp.getCmd()) : null;
}
