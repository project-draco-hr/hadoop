{
  HistoryFileManager historyManager=mock(HistoryFileManager.class);
  jobHistory=spy(new JobHistory());
  doReturn(historyManager).when(jobHistory).createHistoryFileManager();
  Configuration conf=new Configuration();
  conf.setInt(JHAdminConfig.MR_HISTORY_LOADED_TASKS_CACHE_SIZE,50);
  jobHistory.init(conf);
  jobHistory.start();
  CachedHistoryStorage storage=spy((CachedHistoryStorage)jobHistory.getHistoryStorage());
  assertTrue(storage.getUseLoadedTasksCache());
  assertEquals(storage.getLoadedTasksCacheSize(),50);
  Job[] jobs=new Job[10];
  JobId[] jobIds=new JobId[10];
  for (int i=0; i < jobs.length; i++) {
    jobs[i]=mock(Job.class);
    jobIds[i]=mock(JobId.class);
    when(jobs[i].getID()).thenReturn(jobIds[i]);
    when(jobs[i].getTotalMaps()).thenReturn(10);
    when(jobs[i].getTotalReduces()).thenReturn(2);
  }
  Job[] lgJobs=new Job[3];
  JobId[] lgJobIds=new JobId[3];
  for (int i=0; i < lgJobs.length; i++) {
    lgJobs[i]=mock(Job.class);
    lgJobIds[i]=mock(JobId.class);
    when(lgJobs[i].getID()).thenReturn(lgJobIds[i]);
    when(lgJobs[i].getTotalMaps()).thenReturn(2000);
    when(lgJobs[i].getTotalReduces()).thenReturn(10);
  }
  HistoryFileInfo fileInfo=mock(HistoryFileInfo.class);
  when(historyManager.getFileInfo(any(JobId.class))).thenReturn(fileInfo);
  when(fileInfo.loadJob()).thenReturn(jobs[0]).thenReturn(jobs[1]).thenReturn(jobs[2]).thenReturn(jobs[3]).thenReturn(jobs[4]).thenReturn(jobs[5]).thenReturn(jobs[6]).thenReturn(jobs[7]).thenReturn(jobs[8]).thenReturn(jobs[9]).thenReturn(lgJobs[0]).thenReturn(lgJobs[1]).thenReturn(lgJobs[2]);
  Cache<JobId,Job> jobCache=storage.getLoadedJobCache();
  for (int i=0; i < jobs.length; i++) {
    storage.getFullJob(jobs[i].getID());
  }
  long prevSize=jobCache.size();
  for (int i=0; i < lgJobs.length; i++) {
    storage.getFullJob(lgJobs[i].getID());
  }
  assertTrue(jobCache.size() < prevSize);
}
