{
  File fileBlock=null;
  InputStream in=null;
  OutputStream out=null;
  try {
    fileBlock=newBackupFile();
    String blockId=blockToKey(block);
    in=get(blockId,byteRangeStart);
    if (in == null) {
      throw new IOException("Block missing from S3 store: " + blockId);
    }
    out=new BufferedOutputStream(new FileOutputStream(fileBlock));
    byte[] buf=new byte[bufferSize];
    int numRead;
    while ((numRead=in.read(buf)) >= 0) {
      out.write(buf,0,numRead);
    }
    return fileBlock;
  }
 catch (  IOException e) {
    closeQuietly(out);
    out=null;
    if (fileBlock != null) {
      boolean b=fileBlock.delete();
      if (!b) {
        LOG.warn("Ignoring failed delete");
      }
    }
    throw e;
  }
 finally {
    closeQuietly(out);
    closeQuietly(in);
  }
}
