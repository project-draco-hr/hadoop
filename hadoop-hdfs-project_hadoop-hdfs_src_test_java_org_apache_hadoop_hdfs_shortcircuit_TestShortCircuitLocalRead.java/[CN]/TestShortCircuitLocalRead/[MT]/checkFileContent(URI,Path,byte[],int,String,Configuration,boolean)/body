{
  DistributedFileSystem fs=getFileSystem(readingUser,uri,conf);
  ClientContext getClientContext=ClientContext.getFromConf(conf);
  if (legacyShortCircuitFails) {
    assertFalse(getClientContext.getDisableLegacyBlockReaderLocal());
  }
  FSDataInputStream stm=fs.open(name);
  byte[] actual=new byte[expected.length - readOffset];
  stm.readFully(readOffset,actual);
  checkData(actual,readOffset,expected,"Read 2");
  stm.close();
  actual=new byte[expected.length - readOffset];
  stm=fs.open(name);
  IOUtils.skipFully(stm,readOffset);
  int nread=stm.read(actual,0,3);
  nread+=stm.read(actual,nread,2);
  int len=517;
  if (actual.length - nread >= len) {
    nread+=stm.read(actual,nread,len);
  }
  checkData(actual,readOffset,expected,nread,"A few bytes");
  while (nread < actual.length) {
    int nbytes=stm.read(actual,nread,actual.length - nread);
    if (nbytes < 0) {
      throw new EOFException("End of file reached before reading fully.");
    }
    nread+=nbytes;
  }
  checkData(actual,readOffset,expected,"Read 3");
  if (legacyShortCircuitFails) {
    assertTrue(getClientContext.getDisableLegacyBlockReaderLocal());
  }
  stm.close();
}
