{
  DistributedFileSystem dfs=cluster.getFileSystem();
  dfs.mkdirs(dir);
  dfs.getClient().createErasureCodingZone(dir.toString());
  FSDataOutputStream out=null;
  try {
    out=dfs.create(file,(short)1);
    FSNamesystem ns=cluster.getNamesystem();
    FSDirectory fsdir=ns.getFSDirectory();
    INodeFile fileNode=fsdir.getINode4Write(file.toString()).asFile();
    ExtendedBlock previous=null;
    for (int i=0; i < numBlocks; i++) {
      Block newBlock=createBlock(cluster.getDataNodes(),dfs,ns,file.toString(),fileNode,dfs.getClient().getClientName(),previous,numStripesPerBlk);
      previous=new ExtendedBlock(ns.getBlockPoolId(),newBlock);
    }
    dfs.getClient().namenode.complete(file.toString(),dfs.getClient().getClientName(),previous,fileNode.getId());
  }
  finally {
    IOUtils.cleanup(null,out);
  }
}
