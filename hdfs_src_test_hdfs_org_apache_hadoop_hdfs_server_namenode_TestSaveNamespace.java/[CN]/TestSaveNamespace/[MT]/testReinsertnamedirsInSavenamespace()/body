{
  Configuration conf=getConf();
  conf.setBoolean(DFSConfigKeys.DFS_NAMENODE_NAME_DIR_RESTORE_KEY,true);
  NameNode.initMetrics(conf,NamenodeRole.NAMENODE);
  DFSTestUtil.formatNameNode(conf);
  FSNamesystem fsn=new FSNamesystem(conf);
  FSImage originalImage=fsn.dir.fsImage;
  NNStorage storage=originalImage.getStorage();
  storage.close();
  NNStorage spyStorage=spy(storage);
  originalImage.storage=spyStorage;
  FSImage spyImage=spy(originalImage);
  fsn.dir.fsImage=spyImage;
  spyImage.getStorage().setStorageDirectories(FSNamesystem.getNamespaceDirs(conf),FSNamesystem.getNamespaceEditsDirs(conf));
  doAnswer(new FaultySaveImage(false)).when(spyImage).saveFSImage((File)anyObject());
  try {
    doAnEdit(fsn,1);
    fsn.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
    LOG.info("Doing the first savenamespace.");
    fsn.saveNamespace();
    LOG.warn("First savenamespace sucessful.");
    assertTrue("Savenamespace should have marked one directory as bad." + " But found " + spyStorage.getRemovedStorageDirs().size() + " bad directories.",spyStorage.getRemovedStorageDirs().size() == 1);
    LOG.info("Doing the second savenamespace.");
    fsn.saveNamespace();
    LOG.warn("Second savenamespace sucessful.");
    assertTrue("Savenamespace should have been successful in removing " + " bad directories from Image." + " But found " + storage.getRemovedStorageDirs().size() + " bad directories.",storage.getRemovedStorageDirs().size() == 0);
    LOG.info("Shutting down fsimage.");
    originalImage.close();
    fsn.close();
    fsn=null;
    LOG.info("Loading new FSmage from disk.");
    fsn=new FSNamesystem(conf);
    LOG.info("Checking reloaded image.");
    checkEditExists(fsn,1);
    LOG.info("Reloaded image is good.");
  }
  finally {
    if (fsn != null) {
      fsn.close();
    }
  }
}
