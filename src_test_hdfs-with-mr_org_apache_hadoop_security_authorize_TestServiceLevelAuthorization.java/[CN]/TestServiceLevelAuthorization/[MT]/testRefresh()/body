{
  MiniDFSCluster dfs=null;
  try {
    final int slaves=4;
    Configuration conf=new Configuration();
    conf.setClass(PolicyProvider.POLICY_PROVIDER_CONFIG,HDFSPolicyProvider.class,PolicyProvider.class);
    conf.setBoolean(ServiceAuthorizationManager.SERVICE_AUTHORIZATION_CONFIG,true);
    dfs=new MiniDFSCluster(conf,slaves,true,null);
    refreshPolicy(conf);
    String confDir=System.getProperty("test.build.extraconf","build/test/extraconf");
    File policyFile=new File(confDir,ConfiguredPolicy.HADOOP_POLICY_FILE);
    String policyFileCopy=ConfiguredPolicy.HADOOP_POLICY_FILE + ".orig";
    FileUtil.copy(policyFile,FileSystem.getLocal(conf),new Path(confDir,policyFileCopy),false,conf);
    rewriteHadoopPolicyFile(new File(confDir,ConfiguredPolicy.HADOOP_POLICY_FILE));
    refreshPolicy(conf);
    try {
      conf.set(UnixUserGroupInformation.UGI_PROPERTY_NAME,UNKNOWN_USER);
      refreshPolicy(conf);
      fail("Refresh of NameNode's policy file cannot be successful!");
    }
 catch (    RemoteException re) {
      System.out.println("Good, refresh worked... refresh failed with: " + StringUtils.stringifyException(re.unwrapRemoteException()));
    }
 finally {
      FileUtil.fullyDelete(new File(confDir,ConfiguredPolicy.HADOOP_POLICY_FILE));
      FileUtil.replaceFile(new File(confDir,policyFileCopy),new File(confDir,ConfiguredPolicy.HADOOP_POLICY_FILE));
    }
  }
  finally {
    if (dfs != null) {
      dfs.shutdown();
    }
  }
}
