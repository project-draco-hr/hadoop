{
  final BlockManager bm=cluster.getNamesystem().getBlockManager();
  ExtendedBlock b=DFSTestUtil.getFirstBlock(fs,ECFilePath);
  Iterator<DatanodeStorageInfo> storageInfos=bm.blocksMap.getStorages(b.getLocalBlock()).iterator();
  DatanodeDescriptor firstDn=storageInfos.next().getDatanodeDescriptor();
  Iterator<BlockInfo> it=firstDn.getBlockIterator();
  int missingBlkCnt=0;
  while (it.hasNext()) {
    BlockInfo blk=it.next();
    BlockManager.LOG.debug("Block " + blk + " will be lost");
    missingBlkCnt++;
  }
  BlockManager.LOG.debug("Missing in total " + missingBlkCnt + " blocks");
  bm.getDatanodeManager().removeDatanode(firstDn);
  bm.computeDatanodeWork();
  short cnt=0;
  for (  DataNode dn : cluster.getDataNodes()) {
    DatanodeDescriptor dnDescriptor=bm.getDatanodeManager().getDatanode(dn.getDatanodeUuid());
    cnt+=dnDescriptor.getNumberOfBlocksToBeErasureCoded();
  }
  assertTrue("Counting the number of outstanding EC tasks",cnt == missingBlkCnt);
}
