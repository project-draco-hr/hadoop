{
  Configuration conf=new Configuration();
  MiniDFSCluster cluster=null;
  try {
    conf.set(DFSConfigKeys.DFS_FEDERATION_NAMESERVICES,"namesServerId1");
    cluster=new MiniDFSCluster.Builder(conf).federation(true).numNameNodes(1).nameNodePort(nnPort1).build();
    DataNode dn=cluster.getDataNodes().get(0);
    assertEquals(1,dn.getAllBpOs().length);
    cluster.addNameNode(conf,nnPort2);
    assertEquals(2,dn.getAllBpOs().length);
    cluster.addNameNode(conf,nnPort3);
    assertEquals(3,dn.getAllBpOs().length);
    cluster.addNameNode(conf,nnPort4);
    BPOfferService[] bpoList=dn.getAllBpOs();
    for (int i=0; i < 4; i++) {
      InetSocketAddress addr=cluster.getNameNode(i).getNameNodeAddress();
      boolean found=false;
      for (int j=0; j < bpoList.length; j++) {
        if (bpoList[j] != null && addr.equals(bpoList[j].nnAddr)) {
          found=true;
          bpoList[j]=null;
          break;
        }
      }
      assertTrue("NameNode address " + addr + " is not found.",found);
    }
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
