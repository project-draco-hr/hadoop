{
  cluster.shutdown();
  cluster=null;
  HdfsConfiguration conf=createCachingConf();
  cluster=new MiniDFSCluster.Builder(conf).numDataNodes(0).build();
  cluster.waitActive();
  DistributedFileSystem dfs=cluster.getFileSystem();
  final String pool="poolparty";
  String groupName="partygroup";
  FsPermission mode=new FsPermission((short)0777);
  int weight=747;
  dfs.addCachePool(new CachePoolInfo(pool).setGroupName(groupName).setMode(mode).setWeight(weight));
  RemoteIterator<CachePoolInfo> pit=dfs.listCachePools();
  assertTrue("No cache pools found",pit.hasNext());
  CachePoolInfo info=pit.next();
  assertEquals(pool,info.getPoolName());
  assertEquals(groupName,info.getGroupName());
  assertEquals(mode,info.getMode());
  assertEquals(weight,(int)info.getWeight());
  assertFalse("Unexpected # of cache pools found",pit.hasNext());
  int numEntries=10;
  String entryPrefix="/party-";
  long prevId=-1;
  for (int i=0; i < numEntries; i++) {
    prevId=dfs.addPathBasedCacheDirective(new PathBasedCacheDirective.Builder().setPath(new Path(entryPrefix + i)).setPool(pool).build());
  }
  RemoteIterator<PathBasedCacheDirective> dit=dfs.listPathBasedCacheDirectives(null);
  for (int i=0; i < numEntries; i++) {
    assertTrue("Unexpected # of cache entries: " + i,dit.hasNext());
    PathBasedCacheDirective cd=dit.next();
    assertEquals(i + 1,cd.getId().longValue());
    assertEquals(entryPrefix + i,cd.getPath().toUri().getPath());
    assertEquals(pool,cd.getPool());
  }
  assertFalse("Unexpected # of cache directives found",dit.hasNext());
  cluster.restartNameNode();
  pit=dfs.listCachePools();
  assertTrue("No cache pools found",pit.hasNext());
  info=pit.next();
  assertEquals(pool,info.getPoolName());
  assertEquals(pool,info.getPoolName());
  assertEquals(groupName,info.getGroupName());
  assertEquals(mode,info.getMode());
  assertEquals(weight,(int)info.getWeight());
  assertFalse("Unexpected # of cache pools found",pit.hasNext());
  dit=dfs.listPathBasedCacheDirectives(null);
  for (int i=0; i < numEntries; i++) {
    assertTrue("Unexpected # of cache entries: " + i,dit.hasNext());
    PathBasedCacheDirective cd=dit.next();
    assertEquals(i + 1,cd.getId().longValue());
    assertEquals(entryPrefix + i,cd.getPath().toUri().getPath());
    assertEquals(pool,cd.getPool());
  }
  assertFalse("Unexpected # of cache directives found",dit.hasNext());
  long nextId=dfs.addPathBasedCacheDirective(new PathBasedCacheDirective.Builder().setPath(new Path("/foobar")).setPool(pool).build());
  assertEquals(prevId + 1,nextId);
}
