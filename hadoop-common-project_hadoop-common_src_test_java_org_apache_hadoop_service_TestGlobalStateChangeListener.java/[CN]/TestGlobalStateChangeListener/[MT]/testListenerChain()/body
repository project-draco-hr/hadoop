{
  LoggingStateChangeListener logListener=new LoggingStateChangeListener();
  register(logListener);
  BreakableStateChangeListener l0=new BreakableStateChangeListener("l0");
  register(l0);
  listener.setFailingState(Service.STATE.STARTED);
  register();
  BreakableStateChangeListener l3=new BreakableStateChangeListener("l3");
  register(l3);
  BreakableService service=new BreakableService();
  service.init(new Configuration());
  assertServiceStateInited(service);
  assertListenerState(l0,Service.STATE.INITED);
  assertListenerState(listener,Service.STATE.INITED);
  assertListenerState(l3,Service.STATE.INITED);
  service.start();
  assertServiceStateStarted(service);
  assertListenerState(l0,Service.STATE.STARTED);
  assertListenerEventCount(l0,2);
  assertListenerState(listener,Service.STATE.STARTED);
  assertListenerEventCount(listener,2);
  assertListenerState(l3,Service.STATE.INITED);
  assertListenerEventCount(l3,1);
  service.stop();
  assertListenerEventCount(l0,3);
  assertListenerEventCount(listener,3);
  assertListenerEventCount(l3,2);
  unregister(logListener);
  unregister(l0);
  unregister(l3);
  service=new BreakableService();
  service.init(new Configuration());
  assertListenerEventCount(l0,3);
  assertListenerEventCount(l3,2);
  assertListenerEventCount(listener,4);
}
