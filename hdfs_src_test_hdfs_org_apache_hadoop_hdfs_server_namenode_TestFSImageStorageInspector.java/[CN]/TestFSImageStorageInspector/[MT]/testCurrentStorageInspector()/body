{
  FSImageTransactionalStorageInspector inspector=new FSImageTransactionalStorageInspector();
  StorageDirectory mockDir=mockDirectory(NameNodeDirType.IMAGE_AND_EDITS,false,"/foo/current/" + getImageFileName(123),"/foo/current/" + getFinalizedEditsFileName(123,456),"/foo/current/" + getImageFileName(456),"/foo/current/" + getInProgressEditsFileName(457));
  inspector.inspectDirectory(mockDir);
  mockLogValidation(inspector,"/foo/current/" + getInProgressEditsFileName(457),10);
  assertEquals(2,inspector.foundEditLogs.size());
  assertEquals(2,inspector.foundImages.size());
  assertTrue(inspector.foundEditLogs.get(1).isInProgress());
  FoundFSImage latestImage=inspector.getLatestImage();
  assertEquals(456,latestImage.txId);
  assertSame(mockDir,latestImage.sd);
  assertTrue(inspector.isUpgradeFinalized());
  LoadPlan plan=inspector.createLoadPlan();
  LOG.info("Plan: " + plan);
  assertEquals(new File("/foo/current/" + getImageFileName(456)),plan.getImageFile());
  assertArrayEquals(new File[]{new File("/foo/current/" + getInProgressEditsFileName(457))},plan.getEditsFiles().toArray(new File[0]));
}
