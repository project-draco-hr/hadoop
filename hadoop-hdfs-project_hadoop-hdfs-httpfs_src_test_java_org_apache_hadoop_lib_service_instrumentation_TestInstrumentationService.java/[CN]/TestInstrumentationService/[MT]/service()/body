{
  String dir=TestDirHelper.getTestDir().getAbsolutePath();
  String services=StringUtils.join(",",Arrays.asList(InstrumentationService.class.getName()));
  Configuration conf=new Configuration(false);
  conf.set("server.services",services);
  Server server=new Server("server",dir,dir,dir,dir,conf);
  server.init();
  Instrumentation instrumentation=server.get(Instrumentation.class);
  assertNotNull(instrumentation);
  instrumentation.incr("g","c",1);
  instrumentation.incr("g","c",2);
  instrumentation.incr("g","c1",2);
  Instrumentation.Cron cron=instrumentation.createCron();
  cron.start();
  sleep(100);
  cron.stop();
  instrumentation.addCron("g","t",cron);
  cron=instrumentation.createCron();
  cron.start();
  sleep(200);
  cron.stop();
  instrumentation.addCron("g","t",cron);
  Instrumentation.Variable<String> var=new Instrumentation.Variable<String>(){
    @Override public String getValue(){
      return "foo";
    }
  }
;
  instrumentation.addVariable("g","v",var);
  Instrumentation.Variable<Long> varToSample=new Instrumentation.Variable<Long>(){
    @Override public Long getValue(){
      return 1L;
    }
  }
;
  instrumentation.addSampler("g","s",10,varToSample);
  Map<String,?> snapshot=instrumentation.getSnapshot();
  assertNotNull(snapshot.get("os-env"));
  assertNotNull(snapshot.get("sys-props"));
  assertNotNull(snapshot.get("jvm"));
  assertNotNull(snapshot.get("counters"));
  assertNotNull(snapshot.get("timers"));
  assertNotNull(snapshot.get("variables"));
  assertNotNull(snapshot.get("samplers"));
  assertNotNull(((Map<String,String>)snapshot.get("os-env")).get("PATH"));
  assertNotNull(((Map<String,String>)snapshot.get("sys-props")).get("java.version"));
  assertNotNull(((Map<String,?>)snapshot.get("jvm")).get("free.memory"));
  assertNotNull(((Map<String,?>)snapshot.get("jvm")).get("max.memory"));
  assertNotNull(((Map<String,?>)snapshot.get("jvm")).get("total.memory"));
  assertNotNull(((Map<String,Map<String,Object>>)snapshot.get("counters")).get("g"));
  assertNotNull(((Map<String,Map<String,Object>>)snapshot.get("timers")).get("g"));
  assertNotNull(((Map<String,Map<String,Object>>)snapshot.get("variables")).get("g"));
  assertNotNull(((Map<String,Map<String,Object>>)snapshot.get("samplers")).get("g"));
  assertNotNull(((Map<String,Map<String,Object>>)snapshot.get("counters")).get("g").get("c"));
  assertNotNull(((Map<String,Map<String,Object>>)snapshot.get("counters")).get("g").get("c1"));
  assertNotNull(((Map<String,Map<String,Object>>)snapshot.get("timers")).get("g").get("t"));
  assertNotNull(((Map<String,Map<String,Object>>)snapshot.get("variables")).get("g").get("v"));
  assertNotNull(((Map<String,Map<String,Object>>)snapshot.get("samplers")).get("g").get("s"));
  StringWriter writer=new StringWriter();
  JSONObject.writeJSONString(snapshot,writer);
  writer.close();
  server.destroy();
}
