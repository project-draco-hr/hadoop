{
  ds=new DefaultDirectoryService();
  ds.setInstanceLayout(new InstanceLayout(workDir));
  CacheService cacheService=new CacheService();
  ds.setCacheService(cacheService);
  InstanceLayout instanceLayout=ds.getInstanceLayout();
  File schemaPartitionDirectory=new File(instanceLayout.getPartitionsDirectory(),"schema");
  SchemaLdifExtractor extractor=new DefaultSchemaLdifExtractor(instanceLayout.getPartitionsDirectory());
  extractor.extractOrCopy();
  SchemaLoader loader=new LdifSchemaLoader(schemaPartitionDirectory);
  SchemaManager schemaManager=new DefaultSchemaManager(loader);
  schemaManager.loadAllEnabled();
  ds.setSchemaManager(schemaManager);
  LdifPartition schemaLdifPartition=new LdifPartition(schemaManager);
  schemaLdifPartition.setPartitionPath(schemaPartitionDirectory.toURI());
  SchemaPartition schemaPartition=new SchemaPartition(schemaManager);
  schemaPartition.setWrappedPartition(schemaLdifPartition);
  ds.setSchemaPartition(schemaPartition);
  JdbmPartition systemPartition=new JdbmPartition(ds.getSchemaManager());
  systemPartition.setId("system");
  systemPartition.setPartitionPath(new File(ds.getInstanceLayout().getPartitionsDirectory(),systemPartition.getId()).toURI());
  systemPartition.setSuffixDn(new Dn(ServerDNConstants.SYSTEM_DN));
  systemPartition.setSchemaManager(ds.getSchemaManager());
  ds.setSystemPartition(systemPartition);
  ds.getChangeLog().setEnabled(false);
  ds.setDenormalizeOpAttrsEnabled(true);
  ds.addLast(new KeyDerivationInterceptor());
  String orgName=conf.getProperty(ORG_NAME).toLowerCase();
  String orgDomain=conf.getProperty(ORG_DOMAIN).toLowerCase();
  JdbmPartition partition=new JdbmPartition(ds.getSchemaManager());
  partition.setId(orgName);
  partition.setPartitionPath(new File(ds.getInstanceLayout().getPartitionsDirectory(),orgName).toURI());
  partition.setSuffixDn(new Dn("dc=" + orgName + ",dc="+ orgDomain));
  ds.addPartition(partition);
  Set<Index<?,?,String>> indexedAttributes=new HashSet<Index<?,?,String>>();
  indexedAttributes.add(new JdbmIndex<String,Entry>("objectClass",false));
  indexedAttributes.add(new JdbmIndex<String,Entry>("dc",false));
  indexedAttributes.add(new JdbmIndex<String,Entry>("ou",false));
  partition.setIndexedAttributes(indexedAttributes);
  ds.setInstanceId(conf.getProperty(INSTANCE));
  ds.startup();
  Dn dn=new Dn("dc=" + orgName + ",dc="+ orgDomain);
  Entry entry=ds.newEntry(dn);
  entry.add("objectClass","top","domain");
  entry.add("dc",orgName);
  ds.getAdminSession().add(entry);
}
