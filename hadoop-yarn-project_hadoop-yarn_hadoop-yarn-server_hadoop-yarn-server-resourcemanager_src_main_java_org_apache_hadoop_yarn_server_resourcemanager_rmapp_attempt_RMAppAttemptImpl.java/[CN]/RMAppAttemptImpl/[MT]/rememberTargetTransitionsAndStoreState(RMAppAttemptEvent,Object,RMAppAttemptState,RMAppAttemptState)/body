{
  rememberTargetTransitions(event,transitionToDo,targetFinalState);
  stateBeforeFinalSaving=getState();
  String diags=null;
  String finalTrackingUrl=null;
  FinalApplicationStatus finalStatus=null;
  int exitStatus=ContainerExitStatus.INVALID;
switch (event.getType()) {
case LAUNCH_FAILED:
    RMAppAttemptLaunchFailedEvent launchFaileEvent=(RMAppAttemptLaunchFailedEvent)event;
  diags=launchFaileEvent.getMessage();
break;
case REGISTERED:
diags=getUnexpectedAMRegisteredDiagnostics();
break;
case UNREGISTERED:
RMAppAttemptUnregistrationEvent unregisterEvent=(RMAppAttemptUnregistrationEvent)event;
diags=unregisterEvent.getDiagnostics();
finalTrackingUrl=sanitizeTrackingUrl(unregisterEvent.getFinalTrackingUrl());
finalStatus=unregisterEvent.getFinalApplicationStatus();
break;
case CONTAINER_FINISHED:
RMAppAttemptContainerFinishedEvent finishEvent=(RMAppAttemptContainerFinishedEvent)event;
diags=getAMContainerCrashedDiagnostics(finishEvent);
exitStatus=finishEvent.getContainerStatus().getExitStatus();
break;
case KILL:
break;
case EXPIRE:
diags=getAMExpiredDiagnostics(event);
break;
default :
break;
}
AggregateAppResourceUsage resUsage=this.attemptMetrics.getAggregateAppResourceUsage();
RMStateStore rmStore=rmContext.getStateStore();
setFinishTime(System.currentTimeMillis());
ApplicationAttemptStateData attemptState=ApplicationAttemptStateData.newInstance(applicationAttemptId,getMasterContainer(),rmStore.getCredentialsFromAppAttempt(this),startTime,stateToBeStored,finalTrackingUrl,diags,finalStatus,exitStatus,getFinishTime(),resUsage.getMemorySeconds(),resUsage.getVcoreSeconds());
LOG.info("Updating application attempt " + applicationAttemptId + " with final state: "+ targetedFinalState+ ", and exit status: "+ exitStatus);
rmStore.updateApplicationAttemptState(attemptState);
}
