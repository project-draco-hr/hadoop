{
  ApplicationAttemptId appAttemptId=appAttempt.getAppAttemptId();
  appAttempt.masterService.unregisterAttempt(appAttemptId);
  ApplicationId applicationId=appAttemptId.getApplicationId();
  RMAppEvent appEvent=null;
switch (finalAttemptState) {
case FINISHED:
{
      appEvent=new RMAppFinishedAttemptEvent(applicationId,appAttempt.getDiagnostics());
    }
  break;
case KILLED:
{
  appAttempt.setTrackingUrlToRMAppPage();
  appEvent=new RMAppFailedAttemptEvent(applicationId,RMAppEventType.ATTEMPT_KILLED,"Application killed by user.");
}
break;
case FAILED:
{
appAttempt.setTrackingUrlToRMAppPage();
appEvent=new RMAppFailedAttemptEvent(applicationId,RMAppEventType.ATTEMPT_FAILED,appAttempt.getDiagnostics());
}
break;
default :
{
LOG.error("Cannot get this state!! Error!!");
}
break;
}
appAttempt.eventHandler.handle(appEvent);
appAttempt.eventHandler.handle(new AppRemovedSchedulerEvent(appAttemptId,finalAttemptState));
appAttempt.rmContext.getAMRMTokenSecretManager().applicationMasterFinished(appAttemptId);
}
