{
  HttpServer2 server=startHttpServer();
  MRApp app=spy(new MRAppWithCustomContainerAllocator(2,2,true,this.getClass().getName(),true,2,true));
  doNothing().when(app).sysexit();
  JobConf conf=new JobConf();
  conf.set(JobContext.MR_JOB_END_NOTIFICATION_URL,JobEndServlet.baseUrl + "jobend?jobid=$jobId&status=$jobStatus");
  JobImpl job=(JobImpl)app.submit(conf);
  app.waitForInternalState(job,JobStateInternal.SUCCEEDED);
  app.shutDownJob();
  Assert.assertTrue(app.isLastAMRetry());
  Assert.assertEquals(1,JobEndServlet.calledTimes);
  Assert.assertEquals("jobid=" + job.getID() + "&status=SUCCEEDED",JobEndServlet.requestUri.getQuery());
  Assert.assertEquals(JobState.SUCCEEDED.toString(),JobEndServlet.foundJobState);
  server.stop();
}
