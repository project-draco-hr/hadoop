{
  HttpServer2 server=startHttpServer();
  MRApp app=spy(new MRAppWithCustomContainerAllocator(2,2,false,this.getClass().getName(),true,2,false));
  doNothing().when(app).sysexit();
  JobConf conf=new JobConf();
  conf.set(JobContext.MR_JOB_END_NOTIFICATION_URL,JobEndServlet.baseUrl + "jobend?jobid=$jobId&status=$jobStatus");
  JobImpl job=(JobImpl)app.submit(conf);
  app.waitForState(job,JobState.RUNNING);
  app.getContext().getEventHandler().handle(new JobEvent(app.getJobId(),JobEventType.JOB_AM_REBOOT));
  app.waitForInternalState(job,JobStateInternal.REBOOT);
  app.shutDownJob();
  Assert.assertTrue(app.isLastAMRetry());
  Assert.assertEquals(1,JobEndServlet.calledTimes);
  Assert.assertEquals("jobid=" + job.getID() + "&status=FAILED",JobEndServlet.requestUri.getQuery());
  Assert.assertEquals(JobState.FAILED.toString(),JobEndServlet.foundJobState);
  server.stop();
}
