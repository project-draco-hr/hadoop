{
  HttpServer server=startHttpServer();
  MRApp app=spy(new MRApp(2,2,false,this.getClass().getName(),true));
  doNothing().when(app).sysexit();
  app.safeToReportTerminationToUser.set(false);
  Configuration conf=new Configuration();
  conf.set(JobContext.MR_JOB_END_NOTIFICATION_URL,JobEndServlet.baseUrl + "jobend?jobid=$jobId&status=$jobStatus");
  JobImpl job=(JobImpl)app.submit(new Configuration());
  app.waitForState(job,JobState.RUNNING);
  app.getContext().getEventHandler().handle(new JobEvent(app.getJobId(),JobEventType.JOB_AM_REBOOT));
  app.waitForInternalState(job,JobStateInternal.REBOOT);
  app.waitForState(job,JobState.RUNNING);
  app.shutDownJob();
  Assert.assertEquals(false,app.isLastAMRetry());
  Assert.assertEquals(0,JobEndServlet.calledTimes);
  Assert.assertEquals(null,JobEndServlet.requestUri);
  Assert.assertEquals(null,JobEndServlet.foundJobState);
  server.stop();
}
