{
  for (  LayoutFeature f : features) {
    final FeatureInfo info=f.getInfo();
    SortedSet<LayoutFeature> ancestorSet=map.get(info.getAncestorLayoutVersion());
    if (ancestorSet == null) {
      ancestorSet=new TreeSet<LayoutFeature>(new LayoutFeatureComparator());
      map.put(info.getAncestorLayoutVersion(),ancestorSet);
    }
    SortedSet<LayoutFeature> featureSet=new TreeSet<LayoutFeature>(ancestorSet);
    if (info.getSpecialFeatures() != null) {
      for (      LayoutFeature specialFeature : info.getSpecialFeatures()) {
        featureSet.add(specialFeature);
      }
    }
    featureSet.add(f);
    map.put(info.getLayoutVersion(),featureSet);
  }
}
