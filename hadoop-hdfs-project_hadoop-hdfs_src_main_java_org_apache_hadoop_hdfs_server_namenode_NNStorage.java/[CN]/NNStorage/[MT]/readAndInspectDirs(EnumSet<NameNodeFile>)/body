{
  Integer layoutVersion=null;
  boolean multipleLV=false;
  StringBuilder layoutVersions=new StringBuilder();
  for (Iterator<StorageDirectory> it=dirIterator(false); it.hasNext(); ) {
    StorageDirectory sd=it.next();
    if (!sd.getVersionFile().exists()) {
      FSImage.LOG.warn("Storage directory " + sd + " contains no VERSION file. Skipping...");
      continue;
    }
    readProperties(sd);
    int lv=getLayoutVersion();
    if (layoutVersion == null) {
      layoutVersion=Integer.valueOf(lv);
    }
 else     if (!layoutVersion.equals(lv)) {
      multipleLV=true;
    }
    layoutVersions.append("(").append(sd.getRoot()).append(", ").append(lv).append(") ");
  }
  if (layoutVersion == null) {
    throw new IOException("No storage directories contained VERSION information");
  }
  if (multipleLV) {
    throw new IOException("Storage directories contain multiple layout versions: " + layoutVersions);
  }
  FSImageStorageInspector inspector;
  if (NameNodeLayoutVersion.supports(LayoutVersion.Feature.TXID_BASED_LAYOUT,getLayoutVersion())) {
    inspector=new FSImageTransactionalStorageInspector(fileTypes);
  }
 else {
    inspector=new FSImagePreTransactionalStorageInspector();
  }
  inspectStorageDirs(inspector);
  return inspector;
}
