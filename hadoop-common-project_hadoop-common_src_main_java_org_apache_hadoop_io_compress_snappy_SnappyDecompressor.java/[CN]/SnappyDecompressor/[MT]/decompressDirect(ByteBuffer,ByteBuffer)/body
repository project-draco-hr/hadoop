{
  assert(this instanceof SnappyDirectDecompressor);
  ByteBuffer presliced=dst;
  if (dst.position() > 0) {
    presliced=dst;
    dst=dst.slice();
  }
  Buffer originalCompressed=compressedDirectBuf;
  Buffer originalUncompressed=uncompressedDirectBuf;
  int originalBufferSize=directBufferSize;
  compressedDirectBuf=src.slice();
  compressedDirectBufLen=src.remaining();
  uncompressedDirectBuf=dst;
  directBufferSize=dst.remaining();
  int n=0;
  try {
    n=decompressBytesDirect();
    presliced.position(presliced.position() + n);
    src.position(src.limit());
    finished=true;
  }
  finally {
    compressedDirectBuf=originalCompressed;
    uncompressedDirectBuf=originalUncompressed;
    compressedDirectBufLen=0;
    directBufferSize=originalBufferSize;
  }
  return n;
}
