{
  BlockReader reader=null;
  Preconditions.checkNotNull(configuration);
  final ShortCircuitConf scConf=conf.getShortCircuitConf();
  if (scConf.isShortCircuitLocalReads() && allowShortCircuitLocalReads) {
    if (clientContext.getUseLegacyBlockReaderLocal()) {
      reader=getLegacyBlockReaderLocal();
      if (reader != null) {
        if (LOG.isTraceEnabled()) {
          LOG.trace(this + ": returning new legacy block reader local.");
        }
        return reader;
      }
    }
 else {
      reader=getBlockReaderLocal();
      if (reader != null) {
        if (LOG.isTraceEnabled()) {
          LOG.trace(this + ": returning new block reader local.");
        }
        return reader;
      }
    }
  }
  if (scConf.isDomainSocketDataTraffic()) {
    reader=getRemoteBlockReaderFromDomain();
    if (reader != null) {
      if (LOG.isTraceEnabled()) {
        LOG.trace(this + ": returning new remote block reader using " + "UNIX domain socket on "+ pathInfo.getPath());
      }
      return reader;
    }
  }
  Preconditions.checkState(!DFSInputStream.tcpReadsDisabledForTesting,"TCP reads were disabled for testing, but we failed to " + "do a non-TCP read.");
  return getRemoteBlockReaderFromTcp();
}
