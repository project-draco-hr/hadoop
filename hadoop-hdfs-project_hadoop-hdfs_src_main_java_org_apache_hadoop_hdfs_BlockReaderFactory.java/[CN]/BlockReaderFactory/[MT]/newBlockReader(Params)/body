{
  if (params.getConf().useLegacyBlockReader) {
    if (params.getEncryptionKey() != null) {
      throw new RuntimeException("Encryption is not supported with the legacy block reader.");
    }
    return RemoteBlockReader.newBlockReader(params);
  }
 else {
    Socket sock=params.getSocket();
    if (params.getIoStreamPair() == null) {
      params.setIoStreamPair(new IOStreamPair(NetUtils.getInputStream(sock),NetUtils.getOutputStream(sock,HdfsServerConstants.WRITE_TIMEOUT)));
      if (params.getEncryptionKey() != null) {
        IOStreamPair encryptedStreams=DataTransferEncryptor.getEncryptedStreams(params.getIoStreamPair().out,params.getIoStreamPair().in,params.getEncryptionKey());
        params.setIoStreamPair(encryptedStreams);
      }
    }
    return RemoteBlockReader2.newBlockReader(params);
  }
}
