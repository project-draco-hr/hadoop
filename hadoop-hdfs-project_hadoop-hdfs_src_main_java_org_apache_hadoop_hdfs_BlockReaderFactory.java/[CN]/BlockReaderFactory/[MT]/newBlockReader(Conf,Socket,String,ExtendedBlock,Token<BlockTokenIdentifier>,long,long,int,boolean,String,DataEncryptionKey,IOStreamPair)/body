{
  if (conf.useLegacyBlockReader) {
    if (encryptionKey != null) {
      throw new RuntimeException("Encryption is not supported with the legacy block reader.");
    }
    return RemoteBlockReader.newBlockReader(sock,file,block,blockToken,startOffset,len,bufferSize,verifyChecksum,clientName);
  }
 else {
    if (ioStreams == null) {
      ioStreams=new IOStreamPair(NetUtils.getInputStream(sock),NetUtils.getOutputStream(sock,HdfsServerConstants.WRITE_TIMEOUT));
      if (encryptionKey != null) {
        IOStreamPair encryptedStreams=DataTransferEncryptor.getEncryptedStreams(ioStreams.out,ioStreams.in,encryptionKey);
        ioStreams=encryptedStreams;
      }
    }
    return RemoteBlockReader2.newBlockReader(sock,file,block,blockToken,startOffset,len,bufferSize,verifyChecksum,clientName,encryptionKey,ioStreams);
  }
}
