{
  Configuration conf=new Configuration();
  FSImage image=new FSImage(conf);
  final DatanodeStorageInfo[] targets={};
  FSNamesystem namesystem=new FSNamesystem(conf,image);
  FSNamesystem namesystemSpy=spy(namesystem);
  BlockInfoUnderConstruction blockInfo=new BlockInfoUnderConstruction(block,1,HdfsServerConstants.BlockUCState.UNDER_CONSTRUCTION,targets);
  blockInfo.setBlockCollection(file);
  blockInfo.setGenerationStamp(genStamp);
  blockInfo.initializeBlockRecovery(genStamp);
  doReturn(true).when(file).removeLastBlock(any(Block.class));
  doReturn(blockInfo).when(namesystemSpy).getStoredBlock(any(Block.class));
  doReturn("").when(namesystemSpy).closeFileCommitBlocks(any(INodeFileUnderConstruction.class),any(BlockInfo.class));
  doReturn("").when(namesystemSpy).persistBlocks(any(INodeFileUnderConstruction.class),anyBoolean());
  doReturn(mock(FSEditLog.class)).when(namesystemSpy).getEditLog();
  return namesystemSpy;
}
