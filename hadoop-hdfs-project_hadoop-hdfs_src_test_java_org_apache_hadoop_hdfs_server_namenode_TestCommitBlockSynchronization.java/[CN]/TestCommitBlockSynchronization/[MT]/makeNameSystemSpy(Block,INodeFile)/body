{
  Configuration conf=new Configuration();
  FSImage image=new FSImage(conf);
  final DatanodeStorageInfo[] targets={};
  FSNamesystem namesystem=new FSNamesystem(conf,image);
  namesystem.setImageLoaded(true);
  if (file.getParent() == null) {
    INodeDirectory parent=mock(INodeDirectory.class);
    parent.setLocalName(new byte[0]);
    parent.addChild(file);
    file.setParent(parent);
  }
  namesystem.dir.getINodeMap().put(file);
  FSNamesystem namesystemSpy=spy(namesystem);
  BlockInfoUnderConstruction blockInfo=new BlockInfoUnderConstruction(block,(short)1,HdfsServerConstants.BlockUCState.UNDER_CONSTRUCTION,targets);
  blockInfo.setBlockCollection(file);
  blockInfo.setGenerationStamp(genStamp);
  blockInfo.initializeBlockRecovery(genStamp);
  doReturn(true).when(file).removeLastBlock(any(Block.class));
  doReturn(true).when(file).isUnderConstruction();
  doReturn(blockInfo).when(namesystemSpy).getStoredBlock(any(Block.class));
  doReturn(blockInfo).when(file).getLastBlock();
  doReturn("").when(namesystemSpy).closeFileCommitBlocks(any(INodeFile.class),any(BlockInfo.class));
  doReturn(mock(FSEditLog.class)).when(namesystemSpy).getEditLog();
  return namesystemSpy;
}
