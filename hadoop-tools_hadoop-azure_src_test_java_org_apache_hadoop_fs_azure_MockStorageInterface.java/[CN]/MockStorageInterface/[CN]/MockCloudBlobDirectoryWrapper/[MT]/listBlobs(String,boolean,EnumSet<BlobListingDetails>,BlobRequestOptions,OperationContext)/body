{
  ArrayList<ListBlobItem> ret=new ArrayList<ListBlobItem>();
  String fullPrefix=prefix == null ? uri.toString() : new URI(uri.getScheme(),uri.getAuthority(),uri.getPath() + prefix,uri.getQuery(),uri.getFragment()).toString();
  boolean includeMetadata=listingDetails.contains(BlobListingDetails.METADATA);
  HashSet<String> addedDirectories=new HashSet<String>();
  for (  InMemoryBlockBlobStore.ListBlobEntry current : backingStore.listBlobs(fullPrefix,includeMetadata)) {
    int indexOfSlash=current.getKey().indexOf('/',fullPrefix.length());
    if (useFlatBlobListing || indexOfSlash < 0) {
      ret.add(new MockCloudBlockBlobWrapper(new URI(current.getKey()),current.getMetadata(),current.getContentLength()));
    }
 else {
      String directoryName=current.getKey().substring(0,indexOfSlash);
      if (!addedDirectories.contains(directoryName)) {
        addedDirectories.add(current.getKey());
        ret.add(new MockCloudBlobDirectoryWrapper(new URI(directoryName + "/")));
      }
    }
  }
  return ret;
}
