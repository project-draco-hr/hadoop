{
  Socket sock=null;
  try {
    if (testDescription != null) {
      LOG.info("Testing : " + testDescription);
    }
    LOG.info("Going to write:" + StringUtils.byteToHexString(sendBuf.toByteArray()));
    sock=new Socket();
    sock.connect(dnAddr,HdfsServerConstants.READ_TIMEOUT);
    sock.setSoTimeout(HdfsServerConstants.READ_TIMEOUT);
    OutputStream out=sock.getOutputStream();
    byte[] retBuf=new byte[recvBuf.size()];
    DataInputStream in=new DataInputStream(sock.getInputStream());
    out.write(sendBuf.toByteArray());
    out.flush();
    try {
      in.readFully(retBuf);
    }
 catch (    EOFException eof) {
      if (eofExpected) {
        LOG.info("Got EOF as expected.");
        return;
      }
      throw eof;
    }
    LOG.info("Received: " + new String(retBuf));
    LOG.info("Expected: " + StringUtils.byteToHexString(recvBuf.toByteArray()));
    if (eofExpected) {
      throw new IOException("Did not recieve IOException when an exception " + "is expected while reading from " + datanode.getName());
    }
    byte[] needed=recvBuf.toByteArray();
    assertEquals(StringUtils.byteToHexString(needed),StringUtils.byteToHexString(retBuf));
  }
  finally {
    IOUtils.closeSocket(sock);
  }
}
