{
  Configuration conf=new Configuration();
  TestTokenSecretManager sm=null;
  if (secure) {
    makeSecure(conf);
    sm=new TestTokenSecretManager();
  }
  UserGroupInformation.setConfiguration(conf);
  RPC.setProtocolEngine(conf,AvroSpecificTestProtocol.class,AvroSpecificRpcEngine.class);
  Server server=RPC.getServer(AvroSpecificTestProtocol.class,new AvroSpecificTestProtocolImpl(),ADDRESS,0,5,true,conf,sm);
  try {
    server.start();
    InetSocketAddress addr=NetUtils.getConnectAddress(server);
    if (secure) {
      addToken(sm,addr);
      Assert.assertEquals("auth",SaslRpcServer.SASL_PROPS.get(Sasl.QOP));
    }
    AvroSpecificTestProtocol proxy=(AvroSpecificTestProtocol)RPC.getProxy(AvroSpecificTestProtocol.class,0,addr,conf);
    Utf8 echo=proxy.echo(new Utf8("hello world"));
    assertEquals("hello world",echo.toString());
    int intResult=proxy.add(1,2);
    assertEquals(3,intResult);
  }
  finally {
    resetSecurity();
    server.stop();
  }
}
