{
  Container container=getContainer(reservedContainer,node,allocationResult.getResourceToBeAllocated(),priority);
  if (container == null) {
    LOG.warn("Couldn't get container for allocation!");
    return ContainerAllocation.QUEUE_SKIPPED;
  }
  if (allocationResult.getAllocationState() == AllocationState.ALLOCATED) {
    allocationResult=handleNewContainerAllocation(allocationResult,node,priority,reservedContainer,container);
  }
 else {
    application.reserve(priority,node,reservedContainer,container);
  }
  allocationResult.updatedContainer=container;
  if (reservedContainer == null) {
    if (allocationResult.containerNodeType != NodeType.OFF_SWITCH) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Resetting scheduling opportunities");
      }
      application.resetSchedulingOpportunities(priority);
    }
    application.resetMissedNonPartitionedRequestSchedulingOpportunity(priority);
  }
  return allocationResult;
}
