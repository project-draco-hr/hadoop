{
  Configuration conf=new Configuration();
  MiniDFSCluster cluster=null;
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(2).build();
    String nnUri=FileSystem.getDefaultUri(conf).toString();
    FileSystem fs=FileSystem.get(URI.create(nnUri),conf);
{
      MyFile[] files=createFiles(URI.create(nnUri),"/srcdat");
      FileStatus[] srcstat=getFileStatus(fs,"/srcdat",files);
      for (int i=0; i < srcstat.length; i++) {
        fs.setOwner(srcstat[i].getPath(),"u" + i,null);
      }
      ToolRunner.run(new DistCpV1(conf),new String[]{"-pu",nnUri + "/srcdat",nnUri + "/destdat"});
      assertTrue("Source and destination directories do not match.",checkFiles(fs,"/destdat",files));
      FileStatus[] dststat=getFileStatus(fs,"/destdat",files);
      for (int i=0; i < dststat.length; i++) {
        assertEquals("i=" + i,"u" + i,dststat[i].getOwner());
      }
      deldir(fs,"/destdat");
      deldir(fs,"/srcdat");
    }
{
      MyFile[] files=createFiles(URI.create(nnUri),"/srcdat");
      FileStatus[] srcstat=getFileStatus(fs,"/srcdat",files);
      for (int i=0; i < srcstat.length; i++) {
        fs.setOwner(srcstat[i].getPath(),null,"g" + i);
      }
      ToolRunner.run(new DistCpV1(conf),new String[]{"-pg",nnUri + "/srcdat",nnUri + "/destdat"});
      assertTrue("Source and destination directories do not match.",checkFiles(fs,"/destdat",files));
      FileStatus[] dststat=getFileStatus(fs,"/destdat",files);
      for (int i=0; i < dststat.length; i++) {
        assertEquals("i=" + i,"g" + i,dststat[i].getGroup());
      }
      deldir(fs,"/destdat");
      deldir(fs,"/srcdat");
    }
{
      MyFile[] files=createFiles(URI.create(nnUri),"/srcdat");
      FileStatus[] srcstat=getFileStatus(fs,"/srcdat",files);
      FsPermission[] permissions=new FsPermission[srcstat.length];
      for (int i=0; i < srcstat.length; i++) {
        permissions[i]=new FsPermission((short)(i & 0666));
        fs.setPermission(srcstat[i].getPath(),permissions[i]);
      }
      ToolRunner.run(new DistCpV1(conf),new String[]{"-pp",nnUri + "/srcdat",nnUri + "/destdat"});
      assertTrue("Source and destination directories do not match.",checkFiles(fs,"/destdat",files));
      FileStatus[] dststat=getFileStatus(fs,"/destdat",files);
      for (int i=0; i < dststat.length; i++) {
        assertEquals("i=" + i,permissions[i],dststat[i].getPermission());
      }
      deldir(fs,"/destdat");
      deldir(fs,"/srcdat");
    }
{
      MyFile[] files=createFiles(URI.create(nnUri),"/srcdat");
      fs.mkdirs(new Path("/srcdat/tmpf1"));
      fs.mkdirs(new Path("/srcdat/tmpf2"));
      FileStatus[] srcstat=getFileStatus(fs,"/srcdat",files);
      FsPermission[] permissions=new FsPermission[srcstat.length];
      for (int i=0; i < srcstat.length; i++) {
        fs.setTimes(srcstat[i].getPath(),40,50);
      }
      ToolRunner.run(new DistCpV1(conf),new String[]{"-pt",nnUri + "/srcdat",nnUri + "/destdat"});
      FileStatus[] dststat=getFileStatus(fs,"/destdat",files);
      for (int i=0; i < dststat.length; i++) {
        assertEquals("Modif. Time i=" + i,40,dststat[i].getModificationTime());
        assertEquals("Access Time i=" + i + srcstat[i].getPath()+ "-"+ dststat[i].getPath(),50,dststat[i].getAccessTime());
      }
      assertTrue("Source and destination directories do not match.",checkFiles(fs,"/destdat",files));
      deldir(fs,"/destdat");
      deldir(fs,"/srcdat");
    }
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
