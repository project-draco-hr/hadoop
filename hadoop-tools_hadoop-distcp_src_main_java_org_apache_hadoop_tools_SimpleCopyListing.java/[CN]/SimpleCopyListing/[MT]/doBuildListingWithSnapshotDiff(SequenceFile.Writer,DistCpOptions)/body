{
  ArrayList<DiffInfo> diffList=distCpSync.prepareDiffList();
  Path sourceRoot=options.getSourcePaths().get(0);
  FileSystem sourceFS=sourceRoot.getFileSystem(getConf());
  try {
    for (    DiffInfo diff : diffList) {
      diff.target=new Path(options.getSourcePaths().get(0),diff.target);
      if (diff.getType() == SnapshotDiffReport.DiffType.MODIFY) {
        addToFileListing(fileListWriter,sourceRoot,diff.target,options);
      }
 else       if (diff.getType() == SnapshotDiffReport.DiffType.CREATE) {
        addToFileListing(fileListWriter,sourceRoot,diff.target,options);
        FileStatus sourceStatus=sourceFS.getFileStatus(diff.target);
        if (sourceStatus.isDirectory()) {
          if (LOG.isDebugEnabled()) {
            LOG.debug("Adding source dir for traverse: " + sourceStatus.getPath());
          }
          HashSet<String> excludeList=distCpSync.getTraverseExcludeList(diff.source,options.getSourcePaths().get(0));
          ArrayList<FileStatus> sourceDirs=new ArrayList<>();
          sourceDirs.add(sourceStatus);
          traverseDirectory(fileListWriter,sourceFS,sourceDirs,sourceRoot,options,excludeList);
        }
      }
    }
    fileListWriter.close();
    fileListWriter=null;
  }
  finally {
    IOUtils.cleanup(LOG,fileListWriter);
  }
}
