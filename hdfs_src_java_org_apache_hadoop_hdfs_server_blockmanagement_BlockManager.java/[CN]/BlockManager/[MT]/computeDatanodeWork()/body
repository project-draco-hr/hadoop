{
  int workFound=0;
  int blocksToProcess=0;
  int nodesToProcess=0;
  if (namesystem.isInSafeMode())   return workFound;
synchronized (namesystem.heartbeats) {
    blocksToProcess=(int)(namesystem.heartbeats.size() * ReplicationMonitor.REPLICATION_WORK_MULTIPLIER_PER_ITERATION);
    nodesToProcess=(int)Math.ceil((double)namesystem.heartbeats.size() * ReplicationMonitor.INVALIDATE_WORK_PCT_PER_ITERATION / 100);
  }
  workFound=this.computeReplicationWork(blocksToProcess);
  namesystem.writeLock();
  try {
    this.updateState();
    this.scheduledReplicationBlocksCount=workFound;
  }
  finally {
    namesystem.writeUnlock();
  }
  workFound+=this.computeInvalidateWork(nodesToProcess);
  return workFound;
}
