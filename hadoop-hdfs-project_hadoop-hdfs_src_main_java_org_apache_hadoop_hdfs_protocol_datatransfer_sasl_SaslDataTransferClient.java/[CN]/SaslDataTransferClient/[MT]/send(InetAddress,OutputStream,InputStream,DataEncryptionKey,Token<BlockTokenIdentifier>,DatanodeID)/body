{
  if (encryptionKey != null) {
    LOG.debug("SASL client doing encrypted handshake for addr = {}, datanodeId = {}",addr,datanodeId);
    return getEncryptedStreams(underlyingOut,underlyingIn,encryptionKey);
  }
 else   if (!UserGroupInformation.isSecurityEnabled()) {
    LOG.debug("SASL client skipping handshake in unsecured configuration for " + "addr = {}, datanodeId = {}",addr,datanodeId);
    return null;
  }
 else   if (datanodeId.getXferPort() < 1024) {
    LOG.debug("SASL client skipping handshake in secured configuration with " + "privileged port for addr = {}, datanodeId = {}",addr,datanodeId);
    return null;
  }
 else   if (accessToken.getIdentifier().length == 0) {
    if (!fallbackToSimpleAuthAllowed) {
      throw new IOException("No block access token was provided (insecure cluster), but this " + "client is configured to allow only secure connections.");
    }
    LOG.debug("SASL client skipping handshake in secured configuration with " + "unsecured cluster for addr = {}, datanodeId = {}",addr,datanodeId);
    return null;
  }
 else {
    LOG.debug("SASL client doing general handshake for addr = {}, datanodeId = {}",addr,datanodeId);
    return getSaslStreams(addr,underlyingOut,underlyingIn,accessToken,datanodeId);
  }
}
