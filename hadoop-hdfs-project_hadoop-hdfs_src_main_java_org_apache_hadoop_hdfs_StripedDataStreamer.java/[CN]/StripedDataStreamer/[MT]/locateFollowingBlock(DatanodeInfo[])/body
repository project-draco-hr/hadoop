{
  return new ConcurrentPoll<LocatedBlock>(coordinator.getFollowingBlocks()){
    @Override boolean isReady2Populate(){
      return super.isReady2Populate() && (block == null || coordinator.hasAllEndBlocks());
    }
    @Override void populate() throws IOException {
      getLastException().check(false);
      if (block != null) {
        long bytes=0;
        for (int i=0; i < schema.getNumDataUnits(); i++) {
          final ExtendedBlock b=coordinator.takeEndBlock(i);
          StripedBlockUtil.checkBlocks(index,block,i,b);
          bytes+=b.getNumBytes();
        }
        block.setNumBytes(bytes);
        block.setBlockId(block.getBlockId() - index);
      }
      if (LOG.isDebugEnabled()) {
        LOG.debug("locateFollowingBlock: index=" + index + ", block="+ block);
      }
      final LocatedBlock lb=StripedDataStreamer.super.locateFollowingBlock(excludedNodes);
      if (lb.getLocations().length < schema.getNumDataUnits()) {
        throw new IOException("Failed to get datablocks number of nodes from namenode: blockGroupSize= " + (schema.getNumDataUnits() + schema.getNumParityUnits()) + ", blocks.length= "+ lb.getLocations().length);
      }
      final LocatedBlock[] blocks=StripedBlockUtil.parseStripedBlockGroup((LocatedStripedBlock)lb,cellSize,schema.getNumDataUnits(),schema.getNumParityUnits());
      for (int i=0; i < blocks.length; i++) {
        StripedDataStreamer si=coordinator.getStripedDataStreamer(i);
        if (si.isFailed()) {
          continue;
        }
        if (blocks[i] == null) {
          LOG.warn("Failed to get block location for parity block, index=" + i);
          si.getLastException().set(new IOException("Failed to get following block, i=" + i));
          si.setFailed(true);
          si.endBlock();
          si.close(true);
        }
 else {
          queue.offer(i,blocks[i]);
        }
      }
    }
  }
.poll(index);
}
