{
  String home=System.getProperty("hadoop.home.dir");
  if (home == null) {
    home=System.getenv("HADOOP_HOME");
  }
  try {
    if (home == null) {
      throw new IOException("HADOOP_HOME or hadoop.home.dir are not set.");
    }
    if (home.startsWith("\"") && home.endsWith("\"")) {
      home=home.substring(1,home.length() - 1);
    }
    File homedir=new File(home);
    if (!homedir.isAbsolute() || !homedir.exists() || !homedir.isDirectory()) {
      throw new IOException("Hadoop home directory " + homedir + " does not exist, is not a directory, or is not an absolute path.");
    }
    home=homedir.getCanonicalPath();
  }
 catch (  IOException ioe) {
    LOG.error("Failed to detect a valid hadoop home directory",ioe);
    home=null;
  }
  return home;
}
