{
  Path applicationTokensFile=new Path(jobSubmitDir,MRConstants.APPLICATION_TOKENS_FILE);
  try {
    ts.writeTokenStorageFile(applicationTokensFile,conf);
  }
 catch (  IOException e) {
    throw new YarnException(e);
  }
  ApplicationSubmissionContext appContext=createApplicationSubmissionContext(conf,jobSubmitDir,ts);
  ApplicationId applicationId=resMgrDelegate.submitApplication(appContext);
  ApplicationReport appMaster=resMgrDelegate.getApplicationReport(applicationId);
  String diagnostics=(appMaster == null ? "application report is null" : appMaster.getDiagnostics());
  if (appMaster == null || appMaster.getState() == ApplicationState.FAILED || appMaster.getState() == ApplicationState.KILLED) {
    throw new IOException("Failed to run job : " + diagnostics);
  }
  return clientCache.getClient(jobId).getJobStatus(jobId);
}
