{
  addHistoyToken(ts);
  Path applicationTokensFile=new Path(jobSubmitDir,MRJobConfig.APPLICATION_TOKENS_FILE);
  try {
    ts.writeTokenStorageFile(applicationTokensFile,conf);
  }
 catch (  IOException e) {
    throw new YarnRuntimeException(e);
  }
  ApplicationSubmissionContext appContext=createApplicationSubmissionContext(conf,jobSubmitDir,ts);
  try {
    ApplicationId applicationId=resMgrDelegate.submitApplication(appContext);
    ApplicationReport appMaster=resMgrDelegate.getApplicationReport(applicationId);
    String diagnostics=(appMaster == null ? "application report is null" : appMaster.getDiagnostics());
    if (appMaster == null || appMaster.getYarnApplicationState() == YarnApplicationState.FAILED || appMaster.getYarnApplicationState() == YarnApplicationState.KILLED) {
      throw new IOException("Failed to run job : " + diagnostics);
    }
    return clientCache.getClient(jobId).getJobStatus(jobId);
  }
 catch (  YarnException e) {
    throw new IOException(e);
  }
}
