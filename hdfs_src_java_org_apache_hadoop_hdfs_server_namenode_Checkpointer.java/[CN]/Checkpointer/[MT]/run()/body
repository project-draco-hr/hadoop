{
  long periodMSec=5 * 60;
  if (checkpointPeriod < periodMSec) {
    periodMSec=checkpointPeriod;
  }
  periodMSec*=1000;
  long lastCheckpointTime=0;
  if (!backupNode.shouldCheckpointAtStartup()) {
    lastCheckpointTime=now();
  }
  while (shouldRun) {
    try {
      long now=now();
      boolean shouldCheckpoint=false;
      if (now >= lastCheckpointTime + periodMSec) {
        shouldCheckpoint=true;
      }
 else {
        long txns=countUncheckpointedTxns();
        if (txns >= checkpointTxnCount)         shouldCheckpoint=true;
      }
      if (shouldCheckpoint) {
        doCheckpoint();
        lastCheckpointTime=now;
      }
    }
 catch (    IOException e) {
      LOG.error("Exception in doCheckpoint: ",e);
    }
catch (    Throwable e) {
      LOG.error("Throwable Exception in doCheckpoint: ",e);
      shutdown();
      break;
    }
    try {
      Thread.sleep(periodMSec);
    }
 catch (    InterruptedException ie) {
    }
  }
}
