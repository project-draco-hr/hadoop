{
  assumeTrue(!System.getProperty("os.name").startsWith("Windows"));
  final DatanodeManager dm=cluster.getNamesystem().getBlockManager().getDatanodeManager();
  long origCapacity=DFSTestUtil.getLiveDatanodeCapacity(dm);
  File dir=new File(cluster.getInstanceStorageDir(0,0),"current");
  try {
    prepareDirToFail(dir);
    restartDatanodes(1,false);
    assertEquals(true,cluster.getDataNodes().get(0).isBPServiceAlive(cluster.getNamesystem().getBlockPoolId()));
    DFSTestUtil.waitForDatanodeStatus(dm,1,0,1,origCapacity / 2,WAIT_FOR_HEARTBEATS);
  }
  finally {
    FileUtil.chmod(dir.toString(),"755");
  }
}
