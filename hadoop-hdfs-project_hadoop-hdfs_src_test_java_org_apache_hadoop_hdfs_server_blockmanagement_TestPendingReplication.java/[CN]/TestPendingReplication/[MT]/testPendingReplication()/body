{
  PendingReplicationBlocks pendingReplications;
  pendingReplications=new PendingReplicationBlocks(TIMEOUT * 1000);
  pendingReplications.start();
  DatanodeStorageInfo[] storages=DFSTestUtil.createDatanodeStorageInfos(10);
  for (int i=0; i < storages.length; i++) {
    BlockInfo block=genBlockInfo(i,i,0);
    DatanodeStorageInfo[] targets=new DatanodeStorageInfo[i];
    System.arraycopy(storages,0,targets,0,i);
    pendingReplications.increment(block,DatanodeStorageInfo.toDatanodeDescriptors(targets));
  }
  assertEquals("Size of pendingReplications ",10,pendingReplications.size());
  BlockInfo blk=genBlockInfo(8,8,0);
  pendingReplications.decrement(blk,storages[7].getDatanodeDescriptor());
  assertEquals("pendingReplications.getNumReplicas ",7,pendingReplications.getNumReplicas(blk));
  pendingReplications.increment(blk,storages[0].getDatanodeDescriptor());
  assertEquals("pendingReplications.getNumReplicas ",7,pendingReplications.getNumReplicas(blk));
  for (int i=0; i < 7; i++) {
    pendingReplications.decrement(blk,storages[i].getDatanodeDescriptor());
  }
  assertTrue(pendingReplications.size() == 9);
  pendingReplications.increment(blk,DatanodeStorageInfo.toDatanodeDescriptors(DFSTestUtil.createDatanodeStorageInfos(8)));
  assertTrue(pendingReplications.size() == 10);
  for (int i=0; i < 10; i++) {
    BlockInfo block=genBlockInfo(i,i,0);
    int numReplicas=pendingReplications.getNumReplicas(block);
    assertTrue(numReplicas == i);
  }
  assertTrue(pendingReplications.getTimedOutBlocks() == null);
  try {
    Thread.sleep(1000);
  }
 catch (  Exception e) {
  }
  for (int i=10; i < 15; i++) {
    BlockInfo block=genBlockInfo(i,i,0);
    pendingReplications.increment(block,DatanodeStorageInfo.toDatanodeDescriptors(DFSTestUtil.createDatanodeStorageInfos(i)));
  }
  assertTrue(pendingReplications.size() == 15);
  int loop=0;
  while (pendingReplications.size() > 0) {
    try {
      Thread.sleep(1000);
    }
 catch (    Exception e) {
    }
    loop++;
  }
  System.out.println("Had to wait for " + loop + " seconds for the lot to timeout");
  assertEquals("Size of pendingReplications ",0,pendingReplications.size());
  Block[] timedOut=pendingReplications.getTimedOutBlocks();
  assertTrue(timedOut != null && timedOut.length == 15);
  for (int i=0; i < timedOut.length; i++) {
    assertTrue(timedOut[i].getBlockId() < 15);
  }
  pendingReplications.stop();
}
