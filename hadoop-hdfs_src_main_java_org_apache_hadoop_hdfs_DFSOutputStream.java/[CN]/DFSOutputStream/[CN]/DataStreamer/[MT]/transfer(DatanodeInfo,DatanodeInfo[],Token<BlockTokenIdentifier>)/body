{
  Socket sock=null;
  DataOutputStream out=null;
  DataInputStream in=null;
  try {
    sock=createSocketForPipeline(src,2,dfsClient);
    final long writeTimeout=dfsClient.getDatanodeWriteTimeout(2);
    out=new DataOutputStream(new BufferedOutputStream(NetUtils.getOutputStream(sock,writeTimeout),FSConstants.SMALL_BUFFER_SIZE));
    new Sender(out).transferBlock(block,blockToken,dfsClient.clientName,targets);
    in=new DataInputStream(NetUtils.getInputStream(sock));
    BlockOpResponseProto response=BlockOpResponseProto.parseFrom(HdfsProtoUtil.vintPrefixed(in));
    if (SUCCESS != response.getStatus()) {
      throw new IOException("Failed to add a datanode");
    }
  }
  finally {
    IOUtils.closeStream(in);
    IOUtils.closeStream(out);
    IOUtils.closeSocket(sock);
  }
}
