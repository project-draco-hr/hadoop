{
  for (Iterator<Task> i=tasks.iterator(); i.hasNext(); ) {
    final Task task=i.next();
    final BalancerDatanode target=task.target.getBalancerDatanode();
    PendingMove pendingBlock=new PendingMove();
    if (target.addPendingBlock(pendingBlock)) {
      pendingBlock.source=this;
      pendingBlock.target=task.target;
      if (pendingBlock.chooseBlockAndProxy()) {
        long blockSize=pendingBlock.block.getNumBytes();
        incScheduledSize(-blockSize);
        task.size-=blockSize;
        if (task.size == 0) {
          i.remove();
        }
        return pendingBlock;
      }
 else {
        target.removePendingBlock(pendingBlock);
      }
    }
  }
  return null;
}
