{
  Configuration conf=new Configuration();
  conf.set(HADOOP_SECURITY_AUTHENTICATION,"kerberos");
  UserGroupInformation.setConfiguration(conf);
  BlockTokenSecretManager sm=new BlockTokenSecretManager(blockKeyUpdateInterval,blockTokenLifetime,0,1,"fake-pool",null);
  Token<BlockTokenIdentifier> token=sm.generateToken(block3,EnumSet.allOf(BlockTokenIdentifier.AccessMode.class));
  final Server server=createMockDatanode(sm,token,conf);
  server.start();
  final InetSocketAddress addr=NetUtils.getConnectAddress(server);
  final UserGroupInformation ticket=UserGroupInformation.createRemoteUser(block3.toString());
  ticket.addToken(token);
  ClientDatanodeProtocol proxy=null;
  try {
    proxy=DFSUtil.createClientDatanodeProtocolProxy(addr,ticket,conf,NetUtils.getDefaultSocketFactory(conf));
    assertEquals(block3.getBlockId(),proxy.getReplicaVisibleLength(block3));
  }
  finally {
    server.stop();
    if (proxy != null) {
      RPC.stopProxy(proxy);
    }
  }
}
