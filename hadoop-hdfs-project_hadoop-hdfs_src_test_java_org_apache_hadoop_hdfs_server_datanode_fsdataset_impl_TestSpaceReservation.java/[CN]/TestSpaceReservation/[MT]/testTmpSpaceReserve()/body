{
  final short replication=2;
  startCluster(BLOCK_SIZE,replication,-1);
  final int byteCount1=100;
  final int byteCount2=200;
  final String methodName=GenericTestUtils.getMethodName();
{
    final Path file=new Path("/" + methodName + ".01.dat");
    try (FSDataOutputStream os=fs.create(file,(short)1)){
      os.write(new byte[byteCount1]);
      os.hsync();
    }
     BlockLocation[] blockLocations=fs.getFileBlockLocations(file,0,10);
    String firstReplicaNode=blockLocations[0].getNames()[0];
    int newReplicaDNIndex=0;
    if (firstReplicaNode.equals(cluster.getDataNodes().get(0).getDisplayName())) {
      newReplicaDNIndex=1;
    }
    FsVolumeImpl fsVolumeImpl=(FsVolumeImpl)cluster.getDataNodes().get(newReplicaDNIndex).getFSDataset().getFsVolumeReferences().get(0);
    performReReplication(file,true);
    assertEquals("Wrong reserve space for Tmp ",byteCount1,fsVolumeImpl.getRecentReserved());
    assertEquals("Reserved Tmp space is not released",0,fsVolumeImpl.getReservedForReplicas());
  }
{
    final Path file=new Path("/" + methodName + ".01.dat");
    try (FSDataOutputStream os=fs.create(file,(short)1)){
      os.write(new byte[byteCount2]);
      os.hsync();
    }
     BlockLocation[] blockLocations=fs.getFileBlockLocations(file,0,10);
    String firstReplicaNode=blockLocations[0].getNames()[0];
    int newReplicaDNIndex=0;
    if (firstReplicaNode.equals(cluster.getDataNodes().get(0).getDisplayName())) {
      newReplicaDNIndex=1;
    }
    BlockPoolSlice blockPoolSlice=Mockito.mock(BlockPoolSlice.class);
    Mockito.when(blockPoolSlice.createTmpFile((Block)Mockito.any())).thenThrow(new IOException("Synthetic IO Exception Throgh MOCK"));
    final FsVolumeImpl fsVolumeImpl=(FsVolumeImpl)cluster.getDataNodes().get(newReplicaDNIndex).getFSDataset().getFsVolumeReferences().get(0);
    fsVolumeImpl.reserveSpaceForReplica(1000);
    Field field=FsVolumeImpl.class.getDeclaredField("bpSlices");
    field.setAccessible(true);
    @SuppressWarnings("unchecked") Map<String,BlockPoolSlice> bpSlices=(Map<String,BlockPoolSlice>)field.get(fsVolumeImpl);
    bpSlices.put(fsVolumeImpl.getBlockPoolList()[0],blockPoolSlice);
    performReReplication(file,false);
    assertEquals("Wrong reserve space for Tmp ",byteCount2,fsVolumeImpl.getRecentReserved());
    assertEquals("Tmp space is not released OR released twice",1000,fsVolumeImpl.getReservedForReplicas());
  }
}
