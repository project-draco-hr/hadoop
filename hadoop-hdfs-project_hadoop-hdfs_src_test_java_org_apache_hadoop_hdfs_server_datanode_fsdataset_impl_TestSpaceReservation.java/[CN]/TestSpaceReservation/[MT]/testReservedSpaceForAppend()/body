{
  final short replication=3;
  startCluster(BLOCK_SIZE,replication,-1);
  final String methodName=GenericTestUtils.getMethodName();
  final Path file=new Path("/" + methodName + ".01.dat");
  FSDataOutputStream os=fs.create(file,replication);
  os.write(new byte[1024]);
  os.close();
  final Path file2=new Path("/" + methodName + ".02.dat");
  FSDataOutputStream os2=fs.create(file2,replication);
  os2.write(new byte[1]);
  os2.hflush();
  int expectedFile2Reserved=BLOCK_SIZE - 1;
  checkReservedSpace(expectedFile2Reserved);
  os=fs.append(file);
  os.write(new byte[1]);
  os.hflush();
  int expectedFile1Reserved=BLOCK_SIZE - 1025;
  checkReservedSpace(expectedFile2Reserved + expectedFile1Reserved);
  os.close();
  checkReservedSpace(expectedFile2Reserved);
  os=fs.append(file);
  os.write(new byte[1]);
  os.hflush();
  expectedFile1Reserved--;
  checkReservedSpace(expectedFile2Reserved + expectedFile1Reserved);
  DFSTestUtil.abortStream(((DFSOutputStream)os.getWrappedStream()));
  checkReservedSpace(expectedFile2Reserved);
}
