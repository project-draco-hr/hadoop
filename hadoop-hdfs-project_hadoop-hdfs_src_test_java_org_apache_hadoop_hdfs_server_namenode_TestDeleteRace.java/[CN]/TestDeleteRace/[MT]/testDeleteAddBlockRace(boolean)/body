{
  try {
    conf.setClass(DFSConfigKeys.DFS_BLOCK_REPLICATOR_CLASSNAME_KEY,SlowBlockPlacementPolicy.class,BlockPlacementPolicy.class);
    cluster=new MiniDFSCluster.Builder(conf).build();
    FileSystem fs=cluster.getFileSystem();
    final String fileName="/testDeleteAddBlockRace";
    Path filePath=new Path(fileName);
    FSDataOutputStream out=null;
    out=fs.create(filePath);
    if (hasSnapshot) {
      SnapshotTestHelper.createSnapshot((DistributedFileSystem)fs,new Path("/"),"s1");
    }
    Thread deleteThread=new DeleteThread(fs,filePath);
    deleteThread.start();
    try {
      out.write(new byte[32],0,32);
      out.hsync();
      Assert.fail("Should have failed.");
    }
 catch (    FileNotFoundException e) {
      GenericTestUtils.assertExceptionContains(filePath.getName(),e);
    }
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}
