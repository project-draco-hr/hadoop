{
  MiniDFSCluster cluster=null;
  HdfsConfiguration conf=new HdfsConfiguration();
  conf.setBoolean(DFSConfigKeys.DFS_CLIENT_READ_SHORTCIRCUIT_SKIP_CHECKSUM_KEY,!checksum);
  conf.setLong(DFSConfigKeys.DFS_BYTES_PER_CHECKSUM_KEY,BlockReaderLocalTest.BYTES_PER_CHECKSUM);
  conf.set(DFSConfigKeys.DFS_CHECKSUM_TYPE_KEY,"CRC32C");
  conf.setLong(DFSConfigKeys.DFS_CLIENT_CACHE_READAHEAD,readahead);
  test.setConfiguration(conf);
  FileInputStream dataIn=null, metaIn=null;
  final Path TEST_PATH=new Path("/a");
  final long RANDOM_SEED=4567L;
  BlockReaderLocal blockReaderLocal=null;
  FSDataInputStream fsIn=null;
  byte original[]=new byte[BlockReaderLocalTest.TEST_LENGTH];
  FileSystem fs=null;
  try {
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(1).build();
    cluster.waitActive();
    fs=cluster.getFileSystem();
    DFSTestUtil.createFile(fs,TEST_PATH,BlockReaderLocalTest.TEST_LENGTH,(short)1,RANDOM_SEED);
    try {
      DFSTestUtil.waitReplication(fs,TEST_PATH,(short)1);
    }
 catch (    InterruptedException e) {
      Assert.fail("unexpected InterruptedException during " + "waitReplication: " + e);
    }
catch (    TimeoutException e) {
      Assert.fail("unexpected TimeoutException during " + "waitReplication: " + e);
    }
    fsIn=fs.open(TEST_PATH);
    IOUtils.readFully(fsIn,original,0,BlockReaderLocalTest.TEST_LENGTH);
    fsIn.close();
    fsIn=null;
    ExtendedBlock block=DFSTestUtil.getFirstBlock(fs,TEST_PATH);
    File dataFile=MiniDFSCluster.getBlockFile(0,block);
    File metaFile=MiniDFSCluster.getBlockMetadataFile(0,block);
    DatanodeID datanodeID=cluster.getDataNodes().get(0).getDatanodeId();
    ShortCircuitCache shortCircuitCache=ClientContext.getFromConf(conf).getShortCircuitCache();
    cluster.shutdown();
    cluster=null;
    test.setup(dataFile,checksum);
    FileInputStream streams[]={new FileInputStream(dataFile),new FileInputStream(metaFile)};
    dataIn=streams[0];
    metaIn=streams[1];
    Key key=new Key(block.getBlockId(),block.getBlockPoolId());
    ShortCircuitReplica replica=new ShortCircuitReplica(key,dataIn,metaIn,shortCircuitCache,Time.now());
    blockReaderLocal=new BlockReaderLocal.Builder(new DFSClient.Conf(conf)).setFilename(TEST_PATH.getName()).setBlock(block).setShortCircuitReplica(replica).setDatanodeID(datanodeID).setCachingStrategy(new CachingStrategy(false,readahead)).setVerifyChecksum(checksum).build();
    dataIn=null;
    metaIn=null;
    test.doTest(blockReaderLocal,original);
    Assert.assertEquals(0,streams[0].getChannel().position());
    Assert.assertEquals(0,streams[1].getChannel().position());
  }
  finally {
    if (fsIn != null)     fsIn.close();
    if (fs != null)     fs.close();
    if (cluster != null)     cluster.shutdown();
    if (dataIn != null)     dataIn.close();
    if (metaIn != null)     metaIn.close();
    if (blockReaderLocal != null)     blockReaderLocal.close();
  }
}
