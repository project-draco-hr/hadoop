{
  RollingFileSystemSink.flushQuickly=false;
  RollingFileSystemSink.hasFlushed=false;
  initKdc();
  MiniDFSCluster cluster=null;
  try {
    HdfsConfiguration conf=createSecureConfig("authentication,privacy");
    RollingFileSystemSink.suppliedConf=conf;
    cluster=new MiniDFSCluster.Builder(conf).numDataNodes(NUM_DATANODES).build();
    final String path="hdfs://" + cluster.getNameNode().getHostAndPort() + "/tmp/test";
    createDirectoriesSecurely(cluster);
    initMetricsSystem(path,true,false);
    assertTrue("No exception was generated initializing the sink against a " + "secure cluster even though the principal and keytab properties " + "were missing",ErrorSink.errored);
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
    shutdownKdc();
    UserGroupInformation.setConfiguration(new Configuration());
    RollingFileSystemSink.suppliedConf=null;
    RollingFileSystemSink.suppliedFilesystem=null;
  }
}
