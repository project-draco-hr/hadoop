{
  Configuration conf=new Configuration();
  conf.setLong(DFSConfigKeys.DFS_BLOCK_SIZE_KEY,BLOCK_SIZE);
  conf.setLong(DFSConfigKeys.DFS_BLOCKREPORT_INTERVAL_MSEC_KEY,10800000L);
  conf.setLong(DFSConfigKeys.DFS_HEARTBEAT_INTERVAL_KEY,1080L);
  cluster=new MiniDFSCluster.Builder(conf).numDataNodes(2).build();
  cluster.waitActive();
  final DataNode dn=cluster.getDataNodes().get(0);
  DatanodeProtocolClientSideTranslatorPB spy=DataNodeTestUtils.spyOnBposToNN(dn,cluster.getNameNode());
  File dataDirToKeep=new File(cluster.getDataDirectory(),"data1");
  assertThat("DN did not update its own config",dn.reconfigurePropertyImpl(DFS_DATANODE_DATA_DIR_KEY,dataDirToKeep.toString()),is(dn.getConf().get(DFS_DATANODE_DATA_DIR_KEY)));
  Mockito.verify(spy,timeout(60000).times(1)).blockReport(any(DatanodeRegistration.class),anyString(),any(StorageBlockReport[].class),any(BlockReportContext.class));
}
