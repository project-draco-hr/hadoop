{
  File dataDir=new File(cluster.getDataDirectory());
  DataNode dn=cluster.getDataNodes().get(0);
  Configuration conf=dn.getConf();
  String oldDataDir=conf.get(DFS_DATANODE_DATA_DIR_KEY);
  List<File> newVolumeDirs=new ArrayList<File>();
  StringBuilder newDataDirBuf=new StringBuilder(oldDataDir);
  int startIdx=oldDataDir.split(",").length + 1;
  while (true) {
    File volumeDir=new File(dataDir,"data" + startIdx);
    if (!volumeDir.exists()) {
      break;
    }
    startIdx++;
  }
  for (int i=startIdx; i < startIdx + numNewVolumes; i++) {
    File volumeDir=new File(dataDir,"data" + String.valueOf(i));
    newVolumeDirs.add(volumeDir);
    volumeDir.mkdirs();
    newDataDirBuf.append(",");
    newDataDirBuf.append(StorageLocation.parse(volumeDir.toString()).toString());
  }
  String newDataDir=newDataDirBuf.toString();
  dn.reconfigurePropertyImpl(DFS_DATANODE_DATA_DIR_KEY,newDataDir);
  String[] effectiveDataDirs=conf.get(DFS_DATANODE_DATA_DIR_KEY).split(",");
  String[] expectDataDirs=newDataDir.split(",");
  assertEquals(expectDataDirs.length,effectiveDataDirs.length);
  for (int i=0; i < expectDataDirs.length; i++) {
    StorageLocation expectLocation=StorageLocation.parse(expectDataDirs[i]);
    StorageLocation effectiveLocation=StorageLocation.parse(effectiveDataDirs[i]);
    assertEquals(expectLocation.getStorageType(),effectiveLocation.getStorageType());
    assertEquals(expectLocation.getFile().getCanonicalFile(),effectiveLocation.getFile().getCanonicalFile());
  }
  for (  File volumeDir : newVolumeDirs) {
    File curDir=new File(volumeDir,"current");
    assertTrue(curDir.exists());
    assertTrue(curDir.isDirectory());
  }
}
