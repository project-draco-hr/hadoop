{
  File dataDir=new File(cluster.getDataDirectory());
  DataNode dn=cluster.getDataNodes().get(0);
  Configuration conf=dn.getConf();
  String oldDataDir=conf.get(DFS_DATANODE_DATA_DIR_KEY);
  List<File> newVolumeDirs=new ArrayList<File>();
  StringBuilder newDataDirBuf=new StringBuilder(oldDataDir);
  int startIdx=oldDataDir.split(",").length + 1;
  while (true) {
    File volumeDir=new File(dataDir,"data" + startIdx);
    if (!volumeDir.exists()) {
      break;
    }
    startIdx++;
  }
  for (int i=startIdx; i < startIdx + numNewVolumes; i++) {
    File volumeDir=new File(dataDir,"data" + String.valueOf(i));
    newVolumeDirs.add(volumeDir);
    volumeDir.mkdirs();
    newDataDirBuf.append(",");
    newDataDirBuf.append(volumeDir.toURI());
  }
  String newDataDir=newDataDirBuf.toString();
  dn.reconfigurePropertyImpl(DFS_DATANODE_DATA_DIR_KEY,newDataDir);
  assertEquals(newDataDir,conf.get(DFS_DATANODE_DATA_DIR_KEY));
  for (  File volumeDir : newVolumeDirs) {
    File curDir=new File(volumeDir,"current");
    assertTrue(curDir.exists());
    assertTrue(curDir.isDirectory());
  }
}
