{
  File dataDir=new File(cluster.getDataDirectory());
  DataNode dn=cluster.getDataNodes().get(0);
  Configuration conf=dn.getConf();
  String oldDataDir=conf.get(DFS_DATANODE_DATA_DIR_KEY);
  List<File> newVolumeDirs=new ArrayList<File>();
  StringBuilder newDataDirBuf=new StringBuilder(oldDataDir);
  int startIdx=oldDataDir.split(",").length + 1;
  while (true) {
    File volumeDir=new File(dataDir,"data" + startIdx);
    if (!volumeDir.exists()) {
      break;
    }
    startIdx++;
  }
  for (int i=startIdx; i < startIdx + numNewVolumes; i++) {
    File volumeDir=new File(dataDir,"data" + String.valueOf(i));
    newVolumeDirs.add(volumeDir);
    volumeDir.mkdirs();
    newDataDirBuf.append(",");
    newDataDirBuf.append(StorageLocation.parse(volumeDir.toString()).toString());
  }
  String newDataDir=newDataDirBuf.toString();
  assertThat("DN did not update its own config",dn.reconfigurePropertyImpl(DFS_DATANODE_DATA_DIR_KEY,newDataDir),is(conf.get(DFS_DATANODE_DATA_DIR_KEY)));
  String[] effectiveDataDirs=conf.get(DFS_DATANODE_DATA_DIR_KEY).split(",");
  String[] expectDataDirs=newDataDir.split(",");
  assertEquals(expectDataDirs.length,effectiveDataDirs.length);
  List<StorageLocation> expectedStorageLocations=new ArrayList<>();
  List<StorageLocation> effectiveStorageLocations=new ArrayList<>();
  for (int i=0; i < expectDataDirs.length; i++) {
    StorageLocation expectLocation=StorageLocation.parse(expectDataDirs[i]);
    StorageLocation effectiveLocation=StorageLocation.parse(effectiveDataDirs[i]);
    expectedStorageLocations.add(expectLocation);
    effectiveStorageLocations.add(effectiveLocation);
  }
  Comparator<StorageLocation> comparator=new Comparator<StorageLocation>(){
    @Override public int compare(    StorageLocation o1,    StorageLocation o2){
      return o1.toString().compareTo(o2.toString());
    }
  }
;
  Collections.sort(expectedStorageLocations,comparator);
  Collections.sort(effectiveStorageLocations,comparator);
  assertEquals("Effective volumes doesnt match expected",expectedStorageLocations,effectiveStorageLocations);
  for (  File volumeDir : newVolumeDirs) {
    File curDir=new File(volumeDir,"current");
    assertTrue(curDir.exists());
    assertTrue(curDir.isDirectory());
  }
}
