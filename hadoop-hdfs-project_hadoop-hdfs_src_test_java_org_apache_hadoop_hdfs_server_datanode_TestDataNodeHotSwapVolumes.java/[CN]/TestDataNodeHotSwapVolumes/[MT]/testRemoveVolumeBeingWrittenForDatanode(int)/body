{
  startDFSCluster(1,3);
  final short REPLICATION=3;
  final DataNode dn=cluster.getDataNodes().get(dataNodeIdx);
  final FileSystem fs=cluster.getFileSystem();
  final Path testFile=new Path("/test");
  FSDataOutputStream out=fs.create(testFile,REPLICATION);
  Random rb=new Random(0);
  byte[] writeBuf=new byte[BLOCK_SIZE / 2];
  rb.nextBytes(writeBuf);
  out.write(writeBuf);
  out.hflush();
  final CyclicBarrier barrier=new CyclicBarrier(2);
  List<String> oldDirs=getDataDirs(dn);
  final String newDirs=oldDirs.get(1);
  final List<Exception> exceptions=new ArrayList<>();
  Thread reconfigThread=new Thread(){
    public void run(){
      try {
        barrier.await();
        dn.reconfigurePropertyImpl(DFSConfigKeys.DFS_DATANODE_DATA_DIR_KEY,newDirs);
      }
 catch (      ReconfigurationException|InterruptedException|BrokenBarrierException e) {
        exceptions.add(e);
      }
    }
  }
;
  reconfigThread.start();
  barrier.await();
  rb.nextBytes(writeBuf);
  out.write(writeBuf);
  out.hflush();
  out.close();
  DFSTestUtil.waitReplication(fs,testFile,REPLICATION);
  byte[] content=DFSTestUtil.readFileBuffer(fs,testFile);
  assertEquals(BLOCK_SIZE,content.length);
  reconfigThread.join();
  if (!exceptions.isEmpty()) {
    throw new IOException(exceptions.get(0).getCause());
  }
}
