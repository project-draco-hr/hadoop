{
  final AppLevelServiceManager serviceManager=spy(new AppLevelServiceManager());
  doReturn(new Configuration()).when(serviceManager).getConfig();
  final int NUM_APPS=5;
  List<Callable<Boolean>> tasks=new ArrayList<Callable<Boolean>>();
  for (int i=0; i < NUM_APPS; i++) {
    final String appId=String.valueOf(i);
    Callable<Boolean> task=new Callable<Boolean>(){
      public Boolean call(){
        return serviceManager.addService(appId);
      }
    }
;
    tasks.add(task);
  }
  ExecutorService executor=Executors.newFixedThreadPool(NUM_APPS);
  try {
    List<Future<Boolean>> futures=executor.invokeAll(tasks);
    for (    Future<Boolean> future : futures) {
      assertTrue(future.get());
    }
  }
  finally {
    executor.shutdownNow();
  }
  for (int i=0; i < NUM_APPS; i++) {
    assertTrue(serviceManager.hasService(String.valueOf(i)));
  }
}
