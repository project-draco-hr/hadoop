{
  Preconditions.checkArgument(startingDir.compareTo(components[0]) == 0);
  INode curNode=startingDir;
  final INodesInPath existing=new INodesInPath(components,numOfINodes);
  int count=0;
  int index=numOfINodes - components.length;
  if (index > 0) {
    index=0;
  }
  while (count < components.length && curNode != null) {
    final boolean lastComp=(count == components.length - 1);
    if (index >= 0) {
      existing.addNode(curNode);
    }
    final boolean isRef=curNode.isReference();
    final boolean isDir=curNode.isDirectory();
    final INodeDirectory dir=isDir ? curNode.asDirectory() : null;
    if (!isRef && isDir && dir.isWithSnapshot()) {
      if (!existing.isSnapshot()) {
        existing.updateLatestSnapshotId(dir.getDirectoryWithSnapshotFeature().getLastSnapshotId());
      }
    }
 else     if (isRef && isDir && !lastComp) {
      if (!existing.isSnapshot()) {
        int dstSnapshotId=curNode.asReference().getDstSnapshotId();
        int latest=existing.getLatestSnapshotId();
        if (latest == Snapshot.CURRENT_STATE_ID || (dstSnapshotId != Snapshot.CURRENT_STATE_ID && dstSnapshotId >= latest)) {
          int lastSnapshot=Snapshot.CURRENT_STATE_ID;
          DirectoryWithSnapshotFeature sf=null;
          if (curNode.isDirectory() && (sf=curNode.asDirectory().getDirectoryWithSnapshotFeature()) != null) {
            lastSnapshot=sf.getLastSnapshotId();
          }
          existing.setSnapshotId(lastSnapshot);
        }
      }
    }
    if (curNode.isSymlink() && (!lastComp || (lastComp && resolveLink))) {
      final String path=constructPath(components,0,components.length);
      final String preceding=constructPath(components,0,count);
      final String remainder=constructPath(components,count + 1,components.length);
      final String link=DFSUtil.bytes2String(components[count]);
      final String target=curNode.asSymlink().getSymlinkString();
      if (LOG.isDebugEnabled()) {
        LOG.debug("UnresolvedPathException " + " path: " + path + " preceding: "+ preceding+ " count: "+ count+ " link: "+ link+ " target: "+ target+ " remainder: "+ remainder);
      }
      throw new UnresolvedPathException(path,preceding,remainder,target);
    }
    if (lastComp || !isDir) {
      break;
    }
    final byte[] childName=components[count + 1];
    if (isDotSnapshotDir(childName) && isDir && dir.isSnapshottable()) {
      count++;
      index++;
      existing.isSnapshot=true;
      if (index >= 0) {
        existing.capacity--;
      }
      if (count == components.length - 1) {
        break;
      }
      final Snapshot s=dir.getSnapshot(components[count + 1]);
      if (s == null) {
        curNode=null;
      }
 else {
        curNode=s.getRoot();
        existing.setSnapshotId(s.getId());
      }
      if (index >= -1) {
        existing.snapshotRootIndex=existing.numNonNull;
      }
    }
 else {
      curNode=dir.getChild(childName,existing.getPathSnapshotId());
    }
    count++;
    index++;
  }
  return existing;
}
