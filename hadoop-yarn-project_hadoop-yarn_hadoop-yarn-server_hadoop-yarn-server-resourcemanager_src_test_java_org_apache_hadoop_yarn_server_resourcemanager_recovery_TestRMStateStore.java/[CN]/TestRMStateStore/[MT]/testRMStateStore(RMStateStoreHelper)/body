{
  long submitTime=System.currentTimeMillis();
  RMStateStore store=stateStoreHelper.getRMStateStore();
  TestDispatcher dispatcher=new TestDispatcher();
  store.setDispatcher(dispatcher);
  ApplicationAttemptId attemptId1=ConverterUtils.toApplicationAttemptId("appattempt_1352994193343_0001_000001");
  ApplicationId appId1=attemptId1.getApplicationId();
  storeApp(store,appId1,submitTime);
  ContainerId containerId1=storeAttempt(store,attemptId1,"container_1352994193343_0001_01_000001",dispatcher);
  String appAttemptIdStr2="appattempt_1352994193343_0001_000002";
  ApplicationAttemptId attemptId2=ConverterUtils.toApplicationAttemptId(appAttemptIdStr2);
  ContainerId containerId2=storeAttempt(store,attemptId2,"container_1352994193343_0001_02_000001",dispatcher);
  ApplicationAttemptId attemptIdRemoved=ConverterUtils.toApplicationAttemptId("appattempt_1352994193343_0002_000001");
  ApplicationId appIdRemoved=attemptIdRemoved.getApplicationId();
  storeApp(store,appIdRemoved,submitTime);
  storeAttempt(store,attemptIdRemoved,"container_1352994193343_0002_01_000001",dispatcher);
  RMApp mockRemovedApp=mock(RMApp.class);
  HashMap<ApplicationAttemptId,RMAppAttempt> attempts=new HashMap<ApplicationAttemptId,RMAppAttempt>();
  ApplicationSubmissionContext context=new ApplicationSubmissionContextPBImpl();
  context.setApplicationId(appIdRemoved);
  when(mockRemovedApp.getSubmitTime()).thenReturn(submitTime);
  when(mockRemovedApp.getApplicationSubmissionContext()).thenReturn(context);
  when(mockRemovedApp.getAppAttempts()).thenReturn(attempts);
  RMAppAttempt mockRemovedAttempt=mock(RMAppAttempt.class);
  when(mockRemovedAttempt.getAppAttemptId()).thenReturn(attemptIdRemoved);
  attempts.put(attemptIdRemoved,mockRemovedAttempt);
  store.removeApplication(mockRemovedApp);
  stateStoreHelper.addOrphanAttemptIfNeeded(store,dispatcher);
  Thread.sleep(1000);
  store.close();
  store=stateStoreHelper.getRMStateStore();
  RMState state=store.loadState();
  Map<ApplicationId,ApplicationState> rmAppState=state.getApplicationState();
  assertEquals(1,rmAppState.size());
  ApplicationState appState=rmAppState.get(appId1);
  assertNotNull(appState);
  assertEquals(submitTime,appState.getSubmitTime());
  assertEquals(appId1,appState.getApplicationSubmissionContext().getApplicationId());
  ApplicationAttemptState attemptState=appState.getAttempt(attemptId1);
  assertNotNull(attemptState);
  assertEquals(attemptId1,attemptState.getAttemptId());
  assertEquals(containerId1,attemptState.getMasterContainer().getId());
  attemptState=appState.getAttempt(attemptId2);
  assertNotNull(attemptState);
  assertEquals(attemptId2,attemptState.getAttemptId());
  assertEquals(containerId2,attemptState.getMasterContainer().getId());
  assertTrue(stateStoreHelper.isFinalStateValid());
  store.close();
}
